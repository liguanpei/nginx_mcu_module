cscope 15 /home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module -q 0000002673 0000728728
	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/.git/config

1 [
c‹e
]

2 
	gªposô‹yf‹m©vîsi⁄
 = 0

3 
fûemode
 = 
åue


4 
b¨e
 = 
Ál£


5 
logÆÃefupd©es
 = 
åue


6 [
ªmŸe
 "origin"]

7 
„tch
 = +
ªfs
/
hóds


	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/config

1 
	gngx_add⁄_«me
="ngx_rtmp_module"

3 
CORE_MODULES
="$CORE_MODULES

4 
ngx_πmp_moduÀ
 \

5 
ngx_πmp_c‹e_moduÀ
 \

6 
ngx_πmp_cmd_moduÀ
 \

7 
ngx_πmp_codec_moduÀ
 \

8 
ngx_πmp_ac˚ss_moduÀ
 \

9 
ngx_πmp_ªc‹d_moduÀ
 \

10 
ngx_πmp_live_moduÀ
 \

11 
ngx_πmp_∂ay_moduÀ
 \

12 
ngx_πmp_Êv_moduÀ
 \

13 
ngx_πmp_mp4_moduÀ
 \

14 
ngx_πmp_√tˇŒ_moduÀ
 \

15 
ngx_πmp_ªœy_moduÀ
 \

16 
ngx_πmp_exec_moduÀ
 \

17 
ngx_πmp_auto_push_moduÀ
 \

18 
ngx_πmp_nŸify_moduÀ
 \

19 
ngx_πmp_log_moduÀ
 \

20 
ngx_πmp_limô_moduÀ
 \

21 
ngx_πmp_hls_moduÀ
 \

22 
ngx_πmp_dash_moduÀ
 \

26 
HTTP_MODULES
="$HTTP_MODULES \
_rtmp_stat_module \
_rtmp_control_module \
"

32 
NGX_ADDON_DEPS
="$NGX_ADDON_DEPS \
$ngx_addon_dir/ngx_rtmp_amf.h \
$ngx_addon_dir/ngx_rtmp_bandwidth.h \
$ngx_addon_dir/ngx_rtmp_cmd_module.h \
$ngx_addon_dir/ngx_rtmp_codec_module.h \
$ngx_addon_dir/ngx_rtmp_eval.h \
$ngx_addon_dir/ngx_rtmp.h \
$ngx_addon_dir/ngx_rtmp_version.h \
$ngx_addon_dir/ngx_rtmp_live_module.h \
$ngx_addon_dir/ngx_rtmp_netcall_module.h \
$ngx_addon_dir/ngx_rtmp_play_module.h \
$ngx_addon_dir/ngx_rtmp_record_module.h \
$ngx_addon_dir/ngx_rtmp_relay_module.h \
$ngx_addon_dir/ngx_rtmp_streams.h \
$ngx_addon_dir/ngx_rtmp_bitop.h \
$ngx_addon_dir/ngx_rtmp_proxy_protocol.h \
$ngx_addon_dir/hls/ngx_rtmp_mpegts.h \
$ngx_addon_dir/dash/ngx_rtmp_mp4.h \
"

53 
NGX_ADDON_SRCS
="$NGX_ADDON_SRCS \
$ngx_addon_dir/ngx_rtmp.c \
$ngx_addon_dir/ngx_rtmp_init.c \
$ngx_addon_dir/ngx_rtmp_handshake.c \
$ngx_addon_dir/ngx_rtmp_handler.c \
$ngx_addon_dir/ngx_rtmp_amf.c \
$ngx_addon_dir/ngx_rtmp_send.c \
$ngx_addon_dir/ngx_rtmp_shared.c \
$ngx_addon_dir/ngx_rtmp_eval.c \
$ngx_addon_dir/ngx_rtmp_receive.c \
$ngx_addon_dir/ngx_rtmp_core_module.c \
$ngx_addon_dir/ngx_rtmp_cmd_module.c \
$ngx_addon_dir/ngx_rtmp_codec_module.c \
$ngx_addon_dir/ngx_rtmp_access_module.c \
$ngx_addon_dir/ngx_rtmp_record_module.c \
$ngx_addon_dir/ngx_rtmp_live_module.c \
$ngx_addon_dir/ngx_rtmp_play_module.c \
$ngx_addon_dir/ngx_rtmp_flv_module.c \
$ngx_addon_dir/ngx_rtmp_mp4_module.c \
$ngx_addon_dir/ngx_rtmp_netcall_module.c \
$ngx_addon_dir/ngx_rtmp_stat_module.c \
$ngx_addon_dir/ngx_rtmp_control_module.c \
$ngx_addon_dir/ngx_rtmp_relay_module.c \
$ngx_addon_dir/ngx_rtmp_bandwidth.c \
$ngx_addon_dir/ngx_rtmp_exec_module.c \
$ngx_addon_dir/ngx_rtmp_auto_push_module.c \
$ngx_addon_dir/ngx_rtmp_notify_module.c \
$ngx_addon_dir/ngx_rtmp_log_module.c \
$ngx_addon_dir/ngx_rtmp_limit_module.c \
$ngx_addon_dir/ngx_rtmp_bitop.c \
$ngx_addon_dir/ngx_rtmp_proxy_protocol.c \
$ngx_addon_dir/hls/ngx_rtmp_hls_module.c \
$ngx_addon_dir/dash/ngx_rtmp_dash_module.c \
$ngx_addon_dir/hls/ngx_rtmp_mpegts.c \
$ngx_addon_dir/dash/ngx_rtmp_mp4.c \
"

89 
CFLAGS
="$CFLAGS -I$ngx_addon_dir"

91 
USE_OPENSSL
=
YES


	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/dash/ngx_rtmp_dash_module.c

3 
	~<ngx_c⁄fig.h
>

4 
	~<ngx_c‹e.h
>

5 
	~<ngx_πmp.h
>

6 
	~<ngx_πmp_codec_moduÀ.h
>

7 
	~"ngx_πmp_live_moduÀ.h
"

8 
	~"ngx_πmp_mp4.h
"

11 
ngx_πmp_publish_±
 
	g√xt_publish
;

12 
ngx_πmp_˛o£_°ªam_±
 
	g√xt_˛o£_°ªam
;

13 
ngx_πmp_°ªam_begö_±
 
	g√xt_°ªam_begö
;

14 
ngx_πmp_°ªam_eof_±
 
	g√xt_°ªam_eof
;

17 
ngx_öt_t
 
ngx_πmp_dash_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
);

18 * 
ngx_πmp_dash_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
);

19 * 
ngx_πmp_dash_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
,

20 *
∑ª¡
, *
chûd
);

21 
ngx_öt_t
 
ngx_πmp_dash_wrôe_öô_£gmíts
(
ngx_πmp_£ssi⁄_t
 *
s
);

24 
	#NGX_RTMP_DASH_BUFSIZE
 (1024*1024)

	)

25 
	#NGX_RTMP_DASH_MAX_MDAT
 (10*1024*1024)

	)

26 
	#NGX_RTMP_DASH_MAX_SAMPLES
 1024

	)

27 
	#NGX_RTMP_DASH_DIR_ACCESS
 0744

	)

31 
uöt32_t
 
	mtime°amp
;

32 
uöt32_t
 
	mduøti⁄
;

33 } 
	tngx_πmp_dash_‰ag_t
;

37 
ngx_uöt_t
 
	mid
;

38 
ngx_uöt_t
 
	m›íed
;

39 
ngx_uöt_t
 
	mmd©_size
;

40 
ngx_uöt_t
 
	mßm∂e_cou¡
;

41 
ngx_uöt_t
 
	mßm∂e_mask
;

42 
ngx_fd_t
 
	mfd
;

43 
	mty≥
;

44 
uöt32_t
 
	móæõ°_¥es_time
;

45 
uöt32_t
 
	mœã°_¥es_time
;

46 
ngx_πmp_mp4_ßm∂e_t
 
	mßm∂es
[
NGX_RTMP_DASH_MAX_SAMPLES
];

47 } 
	tngx_πmp_dash_åack_t
;

51 
ngx_°r_t
 
	m∂ayli°
;

52 
ngx_°r_t
 
	m∂ayli°_bak
;

53 
ngx_°r_t
 
	m«me
;

54 
ngx_°r_t
 
	m°ªam
;

55 
ngx_time_t
 
	m°¨t_time
;

57 
ngx_uöt_t
 
	mn‰ags
;

58 
ngx_uöt_t
 
	m‰ag
;

59 
ngx_πmp_dash_‰ag_t
 *
	m‰ags
;

61 
	m›íed
:1;

62 
	mhas_video
:1;

63 
	mhas_audio
:1;

65 
ngx_fûe_t
 
	mvideo_fûe
;

66 
ngx_fûe_t
 
	maudio_fûe
;

68 
ngx_uöt_t
 
	mid
;

70 
ngx_πmp_dash_åack_t
 
	maudio
;

71 
ngx_πmp_dash_åack_t
 
	mvideo
;

72 } 
	tngx_πmp_dash_˘x_t
;

76 
ngx_°r_t
 
	m∑th
;

77 
ngx_m£c_t
 
	m∂ayÀn
;

78 } 
	tngx_πmp_dash_˛ónup_t
;

82 
ngx_Êag_t
 
	mdash
;

83 
ngx_m£c_t
 
	m‰agÀn
;

84 
ngx_m£c_t
 
	m∂ayÀn
;

85 
ngx_Êag_t
 
	m√°ed
;

86 
ngx_°r_t
 
	m∑th
;

87 
ngx_uöt_t
 
	mwö‰ags
;

88 
ngx_Êag_t
 
	m˛ónup
;

89 
ngx_∑th_t
 *
	m¶Ÿ
;

90 } 
	tngx_πmp_dash_≠p_c⁄f_t
;

93 
ngx_comm™d_t
 
	gngx_πmp_dash_comm™ds
[] = {

95 { 
ngx_°rög
("dash"),

96 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

97 
ngx_c⁄f_£t_Êag_¶Ÿ
,

98 
NGX_RTMP_APP_CONF_OFFSET
,

99 
off£tof
(
ngx_πmp_dash_≠p_c⁄f_t
, 
dash
),

100 
NULL
 },

102 { 
ngx_°rög
("dash_fragment"),

103 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

104 
ngx_c⁄f_£t_m£c_¶Ÿ
,

105 
NGX_RTMP_APP_CONF_OFFSET
,

106 
off£tof
(
ngx_πmp_dash_≠p_c⁄f_t
, 
‰agÀn
),

107 
NULL
 },

109 { 
ngx_°rög
("dash_path"),

110 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

111 
ngx_c⁄f_£t_°r_¶Ÿ
,

112 
NGX_RTMP_APP_CONF_OFFSET
,

113 
off£tof
(
ngx_πmp_dash_≠p_c⁄f_t
, 
∑th
),

114 
NULL
 },

116 { 
ngx_°rög
("dash_playlist_length"),

117 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

118 
ngx_c⁄f_£t_m£c_¶Ÿ
,

119 
NGX_RTMP_APP_CONF_OFFSET
,

120 
off£tof
(
ngx_πmp_dash_≠p_c⁄f_t
, 
∂ayÀn
),

121 
NULL
 },

123 { 
ngx_°rög
("dash_cleanup"),

124 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

125 
ngx_c⁄f_£t_Êag_¶Ÿ
,

126 
NGX_RTMP_APP_CONF_OFFSET
,

127 
off£tof
(
ngx_πmp_dash_≠p_c⁄f_t
, 
˛ónup
),

128 
NULL
 },

130 { 
ngx_°rög
("dash_nested"),

131 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

132 
ngx_c⁄f_£t_Êag_¶Ÿ
,

133 
NGX_RTMP_APP_CONF_OFFSET
,

134 
off£tof
(
ngx_πmp_dash_≠p_c⁄f_t
, 
√°ed
),

135 
NULL
 },

137 
ngx_nuŒ_comm™d


141 
ngx_πmp_moduÀ_t
 
	gngx_πmp_dash_moduÀ_˘x
 = {

142 
NULL
,

143 
ngx_πmp_dash_po°c⁄figuøti⁄
,

145 
NULL
,

146 
NULL
,

148 
NULL
,

149 
NULL
,

151 
ngx_πmp_dash_¸óã_≠p_c⁄f
,

152 
ngx_πmp_dash_mîge_≠p_c⁄f
,

156 
ngx_moduÀ_t
 
	gngx_πmp_dash_moduÀ
 = {

157 
NGX_MODULE_V1
,

158 &
ngx_πmp_dash_moduÀ_˘x
,

159 
ngx_πmp_dash_comm™ds
,

160 
NGX_RTMP_MODULE
,

161 
NULL
,

162 
NULL
,

163 
NULL
,

164 
NULL
,

165 
NULL
,

166 
NULL
,

167 
NULL
,

168 
NGX_MODULE_V1_PADDING


172 
ngx_πmp_dash_‰ag_t
 *

173 
	$ngx_πmp_dash_gë_‰ag
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_öt_t
 
n
)

175 
ngx_πmp_dash_˘x_t
 *
˘x
;

176 
ngx_πmp_dash_≠p_c⁄f_t
 *
dacf
;

178 
dacf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_dash_moduÀ
);

179 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_dash_moduÀ
);

181  &
˘x
->
‰ags
[(˘x->
‰ag
 + 
n
Ë% (
dacf
->
wö‰ags
 * 2 + 1)];

182 
	}
}

186 
	$ngx_πmp_dash_√xt_‰ag
(
ngx_πmp_£ssi⁄_t
 *
s
)

188 
ngx_πmp_dash_˘x_t
 *
˘x
;

189 
ngx_πmp_dash_≠p_c⁄f_t
 *
dacf
;

191 
dacf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_dash_moduÀ
);

192 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_dash_moduÀ
);

194 i‡(
˘x
->
n‰ags
 =
dacf
->
wö‰ags
) {

195 
˘x
->
‰ag
++;

197 
˘x
->
n‰ags
++;

199 
	}
}

202 
ngx_öt_t


203 
	$ngx_πmp_dash_ª«me_fûe
(
u_ch¨
 *
§c
, u_ch¨ *
d°
)

207 #i‡(
NGX_WIN32
)

208  
	`MoveFûeEx
((
LPCTSTR
Ë
§c
, (LPCTSTRË
d°
, 
MOVEFILE_REPLACE_EXISTING
);

210  
	`ngx_ª«me_fûe
(
§c
, 
d°
);

212 
	}
}

215 
ngx_öt_t


216 
	$ngx_πmp_dash_wrôe_∂ayli°
(
ngx_πmp_£ssi⁄_t
 *
s
)

218 *
£p
;

219 
u_ch¨
 *
p
, *
œ°
;

220 
ssize_t
 
n
;

221 
ngx_fd_t
 
fd
;

222 
tm
Åm;

223 
ngx_°r_t
 
n⁄ame
, *
«me
;

224 
ngx_uöt_t
 
i
;

225 
ngx_πmp_dash_˘x_t
 *
˘x
;

226 
ngx_πmp_codec_˘x_t
 *
codec_˘x
;

227 
ngx_πmp_dash_‰ag_t
 *
f
;

228 
ngx_πmp_dash_≠p_c⁄f_t
 *
dacf
;

230 
u_ch¨
 
buf„r
[
NGX_RTMP_DASH_BUFSIZE
];

231 
u_ch¨
 
°¨t_time
[("1970-09-28T12:00:00+06:00")];

232 
u_ch¨
 
íd_time
[("1970-09-28T12:00:00+06:00")];

234 
dacf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_dash_moduÀ
);

235 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_dash_moduÀ
);

236 
codec_˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

238 i‡(
dacf
 =
NULL
 || 
˘x
 =NULL || 
codec_˘x
 == NULL) {

239  
NGX_ERROR
;

242 i‡(
˘x
->
id
 == 0) {

243 
	`ngx_πmp_dash_wrôe_öô_£gmíts
(
s
);

246 
fd
 = 
	`ngx_›í_fûe
(
˘x
->
∂ayli°_bak
.
d©a
, 
NGX_FILE_WRONLY
,

247 
NGX_FILE_TRUNCATE
, 
NGX_FILE_DEFAULT_ACCESS
);

249 i‡(
fd
 =
NGX_INVALID_FILE
) {

250 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

251 "dash: o≥¿Áûed: '%V'", &
˘x
->
∂ayli°_bak
);

252  
NGX_ERROR
;

256 
	#NGX_RTMP_DASH_MANIFEST_HEADER
 \

271 " <Pîiod sèπ=\"PT0S\" id=\"dash\">\n"

	)

274 
	#NGX_RTMP_DASH_MANIFEST_VIDEO
 \

296 " <SegmítTimñöe>\n"

	)

299 
	#NGX_RTMP_DASH_MANIFEST_VIDEO_FOOTER
 \

303 " </Ad≠èti⁄Së>\n"

	)

306 
	#NGX_RTMP_DASH_MANIFEST_TIME
 \

307 " <SÅ=\"%uD\" d=\"%uD\"/>\n"

	)

310 
	#NGX_RTMP_DASH_MANIFEST_AUDIO
 \

330 " <SegmítTimñöe>\n"

	)

333 
	#NGX_RTMP_DASH_MANIFEST_AUDIO_FOOTER
 \

337 " </Ad≠èti⁄Së>\n"

	)

340 
	#NGX_RTMP_DASH_MANIFEST_FOOTER
 \

342 "</MPD>\n"

	)

344 
	`ngx_libc_loˇ…ime
(
˘x
->
°¨t_time
.
£c
 +

345 
	`ngx_πmp_dash_gë_‰ag
(
s
, 0)->
time°amp
 / 1000, &
tm
);

347 *
	`ngx_•rötf
(
°¨t_time
, "%4d-%02d-%02dT%02d:%02d:%02d%c%02d:%02d",

348 
tm
.
tm_yór
 + 1900,Åm.
tm_m⁄
 + 1,

349 
tm
.
tm_mday
,Åm.
tm_hour
,

350 
tm
.
tm_mö
,Åm.
tm_£c
,

351 
˘x
->
°¨t_time
.
gmtoff
 < 0 ? '-' : '+',

352 
	`ngx_abs
(
˘x
->
°¨t_time
.
gmtoff
 / 60),

353 
	`ngx_abs
(
˘x
->
°¨t_time
.
gmtoff
 % 60)) = 0;

355 
	`ngx_libc_loˇ…ime
(
˘x
->
°¨t_time
.
£c
 +

356 (
	`ngx_πmp_dash_gë_‰ag
(
s
, 
˘x
->
n‰ags
 - 1)->
time°amp
 +

357 
	`ngx_πmp_dash_gë_‰ag
(
s
, 
˘x
->
n‰ags
 - 1)->
duøti⁄
) /

358 1000, &
tm
);

360 *
	`ngx_•rötf
(
íd_time
, "%4d-%02d-%02dT%02d:%02d:%02d%c%02d:%02d",

361 
tm
.
tm_yór
 + 1900,Åm.
tm_m⁄
 + 1,

362 
tm
.
tm_mday
,Åm.
tm_hour
,

363 
tm
.
tm_mö
,Åm.
tm_£c
,

364 
˘x
->
°¨t_time
.
gmtoff
 < 0 ? '-' : '+',

365 
	`ngx_abs
(
˘x
->
°¨t_time
.
gmtoff
 / 60),

366 
	`ngx_abs
(
˘x
->
°¨t_time
.
gmtoff
 % 60)) = 0;

368 
œ°
 = 
buf„r
 + (buffer);

370 
p
 = 
	`ngx_¶¥ötf
(
buf„r
, 
œ°
, 
NGX_RTMP_DASH_MANIFEST_HEADER
,

371 
°¨t_time
,

372 
íd_time
,

373 (
ngx_uöt_t
Ë(
dacf
->
‰agÀn
 / 1000),

374 (
ngx_uöt_t
Ë(
dacf
->
‰agÀn
 / 1000),

375 (
ngx_uöt_t
Ë(
dacf
->
‰agÀn
 / 500));

377 
n
 = 
	`ngx_wrôe_fd
(
fd
, 
buf„r
, 
p
 - buffer);

379 
	`ngx_°r_nuŒ
(&
n⁄ame
);

381 
«me
 = (
dacf
->
√°ed
 ? &
n⁄ame
 : &
˘x
->name);

382 
£p
 = (
dacf
->
√°ed
 ? "" : "-");

384 i‡(
˘x
->
has_video
) {

385 
p
 = 
	`ngx_¶¥ötf
(
buf„r
, 
œ°
, 
NGX_RTMP_DASH_MANIFEST_VIDEO
,

386 
codec_˘x
->
width
,

387 
codec_˘x
->
height
,

388 
codec_˘x
->
‰ame_øã
,

389 &
˘x
->
«me
,

390 
codec_˘x
->
avc_¥ofûe
,

391 
codec_˘x
->
avc_com∑t
,

392 
codec_˘x
->
avc_Àvñ
,

393 
codec_˘x
->
width
,

394 
codec_˘x
->
height
,

395 
codec_˘x
->
‰ame_øã
,

396 (
ngx_uöt_t
Ë(
codec_˘x
->
video_d©a_øã
 * 1000),

397 
«me
, 
£p
,

398 
«me
, 
£p
);

400 
i
 = 0; i < 
˘x
->
n‰ags
; i++) {

401 
f
 = 
	`ngx_πmp_dash_gë_‰ag
(
s
, 
i
);

402 
p
 = 
	`ngx_¶¥ötf
’, 
œ°
, 
NGX_RTMP_DASH_MANIFEST_TIME
,

403 
f
->
time°amp
, f->
duøti⁄
);

406 
p
 = 
	`ngx_¶¥ötf
’, 
œ°
, 
NGX_RTMP_DASH_MANIFEST_VIDEO_FOOTER
);

408 
n
 = 
	`ngx_wrôe_fd
(
fd
, 
buf„r
, 
p
 - buffer);

411 i‡(
˘x
->
has_audio
) {

412 
p
 = 
	`ngx_¶¥ötf
(
buf„r
, 
œ°
, 
NGX_RTMP_DASH_MANIFEST_AUDIO
,

413 &
˘x
->
«me
,

414 
codec_˘x
->
audio_codec_id
 =
NGX_RTMP_AUDIO_AAC
 ?

415 (
codec_˘x
->
Øc_sbr
 ? "40.5" : "40.2") : "6b",

416 
codec_˘x
->
ßm∂e_øã
,

417 (
ngx_uöt_t
Ë(
codec_˘x
->
audio_d©a_øã
 * 1000),

418 
«me
, 
£p
,

419 
«me
, 
£p
);

421 
i
 = 0; i < 
˘x
->
n‰ags
; i++) {

422 
f
 = 
	`ngx_πmp_dash_gë_‰ag
(
s
, 
i
);

423 
p
 = 
	`ngx_¶¥ötf
’, 
œ°
, 
NGX_RTMP_DASH_MANIFEST_TIME
,

424 
f
->
time°amp
, f->
duøti⁄
);

427 
p
 = 
	`ngx_¶¥ötf
’, 
œ°
, 
NGX_RTMP_DASH_MANIFEST_AUDIO_FOOTER
);

429 
n
 = 
	`ngx_wrôe_fd
(
fd
, 
buf„r
, 
p
 - buffer);

432 
p
 = 
	`ngx_¶¥ötf
(
buf„r
, 
œ°
, 
NGX_RTMP_DASH_MANIFEST_FOOTER
);

433 
n
 = 
	`ngx_wrôe_fd
(
fd
, 
buf„r
, 
p
 - buffer);

435 i‡(
n
 < 0) {

436 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

437 "dash: wrôêÁûed: '%V'", &
˘x
->
∂ayli°_bak
);

438 
	`ngx_˛o£_fûe
(
fd
);

439  
NGX_ERROR
;

442 
	`ngx_˛o£_fûe
(
fd
);

444 i‡(
	`ngx_πmp_dash_ª«me_fûe
(
˘x
->
∂ayli°_bak
.
d©a
, ctx->
∂ayli°
.data)

445 =
NGX_FILE_ERROR
)

447 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

449 &
˘x
->
∂ayli°_bak
, &˘x->
∂ayli°
);

450  
NGX_ERROR
;

453  
NGX_OK
;

454 
	}
}

457 
ngx_öt_t


458 
	$ngx_πmp_dash_wrôe_öô_£gmíts
(
ngx_πmp_£ssi⁄_t
 *
s
)

460 
ngx_fd_t
 
fd
;

461 
ngx_öt_t
 
rc
;

462 
ngx_buf_t
 
b
;

463 
ngx_πmp_dash_˘x_t
 *
˘x
;

464 
ngx_πmp_codec_˘x_t
 *
codec_˘x
;

466 
u_ch¨
 
buf„r
[
NGX_RTMP_DASH_BUFSIZE
];

468 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_dash_moduÀ
);

469 
codec_˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

471 i‡(
˘x
 =
NULL
 || 
codec_˘x
 == NULL) {

472  
NGX_ERROR
;

477 *
	`ngx_•rötf
(
˘x
->
°ªam
.
d©a
 + ctx->°ªam.
Àn
, "init.m4v") = 0;

479 
fd
 = 
	`ngx_›í_fûe
(
˘x
->
°ªam
.
d©a
, 
NGX_FILE_RDWR
, 
NGX_FILE_TRUNCATE
,

480 
NGX_FILE_DEFAULT_ACCESS
);

482 i‡(
fd
 =
NGX_INVALID_FILE
) {

483 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

485  
NGX_ERROR
;

488 
b
.
°¨t
 = 
buf„r
;

489 
b
.
íd
 = b.
°¨t
 + (
buf„r
);

490 
b
.
pos
 = b.
œ°
 = b.
°¨t
;

492 
	`ngx_πmp_mp4_wrôe_·yp
(&
b
);

493 
	`ngx_πmp_mp4_wrôe_moov
(
s
, &
b
, 
NGX_RTMP_MP4_VIDEO_TRACK
);

495 
rc
 = 
	`ngx_wrôe_fd
(
fd
, 
b
.
°¨t
, (
size_t
Ë(b.
œ°
 - b.start));

496 i‡(
rc
 =
NGX_ERROR
) {

497 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

501 
	`ngx_˛o£_fûe
(
fd
);

505 *
	`ngx_•rötf
(
˘x
->
°ªam
.
d©a
 + ctx->°ªam.
Àn
, "init.m4a") = 0;

507 
fd
 = 
	`ngx_›í_fûe
(
˘x
->
°ªam
.
d©a
, 
NGX_FILE_RDWR
, 
NGX_FILE_TRUNCATE
,

508 
NGX_FILE_DEFAULT_ACCESS
);

510 i‡(
fd
 =
NGX_INVALID_FILE
) {

511 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

513  
NGX_ERROR
;

516 
b
.
pos
 = b.
œ°
 = b.
°¨t
;

518 
	`ngx_πmp_mp4_wrôe_·yp
(&
b
);

519 
	`ngx_πmp_mp4_wrôe_moov
(
s
, &
b
, 
NGX_RTMP_MP4_AUDIO_TRACK
);

521 
rc
 = 
	`ngx_wrôe_fd
(
fd
, 
b
.
°¨t
, (
size_t
Ë(b.
œ°
 - b.start));

522 i‡(
rc
 =
NGX_ERROR
) {

523 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

527 
	`ngx_˛o£_fûe
(
fd
);

529  
NGX_OK
;

530 
	}
}

534 
	$ngx_πmp_dash_˛o£_‰agmít
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_dash_åack_t
 *
t
)

536 
u_ch¨
 *
pos
, *
pos1
;

537 
size_t
 
À·
;

538 
ssize_t
 
n
;

539 
ngx_fd_t
 
fd
;

540 
ngx_buf_t
 
b
;

541 
ngx_πmp_dash_˘x_t
 *
˘x
;

542 
ngx_πmp_dash_‰ag_t
 *
f
;

544 
u_ch¨
 
buf„r
[
NGX_RTMP_DASH_BUFSIZE
];

546 i‡(!
t
->
›íed
) {

550 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

552 
t
->
id
,Å->
ty≥
,Å->
óæõ°_¥es_time
);

554 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_dash_moduÀ
);

556 
b
.
°¨t
 = 
buf„r
;

557 
b
.
íd
 = 
buf„r
 + (buffer);

558 
b
.
pos
 = b.
œ°
 = b.
°¨t
;

560 
	`ngx_πmp_mp4_wrôe_°yp
(&
b
);

562 
pos
 = 
b
.
œ°
;

563 
b
.
œ°
 += 44;

565 
	`ngx_πmp_mp4_wrôe_moof
(&
b
, 
t
->
óæõ°_¥es_time
,Å->
ßm∂e_cou¡
,

566 
t
->
ßm∂es
,Å->
ßm∂e_mask
,Å->
id
);

567 
pos1
 = 
b
.
œ°
;

568 
b
.
œ°
 = 
pos
;

570 
	`ngx_πmp_mp4_wrôe_sidx
(&
b
, 
t
->
md©_size
 + 8 + (
pos1
 - (
pos
 + 44)),

571 
t
->
óæõ°_¥es_time
,Å->
œã°_¥es_time
);

572 
b
.
œ°
 = 
pos1
;

573 
	`ngx_πmp_mp4_wrôe_md©
(&
b
, 
t
->
md©_size
 + 8);

577 
f
 = 
	`ngx_πmp_dash_gë_‰ag
(
s
, 
˘x
->
n‰ags
);

579 *
	`ngx_•rötf
(
˘x
->
°ªam
.
d©a
 + ctx->°ªam.
Àn
, "%uD.m4%c",

580 
f
->
time°amp
, 
t
->
ty≥
) = 0;

582 
fd
 = 
	`ngx_›í_fûe
(
˘x
->
°ªam
.
d©a
, 
NGX_FILE_RDWR
,

583 
NGX_FILE_TRUNCATE
, 
NGX_FILE_DEFAULT_ACCESS
);

585 i‡(
fd
 =
NGX_INVALID_FILE
) {

586 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

588 
d⁄e
;

591 i‡(
	`ngx_wrôe_fd
(
fd
, 
b
.
pos
, (
size_t
Ë(b.
œ°
 - b.pos)Ë=
NGX_ERROR
) {

592 
d⁄e
;

595 
À·
 = (
size_t
Ë
t
->
md©_size
;

597 #i‡(
NGX_WIN32
)

598 i‡(
	`SëFûePoöãr
(
t
->
fd
, 0, 0, 
FILE_BEGIN
Ë=
INVALID_SET_FILE_POINTER
) {

599 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

601 
d⁄e
;

604 i‡(
	`l£ek
(
t
->
fd
, 0, 
SEEK_SET
) == -1) {

605 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

607 
d⁄e
;

611 
À·
 > 0) {

613 
n
 = 
	`ngx_ªad_fd
(
t
->
fd
, 
buf„r
, 
	`ngx_mö
((buf„r), 
À·
));

614 i‡(
n
 =
NGX_ERROR
) {

618 
n
 = 
	`ngx_wrôe_fd
(
fd
, 
buf„r
, (
size_t
)Ç);

619 i‡(
n
 =
NGX_ERROR
) {

623 
À·
 -
n
;

626 
d⁄e
:

628 i‡(
fd
 !
NGX_INVALID_FILE
) {

629 
	`ngx_˛o£_fûe
(
fd
);

632 
	`ngx_˛o£_fûe
(
t
->
fd
);

634 
t
->
fd
 = 
NGX_INVALID_FILE
;

635 
t
->
›íed
 = 0;

636 
	}
}

639 
ngx_öt_t


640 
	$ngx_πmp_dash_˛o£_‰agmíts
(
ngx_πmp_£ssi⁄_t
 *
s
)

642 
ngx_πmp_dash_˘x_t
 *
˘x
;

644 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_dash_moduÀ
);

645 i‡(
˘x
 =
NULL
 || !˘x->
›íed
) {

646  
NGX_OK
;

649 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

652 
	`ngx_πmp_dash_˛o£_‰agmít
(
s
, &
˘x
->
video
);

653 
	`ngx_πmp_dash_˛o£_‰agmít
(
s
, &
˘x
->
audio
);

655 
	`ngx_πmp_dash_√xt_‰ag
(
s
);

657 
	`ngx_πmp_dash_wrôe_∂ayli°
(
s
);

659 
˘x
->
id
++;

660 
˘x
->
›íed
 = 0;

662  
NGX_OK
;

663 
	}
}

666 
ngx_öt_t


667 
	$ngx_πmp_dash_›í_‰agmít
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_dash_åack_t
 *
t
,

668 
ngx_uöt_t
 
id
, 
ty≥
)

670 
ngx_πmp_dash_˘x_t
 *
˘x
;

672 i‡(
t
->
›íed
) {

673  
NGX_OK
;

676 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

677 "dash: o≥¿‰agmíàid=%ui,Åy≥='%c'", 
id
, 
ty≥
);

679 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_dash_moduÀ
);

681 *
	`ngx_•rötf
(
˘x
->
°ªam
.
d©a
 + ctx->°ªam.
Àn
, "øw.m4%c", 
ty≥
) = 0;

683 
t
->
fd
 = 
	`ngx_›í_fûe
(
˘x
->
°ªam
.
d©a
, 
NGX_FILE_RDWR
,

684 
NGX_FILE_TRUNCATE
, 
NGX_FILE_DEFAULT_ACCESS
);

686 i‡(
t
->
fd
 =
NGX_INVALID_FILE
) {

687 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

689  
NGX_ERROR
;

692 
t
->
id
 = id;

693 
t
->
ty≥
 =Åype;

694 
t
->
ßm∂e_cou¡
 = 0;

695 
t
->
óæõ°_¥es_time
 = 0;

696 
t
->
œã°_¥es_time
 = 0;

697 
t
->
md©_size
 = 0;

698 
t
->
›íed
 = 1;

700 i‡(
ty≥
 == 'v') {

701 
t
->
ßm∂e_mask
 = 
NGX_RTMP_MP4_SAMPLE_SIZE
|

702 
NGX_RTMP_MP4_SAMPLE_DURATION
|

703 
NGX_RTMP_MP4_SAMPLE_DELAY
|

704 
NGX_RTMP_MP4_SAMPLE_KEY
;

706 
t
->
ßm∂e_mask
 = 
NGX_RTMP_MP4_SAMPLE_SIZE
|

707 
NGX_RTMP_MP4_SAMPLE_DURATION
;

710  
NGX_OK
;

711 
	}
}

714 
ngx_öt_t


715 
	$ngx_πmp_dash_›í_‰agmíts
(
ngx_πmp_£ssi⁄_t
 *
s
)

717 
ngx_πmp_dash_˘x_t
 *
˘x
;

719 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

722 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_dash_moduÀ
);

724 i‡(
˘x
->
›íed
) {

725  
NGX_OK
;

728 
	`ngx_πmp_dash_›í_‰agmít
(
s
, &
˘x
->
video
, ctx->
id
, 'v');

730 
	`ngx_πmp_dash_›í_‰agmít
(
s
, &
˘x
->
audio
, ctx->
id
, 'a');

732 
˘x
->
›íed
 = 1;

734  
NGX_OK
;

735 
	}
}

738 
ngx_öt_t


739 
	$ngx_πmp_dash_ísuª_dúe˘‹y
(
ngx_πmp_£ssi⁄_t
 *
s
)

741 
size_t
 
Àn
;

742 
ngx_fûe_öfo_t
 
fi
;

743 
ngx_πmp_dash_˘x_t
 *
˘x
;

744 
ngx_πmp_dash_≠p_c⁄f_t
 *
dacf
;

746 
u_ch¨
 
∑th
[
NGX_MAX_PATH
 + 1];

748 
dacf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_dash_moduÀ
);

750 *
	`ngx_¢¥ötf
(
∑th
, ’©hË- 1, "%V", &
dacf
->path) = 0;

752 i‡(
	`ngx_fûe_öfo
(
∑th
, &
fi
Ë=
NGX_FILE_ERROR
) {

754 i‡(
ngx_î∫o
 !
NGX_ENOENT
) {

755 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

756 "dash: " 
ngx_fûe_öfo_n
 " failed on '%V'",

757 &
dacf
->
∑th
);

758  
NGX_ERROR
;

763 i‡(
	`ngx_¸óã_dú
(
∑th
, 
NGX_RTMP_DASH_DIR_ACCESS
Ë=
NGX_FILE_ERROR
) {

764 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

765 "dash: " 
ngx_¸óã_dú_n
 " failed on '%V'",

766 &
dacf
->
∑th
);

767  
NGX_ERROR
;

770 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

771 "dash: dúe˘‹y '%V' cª©ed", &
dacf
->
∑th
);

775 i‡(!
	`ngx_is_dú
(&
fi
)) {

776 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

778 &
dacf
->
∑th
);

779  
NGX_ERROR
;

782 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

783 "dash: dúe˘‹y '%V'Éxi°s", &
dacf
->
∑th
);

786 i‡(!
dacf
->
√°ed
) {

787  
NGX_OK
;

790 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_dash_moduÀ
);

792 
Àn
 = 
dacf
->
∑th
.len;

793 i‡(
dacf
->
∑th
.
d©a
[
Àn
 - 1] == '/') {

794 
Àn
--;

797 *
	`ngx_¢¥ötf
(
∑th
, ’©hË- 1, "%*s/%V", 
Àn
, 
dacf
->∑th.
d©a
,

798 &
˘x
->
«me
) = 0;

800 i‡(
	`ngx_fûe_öfo
(
∑th
, &
fi
Ë!
NGX_FILE_ERROR
) {

802 i‡(
	`ngx_is_dú
(&
fi
)) {

803 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

804 "dash: dúe˘‹y '%s'Éxi°s", 
∑th
);

805  
NGX_OK
;

808 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

809 "dash: '%s'Éxi°†™d i†nŸá dúe˘‹y", 
∑th
);

811  
NGX_ERROR
;

814 i‡(
ngx_î∫o
 !
NGX_ENOENT
) {

815 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

816 "dash: " 
ngx_fûe_öfo_n
 " faûed o¿'%s'", 
∑th
);

817  
NGX_ERROR
;

822 i‡(
	`ngx_¸óã_dú
(
∑th
, 
NGX_RTMP_DASH_DIR_ACCESS
Ë=
NGX_FILE_ERROR
) {

823 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

824 "dash: " 
ngx_¸óã_dú_n
 " faûed o¿'%s'", 
∑th
);

825  
NGX_ERROR
;

828 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

829 "dash: dúe˘‹y '%s' cª©ed", 
∑th
);

831  
NGX_OK
;

832 
	}
}

835 
ngx_öt_t


836 
	$ngx_πmp_dash_publish
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_publish_t
 *
v
)

838 
u_ch¨
 *
p
;

839 
size_t
 
Àn
;

840 
ngx_πmp_dash_˘x_t
 *
˘x
;

841 
ngx_πmp_dash_‰ag_t
 *
f
;

842 
ngx_πmp_dash_≠p_c⁄f_t
 *
dacf
;

844 
dacf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_dash_moduÀ
);

845 i‡(
dacf
 =
NULL
 || !dacf->
dash
 || dacf->
∑th
.
Àn
 == 0) {

846 
√xt
;

849 i‡(
s
->
auto_pushed
) {

850 
√xt
;

853 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

854 "dash:Öublish:Çame='%s'Åy≥='%s'", 
v
->
«me
, v->
ty≥
);

856 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_dash_moduÀ
);

858 i‡(
˘x
 =
NULL
) {

859 
˘x
 = 
	`ngx_pˇŒoc
(
s
->
c⁄√˘i⁄
->
poﬁ
, (
ngx_πmp_dash_˘x_t
));

860 i‡(
˘x
 =
NULL
) {

861 
√xt
;

863 
	`ngx_πmp_£t_˘x
(
s
, 
˘x
, 
ngx_πmp_dash_moduÀ
);

866 i‡(
˘x
->
›íed
) {

867 
√xt
;

870 
f
 = 
˘x
->
‰ags
;

871 
	`ngx_memzîo
(
˘x
, (
ngx_πmp_dash_˘x_t
));

872 
˘x
->
‰ags
 = 
f
;

875 i‡(
˘x
->
‰ags
 =
NULL
) {

876 
˘x
->
‰ags
 = 
	`ngx_pˇŒoc
(
s
->
c⁄√˘i⁄
->
poﬁ
,

877 (
ngx_πmp_dash_‰ag_t
) *

878 (
dacf
->
wö‰ags
 * 2 + 1));

879 i‡(
˘x
->
‰ags
 =
NULL
) {

880  
NGX_ERROR
;

884 
˘x
->
id
 = 0;

886 i‡(
	`ngx_°r°r
(
v
->
«me
, "..")) {

887 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

888 "dash: bad såómÇame: '%s'", 
v
->
«me
);

889  
NGX_ERROR
;

892 
˘x
->
«me
.
Àn
 = 
	`ngx_°æí
(
v
->name);

893 
˘x
->
«me
.
d©a
 = 
	`ngx_∑Œoc
(
s
->
c⁄√˘i⁄
->
poﬁ
, ctx->«me.
Àn
 + 1);

895 i‡(
˘x
->
«me
.
d©a
 =
NULL
) {

896  
NGX_ERROR
;

899 *
	`ngx_˝ymem
(
˘x
->
«me
.
d©a
, 
v
->«me, ctx->«me.
Àn
) = 0;

901 
Àn
 = 
dacf
->
∑th
.À¿+ 1 + 
˘x
->
«me
.len + (".mpd");

902 i‡(
dacf
->
√°ed
) {

903 
Àn
 += ("/index") - 1;

906 
˘x
->
∂ayli°
.
d©a
 = 
	`ngx_∑Œoc
(
s
->
c⁄√˘i⁄
->
poﬁ
, 
Àn
);

907 
p
 = 
	`ngx_˝ymem
(
˘x
->
∂ayli°
.
d©a
, 
dacf
->
∑th
.d©a, dacf->∑th.
Àn
);

909 i‡(
p
[-1] != '/') {

910 *
p
++ = '/';

913 
p
 = 
	`ngx_˝ymem
’, 
˘x
->
«me
.
d©a
, ctx->«me.
Àn
);

921 
˘x
->
°ªam
.
Àn
 = 
p
 - ctx->
∂ayli°
.
d©a
 + 1;

922 
˘x
->
°ªam
.
d©a
 = 
	`ngx_∑Œoc
(
s
->
c⁄√˘i⁄
->
poﬁ
,

923 
˘x
->
°ªam
.
Àn
 + 
NGX_INT32_LEN
 +

926 
	`ngx_mem˝y
(
˘x
->
°ªam
.
d©a
, ctx->
∂ayli°
.d©a, ctx->°ªam.
Àn
 - 1);

927 
˘x
->
°ªam
.
d©a
[˘x->°ªam.
Àn
 - 1] = (
dacf
->
√°ed
 ? '/' : '-');

929 i‡(
dacf
->
√°ed
) {

930 
p
 = 
	`ngx_˝ymem
(p, "/index.mpd", ("/index.mpd") - 1);

932 
p
 = 
	`ngx_˝ymem
(p, ".mpd", (".mpd") - 1);

935 
˘x
->
∂ayli°
.
Àn
 = 
p
 - ctx->∂ayli°.
d©a
;

937 *
p
 = 0;

941 
˘x
->
∂ayli°_bak
.
d©a
 = 
	`ngx_∑Œoc
(
s
->
c⁄√˘i⁄
->
poﬁ
,

942 
˘x
->
∂ayli°
.
Àn
 + (".bak"));

943 
p
 = 
	`ngx_˝ymem
(
˘x
->
∂ayli°_bak
.
d©a
, ctx->
∂ayli°
.data,

944 
˘x
->
∂ayli°
.
Àn
);

945 
p
 = 
	`ngx_˝ymem
(p, ".bak", (".bak") - 1);

947 
˘x
->
∂ayli°_bak
.
Àn
 = 
p
 - ctx->∂ayli°_bak.
d©a
;

949 *
p
 = 0;

951 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

953 &
˘x
->
∂ayli°
, &˘x->
∂ayli°_bak
, &˘x->
°ªam
);

955 
˘x
->
°¨t_time
 = *
ngx_ˇched_time
;

957 i‡(
	`ngx_πmp_dash_ísuª_dúe˘‹y
(
s
Ë!
NGX_OK
) {

958  
NGX_ERROR
;

961 
√xt
:

962  
	`√xt_publish
(
s
, 
v
);

963 
	}
}

966 
ngx_öt_t


967 
	$ngx_πmp_dash_˛o£_°ªam
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_˛o£_°ªam_t
 *
v
)

969 
ngx_πmp_dash_˘x_t
 *
˘x
;

970 
ngx_πmp_dash_≠p_c⁄f_t
 *
dacf
;

972 
dacf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_dash_moduÀ
);

974 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_dash_moduÀ
);

976 i‡(
dacf
 =
NULL
 || !dacf->
dash
 || 
˘x
 == NULL) {

977 
√xt
;

980 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

983 
	`ngx_πmp_dash_˛o£_‰agmíts
(
s
);

985 
√xt
:

986  
	`√xt_˛o£_°ªam
(
s
, 
v
);

987 
	}
}

991 
	$ngx_πmp_dash_upd©e_‰agmíts
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_öt_t
 
bound¨y
,

992 
uöt32_t
 
time°amp
)

994 
öt32_t
 
d
;

995 
ngx_öt_t
 
hô
;

996 
ngx_πmp_dash_˘x_t
 *
˘x
;

997 
ngx_πmp_dash_‰ag_t
 *
f
;

998 
ngx_πmp_dash_≠p_c⁄f_t
 *
dacf
;

1000 
dacf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_dash_moduÀ
);

1001 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_dash_moduÀ
);

1002 
f
 = 
	`ngx_πmp_dash_gë_‰ag
(
s
, 
˘x
->
n‰ags
);

1004 
d
 = (
öt32_t
Ë(
time°amp
 - 
f
->timestamp);

1006 i‡(
d
 >= 0) {

1008 
f
->
duøti⁄
 = 
time°amp
 - f->timestamp;

1009 
hô
 = (
f
->
duøti⁄
 >
dacf
->
‰agÀn
);

1015 
hô
 = (-
d
 > 1000);

1018 i‡(
˘x
->
has_video
 && !
hô
) {

1019 
bound¨y
 = 0;

1022 i‡(!
˘x
->
has_video
 && ctx->
has_audio
) {

1023 
bound¨y
 = 
hô
;

1026 i‡(
˘x
->
audio
.
md©_size
 >
NGX_RTMP_DASH_MAX_MDAT
) {

1027 
bound¨y
 = 1;

1030 i‡(
˘x
->
video
.
md©_size
 >
NGX_RTMP_DASH_MAX_MDAT
) {

1031 
bound¨y
 = 1;

1034 i‡(!
˘x
->
›íed
) {

1035 
bound¨y
 = 1;

1038 i‡(
bound¨y
) {

1039 
	`ngx_πmp_dash_˛o£_‰agmíts
(
s
);

1040 
	`ngx_πmp_dash_›í_‰agmíts
(
s
);

1042 
f
 = 
	`ngx_πmp_dash_gë_‰ag
(
s
, 
˘x
->
n‰ags
);

1043 
f
->
time°amp
 =Åimestamp;

1045 
	}
}

1048 
ngx_öt_t


1049 
	$ngx_πmp_dash_≠≥nd
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_chaö_t
 *
ö
,

1050 
ngx_πmp_dash_åack_t
 *
t
, 
ngx_öt_t
 
key
, 
uöt32_t
 
time°amp
, uöt32_à
dñay
)

1052 
u_ch¨
 *
p
;

1053 
size_t
 
size
, 
bsize
;

1054 
ngx_πmp_mp4_ßm∂e_t
 *
sm∂
;

1056 
u_ch¨
 
buf„r
[
NGX_RTMP_DASH_BUFSIZE
];

1058 
p
 = 
buf„r
;

1059 
size
 = 0;

1061 ; 
ö
 && 
size
 < (
buf„r
); i¿ö->
√xt
) {

1063 
bsize
 = (
size_t
Ë(
ö
->
buf
->
œ°
 - in->buf->
pos
);

1064 i‡(
size
 + 
bsize
 > (
buf„r
)) {

1065 
bsize
 = (
size_t
Ë((
buf„r
Ë- 
size
);

1068 
p
 = 
	`ngx_˝ymem
’, 
ö
->
buf
->
pos
, 
bsize
);

1069 
size
 +
bsize
;

1072 
	`ngx_πmp_dash_upd©e_‰agmíts
(
s
, 
key
, 
time°amp
);

1074 i‡(
t
->
ßm∂e_cou¡
 == 0) {

1075 
t
->
óæõ°_¥es_time
 = 
time°amp
;

1078 
t
->
œã°_¥es_time
 = 
time°amp
;

1080 i‡(
t
->
ßm∂e_cou¡
 < 
NGX_RTMP_DASH_MAX_SAMPLES
) {

1082 i‡(
	`ngx_wrôe_fd
(
t
->
fd
, 
buf„r
, 
size
Ë=
NGX_ERROR
) {

1083 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

1084 "dash: " 
ngx_wrôe_fd_n
 " failed");

1085  
NGX_ERROR
;

1088 
sm∂
 = &
t
->
ßm∂es
[t->
ßm∂e_cou¡
];

1090 
sm∂
->
dñay
 = delay;

1091 
sm∂
->
size
 = (
uöt32_t
) size;

1092 
sm∂
->
duøti⁄
 = 0;

1093 
sm∂
->
time°amp
 =Åimestamp;

1094 
sm∂
->
key
 = (key ? 1 : 0);

1096 i‡(
t
->
ßm∂e_cou¡
 > 0) {

1097 
sm∂
 = &
t
->
ßm∂es
[t->
ßm∂e_cou¡
 - 1];

1098 
sm∂
->
duøti⁄
 = 
time°amp
 - smpl->timestamp;

1101 
t
->
ßm∂e_cou¡
++;

1102 
t
->
md©_size
 +(
ngx_uöt_t
Ë
size
;

1105  
NGX_OK
;

1106 
	}
}

1109 
ngx_öt_t


1110 
	$ngx_πmp_dash_audio
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

1111 
ngx_chaö_t
 *
ö
)

1113 
u_ch¨
 
hty≥
;

1114 
ngx_πmp_dash_˘x_t
 *
˘x
;

1115 
ngx_πmp_codec_˘x_t
 *
codec_˘x
;

1116 
ngx_πmp_dash_≠p_c⁄f_t
 *
dacf
;

1118 
dacf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_dash_moduÀ
);

1119 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_dash_moduÀ
);

1120 
codec_˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

1122 i‡(
dacf
 =
NULL
 || !dacf->
dash
 || 
˘x
 == NULL ||

1123 
codec_˘x
 =
NULL
 || 
h
->
mÀn
 < 2)

1125  
NGX_OK
;

1130 i‡(
codec_˘x
->
audio_codec_id
 !
NGX_RTMP_AUDIO_AAC
 ||

1131 
codec_˘x
->
Øc_hódî
 =
NULL
)

1133  
NGX_OK
;

1136 i‡(
ö
->
buf
->
œ°
 - in->buf->
pos
 < 2) {

1137  
NGX_ERROR
;

1142 
hty≥
 = 
ö
->
buf
->
pos
[1];

1143 i‡(
hty≥
 != 1) {

1144  
NGX_OK
;

1147 
˘x
->
has_audio
 = 1;

1151 
ö
->
buf
->
pos
 += 2;

1153  
	`ngx_πmp_dash_≠≥nd
(
s
, 
ö
, &
˘x
->
audio
, 0, 
h
->
time°amp
, 0);

1154 
	}
}

1157 
ngx_öt_t


1158 
	$ngx_πmp_dash_video
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

1159 
ngx_chaö_t
 *
ö
)

1161 
u_ch¨
 *
p
;

1162 
uöt8_t
 
·y≥
, 
hty≥
;

1163 
uöt32_t
 
dñay
;

1164 
ngx_πmp_dash_˘x_t
 *
˘x
;

1165 
ngx_πmp_codec_˘x_t
 *
codec_˘x
;

1166 
ngx_πmp_dash_≠p_c⁄f_t
 *
dacf
;

1168 
dacf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_dash_moduÀ
);

1169 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_dash_moduÀ
);

1170 
codec_˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

1172 i‡(
dacf
 =
NULL
 || !dacf->
dash
 || 
˘x
 =NULL || 
codec_˘x
 == NULL ||

1173 
codec_˘x
->
avc_hódî
 =
NULL
 || 
h
->
mÀn
 < 5)

1175  
NGX_OK
;

1180 i‡(
codec_˘x
->
video_codec_id
 !
NGX_RTMP_VIDEO_H264
) {

1181  
NGX_OK
;

1184 i‡(
ö
->
buf
->
œ°
 - in->buf->
pos
 < 5) {

1185  
NGX_ERROR
;

1188 
·y≥
 = (
ö
->
buf
->
pos
[0] & 0xf0) >> 4;

1192 
hty≥
 = 
ö
->
buf
->
pos
[1];

1193 i‡(
hty≥
 != 1) {

1194  
NGX_OK
;

1197 
p
 = (
u_ch¨
 *Ë&
dñay
;

1199 
p
[0] = 
ö
->
buf
->
pos
[4];

1200 
p
[1] = 
ö
->
buf
->
pos
[3];

1201 
p
[2] = 
ö
->
buf
->
pos
[2];

1202 
p
[3] = 0;

1204 
˘x
->
has_video
 = 1;

1208 
ö
->
buf
->
pos
 += 5;

1210  
	`ngx_πmp_dash_≠≥nd
(
s
, 
ö
, &
˘x
->
video
, 
·y≥
 =1, 
h
->
time°amp
,

1211 
dñay
);

1212 
	}
}

1215 
ngx_öt_t


1216 
	$ngx_πmp_dash_°ªam_begö
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_°ªam_begö_t
 *
v
)

1218  
	`√xt_°ªam_begö
(
s
, 
v
);

1219 
	}
}

1222 
ngx_öt_t


1223 
	$ngx_πmp_dash_°ªam_eof
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_°ªam_eof_t
 *
v
)

1225 
	`ngx_πmp_dash_˛o£_‰agmíts
(
s
);

1227  
	`√xt_°ªam_eof
(
s
, 
v
);

1228 
	}
}

1231 
ngx_öt_t


1232 
	$ngx_πmp_dash_˛ónup_dú
(
ngx_°r_t
 *
µ©h
, 
ngx_m£c_t
 
∂ayÀn
)

1234 
time_t
 
mtime
, 
max_age
;

1235 
u_ch¨
 *
p
;

1236 
u_ch¨
 
∑th
[
NGX_MAX_PATH
 + 1], 
mpd_∑th
[NGX_MAX_PATH + 1];

1237 
ngx_dú_t
 
dú
;

1238 
ngx_îr_t
 
îr
;

1239 
ngx_°r_t
 
«me
, 
•©h
, 
mpd
;

1240 
ngx_öt_t
 
√¡rõs
, 
√ø£d
;

1241 
ngx_fûe_öfo_t
 
fi
;

1243 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
ngx_cy˛e
->
log
, 0,

1244 "dash: cÀ™u∞∑th='%V'ÖœyÀn=%M", 
µ©h
, 
∂ayÀn
);

1246 i‡(
	`ngx_›í_dú
(
µ©h
, &
dú
Ë!
NGX_OK
) {

1247 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
ngx_cy˛e
->
log
, 
ngx_î∫o
,

1248 "dash: cÀ™u∞›í dú faûed '%V'", 
µ©h
);

1249  
NGX_ERROR
;

1252 
√¡rõs
 = 0;

1253 
√ø£d
 = 0;

1256 
	`ngx_£t_î∫o
(0);

1258 i‡(
	`ngx_ªad_dú
(&
dú
Ë=
NGX_ERROR
) {

1259 
îr
 = 
ngx_î∫o
;

1261 i‡(
	`ngx_˛o£_dú
(&
dú
Ë=
NGX_ERROR
) {

1262 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
ngx_cy˛e
->
log
, 
ngx_î∫o
,

1263 "dash: cÀ™u∞" 
ngx_˛o£_dú_n
 " \"%V\" failed",

1264 
µ©h
);

1267 i‡(
îr
 =
NGX_ENOMOREFILES
) {

1268  
√¡rõs
 - 
√ø£d
;

1271 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
ngx_cy˛e
->
log
, 
îr
,

1272 "dash: cÀ™u∞" 
ngx_ªad_dú_n


1273 " '%V' faûed", 
µ©h
);

1274  
NGX_ERROR
;

1277 
«me
.
d©a
 = 
	`ngx_de_«me
(&
dú
);

1278 i‡(
«me
.
d©a
[0] == '.') {

1282 
«me
.
Àn
 = 
	`ngx_de_«mñí
(&
dú
);

1284 
p
 = 
	`ngx_¢¥ötf
(
∑th
, ’©hË- 1, "%V/%V", 
µ©h
, &
«me
);

1285 *
p
 = 0;

1287 
•©h
.
d©a
 = 
∑th
;

1288 
•©h
.
Àn
 = 
p
 - 
∑th
;

1290 
√¡rõs
++;

1292 i‡(!
dú
.
vÆid_öfo
 && 
	`ngx_de_öfo
(
∑th
, &dúË=
NGX_FILE_ERROR
) {

1293 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
ngx_cy˛e
->
log
, 
ngx_î∫o
,

1294 "dash: cÀ™u∞" 
ngx_de_öfo_n
 " \"%V\" failed",

1295 &
•©h
);

1300 i‡(
	`ngx_de_is_dú
(&
dú
)) {

1302 i‡(
	`ngx_πmp_dash_˛ónup_dú
(&
•©h
, 
∂ayÀn
) == 0) {

1303 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
ngx_cy˛e
->
log
, 0,

1304 "dash: cÀ™u∞dú '%V'", &
«me
);

1311 *
p
 = 0;

1313 i‡(
	`ngx_dñëe_dú
(
∑th
Ë=
NGX_FILE_ERROR
) {

1314 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
ngx_cy˛e
->
log
, 
ngx_î∫o
,

1315 "dash: cÀ™u∞" 
ngx_dñëe_dú_n


1316 " faûed o¿'%V'", &
•©h
);

1318 
√ø£d
++;

1325 i‡(!
	`ngx_de_is_fûe
(&
dú
)) {

1329 i‡(
«me
.
Àn
 >8 &&Çame.
d©a
[name.len - 8] == 'i' &&

1330 
«me
.
d©a
[«me.
Àn
 - 7] == 'n' &&

1331 
«me
.
d©a
[«me.
Àn
 - 6] == 'i' &&

1332 
«me
.
d©a
[«me.
Àn
 - 5] == 't' &&

1333 
«me
.
d©a
[«me.
Àn
 - 4] == '.' &&

1334 
«me
.
d©a
[«me.
Àn
 - 3] == 'm' &&

1335 
«me
.
d©a
[«me.
Àn
 - 2] == '4')

1337 i‡(
«me
.
Àn
 == 8) {

1338 
	`ngx_°r_£t
(&
mpd
, "index");

1340 
mpd
.
d©a
 = 
«me
.data;

1341 
mpd
.
Àn
 = 
«me
.len - 9;

1344 
p
 = 
	`ngx_¢¥ötf
(
mpd_∑th
, (mpd_path) - 1, "%V/%V.mpd",

1345 
µ©h
, &
mpd
);

1346 *
p
 = 0;

1348 i‡(
	`ngx_fûe_öfo
(
mpd_∑th
, &
fi
Ë!
NGX_FILE_ERROR
) {

1349 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
ngx_cy˛e
->
log
, 0,

1351 &
«me
, 
mpd_∑th
);

1355 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
ngx_cy˛e
->
log
, 0,

1357 &
«me
, 
mpd_∑th
);

1359 
max_age
 = 0;

1361 } i‡(
«me
.
Àn
 >4 &&Çame.
d©a
[name.len - 4] == '.' &&

1362 
«me
.
d©a
[«me.
Àn
 - 3] == 'm' &&

1363 
«me
.
d©a
[«me.
Àn
 - 2] == '4' &&

1364 
«me
.
d©a
[«me.
Àn
 - 1] == 'v')

1366 
max_age
 = 
∂ayÀn
 / 500;

1368 } i‡(
«me
.
Àn
 >4 &&Çame.
d©a
[name.len - 4] == '.' &&

1369 
«me
.
d©a
[«me.
Àn
 - 3] == 'm' &&

1370 
«me
.
d©a
[«me.
Àn
 - 2] == '4' &&

1371 
«me
.
d©a
[«me.
Àn
 - 1] == 'a')

1373 
max_age
 = 
∂ayÀn
 / 500;

1375 } i‡(
«me
.
Àn
 >4 &&Çame.
d©a
[name.len - 4] == '.' &&

1376 
«me
.
d©a
[«me.
Àn
 - 3] == 'm' &&

1377 
«me
.
d©a
[«me.
Àn
 - 2] == 'p' &&

1378 
«me
.
d©a
[«me.
Àn
 - 1] == 'd')

1380 
max_age
 = 
∂ayÀn
 / 500;

1382 } i‡(
«me
.
Àn
 >4 &&Çame.
d©a
[name.len - 4] == '.' &&

1383 
«me
.
d©a
[«me.
Àn
 - 3] == 'r' &&

1384 
«me
.
d©a
[«me.
Àn
 - 2] == 'a' &&

1385 
«me
.
d©a
[«me.
Àn
 - 1] == 'w')

1387 
max_age
 = 
∂ayÀn
 / 1000;

1390 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
ngx_cy˛e
->
log
, 0,

1391 "dash: cÀ™u∞skù unknow¿fûêty≥ '%V'", &
«me
);

1395 
mtime
 = 
	`ngx_de_mtime
(&
dú
);

1396 i‡(
mtime
 + 
max_age
 > 
ngx_ˇched_time
->
£c
) {

1400 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
ngx_cy˛e
->
log
, 0,

1402 &
«me
, 
mtime
, 
ngx_ˇched_time
->
£c
 - mtime);

1404 i‡(
	`ngx_dñëe_fûe
(
∑th
Ë=
NGX_FILE_ERROR
) {

1405 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
ngx_cy˛e
->
log
, 
ngx_î∫o
,

1406 "dash: cÀ™u∞" 
ngx_dñëe_fûe_n
 " failed on '%V'",

1407 &
•©h
);

1411 
√ø£d
++;

1413 
	}
}

1416 
time_t


1417 
	$ngx_πmp_dash_˛ónup
(*
d©a
)

1419 
ngx_πmp_dash_˛ónup_t
 *
˛ónup
 = 
d©a
;

1421 
	`ngx_πmp_dash_˛ónup_dú
(&
˛ónup
->
∑th
, cÀ™up->
∂ayÀn
);

1423  
˛ónup
->
∂ayÀn
 / 500;

1424 
	}
}

1428 
	$ngx_πmp_dash_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
)

1430 
ngx_πmp_dash_≠p_c⁄f_t
 *
c⁄f
;

1432 
c⁄f
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_dash_≠p_c⁄f_t
));

1433 i‡(
c⁄f
 =
NULL
) {

1434  
NULL
;

1437 
c⁄f
->
dash
 = 
NGX_CONF_UNSET
;

1438 
c⁄f
->
‰agÀn
 = 
NGX_CONF_UNSET_MSEC
;

1439 
c⁄f
->
∂ayÀn
 = 
NGX_CONF_UNSET_MSEC
;

1440 
c⁄f
->
˛ónup
 = 
NGX_CONF_UNSET
;

1441 
c⁄f
->
√°ed
 = 
NGX_CONF_UNSET
;

1443  
c⁄f
;

1444 
	}
}

1448 
	$ngx_πmp_dash_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
∑ª¡
, *
chûd
)

1450 
ngx_πmp_dash_≠p_c⁄f_t
 *
¥ev
 = 
∑ª¡
;

1451 
ngx_πmp_dash_≠p_c⁄f_t
 *
c⁄f
 = 
chûd
;

1452 
ngx_πmp_dash_˛ónup_t
 *
˛ónup
;

1454 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
dash
, 
¥ev
->dash, 0);

1455 
	`ngx_c⁄f_mîge_m£c_vÆue
(
c⁄f
->
‰agÀn
, 
¥ev
->fraglen, 5000);

1456 
	`ngx_c⁄f_mîge_m£c_vÆue
(
c⁄f
->
∂ayÀn
, 
¥ev
->playlen, 30000);

1457 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
˛ónup
, 
¥ev
->cleanup, 1);

1458 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
√°ed
, 
¥ev
->nested, 0);

1460 i‡(
c⁄f
->
‰agÀn
) {

1461 
c⁄f
->
wö‰ags
 = c⁄f->
∂ayÀn
 / c⁄f->
‰agÀn
;

1466 i‡(
c⁄f
->
dash
 && c⁄f->
∑th
.
Àn
 && c⁄f->
˛ónup
) {

1467 i‡(
c⁄f
->
∑th
.
d©a
[c⁄f->∑th.
Àn
 - 1] == '/') {

1468 
c⁄f
->
∑th
.
Àn
--;

1471 
˛ónup
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (*cleanup));

1472 i‡(
˛ónup
 =
NULL
) {

1473  
NGX_CONF_ERROR
;

1476 
˛ónup
->
∑th
 = 
c⁄f
->path;

1477 
˛ónup
->
∂ayÀn
 = 
c⁄f
->playlen;

1479 
c⁄f
->
¶Ÿ
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (*conf->slot));

1480 i‡(
c⁄f
->
¶Ÿ
 =
NULL
) {

1481  
NGX_CONF_ERROR
;

1484 
c⁄f
->
¶Ÿ
->
m™agî
 = 
ngx_πmp_dash_˛ónup
;

1485 
c⁄f
->
¶Ÿ
->
«me
 = c⁄f->
∑th
;

1486 
c⁄f
->
¶Ÿ
->
d©a
 = 
˛ónup
;

1487 
c⁄f
->
¶Ÿ
->
c⁄f_fûe
 = 
cf
->c⁄f_fûe->
fûe
.
«me
.
d©a
;

1488 
c⁄f
->
¶Ÿ
->
löe
 = 
cf
->
c⁄f_fûe
->line;

1490 i‡(
	`ngx_add_∑th
(
cf
, &
c⁄f
->
¶Ÿ
Ë!
NGX_OK
) {

1491  
NGX_CONF_ERROR
;

1495 
	`ngx_c⁄f_mîge_°r_vÆue
(
c⁄f
->
∑th
, 
¥ev
->path, "");

1497  
NGX_CONF_OK
;

1498 
	}
}

1501 
ngx_öt_t


1502 
	$ngx_πmp_dash_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
)

1504 
ngx_πmp_h™dÀr_±
 *
h
;

1505 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
;

1507 
cmcf
 = 
	`ngx_πmp_c⁄f_gë_moduÀ_maö_c⁄f
(
cf
, 
ngx_πmp_c‹e_moduÀ
);

1509 
h
 = 
	`ngx_¨øy_push
(&
cmcf
->
evíts
[
NGX_RTMP_MSG_VIDEO
]);

1510 *
h
 = 
ngx_πmp_dash_video
;

1512 
h
 = 
	`ngx_¨øy_push
(&
cmcf
->
evíts
[
NGX_RTMP_MSG_AUDIO
]);

1513 *
h
 = 
ngx_πmp_dash_audio
;

1515 
√xt_publish
 = 
ngx_πmp_publish
;

1516 
ngx_πmp_publish
 = 
ngx_πmp_dash_publish
;

1518 
√xt_˛o£_°ªam
 = 
ngx_πmp_˛o£_°ªam
;

1519 
ngx_πmp_˛o£_°ªam
 = 
ngx_πmp_dash_˛o£_°ªam
;

1521 
√xt_°ªam_begö
 = 
ngx_πmp_°ªam_begö
;

1522 
ngx_πmp_°ªam_begö
 = 
ngx_πmp_dash_°ªam_begö
;

1524 
√xt_°ªam_eof
 = 
ngx_πmp_°ªam_eof
;

1525 
ngx_πmp_°ªam_eof
 = 
ngx_πmp_dash_°ªam_eof
;

1527  
NGX_OK
;

1528 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/dash/ngx_rtmp_mp4.c

3 
	~<ngx_c⁄fig.h
>

4 
	~<ngx_c‹e.h
>

5 
	~"ngx_πmp_mp4.h
"

6 
	~<ngx_πmp_codec_moduÀ.h
>

9 
ngx_öt_t


10 
	$ngx_πmp_mp4_fõld_32
(
ngx_buf_t
 *
b
, 
uöt32_t
 
n
)

12 
u_ch¨
 
byãs
[4];

14 
byãs
[0] = ((
uöt32_t
Ë
n
 >> 24) & 0xFF;

15 
byãs
[1] = ((
uöt32_t
Ë
n
 >> 16) & 0xFF;

16 
byãs
[2] = ((
uöt32_t
Ë
n
 >> 8) & 0xFF;

17 
byãs
[3] = (
uöt32_t
Ë
n
 & 0xFF;

19 i‡(
b
->
œ°
 + (
byãs
Ë> b->
íd
) {

20  
NGX_ERROR
;

23 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, 
byãs
, (bytes));

25  
NGX_OK
;

26 
	}
}

29 
ngx_öt_t


30 
	$ngx_πmp_mp4_fõld_24
(
ngx_buf_t
 *
b
, 
uöt32_t
 
n
)

32 
u_ch¨
 
byãs
[3];

34 
byãs
[0] = ((
uöt32_t
Ë
n
 >> 16) & 0xFF;

35 
byãs
[1] = ((
uöt32_t
Ë
n
 >> 8) & 0xFF;

36 
byãs
[2] = (
uöt32_t
Ë
n
 & 0xFF;

38 i‡(
b
->
œ°
 + (
byãs
Ë> b->
íd
) {

39  
NGX_ERROR
;

42 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, 
byãs
, (bytes));

44  
NGX_OK
;

45 
	}
}

48 
ngx_öt_t


49 
	$ngx_πmp_mp4_fõld_16
(
ngx_buf_t
 *
b
, 
uöt16_t
 
n
)

51 
u_ch¨
 
byãs
[2];

53 
byãs
[0] = ((
uöt32_t
Ë
n
 >> 8) & 0xFF;

54 
byãs
[1] = (
uöt32_t
Ë
n
 & 0xFF;

56 i‡(
b
->
œ°
 + (
byãs
Ë> b->
íd
) {

57  
NGX_ERROR
;

60 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, 
byãs
, (bytes));

62  
NGX_OK
;

63 
	}
}

66 
ngx_öt_t


67 
	$ngx_πmp_mp4_fõld_8
(
ngx_buf_t
 *
b
, 
uöt8_t
 
n
)

69 
u_ch¨
 
byãs
[1];

71 
byãs
[0] = 
n
 & 0xFF;

73 i‡(
b
->
œ°
 + (
byãs
Ë> b->
íd
) {

74  
NGX_ERROR
;

77 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, 
byãs
, (bytes));

79  
NGX_OK
;

80 
	}
}

83 
ngx_öt_t


84 
	$ngx_πmp_mp4_put_des¸
(
ngx_buf_t
 *
b
, 
èg
, 
size_t
 
size
)

86 
	`ngx_πmp_mp4_fõld_8
(
b
, (
uöt8_t
Ë
èg
);

87 
	`ngx_πmp_mp4_fõld_8
(
b
, 
size
 & 0x7F);

89  
NGX_OK
;

90 
	}
}

93 
ngx_öt_t


94 
	$ngx_πmp_mp4_d©a
(
ngx_buf_t
 *
b
, *
d©a
, 
size_t
 
n
)

96 i‡(
b
->
œ°
 + 
n
 > b->
íd
) {

97  
NGX_ERROR
;

100 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
 *Ë
d©a
, 
n
);

102  
NGX_OK
;

103 
	}
}

106 
ngx_öt_t


107 
	$ngx_πmp_mp4_box
(
ngx_buf_t
 *
b
, c⁄° 
box
[4])

109 i‡(
b
->
œ°
 + 4 > b->
íd
) {

110  
NGX_ERROR
;

113 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
 *Ë
box
, 4);

115  
NGX_OK
;

116 
	}
}

119 
u_ch¨
 *

120 
	$ngx_πmp_mp4_°¨t_box
(
ngx_buf_t
 *
b
, c⁄° 
box
[4])

122 
u_ch¨
 *
p
;

124 
p
 = 
b
->
œ°
;

126 i‡(
	`ngx_πmp_mp4_fõld_32
(
b
, 0Ë!
NGX_OK
) {

127  
NULL
;

130 i‡(
	`ngx_πmp_mp4_box
(
b
, 
box
Ë!
NGX_OK
) {

131  
NULL
;

134  
p
;

135 
	}
}

138 
ngx_öt_t


139 
	$ngx_πmp_mp4_upd©e_box_size
(
ngx_buf_t
 *
b
, 
u_ch¨
 *
p
)

141 
u_ch¨
 *
cuΩos
;

143 i‡(
p
 =
NULL
) {

144  
NGX_ERROR
;

147 
cuΩos
 = 
b
->
œ°
;

149 
b
->
œ°
 = 
p
;

151 
	`ngx_πmp_mp4_fõld_32
(
b
, (
uöt32_t
Ë(
cuΩos
 - 
p
));

153 
b
->
œ°
 = 
cuΩos
;

155  
NGX_OK
;

156 
	}
}

159 
ngx_öt_t


160 
	$ngx_πmp_mp4_wrôe_m©rix
(
ngx_buf_t
 *
buf
, 
uöt32_t
 
a
, uöt32_à
b
, uöt32_à
c
,

161 
uöt32_t
 
d
, uöt32_à
tx
, uöt32_à
ty
)

171 
	`ngx_πmp_mp4_fõld_32
(
buf
, 
a
 << 16);

172 
	`ngx_πmp_mp4_fõld_32
(
buf
, 
b
 << 16);

173 
	`ngx_πmp_mp4_fõld_32
(
buf
, 0);

174 
	`ngx_πmp_mp4_fõld_32
(
buf
, 
c
 << 16);

175 
	`ngx_πmp_mp4_fõld_32
(
buf
, 
d
 << 16);

176 
	`ngx_πmp_mp4_fõld_32
(
buf
, 0);

177 
	`ngx_πmp_mp4_fõld_32
(
buf
, 
tx
 << 16);

178 
	`ngx_πmp_mp4_fõld_32
(
buf
, 
ty
 << 16);

179 
	`ngx_πmp_mp4_fõld_32
(
buf
, 1 << 30);

181  
NGX_OK
;

182 
	}
}

185 
ngx_öt_t


186 
	$ngx_πmp_mp4_wrôe_·yp
(
ngx_buf_t
 *
b
)

188 
u_ch¨
 *
pos
;

190 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "ftyp");

193 
	`ngx_πmp_mp4_box
(
b
, "iso6");

196 
	`ngx_πmp_mp4_fõld_32
(
b
, 1);

199 
	`ngx_πmp_mp4_box
(
b
, "isom");

200 
	`ngx_πmp_mp4_box
(
b
, "iso6");

201 
	`ngx_πmp_mp4_box
(
b
, "dash");

203 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

205  
NGX_OK
;

206 
	}
}

209 
ngx_öt_t


210 
	$ngx_πmp_mp4_wrôe_°yp
(
ngx_buf_t
 *
b
)

212 
u_ch¨
 *
pos
;

214 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "styp");

217 
	`ngx_πmp_mp4_box
(
b
, "iso6");

220 
	`ngx_πmp_mp4_fõld_32
(
b
, 1);

223 
	`ngx_πmp_mp4_box
(
b
, "isom");

224 
	`ngx_πmp_mp4_box
(
b
, "iso6");

225 
	`ngx_πmp_mp4_box
(
b
, "dash");

227 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

229  
NGX_OK
;

230 
	}
}

233 
ngx_öt_t


234 
	$ngx_πmp_mp4_wrôe_mvhd
(
ngx_buf_t
 *
b
)

236 
u_ch¨
 *
pos
;

238 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "mvhd");

241 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

244 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

247 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

250 
	`ngx_πmp_mp4_fõld_32
(
b
, 1000);

253 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

256 
	`ngx_πmp_mp4_fõld_32
(
b
, 0x00010000);

257 
	`ngx_πmp_mp4_fõld_16
(
b
, 0x0100);

258 
	`ngx_πmp_mp4_fõld_16
(
b
, 0);

259 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

260 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

262 
	`ngx_πmp_mp4_wrôe_m©rix
(
b
, 1, 0, 0, 1, 0, 0);

265 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

266 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

267 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

268 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

269 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

270 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

273 
	`ngx_πmp_mp4_fõld_32
(
b
, 1);

275 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

277  
NGX_OK
;

278 
	}
}

281 
ngx_öt_t


282 
	$ngx_πmp_mp4_wrôe_tkhd
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_buf_t
 *
b
,

283 
ngx_πmp_mp4_åack_ty≥_t
 
ây≥
)

285 
u_ch¨
 *
pos
;

286 
ngx_πmp_codec_˘x_t
 *
codec_˘x
;

288 
codec_˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

290 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "tkhd");

293 
	`ngx_πmp_mp4_fõld_8
(
b
, 0);

296 
	`ngx_πmp_mp4_fõld_24
(
b
, 0x0000000f);

299 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

302 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

305 
	`ngx_πmp_mp4_fõld_32
(
b
, 1);

308 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

311 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

314 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

315 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

316 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

319 
	`ngx_πmp_mp4_fõld_16
(
b
, 
ây≥
 =
NGX_RTMP_MP4_VIDEO_TRACK
 ? 0 : 0x0100);

322 
	`ngx_πmp_mp4_fõld_16
(
b
, 0);

324 
	`ngx_πmp_mp4_wrôe_m©rix
(
b
, 1, 0, 0, 1, 0, 0);

326 i‡(
ây≥
 =
NGX_RTMP_MP4_VIDEO_TRACK
) {

327 
	`ngx_πmp_mp4_fõld_32
(
b
, (
uöt32_t
Ë
codec_˘x
->
width
 << 16);

328 
	`ngx_πmp_mp4_fõld_32
(
b
, (
uöt32_t
Ë
codec_˘x
->
height
 << 16);

330 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

331 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

334 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

336  
NGX_OK
;

337 
	}
}

340 
ngx_öt_t


341 
	$ngx_πmp_mp4_wrôe_mdhd
(
ngx_buf_t
 *
b
)

343 
u_ch¨
 *
pos
;

345 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "mdhd");

348 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

351 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

354 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

357 
	`ngx_πmp_mp4_fõld_32
(
b
, 1000);

360 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

363 
	`ngx_πmp_mp4_fõld_16
(
b
, 0x15C7);

366 
	`ngx_πmp_mp4_fõld_16
(
b
, 0);

368 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

370  
NGX_OK
;

371 
	}
}

374 
ngx_öt_t


375 
	$ngx_πmp_mp4_wrôe_hdÃ
(
ngx_buf_t
 *
b
, 
ngx_πmp_mp4_åack_ty≥_t
 
ây≥
)

377 
u_ch¨
 *
pos
;

379 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "hdlr");

382 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

385 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

387 i‡(
ây≥
 =
NGX_RTMP_MP4_VIDEO_TRACK
) {

388 
	`ngx_πmp_mp4_box
(
b
, "vide");

390 
	`ngx_πmp_mp4_box
(
b
, "soun");

394 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

395 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

396 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

398 i‡(
ây≥
 =
NGX_RTMP_MP4_VIDEO_TRACK
) {

400 
	`ngx_πmp_mp4_d©a
(
b
, "VideoHandler", ("VideoHandler"));

403 
	`ngx_πmp_mp4_d©a
(
b
, "SoundHandler", ("SoundHandler"));

406 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

408  
NGX_OK
;

409 
	}
}

412 
ngx_öt_t


413 
	$ngx_πmp_mp4_wrôe_vmhd
(
ngx_buf_t
 *
b
)

416 
	`ngx_πmp_mp4_fõld_32
(
b
, 20);

418 
	`ngx_πmp_mp4_box
(
b
, "vmhd");

421 
	`ngx_πmp_mp4_fõld_32
(
b
, 0x01);

424 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

425 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

427  
NGX_OK
;

428 
	}
}

431 
ngx_öt_t


432 
	$ngx_πmp_mp4_wrôe_smhd
(
ngx_buf_t
 *
b
)

435 
	`ngx_πmp_mp4_fõld_32
(
b
, 16);

437 
	`ngx_πmp_mp4_box
(
b
, "smhd");

440 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

443 
	`ngx_πmp_mp4_fõld_16
(
b
, 0);

444 
	`ngx_πmp_mp4_fõld_16
(
b
, 0);

446  
NGX_OK
;

447 
	}
}

450 
ngx_öt_t


451 
	$ngx_πmp_mp4_wrôe_dªf
(
ngx_buf_t
 *
b
)

453 
u_ch¨
 *
pos
;

455 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "dref");

458 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

461 
	`ngx_πmp_mp4_fõld_32
(
b
, 1);

464 
	`ngx_πmp_mp4_fõld_32
(
b
, 0xc);

466 
	`ngx_πmp_mp4_box
(
b
, "url ");

469 
	`ngx_πmp_mp4_fõld_32
(
b
, 0x00000001);

471 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

473  
NGX_OK
;

474 
	}
}

477 
ngx_öt_t


478 
	$ngx_πmp_mp4_wrôe_döf
(
ngx_buf_t
 *
b
)

480 
u_ch¨
 *
pos
;

482 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "dinf");

484 
	`ngx_πmp_mp4_wrôe_dªf
(
b
);

486 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

488  
NGX_OK
;

489 
	}
}

492 
ngx_öt_t


493 
	$ngx_πmp_mp4_wrôe_avcc
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_buf_t
 *
b
)

495 
u_ch¨
 *
pos
, *
p
;

496 
ngx_chaö_t
 *
ö
;

497 
ngx_πmp_codec_˘x_t
 *
codec_˘x
;

499 
codec_˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

501 i‡(
codec_˘x
 =
NULL
) {

502  
NGX_ERROR
;

505 
ö
 = 
codec_˘x
->
avc_hódî
;

506 i‡(
ö
 =
NULL
) {

507  
NGX_ERROR
;

510 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "avcC");

523 
p
 = 
ö
->
buf
->
pos
 + 5;

525 i‡(
p
 < 
ö
->
buf
->
œ°
) {

526 
	`ngx_πmp_mp4_d©a
(
b
, 
p
, (
size_t
Ë(
ö
->
buf
->
œ°
 -Ö));

528 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

532 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

534  
NGX_OK
;

535 
	}
}

538 
ngx_öt_t


539 
	$ngx_πmp_mp4_wrôe_video
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_buf_t
 *
b
)

541 
u_ch¨
 *
pos
;

542 
ngx_πmp_codec_˘x_t
 *
codec_˘x
;

544 
codec_˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

546 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "avc1");

549 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

550 
	`ngx_πmp_mp4_fõld_16
(
b
, 0);

553 
	`ngx_πmp_mp4_fõld_16
(
b
, 1);

556 
	`ngx_πmp_mp4_fõld_16
(
b
, 0);

557 
	`ngx_πmp_mp4_fõld_16
(
b
, 0);

560 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

561 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

562 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

565 
	`ngx_πmp_mp4_fõld_16
(
b
, (
uöt16_t
Ë
codec_˘x
->
width
);

566 
	`ngx_πmp_mp4_fõld_16
(
b
, (
uöt16_t
Ë
codec_˘x
->
height
);

569 
	`ngx_πmp_mp4_fõld_32
(
b
, 0x00480000);

570 
	`ngx_πmp_mp4_fõld_32
(
b
, 0x00480000);

573 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

576 
	`ngx_πmp_mp4_fõld_16
(
b
, 1);

579 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

580 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

581 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

584 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

585 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

586 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

587 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

588 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

589 
	`ngx_πmp_mp4_fõld_16
(
b
, 0x18);

590 
	`ngx_πmp_mp4_fõld_16
(
b
, 0xffff);

592 
	`ngx_πmp_mp4_wrôe_avcc
(
s
, 
b
);

594 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

596  
NGX_OK
;

597 
	}
}

600 
ngx_öt_t


601 
	$ngx_πmp_mp4_wrôe_esds
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_buf_t
 *
b
)

603 
size_t
 
dsi_Àn
;

604 
u_ch¨
 *
pos
, *
dsi
;

605 
ngx_buf_t
 *
db
;

606 
ngx_πmp_codec_˘x_t
 *
codec_˘x
;

608 
codec_˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

610 i‡(
codec_˘x
 =
NULL
 || codec_˘x->
Øc_hódî
 == NULL) {

611  
NGX_ERROR
;

614 
db
 = 
codec_˘x
->
Øc_hódî
->
buf
;

615 i‡(
db
 =
NULL
) {

616  
NGX_ERROR
;

619 
dsi
 = 
db
->
pos
 + 2;

620 i‡(
dsi
 > 
db
->
œ°
) {

621  
NGX_ERROR
;

624 
dsi_Àn
 = 
db
->
œ°
 - 
dsi
;

626 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "esds");

629 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

634 
	`ngx_πmp_mp4_put_des¸
(
b
, 0x03, 23 + 
dsi_Àn
);

637 
	`ngx_πmp_mp4_fõld_16
(
b
, 1);

640 
	`ngx_πmp_mp4_fõld_8
(
b
, 0);

645 
	`ngx_πmp_mp4_put_des¸
(
b
, 0x04, 15 + 
dsi_Àn
);

648 
	`ngx_πmp_mp4_fõld_8
(
b
, 0x40);

651 
	`ngx_πmp_mp4_fõld_8
(
b
, 0x15);

654 
	`ngx_πmp_mp4_fõld_24
(
b
, 0);

657 
	`ngx_πmp_mp4_fõld_32
(
b
, 0x0001F151);

660 
	`ngx_πmp_mp4_fõld_32
(
b
, 0x0001F14D);

665 
	`ngx_πmp_mp4_put_des¸
(
b
, 0x05, 
dsi_Àn
);

666 
	`ngx_πmp_mp4_d©a
(
b
, 
dsi
, 
dsi_Àn
);

671 
	`ngx_πmp_mp4_put_des¸
(
b
, 0x06, 1);

672 
	`ngx_πmp_mp4_fõld_8
(
b
, 0x02);

674 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

676  
NGX_OK
;

677 
	}
}

680 
ngx_öt_t


681 
	$ngx_πmp_mp4_wrôe_audio
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_buf_t
 *
b
)

683 
u_ch¨
 *
pos
;

684 
ngx_πmp_codec_˘x_t
 *
codec_˘x
;

686 
codec_˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

688 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "mp4a");

691 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

692 
	`ngx_πmp_mp4_fõld_16
(
b
, 0);

695 
	`ngx_πmp_mp4_fõld_16
(
b
, 1);

698 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

699 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

702 
	`ngx_πmp_mp4_fõld_16
(
b
, (
uöt16_t
Ë
codec_˘x
->
audio_ch™√ls
);

705 
	`ngx_πmp_mp4_fõld_16
(
b
, (
uöt16_t
Ë(
codec_˘x
->
ßm∂e_size
 * 8));

708 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

711 
	`ngx_πmp_mp4_fõld_16
(
b
, 1000);

714 
	`ngx_πmp_mp4_fõld_16
(
b
, (
uöt16_t
Ë
codec_˘x
->
ßm∂e_øã
);

716 
	`ngx_πmp_mp4_wrôe_esds
(
s
, 
b
);

719 
	`ngx_πmp_mp4_fõld_32
(
b
, 8);

722 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

724 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

726  
NGX_OK
;

727 
	}
}

730 
ngx_öt_t


731 
	$ngx_πmp_mp4_wrôe_°sd
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_buf_t
 *
b
,

732 
ngx_πmp_mp4_åack_ty≥_t
 
ây≥
)

734 
u_ch¨
 *
pos
;

736 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "stsd");

739 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

742 
	`ngx_πmp_mp4_fõld_32
(
b
, 1);

744 i‡(
ây≥
 =
NGX_RTMP_MP4_VIDEO_TRACK
) {

745 
	`ngx_πmp_mp4_wrôe_video
(
s
, 
b
);

747 
	`ngx_πmp_mp4_wrôe_audio
(
s
, 
b
);

750 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

752  
NGX_OK
;

753 
	}
}

756 
ngx_öt_t


757 
	$ngx_πmp_mp4_wrôe_°ts
(
ngx_buf_t
 *
b
)

759 
u_ch¨
 *
pos
;

761 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "stts");

763 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

764 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

766 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

768  
NGX_OK
;

769 
	}
}

772 
ngx_öt_t


773 
	$ngx_πmp_mp4_wrôe_°sc
(
ngx_buf_t
 *
b
)

775 
u_ch¨
 *
pos
;

777 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "stsc");

779 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

780 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

782 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

784  
NGX_OK
;

785 
	}
}

788 
ngx_öt_t


789 
	$ngx_πmp_mp4_wrôe_°sz
(
ngx_buf_t
 *
b
)

791 
u_ch¨
 *
pos
;

793 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "stsz");

795 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

796 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

797 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

799 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

801  
NGX_OK
;

802 
	}
}

805 
ngx_öt_t


806 
	$ngx_πmp_mp4_wrôe_°co
(
ngx_buf_t
 *
b
)

808 
u_ch¨
 *
pos
;

810 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "stco");

812 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

813 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

815 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

817  
NGX_OK
;

818 
	}
}

821 
ngx_öt_t


822 
	$ngx_πmp_mp4_wrôe_°bl
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_buf_t
 *
b
,

823 
ngx_πmp_mp4_åack_ty≥_t
 
ây≥
)

825 
u_ch¨
 *
pos
;

827 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "stbl");

829 
	`ngx_πmp_mp4_wrôe_°sd
(
s
, 
b
, 
ây≥
);

830 
	`ngx_πmp_mp4_wrôe_°ts
(
b
);

831 
	`ngx_πmp_mp4_wrôe_°sc
(
b
);

832 
	`ngx_πmp_mp4_wrôe_°sz
(
b
);

833 
	`ngx_πmp_mp4_wrôe_°co
(
b
);

835 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

837  
NGX_OK
;

838 
	}
}

841 
ngx_öt_t


842 
	$ngx_πmp_mp4_wrôe_möf
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_buf_t
 *
b
,

843 
ngx_πmp_mp4_åack_ty≥_t
 
ây≥
)

845 
u_ch¨
 *
pos
;

847 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "minf");

849 i‡(
ây≥
 =
NGX_RTMP_MP4_VIDEO_TRACK
) {

850 
	`ngx_πmp_mp4_wrôe_vmhd
(
b
);

852 
	`ngx_πmp_mp4_wrôe_smhd
(
b
);

855 
	`ngx_πmp_mp4_wrôe_döf
(
b
);

856 
	`ngx_πmp_mp4_wrôe_°bl
(
s
, 
b
, 
ây≥
);

858 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

860  
NGX_OK
;

861 
	}
}

864 
ngx_öt_t


865 
	$ngx_πmp_mp4_wrôe_mdü
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_buf_t
 *
b
,

866 
ngx_πmp_mp4_åack_ty≥_t
 
ây≥
)

868 
u_ch¨
 *
pos
;

870 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "mdia");

872 
	`ngx_πmp_mp4_wrôe_mdhd
(
b
);

873 
	`ngx_πmp_mp4_wrôe_hdÃ
(
b
, 
ây≥
);

874 
	`ngx_πmp_mp4_wrôe_möf
(
s
, 
b
, 
ây≥
);

876 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

878  
NGX_OK
;

879 
	}
}

881 
ngx_öt_t


882 
	$ngx_πmp_mp4_wrôe_åak
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_buf_t
 *
b
,

883 
ngx_πmp_mp4_åack_ty≥_t
 
ây≥
)

885 
u_ch¨
 *
pos
;

887 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "trak");

889 
	`ngx_πmp_mp4_wrôe_tkhd
(
s
, 
b
, 
ây≥
);

890 
	`ngx_πmp_mp4_wrôe_mdü
(
s
, 
b
, 
ây≥
);

892 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

894  
NGX_OK
;

895 
	}
}

898 
ngx_öt_t


899 
	$ngx_πmp_mp4_wrôe_mvex
(
ngx_buf_t
 *
b
)

901 
u_ch¨
 *
pos
;

903 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "mvex");

905 
	`ngx_πmp_mp4_fõld_32
(
b
, 0x20);

907 
	`ngx_πmp_mp4_box
(
b
, "trex");

910 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

913 
	`ngx_πmp_mp4_fõld_32
(
b
, 1);

916 
	`ngx_πmp_mp4_fõld_32
(
b
, 1);

919 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

922 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

925 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

927 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

929  
NGX_OK
;

930 
	}
}

933 
ngx_öt_t


934 
	$ngx_πmp_mp4_wrôe_moov
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_buf_t
 *
b
,

935 
ngx_πmp_mp4_åack_ty≥_t
 
ây≥
)

937 
u_ch¨
 *
pos
;

939 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "moov");

941 
	`ngx_πmp_mp4_wrôe_mvhd
(
b
);

942 
	`ngx_πmp_mp4_wrôe_mvex
(
b
);

943 
	`ngx_πmp_mp4_wrôe_åak
(
s
, 
b
, 
ây≥
);

945 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

947  
NGX_OK
;

948 
	}
}

951 
ngx_öt_t


952 
	$ngx_πmp_mp4_wrôe_tfhd
(
ngx_buf_t
 *
b
)

954 
u_ch¨
 *
pos
;

956 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "tfhd");

959 
	`ngx_πmp_mp4_fõld_32
(
b
, 0x00020000);

962 
	`ngx_πmp_mp4_fõld_32
(
b
, 1);

964 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

966  
NGX_OK
;

967 
	}
}

970 
ngx_öt_t


971 
	$ngx_πmp_mp4_wrôe_tfdt
(
ngx_buf_t
 *
b
, 
uöt32_t
 
óæõ°_¥es_time
)

973 
u_ch¨
 *
pos
;

975 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "tfdt");

978 
	`ngx_πmp_mp4_fõld_32
(
b
, 0x00000000);

979 
	`ngx_πmp_mp4_fõld_32
(
b
, 
óæõ°_¥es_time
);

981 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

983  
NGX_OK
;

984 
	}
}

987 
ngx_öt_t


988 
	$ngx_πmp_mp4_wrôe_åun
(
ngx_buf_t
 *
b
, 
uöt32_t
 
ßm∂e_cou¡
,

989 
ngx_πmp_mp4_ßm∂e_t
 *
ßm∂es
, 
ngx_uöt_t
 
ßm∂e_mask
, 
u_ch¨
 *
moof_pos
)

991 
u_ch¨
 *
pos
;

992 
uöt32_t
 
i
, 
off£t
, 
nôems
, 
Êags
;

994 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "trun");

996 
nôems
 = 0;

999 
Êags
 = 0x01;

1001 i‡(
ßm∂e_mask
 & 
NGX_RTMP_MP4_SAMPLE_DURATION
) {

1002 
nôems
++;

1003 
Êags
 |= 0x000100;

1006 i‡(
ßm∂e_mask
 & 
NGX_RTMP_MP4_SAMPLE_SIZE
) {

1007 
nôems
++;

1008 
Êags
 |= 0x000200;

1011 i‡(
ßm∂e_mask
 & 
NGX_RTMP_MP4_SAMPLE_KEY
) {

1012 
nôems
++;

1013 
Êags
 |= 0x000400;

1016 i‡(
ßm∂e_mask
 & 
NGX_RTMP_MP4_SAMPLE_DELAY
) {

1017 
nôems
++;

1018 
Êags
 |= 0x000800;

1021 
off£t
 = (
pos
 - 
moof_pos
Ë+ 20 + (
ßm∂e_cou¡
 * 
nôems
 * 4) + 8;

1023 
	`ngx_πmp_mp4_fõld_32
(
b
, 
Êags
);

1024 
	`ngx_πmp_mp4_fõld_32
(
b
, 
ßm∂e_cou¡
);

1025 
	`ngx_πmp_mp4_fõld_32
(
b
, 
off£t
);

1027 
i
 = 0; i < 
ßm∂e_cou¡
; i++, 
ßm∂es
++) {

1029 i‡(
ßm∂e_mask
 & 
NGX_RTMP_MP4_SAMPLE_DURATION
) {

1030 
	`ngx_πmp_mp4_fõld_32
(
b
, 
ßm∂es
->
duøti⁄
);

1033 i‡(
ßm∂e_mask
 & 
NGX_RTMP_MP4_SAMPLE_SIZE
) {

1034 
	`ngx_πmp_mp4_fõld_32
(
b
, 
ßm∂es
->
size
);

1037 i‡(
ßm∂e_mask
 & 
NGX_RTMP_MP4_SAMPLE_KEY
) {

1038 
	`ngx_πmp_mp4_fõld_32
(
b
, 
ßm∂es
->
key
 ? 0x00000000 : 0x00010000);

1041 i‡(
ßm∂e_mask
 & 
NGX_RTMP_MP4_SAMPLE_DELAY
) {

1042 
	`ngx_πmp_mp4_fõld_32
(
b
, 
ßm∂es
->
dñay
);

1046 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

1048  
NGX_OK
;

1049 
	}
}

1052 
ngx_öt_t


1053 
	$ngx_πmp_mp4_wrôe_åaf
(
ngx_buf_t
 *
b
, 
uöt32_t
 
óæõ°_¥es_time
,

1054 
uöt32_t
 
ßm∂e_cou¡
, 
ngx_πmp_mp4_ßm∂e_t
 *
ßm∂es
,

1055 
ngx_uöt_t
 
ßm∂e_mask
, 
u_ch¨
 *
moof_pos
)

1057 
u_ch¨
 *
pos
;

1059 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "traf");

1061 
	`ngx_πmp_mp4_wrôe_tfhd
(
b
);

1062 
	`ngx_πmp_mp4_wrôe_tfdt
(
b
, 
óæõ°_¥es_time
);

1063 
	`ngx_πmp_mp4_wrôe_åun
(
b
, 
ßm∂e_cou¡
, 
ßm∂es
, 
ßm∂e_mask
, 
moof_pos
);

1065 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

1067  
NGX_OK
;

1068 
	}
}

1071 
ngx_öt_t


1072 
	$ngx_πmp_mp4_wrôe_mfhd
(
ngx_buf_t
 *
b
, 
uöt32_t
 
ödex
)

1074 
u_ch¨
 *
pos
;

1076 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "mfhd");

1079 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

1082 
	`ngx_πmp_mp4_fõld_32
(
b
, 
ödex
);

1084 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

1086  
NGX_OK
;

1087 
	}
}

1090 
ngx_öt_t


1091 
	$ngx_πmp_mp4_wrôe_sidx
(
ngx_buf_t
 *
b
, 
ngx_uöt_t
 
ª„ªn˚_size
,

1092 
uöt32_t
 
óæõ°_¥es_time
, uöt32_à
œã°_¥es_time
)

1094 
u_ch¨
 *
pos
;

1095 
uöt32_t
 
duøti⁄
;

1097 
duøti⁄
 = 
œã°_¥es_time
 - 
óæõ°_¥es_time
;

1099 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "sidx");

1102 
	`ngx_πmp_mp4_fõld_32
(
b
, 0);

1105 
	`ngx_πmp_mp4_fõld_32
(
b
, 1);

1108 
	`ngx_πmp_mp4_fõld_32
(
b
, 1000);

1111 
	`ngx_πmp_mp4_fõld_32
(
b
, 
óæõ°_¥es_time
);

1114 
	`ngx_πmp_mp4_fõld_32
(
b
, 
duøti⁄
);

1117 
	`ngx_πmp_mp4_fõld_16
(
b
, 0);

1120 
	`ngx_πmp_mp4_fõld_16
(
b
, 1);

1123 
	`ngx_πmp_mp4_fõld_32
(
b
, 
ª„ªn˚_size
);

1126 
	`ngx_πmp_mp4_fõld_32
(
b
, 
duøti⁄
);

1129 
	`ngx_πmp_mp4_fõld_8
(
b
, 0x90);

1132 
	`ngx_πmp_mp4_fõld_24
(
b
, 0);

1134 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

1136  
NGX_OK
;

1137 
	}
}

1140 
ngx_öt_t


1141 
	$ngx_πmp_mp4_wrôe_moof
(
ngx_buf_t
 *
b
, 
uöt32_t
 
óæõ°_¥es_time
,

1142 
uöt32_t
 
ßm∂e_cou¡
, 
ngx_πmp_mp4_ßm∂e_t
 *
ßm∂es
,

1143 
ngx_uöt_t
 
ßm∂e_mask
, 
uöt32_t
 
ödex
)

1145 
u_ch¨
 *
pos
;

1147 
pos
 = 
	`ngx_πmp_mp4_°¨t_box
(
b
, "moof");

1149 
	`ngx_πmp_mp4_wrôe_mfhd
(
b
, 
ödex
);

1150 
	`ngx_πmp_mp4_wrôe_åaf
(
b
, 
óæõ°_¥es_time
, 
ßm∂e_cou¡
, 
ßm∂es
,

1151 
ßm∂e_mask
, 
pos
);

1153 
	`ngx_πmp_mp4_upd©e_box_size
(
b
, 
pos
);

1155  
NGX_OK
;

1156 
	}
}

1159 
ngx_uöt_t


1160 
	$ngx_πmp_mp4_wrôe_md©
(
ngx_buf_t
 *
b
, 
ngx_uöt_t
 
size
)

1162 
	`ngx_πmp_mp4_fõld_32
(
b
, 
size
);

1164 
	`ngx_πmp_mp4_box
(
b
, "mdat");

1166  
NGX_OK
;

1167 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/dash/ngx_rtmp_mp4.h

3 #i‚de‡
_NGX_RTMP_MP4_H_INCLUDED_


4 
	#_NGX_RTMP_MP4_H_INCLUDED_


	)

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~<ngx_πmp.h
>

12 
	#NGX_RTMP_MP4_SAMPLE_SIZE
 0x01

	)

13 
	#NGX_RTMP_MP4_SAMPLE_DURATION
 0x02

	)

14 
	#NGX_RTMP_MP4_SAMPLE_DELAY
 0x04

	)

15 
	#NGX_RTMP_MP4_SAMPLE_KEY
 0x08

	)

19 
uöt32_t
 
	msize
;

20 
uöt32_t
 
	mduøti⁄
;

21 
uöt32_t
 
	mdñay
;

22 
uöt32_t
 
	mtime°amp
;

23 
	mkey
:1;

24 } 
	tngx_πmp_mp4_ßm∂e_t
;

28 
	mNGX_RTMP_MP4_FILETYPE_INIT
,

29 
	mNGX_RTMP_MP4_FILETYPE_SEG


30 } 
	tngx_πmp_mp4_fûe_ty≥_t
;

34 
	mNGX_RTMP_MP4_VIDEO_TRACK
,

35 
	mNGX_RTMP_MP4_AUDIO_TRACK


36 } 
	tngx_πmp_mp4_åack_ty≥_t
;

39 
ngx_öt_t
 
ngx_πmp_mp4_wrôe_·yp
(
ngx_buf_t
 *
b
);

40 
ngx_öt_t
 
ngx_πmp_mp4_wrôe_°yp
(
ngx_buf_t
 *
b
);

41 
ngx_öt_t
 
ngx_πmp_mp4_wrôe_moov
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_buf_t
 *
b
,

42 
ngx_πmp_mp4_åack_ty≥_t
 
ây≥
);

43 
ngx_öt_t
 
ngx_πmp_mp4_wrôe_moof
(
ngx_buf_t
 *
b
, 
uöt32_t
 
óæõ°_¥es_time
,

44 
uöt32_t
 
ßm∂e_cou¡
, 
ngx_πmp_mp4_ßm∂e_t
 *
ßm∂es
,

45 
ngx_uöt_t
 
ßm∂e_mask
, 
uöt32_t
 
ödex
);

46 
ngx_öt_t
 
ngx_πmp_mp4_wrôe_sidx
(
ngx_buf_t
 *
b
,

47 
ngx_uöt_t
 
ª„ªn˚_size
, 
uöt32_t
 
óæõ°_¥es_time
,

48 
uöt32_t
 
œã°_¥es_time
);

49 
ngx_uöt_t
 
ngx_πmp_mp4_wrôe_md©
(
ngx_buf_t
 *
b
,Çgx_uöt_à
size
);

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/hls/ngx_rtmp_hls_module.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~<ngx_πmp.h
>

10 
	~<ngx_πmp_cmd_moduÀ.h
>

11 
	~<ngx_πmp_codec_moduÀ.h
>

12 
	~"ngx_πmp_m≥gts.h
"

15 
ngx_πmp_publish_±
 
	g√xt_publish
;

16 
ngx_πmp_˛o£_°ªam_±
 
	g√xt_˛o£_°ªam
;

17 
ngx_πmp_°ªam_begö_±
 
	g√xt_°ªam_begö
;

18 
ngx_πmp_°ªam_eof_±
 
	g√xt_°ªam_eof
;

21 * 
ngx_πmp_hls_v¨ü¡
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
,

22 *
c⁄f
);

23 
ngx_öt_t
 
ngx_πmp_hls_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
);

24 * 
ngx_πmp_hls_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
);

25 * 
ngx_πmp_hls_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
,

26 *
∑ª¡
, *
chûd
);

27 
ngx_öt_t
 
ngx_πmp_hls_Êush_audio
(
ngx_πmp_£ssi⁄_t
 *
s
);

28 
ngx_öt_t
 
ngx_πmp_hls_ísuª_dúe˘‹y
(
ngx_πmp_£ssi⁄_t
 *
s
,

29 
ngx_°r_t
 *
∑th
);

32 
	#NGX_RTMP_HLS_BUFSIZE
 (1024*1024)

	)

33 
	#NGX_RTMP_HLS_DIR_ACCESS
 0744

	)

37 
uöt64_t
 
	mid
;

38 
uöt64_t
 
	mkey_id
;

39 
	mduøti⁄
;

40 
	ma˘ive
:1;

41 
	mdisc⁄t
:1;

42 } 
	tngx_πmp_hls_‰ag_t
;

46 
ngx_°r_t
 
	msuffix
;

47 
ngx_¨øy_t
 
	m¨gs
;

48 } 
	tngx_πmp_hls_v¨ü¡_t
;

52 
	m›íed
:1;

54 
ngx_πmp_m≥gts_fûe_t
 
	mfûe
;

56 
ngx_°r_t
 
	m∂ayli°
;

57 
ngx_°r_t
 
	m∂ayli°_bak
;

58 
ngx_°r_t
 
	mv¨_∂ayli°
;

59 
ngx_°r_t
 
	mv¨_∂ayli°_bak
;

60 
ngx_°r_t
 
	m°ªam
;

61 
ngx_°r_t
 
	mkeyfûe
;

62 
ngx_°r_t
 
	m«me
;

63 
u_ch¨
 
	mkey
[16];

65 
uöt64_t
 
	m‰ag
;

66 
uöt64_t
 
	m‰ag_ts
;

67 
uöt64_t
 
	mkey_id
;

68 
ngx_uöt_t
 
	mn‰ags
;

69 
ngx_πmp_hls_‰ag_t
 *
	m‰ags
;

71 
ngx_uöt_t
 
	maudio_cc
;

72 
ngx_uöt_t
 
	mvideo_cc
;

73 
ngx_uöt_t
 
	mkey_‰ags
;

75 
uöt64_t
 
	ma‰ame_ba£
;

76 
uöt64_t
 
	ma‰ame_num
;

78 
ngx_buf_t
 *
	ma‰ame
;

79 
uöt64_t
 
	ma‰ame_±s
;

81 
ngx_πmp_hls_v¨ü¡_t
 *
	mv¨
;

82 } 
	tngx_πmp_hls_˘x_t
;

86 
ngx_°r_t
 
	m∑th
;

87 
ngx_m£c_t
 
	m∂ayÀn
;

88 
ngx_uöt_t
 
	m‰ags_≥r_key
;

89 } 
	tngx_πmp_hls_˛ónup_t
;

93 
ngx_Êag_t
 
	mhls
;

94 
ngx_m£c_t
 
	m‰agÀn
;

95 
ngx_m£c_t
 
	mmax_‰agÀn
;

96 
ngx_m£c_t
 
	mmuxdñay
;

97 
ngx_m£c_t
 
	msync
;

98 
ngx_m£c_t
 
	m∂ayÀn
;

99 
ngx_uöt_t
 
	mwö‰ags
;

100 
ngx_Êag_t
 
	mc⁄töuous
;

101 
ngx_Êag_t
 
	m√°ed
;

102 
ngx_°r_t
 
	m∑th
;

103 
ngx_uöt_t
 
	m«mög
;

104 
ngx_uöt_t
 
	m¶icög
;

105 
ngx_uöt_t
 
	mty≥
;

106 
ngx_∑th_t
 *
	m¶Ÿ
;

107 
ngx_m£c_t
 
	mmax_audio_dñay
;

108 
size_t
 
	maudio_buf„r_size
;

109 
ngx_Êag_t
 
	m˛ónup
;

110 
ngx_¨øy_t
 *
	mv¨ü¡
;

111 
ngx_°r_t
 
	mba£_uæ
;

112 
ngx_öt_t
 
	mgønuœrôy
;

113 
ngx_Êag_t
 
	mkeys
;

114 
ngx_°r_t
 
	mkey_∑th
;

115 
ngx_°r_t
 
	mkey_uæ
;

116 
ngx_uöt_t
 
	m‰ags_≥r_key
;

117 } 
	tngx_πmp_hls_≠p_c⁄f_t
;

120 
	#NGX_RTMP_HLS_NAMING_SEQUENTIAL
 1

	)

121 
	#NGX_RTMP_HLS_NAMING_TIMESTAMP
 2

	)

122 
	#NGX_RTMP_HLS_NAMING_SYSTEM
 3

	)

125 
	#NGX_RTMP_HLS_SLICING_PLAIN
 1

	)

126 
	#NGX_RTMP_HLS_SLICING_ALIGNED
 2

	)

129 
	#NGX_RTMP_HLS_TYPE_LIVE
 1

	)

130 
	#NGX_RTMP_HLS_TYPE_EVENT
 2

	)

133 
ngx_c⁄f_íum_t
 
	gngx_πmp_hls_«mög_¶Ÿs
[] = {

134 { 
ngx_°rög
("£quítül"), 
NGX_RTMP_HLS_NAMING_SEQUENTIAL
 },

135 { 
ngx_°rög
("time°amp"), 
NGX_RTMP_HLS_NAMING_TIMESTAMP
 },

136 { 
ngx_°rög
("sy°em"), 
NGX_RTMP_HLS_NAMING_SYSTEM
 },

137 { 
ngx_nuŒ_°rög
, 0 }

141 
ngx_c⁄f_íum_t
 
	gngx_πmp_hls_¶icög_¶Ÿs
[] = {

142 { 
ngx_°rög
("∂aö"), 
NGX_RTMP_HLS_SLICING_PLAIN
 },

143 { 
ngx_°rög
("Æig√d"), 
NGX_RTMP_HLS_SLICING_ALIGNED
 },

144 { 
ngx_nuŒ_°rög
, 0 }

148 
ngx_c⁄f_íum_t
 
	gngx_πmp_hls_ty≥_¶Ÿs
[] = {

149 { 
ngx_°rög
("live"), 
NGX_RTMP_HLS_TYPE_LIVE
 },

150 { 
ngx_°rög
("evít"), 
NGX_RTMP_HLS_TYPE_EVENT
 },

151 { 
ngx_nuŒ_°rög
, 0 }

155 
ngx_comm™d_t
 
	gngx_πmp_hls_comm™ds
[] = {

157 { 
ngx_°rög
("hls"),

158 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

159 
ngx_c⁄f_£t_Êag_¶Ÿ
,

160 
NGX_RTMP_APP_CONF_OFFSET
,

161 
off£tof
(
ngx_πmp_hls_≠p_c⁄f_t
, 
hls
),

162 
NULL
 },

164 { 
ngx_°rög
("hls_fragment"),

165 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

166 
ngx_c⁄f_£t_m£c_¶Ÿ
,

167 
NGX_RTMP_APP_CONF_OFFSET
,

168 
off£tof
(
ngx_πmp_hls_≠p_c⁄f_t
, 
‰agÀn
),

169 
NULL
 },

171 { 
ngx_°rög
("hls_max_fragment"),

172 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

173 
ngx_c⁄f_£t_m£c_¶Ÿ
,

174 
NGX_RTMP_APP_CONF_OFFSET
,

175 
off£tof
(
ngx_πmp_hls_≠p_c⁄f_t
, 
max_‰agÀn
),

176 
NULL
 },

178 { 
ngx_°rög
("hls_path"),

179 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

180 
ngx_c⁄f_£t_°r_¶Ÿ
,

181 
NGX_RTMP_APP_CONF_OFFSET
,

182 
off£tof
(
ngx_πmp_hls_≠p_c⁄f_t
, 
∑th
),

183 
NULL
 },

185 { 
ngx_°rög
("hls_playlist_length"),

186 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

187 
ngx_c⁄f_£t_m£c_¶Ÿ
,

188 
NGX_RTMP_APP_CONF_OFFSET
,

189 
off£tof
(
ngx_πmp_hls_≠p_c⁄f_t
, 
∂ayÀn
),

190 
NULL
 },

192 { 
ngx_°rög
("hls_muxdelay"),

193 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

194 
ngx_c⁄f_£t_m£c_¶Ÿ
,

195 
NGX_RTMP_APP_CONF_OFFSET
,

196 
off£tof
(
ngx_πmp_hls_≠p_c⁄f_t
, 
muxdñay
),

197 
NULL
 },

199 { 
ngx_°rög
("hls_sync"),

200 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

201 
ngx_c⁄f_£t_m£c_¶Ÿ
,

202 
NGX_RTMP_APP_CONF_OFFSET
,

203 
off£tof
(
ngx_πmp_hls_≠p_c⁄f_t
, 
sync
),

204 
NULL
 },

206 { 
ngx_°rög
("hls_continuous"),

207 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

208 
ngx_c⁄f_£t_Êag_¶Ÿ
,

209 
NGX_RTMP_APP_CONF_OFFSET
,

210 
off£tof
(
ngx_πmp_hls_≠p_c⁄f_t
, 
c⁄töuous
),

211 
NULL
 },

213 { 
ngx_°rög
("hls_nested"),

214 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

215 
ngx_c⁄f_£t_Êag_¶Ÿ
,

216 
NGX_RTMP_APP_CONF_OFFSET
,

217 
off£tof
(
ngx_πmp_hls_≠p_c⁄f_t
, 
√°ed
),

218 
NULL
 },

220 { 
ngx_°rög
("hls_fragment_naming"),

221 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

222 
ngx_c⁄f_£t_íum_¶Ÿ
,

223 
NGX_RTMP_APP_CONF_OFFSET
,

224 
off£tof
(
ngx_πmp_hls_≠p_c⁄f_t
, 
«mög
),

225 &
ngx_πmp_hls_«mög_¶Ÿs
 },

227 { 
ngx_°rög
("hls_fragment_slicing"),

228 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

229 
ngx_c⁄f_£t_íum_¶Ÿ
,

230 
NGX_RTMP_APP_CONF_OFFSET
,

231 
off£tof
(
ngx_πmp_hls_≠p_c⁄f_t
, 
¶icög
),

232 &
ngx_πmp_hls_¶icög_¶Ÿs
 },

234 { 
ngx_°rög
("hls_type"),

235 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

236 
ngx_c⁄f_£t_íum_¶Ÿ
,

237 
NGX_RTMP_APP_CONF_OFFSET
,

238 
off£tof
(
ngx_πmp_hls_≠p_c⁄f_t
, 
ty≥
),

239 &
ngx_πmp_hls_ty≥_¶Ÿs
 },

241 { 
ngx_°rög
("hls_max_audio_delay"),

242 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

243 
ngx_c⁄f_£t_m£c_¶Ÿ
,

244 
NGX_RTMP_APP_CONF_OFFSET
,

245 
off£tof
(
ngx_πmp_hls_≠p_c⁄f_t
, 
max_audio_dñay
),

246 
NULL
 },

248 { 
ngx_°rög
("hls_audio_buffer_size"),

249 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

250 
ngx_c⁄f_£t_size_¶Ÿ
,

251 
NGX_RTMP_APP_CONF_OFFSET
,

252 
off£tof
(
ngx_πmp_hls_≠p_c⁄f_t
, 
audio_buf„r_size
),

253 
NULL
 },

255 { 
ngx_°rög
("hls_cleanup"),

256 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

257 
ngx_c⁄f_£t_Êag_¶Ÿ
,

258 
NGX_RTMP_APP_CONF_OFFSET
,

259 
off£tof
(
ngx_πmp_hls_≠p_c⁄f_t
, 
˛ónup
),

260 
NULL
 },

262 { 
ngx_°rög
("hls_variant"),

263 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_1MORE
,

264 
ngx_πmp_hls_v¨ü¡
,

265 
NGX_RTMP_APP_CONF_OFFSET
,

267 
NULL
 },

269 { 
ngx_°rög
("hls_base_url"),

270 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

271 
ngx_c⁄f_£t_°r_¶Ÿ
,

272 
NGX_RTMP_APP_CONF_OFFSET
,

273 
off£tof
(
ngx_πmp_hls_≠p_c⁄f_t
, 
ba£_uæ
),

274 
NULL
 },

276 { 
ngx_°rög
("hls_fragment_naming_granularity"),

277 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

278 
ngx_c⁄f_£t_num_¶Ÿ
,

279 
NGX_RTMP_APP_CONF_OFFSET
,

280 
off£tof
(
ngx_πmp_hls_≠p_c⁄f_t
, 
gønuœrôy
),

281 
NULL
 },

283 { 
ngx_°rög
("hls_keys"),

284 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

285 
ngx_c⁄f_£t_Êag_¶Ÿ
,

286 
NGX_RTMP_APP_CONF_OFFSET
,

287 
off£tof
(
ngx_πmp_hls_≠p_c⁄f_t
, 
keys
),

288 
NULL
 },

290 { 
ngx_°rög
("hls_key_path"),

291 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

292 
ngx_c⁄f_£t_°r_¶Ÿ
,

293 
NGX_RTMP_APP_CONF_OFFSET
,

294 
off£tof
(
ngx_πmp_hls_≠p_c⁄f_t
, 
key_∑th
),

295 
NULL
 },

297 { 
ngx_°rög
("hls_key_url"),

298 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

299 
ngx_c⁄f_£t_°r_¶Ÿ
,

300 
NGX_RTMP_APP_CONF_OFFSET
,

301 
off£tof
(
ngx_πmp_hls_≠p_c⁄f_t
, 
key_uæ
),

302 
NULL
 },

304 { 
ngx_°rög
("hls_fragments_per_key"),

305 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

306 
ngx_c⁄f_£t_num_¶Ÿ
,

307 
NGX_RTMP_APP_CONF_OFFSET
,

308 
off£tof
(
ngx_πmp_hls_≠p_c⁄f_t
, 
‰ags_≥r_key
),

309 
NULL
 },

311 
ngx_nuŒ_comm™d


315 
ngx_πmp_moduÀ_t
 
	gngx_πmp_hls_moduÀ_˘x
 = {

316 
NULL
,

317 
ngx_πmp_hls_po°c⁄figuøti⁄
,

319 
NULL
,

320 
NULL
,

322 
NULL
,

323 
NULL
,

325 
ngx_πmp_hls_¸óã_≠p_c⁄f
,

326 
ngx_πmp_hls_mîge_≠p_c⁄f
,

330 
ngx_moduÀ_t
 
	gngx_πmp_hls_moduÀ
 = {

331 
NGX_MODULE_V1
,

332 &
ngx_πmp_hls_moduÀ_˘x
,

333 
ngx_πmp_hls_comm™ds
,

334 
NGX_RTMP_MODULE
,

335 
NULL
,

336 
NULL
,

337 
NULL
,

338 
NULL
,

339 
NULL
,

340 
NULL
,

341 
NULL
,

342 
NGX_MODULE_V1_PADDING


346 
ngx_πmp_hls_‰ag_t
 *

347 
	$ngx_πmp_hls_gë_‰ag
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_öt_t
 
n
)

349 
ngx_πmp_hls_˘x_t
 *
˘x
;

350 
ngx_πmp_hls_≠p_c⁄f_t
 *
hacf
;

352 
hacf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_hls_moduÀ
);

353 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_hls_moduÀ
);

355  &
˘x
->
‰ags
[(˘x->
‰ag
 + 
n
Ë% (
hacf
->
wö‰ags
 * 2 + 1)];

356 
	}
}

360 
	$ngx_πmp_hls_√xt_‰ag
(
ngx_πmp_£ssi⁄_t
 *
s
)

362 
ngx_πmp_hls_˘x_t
 *
˘x
;

363 
ngx_πmp_hls_≠p_c⁄f_t
 *
hacf
;

365 
hacf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_hls_moduÀ
);

366 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_hls_moduÀ
);

368 i‡(
˘x
->
n‰ags
 =
hacf
->
wö‰ags
) {

369 
˘x
->
‰ag
++;

371 
˘x
->
n‰ags
++;

373 
	}
}

376 
ngx_öt_t


377 
	$ngx_πmp_hls_ª«me_fûe
(
u_ch¨
 *
§c
, u_ch¨ *
d°
)

381 #i‡(
NGX_WIN32
)

382  
	`MoveFûeEx
((
LPCTSTR
Ë
§c
, (LPCTSTRË
d°
, 
MOVEFILE_REPLACE_EXISTING
);

384  
	`ngx_ª«me_fûe
(
§c
, 
d°
);

386 
	}
}

389 
ngx_öt_t


390 
	$ngx_πmp_hls_wrôe_v¨ü¡_∂ayli°
(
ngx_πmp_£ssi⁄_t
 *
s
)

392 
u_ch¨
 
buf„r
[1024];

394 
u_ch¨
 *
p
, *
œ°
;

395 
ssize_t
 
rc
;

396 
ngx_fd_t
 
fd
;

397 
ngx_°r_t
 *
¨g
;

398 
ngx_uöt_t
 
n
, 
k
;

399 
ngx_πmp_hls_˘x_t
 *
˘x
;

400 
ngx_πmp_hls_v¨ü¡_t
 *
v¨
;

401 
ngx_πmp_hls_≠p_c⁄f_t
 *
hacf
;

403 
hacf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_hls_moduÀ
);

404 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_hls_moduÀ
);

406 
fd
 = 
	`ngx_›í_fûe
(
˘x
->
v¨_∂ayli°_bak
.
d©a
, 
NGX_FILE_WRONLY
,

407 
NGX_FILE_TRUNCATE
, 
NGX_FILE_DEFAULT_ACCESS
);

409 i‡(
fd
 =
NGX_INVALID_FILE
) {

410 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

411 "hls: " 
ngx_›í_fûe_n
 " failed: '%V'",

412 &
˘x
->
v¨_∂ayli°_bak
);

414  
NGX_ERROR
;

417 
	#NGX_RTMP_HLS_VAR_HEADER
 "#EXTM3U\n#EXT-X-VERSION:3\n"

	)

419 
rc
 = 
	`ngx_wrôe_fd
(
fd
, 
NGX_RTMP_HLS_VAR_HEADER
,

420 (
NGX_RTMP_HLS_VAR_HEADER
) - 1);

421 i‡(
rc
 < 0) {

422 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

423 "hls: " 
ngx_wrôe_fd_n
 " failed: '%V'",

424 &
˘x
->
v¨_∂ayli°_bak
);

425 
	`ngx_˛o£_fûe
(
fd
);

426  
NGX_ERROR
;

429 
v¨
 = 
hacf
->
v¨ü¡
->
ñts
;

430 
n
 = 0;Ç < 
hacf
->
v¨ü¡
->
√…s
;Ç++, 
v¨
++)

432 
p
 = 
buf„r
;

433 
œ°
 = 
buf„r
 + (buffer);

435 
p
 = 
	`ngx_¶¥ötf
’, 
œ°
, "#EXT-X-STREAM-INF:PROGRAM-ID=1");

437 
¨g
 = 
v¨
->
¨gs
.
ñts
;

438 
k
 = 0; k < 
v¨
->
¨gs
.
√…s
; k++, 
¨g
++) {

439 
p
 = 
	`ngx_¶¥ötf
’, 
œ°
, ",%V", 
¨g
);

442 i‡(
p
 < 
œ°
) {

443 *
p
++ = '\n';

446 
p
 = 
	`ngx_¶¥ötf
’, 
œ°
, "%V%*s%V",

447 &
hacf
->
ba£_uæ
,

448 
˘x
->
«me
.
Àn
 - ctx->
v¨
->
suffix
.Àn, ctx->«me.
d©a
,

449 &
v¨
->
suffix
);

450 i‡(
hacf
->
√°ed
) {

451 
p
 = 
	`ngx_¶¥ötf
’, 
œ°
, "%s", "/index");

454 
p
 = 
	`ngx_¶¥ötf
’, 
œ°
, "%s", ".m3u8\n");

456 
rc
 = 
	`ngx_wrôe_fd
(
fd
, 
buf„r
, 
p
 - buffer);

457 i‡(
rc
 < 0) {

458 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

459 "hls: " 
ngx_wrôe_fd_n
 " failed '%V'",

460 &
˘x
->
v¨_∂ayli°_bak
);

461 
	`ngx_˛o£_fûe
(
fd
);

462  
NGX_ERROR
;

466 
	`ngx_˛o£_fûe
(
fd
);

468 i‡(
	`ngx_πmp_hls_ª«me_fûe
(
˘x
->
v¨_∂ayli°_bak
.
d©a
,

469 
˘x
->
v¨_∂ayli°
.
d©a
)

470 =
NGX_FILE_ERROR
)

472 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

474 &
˘x
->
v¨_∂ayli°_bak
, &˘x->
v¨_∂ayli°
);

475  
NGX_ERROR
;

478  
NGX_OK
;

479 
	}
}

482 
ngx_öt_t


483 
	$ngx_πmp_hls_wrôe_∂ayli°
(
ngx_πmp_£ssi⁄_t
 *
s
)

485 
u_ch¨
 
buf„r
[1024];

486 
ngx_fd_t
 
fd
;

487 
u_ch¨
 *
p
, *
íd
;

488 
ngx_πmp_hls_˘x_t
 *
˘x
;

489 
ssize_t
 
n
;

490 
ngx_πmp_hls_≠p_c⁄f_t
 *
hacf
;

491 
ngx_πmp_hls_‰ag_t
 *
f
;

492 
ngx_uöt_t
 
i
, 
max_‰ag
;

493 
ngx_°r_t
 
«me_∑π
, 
key_«me_∑π
;

494 
uöt64_t
 
¥ev_key_id
;

495 c⁄° *
£p
, *
key_£p
;

498 
hacf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_hls_moduÀ
);

499 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_hls_moduÀ
);

501 
fd
 = 
	`ngx_›í_fûe
(
˘x
->
∂ayli°_bak
.
d©a
, 
NGX_FILE_WRONLY
,

502 
NGX_FILE_TRUNCATE
, 
NGX_FILE_DEFAULT_ACCESS
);

504 i‡(
fd
 =
NGX_INVALID_FILE
) {

505 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

506 "hls: " 
ngx_›í_fûe_n
 " failed: '%V'",

507 &
˘x
->
∂ayli°_bak
);

508  
NGX_ERROR
;

511 
max_‰ag
 = 
hacf
->
‰agÀn
 / 1000;

513 
i
 = 0; i < 
˘x
->
n‰ags
; i++) {

514 
f
 = 
	`ngx_πmp_hls_gë_‰ag
(
s
, 
i
);

515 i‡(
f
->
duøti⁄
 > 
max_‰ag
) {

516 
max_‰ag
 = (
ngx_uöt_t
Ë(
f
->
duøti⁄
 + .5);

520 
p
 = 
buf„r
;

521 
íd
 = 
p
 + (
buf„r
);

523 
p
 = 
	`ngx_¶¥ötf
’, 
íd
,

528 
˘x
->
‰ag
, 
max_‰ag
);

530 i‡(
hacf
->
ty≥
 =
NGX_RTMP_HLS_TYPE_EVENT
) {

531 
p
 = 
	`ngx_¶¥ötf
’, 
íd
, "#EXT-X-PLAYLIST-TYPE: EVENT\n");

534 
n
 = 
	`ngx_wrôe_fd
(
fd
, 
buf„r
, 
p
 - buffer);

535 i‡(
n
 < 0) {

536 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

537 "hls: " 
ngx_wrôe_fd_n
 " failed: '%V'",

538 &
˘x
->
∂ayli°_bak
);

539 
	`ngx_˛o£_fûe
(
fd
);

540  
NGX_ERROR
;

543 
£p
 = 
hacf
->
√°ed
 ? (hacf->
ba£_uæ
.
Àn
 ? "/" : "") : "-";

544 
key_£p
 = 
hacf
->
√°ed
 ? (hacf->
key_uæ
.
Àn
 ? "/" : "") : "-";

546 
«me_∑π
.
Àn
 = 0;

547 i‡(!
hacf
->
√°ed
 || hacf->
ba£_uæ
.
Àn
) {

548 
«me_∑π
 = 
˘x
->
«me
;

551 
key_«me_∑π
.
Àn
 = 0;

552 i‡(!
hacf
->
√°ed
 || hacf->
key_uæ
.
Àn
) {

553 
key_«me_∑π
 = 
˘x
->
«me
;

556 
¥ev_key_id
 = 0;

558 
i
 = 0; i < 
˘x
->
n‰ags
; i++) {

559 
f
 = 
	`ngx_πmp_hls_gë_‰ag
(
s
, 
i
);

561 
p
 = 
buf„r
;

562 
íd
 = 
p
 + (
buf„r
);

564 i‡(
f
->
disc⁄t
) {

565 
p
 = 
	`ngx_¶¥ötf
’, 
íd
, "#EXT-X-DISCONTINUITY\n");

568 i‡(
hacf
->
keys
 && (
i
 =0 || 
f
->
key_id
 !
¥ev_key_id
)) {

569 
p
 = 
	`ngx_¶¥ötf
’, 
íd
, "#EXT-X-KEY:METHOD=AES-128,"

571 &
hacf
->
key_uæ
, &
key_«me_∑π
,

572 
key_£p
, 
f
->
key_id
, f->key_id);

575 
¥ev_key_id
 = 
f
->
key_id
;

577 
p
 = 
	`ngx_¶¥ötf
’, 
íd
,

580 
f
->
duøti⁄
, &
hacf
->
ba£_uæ
, &
«me_∑π
, 
£p
, f->
id
);

582 
	`ngx_log_debug5
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

585 
˘x
->
‰ag
, 
i
 + 1, ctx->
n‰ags
, 
f
->
duøti⁄
, f->
disc⁄t
);

587 
n
 = 
	`ngx_wrôe_fd
(
fd
, 
buf„r
, 
p
 - buffer);

588 i‡(
n
 < 0) {

589 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

590 "hls: " 
ngx_wrôe_fd_n
 " failed '%V'",

591 &
˘x
->
∂ayli°_bak
);

592 
	`ngx_˛o£_fûe
(
fd
);

593  
NGX_ERROR
;

597 
	`ngx_˛o£_fûe
(
fd
);

599 i‡(
	`ngx_πmp_hls_ª«me_fûe
(
˘x
->
∂ayli°_bak
.
d©a
, ctx->
∂ayli°
.data)

600 =
NGX_FILE_ERROR
)

602 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

604 &
˘x
->
∂ayli°_bak
, &˘x->
∂ayli°
);

605  
NGX_ERROR
;

608 i‡(
˘x
->
v¨
) {

609  
	`ngx_πmp_hls_wrôe_v¨ü¡_∂ayli°
(
s
);

612  
NGX_OK
;

613 
	}
}

616 
ngx_öt_t


617 
	$ngx_πmp_hls_c›y
(
ngx_πmp_£ssi⁄_t
 *
s
, *
d°
, 
u_ch¨
 **
§c
, 
size_t
 
n
,

618 
ngx_chaö_t
 **
ö
)

620 
u_ch¨
 *
œ°
;

621 
size_t
 
≤
;

623 i‡(*
ö
 =
NULL
) {

624  
NGX_ERROR
;

628 
œ°
 = (*
ö
)->
buf
->last;

630 i‡((
size_t
)(
œ°
 - *
§c
Ë>
n
) {

631 i‡(
d°
) {

632 
	`ngx_mem˝y
(
d°
, *
§c
, 
n
);

635 *
§c
 +
n
;

637 *
ö
 && *
§c
 =(*ö)->
buf
->
œ°
) {

638 *
ö
 = (*ö)->
√xt
;

639 i‡(*
ö
) {

640 *
§c
 = (*
ö
)->
buf
->
pos
;

644  
NGX_OK
;

647 
≤
 = 
œ°
 - *
§c
;

649 i‡(
d°
) {

650 
	`ngx_mem˝y
(
d°
, *
§c
, 
≤
);

651 
d°
 = (
u_ch¨
 *)d° + 
≤
;

654 
n
 -
≤
;

655 *
ö
 = (*ö)->
√xt
;

657 i‡(*
ö
 =
NULL
) {

658 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

659 "hls: faûedÅÿªad %uz byã(s)", 
n
);

660  
NGX_ERROR
;

663 *
§c
 = (*
ö
)->
buf
->
pos
;

665 
	}
}

668 
ngx_öt_t


669 
	$ngx_πmp_hls_≠≥nd_aud
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_buf_t
 *
out
)

671 
u_ch¨
 
aud_«l
[] = { 0x00, 0x00, 0x00, 0x01, 0x09, 0xf0 };

673 i‡(
out
->
œ°
 + (
aud_«l
Ë> out->
íd
) {

674  
NGX_ERROR
;

677 
out
->
œ°
 = 
	`ngx_˝ymem
(out->œ°, 
aud_«l
, (aud_nal));

679  
NGX_OK
;

680 
	}
}

683 
ngx_öt_t


684 
	$ngx_πmp_hls_≠≥nd_•s_µs
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_buf_t
 *
out
)

686 
ngx_πmp_codec_˘x_t
 *
codec_˘x
;

687 
u_ch¨
 *
p
;

688 
ngx_chaö_t
 *
ö
;

689 
ngx_πmp_hls_˘x_t
 *
˘x
;

690 
öt8_t
 
¬Æs
;

691 
uöt16_t
 
Àn
, 
æí
;

692 
ngx_öt_t
 
n
;

694 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_hls_moduÀ
);

696 
codec_˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

698 i‡(
˘x
 =
NULL
 || 
codec_˘x
 == NULL) {

699  
NGX_ERROR
;

702 
ö
 = 
codec_˘x
->
avc_hódî
;

703 i‡(
ö
 =
NULL
) {

704  
NGX_ERROR
;

707 
p
 = 
ö
->
buf
->
pos
;

723 i‡(
	`ngx_πmp_hls_c›y
(
s
, 
NULL
, &
p
, 10, &
ö
Ë!
NGX_OK
) {

724  
NGX_ERROR
;

728 i‡(
	`ngx_πmp_hls_c›y
(
s
, &
¬Æs
, &
p
, 1, &
ö
Ë!
NGX_OK
) {

729  
NGX_ERROR
;

732 
¬Æs
 &= 0x1f;

734 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

735 "hls: SPSÇumbî: %uz", 
¬Æs
);

738 
n
 = 0; ; ++n) {

739 ; 
¬Æs
; --nnals) {

742 i‡(
	`ngx_πmp_hls_c›y
(
s
, &
æí
, &
p
, 2, &
ö
Ë!
NGX_OK
) {

743  
NGX_ERROR
;

746 
	`ngx_πmp_rmem˝y
(&
Àn
, &
æí
, 2);

748 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

749 "hls: hódî NALÜígth: %uz", (
size_t
Ë
Àn
);

752 i‡(
out
->
íd
 - out->
œ°
 < 4) {

753 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

755  
NGX_ERROR
;

758 *
out
->
œ°
++ = 0;

759 *
out
->
œ°
++ = 0;

760 *
out
->
œ°
++ = 0;

761 *
out
->
œ°
++ = 1;

764 i‡(
out
->
íd
 - out->
œ°
 < 
Àn
) {

765 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

767  
NGX_ERROR
;

770 i‡(
	`ngx_πmp_hls_c›y
(
s
, 
out
->
œ°
, &
p
, 
Àn
, &
ö
Ë!
NGX_OK
) {

771  
NGX_ERROR
;

774 
out
->
œ°
 +
Àn
;

777 i‡(
n
 == 1) {

782 i‡(
	`ngx_πmp_hls_c›y
(
s
, &
¬Æs
, &
p
, 1, &
ö
Ë!
NGX_OK
) {

783  
NGX_ERROR
;

786 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

787 "hls: PPSÇumbî: %uz", 
¬Æs
);

790  
NGX_OK
;

791 
	}
}

794 
uöt64_t


795 
	$ngx_πmp_hls_gë_‰agmít_id
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt64_t
 
ts
)

797 
ngx_πmp_hls_˘x_t
 *
˘x
;

798 
ngx_πmp_hls_≠p_c⁄f_t
 *
hacf
;

800 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_hls_moduÀ
);

802 
hacf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_hls_moduÀ
);

804 
hacf
->
«mög
) {

806 
NGX_RTMP_HLS_NAMING_TIMESTAMP
:

807  
ts
;

809 
NGX_RTMP_HLS_NAMING_SYSTEM
:

810  (
uöt64_t
Ë
ngx_ˇched_time
->
£c
 * 1000 +Çgx_ˇched_time->
m£c
;

813  
˘x
->
‰ag
 + ctx->
n‰ags
;

815 
	}
}

818 
ngx_öt_t


819 
	$ngx_πmp_hls_˛o£_‰agmít
(
ngx_πmp_£ssi⁄_t
 *
s
)

821 
ngx_πmp_hls_˘x_t
 *
˘x
;

823 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_hls_moduÀ
);

824 i‡(
˘x
 =
NULL
 || !˘x->
›íed
) {

825  
NGX_OK
;

828 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

829 "hls: clo£ føgmíàn=%uL", 
˘x
->
‰ag
);

831 
	`ngx_πmp_m≥gts_˛o£_fûe
(&
˘x
->
fûe
);

833 
˘x
->
›íed
 = 0;

835 
	`ngx_πmp_hls_√xt_‰ag
(
s
);

837 
	`ngx_πmp_hls_wrôe_∂ayli°
(
s
);

839  
NGX_OK
;

840 
	}
}

843 
ngx_öt_t


844 
	$ngx_πmp_hls_›í_‰agmít
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt64_t
 
ts
,

845 
ngx_öt_t
 
disc⁄t
)

847 
uöt64_t
 
id
;

848 
ngx_fd_t
 
fd
;

849 
ngx_uöt_t
 
g
;

850 
ngx_πmp_hls_˘x_t
 *
˘x
;

851 
ngx_πmp_hls_‰ag_t
 *
f
;

852 
ngx_πmp_hls_≠p_c⁄f_t
 *
hacf
;

854 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_hls_moduÀ
);

856 i‡(
˘x
->
›íed
) {

857  
NGX_OK
;

860 
hacf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_hls_moduÀ
);

862 i‡(
	`ngx_πmp_hls_ísuª_dúe˘‹y
(
s
, &
hacf
->
∑th
Ë!
NGX_OK
) {

863  
NGX_ERROR
;

866 i‡(
hacf
->
keys
 &&

867 
	`ngx_πmp_hls_ísuª_dúe˘‹y
(
s
, &
hacf
->
key_∑th
Ë!
NGX_OK
)

869  
NGX_ERROR
;

872 
id
 = 
	`ngx_πmp_hls_gë_‰agmít_id
(
s
, 
ts
);

874 i‡(
hacf
->
gønuœrôy
) {

875 
g
 = (
ngx_uöt_t
Ë
hacf
->
gønuœrôy
;

876 
id
 = (
uöt64_t
Ë(id / 
g
) * g;

879 
	`ngx_•rötf
(
˘x
->
°ªam
.
d©a
 + ctx->°ªam.
Àn
, "%uL.ts%Z", 
id
);

881 i‡(
hacf
->
keys
) {

882 i‡(
˘x
->
key_‰ags
 == 0) {

884 
˘x
->
key_‰ags
 = 
hacf
->
‰ags_≥r_key
 - 1;

885 
˘x
->
key_id
 = 
id
;

887 i‡(
	`RAND_byãs
(
˘x
->
key
, 16) < 0) {

888 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

890  
NGX_ERROR
;

893 
	`ngx_•rötf
(
˘x
->
keyfûe
.
d©a
 + ctx->keyfûe.
Àn
, "%uL.key%Z", 
id
);

895 
fd
 = 
	`ngx_›í_fûe
(
˘x
->
keyfûe
.
d©a
, 
NGX_FILE_WRONLY
,

896 
NGX_FILE_TRUNCATE
, 
NGX_FILE_DEFAULT_ACCESS
);

898 i‡(
fd
 =
NGX_INVALID_FILE
) {

899 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

901 
˘x
->
keyfûe
.
d©a
);

902  
NGX_ERROR
;

905 i‡(
	`ngx_wrôe_fd
(
fd
, 
˘x
->
key
, 16) != 16) {

906 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

908 
˘x
->
keyfûe
.
d©a
);

909 
	`ngx_˛o£_fûe
(
fd
);

910  
NGX_ERROR
;

913 
	`ngx_˛o£_fûe
(
fd
);

916 i‡(
hacf
->
‰ags_≥r_key
) {

917 
˘x
->
key_‰ags
--;

920 i‡(
	`ngx_£t_fûe_time
(
˘x
->
keyfûe
.
d©a
, 0, 
ngx_ˇched_time
->
£c
)

921 !
NGX_OK
)

923 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

924 
ngx_£t_fûe_time_n
 " '%s' failed",

925 
˘x
->
keyfûe
.
d©a
);

930 
	`ngx_log_debug6
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

933 
˘x
->
°ªam
.
d©a
,

934 
˘x
->
keyfûe
.
d©a
 ? ctx->keyfûe.d©®: (
u_ch¨
 *) "",

935 
˘x
->
‰ag
, ctx->
n‰ags
, 
ts
, 
disc⁄t
);

937 i‡(
hacf
->
keys
 &&

938 
	`ngx_πmp_m≥gts_öô_í¸y±i⁄
(&
˘x
->
fûe
, ctx->
key
, 16, ctx->
key_id
)

939 !
NGX_OK
)

941 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

943  
NGX_ERROR
;

946 i‡(
	`ngx_πmp_m≥gts_›í_fûe
(&
˘x
->
fûe
, ctx->
°ªam
.
d©a
,

947 
s
->
c⁄√˘i⁄
->
log
)

948 !
NGX_OK
)

950  
NGX_ERROR
;

953 
˘x
->
›íed
 = 1;

955 
f
 = 
	`ngx_πmp_hls_gë_‰ag
(
s
, 
˘x
->
n‰ags
);

957 
	`ngx_memzîo
(
f
, (*f));

959 
f
->
a˘ive
 = 1;

960 
f
->
disc⁄t
 = discont;

961 
f
->
id
 = id;

962 
f
->
key_id
 = 
˘x
->key_id;

964 
˘x
->
‰ag_ts
 = 
ts
;

968 
	`ngx_πmp_hls_Êush_audio
(
s
);

970  
NGX_OK
;

971 
	}
}

975 
	$ngx_πmp_hls_ª°‹e_°ªam
(
ngx_πmp_£ssi⁄_t
 *
s
)

977 
ngx_πmp_hls_˘x_t
 *
˘x
;

978 
ngx_fûe_t
 
fûe
;

979 
ssize_t
 
ªt
;

980 
off_t
 
off£t
;

981 
u_ch¨
 *
p
, *
œ°
, *
íd
, *
√xt
, *
∑
, *
µ
, 
c
;

982 
ngx_πmp_hls_‰ag_t
 *
f
;

983 
duøti⁄
;

984 
ngx_öt_t
 
disc⁄t
;

985 
uöt64_t
 
mag
, 
key_id
, 
ba£
;

986 
u_ch¨
 
buf„r
[4096];

988 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_hls_moduÀ
);

990 
	`ngx_memzîo
(&
fûe
, (file));

992 
fûe
.
log
 = 
s
->
c⁄√˘i⁄
->log;

994 
	`ngx_°r_£t
(&
fûe
.
«me
, "m3u8");

996 
fûe
.
fd
 = 
	`ngx_›í_fûe
(
˘x
->
∂ayli°
.
d©a
, 
NGX_FILE_RDONLY
, 
NGX_FILE_OPEN
,

998 i‡(
fûe
.
fd
 =
NGX_INVALID_FILE
) {

1002 
off£t
 = 0;

1003 
˘x
->
n‰ags
 = 0;

1004 
f
 = 
NULL
;

1005 
duøti⁄
 = 0;

1006 
disc⁄t
 = 0;

1007 
key_id
 = 0;

1011 
ªt
 = 
	`ngx_ªad_fûe
(&
fûe
, 
buf„r
, (buf„r), 
off£t
);

1012 i‡(
ªt
 <= 0) {

1013 
d⁄e
;

1016 
p
 = 
buf„r
;

1017 
íd
 = 
buf„r
 + 
ªt
;

1020 
œ°
 = 
	`ngx_°æchr
(
p
, 
íd
, '\n');

1022 i‡(
œ°
 =
NULL
) {

1023 i‡(
p
 =
buf„r
) {

1024 
d⁄e
;

1029 
√xt
 = 
œ°
 + 1;

1030 
off£t
 +(
√xt
 - 
p
);

1032 i‡(
p
 !
œ°
 &&Üast[-1] == '\r') {

1033 
œ°
--;

1037 
	#NGX_RTMP_MSEQ
 "#EXT-X-MEDIA-SEQUENCE:"

	)

1038 
	#NGX_RTMP_MSEQ_LEN
 ((
NGX_RTMP_MSEQ
Ë- 1)

	)

1041 i‡(
	`ngx_memcmp
(
p
, 
NGX_RTMP_MSEQ
, 
NGX_RTMP_MSEQ_LEN
) == 0) {

1043 
˘x
->
‰ag
 = (
uöt64_t
Ë
	`°πod
((const *)

1044 &
p
[
NGX_RTMP_MSEQ_LEN
], 
NULL
);

1046 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1047 "hls:Ñe°‹ê£quí˚ føg=%uL", 
˘x
->
‰ag
);

1051 
	#NGX_RTMP_XKEY
 "#EXT-X-KEY:"

	)

1052 
	#NGX_RTMP_XKEY_LEN
 ((
NGX_RTMP_XKEY
Ë- 1)

	)

1054 i‡(
	`ngx_memcmp
(
p
, 
NGX_RTMP_XKEY
, 
NGX_RTMP_XKEY_LEN
) == 0) {

1058 
key_id
 = 0;

1059 
ba£
 = 1;

1060 
µ
 = 
œ°
 - 1;

1063 i‡(
µ
 < 
p
) {

1064 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1069 
c
 = *
µ
;

1070 i‡(
c
 == 'x') {

1074 i‡(
c
 >= '0' && c <= '9') {

1075 
c
 -= '0';

1076 
√xt
;

1079 
c
 |= 0x20;

1081 i‡(
c
 >= 'a' && c <= 'f') {

1082 
c
 -= 'a' - 10;

1083 
√xt
;

1086 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1090 
√xt
:

1092 
key_id
 +
ba£
 * 
c
;

1093 
ba£
 *= 0x10;

1094 
µ
--;

1099 
	#NGX_RTMP_EXTINF
 "#EXTINF:"

	)

1100 
	#NGX_RTMP_EXTINF_LEN
 ((
NGX_RTMP_EXTINF
Ë- 1)

	)

1103 i‡(
	`ngx_memcmp
(
p
, 
NGX_RTMP_EXTINF
, 
NGX_RTMP_EXTINF_LEN
) == 0) {

1105 
duøti⁄
 = 
	`°πod
((c⁄° *Ë&
p
[
NGX_RTMP_EXTINF_LEN
], 
NULL
);

1107 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1108 "hls:Ñe°‹êduøri⁄=%.3f", 
duøti⁄
);

1112 
	#NGX_RTMP_DISCONT
 "#EXT-X-DISCONTINUITY"

	)

1113 
	#NGX_RTMP_DISCONT_LEN
 ((
NGX_RTMP_DISCONT
Ë- 1)

	)

1116 i‡(
	`ngx_memcmp
(
p
, 
NGX_RTMP_DISCONT
, 
NGX_RTMP_DISCONT_LEN
) == 0) {

1118 
disc⁄t
 = 1;

1120 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1126 i‡(
p
 + 4 <
œ°
 &&

1127 
œ°
[-3] == '.' &&Üast[-2] == 't' &&Üast[-1] == 's')

1129 
f
 = 
	`ngx_πmp_hls_gë_‰ag
(
s
, 
˘x
->
n‰ags
);

1131 
	`ngx_memzîo
(
f
, (*f));

1133 
f
->
duøti⁄
 = duration;

1134 
f
->
disc⁄t
 = discont;

1135 
f
->
a˘ive
 = 1;

1136 
f
->
id
 = 0;

1138 
disc⁄t
 = 0;

1140 
mag
 = 1;

1141 
∑
 = 
œ°
 - 4;Ö®>
p
;Öa--) {

1142 i‡(*
∑
 < '0' || *pa > '9') {

1145 
f
->
id
 +(*
∑
 - '0'Ë* 
mag
;

1146 
mag
 *= 10;

1149 
f
->
key_id
 = key_id;

1151 
	`ngx_πmp_hls_√xt_‰ag
(
s
);

1153 
	`ngx_log_debug6
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1156 (
size_t
Ë(
œ°
 - 
p
),Ö, 
f
->
id
, f->
duøti⁄
,

1157 
˘x
->
‰ag
, ctx->
n‰ags
);

1160 
p
 = 
√xt
;

1164 
d⁄e
:

1165 
	`ngx_˛o£_fûe
(
fûe
.
fd
);

1166 
	}
}

1169 
ngx_öt_t


1170 
	$ngx_πmp_hls_ísuª_dúe˘‹y
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_°r_t
 *
∑th
)

1172 
size_t
 
Àn
;

1173 
ngx_fûe_öfo_t
 
fi
;

1174 
ngx_πmp_hls_˘x_t
 *
˘x
;

1175 
ngx_πmp_hls_≠p_c⁄f_t
 *
hacf
;

1177 
u_ch¨
 
z∑th
[
NGX_MAX_PATH
 + 1];

1179 
hacf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_hls_moduÀ
);

1181 i‡(
∑th
->
Àn
 + 1 > (
z∑th
)) {

1182 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0, "hls:ÅooÜongÖath");

1183  
NGX_ERROR
;

1186 
	`ngx_¢¥ötf
(
z∑th
, (z∑th), "%V%Z", 
∑th
);

1188 i‡(
	`ngx_fûe_öfo
(
z∑th
, &
fi
Ë=
NGX_FILE_ERROR
) {

1190 i‡(
ngx_î∫o
 !
NGX_ENOENT
) {

1191 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

1192 "hls: " 
ngx_fûe_öfo_n
 " faûed o¿'%V'", 
∑th
);

1193  
NGX_ERROR
;

1198 i‡(
	`ngx_¸óã_dú
(
z∑th
, 
NGX_RTMP_HLS_DIR_ACCESS
Ë=
NGX_FILE_ERROR
) {

1199 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

1200 "hls: " 
ngx_¸óã_dú_n
 " faûed o¿'%V'", 
∑th
);

1201  
NGX_ERROR
;

1204 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1205 "hls: dúe˘‹y '%V' cª©ed", 
∑th
);

1209 i‡(!
	`ngx_is_dú
(&
fi
)) {

1210 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1211 "hls: '%V'Éxi°†™d i†nŸá dúe˘‹y", 
∑th
);

1212  
NGX_ERROR
;

1215 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1216 "hls: dúe˘‹y '%V'Éxi°s", 
∑th
);

1219 i‡(!
hacf
->
√°ed
) {

1220  
NGX_OK
;

1223 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_hls_moduÀ
);

1225 
Àn
 = 
∑th
->len;

1226 i‡(
∑th
->
d©a
[
Àn
 - 1] == '/') {

1227 
Àn
--;

1230 i‡(
Àn
 + 1 + 
˘x
->
«me
.À¿+ 1 > (
z∑th
)) {

1231 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0, "hls:ÅooÜongÖath");

1232  
NGX_ERROR
;

1235 
	`ngx_¢¥ötf
(
z∑th
, (z∑thË- 1, "%*s/%V%Z", 
Àn
, 
∑th
->
d©a
,

1236 &
˘x
->
«me
);

1238 i‡(
	`ngx_fûe_öfo
(
z∑th
, &
fi
Ë!
NGX_FILE_ERROR
) {

1240 i‡(
	`ngx_is_dú
(&
fi
)) {

1241 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1242 "hls: dúe˘‹y '%s'Éxi°s", 
z∑th
);

1243  
NGX_OK
;

1246 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1247 "hls: '%s'Éxi°†™d i†nŸá dúe˘‹y", 
z∑th
);

1249  
NGX_ERROR
;

1252 i‡(
ngx_î∫o
 !
NGX_ENOENT
) {

1253 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

1254 "hls: " 
ngx_fûe_öfo_n
 " faûed o¿'%s'", 
z∑th
);

1255  
NGX_ERROR
;

1260 i‡(
	`ngx_¸óã_dú
(
z∑th
, 
NGX_RTMP_HLS_DIR_ACCESS
Ë=
NGX_FILE_ERROR
) {

1261 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

1262 "hls: " 
ngx_¸óã_dú_n
 " faûed o¿'%s'", 
z∑th
);

1263  
NGX_ERROR
;

1266 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1267 "hls: dúe˘‹y '%s' cª©ed", 
z∑th
);

1269  
NGX_OK
;

1270 
	}
}

1273 
ngx_öt_t


1274 
	$ngx_πmp_hls_publish
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_publish_t
 *
v
)

1276 
ngx_πmp_hls_≠p_c⁄f_t
 *
hacf
;

1277 
ngx_πmp_hls_˘x_t
 *
˘x
;

1278 
u_ch¨
 *
p
, *
µ
;

1279 
ngx_πmp_hls_‰ag_t
 *
f
;

1280 
ngx_buf_t
 *
b
;

1281 
size_t
 
Àn
;

1282 
ngx_πmp_hls_v¨ü¡_t
 *
v¨
;

1283 
ngx_uöt_t
 
n
;

1285 
hacf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_hls_moduÀ
);

1286 i‡(
hacf
 =
NULL
 || !hacf->
hls
 || hacf->
∑th
.
Àn
 == 0) {

1287 
√xt
;

1290 i‡(
s
->
auto_pushed
) {

1291 
√xt
;

1294 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1296 
v
->
«me
, v->
ty≥
);

1298 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_hls_moduÀ
);

1300 i‡(
˘x
 =
NULL
) {

1302 
˘x
 = 
	`ngx_pˇŒoc
(
s
->
c⁄√˘i⁄
->
poﬁ
, (
ngx_πmp_hls_˘x_t
));

1303 
	`ngx_πmp_£t_˘x
(
s
, 
˘x
, 
ngx_πmp_hls_moduÀ
);

1307 
f
 = 
˘x
->
‰ags
;

1308 
b
 = 
˘x
->
a‰ame
;

1310 
	`ngx_memzîo
(
˘x
, (
ngx_πmp_hls_˘x_t
));

1312 
˘x
->
‰ags
 = 
f
;

1313 
˘x
->
a‰ame
 = 
b
;

1315 i‡(
b
) {

1316 
b
->
pos
 = b->
œ°
 = b->
°¨t
;

1320 i‡(
˘x
->
‰ags
 =
NULL
) {

1321 
˘x
->
‰ags
 = 
	`ngx_pˇŒoc
(
s
->
c⁄√˘i⁄
->
poﬁ
,

1322 (
ngx_πmp_hls_‰ag_t
) *

1323 (
hacf
->
wö‰ags
 * 2 + 1));

1324 i‡(
˘x
->
‰ags
 =
NULL
) {

1325  
NGX_ERROR
;

1329 i‡(
	`ngx_°r°r
(
v
->
«me
, "..")) {

1330 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1331 "hls: bad såómÇame: '%s'", 
v
->
«me
);

1332  
NGX_ERROR
;

1335 
˘x
->
«me
.
Àn
 = 
	`ngx_°æí
(
v
->name);

1336 
˘x
->
«me
.
d©a
 = 
	`ngx_∑Œoc
(
s
->
c⁄√˘i⁄
->
poﬁ
, ctx->«me.
Àn
 + 1);

1338 i‡(
˘x
->
«me
.
d©a
 =
NULL
) {

1339  
NGX_ERROR
;

1342 *
	`ngx_˝ymem
(
˘x
->
«me
.
d©a
, 
v
->«me, ctx->«me.
Àn
) = 0;

1344 
Àn
 = 
hacf
->
∑th
.À¿+ 1 + 
˘x
->
«me
.len + (".m3u8");

1345 i‡(
hacf
->
√°ed
) {

1346 
Àn
 += ("/index") - 1;

1349 
˘x
->
∂ayli°
.
d©a
 = 
	`ngx_∑Œoc
(
s
->
c⁄√˘i⁄
->
poﬁ
, 
Àn
);

1350 
p
 = 
	`ngx_˝ymem
(
˘x
->
∂ayli°
.
d©a
, 
hacf
->
∑th
.d©a, hacf->∑th.
Àn
);

1352 i‡(
p
[-1] != '/') {

1353 *
p
++ = '/';

1356 
p
 = 
	`ngx_˝ymem
’, 
˘x
->
«me
.
d©a
, ctx->«me.
Àn
);

1364 
˘x
->
°ªam
.
Àn
 = 
p
 - ctx->
∂ayli°
.
d©a
 + 1;

1365 
˘x
->
°ªam
.
d©a
 = 
	`ngx_∑Œoc
(
s
->
c⁄√˘i⁄
->
poﬁ
,

1366 
˘x
->
°ªam
.
Àn
 + 
NGX_INT64_LEN
 +

1369 
	`ngx_mem˝y
(
˘x
->
°ªam
.
d©a
, ctx->
∂ayli°
.d©a, ctx->°ªam.
Àn
 - 1);

1370 
˘x
->
°ªam
.
d©a
[˘x->°ªam.
Àn
 - 1] = (
hacf
->
√°ed
 ? '/' : '-');

1374 i‡(
hacf
->
v¨ü¡
) {

1375 
v¨
 = 
hacf
->
v¨ü¡
->
ñts
;

1376 
n
 = 0;Ç < 
hacf
->
v¨ü¡
->
√…s
;Ç++, 
v¨
++) {

1377 i‡(
˘x
->
«me
.
Àn
 > 
v¨
->
suffix
.len &&

1378 
	`ngx_memcmp
(
v¨
->
suffix
.
d©a
,

1379 
˘x
->
«me
.
d©a
 + ctx->«me.
Àn
 - 
v¨
->
suffix
.len,

1380 
v¨
->
suffix
.
Àn
)

1383 
˘x
->
v¨
 = var;

1385 
Àn
 = (
size_t
Ë(
p
 - 
˘x
->
∂ayli°
.
d©a
);

1387 
˘x
->
v¨_∂ayli°
.
Àn
 =Üí - 
v¨
->
suffix
.len + (".m3u8")

1389 
˘x
->
v¨_∂ayli°
.
d©a
 = 
	`ngx_∑Œoc
(
s
->
c⁄√˘i⁄
->
poﬁ
,

1390 
˘x
->
v¨_∂ayli°
.
Àn
 + 1);

1392 
µ
 = 
	`ngx_˝ymem
(
˘x
->
v¨_∂ayli°
.
d©a
, ctx->
∂ayli°
.data,

1393 
Àn
 - 
v¨
->
suffix
.len);

1394 
µ
 = 
	`ngx_˝ymem
(pp, ".m3u8", (".m3u8") - 1);

1395 *
µ
 = 0;

1397 
˘x
->
v¨_∂ayli°_bak
.
Àn
 = ctx->
v¨_∂ayli°
.len +

1399 
˘x
->
v¨_∂ayli°_bak
.
d©a
 = 
	`ngx_∑Œoc
(
s
->
c⁄√˘i⁄
->
poﬁ
,

1400 
˘x
->
v¨_∂ayli°_bak
.
Àn
 + 1);

1402 
µ
 = 
	`ngx_˝ymem
(
˘x
->
v¨_∂ayli°_bak
.
d©a
,

1403 
˘x
->
v¨_∂ayli°
.
d©a
,

1404 
˘x
->
v¨_∂ayli°
.
Àn
);

1405 
µ
 = 
	`ngx_˝ymem
(pp, ".bak", (".bak") - 1);

1406 *
µ
 = 0;

1416 i‡(
hacf
->
√°ed
) {

1417 
p
 = 
	`ngx_˝ymem
(p, "/index.m3u8", ("/index.m3u8") - 1);

1419 
p
 = 
	`ngx_˝ymem
(p, ".m3u8", (".m3u8") - 1);

1422 
˘x
->
∂ayli°
.
Àn
 = 
p
 - ctx->∂ayli°.
d©a
;

1424 *
p
 = 0;

1428 
˘x
->
∂ayli°_bak
.
d©a
 = 
	`ngx_∑Œoc
(
s
->
c⁄√˘i⁄
->
poﬁ
,

1429 
˘x
->
∂ayli°
.
Àn
 + (".bak"));

1430 
p
 = 
	`ngx_˝ymem
(
˘x
->
∂ayli°_bak
.
d©a
, ctx->
∂ayli°
.data,

1431 
˘x
->
∂ayli°
.
Àn
);

1432 
p
 = 
	`ngx_˝ymem
(p, ".bak", (".bak") - 1);

1434 
˘x
->
∂ayli°_bak
.
Àn
 = 
p
 - ctx->∂ayli°_bak.
d©a
;

1436 *
p
 = 0;

1440 i‡(
hacf
->
keys
) {

1441 
Àn
 = 
hacf
->
key_∑th
.À¿+ 1 + 
˘x
->
«me
.À¿+ 1 + 
NGX_INT64_LEN


1444 
˘x
->
keyfûe
.
d©a
 = 
	`ngx_∑Œoc
(
s
->
c⁄√˘i⁄
->
poﬁ
, 
Àn
);

1445 i‡(
˘x
->
keyfûe
.
d©a
 =
NULL
) {

1446  
NGX_ERROR
;

1449 
p
 = 
	`ngx_˝ymem
(
˘x
->
keyfûe
.
d©a
, 
hacf
->
key_∑th
.data,

1450 
hacf
->
key_∑th
.
Àn
);

1452 i‡(
p
[-1] != '/') {

1453 *
p
++ = '/';

1456 
p
 = 
	`ngx_˝ymem
’, 
˘x
->
«me
.
d©a
, ctx->«me.
Àn
);

1457 *
p
++ = (
hacf
->
√°ed
 ? '/' : '-');

1459 
˘x
->
keyfûe
.
Àn
 = 
p
 - ctx->keyfûe.
d©a
;

1462 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1465 &
˘x
->
∂ayli°
, &˘x->
∂ayli°_bak
,

1466 &
˘x
->
°ªam
, &˘x->
keyfûe
);

1468 i‡(
hacf
->
c⁄töuous
) {

1469 
	`ngx_πmp_hls_ª°‹e_°ªam
(
s
);

1472 
√xt
:

1473  
	`√xt_publish
(
s
, 
v
);

1474 
	}
}

1477 
ngx_öt_t


1478 
	$ngx_πmp_hls_˛o£_°ªam
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_˛o£_°ªam_t
 *
v
)

1480 
ngx_πmp_hls_≠p_c⁄f_t
 *
hacf
;

1481 
ngx_πmp_hls_˘x_t
 *
˘x
;

1483 
hacf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_hls_moduÀ
);

1485 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_hls_moduÀ
);

1487 i‡(
hacf
 =
NULL
 || !hacf->
hls
 || 
˘x
 == NULL) {

1488 
√xt
;

1491 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1494 
	`ngx_πmp_hls_˛o£_‰agmít
(
s
);

1496 
√xt
:

1497  
	`√xt_˛o£_°ªam
(
s
, 
v
);

1498 
	}
}

1501 
ngx_öt_t


1502 
	$ngx_πmp_hls_∑r£_Øc_hódî
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_uöt_t
 *
objty≥
,

1503 
ngx_uöt_t
 *
§ödex
,Çgx_uöt_à*
chc⁄f
)

1505 
ngx_πmp_codec_˘x_t
 *
codec_˘x
;

1506 
ngx_chaö_t
 *
˛
;

1507 
u_ch¨
 *
p
, 
b0
, 
b1
;

1509 
codec_˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

1511 
˛
 = 
codec_˘x
->
Øc_hódî
;

1513 
p
 = 
˛
->
buf
->
pos
;

1515 i‡(
	`ngx_πmp_hls_c›y
(
s
, 
NULL
, &
p
, 2, &
˛
Ë!
NGX_OK
) {

1516  
NGX_ERROR
;

1519 i‡(
	`ngx_πmp_hls_c›y
(
s
, &
b0
, &
p
, 1, &
˛
Ë!
NGX_OK
) {

1520  
NGX_ERROR
;

1523 i‡(
	`ngx_πmp_hls_c›y
(
s
, &
b1
, &
p
, 1, &
˛
Ë!
NGX_OK
) {

1524  
NGX_ERROR
;

1527 *
objty≥
 = 
b0
 >> 3;

1528 i‡(*
objty≥
 == 0 || *objtype == 0x1f) {

1529 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1530 "hls: unsuµ‹ãdádt†obje˘Åy≥:%ui", *
objty≥
);

1531  
NGX_ERROR
;

1534 i‡(*
objty≥
 > 4) {

1541 *
objty≥
 = 2;

1544 *
§ödex
 = ((
b0
 << 1Ë& 0x0fË| ((
b1
 & 0x80) >> 7);

1545 i‡(*
§ödex
 == 0x0f) {

1546 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1547 "hls: unsuµ‹ãdádt†ßm∂êøã:%ui", *
§ödex
);

1548  
NGX_ERROR
;

1551 *
chc⁄f
 = (
b1
 >> 3) & 0x0f;

1553 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1555 "ch™√l_c⁄fig:%ui", *
objty≥
, *
§ödex
, *
chc⁄f
);

1557  
NGX_OK
;

1558 
	}
}

1562 
	$ngx_πmp_hls_upd©e_‰agmít
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt64_t
 
ts
,

1563 
ngx_öt_t
 
bound¨y
, 
ngx_uöt_t
 
Êush_øã
)

1565 
ngx_πmp_hls_˘x_t
 *
˘x
;

1566 
ngx_πmp_hls_≠p_c⁄f_t
 *
hacf
;

1567 
ngx_πmp_hls_‰ag_t
 *
f
;

1568 
ngx_m£c_t
 
ts_‰ag_Àn
;

1569 
ngx_öt_t
 
ßme_‰ag
, 
f‹˚
,
disc⁄t
;

1570 
ngx_buf_t
 *
b
;

1571 
öt64_t
 
d
;

1573 
hacf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_hls_moduÀ
);

1574 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_hls_moduÀ
);

1575 
f
 = 
NULL
;

1576 
f‹˚
 = 0;

1577 
disc⁄t
 = 1;

1579 i‡(
˘x
->
›íed
) {

1580 
f
 = 
	`ngx_πmp_hls_gë_‰ag
(
s
, 
˘x
->
n‰ags
);

1581 
d
 = (
öt64_t
Ë(
ts
 - 
˘x
->
‰ag_ts
);

1583 i‡(
d
 > (
öt64_t
Ë
hacf
->
max_‰agÀn
 * 90 || d < -90000) {

1584 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1585 "hls: f‹˚ føgmíà•lô: %.3‡£c, ", 
d
 / 90000.);

1586 
f‹˚
 = 1;

1589 
f
->
duøti⁄
 = (
ts
 - 
˘x
->
‰ag_ts
) / 90000.;

1590 
disc⁄t
 = 0;

1594 
hacf
->
¶icög
) {

1595 
NGX_RTMP_HLS_SLICING_PLAIN
:

1596 i‡(
f
 && f->
duøti⁄
 < 
hacf
->
‰agÀn
 / 1000.) {

1597 
bound¨y
 = 0;

1601 
NGX_RTMP_HLS_SLICING_ALIGNED
:

1603 
ts_‰ag_Àn
 = 
hacf
->
‰agÀn
 * 90;

1604 
ßme_‰ag
 = 
˘x
->
‰ag_ts
 / 
ts_‰ag_Àn
 =
ts
 /Ås_frag_len;

1606 i‡(
f
 && 
ßme_‰ag
) {

1607 
bound¨y
 = 0;

1610 i‡(
f
 =
NULL
 && (
˘x
->
‰ag_ts
 =0 || 
ßme_‰ag
)) {

1611 
˘x
->
‰ag_ts
 = 
ts
;

1612 
bound¨y
 = 0;

1618 i‡(
bound¨y
 || 
f‹˚
) {

1619 
	`ngx_πmp_hls_˛o£_‰agmít
(
s
);

1620 
	`ngx_πmp_hls_›í_‰agmít
(
s
, 
ts
, 
disc⁄t
);

1623 
b
 = 
˘x
->
a‰ame
;

1624 i‡(
˘x
->
›íed
 && 
b
 && b->
œ°
 > b->
pos
 &&

1625 
˘x
->
a‰ame_±s
 + (
uöt64_t
Ë
hacf
->
max_audio_dñay
 * 90 / 
Êush_øã


1626 < 
ts
)

1628 
	`ngx_πmp_hls_Êush_audio
(
s
);

1630 
	}
}

1633 
ngx_öt_t


1634 
	$ngx_πmp_hls_Êush_audio
(
ngx_πmp_£ssi⁄_t
 *
s
)

1636 
ngx_πmp_hls_˘x_t
 *
˘x
;

1637 
ngx_πmp_m≥gts_‰ame_t
 
‰ame
;

1638 
ngx_öt_t
 
rc
;

1639 
ngx_buf_t
 *
b
;

1641 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_hls_moduÀ
);

1643 i‡(
˘x
 =
NULL
 || !˘x->
›íed
) {

1644  
NGX_OK
;

1647 
b
 = 
˘x
->
a‰ame
;

1649 i‡(
b
 =
NULL
 || b->
pos
 =b->
œ°
) {

1650  
NGX_OK
;

1653 
	`ngx_memzîo
(&
‰ame
, (frame));

1655 
‰ame
.
dts
 = 
˘x
->
a‰ame_±s
;

1656 
‰ame
.
±s
 = føme.
dts
;

1657 
‰ame
.
cc
 = 
˘x
->
audio_cc
;

1658 
‰ame
.
pid
 = 0x101;

1659 
‰ame
.
sid
 = 0xc0;

1661 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1662 "hls: flusháudiÿ±s=%uL", 
‰ame
.
±s
);

1664 
rc
 = 
	`ngx_πmp_m≥gts_wrôe_‰ame
(&
˘x
->
fûe
, &
‰ame
, 
b
);

1666 i‡(
rc
 !
NGX_OK
) {

1667 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1671 
˘x
->
audio_cc
 = 
‰ame
.
cc
;

1672 
b
->
pos
 = b->
œ°
 = b->
°¨t
;

1674  
rc
;

1675 
	}
}

1678 
ngx_öt_t


1679 
	$ngx_πmp_hls_audio
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

1680 
ngx_chaö_t
 *
ö
)

1682 
ngx_πmp_hls_≠p_c⁄f_t
 *
hacf
;

1683 
ngx_πmp_hls_˘x_t
 *
˘x
;

1684 
ngx_πmp_codec_˘x_t
 *
codec_˘x
;

1685 
uöt64_t
 
±s
, 
e°_±s
;

1686 
öt64_t
 
d±s
;

1687 
size_t
 
bsize
;

1688 
ngx_buf_t
 *
b
;

1689 
u_ch¨
 *
p
;

1690 
ngx_uöt_t
 
objty≥
, 
§ödex
, 
chc⁄f
, 
size
;

1692 
hacf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_hls_moduÀ
);

1694 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_hls_moduÀ
);

1696 
codec_˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

1698 i‡(
hacf
 =
NULL
 || !hacf->
hls
 || 
˘x
 == NULL ||

1699 
codec_˘x
 =
NULL
 || 
h
->
mÀn
 < 2)

1701  
NGX_OK
;

1704 i‡(
codec_˘x
->
audio_codec_id
 !
NGX_RTMP_AUDIO_AAC
 ||

1705 
codec_˘x
->
Øc_hódî
 =
NULL
 || 
	`ngx_πmp_is_codec_hódî
(
ö
))

1707  
NGX_OK
;

1710 
b
 = 
˘x
->
a‰ame
;

1712 i‡(
b
 =
NULL
) {

1714 
b
 = 
	`ngx_pˇŒoc
(
s
->
c⁄√˘i⁄
->
poﬁ
, (
ngx_buf_t
));

1715 i‡(
b
 =
NULL
) {

1716  
NGX_ERROR
;

1719 
˘x
->
a‰ame
 = 
b
;

1721 
b
->
°¨t
 = 
	`ngx_∑Œoc
(
s
->
c⁄√˘i⁄
->
poﬁ
, 
hacf
->
audio_buf„r_size
);

1722 i‡(
b
->
°¨t
 =
NULL
) {

1723  
NGX_ERROR
;

1726 
b
->
íd
 = b->
°¨t
 + 
hacf
->
audio_buf„r_size
;

1727 
b
->
pos
 = b->
œ°
 = b->
°¨t
;

1730 
size
 = 
h
->
mÀn
 - 2 + 7;

1731 
±s
 = (
uöt64_t
Ë
h
->
time°amp
 * 90;

1733 i‡(
b
->
°¨t
 + 
size
 > b->
íd
) {

1734 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1736  
NGX_OK
;

1745 
	`ngx_πmp_hls_upd©e_‰agmít
(
s
, 
±s
, 
codec_˘x
->
avc_hódî
 =
NULL
, 2);

1747 i‡(
b
->
œ°
 + 
size
 > b->
íd
) {

1748 
	`ngx_πmp_hls_Êush_audio
(
s
);

1751 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1752 "hls:áudiÿ±s=%uL", 
±s
);

1754 i‡(
b
->
œ°
 + 7 > b->
íd
) {

1755 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1757  
NGX_OK
;

1760 
p
 = 
b
->
œ°
;

1761 
b
->
œ°
 += 5;

1765 ; 
ö
 && 
b
->
œ°
 < b->
íd
; i¿ö->
√xt
) {

1767 
bsize
 = 
ö
->
buf
->
œ°
 - in->buf->
pos
;

1768 i‡(
b
->
œ°
 + 
bsize
 > b->
íd
) {

1769 
bsize
 = 
b
->
íd
 - b->
œ°
;

1772 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, 
ö
->
buf
->
pos
, 
bsize
);

1777 i‡(
	`ngx_πmp_hls_∑r£_Øc_hódî
(
s
, &
objty≥
, &
§ödex
, &
chc⁄f
)

1778 !
NGX_OK
)

1780 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1782  
NGX_OK
;

1787 
p
[0] = 0xff;

1788 
p
[1] = 0xf1;

1789 
p
[2] = (
u_ch¨
Ë(((
objty≥
 - 1Ë<< 6Ë| (
§ödex
 << 2) |

1790 ((
chc⁄f
 & 0x04) >> 2));

1791 
p
[3] = (
u_ch¨
Ë(((
chc⁄f
 & 0x03Ë<< 6Ë| ((
size
 >> 11) & 0x03));

1792 
p
[4] = (
u_ch¨
Ë(
size
 >> 3);

1793 
p
[5] = (
u_ch¨
Ë((
size
 << 5) | 0x1f);

1794 
p
[6] = 0xfc;

1796 i‡(
p
 !
b
->
°¨t
) {

1797 
˘x
->
a‰ame_num
++;

1798  
NGX_OK
;

1801 
˘x
->
a‰ame_±s
 = 
±s
;

1803 i‡(!
hacf
->
sync
 || 
codec_˘x
->
ßm∂e_øã
 == 0) {

1804  
NGX_OK
;

1812 
e°_±s
 = 
˘x
->
a‰ame_ba£
 + ctx->
a‰ame_num
 * 90000 * 1024 /

1813 
codec_˘x
->
ßm∂e_øã
;

1814 
d±s
 = (
öt64_t
Ë(
e°_±s
 - 
±s
);

1816 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1818 
d±s
, dpts / 90000.);

1820 i‡(
d±s
 <(
öt64_t
Ë
hacf
->
sync
 * 90 &&

1821 
d±s
 >(
öt64_t
Ë
hacf
->
sync
 * -90)

1823 
˘x
->
a‰ame_num
++;

1824 
˘x
->
a‰ame_±s
 = 
e°_±s
;

1825  
NGX_OK
;

1828 
˘x
->
a‰ame_ba£
 = 
±s
;

1829 
˘x
->
a‰ame_num
 = 1;

1831 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1833 
d±s
, dpts / 90000.);

1835  
NGX_OK
;

1836 
	}
}

1839 
ngx_öt_t


1840 
	$ngx_πmp_hls_video
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

1841 
ngx_chaö_t
 *
ö
)

1843 
ngx_πmp_hls_≠p_c⁄f_t
 *
hacf
;

1844 
ngx_πmp_hls_˘x_t
 *
˘x
;

1845 
ngx_πmp_codec_˘x_t
 *
codec_˘x
;

1846 
u_ch¨
 *
p
;

1847 
uöt8_t
 
fmt
, 
·y≥
, 
hty≥
, 
«l_ty≥
, 
§c_«l_ty≥
;

1848 
uöt32_t
 
Àn
, 
æí
;

1849 
ngx_buf_t
 
out
, *
b
;

1850 
uöt32_t
 
˘s
;

1851 
ngx_πmp_m≥gts_‰ame_t
 
‰ame
;

1852 
ngx_uöt_t
 
«l_byãs
;

1853 
ngx_öt_t
 
aud_£¡
, 
•s_µs_£¡
, 
bound¨y
;

1854 
u_ch¨
 
buf„r
[
NGX_RTMP_HLS_BUFSIZE
];

1856 
hacf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_hls_moduÀ
);

1858 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_hls_moduÀ
);

1860 
codec_˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

1862 i‡(
hacf
 =
NULL
 || !hacf->
hls
 || 
˘x
 =NULL || 
codec_˘x
 == NULL ||

1863 
codec_˘x
->
avc_hódî
 =
NULL
 || 
h
->
mÀn
 < 1)

1865  
NGX_OK
;

1869 i‡(
codec_˘x
->
video_codec_id
 !
NGX_RTMP_VIDEO_H264
) {

1870  
NGX_OK
;

1873 
p
 = 
ö
->
buf
->
pos
;

1874 i‡(
	`ngx_πmp_hls_c›y
(
s
, &
fmt
, &
p
, 1, &
ö
Ë!
NGX_OK
) {

1875  
NGX_ERROR
;

1882 
·y≥
 = (
fmt
 & 0xf0) >> 4;

1886 i‡(
	`ngx_πmp_hls_c›y
(
s
, &
hty≥
, &
p
, 1, &
ö
Ë!
NGX_OK
) {

1887  
NGX_ERROR
;

1892 i‡(
hty≥
 != 1) {

1893  
NGX_OK
;

1898 i‡(
	`ngx_πmp_hls_c›y
(
s
, &
˘s
, &
p
, 3, &
ö
Ë!
NGX_OK
) {

1899  
NGX_ERROR
;

1902 
˘s
 = ((cts & 0x00FF0000) >> 16) | ((cts & 0x000000FF) << 16) |

1903 (
˘s
 & 0x0000FF00);

1905 
	`ngx_memzîo
(&
out
, (out));

1907 
out
.
°¨t
 = 
buf„r
;

1908 
out
.
íd
 = 
buf„r
 + (buffer);

1909 
out
.
pos
 = out.
°¨t
;

1910 
out
.
œ°
 = out.
pos
;

1912 
«l_byãs
 = 
codec_˘x
->
avc_«l_byãs
;

1913 
aud_£¡
 = 0;

1914 
•s_µs_£¡
 = 0;

1916 
ö
) {

1917 i‡(
	`ngx_πmp_hls_c›y
(
s
, &
æí
, &
p
, 
«l_byãs
, &
ö
Ë!
NGX_OK
) {

1918  
NGX_OK
;

1921 
Àn
 = 0;

1922 
	`ngx_πmp_rmem˝y
(&
Àn
, &
æí
, 
«l_byãs
);

1924 i‡(
Àn
 == 0) {

1928 i‡(
	`ngx_πmp_hls_c›y
(
s
, &
§c_«l_ty≥
, &
p
, 1, &
ö
Ë!
NGX_OK
) {

1929  
NGX_OK
;

1932 
«l_ty≥
 = 
§c_«l_ty≥
 & 0x1f;

1934 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1936 (
ngx_uöt_t
Ë
«l_ty≥
, 
Àn
);

1938 i‡(
«l_ty≥
 >= 7 &&Çal_type <= 9) {

1939 i‡(
	`ngx_πmp_hls_c›y
(
s
, 
NULL
, &
p
, 
Àn
 - 1, &
ö
Ë!
NGX_OK
) {

1940  
NGX_ERROR
;

1945 i‡(!
aud_£¡
) {

1946 
«l_ty≥
) {

1950 i‡(
	`ngx_πmp_hls_≠≥nd_aud
(
s
, &
out
Ë!
NGX_OK
) {

1951 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1955 
aud_£¡
 = 1;

1960 
«l_ty≥
) {

1962 
•s_µs_£¡
 = 0;

1965 i‡(
•s_µs_£¡
) {

1968 i‡(
	`ngx_πmp_hls_≠≥nd_•s_µs
(
s
, &
out
Ë!
NGX_OK
) {

1969 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1972 
•s_µs_£¡
 = 1;

1978 i‡(
out
.
íd
 - out.
œ°
 < 5) {

1979 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1981  
NGX_OK
;

1986 i‡(
out
.
œ°
 =out.
pos
) {

1987 *
out
.
œ°
++ = 0;

1990 *
out
.
œ°
++ = 0;

1991 *
out
.
œ°
++ = 0;

1992 *
out
.
œ°
++ = 1;

1993 *
out
.
œ°
++ = 
§c_«l_ty≥
;

1997 i‡(
out
.
íd
 - out.
œ°
 < (
ngx_öt_t
Ë
Àn
) {

1998 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

2000  
NGX_OK
;

2003 i‡(
	`ngx_πmp_hls_c›y
(
s
, 
out
.
œ°
, &
p
, 
Àn
 - 1, &
ö
Ë!
NGX_OK
) {

2004  
NGX_ERROR
;

2007 
out
.
œ°
 +(
Àn
 - 1);

2010 
	`ngx_memzîo
(&
‰ame
, (frame));

2012 
‰ame
.
cc
 = 
˘x
->
video_cc
;

2013 
‰ame
.
dts
 = (
uöt64_t
Ë
h
->
time°amp
 * 90;

2014 
‰ame
.
±s
 = føme.
dts
 + 
˘s
 * 90;

2015 
‰ame
.
pid
 = 0x100;

2016 
‰ame
.
sid
 = 0xe0;

2017 
‰ame
.
key
 = (
·y≥
 == 1);

2025 
b
 = 
˘x
->
a‰ame
;

2026 
bound¨y
 = 
‰ame
.
key
 && (
codec_˘x
->
Øc_hódî
 =
NULL
 || !
˘x
->
›íed
 ||

2027 (
b
 && b->
œ°
 > b->
pos
));

2029 
	`ngx_πmp_hls_upd©e_‰agmít
(
s
, 
‰ame
.
dts
, 
bound¨y
, 1);

2031 i‡(!
˘x
->
›íed
) {

2032  
NGX_OK
;

2035 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

2036 "hls: videÿ±s=%uL, dts=%uL", 
‰ame
.
±s
, føme.
dts
);

2038 i‡(
	`ngx_πmp_m≥gts_wrôe_‰ame
(&
˘x
->
fûe
, &
‰ame
, &
out
Ë!
NGX_OK
) {

2039 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

2043 
˘x
->
video_cc
 = 
‰ame
.
cc
;

2045  
NGX_OK
;

2046 
	}
}

2049 
ngx_öt_t


2050 
	$ngx_πmp_hls_°ªam_begö
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_°ªam_begö_t
 *
v
)

2052  
	`√xt_°ªam_begö
(
s
, 
v
);

2053 
	}
}

2056 
ngx_öt_t


2057 
	$ngx_πmp_hls_°ªam_eof
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_°ªam_eof_t
 *
v
)

2059 
	`ngx_πmp_hls_Êush_audio
(
s
);

2061 
	`ngx_πmp_hls_˛o£_‰agmít
(
s
);

2063  
	`√xt_°ªam_eof
(
s
, 
v
);

2064 
	}
}

2067 
ngx_öt_t


2068 
	$ngx_πmp_hls_˛ónup_dú
(
ngx_°r_t
 *
µ©h
, 
ngx_m£c_t
 
∂ayÀn
)

2070 
ngx_dú_t
 
dú
;

2071 
time_t
 
mtime
, 
max_age
;

2072 
ngx_îr_t
 
îr
;

2073 
ngx_°r_t
 
«me
, 
•©h
;

2074 
u_ch¨
 *
p
;

2075 
ngx_öt_t
 
√¡rõs
, 
√ø£d
;

2076 
u_ch¨
 
∑th
[
NGX_MAX_PATH
 + 1];

2078 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
ngx_cy˛e
->
log
, 0,

2080 
µ©h
, 
∂ayÀn
);

2082 i‡(
	`ngx_›í_dú
(
µ©h
, &
dú
Ë!
NGX_OK
) {

2083 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
ngx_cy˛e
->
log
, 
ngx_î∫o
,

2084 "hls: cÀ™u∞›í dú faûed '%V'", 
µ©h
);

2085  
NGX_ERROR
;

2088 
√¡rõs
 = 0;

2089 
√ø£d
 = 0;

2092 
	`ngx_£t_î∫o
(0);

2094 i‡(
	`ngx_ªad_dú
(&
dú
Ë=
NGX_ERROR
) {

2095 
îr
 = 
ngx_î∫o
;

2097 i‡(
	`ngx_˛o£_dú
(&
dú
Ë=
NGX_ERROR
) {

2098 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
ngx_cy˛e
->
log
, 
ngx_î∫o
,

2099 "hls: cÀ™u∞" 
ngx_˛o£_dú_n
 " \"%V\" failed",

2100 
µ©h
);

2103 i‡(
îr
 =
NGX_ENOMOREFILES
) {

2104  
√¡rõs
 - 
√ø£d
;

2107 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
ngx_cy˛e
->
log
, 
îr
,

2108 "hls: cÀ™u∞" 
ngx_ªad_dú_n


2109 " '%V' faûed", 
µ©h
);

2110  
NGX_ERROR
;

2113 
«me
.
d©a
 = 
	`ngx_de_«me
(&
dú
);

2114 i‡(
«me
.
d©a
[0] == '.') {

2118 
«me
.
Àn
 = 
	`ngx_de_«mñí
(&
dú
);

2120 
p
 = 
	`ngx_¢¥ötf
(
∑th
, ’©hË- 1, "%V/%V", 
µ©h
, &
«me
);

2121 *
p
 = 0;

2123 
•©h
.
d©a
 = 
∑th
;

2124 
•©h
.
Àn
 = 
p
 - 
∑th
;

2126 
√¡rõs
++;

2128 i‡(!
dú
.
vÆid_öfo
 && 
	`ngx_de_öfo
(
∑th
, &dúË=
NGX_FILE_ERROR
) {

2129 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
ngx_cy˛e
->
log
, 
ngx_î∫o
,

2130 "hls: cÀ™u∞" 
ngx_de_öfo_n
 " \"%V\" failed",

2131 &
•©h
);

2136 i‡(
	`ngx_de_is_dú
(&
dú
)) {

2138 i‡(
	`ngx_πmp_hls_˛ónup_dú
(&
•©h
, 
∂ayÀn
) == 0) {

2139 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
ngx_cy˛e
->
log
, 0,

2140 "hls: cÀ™u∞dú '%V'", &
«me
);

2147 *
p
 = 0;

2149 i‡(
	`ngx_dñëe_dú
(
∑th
Ë=
NGX_FILE_ERROR
) {

2150 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
ngx_cy˛e
->
log
, 
ngx_î∫o
,

2151 "hls: cÀ™u∞" 
ngx_dñëe_dú_n


2152 " faûed o¿'%V'", &
•©h
);

2154 
√ø£d
++;

2161 i‡(!
	`ngx_de_is_fûe
(&
dú
)) {

2165 i‡(
«me
.
Àn
 >3 &&Çame.
d©a
[name.len - 3] == '.' &&

2166 
«me
.
d©a
[«me.
Àn
 - 2] == 't' &&

2167 
«me
.
d©a
[«me.
Àn
 - 1] == 's')

2169 
max_age
 = 
∂ayÀn
 / 500;

2171 } i‡(
«me
.
Àn
 >5 &&Çame.
d©a
[name.len - 5] == '.' &&

2172 
«me
.
d©a
[«me.
Àn
 - 4] == 'm' &&

2173 
«me
.
d©a
[«me.
Àn
 - 3] == '3' &&

2174 
«me
.
d©a
[«me.
Àn
 - 2] == 'u' &&

2175 
«me
.
d©a
[«me.
Àn
 - 1] == '8')

2177 
max_age
 = 
∂ayÀn
 / 1000;

2179 } i‡(
«me
.
Àn
 >4 &&Çame.
d©a
[name.len - 4] == '.' &&

2180 
«me
.
d©a
[«me.
Àn
 - 3] == 'k' &&

2181 
«me
.
d©a
[«me.
Àn
 - 2] == 'e' &&

2182 
«me
.
d©a
[«me.
Àn
 - 1] == 'y')

2184 
max_age
 = 
∂ayÀn
 / 500;

2187 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
ngx_cy˛e
->
log
, 0,

2188 "hls: cÀ™u∞skù unknow¿fûêty≥ '%V'", &
«me
);

2192 
mtime
 = 
	`ngx_de_mtime
(&
dú
);

2193 i‡(
mtime
 + 
max_age
 > 
ngx_ˇched_time
->
£c
) {

2197 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
ngx_cy˛e
->
log
, 0,

2199 &
«me
, 
mtime
, 
ngx_ˇched_time
->
£c
 - mtime);

2201 i‡(
	`ngx_dñëe_fûe
(
∑th
Ë=
NGX_FILE_ERROR
) {

2202 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
ngx_cy˛e
->
log
, 
ngx_î∫o
,

2203 "hls: cÀ™u∞" 
ngx_dñëe_fûe_n
 " failed on '%V'",

2204 &
•©h
);

2208 
√ø£d
++;

2210 
	}
}

2213 
time_t


2214 
	$ngx_πmp_hls_˛ónup
(*
d©a
)

2216 
ngx_πmp_hls_˛ónup_t
 *
˛ónup
 = 
d©a
;

2218 
	`ngx_πmp_hls_˛ónup_dú
(&
˛ónup
->
∑th
, cÀ™up->
∂ayÀn
);

2220  
˛ónup
->
∂ayÀn
 / 500;

2221 
	}
}

2225 
	$ngx_πmp_hls_v¨ü¡
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

2227 
ngx_πmp_hls_≠p_c⁄f_t
 *
hacf
 = 
c⁄f
;

2229 
ngx_°r_t
 *
vÆue
, *
¨g
;

2230 
ngx_uöt_t
 
n
;

2231 
ngx_πmp_hls_v¨ü¡_t
 *
v¨
;

2233 
vÆue
 = 
cf
->
¨gs
->
ñts
;

2235 i‡(
hacf
->
v¨ü¡
 =
NULL
) {

2236 
hacf
->
v¨ü¡
 = 
	`ngx_¨øy_¸óã
(
cf
->
poﬁ
, 1,

2237 (
ngx_πmp_hls_v¨ü¡_t
));

2238 i‡(
hacf
->
v¨ü¡
 =
NULL
) {

2239  
NGX_CONF_ERROR
;

2243 
v¨
 = 
	`ngx_¨øy_push
(
hacf
->
v¨ü¡
);

2244 i‡(
v¨
 =
NULL
) {

2245  
NGX_CONF_ERROR
;

2248 
	`ngx_memzîo
(
v¨
, (
ngx_πmp_hls_v¨ü¡_t
));

2250 
v¨
->
suffix
 = 
vÆue
[1];

2252 i‡(
cf
->
¨gs
->
√…s
 == 2) {

2253  
NGX_CONF_OK
;

2256 i‡(
	`ngx_¨øy_öô
(&
v¨
->
¨gs
, 
cf
->
poﬁ
, cf->¨gs->
√…s
 - 2,

2257 (
ngx_°r_t
))

2258 !
NGX_OK
)

2260  
NGX_CONF_ERROR
;

2263 
¨g
 = 
	`ngx_¨øy_push_n
(&
v¨
->
¨gs
, 
cf
->¨gs->
√…s
 - 2);

2264 i‡(
¨g
 =
NULL
) {

2265  
NGX_CONF_ERROR
;

2268 
n
 = 2;Ç < 
cf
->
¨gs
->
√…s
;Ç++) {

2269 *
¨g
++ = 
vÆue
[
n
];

2272  
NGX_CONF_OK
;

2273 
	}
}

2277 
	$ngx_πmp_hls_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
)

2279 
ngx_πmp_hls_≠p_c⁄f_t
 *
c⁄f
;

2281 
c⁄f
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_hls_≠p_c⁄f_t
));

2282 i‡(
c⁄f
 =
NULL
) {

2283  
NULL
;

2286 
c⁄f
->
hls
 = 
NGX_CONF_UNSET
;

2287 
c⁄f
->
‰agÀn
 = 
NGX_CONF_UNSET_MSEC
;

2288 
c⁄f
->
max_‰agÀn
 = 
NGX_CONF_UNSET_MSEC
;

2289 
c⁄f
->
muxdñay
 = 
NGX_CONF_UNSET_MSEC
;

2290 
c⁄f
->
sync
 = 
NGX_CONF_UNSET_MSEC
;

2291 
c⁄f
->
∂ayÀn
 = 
NGX_CONF_UNSET_MSEC
;

2292 
c⁄f
->
c⁄töuous
 = 
NGX_CONF_UNSET
;

2293 
c⁄f
->
√°ed
 = 
NGX_CONF_UNSET
;

2294 
c⁄f
->
«mög
 = 
NGX_CONF_UNSET_UINT
;

2295 
c⁄f
->
¶icög
 = 
NGX_CONF_UNSET_UINT
;

2296 
c⁄f
->
ty≥
 = 
NGX_CONF_UNSET_UINT
;

2297 
c⁄f
->
max_audio_dñay
 = 
NGX_CONF_UNSET_MSEC
;

2298 
c⁄f
->
audio_buf„r_size
 = 
NGX_CONF_UNSET_SIZE
;

2299 
c⁄f
->
˛ónup
 = 
NGX_CONF_UNSET
;

2300 
c⁄f
->
gønuœrôy
 = 
NGX_CONF_UNSET
;

2301 
c⁄f
->
keys
 = 
NGX_CONF_UNSET
;

2302 
c⁄f
->
‰ags_≥r_key
 = 
NGX_CONF_UNSET_UINT
;

2304  
c⁄f
;

2305 
	}
}

2309 
	$ngx_πmp_hls_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
∑ª¡
, *
chûd
)

2311 
ngx_πmp_hls_≠p_c⁄f_t
 *
¥ev
 = 
∑ª¡
;

2312 
ngx_πmp_hls_≠p_c⁄f_t
 *
c⁄f
 = 
chûd
;

2313 
ngx_πmp_hls_˛ónup_t
 *
˛ónup
;

2315 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
hls
, 
¥ev
->hls, 0);

2316 
	`ngx_c⁄f_mîge_m£c_vÆue
(
c⁄f
->
‰agÀn
, 
¥ev
->fraglen, 5000);

2317 
	`ngx_c⁄f_mîge_m£c_vÆue
(
c⁄f
->
max_‰agÀn
, 
¥ev
->max_fraglen,

2318 
c⁄f
->
‰agÀn
 * 10);

2319 
	`ngx_c⁄f_mîge_m£c_vÆue
(
c⁄f
->
muxdñay
, 
¥ev
->muxdelay, 700);

2320 
	`ngx_c⁄f_mîge_m£c_vÆue
(
c⁄f
->
sync
, 
¥ev
->sync, 2);

2321 
	`ngx_c⁄f_mîge_m£c_vÆue
(
c⁄f
->
∂ayÀn
, 
¥ev
->playlen, 30000);

2322 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
c⁄töuous
, 
¥ev
->continuous, 1);

2323 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
√°ed
, 
¥ev
->nested, 0);

2324 
	`ngx_c⁄f_mîge_uöt_vÆue
(
c⁄f
->
«mög
, 
¥ev
->naming,

2325 
NGX_RTMP_HLS_NAMING_SEQUENTIAL
);

2326 
	`ngx_c⁄f_mîge_uöt_vÆue
(
c⁄f
->
¶icög
, 
¥ev
->slicing,

2327 
NGX_RTMP_HLS_SLICING_PLAIN
);

2328 
	`ngx_c⁄f_mîge_uöt_vÆue
(
c⁄f
->
ty≥
, 
¥ev
->type,

2329 
NGX_RTMP_HLS_TYPE_LIVE
);

2330 
	`ngx_c⁄f_mîge_m£c_vÆue
(
c⁄f
->
max_audio_dñay
, 
¥ev
->max_audio_delay,

2332 
	`ngx_c⁄f_mîge_size_vÆue
(
c⁄f
->
audio_buf„r_size
, 
¥ev
->audio_buffer_size,

2333 
NGX_RTMP_HLS_BUFSIZE
);

2334 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
˛ónup
, 
¥ev
->cleanup, 1);

2335 
	`ngx_c⁄f_mîge_°r_vÆue
(
c⁄f
->
ba£_uæ
, 
¥ev
->base_url, "");

2336 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
gønuœrôy
, 
¥ev
->granularity, 0);

2337 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
keys
, 
¥ev
->keys, 0);

2338 
	`ngx_c⁄f_mîge_°r_vÆue
(
c⁄f
->
key_∑th
, 
¥ev
->key_path, "");

2339 
	`ngx_c⁄f_mîge_°r_vÆue
(
c⁄f
->
key_uæ
, 
¥ev
->key_url, "");

2340 
	`ngx_c⁄f_mîge_uöt_vÆue
(
c⁄f
->
‰ags_≥r_key
, 
¥ev
->frags_per_key, 0);

2342 i‡(
c⁄f
->
‰agÀn
) {

2343 
c⁄f
->
wö‰ags
 = c⁄f->
∂ayÀn
 / c⁄f->
‰agÀn
;

2348 i‡(
c⁄f
->
hls
 && c⁄f->
∑th
.
Àn
 && c⁄f->
˛ónup
 &&

2349 
c⁄f
->
ty≥
 !
NGX_RTMP_HLS_TYPE_EVENT
)

2351 i‡(
c⁄f
->
∑th
.
d©a
[c⁄f->∑th.
Àn
 - 1] == '/') {

2352 
c⁄f
->
∑th
.
Àn
--;

2355 
˛ónup
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (*cleanup));

2356 i‡(
˛ónup
 =
NULL
) {

2357  
NGX_CONF_ERROR
;

2360 
˛ónup
->
∑th
 = 
c⁄f
->path;

2361 
˛ónup
->
∂ayÀn
 = 
c⁄f
->playlen;

2363 
c⁄f
->
¶Ÿ
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (*conf->slot));

2364 i‡(
c⁄f
->
¶Ÿ
 =
NULL
) {

2365  
NGX_CONF_ERROR
;

2368 
c⁄f
->
¶Ÿ
->
m™agî
 = 
ngx_πmp_hls_˛ónup
;

2369 
c⁄f
->
¶Ÿ
->
«me
 = c⁄f->
∑th
;

2370 
c⁄f
->
¶Ÿ
->
d©a
 = 
˛ónup
;

2371 
c⁄f
->
¶Ÿ
->
c⁄f_fûe
 = 
cf
->c⁄f_fûe->
fûe
.
«me
.
d©a
;

2372 
c⁄f
->
¶Ÿ
->
löe
 = 
cf
->
c⁄f_fûe
->line;

2374 i‡(
	`ngx_add_∑th
(
cf
, &
c⁄f
->
¶Ÿ
Ë!
NGX_OK
) {

2375  
NGX_CONF_ERROR
;

2379 
	`ngx_c⁄f_mîge_°r_vÆue
(
c⁄f
->
∑th
, 
¥ev
->path, "");

2381 i‡(
c⁄f
->
keys
 && c⁄f->
˛ónup
 && c⁄f->
key_∑th
.
Àn
 &&

2382 
	`ngx_°rcmp
(
c⁄f
->
key_∑th
.
d©a
, c⁄f->
∑th
.data) != 0 &&

2383 
c⁄f
->
ty≥
 !
NGX_RTMP_HLS_TYPE_EVENT
)

2385 i‡(
c⁄f
->
key_∑th
.
d©a
[c⁄f->key_∑th.
Àn
 - 1] == '/') {

2386 
c⁄f
->
key_∑th
.
Àn
--;

2389 
˛ónup
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (*cleanup));

2390 i‡(
˛ónup
 =
NULL
) {

2391  
NGX_CONF_ERROR
;

2394 
˛ónup
->
∑th
 = 
c⁄f
->
key_∑th
;

2395 
˛ónup
->
∂ayÀn
 = 
c⁄f
->playlen;

2397 
c⁄f
->
¶Ÿ
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (*conf->slot));

2398 i‡(
c⁄f
->
¶Ÿ
 =
NULL
) {

2399  
NGX_CONF_ERROR
;

2402 
c⁄f
->
¶Ÿ
->
m™agî
 = 
ngx_πmp_hls_˛ónup
;

2403 
c⁄f
->
¶Ÿ
->
«me
 = c⁄f->
key_∑th
;

2404 
c⁄f
->
¶Ÿ
->
d©a
 = 
˛ónup
;

2405 
c⁄f
->
¶Ÿ
->
c⁄f_fûe
 = 
cf
->c⁄f_fûe->
fûe
.
«me
.
d©a
;

2406 
c⁄f
->
¶Ÿ
->
löe
 = 
cf
->
c⁄f_fûe
->line;

2408 i‡(
	`ngx_add_∑th
(
cf
, &
c⁄f
->
¶Ÿ
Ë!
NGX_OK
) {

2409  
NGX_CONF_ERROR
;

2413 
	`ngx_c⁄f_mîge_°r_vÆue
(
c⁄f
->
key_∑th
, 
¥ev
->key_path, "");

2415 i‡(
c⁄f
->
key_∑th
.
Àn
 == 0) {

2416 
c⁄f
->
key_∑th
 = c⁄f->
∑th
;

2419  
NGX_CONF_OK
;

2420 
	}
}

2423 
ngx_öt_t


2424 
	$ngx_πmp_hls_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
)

2426 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
;

2427 
ngx_πmp_h™dÀr_±
 *
h
;

2429 
cmcf
 = 
	`ngx_πmp_c⁄f_gë_moduÀ_maö_c⁄f
(
cf
, 
ngx_πmp_c‹e_moduÀ
);

2431 
h
 = 
	`ngx_¨øy_push
(&
cmcf
->
evíts
[
NGX_RTMP_MSG_VIDEO
]);

2432 *
h
 = 
ngx_πmp_hls_video
;

2434 
h
 = 
	`ngx_¨øy_push
(&
cmcf
->
evíts
[
NGX_RTMP_MSG_AUDIO
]);

2435 *
h
 = 
ngx_πmp_hls_audio
;

2437 
√xt_publish
 = 
ngx_πmp_publish
;

2438 
ngx_πmp_publish
 = 
ngx_πmp_hls_publish
;

2440 
√xt_˛o£_°ªam
 = 
ngx_πmp_˛o£_°ªam
;

2441 
ngx_πmp_˛o£_°ªam
 = 
ngx_πmp_hls_˛o£_°ªam
;

2443 
√xt_°ªam_begö
 = 
ngx_πmp_°ªam_begö
;

2444 
ngx_πmp_°ªam_begö
 = 
ngx_πmp_hls_°ªam_begö
;

2446 
√xt_°ªam_eof
 = 
ngx_πmp_°ªam_eof
;

2447 
ngx_πmp_°ªam_eof
 = 
ngx_πmp_hls_°ªam_eof
;

2449  
NGX_OK
;

2450 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/hls/ngx_rtmp_mpegts.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp_m≥gts.h
"

12 
u_ch¨
 
	gngx_πmp_m≥gts_hódî
[] = {

75 
	#NGX_RTMP_HLS_DELAY
 63000

	)

78 
ngx_öt_t


79 
	$ngx_πmp_m≥gts_wrôe_fûe
(
ngx_πmp_m≥gts_fûe_t
 *
fûe
, 
u_ch¨
 *
ö
,

80 
size_t
 
ö_size
)

82 
u_ch¨
 *
out
;

83 
size_t
 
out_size
, 
n
;

84 
ssize_t
 
rc
;

86 
u_ch¨
 
buf
[1024];

88 i‡(!
fûe
->
í¸y±
) {

89 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
fûe
->
log
, 0,

90 "m≥gts: wrôê%uz byãs", 
ö_size
);

92 
rc
 = 
	`ngx_wrôe_fd
(
fûe
->
fd
, 
ö
, 
ö_size
);

93 i‡(
rc
 < 0) {

94  
NGX_ERROR
;

97  
NGX_OK
;

102 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_CORE
, 
fûe
->
log
, 0,

103 "m≥gts: wrôê%uzÉn¸y±ed byãs", 
ö_size
);

105 
out
 = 
buf
;

106 
out_size
 = (
buf
);

108 i‡(
fûe
->
size
 > 0 && fûe->sizê+ 
ö_size
 >= 16) {

109 
	`ngx_mem˝y
(
fûe
->
buf
 + fûe->
size
, 
ö
, 16 - file->size);

111 
ö
 +16 - 
fûe
->
size
;

112 
ö_size
 -16 - 
fûe
->
size
;

114 
	`AES_cbc_í¸y±
(
fûe
->
buf
, 
out
, 16, &fûe->
key
, fûe->
iv
, 
AES_ENCRYPT
);

116 
out
 += 16;

117 
out_size
 -= 16;

119 
fûe
->
size
 = 0;

123 
n
 = 
ö_size
 & ~0x0f;

125 i‡(
n
 > 0) {

126 i‡(
n
 > 
out_size
) {

127 
n
 = 
out_size
;

130 
	`AES_cbc_í¸y±
(
ö
, 
out
, 
n
, &
fûe
->
key
, fûe->
iv
, 
AES_ENCRYPT
);

132 
ö
 +
n
;

133 
ö_size
 -
n
;

135 } i‡(
out
 =
buf
) {

139 
rc
 = 
	`ngx_wrôe_fd
(
fûe
->
fd
, 
buf
, 
out
 - bu‡+ 
n
);

140 i‡(
rc
 < 0) {

141  
NGX_ERROR
;

144 
out
 = 
buf
;

145 
out_size
 = (
buf
);

148 i‡(
ö_size
) {

149 
	`ngx_mem˝y
(
fûe
->
buf
 + fûe->
size
, 
ö
, 
ö_size
);

150 
fûe
->
size
 +
ö_size
;

153  
NGX_OK
;

154 
	}
}

157 
ngx_öt_t


158 
	$ngx_πmp_m≥gts_wrôe_hódî
(
ngx_πmp_m≥gts_fûe_t
 *
fûe
)

160  
	`ngx_πmp_m≥gts_wrôe_fûe
(
fûe
, 
ngx_πmp_m≥gts_hódî
,

161 (
ngx_πmp_m≥gts_hódî
));

162 
	}
}

165 
u_ch¨
 *

166 
	$ngx_πmp_m≥gts_wrôe_p¸
(
u_ch¨
 *
p
, 
uöt64_t
 
p¸
)

168 *
p
++ = (
u_ch¨
Ë(
p¸
 >> 25);

169 *
p
++ = (
u_ch¨
Ë(
p¸
 >> 17);

170 *
p
++ = (
u_ch¨
Ë(
p¸
 >> 9);

171 *
p
++ = (
u_ch¨
Ë(
p¸
 >> 1);

172 *
p
++ = (
u_ch¨
Ë(
p¸
 << 7 | 0x7e);

173 *
p
++ = 0;

175  
p
;

176 
	}
}

179 
u_ch¨
 *

180 
	$ngx_πmp_m≥gts_wrôe_±s
(
u_ch¨
 *
p
, 
ngx_uöt_t
 
fb
, 
uöt64_t
 
±s
)

182 
ngx_uöt_t
 
vÆ
;

184 
vÆ
 = 
fb
 << 4 | (((
±s
 >> 30) & 0x07) << 1) | 1;

185 *
p
++ = (
u_ch¨
Ë
vÆ
;

187 
vÆ
 = (((
±s
 >> 15) & 0x7fff) << 1) | 1;

188 *
p
++ = (
u_ch¨
Ë(
vÆ
 >> 8);

189 *
p
++ = (
u_ch¨
Ë
vÆ
;

191 
vÆ
 = (((
±s
) & 0x7fff) << 1) | 1;

192 *
p
++ = (
u_ch¨
Ë(
vÆ
 >> 8);

193 *
p
++ = (
u_ch¨
Ë
vÆ
;

195  
p
;

196 
	}
}

199 
ngx_öt_t


200 
	$ngx_πmp_m≥gts_wrôe_‰ame
(
ngx_πmp_m≥gts_fûe_t
 *
fûe
,

201 
ngx_πmp_m≥gts_‰ame_t
 *
f
, 
ngx_buf_t
 *
b
)

203 
ngx_uöt_t
 
≥s_size
, 
hódî_size
, 
body_size
, 
ö_size
, 
°uff_size
, 
Êags
;

204 
u_ch¨
 
∑ckë
[188], *
p
, *
ba£
;

205 
ngx_öt_t
 
fú°
, 
rc
;

207 
	`ngx_log_debug6
(
NGX_LOG_DEBUG_CORE
, 
fûe
->
log
, 0,

210 
f
->
pid
, f->
sid
, f->
±s
, f->
dts
,

211 (
ngx_uöt_t
Ë
f
->
key
, (
size_t
Ë(
b
->
œ°
 - b->
pos
));

213 
fú°
 = 1;

215 
b
->
pos
 < b->
œ°
) {

216 
p
 = 
∑ckë
;

218 
f
->
cc
++;

220 *
p
++ = 0x47;

221 *
p
++ = (
u_ch¨
Ë(
f
->
pid
 >> 8);

223 i‡(
fú°
) {

224 
p
[-1] |= 0x40;

227 *
p
++ = (
u_ch¨
Ë
f
->
pid
;

228 *
p
++ = 0x10 | (
f
->
cc
 & 0x0f);

230 i‡(
fú°
) {

232 i‡(
f
->
key
) {

233 
∑ckë
[3] |= 0x20;

235 *
p
++ = 7;

236 *
p
++ = 0x50;

238 
p
 = 
	`ngx_πmp_m≥gts_wrôe_p¸
’, 
f
->
dts
 - 
NGX_RTMP_HLS_DELAY
);

243 *
p
++ = 0x00;

244 *
p
++ = 0x00;

245 *
p
++ = 0x01;

246 *
p
++ = (
u_ch¨
Ë
f
->
sid
;

248 
hódî_size
 = 5;

249 
Êags
 = 0x80;

251 i‡(
f
->
dts
 !f->
±s
) {

252 
hódî_size
 += 5;

253 
Êags
 |= 0x40;

256 
≥s_size
 = (
b
->
œ°
 - b->
pos
Ë+ 
hódî_size
 + 3;

257 i‡(
≥s_size
 > 0xffff) {

258 
≥s_size
 = 0;

261 *
p
++ = (
u_ch¨
Ë(
≥s_size
 >> 8);

262 *
p
++ = (
u_ch¨
Ë
≥s_size
;

263 *
p
++ = 0x80;

264 *
p
++ = (
u_ch¨
Ë
Êags
;

265 *
p
++ = (
u_ch¨
Ë
hódî_size
;

267 
p
 = 
	`ngx_πmp_m≥gts_wrôe_±s
’, 
Êags
 >> 6, 
f
->
±s
 +

268 
NGX_RTMP_HLS_DELAY
);

270 i‡(
f
->
dts
 !f->
±s
) {

271 
p
 = 
	`ngx_πmp_m≥gts_wrôe_±s
’, 1, 
f
->
dts
 +

272 
NGX_RTMP_HLS_DELAY
);

275 
fú°
 = 0;

278 
body_size
 = (
ngx_uöt_t
Ë(
∑ckë
 + ’ackëË- 
p
);

279 
ö_size
 = (
ngx_uöt_t
Ë(
b
->
œ°
 - b->
pos
);

281 i‡(
body_size
 <
ö_size
) {

282 
	`ngx_mem˝y
(
p
, 
b
->
pos
, 
body_size
);

283 
b
->
pos
 +
body_size
;

286 
°uff_size
 = (
body_size
 - 
ö_size
);

288 i‡(
∑ckë
[3] & 0x20) {

292 
ba£
 = &
∑ckë
[5] +Öacket[4];

293 
p
 = 
	`ngx_movemem
(
ba£
 + 
°uff_size
, base,Ö - base);

294 
	`ngx_mem£t
(
ba£
, 0xff, 
°uff_size
);

295 
∑ckë
[4] +(
u_ch¨
Ë
°uff_size
;

301 
∑ckë
[3] |= 0x20;

302 
p
 = 
	`ngx_movemem
(&
∑ckë
[4] + 
°uff_size
, &packet[4],

303 
p
 - &
∑ckë
[4]);

305 
∑ckë
[4] = (
u_ch¨
Ë(
°uff_size
 - 1);

306 i‡(
°uff_size
 >= 2) {

307 
∑ckë
[5] = 0;

308 
	`ngx_mem£t
(&
∑ckë
[6], 0xff, 
°uff_size
 - 2);

312 
	`ngx_mem˝y
(
p
, 
b
->
pos
, 
ö_size
);

313 
b
->
pos
 = b->
œ°
;

316 
rc
 = 
	`ngx_πmp_m≥gts_wrôe_fûe
(
fûe
, 
∑ckë
, (packet));

317 i‡(
rc
 !
NGX_OK
) {

318  
rc
;

322  
NGX_OK
;

323 
	}
}

326 
ngx_öt_t


327 
	$ngx_πmp_m≥gts_öô_í¸y±i⁄
(
ngx_πmp_m≥gts_fûe_t
 *
fûe
,

328 
u_ch¨
 *
key
, 
size_t
 
key_Àn
, 
uöt64_t
 
iv
)

330 i‡(
	`AES_£t_í¸y±_key
(
key
, 
key_Àn
 * 8, &
fûe
->key)) {

331  
NGX_ERROR
;

334 
	`ngx_memzîo
(
fûe
->
iv
, 8);

336 
fûe
->
iv
[8] = (
u_ch¨
) (iv >> 56);

337 
fûe
->
iv
[9] = (
u_ch¨
) (iv >> 48);

338 
fûe
->
iv
[10] = (
u_ch¨
) (iv >> 40);

339 
fûe
->
iv
[11] = (
u_ch¨
) (iv >> 32);

340 
fûe
->
iv
[12] = (
u_ch¨
) (iv >> 24);

341 
fûe
->
iv
[13] = (
u_ch¨
) (iv >> 16);

342 
fûe
->
iv
[14] = (
u_ch¨
) (iv >> 8);

343 
fûe
->
iv
[15] = (
u_ch¨
) (iv);

345 
fûe
->
í¸y±
 = 1;

347  
NGX_OK
;

348 
	}
}

351 
ngx_öt_t


352 
	$ngx_πmp_m≥gts_›í_fûe
(
ngx_πmp_m≥gts_fûe_t
 *
fûe
, 
u_ch¨
 *
∑th
,

353 
ngx_log_t
 *
log
)

355 
fûe
->
log
 =Üog;

357 
fûe
->
fd
 = 
	`ngx_›í_fûe
(
∑th
, 
NGX_FILE_WRONLY
, 
NGX_FILE_TRUNCATE
,

358 
NGX_FILE_DEFAULT_ACCESS
);

360 i‡(
fûe
->
fd
 =
NGX_INVALID_FILE
) {

361 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
log
, 
ngx_î∫o
,

363  
NGX_ERROR
;

366 
fûe
->
size
 = 0;

368 i‡(
	`ngx_πmp_m≥gts_wrôe_hódî
(
fûe
Ë!
NGX_OK
) {

369 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
log
, 
ngx_î∫o
,

371 
	`ngx_˛o£_fûe
(
fûe
->
fd
);

372  
NGX_ERROR
;

375  
NGX_OK
;

376 
	}
}

379 
ngx_öt_t


380 
	$ngx_πmp_m≥gts_˛o£_fûe
(
ngx_πmp_m≥gts_fûe_t
 *
fûe
)

382 
u_ch¨
 
buf
[16];

383 
ssize_t
 
rc
;

385 i‡(
fûe
->
í¸y±
) {

386 
	`ngx_mem£t
(
fûe
->
buf
 + fûe->
size
, 16 - file->size, 16 - file->size);

388 
	`AES_cbc_í¸y±
(
fûe
->
buf
, buf, 16, &fûe->
key
, fûe->
iv
, 
AES_ENCRYPT
);

390 
rc
 = 
	`ngx_wrôe_fd
(
fûe
->
fd
, 
buf
, 16);

391 i‡(
rc
 < 0) {

392  
NGX_ERROR
;

396 
	`ngx_˛o£_fûe
(
fûe
->
fd
);

398  
NGX_OK
;

399 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/hls/ngx_rtmp_mpegts.h

7 #i‚de‡
_NGX_RTMP_MPEGTS_H_INCLUDED_


8 
	#_NGX_RTMP_MPEGTS_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

13 
	~<›ís¶/´s.h
>

17 
ngx_fd_t
 
	mfd
;

18 
ngx_log_t
 *
	mlog
;

19 
	mí¸y±
:1;

20 
	msize
:4;

21 
u_ch¨
 
	mbuf
[16];

22 
u_ch¨
 
	miv
[16];

23 
AES_KEY
 
	mkey
;

24 } 
	tngx_πmp_m≥gts_fûe_t
;

28 
uöt64_t
 
	m±s
;

29 
uöt64_t
 
	mdts
;

30 
ngx_uöt_t
 
	mpid
;

31 
ngx_uöt_t
 
	msid
;

32 
ngx_uöt_t
 
	mcc
;

33 
	mkey
:1;

34 } 
	tngx_πmp_m≥gts_‰ame_t
;

37 
ngx_öt_t
 
ngx_πmp_m≥gts_öô_í¸y±i⁄
(
ngx_πmp_m≥gts_fûe_t
 *
fûe
,

38 
u_ch¨
 *
key
, 
size_t
 
key_Àn
, 
uöt64_t
 
iv
);

39 
ngx_öt_t
 
ngx_πmp_m≥gts_›í_fûe
(
ngx_πmp_m≥gts_fûe_t
 *
fûe
, 
u_ch¨
 *
∑th
,

40 
ngx_log_t
 *
log
);

41 
ngx_öt_t
 
ngx_πmp_m≥gts_˛o£_fûe
(
ngx_πmp_m≥gts_fûe_t
 *
fûe
);

42 
ngx_öt_t
 
ngx_πmp_m≥gts_wrôe_‰ame
(
ngx_πmp_m≥gts_fûe_t
 *
fûe
,

43 
ngx_πmp_m≥gts_‰ame_t
 *
f
, 
ngx_buf_t
 *
b
);

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~<ngx_evít.h
>

10 
	~<ngöx.h
>

11 
	~"ngx_πmp.h
"

14 *
ngx_πmp_block
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

15 
ngx_öt_t
 
ngx_πmp_add_p‹ts
(
ngx_c⁄f_t
 *
cf
, 
ngx_¨øy_t
 *
p‹ts
,

16 
ngx_πmp_li°í_t
 *
li°í
);

17 *
ngx_πmp_›timize_£rvîs
(
ngx_c⁄f_t
 *
cf
, 
ngx_¨øy_t
 *
p‹ts
);

18 
ngx_öt_t
 
ngx_πmp_add_addrs
(
ngx_c⁄f_t
 *
cf
, 
ngx_πmp_p‹t_t
 *
mp‹t
,

19 
ngx_πmp_c⁄f_addr_t
 *
addr
);

20 #i‡(
NGX_HAVE_INET6
)

21 
ngx_öt_t
 
ngx_πmp_add_addrs6
(
ngx_c⁄f_t
 *
cf
, 
ngx_πmp_p‹t_t
 *
mp‹t
,

22 
ngx_πmp_c⁄f_addr_t
 *
addr
);

24 
ngx_öt_t
 
ngx_πmp_cmp_c⁄f_addrs
(c⁄° *
⁄e
, c⁄° *
two
);

25 
ngx_öt_t
 
ngx_πmp_öô_evíts
(
ngx_c⁄f_t
 *
cf
,

26 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
);

27 
ngx_öt_t
 
ngx_πmp_öô_evít_h™dÀrs
(
ngx_c⁄f_t
 *
cf
,

28 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
);

29 * 
ngx_πmp_mîge_≠∂iˇti⁄s
(
ngx_c⁄f_t
 *
cf
,

30 
ngx_¨øy_t
 *
≠∂iˇti⁄s
, **
≠p_c⁄f
, 
ngx_πmp_moduÀ_t
 *
moduÀ
,

31 
ngx_uöt_t
 
˘x_ödex
);

32 
ngx_öt_t
 
ngx_πmp_öô_¥o˚ss
(
ngx_cy˛e_t
 *
cy˛e
);

35 #i‡(
ngöx_vîsi⁄
 >= 1007005)

36 
ngx_thªad_vﬁ©ûe
 
ngx_queue_t
 
	gngx_πmp_öô_queue
;

38 
ngx_thªad_vﬁ©ûe
 
ngx_evít_t
 *
	gngx_πmp_öô_queue
;

42 
ngx_uöt_t
 
	gngx_πmp_max_moduÀ
;

45 
ngx_comm™d_t
 
	gngx_πmp_comm™ds
[] = {

47 { 
ngx_°rög
("rtmp"),

48 
NGX_MAIN_CONF
|
NGX_CONF_BLOCK
|
NGX_CONF_NOARGS
,

49 
ngx_πmp_block
,

52 
NULL
 },

54 
ngx_nuŒ_comm™d


58 
ngx_c‹e_moduÀ_t
 
	gngx_πmp_moduÀ_˘x
 = {

59 
ngx_°rög
("rtmp"),

60 
NULL
,

61 
NULL


65 
ngx_moduÀ_t
 
	gngx_πmp_moduÀ
 = {

66 
NGX_MODULE_V1
,

67 &
ngx_πmp_moduÀ_˘x
,

68 
ngx_πmp_comm™ds
,

69 
NGX_CORE_MODULE
,

70 
NULL
,

71 
NULL
,

72 
ngx_πmp_öô_¥o˚ss
,

73 
NULL
,

74 
NULL
,

75 
NULL
,

76 
NULL
,

77 
NGX_MODULE_V1_PADDING


82 
	$ngx_πmp_block
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

84 *
rv
;

85 
ngx_uöt_t
 
i
, 
m
, 
mi
, 
s
;

86 
ngx_c⁄f_t
 
pcf
;

87 
ngx_¨øy_t
 
p‹ts
;

88 
ngx_πmp_li°í_t
 *
li°í
;

89 
ngx_πmp_moduÀ_t
 *
moduÀ
;

90 
ngx_πmp_c⁄f_˘x_t
 *
˘x
;

91 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
, **
cscÂ
;

92 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
;

94 
˘x
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_c⁄f_˘x_t
));

95 i‡(
˘x
 =
NULL
) {

96  
NGX_CONF_ERROR
;

99 *(
ngx_πmp_c⁄f_˘x_t
 **Ë
c⁄f
 = 
˘x
;

103 
ngx_πmp_max_moduÀ
 = 0;

104 
m
 = 0; 
ngx_moduÀs
[m]; m++) {

105 i‡(
ngx_moduÀs
[
m
]->
ty≥
 !
NGX_RTMP_MODULE
) {

109 
ngx_moduÀs
[
m
]->
˘x_ödex
 = 
ngx_πmp_max_moduÀ
++;

115 
˘x
->
maö_c⁄f
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
,

116 (*Ë* 
ngx_πmp_max_moduÀ
);

117 i‡(
˘x
->
maö_c⁄f
 =
NULL
) {

118  
NGX_CONF_ERROR
;

127 
˘x
->
§v_c⁄f
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (*Ë* 
ngx_πmp_max_moduÀ
);

128 i‡(
˘x
->
§v_c⁄f
 =
NULL
) {

129  
NGX_CONF_ERROR
;

138 
˘x
->
≠p_c⁄f
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (*Ë* 
ngx_πmp_max_moduÀ
);

139 i‡(
˘x
->
≠p_c⁄f
 =
NULL
) {

140  
NGX_CONF_ERROR
;

149 
m
 = 0; 
ngx_moduÀs
[m]; m++) {

150 i‡(
ngx_moduÀs
[
m
]->
ty≥
 !
NGX_RTMP_MODULE
) {

154 
moduÀ
 = 
ngx_moduÀs
[
m
]->
˘x
;

155 
mi
 = 
ngx_moduÀs
[
m
]->
˘x_ödex
;

157 i‡(
moduÀ
->
¸óã_maö_c⁄f
) {

158 
˘x
->
maö_c⁄f
[
mi
] = 
moduÀ
->
	`¸óã_maö_c⁄f
(
cf
);

159 i‡(
˘x
->
maö_c⁄f
[
mi
] =
NULL
) {

160  
NGX_CONF_ERROR
;

164 i‡(
moduÀ
->
¸óã_§v_c⁄f
) {

165 
˘x
->
§v_c⁄f
[
mi
] = 
moduÀ
->
	`¸óã_§v_c⁄f
(
cf
);

166 i‡(
˘x
->
§v_c⁄f
[
mi
] =
NULL
) {

167  
NGX_CONF_ERROR
;

171 i‡(
moduÀ
->
¸óã_≠p_c⁄f
) {

172 
˘x
->
≠p_c⁄f
[
mi
] = 
moduÀ
->
	`¸óã_≠p_c⁄f
(
cf
);

173 i‡(
˘x
->
≠p_c⁄f
[
mi
] =
NULL
) {

174  
NGX_CONF_ERROR
;

179 
pcf
 = *
cf
;

180 
cf
->
˘x
 = ctx;

182 
m
 = 0; 
ngx_moduÀs
[m]; m++) {

183 i‡(
ngx_moduÀs
[
m
]->
ty≥
 !
NGX_RTMP_MODULE
) {

187 
moduÀ
 = 
ngx_moduÀs
[
m
]->
˘x
;

189 i‡(
moduÀ
->
¥ec⁄figuøti⁄
) {

190 i‡(
moduÀ
->
	`¥ec⁄figuøti⁄
(
cf
Ë!
NGX_OK
) {

191  
NGX_CONF_ERROR
;

198 
cf
->
moduÀ_ty≥
 = 
NGX_RTMP_MODULE
;

199 
cf
->
cmd_ty≥
 = 
NGX_RTMP_MAIN_CONF
;

200 
rv
 = 
	`ngx_c⁄f_∑r£
(
cf
, 
NULL
);

202 i‡(
rv
 !
NGX_CONF_OK
) {

203 *
cf
 = 
pcf
;

204  
rv
;

210 
cmcf
 = 
˘x
->
maö_c⁄f
[
ngx_πmp_c‹e_moduÀ
.
˘x_ödex
];

211 
cscÂ
 = 
cmcf
->
£rvîs
.
ñts
;

213 
m
 = 0; 
ngx_moduÀs
[m]; m++) {

214 i‡(
ngx_moduÀs
[
m
]->
ty≥
 !
NGX_RTMP_MODULE
) {

218 
moduÀ
 = 
ngx_moduÀs
[
m
]->
˘x
;

219 
mi
 = 
ngx_moduÀs
[
m
]->
˘x_ödex
;

223 
cf
->
˘x
 = ctx;

225 i‡(
moduÀ
->
öô_maö_c⁄f
) {

226 
rv
 = 
moduÀ
->
	`öô_maö_c⁄f
(
cf
, 
˘x
->
maö_c⁄f
[
mi
]);

227 i‡(
rv
 !
NGX_CONF_OK
) {

228 *
cf
 = 
pcf
;

229  
rv
;

233 
s
 = 0; s < 
cmcf
->
£rvîs
.
√…s
; s++) {

237 
cf
->
˘x
 = 
cscÂ
[
s
]->ctx;

239 i‡(
moduÀ
->
mîge_§v_c⁄f
) {

240 
rv
 = 
moduÀ
->
	`mîge_§v_c⁄f
(
cf
,

241 
˘x
->
§v_c⁄f
[
mi
],

242 
cscÂ
[
s
]->
˘x
->
§v_c⁄f
[
mi
]);

243 i‡(
rv
 !
NGX_CONF_OK
) {

244 *
cf
 = 
pcf
;

245  
rv
;

249 i‡(
moduÀ
->
mîge_≠p_c⁄f
) {

255 
rv
 = 
moduÀ
->
	`mîge_≠p_c⁄f
(
cf
,

256 
˘x
->
≠p_c⁄f
[
mi
],

257 
cscÂ
[
s
]->
˘x
->
≠p_c⁄f
[
mi
]);

258 i‡(
rv
 !
NGX_CONF_OK
) {

259 *
cf
 = 
pcf
;

260  
rv
;

265 
cscf
 = 
cscÂ
[
s
]->
˘x
->
§v_c⁄f
[
ngx_πmp_c‹e_moduÀ
.
˘x_ödex
];

267 
rv
 = 
	`ngx_πmp_mîge_≠∂iˇti⁄s
(
cf
, &
cscf
->
≠∂iˇti⁄s
,

268 
cscÂ
[
s
]->
˘x
->
≠p_c⁄f
,

269 
moduÀ
, 
mi
);

270 i‡(
rv
 !
NGX_CONF_OK
) {

271 *
cf
 = 
pcf
;

272  
rv
;

280 i‡(
	`ngx_πmp_öô_evíts
(
cf
, 
cmcf
Ë!
NGX_OK
) {

281  
NGX_CONF_ERROR
;

284 
m
 = 0; 
ngx_moduÀs
[m]; m++) {

285 i‡(
ngx_moduÀs
[
m
]->
ty≥
 !
NGX_RTMP_MODULE
) {

289 
moduÀ
 = 
ngx_moduÀs
[
m
]->
˘x
;

291 i‡(
moduÀ
->
po°c⁄figuøti⁄
) {

292 i‡(
moduÀ
->
	`po°c⁄figuøti⁄
(
cf
Ë!
NGX_OK
) {

293  
NGX_CONF_ERROR
;

298 *
cf
 = 
pcf
;

300 i‡(
	`ngx_πmp_öô_evít_h™dÀrs
(
cf
, 
cmcf
Ë!
NGX_OK
) {

301  
NGX_CONF_ERROR
;

304 i‡(
	`ngx_¨øy_öô
(&
p‹ts
, 
cf
->
ãmp_poﬁ
, 4, (
ngx_πmp_c⁄f_p‹t_t
))

305 !
NGX_OK
)

307  
NGX_CONF_ERROR
;

310 
li°í
 = 
cmcf
->li°í.
ñts
;

312 
i
 = 0; i < 
cmcf
->
li°í
.
√…s
; i++) {

313 i‡(
	`ngx_πmp_add_p‹ts
(
cf
, &
p‹ts
, &
li°í
[
i
]Ë!
NGX_OK
) {

314  
NGX_CONF_ERROR
;

318  
	`ngx_πmp_›timize_£rvîs
(
cf
, &
p‹ts
);

319 
	}
}

323 
	$ngx_πmp_mîge_≠∂iˇti⁄s
(
ngx_c⁄f_t
 *
cf
, 
ngx_¨øy_t
 *
≠∂iˇti⁄s
,

324 **
≠p_c⁄f
, 
ngx_πmp_moduÀ_t
 *
moduÀ
, 
ngx_uöt_t
 
˘x_ödex
)

326 *
rv
;

327 
ngx_πmp_c⁄f_˘x_t
 *
˘x
, 
ßved
;

328 
ngx_πmp_c‹e_≠p_c⁄f_t
 **
ˇcÂ
;

329 
ngx_uöt_t
 
n
;

330 
ngx_πmp_c‹e_≠p_c⁄f_t
 *
ˇcf
;

332 i‡(
≠∂iˇti⁄s
 =
NULL
) {

333  
NGX_CONF_OK
;

336 
˘x
 = (
ngx_πmp_c⁄f_˘x_t
 *Ë
cf
->ctx;

337 
ßved
 = *
˘x
;

339 
ˇcÂ
 = 
≠∂iˇti⁄s
->
ñts
;

340 
n
 = 0;Ç < 
≠∂iˇti⁄s
->
√…s
; ++n, ++
ˇcÂ
) {

342 
˘x
->
≠p_c⁄f
 = (*
ˇcÂ
)->app_conf;

344 
rv
 = 
moduÀ
->
	`mîge_≠p_c⁄f
(
cf
, 
≠p_c⁄f
[
˘x_ödex
],

345 (*
ˇcÂ
)->
≠p_c⁄f
[
˘x_ödex
]);

346 i‡(
rv
 !
NGX_CONF_OK
) {

347  
rv
;

350 
ˇcf
 = (*
ˇcÂ
)->
≠p_c⁄f
[
ngx_πmp_c‹e_moduÀ
.
˘x_ödex
];

351 
rv
 = 
	`ngx_πmp_mîge_≠∂iˇti⁄s
(
cf
, &
ˇcf
->
≠∂iˇti⁄s
,

352 (*
ˇcÂ
)->
≠p_c⁄f
,

353 
moduÀ
, 
˘x_ödex
);

354 i‡(
rv
 !
NGX_CONF_OK
) {

355  
rv
;

359 *
˘x
 = 
ßved
;

361  
NGX_CONF_OK
;

362 
	}
}

365 
ngx_öt_t


366 
	$ngx_πmp_öô_evíts
(
ngx_c⁄f_t
 *
cf
, 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
)

368 
size_t
 
n
;

370 
n
 = 0;Ç < 
NGX_RTMP_MAX_EVENT
; ++n) {

371 i‡(
	`ngx_¨øy_öô
(&
cmcf
->
evíts
[
n
], 
cf
->
poﬁ
, 1,

372 (
ngx_πmp_h™dÀr_±
)Ë!
NGX_OK
)

374  
NGX_ERROR
;

378 i‡(
	`ngx_¨øy_öô
(&
cmcf
->
amf
, 
cf
->
poﬁ
, 1,

379 (
ngx_πmp_amf_h™dÀr_t
)Ë!
NGX_OK
)

381  
NGX_ERROR
;

384  
NGX_OK
;

385 
	}
}

388 
ngx_öt_t


389 
	$ngx_πmp_öô_evít_h™dÀrs
(
ngx_c⁄f_t
 *
cf
, 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
)

391 
ngx_hash_öô_t
 
ˇŒs_hash
;

392 
ngx_πmp_h™dÀr_±
 *
eh
;

393 
ngx_πmp_amf_h™dÀr_t
 *
h
;

394 
ngx_hash_key_t
 *
ha
;

395 
size_t
 
n
, 
m
;

397 
size_t
 
pm_evíts
[] = {

398 
NGX_RTMP_MSG_CHUNK_SIZE
,

399 
NGX_RTMP_MSG_ABORT
,

400 
NGX_RTMP_MSG_ACK
,

401 
NGX_RTMP_MSG_ACK_SIZE
,

402 
NGX_RTMP_MSG_BANDWIDTH


405 
size_t
 
amf_evíts
[] = {

406 
NGX_RTMP_MSG_AMF_CMD
,

407 
NGX_RTMP_MSG_AMF_META
,

408 
NGX_RTMP_MSG_AMF_SHARED
,

409 
NGX_RTMP_MSG_AMF3_CMD
,

410 
NGX_RTMP_MSG_AMF3_META
,

411 
NGX_RTMP_MSG_AMF3_SHARED


415 
n
 = 0;Ç < (
pm_evíts
) / (pm_events[0]); ++n) {

416 
eh
 = 
	`ngx_¨øy_push
(&
cmcf
->
evíts
[
pm_evíts
[
n
]]);

417 *
eh
 = 
ngx_πmp_¥Ÿocﬁ_mesßge_h™dÀr
;

421 
n
 = 0;Ç < (
amf_evíts
) / (amf_events[0]); ++n) {

422 
eh
 = 
	`ngx_¨øy_push
(&
cmcf
->
evíts
[
amf_evíts
[
n
]]);

423 *
eh
 = 
ngx_πmp_amf_mesßge_h™dÀr
;

427 
eh
 = 
	`ngx_¨øy_push
(&
cmcf
->
evíts
[
NGX_RTMP_MSG_USER
]);

428 *
eh
 = 
ngx_πmp_u£r_mesßge_h™dÀr
;

431 
eh
 = 
	`ngx_¨øy_push
(&
cmcf
->
evíts
[
NGX_RTMP_MSG_AGGREGATE
]);

432 *
eh
 = 
ngx_πmp_aggªg©e_mesßge_h™dÀr
;

435 
	`ngx_¨øy_öô
(&
cmcf
->
amf_¨øys
, 
cf
->
poﬁ
, 1, (
ngx_hash_key_t
));

437 
h
 = 
cmcf
->
amf
.
ñts
;

438 
n
 = 0;Ç < 
cmcf
->
amf
.
√…s
; ++n, ++
h
) {

439 
ha
 = 
cmcf
->
amf_¨øys
.
ñts
;

440 
m
 = 0; m < 
cmcf
->
amf_¨øys
.
√…s
; ++m, ++
ha
) {

441 i‡(
h
->
«me
.
Àn
 =
ha
->
key
.len

442 && !
	`ngx_°∫cmp
(
h
->
«me
.
d©a
, 
ha
->
key
.d©a, ha->key.
Àn
))

447 i‡(
m
 =
cmcf
->
amf_¨øys
.
√…s
) {

448 
ha
 = 
	`ngx_¨øy_push
(&
cmcf
->
amf_¨øys
);

449 
ha
->
key
 = 
h
->
«me
;

450 
ha
->
key_hash
 = 
	`ngx_hash_key_lc
(ha->
key
.
d©a
, ha->key.
Àn
);

451 
ha
->
vÆue
 = 
	`ngx_¨øy_¸óã
(
cf
->
poﬁ
, 1,

452 (
ngx_πmp_h™dÀr_±
));

453 i‡(
ha
->
vÆue
 =
NULL
) {

454  
NGX_ERROR
;

458 
eh
 = 
	`ngx_¨øy_push
((
ngx_¨øy_t
*)
ha
->
vÆue
);

459 *
eh
 = 
h
->
h™dÀr
;

462 
ˇŒs_hash
.
hash
 = &
cmcf
->
amf_hash
;

463 
ˇŒs_hash
.
key
 = 
ngx_hash_key_lc
;

464 
ˇŒs_hash
.
max_size
 = 512;

465 
ˇŒs_hash
.
buckë_size
 = 
ngx_ˇchñöe_size
;

466 
ˇŒs_hash
.
«me
 = "amf_hash";

467 
ˇŒs_hash
.
poﬁ
 = 
cf
->pool;

468 
ˇŒs_hash
.
ãmp_poﬁ
 = 
NULL
;

470 i‡(
	`ngx_hash_öô
(&
ˇŒs_hash
, 
cmcf
->
amf_¨øys
.
ñts
, cmcf->amf_¨øys.
√…s
)

471 !
NGX_OK
)

473  
NGX_ERROR
;

476  
NGX_OK
;

477 
	}
}

480 
ngx_öt_t


481 
	$ngx_πmp_add_p‹ts
(
ngx_c⁄f_t
 *
cf
, 
ngx_¨øy_t
 *
p‹ts
,

482 
ngx_πmp_li°í_t
 *
li°í
)

484 
ö_p‹t_t
 
p
;

485 
ngx_uöt_t
 
i
;

486 
sockaddr
 *
ß
;

487 
sockaddr_ö
 *
sö
;

488 
ngx_πmp_c⁄f_p‹t_t
 *
p‹t
;

489 
ngx_πmp_c⁄f_addr_t
 *
addr
;

490 #i‡(
NGX_HAVE_INET6
)

491 
sockaddr_ö6
 *
sö6
;

494 
ß
 = (
sockaddr
 *Ë&
li°í
->sockaddr;

496 
ß
->
ß_Ámûy
) {

498 #i‡(
NGX_HAVE_INET6
)

499 
AF_INET6
:

500 
sö6
 = (
sockaddr_ö6
 *Ë
ß
;

501 
p
 = 
sö6
->
sö6_p‹t
;

506 
sö
 = (
sockaddr_ö
 *Ë
ß
;

507 
p
 = 
sö
->
sö_p‹t
;

511 
p‹t
 = 
p‹ts
->
ñts
;

512 
i
 = 0; i < 
p‹ts
->
√…s
; i++) {

513 i‡(
p
 =
p‹t
[
i
].p‹à&& 
ß
->
ß_Ámûy
 =p‹t[i].
Ámûy
) {

517 
p‹t
 = &p‹t[
i
];

518 
found
;

524 
p‹t
 = 
	`ngx_¨øy_push
(
p‹ts
);

525 i‡(
p‹t
 =
NULL
) {

526  
NGX_ERROR
;

529 
p‹t
->
Ámûy
 = 
ß
->
ß_Ámûy
;

530 
p‹t
->p‹à
p
;

532 i‡(
	`ngx_¨øy_öô
(&
p‹t
->
addrs
, 
cf
->
ãmp_poﬁ
, 2,

533 (
ngx_πmp_c⁄f_addr_t
))

534 !
NGX_OK
)

536  
NGX_ERROR
;

539 
found
:

541 
addr
 = 
	`ngx_¨øy_push
(&
p‹t
->
addrs
);

542 i‡(
addr
 =
NULL
) {

543  
NGX_ERROR
;

546 
addr
->
sockaddr
 = (sockadd∏*Ë&
li°í
->sockaddr;

547 
addr
->
sockÀn
 = 
li°í
->socklen;

548 
addr
->
˘x
 = 
li°í
->ctx;

549 
addr
->
böd
 = 
li°í
->bind;

550 
addr
->
wûdˇrd
 = 
li°í
->wildcard;

551 
addr
->
so_kì∑live
 = 
li°í
->so_keepalive;

552 
addr
->
¥oxy_¥Ÿocﬁ
 = 
li°í
->proxy_protocol;

553 #i‡(
NGX_HAVE_KEEPALIVE_TUNABLE
)

554 
addr
->
t˝_kìpidÀ
 = 
li°í
->tcp_keepidle;

555 
addr
->
t˝_kìpötvl
 = 
li°í
->tcp_keepintvl;

556 
addr
->
t˝_kìp˙t
 = 
li°í
->tcp_keepcnt;

558 #i‡(
NGX_HAVE_INET6
 && 
deföed
 
IPV6_V6ONLY
)

559 
addr
->
ùv6⁄ly
 = 
li°í
->ipv6only;

562  
NGX_OK
;

563 
	}
}

567 
	$ngx_πmp_›timize_£rvîs
(
ngx_c⁄f_t
 *
cf
, 
ngx_¨øy_t
 *
p‹ts
)

569 
ngx_uöt_t
 
i
, 
p
, 
œ°
, 
böd_wûdˇrd
;

570 
ngx_li°íög_t
 *
ls
;

571 
ngx_πmp_p‹t_t
 *
mp‹t
;

572 
ngx_πmp_c⁄f_p‹t_t
 *
p‹t
;

573 
ngx_πmp_c⁄f_addr_t
 *
addr
;

575 
p‹t
 = 
p‹ts
->
ñts
;

576 
p
 = 0;Ö < 
p‹ts
->
√…s
;Ö++) {

578 
	`ngx_s‹t
(
p‹t
[
p
].
addrs
.
ñts
, (
size_t
Ëp‹t[p].addrs.
√…s
,

579 (
ngx_πmp_c⁄f_addr_t
), 
ngx_πmp_cmp_c⁄f_addrs
);

581 
addr
 = 
p‹t
[
p
].
addrs
.
ñts
;

582 
œ°
 = 
p‹t
[
p
].
addrs
.
√…s
;

589 i‡(
addr
[
œ°
 - 1].
wûdˇrd
) {

590 
addr
[
œ°
 - 1].
böd
 = 1;

591 
böd_wûdˇrd
 = 1;

594 
böd_wûdˇrd
 = 0;

597 
i
 = 0;

599 
i
 < 
œ°
) {

601 i‡(
böd_wûdˇrd
 && !
addr
[
i
].
böd
) {

602 
i
++;

606 
ls
 = 
	`ngx_¸óã_li°íög
(
cf
, 
addr
[
i
].
sockaddr
,áddr[i].
sockÀn
);

607 i‡(
ls
 =
NULL
) {

608  
NGX_CONF_ERROR
;

611 
ls
->
addr_¡›
 = 1;

612 
ls
->
h™dÀr
 = 
ngx_πmp_öô_c⁄√˘i⁄
;

613 
ls
->
poﬁ_size
 = 4096;

616 
ls
->
logp
 = &
cf
->
cy˛e
->
√w_log
;

617 
ls
->
log
.
d©a
 = &ls->
addr_ãxt
;

618 
ls
->
log
.
h™dÀr
 = 
ngx_ac˚±_log_îr‹
;

620 
ls
->
kì∑live
 = 
addr
[
i
].
so_kì∑live
;

621 #i‡(
NGX_HAVE_KEEPALIVE_TUNABLE
)

622 
ls
->
kìpidÀ
 = 
addr
[
i
].
t˝_kìpidÀ
;

623 
ls
->
kìpötvl
 = 
addr
[
i
].
t˝_kìpötvl
;

624 
ls
->
kìp˙t
 = 
addr
[
i
].
t˝_kìp˙t
;

627 #i‡(
NGX_HAVE_INET6
 && 
deföed
 
IPV6_V6ONLY
)

628 
ls
->
ùv6⁄ly
 = 
addr
[
i
].ipv6only;

631 
mp‹t
 = 
	`ngx_∑Œoc
(
cf
->
poﬁ
, (
ngx_πmp_p‹t_t
));

632 i‡(
mp‹t
 =
NULL
) {

633  
NGX_CONF_ERROR
;

636 
ls
->
£rvîs
 = 
mp‹t
;

638 i‡(
i
 =
œ°
 - 1) {

639 
mp‹t
->
«ddrs
 = 
œ°
;

642 
mp‹t
->
«ddrs
 = 1;

643 
i
 = 0;

646 
ls
->
sockaddr
->
ß_Ámûy
) {

647 #i‡(
NGX_HAVE_INET6
)

648 
AF_INET6
:

649 i‡(
	`ngx_πmp_add_addrs6
(
cf
, 
mp‹t
, 
addr
Ë!
NGX_OK
) {

650  
NGX_CONF_ERROR
;

655 i‡(
	`ngx_πmp_add_addrs
(
cf
, 
mp‹t
, 
addr
Ë!
NGX_OK
) {

656  
NGX_CONF_ERROR
;

661 
addr
++;

662 
œ°
--;

666  
NGX_CONF_OK
;

667 
	}
}

670 
ngx_öt_t


671 
	$ngx_πmp_add_addrs
(
ngx_c⁄f_t
 *
cf
, 
ngx_πmp_p‹t_t
 *
mp‹t
,

672 
ngx_πmp_c⁄f_addr_t
 *
addr
)

674 
u_ch¨
 *
p
;

675 
size_t
 
Àn
;

676 
ngx_uöt_t
 
i
;

677 
ngx_πmp_ö_addr_t
 *
addrs
;

678 
sockaddr_ö
 *
sö
;

679 
u_ch¨
 
buf
[
NGX_SOCKADDR_STRLEN
];

681 
mp‹t
->
addrs
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
,

682 
mp‹t
->
«ddrs
 * (
ngx_πmp_ö_addr_t
));

683 i‡(
mp‹t
->
addrs
 =
NULL
) {

684  
NGX_ERROR
;

687 
addrs
 = 
mp‹t
->addrs;

689 
i
 = 0; i < 
mp‹t
->
«ddrs
; i++) {

691 
sö
 = (
sockaddr_ö
 *Ë
addr
[
i
].
sockaddr
;

692 
addrs
[
i
].
addr
 = 
sö
->
sö_addr
.
s_addr
;

694 
addrs
[
i
].
c⁄f
.
˘x
 = 
addr
[i].ctx;

696 
Àn
 = 
	`ngx_sock_¡›
(
addr
[
i
].
sockaddr
,

697 #i‡(
ngöx_vîsi⁄
 >= 1005003)

698 
addr
[
i
].
sockÀn
,

700 
buf
, 
NGX_SOCKADDR_STRLEN
, 1);

702 
p
 = 
	`ngx_≤Æloc
(
cf
->
poﬁ
, 
Àn
);

703 i‡(
p
 =
NULL
) {

704  
NGX_ERROR
;

707 
	`ngx_mem˝y
(
p
, 
buf
, 
Àn
);

709 
addrs
[
i
].
c⁄f
.
addr_ãxt
.
Àn
 =Üen;

710 
addrs
[
i
].
c⁄f
.
addr_ãxt
.
d©a
 = 
p
;

711 
addrs
[
i
].
c⁄f
.
¥oxy_¥Ÿocﬁ
 = 
addr
->proxy_protocol;

714  
NGX_OK
;

715 
	}
}

718 #i‡(
NGX_HAVE_INET6
)

720 
ngx_öt_t


721 
	$ngx_πmp_add_addrs6
(
ngx_c⁄f_t
 *
cf
, 
ngx_πmp_p‹t_t
 *
mp‹t
,

722 
ngx_πmp_c⁄f_addr_t
 *
addr
)

724 
u_ch¨
 *
p
;

725 
size_t
 
Àn
;

726 
ngx_uöt_t
 
i
;

727 
ngx_πmp_ö6_addr_t
 *
addrs6
;

728 
sockaddr_ö6
 *
sö6
;

729 
u_ch¨
 
buf
[
NGX_SOCKADDR_STRLEN
];

731 
mp‹t
->
addrs
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
,

732 
mp‹t
->
«ddrs
 * (
ngx_πmp_ö6_addr_t
));

733 i‡(
mp‹t
->
addrs
 =
NULL
) {

734  
NGX_ERROR
;

737 
addrs6
 = 
mp‹t
->
addrs
;

739 
i
 = 0; i < 
mp‹t
->
«ddrs
; i++) {

741 
sö6
 = (
sockaddr_ö6
 *Ë
addr
[
i
].
sockaddr
;

742 
addrs6
[
i
].
addr6
 = 
sö6
->
sö6_addr
;

744 
addrs6
[
i
].
c⁄f
.
˘x
 = 
addr
[i].ctx;

746 
Àn
 = 
	`ngx_sock_¡›
(
addr
[
i
].
sockaddr
,

747 #i‡(
ngöx_vîsi⁄
 >= 1005003)

748 
addr
[
i
].
sockÀn
,

750 
buf
, 
NGX_SOCKADDR_STRLEN
, 1);

752 
p
 = 
	`ngx_≤Æloc
(
cf
->
poﬁ
, 
Àn
);

753 i‡(
p
 =
NULL
) {

754  
NGX_ERROR
;

757 
	`ngx_mem˝y
(
p
, 
buf
, 
Àn
);

759 
addrs6
[
i
].
c⁄f
.
addr_ãxt
.
Àn
 =Üen;

760 
addrs6
[
i
].
c⁄f
.
addr_ãxt
.
d©a
 = 
p
;

761 
addrs6
[
i
].
c⁄f
.
¥oxy_¥Ÿocﬁ
 = 
addr
->proxy_protocol;

764  
NGX_OK
;

765 
	}
}

770 
ngx_öt_t


771 
	$ngx_πmp_cmp_c⁄f_addrs
(c⁄° *
⁄e
, c⁄° *
two
)

773 
ngx_πmp_c⁄f_addr_t
 *
fú°
, *
£c⁄d
;

775 
fú°
 = (
ngx_πmp_c⁄f_addr_t
 *Ë
⁄e
;

776 
£c⁄d
 = (
ngx_πmp_c⁄f_addr_t
 *Ë
two
;

778 i‡(
fú°
->
wûdˇrd
) {

783 i‡(
fú°
->
böd
 && !
£c⁄d
->bind) {

788 i‡(!
fú°
->
böd
 && 
£c⁄d
->bind) {

796 
	}
}

799 
ngx_öt_t


800 
	$ngx_πmp_fúe_evít
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_uöt_t
 
evt
,

801 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
)

803 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
;

804 
ngx_¨øy_t
 *
ch
;

805 
ngx_πmp_h™dÀr_±
 *
hh
;

806 
size_t
 
n
;

808 
cmcf
 = 
	`ngx_πmp_gë_moduÀ_maö_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

810 
ch
 = &
cmcf
->
evíts
[
evt
];

811 
hh
 = 
ch
->
ñts
;

812 
n
 = 0;Ç < 
ch
->
√…s
; ++n, ++
hh
) {

813 i‡(*
hh
 && (*hh)(
s
, 
h
, 
ö
Ë!
NGX_OK
) {

814  
NGX_ERROR
;

817  
NGX_OK
;

818 
	}
}

822 
	$ngx_πmp_rmem˝y
(*
d°
, c⁄° * 
§c
, 
size_t
 
n
)

824 
u_ch¨
 *
d
, *
s
;

826 
d
 = 
d°
;

827 
s
 = (
u_ch¨
*)
§c
 + 
n
 - 1;

829 
s
 >(
u_ch¨
*)
§c
) {

830 *
d
++ = *
s
--;

833  
d°
;

834 
	}
}

837 
ngx_öt_t


838 
	$ngx_πmp_öô_¥o˚ss
(
ngx_cy˛e_t
 *
cy˛e
)

840 #i‡(
ngöx_vîsi⁄
 >= 1007005)

841 
	`ngx_queue_öô
(&
ngx_πmp_öô_queue
);

843  
NGX_OK
;

844 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp.h

7 #i‚de‡
_NGX_RTMP_H_INCLUDED_


8 
	#_NGX_RTMP_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

13 
	~<ngx_evít.h
>

14 
	~<ngx_evít_c⁄√˘.h
>

15 
	~<ngöx.h
>

17 
	~"ngx_πmp_amf.h
"

18 
	~"ngx_πmp_b™dwidth.h
"

21 #i‡(
NGX_WIN32
)

22 
__öt8
 
	töt8_t
;

23 
	t__öt8
 
	tuöt8_t
;

28 **
	mmaö_c⁄f
;

29 **
	m§v_c⁄f
;

30 **
	m≠p_c⁄f
;

31 } 
	tngx_πmp_c⁄f_˘x_t
;

35 
u_ch¨
 
	msockaddr
[
NGX_SOCKADDRLEN
];

36 
sockÀn_t
 
	msockÀn
;

39 
ngx_πmp_c⁄f_˘x_t
 *
	m˘x
;

41 
	mböd
:1;

42 
	mwûdˇrd
:1;

43 #i‡(
NGX_HAVE_INET6
 && 
deföed
 
IPV6_V6ONLY
)

44 
	mùv6⁄ly
:2;

46 
	mso_kì∑live
:2;

47 
	m¥oxy_¥Ÿocﬁ
:1;

48 #i‡(
NGX_HAVE_KEEPALIVE_TUNABLE
)

49 
	mt˝_kìpidÀ
;

50 
	mt˝_kìpötvl
;

51 
	mt˝_kìp˙t
;

53 } 
	tngx_πmp_li°í_t
;

57 
ngx_πmp_c⁄f_˘x_t
 *
	m˘x
;

58 
ngx_°r_t
 
	maddr_ãxt
;

59 
	m¥oxy_¥Ÿocﬁ
:1;

60 } 
	tngx_πmp_addr_c⁄f_t
;

63 
ö_addr_t
 
	maddr
;

64 
ngx_πmp_addr_c⁄f_t
 
	mc⁄f
;

65 } 
	tngx_πmp_ö_addr_t
;

68 #i‡(
NGX_HAVE_INET6
)

71 
ö6_addr
 
	maddr6
;

72 
ngx_πmp_addr_c⁄f_t
 
	mc⁄f
;

73 } 
	tngx_πmp_ö6_addr_t
;

79 *
	maddrs
;

80 
ngx_uöt_t
 
	m«ddrs
;

81 } 
	tngx_πmp_p‹t_t
;

85 
	mÁmûy
;

86 
ö_p‹t_t
 
	mp‹t
;

87 
ngx_¨øy_t
 
	maddrs
;

88 } 
	tngx_πmp_c⁄f_p‹t_t
;

92 
sockaddr
 *
	msockaddr
;

93 
sockÀn_t
 
	msockÀn
;

95 
ngx_πmp_c⁄f_˘x_t
 *
	m˘x
;

97 
	mböd
:1;

98 
	mwûdˇrd
:1;

99 #i‡(
NGX_HAVE_INET6
 && 
deföed
 
IPV6_V6ONLY
)

100 
	mùv6⁄ly
:2;

102 
	mso_kì∑live
:2;

103 
	m¥oxy_¥Ÿocﬁ
:1;

104 #i‡(
NGX_HAVE_KEEPALIVE_TUNABLE
)

105 
	mt˝_kìpidÀ
;

106 
	mt˝_kìpötvl
;

107 
	mt˝_kìp˙t
;

109 } 
	tngx_πmp_c⁄f_addr_t
;

112 
	#NGX_RTMP_VERSION
 3

	)

114 
	#NGX_LOG_DEBUG_RTMP
 
NGX_LOG_DEBUG_CORE


	)

116 
	#NGX_RTMP_DEFAULT_CHUNK_SIZE
 128

	)

120 
	#NGX_RTMP_MSG_CHUNK_SIZE
 1

	)

121 
	#NGX_RTMP_MSG_ABORT
 2

	)

122 
	#NGX_RTMP_MSG_ACK
 3

	)

123 
	#NGX_RTMP_MSG_USER
 4

	)

124 
	#NGX_RTMP_MSG_ACK_SIZE
 5

	)

125 
	#NGX_RTMP_MSG_BANDWIDTH
 6

	)

126 
	#NGX_RTMP_MSG_EDGE
 7

	)

127 
	#NGX_RTMP_MSG_AUDIO
 8

	)

128 
	#NGX_RTMP_MSG_VIDEO
 9

	)

129 
	#NGX_RTMP_MSG_AMF3_META
 15

	)

130 
	#NGX_RTMP_MSG_AMF3_SHARED
 16

	)

131 
	#NGX_RTMP_MSG_AMF3_CMD
 17

	)

132 
	#NGX_RTMP_MSG_AMF_META
 18

	)

133 
	#NGX_RTMP_MSG_AMF_SHARED
 19

	)

134 
	#NGX_RTMP_MSG_AMF_CMD
 20

	)

135 
	#NGX_RTMP_MSG_AGGREGATE
 22

	)

136 
	#NGX_RTMP_MSG_MAX
 22

	)

138 
	#NGX_RTMP_CONNECT
 
NGX_RTMP_MSG_MAX
 + 1

	)

139 
	#NGX_RTMP_DISCONNECT
 
NGX_RTMP_MSG_MAX
 + 2

	)

140 
	#NGX_RTMP_HANDSHAKE_DONE
 
NGX_RTMP_MSG_MAX
 + 3

	)

141 
	#NGX_RTMP_MAX_EVENT
 
NGX_RTMP_MSG_MAX
 + 4

	)

145 
	#NGX_RTMP_USER_STREAM_BEGIN
 0

	)

146 
	#NGX_RTMP_USER_STREAM_EOF
 1

	)

147 
	#NGX_RTMP_USER_STREAM_DRY
 2

	)

148 
	#NGX_RTMP_USER_SET_BUFLEN
 3

	)

149 
	#NGX_RTMP_USER_RECORDED
 4

	)

150 
	#NGX_RTMP_USER_PING_REQUEST
 6

	)

151 
	#NGX_RTMP_USER_PING_RESPONSE
 7

	)

152 
	#NGX_RTMP_USER_UNKNOWN
 8

	)

153 
	#NGX_RTMP_USER_BUFFER_END
 31

	)

160 
	#NGX_RTMP_MAX_CHUNK_HEADER
 18

	)

164 
uöt32_t
 
	mcsid
;

165 
uöt32_t
 
	mtime°amp
;

166 
uöt32_t
 
	mmÀn
;

167 
uöt8_t
 
	mty≥
;

168 
uöt32_t
 
	mmsid
;

169 } 
	tngx_πmp_hódî_t
;

173 
ngx_πmp_hódî_t
 
	mhdr
;

174 
uöt32_t
 
	mdtime
;

175 
uöt32_t
 
	mÀn
;

176 
uöt8_t
 
	mext
;

177 
ngx_chaö_t
 *
	mö
;

178 } 
	tngx_πmp_°ªam_t
;

183 #i‡(
NGX_WIN32
)

184 #¥agm®
w¨nög
(
push
)

185 #¥agm®
w¨nög
(
dißbÀ
:4200)

190 
uöt32_t
 
	msig«tuª
;

192 
ngx_evít_t
 
	m˛o£
;

194 **
	m˘x
;

195 **
	mmaö_c⁄f
;

196 **
	m§v_c⁄f
;

197 **
	m≠p_c⁄f
;

199 
ngx_°r_t
 *
	maddr_ãxt
;

200 
	mc⁄√˘ed
;

202 #i‡(
ngöx_vîsi⁄
 >= 1007005)

203 
ngx_queue_t
 
	mpo°ed_dry_evíts
;

205 
ngx_evít_t
 *
	mpo°ed_dry_evíts
;

209 
uöt32_t
 
	mbuÊí
;

210 
uöt32_t
 
	mack_size
;

213 
ngx_°r_t
 
	m≠p
;

214 
ngx_°r_t
 
	m¨gs
;

215 
ngx_°r_t
 
	mÊashvî
;

216 
ngx_°r_t
 
	mswf_uæ
;

217 
ngx_°r_t
 
	mtc_uæ
;

218 
uöt32_t
 
	macodecs
;

219 
uöt32_t
 
	mvcodecs
;

220 
ngx_°r_t
 
	m∑ge_uæ
;

223 
ngx_buf_t
 *
	mhs_buf
;

224 
u_ch¨
 *
	mhs_dige°
;

225 
	mhs_ﬁd
:1;

226 
ngx_uöt_t
 
	mhs_°age
;

229 
ngx_m£c_t
 
	mïoch
;

230 
ngx_m£c_t
 
	m≥î_ïoch
;

231 
ngx_m£c_t
 
	mba£_time
;

232 
uöt32_t
 
	mcuºít_time
;

235 
ngx_evít_t
 
	mpög_evt
;

236 
	mpög_a˘ive
:1;

237 
	mpög_ª£t
:1;

240 
	mauto_pushed
:1;

241 
	mªœy
:1;

242 
	m°©ic_ªœy
:1;

247 
ngx_πmp_°ªam_t
 *
	mö_°ªams
;

248 
uöt32_t
 
	mö_csid
;

249 
ngx_uöt_t
 
	mö_chunk_size
;

250 
ngx_poﬁ_t
 *
	mö_poﬁ
;

251 
uöt32_t
 
	mö_byãs
;

252 
uöt32_t
 
	mö_œ°_ack
;

254 
ngx_poﬁ_t
 *
	mö_ﬁd_poﬁ
;

255 
ngx_öt_t
 
	mö_chunk_size_ch™gög
;

257 
ngx_c⁄√˘i⁄_t
 *
	mc⁄√˘i⁄
;

260 
ngx_m£c_t
 
	mtimeout
;

261 
uöt32_t
 
	mout_byãs
;

262 
size_t
 
	mout_pos
, 
	mout_œ°
;

263 
ngx_chaö_t
 *
	mout_chaö
;

264 
u_ch¨
 *
	mout_bpos
;

265 
	mout_buf„r
:1;

266 
size_t
 
	mout_queue
;

267 
size_t
 
	mout_c‹k
;

268 
ngx_chaö_t
 *
	mout
[0];

269 } 
	tngx_πmp_£ssi⁄_t
;

272 #i‡(
NGX_WIN32
)

273 #¥agm®
w¨nög
(
p›
)

282 
	$ngx_öt_t
 (*
	tngx_πmp_h™dÀr_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

283 
	tngx_πmp_hódî_t
 *
	th
, 
	tngx_chaö_t
 *
	tö
);

287 
ngx_°r_t
 
«me
;

288 
ngx_πmp_h™dÀr_±
 
h™dÀr
;

289 } 
	tngx_πmp_amf_h™dÀr_t
;

293 
ngx_¨øy_t
 
£rvîs
;

294 
ngx_¨øy_t
 
li°í
;

296 
ngx_¨øy_t
 
evíts
[
NGX_RTMP_MAX_EVENT
];

298 
ngx_hash_t
 
amf_hash
;

299 
ngx_¨øy_t
 
amf_¨øys
;

300 
ngx_¨øy_t
 
amf
;

301 } 
	tngx_πmp_c‹e_maö_c⁄f_t
;

305 
ngx_πmp_c‹e_maö_c⁄f_t
 *
ngx_πmp_c‹e_maö_c⁄f
;

308 
	sngx_πmp_c‹e_§v_c⁄f_s
 {

309 
ngx_¨øy_t
 
≠∂iˇti⁄s
;

311 
ngx_m£c_t
 
timeout
;

312 
ngx_m£c_t
 
pög
;

313 
ngx_m£c_t
 
pög_timeout
;

314 
ngx_Êag_t
 
so_kì∑live
;

315 
ngx_öt_t
 
max_°ªams
;

317 
ngx_uöt_t
 
ack_wödow
;

319 
ngx_öt_t
 
chunk_size
;

320 
ngx_poﬁ_t
 *
poﬁ
;

321 
ngx_chaö_t
 *
‰ì
;

322 
ngx_chaö_t
 *
‰ì_hs
;

323 
size_t
 
max_mesßge
;

324 
ngx_Êag_t
 
∂ay_time_fix
;

325 
ngx_Êag_t
 
publish_time_fix
;

326 
ngx_Êag_t
 
busy
;

327 
size_t
 
out_queue
;

328 
size_t
 
out_c‹k
;

329 
ngx_m£c_t
 
buÊí
;

331 
ngx_πmp_c⁄f_˘x_t
 *
˘x
;

332 } 
	tngx_πmp_c‹e_§v_c⁄f_t
;

336 
ngx_¨øy_t
 
≠∂iˇti⁄s
;

337 
ngx_°r_t
 
«me
;

338 **
≠p_c⁄f
;

339 } 
	tngx_πmp_c‹e_≠p_c⁄f_t
;

343 
ngx_°r_t
 *
˛õ¡
;

344 
ngx_πmp_£ssi⁄_t
 *
£ssi⁄
;

345 } 
	tngx_πmp_îr‹_log_˘x_t
;

349 
	`ngx_öt_t
 (*
¥ec⁄figuøti⁄
)(
ngx_c⁄f_t
 *
cf
);

350 
	`ngx_öt_t
 (*
po°c⁄figuøti⁄
)(
ngx_c⁄f_t
 *
cf
);

352 *(*
¸óã_maö_c⁄f
)(
ngx_c⁄f_t
 *
cf
);

353 *(*
öô_maö_c⁄f
)(
ngx_c⁄f_t
 *
cf
, *
c⁄f
);

355 *(*
¸óã_§v_c⁄f
)(
ngx_c⁄f_t
 *
cf
);

356 *(*
mîge_§v_c⁄f
)(
ngx_c⁄f_t
 *
cf
, *
¥ev
,

357 *
c⁄f
);

359 *(*
¸óã_≠p_c⁄f
)(
ngx_c⁄f_t
 *
cf
);

360 *(*
mîge_≠p_c⁄f
)(
ngx_c⁄f_t
 *
cf
, *
¥ev
,

361 *
c⁄f
);

362 } 
	tngx_πmp_moduÀ_t
;

364 
	#NGX_RTMP_MODULE
 0x504D5452

	)

366 
	#NGX_RTMP_MAIN_CONF
 0x02000000

	)

367 
	#NGX_RTMP_SRV_CONF
 0x04000000

	)

368 
	#NGX_RTMP_APP_CONF
 0x08000000

	)

369 
	#NGX_RTMP_REC_CONF
 0x10000000

	)

372 
	#NGX_RTMP_MAIN_CONF_OFFSET
 
	`off£tof
(
ngx_πmp_c⁄f_˘x_t
, 
maö_c⁄f
)

	)

373 
	#NGX_RTMP_SRV_CONF_OFFSET
 
	`off£tof
(
ngx_πmp_c⁄f_˘x_t
, 
§v_c⁄f
)

	)

374 
	#NGX_RTMP_APP_CONF_OFFSET
 
	`off£tof
(
ngx_πmp_c⁄f_˘x_t
, 
≠p_c⁄f
)

	)

377 
	#ngx_πmp_gë_moduÀ_˘x
(
s
, 
moduÀ
Ë(s)->
˘x
[moduÀ.
˘x_ödex
]

	)

378 
	#ngx_πmp_£t_˘x
(
s
, 
c
, 
moduÀ
Ës->
˘x
[moduÀ.
˘x_ödex
] = c;

	)

379 
	#ngx_πmp_dñëe_˘x
(
s
, 
moduÀ
Ës->
˘x
[moduÀ.
˘x_ödex
] = 
NULL
;

	)

382 
	#ngx_πmp_gë_moduÀ_maö_c⁄f
(
s
, 
moduÀ
) \

383 (
s
)->
maö_c⁄f
[
moduÀ
.
˘x_ödex
]

	)

384 
	#ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
moduÀ
Ë(s)->
§v_c⁄f
[moduÀ.
˘x_ödex
]

	)

385 
	#ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
moduÀ
Ë((s)->
≠p_c⁄f
 ? \

386 (
s
)->
≠p_c⁄f
[
moduÀ
.
˘x_ödex
] : 
NULL
)

	)

388 
	#ngx_πmp_c⁄f_gë_moduÀ_maö_c⁄f
(
cf
, 
moduÀ
) \

389 ((
ngx_πmp_c⁄f_˘x_t
 *Ë
cf
->
˘x
)->
maö_c⁄f
[
moduÀ
.
˘x_ödex
]

	)

390 
	#ngx_πmp_c⁄f_gë_moduÀ_§v_c⁄f
(
cf
, 
moduÀ
) \

391 ((
ngx_πmp_c⁄f_˘x_t
 *Ë
cf
->
˘x
)->
§v_c⁄f
[
moduÀ
.
˘x_ödex
]

	)

392 
	#ngx_πmp_c⁄f_gë_moduÀ_≠p_c⁄f
(
cf
, 
moduÀ
) \

393 ((
ngx_πmp_c⁄f_˘x_t
 *Ë
cf
->
˘x
)->
≠p_c⁄f
[
moduÀ
.
˘x_ödex
]

	)

396 #ifde‡
NGX_DEBUG


397 * 
	`ngx_πmp_mesßge_ty≥
(
uöt8_t
 
ty≥
);

398 * 
	`ngx_πmp_u£r_mesßge_ty≥
(
uöt16_t
 
evt
);

401 
	`ngx_πmp_öô_c⁄√˘i⁄
(
ngx_c⁄√˘i⁄_t
 *
c
);

402 
ngx_πmp_£ssi⁄_t
 * 
	`ngx_πmp_öô_£ssi⁄
(
ngx_c⁄√˘i⁄_t
 *
c
,

403 
ngx_πmp_addr_c⁄f_t
 *
addr_c⁄f
);

404 
	`ngx_πmp_föÆize_£ssi⁄
(
ngx_πmp_£ssi⁄_t
 *
s
);

405 
	`ngx_πmp_h™dshake
(
ngx_πmp_£ssi⁄_t
 *
s
);

406 
	`ngx_πmp_˛õ¡_h™dshake
(
ngx_πmp_£ssi⁄_t
 *
s
, 
async
);

407 
	`ngx_πmp_‰ì_h™dshake_buf„rs
(
ngx_πmp_£ssi⁄_t
 *
s
);

408 
	`ngx_πmp_cy˛e
(
ngx_πmp_£ssi⁄_t
 *
s
);

409 
	`ngx_πmp_ª£t_pög
(
ngx_πmp_£ssi⁄_t
 *
s
);

410 
ngx_öt_t
 
	`ngx_πmp_fúe_evít
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_uöt_t
 
evt
,

411 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
);

414 
ngx_öt_t
 
	`ngx_πmp_£t_chunk_size
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_uöt_t
 
size
);

418 * 
	`ngx_πmp_rmem˝y
(*
d°
, c⁄° * 
§c
, 
size_t
 
n
);

420 
	#ngx_πmp_r˝ymem
(
d°
, 
§c
, 
n
) \

421 (((
u_ch¨
*)
	`ngx_πmp_rmem˝y
(
d°
, 
§c
, 
n
)Ë+ (n))

	)

424 
ngx_ölöe
 
uöt16_t


425 
	$ngx_πmp_r16
(
uöt16_t
 
n
)

427  (
n
 << 8) | (n >> 8);

428 
	}
}

431 
ngx_ölöe
 
uöt32_t


432 
	$ngx_πmp_r32
(
uöt32_t
 
n
)

434  (
n
 << 24) | ((n << 8) & 0xff0000) | ((n >> 8) & 0xff00) | (n >> 24);

435 
	}
}

438 
ngx_ölöe
 
uöt64_t


439 
	$ngx_πmp_r64
(
uöt64_t
 
n
)

441  (
uöt64_t
Ë
	`ngx_πmp_r32
((
uöt32_t
Ë
n
) << 32 |

442 
	`ngx_πmp_r32
((
uöt32_t
Ë(
n
 >> 32));

443 
	}
}

447 
ngx_öt_t
 
ngx_πmp_ª˚ive_mesßge
(
ngx_πmp_£ssi⁄_t
 *
s
,

448 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
);

449 
ngx_öt_t
 
ngx_πmp_¥Ÿocﬁ_mesßge_h™dÀr
(
ngx_πmp_£ssi⁄_t
 *
s
,

450 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
);

451 
ngx_öt_t
 
ngx_πmp_u£r_mesßge_h™dÀr
(
ngx_πmp_£ssi⁄_t
 *
s
,

452 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
);

453 
ngx_öt_t
 
ngx_πmp_aggªg©e_mesßge_h™dÀr
(
ngx_πmp_£ssi⁄_t
 *
s
,

454 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
);

455 
ngx_öt_t
 
ngx_πmp_amf_mesßge_h™dÀr
(
ngx_πmp_£ssi⁄_t
 *
s
,

456 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
);

457 
ngx_öt_t
 
ngx_πmp_amf_sh¨ed_obje˘_h™dÀr
(
ngx_πmp_£ssi⁄_t
 *
s
,

458 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
);

465 
	#NGX_RTMP_REFCOUNT_TYPE
 
uöt32_t


	)

466 
	#NGX_RTMP_REFCOUNT_BYTES
 (
NGX_RTMP_REFCOUNT_TYPE
)

	)

468 
	#ngx_πmp_ªf
(
b
) \

469 *((
NGX_RTMP_REFCOUNT_TYPE
*)(
b
Ë- 1)

	)

471 
	#ngx_πmp_ªf_£t
(
b
, 
v
) \

472 
	`ngx_πmp_ªf
(
b
Ë
v


	)

474 
	#ngx_πmp_ªf_gë
(
b
) \

475 ++
	`ngx_πmp_ªf
(
b
)

	)

477 
	#ngx_πmp_ªf_put
(
b
) \

478 --
	`ngx_πmp_ªf
(
b
)

	)

480 
ngx_chaö_t
 * 
ngx_πmp_Æloc_sh¨ed_buf
(
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
);

481 
ngx_πmp_‰ì_sh¨ed_chaö
(
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
,

482 
ngx_chaö_t
 *
ö
);

483 
ngx_chaö_t
 * 
ngx_πmp_≠≥nd_sh¨ed_bufs
(
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
,

484 
ngx_chaö_t
 *
hód
,Çgx_chaö_à*
ö
);

486 
	#ngx_πmp_acquúe_sh¨ed_chaö
(
ö
) \

487 
	`ngx_πmp_ªf_gë
(
ö
); \

488 

	)

491 
ngx_πmp_¥ï¨e_mesßge
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

492 
ngx_πmp_hódî_t
 *
lh
, 
ngx_chaö_t
 *
out
);

493 
ngx_öt_t
 
ngx_πmp_£nd_mesßge
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_chaö_t
 *
out
,

494 
ngx_uöt_t
 
¥i‹ôy
);

501 
	#NGX_RTMP_LIMIT_SOFT
 0

	)

502 
	#NGX_RTMP_LIMIT_HARD
 1

	)

503 
	#NGX_RTMP_LIMIT_DYNAMIC
 2

	)

506 
ngx_chaö_t
 * 
ngx_πmp_¸óã_chunk_size
(
ngx_πmp_£ssi⁄_t
 *
s
,

507 
uöt32_t
 
chunk_size
);

508 
ngx_chaö_t
 * 
ngx_πmp_¸óã_ab‹t
(
ngx_πmp_£ssi⁄_t
 *
s
,

509 
uöt32_t
 
csid
);

510 
ngx_chaö_t
 * 
ngx_πmp_¸óã_ack
(
ngx_πmp_£ssi⁄_t
 *
s
,

511 
uöt32_t
 
£q
);

512 
ngx_chaö_t
 * 
ngx_πmp_¸óã_ack_size
(
ngx_πmp_£ssi⁄_t
 *
s
,

513 
uöt32_t
 
ack_size
);

514 
ngx_chaö_t
 * 
ngx_πmp_¸óã_b™dwidth
(
ngx_πmp_£ssi⁄_t
 *
s
,

515 
uöt32_t
 
ack_size
, 
uöt8_t
 
limô_ty≥
);

517 
ngx_öt_t
 
ngx_πmp_£nd_chunk_size
(
ngx_πmp_£ssi⁄_t
 *
s
,

518 
uöt32_t
 
chunk_size
);

519 
ngx_öt_t
 
ngx_πmp_£nd_ab‹t
(
ngx_πmp_£ssi⁄_t
 *
s
,

520 
uöt32_t
 
csid
);

521 
ngx_öt_t
 
ngx_πmp_£nd_ack
(
ngx_πmp_£ssi⁄_t
 *
s
,

522 
uöt32_t
 
£q
);

523 
ngx_öt_t
 
ngx_πmp_£nd_ack_size
(
ngx_πmp_£ssi⁄_t
 *
s
,

524 
uöt32_t
 
ack_size
);

525 
ngx_öt_t
 
ngx_πmp_£nd_b™dwidth
(
ngx_πmp_£ssi⁄_t
 *
s
,

526 
uöt32_t
 
ack_size
, 
uöt8_t
 
limô_ty≥
);

529 
ngx_chaö_t
 * 
ngx_πmp_¸óã_°ªam_begö
(
ngx_πmp_£ssi⁄_t
 *
s
,

530 
uöt32_t
 
msid
);

531 
ngx_chaö_t
 * 
ngx_πmp_¸óã_°ªam_eof
(
ngx_πmp_£ssi⁄_t
 *
s
,

532 
uöt32_t
 
msid
);

533 
ngx_chaö_t
 * 
ngx_πmp_¸óã_°ªam_dry
(
ngx_πmp_£ssi⁄_t
 *
s
,

534 
uöt32_t
 
msid
);

535 
ngx_chaö_t
 * 
ngx_πmp_¸óã_£t_buÊí
(
ngx_πmp_£ssi⁄_t
 *
s
,

536 
uöt32_t
 
msid
, uöt32_à
buÊí_m£c
);

537 
ngx_chaö_t
 * 
ngx_πmp_¸óã_ªc‹ded
(
ngx_πmp_£ssi⁄_t
 *
s
,

538 
uöt32_t
 
msid
);

539 
ngx_chaö_t
 * 
ngx_πmp_¸óã_pög_ªque°
(
ngx_πmp_£ssi⁄_t
 *
s
,

540 
uöt32_t
 
time°amp
);

541 
ngx_chaö_t
 * 
ngx_πmp_¸óã_pög_ª•⁄£
(
ngx_πmp_£ssi⁄_t
 *
s
,

542 
uöt32_t
 
time°amp
);

544 
ngx_öt_t
 
ngx_πmp_£nd_°ªam_begö
(
ngx_πmp_£ssi⁄_t
 *
s
,

545 
uöt32_t
 
msid
);

546 
ngx_öt_t
 
ngx_πmp_£nd_°ªam_eof
(
ngx_πmp_£ssi⁄_t
 *
s
,

547 
uöt32_t
 
msid
);

548 
ngx_öt_t
 
ngx_πmp_£nd_°ªam_dry
(
ngx_πmp_£ssi⁄_t
 *
s
,

549 
uöt32_t
 
msid
);

550 
ngx_öt_t
 
ngx_πmp_£nd_£t_buÊí
(
ngx_πmp_£ssi⁄_t
 *
s
,

551 
uöt32_t
 
msid
, uöt32_à
buÊí_m£c
);

552 
ngx_öt_t
 
ngx_πmp_£nd_ªc‹ded
(
ngx_πmp_£ssi⁄_t
 *
s
,

553 
uöt32_t
 
msid
);

554 
ngx_öt_t
 
ngx_πmp_£nd_pög_ªque°
(
ngx_πmp_£ssi⁄_t
 *
s
,

555 
uöt32_t
 
time°amp
);

556 
ngx_öt_t
 
ngx_πmp_£nd_pög_ª•⁄£
(
ngx_πmp_£ssi⁄_t
 *
s
,

557 
uöt32_t
 
time°amp
);

560 
ngx_öt_t
 
ngx_πmp_≠≥nd_amf
(
ngx_πmp_£ssi⁄_t
 *
s
,

561 
ngx_chaö_t
 **
fú°
,Çgx_chaö_à**
œ°
,

562 
ngx_πmp_amf_ñt_t
 *
ñts
, 
size_t
 
√…s
);

563 
ngx_öt_t
 
ngx_πmp_ª˚ive_amf
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_chaö_t
 *
ö
,

564 
ngx_πmp_amf_ñt_t
 *
ñts
, 
size_t
 
√…s
);

566 
ngx_chaö_t
 * 
ngx_πmp_¸óã_amf
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

567 
ngx_πmp_amf_ñt_t
 *
ñts
, 
size_t
 
√…s
);

568 
ngx_öt_t
 
ngx_πmp_£nd_amf
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

569 
ngx_πmp_amf_ñt_t
 *
ñts
, 
size_t
 
√…s
);

572 
ngx_chaö_t
 * 
ngx_πmp_¸óã_°©us
(
ngx_πmp_£ssi⁄_t
 *
s
, *
code
,

573 * 
Àvñ
, *
desc
);

574 
ngx_chaö_t
 * 
ngx_πmp_¸óã_∂ay_°©us
(
ngx_πmp_£ssi⁄_t
 *
s
, *
code
,

575 * 
Àvñ
, 
ngx_uöt_t
 
duøti⁄
,Çgx_uöt_à
byãs
);

576 
ngx_chaö_t
 * 
ngx_πmp_¸óã_ßm∂e_ac˚ss
(
ngx_πmp_£ssi⁄_t
 *
s
);

578 
ngx_öt_t
 
ngx_πmp_£nd_°©us
(
ngx_πmp_£ssi⁄_t
 *
s
, *
code
,

579 * 
Àvñ
, *
desc
);

580 
ngx_öt_t
 
ngx_πmp_£nd_∂ay_°©us
(
ngx_πmp_£ssi⁄_t
 *
s
, *
code
,

581 * 
Àvñ
, 
ngx_uöt_t
 
duøti⁄
,Çgx_uöt_à
byãs
);

582 
ngx_öt_t
 
ngx_πmp_£nd_ßm∂e_ac˚ss
(
ngx_πmp_£ssi⁄_t
 *
s
);

586 
	#NGX_RTMP_VIDEO_KEY_FRAME
 1

	)

587 
	#NGX_RTMP_VIDEO_INTER_FRAME
 2

	)

588 
	#NGX_RTMP_VIDEO_DISPOSABLE_FRAME
 3

	)

591 
ngx_ölöe
 
ngx_öt_t


592 
	$ngx_πmp_gë_video_‰ame_ty≥
(
ngx_chaö_t
 *
ö
)

594  (
ö
->
buf
->
pos
[0] & 0xf0) >> 4;

595 
	}
}

598 
ngx_ölöe
 
ngx_öt_t


599 
	$ngx_πmp_is_codec_hódî
(
ngx_chaö_t
 *
ö
)

601  
ö
->
buf
->
pos
 + 1 < in->buf->
œ°
 && in->buf->pos[1] == 0;

602 
	}
}

605 
ngx_πmp_b™dwidth_t
 
ngx_πmp_bw_out
;

606 
ngx_πmp_b™dwidth_t
 
ngx_πmp_bw_ö
;

609 
ngx_uöt_t
 
ngx_πmp_«c˚±ed
;

610 #i‡(
ngöx_vîsi⁄
 >= 1007005)

611 
ngx_thªad_vﬁ©ûe
 
ngx_queue_t
 
ngx_πmp_öô_queue
;

613 
ngx_thªad_vﬁ©ûe
 
ngx_evít_t
 *
ngx_πmp_öô_queue
;

616 
ngx_uöt_t
 
ngx_πmp_max_moduÀ
;

617 
ngx_moduÀ_t
 
ngx_πmp_c‹e_moduÀ
;

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_access_module.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp.h
"

10 
	~"ngx_πmp_cmd_moduÀ.h
"

13 
ngx_πmp_publish_±
 
	g√xt_publish
;

14 
ngx_πmp_∂ay_±
 
	g√xt_∂ay
;

17 
	#NGX_RTMP_ACCESS_PUBLISH
 0x01

	)

18 
	#NGX_RTMP_ACCESS_PLAY
 0x02

	)

21 * 
ngx_πmp_ac˚ss_ruÀ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
,

22 *
c⁄f
);

23 
ngx_öt_t
 
ngx_πmp_ac˚ss_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
);

24 * 
ngx_πmp_ac˚ss_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
);

25 * 
ngx_πmp_ac˚ss_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
,

26 *
∑ª¡
, *
chûd
);

30 
ö_addr_t
 
	mmask
;

31 
ö_addr_t
 
	maddr
;

32 
ngx_uöt_t
 
	mdíy
;

33 
ngx_uöt_t
 
	mÊags
;

34 } 
	tngx_πmp_ac˚ss_ruÀ_t
;

37 #i‡(
NGX_HAVE_INET6
)

40 
ö6_addr
 
	maddr
;

41 
ö6_addr
 
	mmask
;

42 
ngx_uöt_t
 
	mdíy
;

43 
ngx_uöt_t
 
	mÊags
;

44 } 
	tngx_πmp_ac˚ss_ruÀ6_t
;

50 
ngx_¨øy_t
 
	mruÀs
;

51 #i‡(
NGX_HAVE_INET6
)

52 
ngx_¨øy_t
 
	mruÀs6
;

54 } 
	tngx_πmp_ac˚ss_≠p_c⁄f_t
;

57 
ngx_comm™d_t
 
	gngx_πmp_ac˚ss_comm™ds
[] = {

59 { 
ngx_°rög
("allow"),

60 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE12
,

61 
ngx_πmp_ac˚ss_ruÀ
,

62 
NGX_RTMP_APP_CONF_OFFSET
,

64 
NULL
 },

66 { 
ngx_°rög
("deny"),

67 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE12
,

68 
ngx_πmp_ac˚ss_ruÀ
,

69 
NGX_RTMP_APP_CONF_OFFSET
,

71 
NULL
 },

73 
ngx_nuŒ_comm™d


77 
ngx_πmp_moduÀ_t
 
	gngx_πmp_ac˚ss_moduÀ_˘x
 = {

78 
NULL
,

79 
ngx_πmp_ac˚ss_po°c⁄figuøti⁄
,

80 
NULL
,

81 
NULL
,

82 
NULL
,

83 
NULL
,

84 
ngx_πmp_ac˚ss_¸óã_≠p_c⁄f
,

85 
ngx_πmp_ac˚ss_mîge_≠p_c⁄f
,

89 
ngx_moduÀ_t
 
	gngx_πmp_ac˚ss_moduÀ
 = {

90 
NGX_MODULE_V1
,

91 &
ngx_πmp_ac˚ss_moduÀ_˘x
,

92 
ngx_πmp_ac˚ss_comm™ds
,

93 
NGX_RTMP_MODULE
,

94 
NULL
,

95 
NULL
,

96 
NULL
,

97 
NULL
,

98 
NULL
,

99 
NULL
,

100 
NULL
,

101 
NGX_MODULE_V1_PADDING


106 
	$ngx_πmp_ac˚ss_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
)

108 
ngx_πmp_ac˚ss_≠p_c⁄f_t
 *
Øcf
;

110 
Øcf
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_ac˚ss_≠p_c⁄f_t
));

111 i‡(
Øcf
 =
NULL
) {

112  
NULL
;

115 i‡(
	`ngx_¨øy_öô
(&
Øcf
->
ruÀs
, 
cf
->
poﬁ
, 1,

116 (
ngx_πmp_ac˚ss_ruÀ_t
))

117 !
NGX_OK
)

119  
NULL
;

122 #i‡(
NGX_HAVE_INET6
)

123 i‡(
	`ngx_¨øy_öô
(&
Øcf
->
ruÀs6
, 
cf
->
poﬁ
, 1,

124 (
ngx_πmp_ac˚ss_ruÀ6_t
))

125 !
NGX_OK
)

127  
NULL
;

131  
Øcf
;

132 
	}
}

135 
ngx_öt_t


136 
	$ngx_πmp_ac˚ss_mîge_ruÀs
(
ngx_¨øy_t
 *
¥ev
,Çgx_¨øy_à*
ruÀs
)

138 *
p
;

140 i‡(
¥ev
->
√…s
 == 0) {

141  
NGX_OK
;

144 i‡(
ruÀs
->
√…s
 == 0) {

145 *
ruÀs
 = *
¥ev
;

146  
NGX_OK
;

149 
p
 = 
	`ngx_¨øy_push_n
(
ruÀs
, 
¥ev
->
√…s
);

150 i‡(
p
 =
NULL
) {

151  
NGX_ERROR
;

154 
	`ngx_mem˝y
(
p
, 
¥ev
->
ñts
,Öªv->
size
 *Öªv->
√…s
);

156  
NGX_OK
;

157 
	}
}

161 
	$ngx_πmp_ac˚ss_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
∑ª¡
, *
chûd
)

163 
ngx_πmp_ac˚ss_≠p_c⁄f_t
 *
¥ev
 = 
∑ª¡
;

164 
ngx_πmp_ac˚ss_≠p_c⁄f_t
 *
c⁄f
 = 
chûd
;

166 i‡(
	`ngx_πmp_ac˚ss_mîge_ruÀs
(&
¥ev
->
ruÀs
, &
c⁄f
->ruÀsË!
NGX_OK
) {

167  
NGX_CONF_ERROR
;

170 #i‡(
NGX_HAVE_INET6
)

171 i‡(
	`ngx_πmp_ac˚ss_mîge_ruÀs
(&
¥ev
->
ruÀs6
, &
c⁄f
->ruÀs6Ë!
NGX_OK
) {

172  
NGX_CONF_ERROR
;

176  
NGX_CONF_OK
;

177 
	}
}

180 
ngx_öt_t


181 
	$ngx_πmp_ac˚ss_found
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_uöt_t
 
díy
)

183 i‡(
díy
) {

184 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

186  
NGX_ERROR
;

189  
NGX_OK
;

190 
	}
}

193 
ngx_öt_t


194 
	$ngx_πmp_ac˚ss_öë
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ö_addr_t
 
addr
, 
ngx_uöt_t
 
Êag
)

196 
ngx_uöt_t
 
i
;

197 
ngx_πmp_ac˚ss_ruÀ_t
 *
ruÀ
;

198 
ngx_πmp_ac˚ss_≠p_c⁄f_t
 *
ascf
;

200 
ascf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_ac˚ss_moduÀ
);

202 
ruÀ
 = 
ascf
->
ruÀs
.
ñts
;

203 
i
 = 0; i < 
ascf
->
ruÀs
.
√…s
; i++) {

205 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_HTTP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

207 
addr
, 
ruÀ
[
i
].
mask
,Ñule[i].addr);

209 i‡((
addr
 & 
ruÀ
[
i
].
mask
Ë=ruÀ[i].add∏&& (
Êag
 &ÑuÀ[i].
Êags
)) {

210  
	`ngx_πmp_ac˚ss_found
(
s
, 
ruÀ
[
i
].
díy
);

214  
NGX_OK
;

215 
	}
}

218 #i‡(
NGX_HAVE_INET6
)

220 
ngx_öt_t


221 
	$ngx_πmp_ac˚ss_öë6
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
p
, 
ngx_uöt_t
 
Êag
)

223 
ngx_uöt_t
 
n
;

224 
ngx_uöt_t
 
i
;

225 
ngx_πmp_ac˚ss_ruÀ6_t
 *
ruÀ6
;

226 
ngx_πmp_ac˚ss_≠p_c⁄f_t
 *
ascf
;

228 
ascf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_ac˚ss_moduÀ
);

230 
ruÀ6
 = 
ascf
->
ruÀs6
.
ñts
;

231 
i
 = 0; i < 
ascf
->
ruÀs6
.
√…s
; i++) {

233 #i‡(
NGX_DEBUG
)

235 
size_t
 
˛
, 
ml
, 
Æ
;

236 
u_ch¨
 
˘
[
NGX_INET6_ADDRSTRLEN
];

237 
u_ch¨
 
mt
[
NGX_INET6_ADDRSTRLEN
];

238 
u_ch¨
 
©
[
NGX_INET6_ADDRSTRLEN
];

240 
˛
 = 
	`ngx_öë6_¡›
(
p
, 
˘
, 
NGX_INET6_ADDRSTRLEN
);

241 
ml
 = 
	`ngx_öë6_¡›
(
ruÀ6
[
i
].
mask
.
s6_addr
, 
mt
, 
NGX_INET6_ADDRSTRLEN
);

242 
Æ
 = 
	`ngx_öë6_¡›
(
ruÀ6
[
i
].
addr
.
s6_addr
, 
©
, 
NGX_INET6_ADDRSTRLEN
);

244 
	`ngx_log_debug6
(
NGX_LOG_DEBUG_HTTP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

245 "ac˚ss: %*†%*†%*s", 
˛
, 
˘
, 
ml
, 
mt
, 
Æ
, 
©
);

249 
n
 = 0;Ç < 16;Ç++) {

250 i‡((
p
[
n
] & 
ruÀ6
[
i
].
mask
.
s6_addr
[n]Ë!ruÀ6[i].
addr
.s6_addr[n]) {

251 
√xt
;

255 i‡(
Êag
 & 
ruÀ6
[
i
].
Êags
) {

256  
	`ngx_πmp_ac˚ss_found
(
s
, 
ruÀ6
[
i
].
díy
);

259 
√xt
:

263  
NGX_OK
;

264 
	}
}

269 
ngx_öt_t


270 
	$ngx_πmp_ac˚ss
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_uöt_t
 
Êag
)

272 
sockaddr_ö
 *
sö
;

273 
ngx_πmp_ac˚ss_≠p_c⁄f_t
 *
ascf
;

274 #i‡(
NGX_HAVE_INET6
)

275 
u_ch¨
 *
p
;

276 
ö_addr_t
 
addr
;

277 
sockaddr_ö6
 *
sö6
;

280 
ascf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_ac˚ss_moduÀ
);

281 i‡(
ascf
 =
NULL
) {

282 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_HTTP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

284  
NGX_ERROR
;

288 i‡(
s
->
c⁄√˘i⁄
->
sockaddr
 =
NULL
) {

289  
NGX_OK
;

292 
s
->
c⁄√˘i⁄
->
sockaddr
->
ß_Ámûy
) {

294 
AF_INET
:

295 
sö
 = (
sockaddr_ö
 *Ë
s
->
c⁄√˘i⁄
->
sockaddr
;

296  
	`ngx_πmp_ac˚ss_öë
(
s
, 
sö
->
sö_addr
.
s_addr
, 
Êag
);

298 #i‡(
NGX_HAVE_INET6
)

300 
AF_INET6
:

301 
sö6
 = (
sockaddr_ö6
 *Ë
s
->
c⁄√˘i⁄
->
sockaddr
;

302 
p
 = 
sö6
->
sö6_addr
.
s6_addr
;

304 i‡(
	`IN6_IS_ADDR_V4MAPPED
(&
sö6
->
sö6_addr
)) {

305 
addr
 = 
p
[12] << 24;

306 
addr
 +
p
[13] << 16;

307 
addr
 +
p
[14] << 8;

308 
addr
 +
p
[15];

309  
	`ngx_πmp_ac˚ss_öë
(
s
, 
	`ht⁄l
(
addr
), 
Êag
);

312  
	`ngx_πmp_ac˚ss_öë6
(
s
, 
p
, 
Êag
);

317  
NGX_OK
;

318 
	}
}

322 
	$ngx_πmp_ac˚ss_ruÀ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

324 
ngx_πmp_ac˚ss_≠p_c⁄f_t
 *
ascf
 = 
c⁄f
;

326 
ngx_öt_t
 
rc
;

327 
ngx_uöt_t
 
Æl
;

328 
ngx_°r_t
 *
vÆue
;

329 
ngx_cidr_t
 
cidr
;

330 
ngx_πmp_ac˚ss_ruÀ_t
 *
ruÀ
;

331 #i‡(
NGX_HAVE_INET6
)

332 
ngx_πmp_ac˚ss_ruÀ6_t
 *
ruÀ6
;

334 
size_t
 
n
;

335 
ngx_uöt_t
 
Êags
;

337 
	`ngx_memzîo
(&
cidr
, (
ngx_cidr_t
));

339 
vÆue
 = 
cf
->
¨gs
->
ñts
;

341 
n
 = 1;

342 
Êags
 = 0;

344 i‡(
cf
->
¨gs
->
√…s
 == 2) {

346 
Êags
 = 
NGX_RTMP_ACCESS_PUBLISH
 | 
NGX_RTMP_ACCESS_PLAY
;

350 ; 
n
 < 
cf
->
¨gs
->
√…s
 - 1; ++n) {

352 i‡(
vÆue
[
n
].
Àn
 == ("publish") - 1 &&

353 
	`ngx_°rcmp
(
vÆue
[1].
d©a
, "publish") == 0)

355 
Êags
 |
NGX_RTMP_ACCESS_PUBLISH
;

360 i‡(
vÆue
[
n
].
Àn
 == ("play") - 1 &&

361 
	`ngx_°rcmp
(
vÆue
[1].
d©a
, "play") == 0)

363 
Êags
 |
NGX_RTMP_ACCESS_PLAY
;

368 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
cf
->
log
, 0,

369 "u√x≥˘edác˚s†•ecifõd: '%V'", &
vÆue
[
n
]);

370  
NGX_CONF_ERROR
;

374 
Æl
 = (
vÆue
[
n
].
Àn
 =3 && 
	`ngx_°rcmp
(vÆue[n].
d©a
, "all") == 0);

376 i‡(!
Æl
) {

378 
rc
 = 
	`ngx_±ocidr
(&
vÆue
[
n
], &
cidr
);

380 i‡(
rc
 =
NGX_ERROR
) {

381 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

382 "övÆidÖ¨amëî \"%V\"", &
vÆue
[1]);

383  
NGX_CONF_ERROR
;

386 i‡(
rc
 =
NGX_DONE
) {

387 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_WARN
, 
cf
, 0,

389 &
vÆue
[1]);

393 
cidr
.
Ámûy
) {

395 #i‡(
NGX_HAVE_INET6
)

396 
AF_INET6
:

399 
ruÀ6
 = 
	`ngx_¨øy_push
(&
ascf
->
ruÀs6
);

400 i‡(
ruÀ6
 =
NULL
) {

401  
NGX_CONF_ERROR
;

404 
ruÀ6
->
mask
 = 
cidr
.
u
.
ö6
.mask;

405 
ruÀ6
->
addr
 = 
cidr
.
u
.
ö6
.addr;

406 
ruÀ6
->
díy
 = (
vÆue
[0].
d©a
[0] == 'd') ? 1 : 0;

407 
ruÀ6
->
Êags
 = flags;

409 i‡(!
Æl
) {

418 
ruÀ
 = 
	`ngx_¨øy_push
(&
ascf
->
ruÀs
);

419 i‡(
ruÀ
 =
NULL
) {

420  
NGX_CONF_ERROR
;

423 
ruÀ
->
mask
 = 
cidr
.
u
.
ö
.mask;

424 
ruÀ
->
addr
 = 
cidr
.
u
.
ö
.addr;

425 
ruÀ
->
díy
 = (
vÆue
[0].
d©a
[0] == 'd') ? 1 : 0;

426 
ruÀ
->
Êags
 = flags;

429  
NGX_CONF_OK
;

430 
	}
}

433 
ngx_öt_t


434 
	$ngx_πmp_ac˚ss_publish
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_publish_t
 *
v
)

436 i‡(
s
->
auto_pushed
) {

437 
√xt
;

440 i‡(
	`ngx_πmp_ac˚ss
(
s
, 
NGX_RTMP_ACCESS_PUBLISH
Ë!
NGX_OK
) {

441  
NGX_ERROR
;

444 
√xt
:

445  
	`√xt_publish
(
s
, 
v
);

446 
	}
}

449 
ngx_öt_t


450 
	$ngx_πmp_ac˚ss_∂ay
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_∂ay_t
 *
v
)

452 i‡(
	`ngx_πmp_ac˚ss
(
s
, 
NGX_RTMP_ACCESS_PLAY
Ë!
NGX_OK
) {

453  
NGX_ERROR
;

456  
	`√xt_∂ay
(
s
, 
v
);

457 
	}
}

460 
ngx_öt_t


461 
	$ngx_πmp_ac˚ss_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
)

464 
√xt_publish
 = 
ngx_πmp_publish
;

465 
ngx_πmp_publish
 = 
ngx_πmp_ac˚ss_publish
;

467 
√xt_∂ay
 = 
ngx_πmp_∂ay
;

468 
ngx_πmp_∂ay
 = 
ngx_πmp_ac˚ss_∂ay
;

470  
NGX_OK
;

471 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_amf.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp_amf.h
"

10 
	~"ngx_πmp.h
"

11 
	~<°rög.h
>

14 
ngx_ölöe
 *

15 
	$ngx_πmp_amf_ªvî£_c›y
(*
d°
, * 
§c
, 
size_t
 
Àn
)

17 
size_t
 
k
;

19 i‡(
d°
 =
NULL
 || 
§c
 == NULL) {

20  
NULL
;

23 
k
 = 0; k < 
Àn
; ++k) {

24 ((
u_ch¨
*)
d°
)[
k
] = ((u_ch¨*)
§c
)[
Àn
 - 1 - k];

27  
d°
;

28 
	}
}

30 
	#NGX_RTMP_AMF_DEBUG_SIZE
 16

	)

32 #ifde‡
NGX_DEBUG


34 
	$ngx_πmp_amf_debug
(c⁄° * 
›
, 
ngx_log_t
 *
log
, 
u_ch¨
 *
p
, 
size_t
 
n
)

36 
u_ch¨
 
h°r
[3 * 
NGX_RTMP_AMF_DEBUG_SIZE
 + 1];

37 
u_ch¨
 
°r
[
NGX_RTMP_AMF_DEBUG_SIZE
 + 1];

38 
u_ch¨
 *
hp
, *
•
;

39 
u_ch¨
 
hex
[] = "0123456789ABCDEF";

40 
size_t
 
i
;

42 
hp
 = 
h°r
;

43 
•
 = 
°r
;

45 
i
 = 0; i < 
n
 && i < 
NGX_RTMP_AMF_DEBUG_SIZE
; ++i) {

46 *
hp
++ = ' ';

47 i‡(
p
) {

48 *
hp
++ = 
hex
[(*
p
 & 0xf0) >> 4];

49 *
hp
++ = 
hex
[*
p
 & 0x0f];

50 *
•
++ = (*
p
 >= 0x20 && *p <= 0x7e) ?

51 *
p
 : (
u_ch¨
)'?';

52 ++
p
;

54 *
hp
++ = 'X';

55 *
hp
++ = 'X';

56 *
•
++ = '?';

59 *
hp
 = *
•
 = '\0';

61 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_RTMP
, 
log
, 0,

62 "AMF %†(%d)%†'%s'", 
›
, 
n
, 
h°r
, 
°r
);

63 
	}
}

66 
ngx_öt_t


67 
	$ngx_πmp_amf_gë
(
ngx_πmp_amf_˘x_t
 *
˘x
, *
p
, 
size_t
 
n
)

69 
size_t
 
size
;

70 
ngx_chaö_t
 *
l
;

71 
size_t
 
off£t
;

72 
u_ch¨
 *
pos
, *
œ°
;

73 #ifde‡
NGX_DEBUG


74 *
›
 = 
p
;

75 
size_t
 
⁄
 = 
n
;

78 i‡(!
n
)

79  
NGX_OK
;

81 
l
 = 
˘x
->
lök
, 
off£t
 = ctx->off£t;Ü;Ü =Ü->
√xt
, offset = 0) {

83 
pos
 = 
l
->
buf
->po†+ 
off£t
;

84 
œ°
 = 
l
->
buf
->last;

86 i‡(
œ°
 >
pos
 + 
n
) {

87 i‡(
p
) {

88 
p
 = 
	`ngx_˝ymem
’, 
pos
, 
n
);

90 
˘x
->
off£t
 = off£à+ 
n
;

91 
˘x
->
lök
 = 
l
;

93 #ifde‡
NGX_DEBUG


94 
	`ngx_πmp_amf_debug
("ªad", 
˘x
->
log
, (
u_ch¨
*)
›
, 
⁄
);

97  
NGX_OK
;

100 
size
 = 
œ°
 - 
pos
;

102 i‡(
p
) {

103 
p
 = 
	`ngx_˝ymem
’, 
pos
, 
size
);

106 
n
 -
size
;

109 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
˘x
->
log
, 0,

110 "AMFÑódÉo‡(%d)", 
n
);

112  
NGX_DONE
;

113 
	}
}

116 
ngx_öt_t


117 
	$ngx_πmp_amf_put
(
ngx_πmp_amf_˘x_t
 *
˘x
, *
p
, 
size_t
 
n
)

119 
ngx_buf_t
 *
b
;

120 
size_t
 
size
;

121 
ngx_chaö_t
 *
l
, *
 
;

123 #ifde‡
NGX_DEBUG


124 
	`ngx_πmp_amf_debug
("wrôe", 
˘x
->
log
, (
u_ch¨
*)
p
, 
n
);

127 
l
 = 
˘x
->
lök
;

129 i‡(
˘x
->
lök
 && ctx->
fú°
 =
NULL
) {

130 
˘x
->
fú°
 = ctx->
lök
;

133 
n
) {

134 
b
 = 
l
 ?Ü->
buf
 : 
NULL
;

136 i‡(
b
 =
NULL
 || b->
œ°
 =b->
íd
) {

138 
 
 = 
˘x
->
	`Æloc
(˘x->
¨g
);

139 i‡(
 
 =
NULL
) {

140  
NGX_ERROR
;

143 i‡(
˘x
->
fú°
 =
NULL
) {

144 
˘x
->
fú°
 = 
 
;

147 i‡(
l
) {

148 
l
->
√xt
 = 
 
;

151 
l
 = 
 
;

152 
˘x
->
lök
 = 
l
;

153 
b
 = 
l
->
buf
;

156 
size
 = 
b
->
íd
 - b->
œ°
;

158 i‡(
size
 >
n
) {

159 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, 
p
, 
n
);

160  
NGX_OK
;

163 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, 
p
, 
size
);

164 
p
 = (
u_ch¨
*Ì + 
size
;

165 
n
 -
size
;

168  
NGX_OK
;

169 
	}
}

172 
ngx_öt_t


173 
	$ngx_πmp_amf_ªad_obje˘
(
ngx_πmp_amf_˘x_t
 *
˘x
, 
ngx_πmp_amf_ñt_t
 *
ñts
,

174 
size_t
 
√…s
)

176 
uöt8_t
 
ty≥
;

177 
uöt16_t
 
Àn
;

178 
size_t
 
n
, 
«mñí
, 
maxÀn
;

179 
ngx_öt_t
 
rc
;

180 
u_ch¨
 
buf
[2];

182 
maxÀn
 = 0;

183 
n
 = 0;Ç < 
√…s
; ++n) {

184 
«mñí
 = 
ñts
[
n
].
«me
.
Àn
;

185 i‡(
«mñí
 > 
maxÀn
)

186 
maxÀn
 = 
«mñí
;

191 #i‡!(
NGX_WIN32
)

192 
«me
[
maxÀn
];

194 
«me
[1024];

195 i‡(
maxÀn
 > (
«me
)) {

196  
NGX_ERROR
;

200 
	`ngx_πmp_amf_gë
(
˘x
, 
buf
, 2)) {

201 
NGX_DONE
:

203  
NGX_OK
;

204 
NGX_OK
:

207  
NGX_ERROR
;

210 
	`ngx_πmp_amf_ªvî£_c›y
(&
Àn
, 
buf
, 2);

212 i‡(!
Àn
)

215 i‡(
Àn
 <
maxÀn
) {

216 
rc
 = 
	`ngx_πmp_amf_gë
(
˘x
, 
«me
, 
Àn
);

219 
rc
 = 
	`ngx_πmp_amf_gë
(
˘x
, 
«me
, 
maxÀn
);

220 i‡(
rc
 !
NGX_OK
)

221  
NGX_ERROR
;

222 
rc
 = 
	`ngx_πmp_amf_gë
(
˘x
, 0, 
Àn
 - 
maxÀn
);

225 i‡(
rc
 !
NGX_OK
)

226  
NGX_ERROR
;

230 
n
 = 0;Ç < 
√…s


231 && (
Àn
 !
ñts
[
n
].
«me
.len

232 || 
	`ngx_°∫cmp
(
«me
, 
ñts
[
n
].«me.
d©a
, 
Àn
));

233 ++
n
);

235 i‡(
	`ngx_πmp_amf_ªad
(
˘x
, 
n
 < 
√…s
 ? &
ñts
[n] : 
NULL
, 1Ë!
NGX_OK
)

236  
NGX_ERROR
;

239 i‡(
	`ngx_πmp_amf_gë
(
˘x
, &
ty≥
, 1Ë!
NGX_OK


240 || 
ty≥
 !
NGX_RTMP_AMF_END
)

242  
NGX_ERROR
;

245  
NGX_OK
;

246 
	}
}

249 
ngx_öt_t


250 
	$ngx_πmp_amf_ªad_¨øy
(
ngx_πmp_amf_˘x_t
 *
˘x
, 
ngx_πmp_amf_ñt_t
 *
ñts
,

251 
size_t
 
√…s
)

253 
uöt32_t
 
Àn
;

254 
size_t
 
n
;

255 
u_ch¨
 
buf
[4];

258 i‡(
	`ngx_πmp_amf_gë
(
˘x
, 
buf
, 4Ë!
NGX_OK
)

259  
NGX_ERROR
;

261 
	`ngx_πmp_amf_ªvî£_c›y
(&
Àn
, 
buf
, 4);

263 
n
 = 0;Ç < 
Àn
; ++n) {

264 i‡(
	`ngx_πmp_amf_ªad
(
˘x
, 
n
 < 
√…s
 ? &
ñts
[n] : 
NULL
, 1Ë!
NGX_OK
)

265  
NGX_ERROR
;

268  
NGX_OK
;

269 
	}
}

272 
ngx_öt_t


273 
	$ngx_πmp_amf_ªad_v¨ü¡
(
ngx_πmp_amf_˘x_t
 *
˘x
, 
ngx_πmp_amf_ñt_t
 *
ñts
,

274 
size_t
 
√…s
)

276 
uöt8_t
 
ty≥
;

277 
ngx_öt_t
 
rc
;

278 
size_t
 
n
;

279 
ngx_πmp_amf_ñt_t
 
ñt
;

281 
rc
 = 
	`ngx_πmp_amf_gë
(
˘x
, &
ty≥
, 1);

282 i‡(
rc
 !
NGX_OK
) {

283  
rc
;

286 
	`ngx_memzîo
(&
ñt
, (elt));

287 
n
 = 0;Ç < 
√…s
; ++n, ++
ñts
) {

288 i‡(
ty≥
 =
ñts
->type) {

289 
ñt
.
d©a
 = 
ñts
->data;

290 
ñt
.
Àn
 = 
ñts
->len;

294 
ñt
.
ty≥
 =Åy≥ | 
NGX_RTMP_AMF_TYPELESS
;

296  
	`ngx_πmp_amf_ªad
(
˘x
, &
ñt
, 1);

297 
	}
}

300 
ngx_öt_t


301 
	$ngx_πmp_amf_is_com∑tibÀ_ty≥
(
uöt8_t
 
t1
, uöt8_à
t2
)

303  
t1
 =
t2


304 || (
t1
 =
NGX_RTMP_AMF_OBJECT
 && 
t2
 =
NGX_RTMP_AMF_MIXED_ARRAY
)

305 || (
t2
 =
NGX_RTMP_AMF_OBJECT
 && 
t1
 =
NGX_RTMP_AMF_MIXED_ARRAY
);

306 
	}
}

309 
ngx_öt_t


310 
	$ngx_πmp_amf_ªad
(
ngx_πmp_amf_˘x_t
 *
˘x
, 
ngx_πmp_amf_ñt_t
 *
ñts
,

311 
size_t
 
√…s
)

313 *
d©a
;

314 
ngx_öt_t
 
ty≥
;

315 
uöt8_t
 
ty≥8
;

316 
size_t
 
n
;

317 
uöt16_t
 
Àn
;

318 
ngx_öt_t
 
rc
;

319 
u_ch¨
 
buf
[8];

320 
uöt32_t
 
max_ödex
;

322 
n
 = 0;Ç < 
√…s
; ++n) {

324 i‡(
ñts
 &&É…s->
ty≥
 & 
NGX_RTMP_AMF_TYPELESS
) {

325 
ty≥
 = 
ñts
->ty≥ & ~
NGX_RTMP_AMF_TYPELESS
;

326 
d©a
 = 
ñts
->data;

329 
	`ngx_πmp_amf_gë
(
˘x
, &
ty≥8
, 1)) {

330 
NGX_DONE
:

331 i‡(
ñts
->
ty≥
 & 
NGX_RTMP_AMF_OPTIONAL
) {

332  
NGX_OK
;

334 
NGX_ERROR
:

335  
NGX_ERROR
;

337 
ty≥
 = 
ty≥8
;

338 
d©a
 = (
ñts
 &&

339 
	`ngx_πmp_amf_is_com∑tibÀ_ty≥
(

340 (
uöt8_t
Ë(
ñts
->
ty≥
 & 0xff), (uint8_t)Åype))

341 ? 
ñts
->
d©a


342 : 
NULL
;

344 i‡(
ñts
 && (ñts->
ty≥
 & 
NGX_RTMP_AMF_CONTEXT
)) {

345 i‡(
d©a
) {

346 *(
ngx_πmp_amf_˘x_t
 *Ë
d©a
 = *
˘x
;

348 
d©a
 = 
NULL
;

352 
ty≥
) {

353 
NGX_RTMP_AMF_NUMBER
:

354 i‡(
	`ngx_πmp_amf_gë
(
˘x
, 
buf
, 8Ë!
NGX_OK
) {

355  
NGX_ERROR
;

357 
	`ngx_πmp_amf_ªvî£_c›y
(
d©a
, 
buf
, 8);

360 
NGX_RTMP_AMF_BOOLEAN
:

361 i‡(
	`ngx_πmp_amf_gë
(
˘x
, 
d©a
, 1Ë!
NGX_OK
) {

362  
NGX_ERROR
;

366 
NGX_RTMP_AMF_STRING
:

367 i‡(
	`ngx_πmp_amf_gë
(
˘x
, 
buf
, 2Ë!
NGX_OK
) {

368  
NGX_ERROR
;

370 
	`ngx_πmp_amf_ªvî£_c›y
(&
Àn
, 
buf
, 2);

372 i‡(
d©a
 =
NULL
) {

373 
rc
 = 
	`ngx_πmp_amf_gë
(
˘x
, 
d©a
, 
Àn
);

375 } i‡(
ñts
->
Àn
 <=Üen) {

376 
rc
 = 
	`ngx_πmp_amf_gë
(
˘x
, 
d©a
, 
ñts
->
Àn
 - 1);

377 i‡(
rc
 !
NGX_OK
)

378  
NGX_ERROR
;

379 ((*)
d©a
)[
ñts
->
Àn
 - 1] = 0;

380 
rc
 = 
	`ngx_πmp_amf_gë
(
˘x
, 
NULL
, 
Àn
 - 
ñts
->len + 1);

383 
rc
 = 
	`ngx_πmp_amf_gë
(
˘x
, 
d©a
, 
Àn
);

384 ((*)
d©a
)[
Àn
] = 0;

387 i‡(
rc
 !
NGX_OK
) {

388  
NGX_ERROR
;

393 
NGX_RTMP_AMF_NULL
:

394 
NGX_RTMP_AMF_ARRAY_NULL
:

397 
NGX_RTMP_AMF_MIXED_ARRAY
:

398 i‡(
	`ngx_πmp_amf_gë
(
˘x
, &
max_ödex
, 4Ë!
NGX_OK
) {

399  
NGX_ERROR
;

402 
NGX_RTMP_AMF_OBJECT
:

403 i‡(
	`ngx_πmp_amf_ªad_obje˘
(
˘x
, 
d©a
,

404 
d©a
 && 
ñts
 ?É…s->
Àn
 / (
ngx_πmp_amf_ñt_t
) : 0

405 Ë!
NGX_OK
)

407  
NGX_ERROR
;

411 
NGX_RTMP_AMF_ARRAY
:

412 i‡(
	`ngx_πmp_amf_ªad_¨øy
(
˘x
, 
d©a
,

413 
d©a
 && 
ñts
 ?É…s->
Àn
 / (
ngx_πmp_amf_ñt_t
) : 0

414 Ë!
NGX_OK
)

416  
NGX_ERROR
;

420 
NGX_RTMP_AMF_VARIANT_
:

421 i‡(
	`ngx_πmp_amf_ªad_v¨ü¡
(
˘x
, 
d©a
,

422 
d©a
 && 
ñts
 ?É…s->
Àn
 / (
ngx_πmp_amf_ñt_t
) : 0

423 Ë!
NGX_OK
)

425  
NGX_ERROR
;

429 
NGX_RTMP_AMF_INT8
:

430 i‡(
	`ngx_πmp_amf_gë
(
˘x
, 
d©a
, 1Ë!
NGX_OK
) {

431  
NGX_ERROR
;

435 
NGX_RTMP_AMF_INT16
:

436 i‡(
	`ngx_πmp_amf_gë
(
˘x
, 
buf
, 2Ë!
NGX_OK
) {

437  
NGX_ERROR
;

439 
	`ngx_πmp_amf_ªvî£_c›y
(
d©a
, 
buf
, 2);

442 
NGX_RTMP_AMF_INT32
:

443 i‡(
	`ngx_πmp_amf_gë
(
˘x
, 
buf
, 4Ë!
NGX_OK
) {

444  
NGX_ERROR
;

446 
	`ngx_πmp_amf_ªvî£_c›y
(
d©a
, 
buf
, 4);

449 
NGX_RTMP_AMF_END
:

450  
NGX_OK
;

453  
NGX_ERROR
;

456 i‡(
ñts
) {

457 ++
ñts
;

461  
NGX_OK
;

462 
	}
}

465 
ngx_öt_t


466 
	$ngx_πmp_amf_wrôe_obje˘
(
ngx_πmp_amf_˘x_t
 *
˘x
,

467 
ngx_πmp_amf_ñt_t
 *
ñts
, 
size_t
 
√…s
)

469 
uöt16_t
 
Àn
;

470 
size_t
 
n
;

471 
u_ch¨
 
buf
[2];

473 
n
 = 0;Ç < 
√…s
; ++n) {

475 
Àn
 = (
uöt16_t
Ë
ñts
[
n
].
«me
.len;

477 i‡(
	`ngx_πmp_amf_put
(
˘x
,

478 
	`ngx_πmp_amf_ªvî£_c›y
(
buf
,

479 &
Àn
, 2), 2Ë!
NGX_OK
)

481  
NGX_ERROR
;

484 i‡(
	`ngx_πmp_amf_put
(
˘x
, 
ñts
[
n
].
«me
.
d©a
, 
Àn
Ë!
NGX_OK
) {

485  
NGX_ERROR
;

488 i‡(
	`ngx_πmp_amf_wrôe
(
˘x
, &
ñts
[
n
], 1Ë!
NGX_OK
) {

489  
NGX_ERROR
;

493 i‡(
	`ngx_πmp_amf_put
(
˘x
, "\0\0", 2Ë!
NGX_OK
) {

494  
NGX_ERROR
;

497  
NGX_OK
;

498 
	}
}

501 
ngx_öt_t


502 
	$ngx_πmp_amf_wrôe_¨øy
(
ngx_πmp_amf_˘x_t
 *
˘x
,

503 
ngx_πmp_amf_ñt_t
 *
ñts
, 
size_t
 
√…s
)

505 
uöt32_t
 
Àn
;

506 
size_t
 
n
;

507 
u_ch¨
 
buf
[4];

509 
Àn
 = 
√…s
;

510 i‡(
	`ngx_πmp_amf_put
(
˘x
,

511 
	`ngx_πmp_amf_ªvî£_c›y
(
buf
,

512 &
Àn
, 4), 4Ë!
NGX_OK
)

514  
NGX_ERROR
;

517 
n
 = 0;Ç < 
√…s
; ++n) {

518 i‡(
	`ngx_πmp_amf_wrôe
(
˘x
, &
ñts
[
n
], 1Ë!
NGX_OK
) {

519  
NGX_ERROR
;

523  
NGX_OK
;

524 
	}
}

527 
ngx_öt_t


528 
	$ngx_πmp_amf_wrôe
(
ngx_πmp_amf_˘x_t
 *
˘x
,

529 
ngx_πmp_amf_ñt_t
 *
ñts
, 
size_t
 
√…s
)

531 
size_t
 
n
;

532 
ngx_öt_t
 
ty≥
;

533 
uöt8_t
 
ty≥8
;

534 *
d©a
;

535 
uöt16_t
 
Àn
;

536 
uöt32_t
 
max_ödex
;

537 
u_ch¨
 
buf
[8];

539 
n
 = 0;Ç < 
√…s
; ++n) {

541 
ty≥
 = 
ñts
[
n
].type;

542 
d©a
 = 
ñts
[
n
].data;

543 
Àn
 = (
uöt16_t
Ë
ñts
[
n
].len;

545 i‡(
ty≥
 & 
NGX_RTMP_AMF_TYPELESS
) {

546 
ty≥
 &~
NGX_RTMP_AMF_TYPELESS
;

548 
ty≥8
 = (
uöt8_t
)
ty≥
;

549 i‡(
	`ngx_πmp_amf_put
(
˘x
, &
ty≥8
, 1Ë!
NGX_OK
)

550  
NGX_ERROR
;

553 
ty≥
) {

554 
NGX_RTMP_AMF_NUMBER
:

555 i‡(
	`ngx_πmp_amf_put
(
˘x
,

556 
	`ngx_πmp_amf_ªvî£_c›y
(
buf
,

557 
d©a
, 8), 8Ë!
NGX_OK
)

559  
NGX_ERROR
;

563 
NGX_RTMP_AMF_BOOLEAN
:

564 i‡(
	`ngx_πmp_amf_put
(
˘x
, 
d©a
, 1Ë!
NGX_OK
) {

565  
NGX_ERROR
;

569 
NGX_RTMP_AMF_STRING
:

570 i‡(
Àn
 =0 && 
d©a
) {

571 
Àn
 = (
uöt16_t
Ë
	`ngx_°æí
((
u_ch¨
*Ë
d©a
);

574 i‡(
	`ngx_πmp_amf_put
(
˘x
,

575 
	`ngx_πmp_amf_ªvî£_c›y
(
buf
,

576 &
Àn
, 2), 2Ë!
NGX_OK
)

578  
NGX_ERROR
;

581 i‡(
	`ngx_πmp_amf_put
(
˘x
, 
d©a
, 
Àn
Ë!
NGX_OK
) {

582  
NGX_ERROR
;

586 
NGX_RTMP_AMF_NULL
:

587 
NGX_RTMP_AMF_ARRAY_NULL
:

590 
NGX_RTMP_AMF_MIXED_ARRAY
:

591 
max_ödex
 = 0;

592 i‡(
	`ngx_πmp_amf_put
(
˘x
, &
max_ödex
, 4Ë!
NGX_OK
) {

593  
NGX_ERROR
;

596 
NGX_RTMP_AMF_OBJECT
:

597 
ty≥8
 = 
NGX_RTMP_AMF_END
;

598 i‡(
	`ngx_πmp_amf_wrôe_obje˘
(
˘x
, 
d©a
,

599 
ñts
[
n
].
Àn
 / (
ngx_πmp_amf_ñt_t
)Ë!
NGX_OK


600 || 
	`ngx_πmp_amf_put
(
˘x
, &
ty≥8
, 1Ë!
NGX_OK
)

602  
NGX_ERROR
;

606 
NGX_RTMP_AMF_ARRAY
:

607 i‡(
	`ngx_πmp_amf_wrôe_¨øy
(
˘x
, 
d©a
,

608 
ñts
[
n
].
Àn
 / (
ngx_πmp_amf_ñt_t
)Ë!
NGX_OK
)

610  
NGX_ERROR
;

614 
NGX_RTMP_AMF_INT8
:

615 i‡(
	`ngx_πmp_amf_put
(
˘x
, 
d©a
, 1Ë!
NGX_OK
) {

616  
NGX_ERROR
;

620 
NGX_RTMP_AMF_INT16
:

621 i‡(
	`ngx_πmp_amf_put
(
˘x
,

622 
	`ngx_πmp_amf_ªvî£_c›y
(
buf
,

623 
d©a
, 2), 2Ë!
NGX_OK
)

625  
NGX_ERROR
;

629 
NGX_RTMP_AMF_INT32
:

630 i‡(
	`ngx_πmp_amf_put
(
˘x
,

631 
	`ngx_πmp_amf_ªvî£_c›y
(
buf
,

632 
d©a
, 4), 4Ë!
NGX_OK
)

634  
NGX_ERROR
;

639  
NGX_ERROR
;

643  
NGX_OK
;

644 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_amf.h

7 #i‚de‡
_NGX_RTMP_AMF_H_INCLUDED_


8 
	#_NGX_RTMP_AMF_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

16 
	#NGX_RTMP_AMF_NUMBER
 0x00

	)

17 
	#NGX_RTMP_AMF_BOOLEAN
 0x01

	)

18 
	#NGX_RTMP_AMF_STRING
 0x02

	)

19 
	#NGX_RTMP_AMF_OBJECT
 0x03

	)

20 
	#NGX_RTMP_AMF_NULL
 0x05

	)

21 
	#NGX_RTMP_AMF_ARRAY_NULL
 0x06

	)

22 
	#NGX_RTMP_AMF_MIXED_ARRAY
 0x08

	)

23 
	#NGX_RTMP_AMF_END
 0x09

	)

24 
	#NGX_RTMP_AMF_ARRAY
 0x0a

	)

27 
	#NGX_RTMP_AMF_INT8
 0x0100

	)

28 
	#NGX_RTMP_AMF_INT16
 0x0101

	)

29 
	#NGX_RTMP_AMF_INT32
 0x0102

	)

30 
	#NGX_RTMP_AMF_VARIANT_
 0x0103

	)

33 
	#NGX_RTMP_AMF_OPTIONAL
 0x1000

	)

34 
	#NGX_RTMP_AMF_TYPELESS
 0x2000

	)

35 
	#NGX_RTMP_AMF_CONTEXT
 0x4000

	)

37 
	#NGX_RTMP_AMF_VARIANT
 (
NGX_RTMP_AMF_VARIANT_
\

38 |
NGX_RTMP_AMF_TYPELESS
)

	)

42 
ngx_öt_t
 
	mty≥
;

43 
ngx_°r_t
 
	m«me
;

44 *
	md©a
;

45 
size_t
 
	mÀn
;

46 } 
	tngx_πmp_amf_ñt_t
;

49 
	gngx_chaö_t
 * (*
	tngx_πmp_amf_Æloc_±
)(*
	t¨g
);

53 
ngx_chaö_t
 *
	mlök
, *
	mfú°
;

54 
size_t
 
	moff£t
;

55 
ngx_πmp_amf_Æloc_±
 
	mÆloc
;

56 *
	m¨g
;

57 
ngx_log_t
 *
	mlog
;

58 } 
	tngx_πmp_amf_˘x_t
;

62 
ngx_öt_t
 
ngx_πmp_amf_ªad
(
ngx_πmp_amf_˘x_t
 *
˘x
,

63 
ngx_πmp_amf_ñt_t
 *
ñts
, 
size_t
 
√…s
);

66 
ngx_öt_t
 
ngx_πmp_amf_wrôe
(
ngx_πmp_amf_˘x_t
 *
˘x
,

67 
ngx_πmp_amf_ñt_t
 *
ñts
, 
size_t
 
√…s
);

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_auto_push_module.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp_cmd_moduÀ.h
"

10 
	~"ngx_πmp_ªœy_moduÀ.h
"

13 
ngx_πmp_publish_±
 
	g√xt_publish
;

14 
ngx_πmp_dñëe_°ªam_±
 
	g√xt_dñëe_°ªam
;

17 
ngx_öt_t
 
ngx_πmp_auto_push_öô_¥o˚ss
(
ngx_cy˛e_t
 *
cy˛e
);

18 
ngx_πmp_auto_push_exô_¥o˚ss
(
ngx_cy˛e_t
 *
cy˛e
);

19 * 
ngx_πmp_auto_push_¸óã_c⁄f
(
ngx_cy˛e_t
 *
cf
);

20 * 
ngx_πmp_auto_push_öô_c⁄f
(
ngx_cy˛e_t
 *
cy˛e
, *
c⁄f
);

21 #i‡(
NGX_HAVE_UNIX_DOMAIN
)

22 
ngx_öt_t
 
ngx_πmp_auto_push_publish
(
ngx_πmp_£ssi⁄_t
 *
s
,

23 
ngx_πmp_publish_t
 *
v
);

24 
ngx_öt_t
 
ngx_πmp_auto_push_dñëe_°ªam
(
ngx_πmp_£ssi⁄_t
 *
s
,

25 
ngx_πmp_dñëe_°ªam_t
 *
v
);

29 
ngx_πmp_auto_push_˘x_s
 
	tngx_πmp_auto_push_˘x_t
;

31 
	sngx_πmp_auto_push_˘x_s
 {

32 
ngx_öt_t
 *
	m¶Ÿs
;

33 
u_ch¨
 
	m«me
[
NGX_RTMP_MAX_NAME
];

34 
u_ch¨
 
	m¨gs
[
NGX_RTMP_MAX_ARGS
];

35 
ngx_evít_t
 
	mpush_evt
;

40 
ngx_Êag_t
 
	mauto_push
;

41 
ngx_°r_t
 
	msockë_dú
;

42 
ngx_m£c_t
 
	mpush_ªc⁄√˘
;

43 } 
	tngx_πmp_auto_push_c⁄f_t
;

46 
ngx_comm™d_t
 
	gngx_πmp_auto_push_comm™ds
[] = {

48 { 
ngx_°rög
("rtmp_auto_push"),

49 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

50 
ngx_c⁄f_£t_Êag_¶Ÿ
,

52 
off£tof
(
ngx_πmp_auto_push_c⁄f_t
, 
auto_push
),

53 
NULL
 },

55 { 
ngx_°rög
("rtmp_auto_push_reconnect"),

56 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

57 
ngx_c⁄f_£t_m£c_¶Ÿ
,

59 
off£tof
(
ngx_πmp_auto_push_c⁄f_t
, 
push_ªc⁄√˘
),

60 
NULL
 },

62 { 
ngx_°rög
("rtmp_socket_dir"),

63 
NGX_MAIN_CONF
|
NGX_DIRECT_CONF
|
NGX_CONF_TAKE1
,

64 
ngx_c⁄f_£t_°r_¶Ÿ
,

66 
off£tof
(
ngx_πmp_auto_push_c⁄f_t
, 
sockë_dú
),

67 
NULL
 },

69 
ngx_nuŒ_comm™d


73 
ngx_c‹e_moduÀ_t
 
	gngx_πmp_auto_push_moduÀ_˘x
 = {

74 
ngx_°rög
("rtmp_auto_push"),

75 
ngx_πmp_auto_push_¸óã_c⁄f
,

76 
ngx_πmp_auto_push_öô_c⁄f


80 
ngx_moduÀ_t
 
	gngx_πmp_auto_push_moduÀ
 = {

81 
NGX_MODULE_V1
,

82 &
ngx_πmp_auto_push_moduÀ_˘x
,

83 
ngx_πmp_auto_push_comm™ds
,

84 
NGX_CORE_MODULE
,

85 
NULL
,

86 
NULL
,

87 
ngx_πmp_auto_push_öô_¥o˚ss
,

88 
NULL
,

89 
NULL
,

90 
ngx_πmp_auto_push_exô_¥o˚ss
,

91 
NULL
,

92 
NGX_MODULE_V1_PADDING


96 
	#NGX_RTMP_AUTO_PUSH_SOCKNAME
 "ngöx-πmp"

	)

99 
ngx_öt_t


100 
	$ngx_πmp_auto_push_öô_¥o˚ss
(
ngx_cy˛e_t
 *
cy˛e
)

102 #i‡(
NGX_HAVE_UNIX_DOMAIN
)

103 
ngx_πmp_auto_push_c⁄f_t
 *
≠cf
;

104 
ngx_li°íög_t
 *
ls
, *
lss
;

105 
sockaddr_un
 *
ßun
;

106 
ªu£addr
;

107 
ngx_sockë_t
 
s
;

108 
size_t
 
n
;

109 
ngx_fûe_öfo_t
 
fi
;

111 i‡(
ngx_¥o˚ss
 !
NGX_PROCESS_WORKER
) {

112  
NGX_OK
;

115 
≠cf
 = (
ngx_πmp_auto_push_c⁄f_t
 *Ë
	`ngx_gë_c⁄f
(
cy˛e
->
c⁄f_˘x
,

116 
ngx_πmp_auto_push_moduÀ
);

117 i‡(
≠cf
->
auto_push
 == 0) {

118  
NGX_OK
;

121 
√xt_publish
 = 
ngx_πmp_publish
;

122 
ngx_πmp_publish
 = 
ngx_πmp_auto_push_publish
;

124 
√xt_dñëe_°ªam
 = 
ngx_πmp_dñëe_°ªam
;

125 
ngx_πmp_dñëe_°ªam
 = 
ngx_πmp_auto_push_dñëe_°ªam
;

127 
ªu£addr
 = 1;

128 
s
 = (
ngx_sockë_t
) -1;

130 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
cy˛e
->
log
, 0,

134 
ls
 = 
cy˛e
->
li°íög
.
ñts
;

135 
lss
 = 
NULL
;

136 
n
 = 0;Ç < 
cy˛e
->
li°íög
.
√…s
; ++n, ++
ls
) {

137 i‡(
ls
->
h™dÀr
 =
ngx_πmp_öô_c⁄√˘i⁄
) {

138 
lss
 = 
ls
;

143 i‡(
lss
 =
NULL
) {

144  
NGX_OK
;

147 
ls
 = 
	`ngx_¨øy_push
(&
cy˛e
->
li°íög
);

148 i‡(
ls
 =
NULL
) {

149  
NGX_ERROR
;

152 *
ls
 = *
lss
;

157 
ls
->
addr_¡›
 = 0;

159 
ls
->
sockÀn
 = (
sockaddr_un
);

160 
ßun
 = 
	`ngx_pˇŒoc
(
cy˛e
->
poﬁ
, 
ls
->
sockÀn
);

161 
ls
->
sockaddr
 = (sockadd∏*Ë
ßun
;

162 i‡(
ls
->
sockaddr
 =
NULL
) {

163  
NGX_ERROR
;

165 
ßun
->
sun_Ámûy
 = 
AF_UNIX
;

166 *
	`ngx_¢¥ötf
((
u_ch¨
 *Ë
ßun
->
sun_∑th
, (saun->sun_path),

167 "%V/" 
NGX_RTMP_AUTO_PUSH_SOCKNAME
 ".%i",

168 &
≠cf
->
sockë_dú
, 
ngx_¥o˚ss_¶Ÿ
)

171 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
cy˛e
->
log
, 0,

173 
ßun
->
sun_∑th
);

175 i‡(
	`ngx_fûe_öfo
(
ßun
->
sun_∑th
, &
fi
Ë!
ENOENT
) {

176 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
cy˛e
->
log
, 0,

178 
ßun
->
sun_∑th
);

179 
	`ngx_dñëe_fûe
(
ßun
->
sun_∑th
);

182 
	`ngx_°r_£t
(&
ls
->
addr_ãxt
, "worker_socket");

184 
s
 = 
	`ngx_sockë
(
AF_UNIX
, 
SOCK_STREAM
, 0);

185 i‡(
s
 == -1) {

186 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_sockë_î∫o
,

187 
ngx_sockë_n
 " worker_socket failed");

188  
NGX_ERROR
;

191 i‡(
	`£tsock›t
(
s
, 
SOL_SOCKET
, 
SO_REUSEADDR
,

192 (c⁄° *Ë&
ªu£addr
, ())

195 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_sockë_î∫o
,

197 
sock_îr‹
;

200 i‡(!(
ngx_evít_Êags
 & 
NGX_USE_AIO_EVENT
)) {

201 i‡(
	`ngx_n⁄blockög
(
s
) == -1) {

202 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_sockë_î∫o
,

203 
ngx_n⁄blockög_n
 " worker_socket failed");

204  
NGX_ERROR
;

208 i‡(
	`böd
(
s
, (
sockaddr
 *Ë
ßun
, (*saun)) == -1) {

209 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_sockë_î∫o
,

210 
ngx_n⁄blockög_n
 " worker_socket bind failed");

211 
sock_îr‹
;

214 i‡(
	`li°í
(
s
, 
NGX_LISTEN_BACKLOG
) == -1) {

215 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_sockë_î∫o
,

217 
NGX_LISTEN_BACKLOG
);

218 
sock_îr‹
;

221 
ls
->
fd
 = 
s
;

222 
ls
->
li°í
 = 1;

224  
NGX_OK
;

226 
sock_îr‹
:

227 i‡(
s
 !(
ngx_sockë_t
Ë-1 && 
	`ngx_˛o£_sockë
(s) == -1) {

228 
	`ngx_log_îr‹
(
NGX_LOG_EMERG
, 
cy˛e
->
log
, 
ngx_sockë_î∫o
,

229 
ngx_˛o£_sockë_n
 " worker_socket failed");

231 
	`ngx_dñëe_fûe
(
ßun
->
sun_∑th
);

233  
NGX_ERROR
;

237  
NGX_OK
;

240 
	}
}

244 
	$ngx_πmp_auto_push_exô_¥o˚ss
(
ngx_cy˛e_t
 *
cy˛e
)

246 #i‡(
NGX_HAVE_UNIX_DOMAIN
)

247 
ngx_πmp_auto_push_c⁄f_t
 *
≠cf
;

248 
u_ch¨
 
∑th
[
NGX_MAX_PATH
];

250 
≠cf
 = (
ngx_πmp_auto_push_c⁄f_t
 *Ë
	`ngx_gë_c⁄f
(
cy˛e
->
c⁄f_˘x
,

251 
ngx_πmp_auto_push_moduÀ
);

252 i‡(
≠cf
->
auto_push
 == 0) {

255 *
	`ngx_¢¥ötf
(
∑th
, (path),

256 "%V/" 
NGX_RTMP_AUTO_PUSH_SOCKNAME
 ".%i",

257 &
≠cf
->
sockë_dú
, 
ngx_¥o˚ss_¶Ÿ
)

260 
	`ngx_dñëe_fûe
(
∑th
);

263 
	}
}

267 
	$ngx_πmp_auto_push_¸óã_c⁄f
(
ngx_cy˛e_t
 *
cy˛e
)

269 
ngx_πmp_auto_push_c⁄f_t
 *
≠cf
;

271 
≠cf
 = 
	`ngx_pˇŒoc
(
cy˛e
->
poﬁ
, (
ngx_πmp_auto_push_c⁄f_t
));

272 i‡(
≠cf
 =
NULL
) {

273  
NULL
;

276 
≠cf
->
auto_push
 = 
NGX_CONF_UNSET
;

277 
≠cf
->
push_ªc⁄√˘
 = 
NGX_CONF_UNSET_MSEC
;

279  
≠cf
;

280 
	}
}

284 
	$ngx_πmp_auto_push_öô_c⁄f
(
ngx_cy˛e_t
 *
cy˛e
, *
c⁄f
)

286 
ngx_πmp_auto_push_c⁄f_t
 *
≠cf
 = 
c⁄f
;

288 
	`ngx_c⁄f_öô_vÆue
(
≠cf
->
auto_push
, 0);

289 
	`ngx_c⁄f_öô_m£c_vÆue
(
≠cf
->
push_ªc⁄√˘
, 100);

291 i‡(
≠cf
->
sockë_dú
.
Àn
 == 0) {

292 
	`ngx_°r_£t
(&
≠cf
->
sockë_dú
, "/tmp");

295  
NGX_CONF_OK
;

296 
	}
}

299 #i‡(
NGX_HAVE_UNIX_DOMAIN
)

301 
	$ngx_πmp_auto_push_ªc⁄√˘
(
ngx_evít_t
 *
ev
)

303 
ngx_πmp_£ssi⁄_t
 *
s
 = 
ev
->
d©a
;

305 
ngx_πmp_auto_push_c⁄f_t
 *
≠cf
;

306 
ngx_πmp_auto_push_˘x_t
 *
˘x
;

307 
ngx_öt_t
 *
¶Ÿ
;

308 
ngx_öt_t
 
n
;

309 
ngx_πmp_ªœy_èrgë_t
 
©
;

310 
u_ch¨
 
∑th
[("unix:"Ë+ 
NGX_MAX_PATH
];

311 
u_ch¨
 
Êash_vî
[("APSH ,") +

312 
NGX_INT_T_LEN
 * 2];

313 
u_ch¨
 
∂ay_∑th
[
NGX_RTMP_MAX_NAME
];

314 
ngx_°r_t
 
«me
;

315 
u_ch¨
 *
p
;

316 
ngx_°r_t
 *
u
;

317 
ngx_pid_t
 
pid
;

318 
ngx_öt_t
 
≈ushed
;

319 
ngx_c‹e_c⁄f_t
 *
ccf
;

320 
ngx_fûe_öfo_t
 
fi
;

322 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

325 
≠cf
 = (
ngx_πmp_auto_push_c⁄f_t
 *Ë
	`ngx_gë_c⁄f
(
ngx_cy˛e
->
c⁄f_˘x
,

326 
ngx_πmp_auto_push_moduÀ
);

327 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_auto_push_moduÀ
);

328 i‡(
˘x
 =
NULL
) {

332 
«me
.
d©a
 = 
˘x
->name;

333 
«me
.
Àn
 = 
	`ngx_°æí
“ame.
d©a
);

335 
	`ngx_memzîo
(&
©
, (at));

336 
	`ngx_°r_£t
(&
©
.
∑ge_uæ
, "nginx-auto-push");

337 
©
.
èg
 = &
ngx_πmp_auto_push_moduÀ
;

339 i‡(
˘x
->
¨gs
[0]) {

340 
©
.
∂ay_∑th
.
d©a
 =Ölay_path;

341 
©
.
∂ay_∑th
.
Àn
 = 
	`ngx_¢¥ötf
(play_path, (play_path),

342 "%s?%s", 
˘x
->
«me
, ctx->
¨gs
) -

343 
∂ay_∑th
;

346 
¶Ÿ
 = 
˘x
->
¶Ÿs
;

347 
≈ushed
 = 0;

349 
n
 = 0;Ç < 
NGX_MAX_PROCESSES
; ++n, ++
¶Ÿ
) {

350 i‡(
n
 =
ngx_¥o˚ss_¶Ÿ
) {

354 
pid
 = 
ngx_¥o˚s£s
[
n
].pid;

355 i‡(
pid
 =0 ||Öid =
NGX_INVALID_PID
) {

359 i‡(*
¶Ÿ
) {

360 
≈ushed
++;

364 
©
.
d©a
 = &
ngx_¥o˚s£s
[
n
];

366 
	`ngx_memzîo
(&
©
.
uæ
, (at.url));

367 
u
 = &
©
.
uæ
.url;

368 
p
 = 
	`ngx_¢¥ötf
(
∑th
, (path) - 1,

369 "unix:%V/" 
NGX_RTMP_AUTO_PUSH_SOCKNAME
 ".%i",

370 &
≠cf
->
sockë_dú
, 
n
);

371 *
p
 = 0;

373 i‡(
	`ngx_fûe_öfo
(
∑th
 + ("unix:"Ë- 1, &
fi
Ë!
NGX_OK
) {

374 
	`ngx_log_debug5
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

375 "auto_push: " 
ngx_fûe_öfo_n
 " failed: "

377 
n
, 
pid
, 
∑th
, 
u
, 
˘x
->
«me
);

381 
u
->
d©a
 = 
∑th
;

382 
u
->
Àn
 = 
p
 - 
∑th
;

383 i‡(
	`ngx_∑r£_uæ
(
s
->
c⁄√˘i⁄
->
poﬁ
, &
©
.
uæ
Ë!
NGX_OK
) {

384 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

387 
u
, 
˘x
->
«me
);

391 
p
 = 
	`ngx_¢¥ötf
(
Êash_vî
, (flash_ver) - 1, "APSH %i,%i",

392 (
ngx_öt_t
Ë
ngx_¥o˚ss_¶Ÿ
, (ngx_öt_tË
ngx_pid
);

393 
©
.
Êash_vî
.
d©a
 = flash_ver;

394 
©
.
Êash_vî
.
Àn
 = 
p
 - flash_ver;

396 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

398 
n
, 
pid
, 
∑th
, 
˘x
->
«me
);

400 i‡(
	`ngx_πmp_ªœy_push
(
s
, &
«me
, &
©
Ë=
NGX_OK
) {

401 *
¶Ÿ
 = 1;

402 
≈ushed
++;

406 
	`ngx_log_debug5
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

409 
n
, 
pid
, 
∑th
, 
u
, 
˘x
->
«me
);

412 
ccf
 = (
ngx_c‹e_c⁄f_t
 *Ë
	`ngx_gë_c⁄f
(
ngx_cy˛e
->
c⁄f_˘x
,

413 
ngx_c‹e_moduÀ
);

415 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

417 
≈ushed
, 
ccf
->
w‹kî_¥o˚s£s
,

418 
ccf
->
w‹kî_¥o˚s£s
 - 1 - 
≈ushed
);

420 i‡(
ccf
->
w‹kî_¥o˚s£s
 =
≈ushed
 + 1) {

426 
¶Ÿ
 = 
˘x
->
¶Ÿs
;

428 
n
 = 0;Ç < 
NGX_MAX_PROCESSES
; ++n, ++
¶Ÿ
) {

429 
pid
 = 
ngx_¥o˚s£s
[
n
].pid;

431 i‡(
n
 =
ngx_¥o˚ss_¶Ÿ
 || *
¶Ÿ
 == 1 ||

432 
pid
 =0 ||Öid =
NGX_INVALID_PID
)

437 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

439 
n
, 
pid
, 
˘x
->
«me
);

442 i‡(!
˘x
->
push_evt
.
timî_£t
) {

443 
	`ngx_add_timî
(&
˘x
->
push_evt
, 
≠cf
->
push_ªc⁄√˘
);

445 
	}
}

448 
ngx_öt_t


449 
	$ngx_πmp_auto_push_publish
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_publish_t
 *
v
)

451 
ngx_πmp_auto_push_c⁄f_t
 *
≠cf
;

452 
ngx_πmp_auto_push_˘x_t
 *
˘x
;

454 i‡(
s
->
auto_pushed
 || (s->
ªœy
 && !s->
°©ic_ªœy
)) {

455 
√xt
;

458 
≠cf
 = (
ngx_πmp_auto_push_c⁄f_t
 *Ë
	`ngx_gë_c⁄f
(
ngx_cy˛e
->
c⁄f_˘x
,

459 
ngx_πmp_auto_push_moduÀ
);

460 i‡(
≠cf
->
auto_push
 == 0) {

461 
√xt
;

464 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_auto_push_moduÀ
);

465 i‡(
˘x
 =
NULL
) {

466 
˘x
 = 
	`ngx_∑Œoc
(
s
->
c⁄√˘i⁄
->
poﬁ
,

467 (
ngx_πmp_auto_push_˘x_t
));

468 i‡(
˘x
 =
NULL
) {

469 
√xt
;

471 
	`ngx_πmp_£t_˘x
(
s
, 
˘x
, 
ngx_πmp_auto_push_moduÀ
);

474 
	`ngx_memzîo
(
˘x
, (*ctx));

476 
˘x
->
push_evt
.
d©a
 = 
s
;

477 
˘x
->
push_evt
.
log
 = 
s
->
c⁄√˘i⁄
->log;

478 
˘x
->
push_evt
.
h™dÀr
 = 
ngx_πmp_auto_push_ªc⁄√˘
;

480 
˘x
->
¶Ÿs
 = 
	`ngx_pˇŒoc
(
s
->
c⁄√˘i⁄
->
poﬁ
,

481 (
ngx_öt_t
Ë* 
NGX_MAX_PROCESSES
);

482 i‡(
˘x
->
¶Ÿs
 =
NULL
) {

483 
√xt
;

486 
	`ngx_mem˝y
(
˘x
->
«me
, 
v
->name, (ctx->name));

487 
	`ngx_mem˝y
(
˘x
->
¨gs
, 
v
->args, (ctx->args));

489 
	`ngx_πmp_auto_push_ªc⁄√˘
(&
˘x
->
push_evt
);

491 
√xt
:

492  
	`√xt_publish
(
s
, 
v
);

493 
	}
}

496 
ngx_öt_t


497 
	$ngx_πmp_auto_push_dñëe_°ªam
(
ngx_πmp_£ssi⁄_t
 *
s
,

498 
ngx_πmp_dñëe_°ªam_t
 *
v
)

500 
ngx_πmp_auto_push_c⁄f_t
 *
≠cf
;

501 
ngx_πmp_auto_push_˘x_t
 *
˘x
, *
p˘x
;

502 
ngx_πmp_ªœy_˘x_t
 *
r˘x
;

503 
ngx_öt_t
 
¶Ÿ
;

505 
≠cf
 = (
ngx_πmp_auto_push_c⁄f_t
 *Ë
	`ngx_gë_c⁄f
(
ngx_cy˛e
->
c⁄f_˘x
,

506 
ngx_πmp_auto_push_moduÀ
);

507 i‡(
≠cf
->
auto_push
 == 0) {

508 
√xt
;

511 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_auto_push_moduÀ
);

512 i‡(
˘x
) {

513 i‡(
˘x
->
push_evt
.
timî_£t
) {

514 
	`ngx_dñ_timî
(&
˘x
->
push_evt
);

516 
√xt
;

520 
r˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªœy_moduÀ
);

521 i‡(
r˘x
 =
NULL
 ||

522 
r˘x
->
èg
 !&
ngx_πmp_auto_push_moduÀ
 ||

523 
r˘x
->
publish
 =
NULL
)

525 
√xt
;

528 
¶Ÿ
 = (
ngx_¥o˚ss_t
 *Ë
r˘x
->
d©a
 - &
ngx_¥o˚s£s
[0];

530 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

532 
¶Ÿ
, &
r˘x
->
≠p
, &r˘x->
«me
);

534 
p˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
r˘x
->
publish
->
£ssi⁄
,

535 
ngx_πmp_auto_push_moduÀ
);

536 i‡(
p˘x
 =
NULL
) {

537 
√xt
;

540 
p˘x
->
¶Ÿs
[
¶Ÿ
] = 0;

543 i‡(!
p˘x
->
push_evt
.
timî_£t
) {

544 
	`ngx_add_timî
(&
p˘x
->
push_evt
, 
≠cf
->
push_ªc⁄√˘
);

547 
√xt
:

548  
	`√xt_dñëe_°ªam
(
s
, 
v
);

549 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_bandwidth.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp_b™dwidth.h
"

13 
	$ngx_πmp_upd©e_b™dwidth
(
ngx_πmp_b™dwidth_t
 *
bw
, 
uöt32_t
 
byãs
)

15 i‡(
ngx_ˇched_time
->
£c
 > 
bw
->
öé_íd
) {

16 
bw
->
b™dwidth
 = 
ngx_ˇched_time
->
£c
 >

17 
bw
->
öé_íd
 + 
NGX_RTMP_BANDWIDTH_INTERVAL


19 : 
bw
->
öé_byãs
 / 
NGX_RTMP_BANDWIDTH_INTERVAL
;

20 
bw
->
öé_byãs
 = 0;

21 
bw
->
öé_íd
 = 
ngx_ˇched_time
->
£c
 + 
NGX_RTMP_BANDWIDTH_INTERVAL
;

24 
bw
->
byãs
 += bytes;

25 
bw
->
öé_byãs
 +
byãs
;

26 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_bandwidth.h

7 #i‚de‡
_NGX_RTMP_BANDWIDTH_H_INCLUDED_


8 
	#_NGX_RTMP_BANDWIDTH_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

16 
	#NGX_RTMP_BANDWIDTH_INTERVAL
 10

	)

20 
uöt64_t
 
	mbyãs
;

21 
uöt64_t
 
	mb™dwidth
;

23 
time_t
 
	möé_íd
;

24 
uöt64_t
 
	möé_byãs
;

25 } 
	tngx_πmp_b™dwidth_t
;

28 
ngx_πmp_upd©e_b™dwidth
(
ngx_πmp_b™dwidth_t
 *
bw
, 
uöt32_t
 
byãs
);

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_bitop.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp_bô›.h
"

13 
	$ngx_πmp_bô_öô_ªadî
(
ngx_πmp_bô_ªadî_t
 *
br
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

15 
	`ngx_memzîo
(
br
, (
ngx_πmp_bô_ªadî_t
));

17 
br
->
pos
 =Öos;

18 
br
->
œ°
 =Üast;

19 
	}
}

22 
uöt64_t


23 
	$ngx_πmp_bô_ªad
(
ngx_πmp_bô_ªadî_t
 *
br
, 
ngx_uöt_t
 
n
)

25 
uöt64_t
 
v
;

26 
ngx_uöt_t
 
d
;

28 
v
 = 0;

30 
n
) {

32 i‡(
br
->
pos
 >br->
œ°
) {

33 
br
->
îr
 = 1;

37 
d
 = (
br
->
offs
 + 
n
 > 8 ? (
ngx_uöt_t
) (8 - br->offs) :Ç);

39 
v
 <<
d
;

40 
v
 +(*
br
->
pos
 >> (8 - br->
offs
 - 
d
)Ë& ((
u_ch¨
) 0xff >> (8 - d));

42 
br
->
offs
 +
d
;

43 
n
 -
d
;

45 i‡(
br
->
offs
 == 8) {

46 
br
->
pos
++;

47 
br
->
offs
 = 0;

51  
v
;

52 
	}
}

55 
uöt64_t


56 
	$ngx_πmp_bô_ªad_gﬁomb
(
ngx_πmp_bô_ªadî_t
 *
br
)

58 
ngx_uöt_t
 
n
;

60 
n
 = 0; 
	`ngx_πmp_bô_ªad
(
br
, 1Ë=0 && !br->
îr
;Ç++);

62  ((
uöt64_t
Ë1 << 
n
Ë+ 
	`ngx_πmp_bô_ªad
(
br
,Ç) - 1;

63 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_bitop.h

7 #i‚de‡
_NGX_RTMP_BITOP_H_INCLUDED_


8 
	#_NGX_RTMP_BITOP_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

16 
u_ch¨
 *
	mpos
;

17 
u_ch¨
 *
	mœ°
;

18 
ngx_uöt_t
 
	moffs
;

19 
ngx_uöt_t
 
	mîr
;

20 } 
	tngx_πmp_bô_ªadî_t
;

23 
ngx_πmp_bô_öô_ªadî
(
ngx_πmp_bô_ªadî_t
 *
br
, 
u_ch¨
 *
pos
,

24 
u_ch¨
 *
œ°
);

25 
uöt64_t
 
ngx_πmp_bô_ªad
(
ngx_πmp_bô_ªadî_t
 *
br
, 
ngx_uöt_t
 
n
);

26 
uöt64_t
 
ngx_πmp_bô_ªad_gﬁomb
(
ngx_πmp_bô_ªadî_t
 *
br
);

29 
	#ngx_πmp_bô_ªad_îr
(
br
Ë((br)->
îr
)

	)

31 
	#ngx_πmp_bô_ªad_eof
(
br
Ë((br)->
pos
 =(br)->
œ°
)

	)

33 
	#ngx_πmp_bô_ªad_8
(
br
) \

34 ((
uöt8_t
Ë
	`ngx_πmp_bô_ªad
(
br
, 8))

	)

36 
	#ngx_πmp_bô_ªad_16
(
br
) \

37 ((
uöt16_t
Ë
	`ngx_πmp_bô_ªad
(
br
, 16))

	)

39 
	#ngx_πmp_bô_ªad_32
(
br
) \

40 ((
uöt32_t
Ë
	`ngx_πmp_bô_ªad
(
br
, 32))

	)

42 
	#ngx_πmp_bô_ªad_64
(
br
) \

43 ((
uöt64_t
Ë
	`ngx_πmp_ªad
(
br
, 64))

	)

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_cmd_module.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp_cmd_moduÀ.h
"

10 
	~"ngx_πmp_°ªams.h
"

13 
	#NGX_RTMP_FMS_VERSION
 "FMS/3,0,1,123"

	)

14 
	#NGX_RTMP_CAPABILITIES
 31

	)

17 
ngx_öt_t
 
ngx_πmp_cmd_c⁄√˘
(
ngx_πmp_£ssi⁄_t
 *
s
,

18 
ngx_πmp_c⁄√˘_t
 *
v
);

19 
ngx_öt_t
 
ngx_πmp_cmd_disc⁄√˘
(
ngx_πmp_£ssi⁄_t
 *
s
);

20 
ngx_öt_t
 
ngx_πmp_cmd_¸óã_°ªam
(
ngx_πmp_£ssi⁄_t
 *
s
,

21 
ngx_πmp_¸óã_°ªam_t
 *
v
);

22 
ngx_öt_t
 
ngx_πmp_cmd_˛o£_°ªam
(
ngx_πmp_£ssi⁄_t
 *
s
,

23 
ngx_πmp_˛o£_°ªam_t
 *
v
);

24 
ngx_öt_t
 
ngx_πmp_cmd_dñëe_°ªam
(
ngx_πmp_£ssi⁄_t
 *
s
,

25 
ngx_πmp_dñëe_°ªam_t
 *
v
);

26 
ngx_öt_t
 
ngx_πmp_cmd_publish
(
ngx_πmp_£ssi⁄_t
 *
s
,

27 
ngx_πmp_publish_t
 *
v
);

28 
ngx_öt_t
 
ngx_πmp_cmd_∂ay
(
ngx_πmp_£ssi⁄_t
 *
s
,

29 
ngx_πmp_∂ay_t
 *
v
);

30 
ngx_öt_t
 
ngx_πmp_cmd_£ek
(
ngx_πmp_£ssi⁄_t
 *
s
,

31 
ngx_πmp_£ek_t
 *
v
);

32 
ngx_öt_t
 
ngx_πmp_cmd_∑u£
(
ngx_πmp_£ssi⁄_t
 *
s
,

33 
ngx_πmp_∑u£_t
 *
v
);

36 
ngx_öt_t
 
ngx_πmp_cmd_°ªam_begö
(
ngx_πmp_£ssi⁄_t
 *
s
,

37 
ngx_πmp_°ªam_begö_t
 *
v
);

38 
ngx_öt_t
 
ngx_πmp_cmd_°ªam_eof
(
ngx_πmp_£ssi⁄_t
 *
s
,

39 
ngx_πmp_°ªam_eof_t
 *
v
);

40 
ngx_öt_t
 
ngx_πmp_cmd_°ªam_dry
(
ngx_πmp_£ssi⁄_t
 *
s
,

41 
ngx_πmp_°ªam_dry_t
 *
v
);

42 
ngx_öt_t
 
ngx_πmp_cmd_ªc‹ded
(
ngx_πmp_£ssi⁄_t
 *
s
,

43 
ngx_πmp_ªc‹ded_t
 *
v
);

44 
ngx_öt_t
 
ngx_πmp_cmd_£t_buÊí
(
ngx_πmp_£ssi⁄_t
 *
s
,

45 
ngx_πmp_£t_buÊí_t
 *
v
);

48 
ngx_πmp_c⁄√˘_±
 
	gngx_πmp_c⁄√˘
;

49 
ngx_πmp_disc⁄√˘_±
 
	gngx_πmp_disc⁄√˘
;

50 
ngx_πmp_¸óã_°ªam_±
 
	gngx_πmp_¸óã_°ªam
;

51 
ngx_πmp_˛o£_°ªam_±
 
	gngx_πmp_˛o£_°ªam
;

52 
ngx_πmp_dñëe_°ªam_±
 
	gngx_πmp_dñëe_°ªam
;

53 
ngx_πmp_publish_±
 
	gngx_πmp_publish
;

54 
ngx_πmp_∂ay_±
 
	gngx_πmp_∂ay
;

55 
ngx_πmp_£ek_±
 
	gngx_πmp_£ek
;

56 
ngx_πmp_∑u£_±
 
	gngx_πmp_∑u£
;

59 
ngx_πmp_°ªam_begö_±
 
	gngx_πmp_°ªam_begö
;

60 
ngx_πmp_°ªam_eof_±
 
	gngx_πmp_°ªam_eof
;

61 
ngx_πmp_°ªam_dry_±
 
	gngx_πmp_°ªam_dry
;

62 
ngx_πmp_ªc‹ded_±
 
	gngx_πmp_ªc‹ded
;

63 
ngx_πmp_£t_buÊí_±
 
	gngx_πmp_£t_buÊí
;

66 
ngx_öt_t
 
ngx_πmp_cmd_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
);

69 
ngx_πmp_moduÀ_t
 
	gngx_πmp_cmd_moduÀ_˘x
 = {

70 
NULL
,

71 
ngx_πmp_cmd_po°c⁄figuøti⁄
,

72 
NULL
,

73 
NULL
,

74 
NULL
,

75 
NULL
,

76 
NULL
,

77 
NULL


81 
ngx_moduÀ_t
 
	gngx_πmp_cmd_moduÀ
 = {

82 
NGX_MODULE_V1
,

83 &
ngx_πmp_cmd_moduÀ_˘x
,

84 
NULL
,

85 
NGX_RTMP_MODULE
,

86 
NULL
,

87 
NULL
,

88 
NULL
,

89 
NULL
,

90 
NULL
,

91 
NULL
,

92 
NULL
,

93 
NGX_MODULE_V1_PADDING


98 
	$ngx_πmp_cmd_fûl_¨gs
(
u_ch¨
 
«me
[
NGX_RTMP_MAX_NAME
],

99 
u_ch¨
 
¨gs
[
NGX_RTMP_MAX_ARGS
])

101 
u_ch¨
 *
p
;

103 
p
 = (
u_ch¨
 *)
	`ngx_°rchr
(
«me
, '?');

104 i‡(
p
 =
NULL
) {

108 *
p
++ = 0;

109 
	`ngx_˝y°∫
(
¨gs
, 
p
, 
NGX_RTMP_MAX_ARGS
);

110 
	}
}

113 
ngx_öt_t


114 
	$ngx_πmp_cmd_c⁄√˘_öô
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

115 
ngx_chaö_t
 *
ö
)

117 
size_t
 
Àn
;

119 
ngx_πmp_c⁄√˘_t
 
v
;

121 
ngx_πmp_amf_ñt_t
 
ö_cmd
[] = {

123 { 
NGX_RTMP_AMF_STRING
,

124 
	`ngx_°rög
("app"),

125 
v
.
≠p
, (v.app) },

127 { 
NGX_RTMP_AMF_STRING
,

128 
	`ngx_°rög
("flashVer"),

129 
v
.
Êashvî
, (v.flashver) },

131 { 
NGX_RTMP_AMF_STRING
,

132 
	`ngx_°rög
("swfUrl"),

133 
v
.
swf_uæ
, (v.swf_url) },

135 { 
NGX_RTMP_AMF_STRING
,

136 
	`ngx_°rög
("tcUrl"),

137 
v
.
tc_uæ
, (v.tc_url) },

139 { 
NGX_RTMP_AMF_NUMBER
,

140 
	`ngx_°rög
("audioCodecs"),

141 &
v
.
acodecs
, (v.acodecs) },

143 { 
NGX_RTMP_AMF_NUMBER
,

144 
	`ngx_°rög
("videoCodecs"),

145 &
v
.
vcodecs
, (v.vcodecs) },

147 { 
NGX_RTMP_AMF_STRING
,

148 
	`ngx_°rög
("pageUrl"),

149 
v
.
∑ge_uæ
, (v.page_url) },

151 { 
NGX_RTMP_AMF_NUMBER
,

152 
	`ngx_°rög
("objectEncoding"),

153 &
v
.
obje˘_ícodög
, 0},

156 
ngx_πmp_amf_ñt_t
 
ö_ñts
[] = {

158 { 
NGX_RTMP_AMF_NUMBER
,

159 
ngx_nuŒ_°rög
,

160 &
v
.
å™s
, 0 },

162 { 
NGX_RTMP_AMF_OBJECT
,

163 
ngx_nuŒ_°rög
,

164 
ö_cmd
, (in_cmd) },

167 
	`ngx_memzîo
(&
v
, (v));

168 i‡(
	`ngx_πmp_ª˚ive_amf
(
s
, 
ö
, 
ö_ñts
,

169 (
ö_ñts
) / (in_elts[0])))

171  
NGX_ERROR
;

174 
Àn
 = 
	`ngx_°æí
(
v
.
≠p
);

175 i‡(
Àn
 > 10 && !
	`ngx_memcmp
(
v
.
≠p
 +Üen - 10, "/_definst_", 10)) {

176 
v
.
≠p
[
Àn
 - 10] = 0;

177 } i‡(
Àn
 && 
v
.
≠p
[len - 1] == '/') {

178 
v
.
≠p
[
Àn
 - 1] = 0;

181 
	`ngx_πmp_cmd_fûl_¨gs
(
v
.
≠p
, v.
¨gs
);

184 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

188 
v
.
≠p
, v.
¨gs
, v.
Êashvî
, v.
swf_uæ
, v.
tc_uæ
, v.
∑ge_uæ
,

189 (
uöt32_t
)
v
.
acodecs
, (uöt32_t)v.
vcodecs
,

190 (
ngx_öt_t
)
v
.
obje˘_ícodög
);

194  
	`ngx_πmp_c⁄√˘
(
s
, &
v
);

195 
	}
}

198 
ngx_öt_t


199 
	$ngx_πmp_cmd_c⁄√˘
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_c⁄√˘_t
 *
v
)

201 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

202 
ngx_πmp_c‹e_≠p_c⁄f_t
 **
ˇcÂ
;

203 
ngx_uöt_t
 
n
;

204 
ngx_πmp_hódî_t
 
h
;

205 
u_ch¨
 *
p
;

207 
å™s
;

208 
ˇ∑bûôõs
 = 
NGX_RTMP_CAPABILITIES
;

209 
obje˘_ícodög
 = 0;

211 
ngx_πmp_amf_ñt_t
 
out_obj
[] = {

213 { 
NGX_RTMP_AMF_STRING
,

214 
	`ngx_°rög
("fmsVer"),

215 
NGX_RTMP_FMS_VERSION
, 0 },

217 { 
NGX_RTMP_AMF_NUMBER
,

218 
	`ngx_°rög
("capabilities"),

219 &
ˇ∑bûôõs
, 0 },

222 
ngx_πmp_amf_ñt_t
 
out_öf
[] = {

224 { 
NGX_RTMP_AMF_STRING
,

225 
	`ngx_°rög
("level"),

228 { 
NGX_RTMP_AMF_STRING
,

229 
	`ngx_°rög
("code"),

232 { 
NGX_RTMP_AMF_STRING
,

233 
	`ngx_°rög
("description"),

236 { 
NGX_RTMP_AMF_NUMBER
,

237 
	`ngx_°rög
("objectEncoding"),

238 &
obje˘_ícodög
, 0 }

241 
ngx_πmp_amf_ñt_t
 
out_ñts
[] = {

243 { 
NGX_RTMP_AMF_STRING
,

244 
ngx_nuŒ_°rög
,

247 { 
NGX_RTMP_AMF_NUMBER
,

248 
ngx_nuŒ_°rög
,

249 &
å™s
, 0 },

251 { 
NGX_RTMP_AMF_OBJECT
,

252 
ngx_nuŒ_°rög
,

253 
out_obj
, (out_obj) },

255 { 
NGX_RTMP_AMF_OBJECT
,

256 
ngx_nuŒ_°rög
,

257 
out_öf
, (out_inf) },

260 i‡(
s
->
c⁄√˘ed
) {

261 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

263  
NGX_ERROR
;

266 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

268 
å™s
 = 
v
->trans;

271 
s
->
c⁄√˘ed
 = 1;

273 
	`ngx_memzîo
(&
h
, (h));

274 
h
.
csid
 = 
NGX_RTMP_CSID_AMF_INI
;

275 
h
.
ty≥
 = 
NGX_RTMP_MSG_AMF_CMD
;

278 
	#NGX_RTMP_SET_STRPAR
(
«me
) \

279 
s
->
«me
.
Àn
 = 
	`ngx_°æí
(
v
->name); \

280 
s
->
«me
.
d©a
 = 
	`ngx_∑Œoc
(s->
c⁄√˘i⁄
->
poﬁ
, s->«me.
Àn
); \

281 
	`ngx_mem˝y
(
s
->
«me
.
d©a
, 
v
->«me, s->«me.
Àn
)

	)

283 
	`NGX_RTMP_SET_STRPAR
(
≠p
);

284 
	`NGX_RTMP_SET_STRPAR
(
¨gs
);

285 
	`NGX_RTMP_SET_STRPAR
(
Êashvî
);

286 
	`NGX_RTMP_SET_STRPAR
(
swf_uæ
);

287 
	`NGX_RTMP_SET_STRPAR
(
tc_uæ
);

288 
	`NGX_RTMP_SET_STRPAR
(
∑ge_uæ
);

290 #unde‡
NGX_RTMP_SET_STRPAR


292 
p
 = 
	`ngx_°æchr
(
s
->
≠p
.
d©a
, s->≠p.d©®+ s->≠p.
Àn
, '?');

293 i‡(
p
) {

294 
s
->
≠p
.
Àn
 = (
p
 - s->≠p.
d©a
);

297 
s
->
acodecs
 = (
uöt32_t
Ë
v
->acodecs;

298 
s
->
vcodecs
 = (
uöt32_t
Ë
v
->vcodecs;

301 
ˇcÂ
 = 
cscf
->
≠∂iˇti⁄s
.
ñts
;

302 
n
 = 0;Ç < 
cscf
->
≠∂iˇti⁄s
.
√…s
; ++n, ++
ˇcÂ
) {

303 i‡((*
ˇcÂ
)->
«me
.
Àn
 =
s
->
≠p
.len &&

304 
	`ngx_°∫cmp
((*
ˇcÂ
)->
«me
.
d©a
, 
s
->
≠p
.d©a, s->≠p.
Àn
) == 0)

307 
s
->
≠p_c⁄f
 = (*
ˇcÂ
)->app_conf;

312 i‡(
s
->
≠p_c⁄f
 =
NULL
) {

313 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

314 "c⁄√˘:áµliˇti⁄ÇŸ found: '%V'", &
s
->
≠p
);

315  
NGX_ERROR
;

318 
obje˘_ícodög
 = 
v
->object_encoding;

320  
	`ngx_πmp_£nd_ack_size
(
s
, 
cscf
->
ack_wödow
Ë!
NGX_OK
 ||

321 
	`ngx_πmp_£nd_b™dwidth
(
s
, 
cscf
->
ack_wödow
,

322 
NGX_RTMP_LIMIT_DYNAMIC
Ë!
NGX_OK
 ||

323 
	`ngx_πmp_£nd_chunk_size
(
s
, 
cscf
->
chunk_size
Ë!
NGX_OK
 ||

324 
	`ngx_πmp_£nd_amf
(
s
, &
h
, 
out_ñts
,

325 (
out_ñts
) / (out_elts[0]))

326 !
NGX_OK
 ? 
NGX_ERROR
 : NGX_OK;

327 
	}
}

330 
ngx_öt_t


331 
	$ngx_πmp_cmd_¸óã_°ªam_öô
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

332 
ngx_chaö_t
 *
ö
)

334 
ngx_πmp_¸óã_°ªam_t
 
v
;

336 
ngx_πmp_amf_ñt_t
 
ö_ñts
[] = {

338 { 
NGX_RTMP_AMF_NUMBER
,

339 
ngx_nuŒ_°rög
,

340 &
v
.
å™s
, (v.trans) },

343 i‡(
	`ngx_πmp_ª˚ive_amf
(
s
, 
ö
, 
ö_ñts
,

344 (
ö_ñts
) / (in_elts[0])))

346  
NGX_ERROR
;

349 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0, "createStream");

351  
	`ngx_πmp_¸óã_°ªam
(
s
, &
v
);

352 
	}
}

355 
ngx_öt_t


356 
	$ngx_πmp_cmd_¸óã_°ªam
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_¸óã_°ªam_t
 *
v
)

359 
°ªam
;

360 
å™s
;

361 
ngx_πmp_hódî_t
 
h
;

363 
ngx_πmp_amf_ñt_t
 
out_ñts
[] = {

365 { 
NGX_RTMP_AMF_STRING
,

366 
ngx_nuŒ_°rög
,

369 { 
NGX_RTMP_AMF_NUMBER
,

370 
ngx_nuŒ_°rög
,

371 &
å™s
, 0 },

373 { 
NGX_RTMP_AMF_NULL
,

374 
ngx_nuŒ_°rög
,

375 
NULL
, 0 },

377 { 
NGX_RTMP_AMF_NUMBER
,

378 
ngx_nuŒ_°rög
,

379 &
°ªam
, (stream) },

382 
å™s
 = 
v
->trans;

383 
°ªam
 = 
NGX_RTMP_MSID
;

385 
	`ngx_memzîo
(&
h
, (h));

387 
h
.
csid
 = 
NGX_RTMP_CSID_AMF_INI
;

388 
h
.
ty≥
 = 
NGX_RTMP_MSG_AMF_CMD
;

390  
	`ngx_πmp_£nd_amf
(
s
, &
h
, 
out_ñts
,

391 (
out_ñts
Ë/ (out_ñts[0])Ë=
NGX_OK
 ?

392 
NGX_DONE
 : 
NGX_ERROR
;

393 
	}
}

396 
ngx_öt_t


397 
	$ngx_πmp_cmd_˛o£_°ªam_öô
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

398 
ngx_chaö_t
 *
ö
)

400 
ngx_πmp_˛o£_°ªam_t
 
v
;

402 
ngx_πmp_amf_ñt_t
 
ö_ñts
[] = {

404 { 
NGX_RTMP_AMF_NUMBER
,

405 
ngx_nuŒ_°rög
,

406 &
v
.
°ªam
, 0 },

409 i‡(
	`ngx_πmp_ª˚ive_amf
(
s
, 
ö
, 
ö_ñts
,

410 (
ö_ñts
) / (in_elts[0])))

412  
NGX_ERROR
;

415 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0, "closeStream");

417  
	`ngx_πmp_˛o£_°ªam
(
s
, &
v
);

418 
	}
}

421 
ngx_öt_t


422 
	$ngx_πmp_cmd_˛o£_°ªam
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_˛o£_°ªam_t
 *
v
)

424  
NGX_OK
;

425 
	}
}

428 
ngx_öt_t


429 
	$ngx_πmp_cmd_dñëe_°ªam_öô
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

430 
ngx_chaö_t
 *
ö
)

432 
ngx_πmp_dñëe_°ªam_t
 
v
;

434 
ngx_πmp_amf_ñt_t
 
ö_ñts
[] = {

436 { 
NGX_RTMP_AMF_NUMBER
,

437 
ngx_nuŒ_°rög
,

438 
NULL
, 0 },

440 { 
NGX_RTMP_AMF_NULL
,

441 
ngx_nuŒ_°rög
,

442 
NULL
, 0 },

444 { 
NGX_RTMP_AMF_NUMBER
,

445 
ngx_nuŒ_°rög
,

446 &
v
.
°ªam
, 0 },

449 i‡(
	`ngx_πmp_ª˚ive_amf
(
s
, 
ö
, 
ö_ñts
,

450 (
ö_ñts
) / (in_elts[0])))

452  
NGX_ERROR
;

455  
	`ngx_πmp_dñëe_°ªam
(
s
, &
v
);

456 
	}
}

459 
ngx_öt_t


460 
	$ngx_πmp_cmd_dñëe_°ªam
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_dñëe_°ªam_t
 *
v
)

462 
ngx_πmp_˛o£_°ªam_t
 
cv
;

464 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0, "deleteStream");

466 
cv
.
°ªam
 = 0;

468  
	`ngx_πmp_˛o£_°ªam
(
s
, &
cv
);

469 
	}
}

472 
ngx_öt_t


473 
	$ngx_πmp_cmd_publish_öô
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

474 
ngx_chaö_t
 *
ö
)

476 
ngx_πmp_publish_t
 
v
;

478 
ngx_πmp_amf_ñt_t
 
ö_ñts
[] = {

481 { 
NGX_RTMP_AMF_NUMBER
,

482 
ngx_nuŒ_°rög
,

483 
NULL
, 0 },

485 { 
NGX_RTMP_AMF_NULL
,

486 
ngx_nuŒ_°rög
,

487 
NULL
, 0 },

489 { 
NGX_RTMP_AMF_STRING
,

490 
ngx_nuŒ_°rög
,

491 &
v
.
«me
, (v.name) },

493 { 
NGX_RTMP_AMF_OPTIONAL
 | 
NGX_RTMP_AMF_STRING
,

494 
ngx_nuŒ_°rög
,

495 &
v
.
ty≥
, (v.type) },

498 
	`ngx_memzîo
(&
v
, (v));

500 i‡(
	`ngx_πmp_ª˚ive_amf
(
s
, 
ö
, 
ö_ñts
,

501 (
ö_ñts
) / (in_elts[0])))

503  
NGX_ERROR
;

506 
	`ngx_πmp_cmd_fûl_¨gs
(
v
.
«me
, v.
¨gs
);

508 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

510 
v
.
«me
, v.
¨gs
, v.
ty≥
, v.
sûít
);

512  
	`ngx_πmp_publish
(
s
, &
v
);

513 
	}
}

516 
ngx_öt_t


517 
	$ngx_πmp_cmd_publish
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_publish_t
 *
v
)

519  
NGX_OK
;

520 
	}
}

522 
ngx_öt_t


523 
	$ngx_πmp_cmd_∂ay_öô
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

524 
ngx_chaö_t
 *
ö
)

526 
ngx_πmp_∂ay_t
 
v
;

528 
ngx_πmp_amf_ñt_t
 
ö_ñts
[] = {

531 { 
NGX_RTMP_AMF_NUMBER
,

532 
ngx_nuŒ_°rög
,

533 
NULL
, 0 },

535 { 
NGX_RTMP_AMF_NULL
,

536 
ngx_nuŒ_°rög
,

537 
NULL
, 0 },

539 { 
NGX_RTMP_AMF_STRING
,

540 
ngx_nuŒ_°rög
,

541 &
v
.
«me
, (v.name) },

543 { 
NGX_RTMP_AMF_OPTIONAL
 | 
NGX_RTMP_AMF_NUMBER
,

544 
ngx_nuŒ_°rög
,

545 &
v
.
°¨t
, 0 },

547 { 
NGX_RTMP_AMF_OPTIONAL
 | 
NGX_RTMP_AMF_NUMBER
,

548 
ngx_nuŒ_°rög
,

549 &
v
.
duøti⁄
, 0 },

551 { 
NGX_RTMP_AMF_OPTIONAL
 | 
NGX_RTMP_AMF_BOOLEAN
,

552 
ngx_nuŒ_°rög
,

553 &
v
.
ª£t
, 0 }

556 
	`ngx_memzîo
(&
v
, (v));

558 i‡(
	`ngx_πmp_ª˚ive_amf
(
s
, 
ö
, 
ö_ñts
,

559 (
ö_ñts
) / (in_elts[0])))

561  
NGX_ERROR
;

564 
	`ngx_πmp_cmd_fûl_¨gs
(
v
.
«me
, v.
¨gs
);

566 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

569 
v
.
«me
, v.
¨gs
, (
ngx_öt_t
Ëv.
°¨t
,

570 (
ngx_öt_t
Ë
v
.
duøti⁄
, (ngx_öt_tËv.
ª£t
,

571 (
ngx_öt_t
Ë
v
.
sûít
);

573  
	`ngx_πmp_∂ay
(
s
, &
v
);

574 
	}
}

577 
ngx_öt_t


578 
	$ngx_πmp_cmd_∂ay
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_∂ay_t
 *
v
)

580  
NGX_OK
;

581 
	}
}

584 
ngx_öt_t


585 
	$ngx_πmp_cmd_∂ay2_öô
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

586 
ngx_chaö_t
 *
ö
)

588 
ngx_πmp_∂ay_t
 
v
;

589 
ngx_πmp_˛o£_°ªam_t
 
vc
;

591 
ngx_πmp_amf_ñt_t
 
ö_obj
[] = {

593 { 
NGX_RTMP_AMF_NUMBER
,

594 
	`ngx_°rög
("start"),

595 &
v
.
°¨t
, 0 },

597 { 
NGX_RTMP_AMF_STRING
,

598 
	`ngx_°rög
("streamName"),

599 &
v
.
«me
, (v.name) },

602 
ngx_πmp_amf_ñt_t
 
ö_ñts
[] = {

605 { 
NGX_RTMP_AMF_NUMBER
,

606 
ngx_nuŒ_°rög
,

607 
NULL
, 0 },

609 { 
NGX_RTMP_AMF_NULL
,

610 
ngx_nuŒ_°rög
,

611 
NULL
, 0 },

613 { 
NGX_RTMP_AMF_OBJECT
,

614 
ngx_nuŒ_°rög
,

615 &
ö_obj
, (in_obj) }

618 
	`ngx_memzîo
(&
v
, (v));

620 i‡(
	`ngx_πmp_ª˚ive_amf
(
s
, 
ö
, 
ö_ñts
,

621 (
ö_ñts
) / (in_elts[0])))

623  
NGX_ERROR
;

626 
	`ngx_πmp_cmd_fûl_¨gs
(
v
.
«me
, v.
¨gs
);

628 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

630 
v
.
«me
, v.
¨gs
, (
ngx_öt_t
Ëv.
°¨t
);

634 i‡(
v
.
°¨t
 < 0) {

635 
v
.
°¨t
 = 
s
->
cuºít_time
;

638 
	`ngx_memzîo
(&
vc
, (vc));

641 
	`ngx_πmp_˛o£_°ªam
(
s
, &
vc
);

643  
	`ngx_πmp_∂ay
(
s
, &
v
);

644 
	}
}

647 
ngx_öt_t


648 
	$ngx_πmp_cmd_∑u£_öô
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

649 
ngx_chaö_t
 *
ö
)

651 
ngx_πmp_∑u£_t
 
v
;

653 
ngx_πmp_amf_ñt_t
 
ö_ñts
[] = {

655 { 
NGX_RTMP_AMF_NUMBER
,

656 
ngx_nuŒ_°rög
,

657 
NULL
, 0 },

659 { 
NGX_RTMP_AMF_NULL
,

660 
ngx_nuŒ_°rög
,

661 
NULL
, 0 },

663 { 
NGX_RTMP_AMF_BOOLEAN
,

664 
ngx_nuŒ_°rög
,

665 &
v
.
∑u£
, 0 },

667 { 
NGX_RTMP_AMF_NUMBER
,

668 
ngx_nuŒ_°rög
,

669 &
v
.
posôi⁄
, 0 },

672 
	`ngx_memzîo
(&
v
, (v));

674 i‡(
	`ngx_πmp_ª˚ive_amf
(
s
, 
ö
, 
ö_ñts
,

675 (
ö_ñts
) / (in_elts[0])))

677  
NGX_ERROR
;

680 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

682 (
ngx_öt_t
Ë
v
.
∑u£
, (ngx_öt_tËv.
posôi⁄
);

684  
	`ngx_πmp_∑u£
(
s
, &
v
);

685 
	}
}

688 
ngx_öt_t


689 
	$ngx_πmp_cmd_∑u£
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_∑u£_t
 *
v
)

691  
NGX_OK
;

692 
	}
}

695 
ngx_öt_t


696 
	$ngx_πmp_cmd_disc⁄√˘_öô
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

697 
ngx_chaö_t
 *
ö
)

699 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0, "disconnect");

701  
	`ngx_πmp_disc⁄√˘
(
s
);

702 
	}
}

705 
ngx_öt_t


706 
	$ngx_πmp_cmd_disc⁄√˘
(
ngx_πmp_£ssi⁄_t
 *
s
)

708  
	`ngx_πmp_dñëe_°ªam
(
s
, 
NULL
);

709 
	}
}

712 
ngx_öt_t


713 
	$ngx_πmp_cmd_£ek_öô
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

714 
ngx_chaö_t
 *
ö
)

716 
ngx_πmp_£ek_t
 
v
;

718 
ngx_πmp_amf_ñt_t
 
ö_ñts
[] = {

721 { 
NGX_RTMP_AMF_NUMBER
,

722 
ngx_nuŒ_°rög
,

723 
NULL
, 0 },

725 { 
NGX_RTMP_AMF_NULL
,

726 
ngx_nuŒ_°rög
,

727 
NULL
, 0 },

729 { 
NGX_RTMP_AMF_NUMBER
,

730 
ngx_nuŒ_°rög
,

731 &
v
.
off£t
, (v.offset) },

734 
	`ngx_memzîo
(&
v
, (v));

736 i‡(
	`ngx_πmp_ª˚ive_amf
(
s
, 
ö
, 
ö_ñts
,

737 (
ö_ñts
) / (in_elts[0])))

739  
NGX_ERROR
;

742 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

743 "£ek: off£t=%i", (
ngx_öt_t
Ë
v
.
off£t
);

745  
	`ngx_πmp_£ek
(
s
, &
v
);

746 
	}
}

749 
ngx_öt_t


750 
	$ngx_πmp_cmd_£ek
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_£ek_t
 *
v
)

752  
NGX_OK
;

753 
	}
}

756 
ngx_öt_t


757 
	$ngx_πmp_cmd_°ªam_begö
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_°ªam_begö_t
 *
v
)

759  
NGX_OK
;

760 
	}
}

763 
ngx_öt_t


764 
	$ngx_πmp_cmd_°ªam_eof
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_°ªam_eof_t
 *
v
)

766  
NGX_OK
;

767 
	}
}

770 
ngx_öt_t


771 
	$ngx_πmp_cmd_°ªam_dry
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_°ªam_dry_t
 *
v
)

773  
NGX_OK
;

774 
	}
}

777 
ngx_öt_t


778 
	$ngx_πmp_cmd_ªc‹ded
(
ngx_πmp_£ssi⁄_t
 *
s
,

779 
ngx_πmp_ªc‹ded_t
 *
v
)

781  
NGX_OK
;

782 
	}
}

785 
ngx_öt_t


786 
	$ngx_πmp_cmd_£t_buÊí
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_£t_buÊí_t
 *
v
)

788  
NGX_OK
;

789 
	}
}

792 
ngx_πmp_amf_h™dÀr_t
 
	gngx_πmp_cmd_m≠
[] = {

793 { 
ngx_°rög
("c⁄√˘"), 
ngx_πmp_cmd_c⁄√˘_öô
 },

794 { 
ngx_°rög
("¸óãSåóm"), 
ngx_πmp_cmd_¸óã_°ªam_öô
 },

795 { 
ngx_°rög
("˛o£Såóm"), 
ngx_πmp_cmd_˛o£_°ªam_öô
 },

796 { 
ngx_°rög
("dñëeSåóm"), 
ngx_πmp_cmd_dñëe_°ªam_öô
 },

797 { 
ngx_°rög
("publish"), 
ngx_πmp_cmd_publish_öô
 },

798 { 
ngx_°rög
("∂ay"), 
ngx_πmp_cmd_∂ay_öô
 },

799 { 
ngx_°rög
("∂ay2"), 
ngx_πmp_cmd_∂ay2_öô
 },

800 { 
ngx_°rög
("£ek"), 
ngx_πmp_cmd_£ek_öô
 },

801 { 
ngx_°rög
("∑u£"), 
ngx_πmp_cmd_∑u£_öô
 },

802 { 
ngx_°rög
("∑u£øw"), 
ngx_πmp_cmd_∑u£_öô
 },

806 
ngx_öt_t


807 
	$ngx_πmp_cmd_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
)

809 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
;

810 
ngx_πmp_h™dÀr_±
 *
h
;

811 
ngx_πmp_amf_h™dÀr_t
 *
ch
, *
bh
;

812 
size_t
 
n
, 
nˇŒs
;

814 
cmcf
 = 
	`ngx_πmp_c⁄f_gë_moduÀ_maö_c⁄f
(
cf
, 
ngx_πmp_c‹e_moduÀ
);

820 
h
 = 
	`ngx_¨øy_push
(&
cmcf
->
evíts
[
NGX_RTMP_DISCONNECT
]);

821 i‡(
h
 =
NULL
) {

822  
NGX_ERROR
;

825 *
h
 = 
ngx_πmp_cmd_disc⁄√˘_öô
;

829 
nˇŒs
 = (
ngx_πmp_cmd_m≠
) / (ngx_rtmp_cmd_map[0]);

831 
ch
 = 
	`ngx_¨øy_push_n
(&
cmcf
->
amf
, 
nˇŒs
);

832 i‡(
ch
 =
NULL
) {

833  
NGX_ERROR
;

836 
bh
 = 
ngx_πmp_cmd_m≠
;

838 
n
 = 0;Ç < 
nˇŒs
; ++n, ++
ch
, ++
bh
) {

839 *
ch
 = *
bh
;

842 
ngx_πmp_c⁄√˘
 = 
ngx_πmp_cmd_c⁄√˘
;

843 
ngx_πmp_disc⁄√˘
 = 
ngx_πmp_cmd_disc⁄√˘
;

844 
ngx_πmp_¸óã_°ªam
 = 
ngx_πmp_cmd_¸óã_°ªam
;

845 
ngx_πmp_˛o£_°ªam
 = 
ngx_πmp_cmd_˛o£_°ªam
;

846 
ngx_πmp_dñëe_°ªam
 = 
ngx_πmp_cmd_dñëe_°ªam
;

847 
ngx_πmp_publish
 = 
ngx_πmp_cmd_publish
;

848 
ngx_πmp_∂ay
 = 
ngx_πmp_cmd_∂ay
;

849 
ngx_πmp_£ek
 = 
ngx_πmp_cmd_£ek
;

850 
ngx_πmp_∑u£
 = 
ngx_πmp_cmd_∑u£
;

852 
ngx_πmp_°ªam_begö
 = 
ngx_πmp_cmd_°ªam_begö
;

853 
ngx_πmp_°ªam_eof
 = 
ngx_πmp_cmd_°ªam_eof
;

854 
ngx_πmp_°ªam_dry
 = 
ngx_πmp_cmd_°ªam_dry
;

855 
ngx_πmp_ªc‹ded
 = 
ngx_πmp_cmd_ªc‹ded
;

856 
ngx_πmp_£t_buÊí
 = 
ngx_πmp_cmd_£t_buÊí
;

858  
NGX_OK
;

859 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_cmd_module.h

7 #i‚de‡
_NGX_RTMP_CMD_H_INCLUDED_


8 
	#_NGX_RTMP_CMD_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

13 
	~<ngx_evít.h
>

14 
	~"ngx_πmp.h
"

17 
	#NGX_RTMP_MAX_NAME
 256

	)

18 
	#NGX_RTMP_MAX_URL
 256

	)

19 
	#NGX_RTMP_MAX_ARGS
 
NGX_RTMP_MAX_NAME


	)

25 
	må™s
;

26 
u_ch¨
 
	m≠p
[
NGX_RTMP_MAX_NAME
];

27 
u_ch¨
 
	m¨gs
[
NGX_RTMP_MAX_ARGS
];

28 
u_ch¨
 
	mÊashvî
[32];

29 
u_ch¨
 
	mswf_uæ
[
NGX_RTMP_MAX_URL
];

30 
u_ch¨
 
	mtc_uæ
[
NGX_RTMP_MAX_URL
];

31 
	macodecs
;

32 
	mvcodecs
;

33 
u_ch¨
 
	m∑ge_uæ
[
NGX_RTMP_MAX_URL
];

34 
	mobje˘_ícodög
;

35 } 
	tngx_πmp_c⁄√˘_t
;

39 
	må™s
;

40 
	m°ªam
;

41 } 
	tngx_πmp_¸óã_°ªam_t
;

45 
	m°ªam
;

46 } 
	tngx_πmp_dñëe_°ªam_t
;

50 
	m°ªam
;

51 } 
	tngx_πmp_˛o£_°ªam_t
;

55 
u_ch¨
 
	m«me
[
NGX_RTMP_MAX_NAME
];

56 
u_ch¨
 
	m¨gs
[
NGX_RTMP_MAX_ARGS
];

57 
u_ch¨
 
	mty≥
[16];

58 
	msûít
;

59 } 
	tngx_πmp_publish_t
;

63 
u_ch¨
 
	m«me
[
NGX_RTMP_MAX_NAME
];

64 
u_ch¨
 
	m¨gs
[
NGX_RTMP_MAX_ARGS
];

65 
	m°¨t
;

66 
	mduøti⁄
;

67 
	mª£t
;

68 
	msûít
;

69 } 
	tngx_πmp_∂ay_t
;

73 
	moff£t
;

74 } 
	tngx_πmp_£ek_t
;

78 
uöt8_t
 
	m∑u£
;

79 
	mposôi⁄
;

80 } 
	tngx_πmp_∑u£_t
;

84 
uöt32_t
 
	mmsid
;

85 } 
	tngx_πmp_msid_t
;

88 
ngx_πmp_msid_t
 
	tngx_πmp_°ªam_begö_t
;

89 
ngx_πmp_msid_t
 
	tngx_πmp_°ªam_eof_t
;

90 
ngx_πmp_msid_t
 
	tngx_πmp_°ªam_dry_t
;

91 
ngx_πmp_msid_t
 
	tngx_πmp_ªc‹ded_t
;

95 
uöt32_t
 
	mmsid
;

96 
uöt32_t
 
	mbuÊí
;

97 } 
	tngx_πmp_£t_buÊí_t
;

100 
ngx_πmp_cmd_fûl_¨gs
(
u_ch¨
 
«me
[
NGX_RTMP_MAX_NAME
],

101 
u_ch¨
 
¨gs
[
NGX_RTMP_MAX_ARGS
]);

104 
	$ngx_öt_t
 (*
	tngx_πmp_c⁄√˘_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

105 
	tngx_πmp_c⁄√˘_t
 *
	tv
);

106 
	$ngx_öt_t
 (*
	tngx_πmp_disc⁄√˘_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
);

107 
	$ngx_öt_t
 (*
	tngx_πmp_¸óã_°ªam_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

108 
	tngx_πmp_¸óã_°ªam_t
 *
	tv
);

109 
	$ngx_öt_t
 (*
	tngx_πmp_˛o£_°ªam_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

110 
	tngx_πmp_˛o£_°ªam_t
 *
	tv
);

111 
	$ngx_öt_t
 (*
	tngx_πmp_dñëe_°ªam_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

112 
	tngx_πmp_dñëe_°ªam_t
 *
	tv
);

113 
	$ngx_öt_t
 (*
	tngx_πmp_publish_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

114 
	tngx_πmp_publish_t
 *
	tv
);

115 
	$ngx_öt_t
 (*
	tngx_πmp_∂ay_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

116 
	tngx_πmp_∂ay_t
 *
	tv
);

117 
	$ngx_öt_t
 (*
	tngx_πmp_£ek_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

118 
	tngx_πmp_£ek_t
 *
	tv
);

119 
	$ngx_öt_t
 (*
	tngx_πmp_∑u£_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

120 
	tngx_πmp_∑u£_t
 *
	tv
);

122 
	$ngx_öt_t
 (*
	tngx_πmp_°ªam_begö_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

123 
	tngx_πmp_°ªam_begö_t
 *
	tv
);

124 
	$ngx_öt_t
 (*
	tngx_πmp_°ªam_eof_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

125 
	tngx_πmp_°ªam_eof_t
 *
	tv
);

126 
	$ngx_öt_t
 (*
	tngx_πmp_°ªam_dry_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

127 
	tngx_πmp_°ªam_dry_t
 *
	tv
);

128 
	$ngx_öt_t
 (*
	tngx_πmp_ªc‹ded_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

129 
	tngx_πmp_ªc‹ded_t
 *
	tv
);

130 
	$ngx_öt_t
 (*
	tngx_πmp_£t_buÊí_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

131 
	tngx_πmp_£t_buÊí_t
 *
	tv
);

134 
ngx_πmp_c⁄√˘_±
 
ngx_πmp_c⁄√˘
;

135 
ngx_πmp_disc⁄√˘_±
 
ngx_πmp_disc⁄√˘
;

136 
ngx_πmp_¸óã_°ªam_±
 
ngx_πmp_¸óã_°ªam
;

137 
ngx_πmp_˛o£_°ªam_±
 
ngx_πmp_˛o£_°ªam
;

138 
ngx_πmp_dñëe_°ªam_±
 
ngx_πmp_dñëe_°ªam
;

139 
ngx_πmp_publish_±
 
ngx_πmp_publish
;

140 
ngx_πmp_∂ay_±
 
ngx_πmp_∂ay
;

141 
ngx_πmp_£ek_±
 
ngx_πmp_£ek
;

142 
ngx_πmp_∑u£_±
 
ngx_πmp_∑u£
;

144 
ngx_πmp_°ªam_begö_±
 
ngx_πmp_°ªam_begö
;

145 
ngx_πmp_°ªam_eof_±
 
ngx_πmp_°ªam_eof
;

146 
ngx_πmp_°ªam_dry_±
 
ngx_πmp_°ªam_dry
;

147 
ngx_πmp_£t_buÊí_±
 
ngx_πmp_£t_buÊí
;

148 
ngx_πmp_ªc‹ded_±
 
ngx_πmp_ªc‹ded
;

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_codec_module.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp_codec_moduÀ.h
"

10 
	~"ngx_πmp_live_moduÀ.h
"

11 
	~"ngx_πmp_cmd_moduÀ.h
"

12 
	~"ngx_πmp_bô›.h
"

15 
	#NGX_RTMP_CODEC_META_OFF
 0

	)

16 
	#NGX_RTMP_CODEC_META_ON
 1

	)

17 
	#NGX_RTMP_CODEC_META_COPY
 2

	)

20 * 
ngx_πmp_codec_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
);

21 * 
ngx_πmp_codec_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
,

22 *
∑ª¡
, *
chûd
);

23 
ngx_öt_t
 
ngx_πmp_codec_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
);

24 
ngx_öt_t
 
ngx_πmp_codec_ªc⁄°ru˘_mëa
(
ngx_πmp_£ssi⁄_t
 *
s
);

25 
ngx_öt_t
 
ngx_πmp_codec_c›y_mëa
(
ngx_πmp_£ssi⁄_t
 *
s
,

26 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
);

27 
ngx_öt_t
 
ngx_πmp_codec_¥ï¨e_mëa
(
ngx_πmp_£ssi⁄_t
 *
s
,

28 
uöt32_t
 
time°amp
);

29 
ngx_πmp_codec_∑r£_Øc_hódî
(
ngx_πmp_£ssi⁄_t
 *
s
,

30 
ngx_chaö_t
 *
ö
);

31 
ngx_πmp_codec_∑r£_avc_hódî
(
ngx_πmp_£ssi⁄_t
 *
s
,

32 
ngx_chaö_t
 *
ö
);

33 #i‡(
NGX_DEBUG
)

34 
ngx_πmp_codec_dump_hódî
(
ngx_πmp_£ssi⁄_t
 *
s
, c⁄° *
ty≥
,

35 
ngx_chaö_t
 *
ö
);

40 
ngx_uöt_t
 
	mmëa
;

41 } 
	tngx_πmp_codec_≠p_c⁄f_t
;

44 
ngx_c⁄f_íum_t
 
	gngx_πmp_codec_mëa_¶Ÿs
[] = {

45 { 
ngx_°rög
("off"), 
NGX_RTMP_CODEC_META_OFF
 },

46 { 
ngx_°rög
("⁄"), 
NGX_RTMP_CODEC_META_ON
 },

47 { 
ngx_°rög
("c›y"), 
NGX_RTMP_CODEC_META_COPY
 },

48 { 
ngx_nuŒ_°rög
, 0 }

52 
ngx_comm™d_t
 
	gngx_πmp_codec_comm™ds
[] = {

54 { 
ngx_°rög
("meta"),

55 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

56 
ngx_c⁄f_£t_íum_¶Ÿ
,

57 
NGX_RTMP_APP_CONF_OFFSET
,

58 
off£tof
(
ngx_πmp_codec_≠p_c⁄f_t
, 
mëa
),

59 &
ngx_πmp_codec_mëa_¶Ÿs
 },

61 
ngx_nuŒ_comm™d


65 
ngx_πmp_moduÀ_t
 
	gngx_πmp_codec_moduÀ_˘x
 = {

66 
NULL
,

67 
ngx_πmp_codec_po°c⁄figuøti⁄
,

68 
NULL
,

69 
NULL
,

70 
NULL
,

71 
NULL
,

72 
ngx_πmp_codec_¸óã_≠p_c⁄f
,

73 
ngx_πmp_codec_mîge_≠p_c⁄f


77 
ngx_moduÀ_t
 
	gngx_πmp_codec_moduÀ
 = {

78 
NGX_MODULE_V1
,

79 &
ngx_πmp_codec_moduÀ_˘x
,

80 
ngx_πmp_codec_comm™ds
,

81 
NGX_RTMP_MODULE
,

82 
NULL
,

83 
NULL
,

84 
NULL
,

85 
NULL
,

86 
NULL
,

87 
NULL
,

88 
NULL
,

89 
NGX_MODULE_V1_PADDING


94 
	gaudio_codecs
[] = {

116 
	gvideo_codecs
[] = {

128 
u_ch¨
 *

129 
	$ngx_πmp_gë_audio_codec_«me
(
ngx_uöt_t
 
id
)

131  (
u_ch¨
 *)(
id
 < (
audio_codecs
) / (audio_codecs[0])

132 ? 
audio_codecs
[
id
]

134 
	}
}

137 
u_ch¨
 *

138 
	$ngx_πmp_gë_video_codec_«me
(
ngx_uöt_t
 
id
)

140  (
u_ch¨
 *)(
id
 < (
video_codecs
) / (video_codecs[0])

141 ? 
video_codecs
[
id
]

143 
	}
}

146 
ngx_uöt_t


147 
	$ngx_πmp_codec_gë_√xt_vîsi⁄
()

149 
ngx_uöt_t
 
v
;

150 
ngx_uöt_t
 
vîsi⁄
;

153 
v
 = ++
vîsi⁄
;

154 } 
v
 == 0);

156  
v
;

157 
	}
}

160 
ngx_öt_t


161 
	$ngx_πmp_codec_disc⁄√˘
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

162 
ngx_chaö_t
 *
ö
)

164 
ngx_πmp_codec_˘x_t
 *
˘x
;

165 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

167 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

168 i‡(
˘x
 =
NULL
) {

169  
NGX_OK
;

172 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

174 i‡(
˘x
->
avc_hódî
) {

175 
	`ngx_πmp_‰ì_sh¨ed_chaö
(
cscf
, 
˘x
->
avc_hódî
);

176 
˘x
->
avc_hódî
 = 
NULL
;

179 i‡(
˘x
->
Øc_hódî
) {

180 
	`ngx_πmp_‰ì_sh¨ed_chaö
(
cscf
, 
˘x
->
Øc_hódî
);

181 
˘x
->
Øc_hódî
 = 
NULL
;

184 i‡(
˘x
->
mëa
) {

185 
	`ngx_πmp_‰ì_sh¨ed_chaö
(
cscf
, 
˘x
->
mëa
);

186 
˘x
->
mëa
 = 
NULL
;

189  
NGX_OK
;

190 
	}
}

193 
ngx_öt_t


194 
	$ngx_πmp_codec_av
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

195 
ngx_chaö_t
 *
ö
)

197 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

198 
ngx_πmp_codec_˘x_t
 *
˘x
;

199 
ngx_chaö_t
 **
hódî
;

200 
uöt8_t
 
fmt
;

201 
ngx_uöt_t
 
ßm∂e_øãs
[] =

204 i‡(
h
->
ty≥
 !
NGX_RTMP_MSG_AUDIO
 && h->ty≥ !
NGX_RTMP_MSG_VIDEO
) {

205  
NGX_OK
;

208 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

209 i‡(
˘x
 =
NULL
) {

210 
˘x
 = 
	`ngx_pˇŒoc
(
s
->
c⁄√˘i⁄
->
poﬁ
, (
ngx_πmp_codec_˘x_t
));

211 
	`ngx_πmp_£t_˘x
(
s
, 
˘x
, 
ngx_πmp_codec_moduÀ
);

215 i‡(
ö
->
buf
->
œ°
 - in->buf->
pos
 < 1) {

216  
NGX_OK
;

219 
fmt
 = 
ö
->
buf
->
pos
[0];

220 i‡(
h
->
ty≥
 =
NGX_RTMP_MSG_AUDIO
) {

221 
˘x
->
audio_codec_id
 = (
fmt
 & 0xf0) >> 4;

222 
˘x
->
audio_ch™√ls
 = (
fmt
 & 0x01) + 1;

223 
˘x
->
ßm∂e_size
 = (
fmt
 & 0x02) ? 2 : 1;

225 i‡(
˘x
->
ßm∂e_øã
 == 0) {

226 
˘x
->
ßm∂e_øã
 = 
ßm∂e_øãs
[(
fmt
 & 0x0c) >> 2];

229 
˘x
->
video_codec_id
 = (
fmt
 & 0x0f);

233 i‡(
ö
->
buf
->
œ°
 - in->buf->
pos
 < 3) {

234  
NGX_OK
;

238 i‡(!
	`ngx_πmp_is_codec_hódî
(
ö
)) {

239  
NGX_OK
;

242 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

243 
hódî
 = 
NULL
;

245 i‡(
h
->
ty≥
 =
NGX_RTMP_MSG_AUDIO
) {

246 i‡(
˘x
->
audio_codec_id
 =
NGX_RTMP_AUDIO_AAC
) {

247 
hódî
 = &
˘x
->
Øc_hódî
;

248 
	`ngx_πmp_codec_∑r£_Øc_hódî
(
s
, 
ö
);

251 i‡(
˘x
->
video_codec_id
 =
NGX_RTMP_VIDEO_H264
) {

252 
hódî
 = &
˘x
->
avc_hódî
;

253 
	`ngx_πmp_codec_∑r£_avc_hódî
(
s
, 
ö
);

257 i‡(
hódî
 =
NULL
) {

258  
NGX_OK
;

261 i‡(*
hódî
) {

262 
	`ngx_πmp_‰ì_sh¨ed_chaö
(
cscf
, *
hódî
);

265 *
hódî
 = 
	`ngx_πmp_≠≥nd_sh¨ed_bufs
(
cscf
, 
NULL
, 
ö
);

267  
NGX_OK
;

268 
	}
}

272 
	$ngx_πmp_codec_∑r£_Øc_hódî
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_chaö_t
 *
ö
)

274 
ngx_uöt_t
 
idx
;

275 
ngx_πmp_codec_˘x_t
 *
˘x
;

276 
ngx_πmp_bô_ªadî_t
 
br
;

278 
ngx_uöt_t
 
Øc_ßm∂e_øãs
[] =

284 #i‡(
NGX_DEBUG
)

285 
	`ngx_πmp_codec_dump_hódî
(
s
, "Øc", 
ö
);

288 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

290 
	`ngx_πmp_bô_öô_ªadî
(&
br
, 
ö
->
buf
->
pos
, in->buf->
œ°
);

292 
	`ngx_πmp_bô_ªad
(&
br
, 16);

294 
˘x
->
Øc_¥ofûe
 = (
ngx_uöt_t
Ë
	`ngx_πmp_bô_ªad
(&
br
, 5);

295 i‡(
˘x
->
Øc_¥ofûe
 == 31) {

296 
˘x
->
Øc_¥ofûe
 = (
ngx_uöt_t
Ë
	`ngx_πmp_bô_ªad
(&
br
, 6) + 32;

299 
idx
 = (
ngx_uöt_t
Ë
	`ngx_πmp_bô_ªad
(&
br
, 4);

300 i‡(
idx
 == 15) {

301 
˘x
->
ßm∂e_øã
 = (
ngx_uöt_t
Ë
	`ngx_πmp_bô_ªad
(&
br
, 24);

303 
˘x
->
ßm∂e_øã
 = 
Øc_ßm∂e_øãs
[
idx
];

306 
˘x
->
Øc_ch™_c⁄f
 = (
ngx_uöt_t
Ë
	`ngx_πmp_bô_ªad
(&
br
, 4);

308 i‡(
˘x
->
Øc_¥ofûe
 == 5 || ctx->aac_profile == 29) {

310 i‡(
˘x
->
Øc_¥ofûe
 == 29) {

311 
˘x
->
Øc_ps
 = 1;

314 
˘x
->
Øc_sbr
 = 1;

316 
idx
 = (
ngx_uöt_t
Ë
	`ngx_πmp_bô_ªad
(&
br
, 4);

317 i‡(
idx
 == 15) {

318 
˘x
->
ßm∂e_øã
 = (
ngx_uöt_t
Ë
	`ngx_πmp_bô_ªad
(&
br
, 24);

320 
˘x
->
ßm∂e_øã
 = 
Øc_ßm∂e_øãs
[
idx
];

323 
˘x
->
Øc_¥ofûe
 = (
ngx_uöt_t
Ë
	`ngx_πmp_bô_ªad
(&
br
, 5);

324 i‡(
˘x
->
Øc_¥ofûe
 == 31) {

325 
˘x
->
Øc_¥ofûe
 = (
ngx_uöt_t
Ë
	`ngx_πmp_bô_ªad
(&
br
, 6) + 32;

350 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

353 
˘x
->
Øc_¥ofûe
, ctx->
ßm∂e_øã
, ctx->
Øc_ch™_c⁄f
);

354 
	}
}

358 
	$ngx_πmp_codec_∑r£_avc_hódî
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_chaö_t
 *
ö
)

360 
ngx_uöt_t
 
¥ofûe_idc
, 
width
, 
height
, 
¸›_À·
, 
¸›_right
,

361 
¸›_t›
, 
¸›_bŸtom
, 
‰ame_mbs_⁄ly
, 
n
, 
cf_idc
,

362 
num_ªf_‰ames
;

363 
ngx_πmp_codec_˘x_t
 *
˘x
;

364 
ngx_πmp_bô_ªadî_t
 
br
;

366 #i‡(
NGX_DEBUG
)

367 
	`ngx_πmp_codec_dump_hódî
(
s
, "avc", 
ö
);

370 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

372 
	`ngx_πmp_bô_öô_ªadî
(&
br
, 
ö
->
buf
->
pos
, in->buf->
œ°
);

374 
	`ngx_πmp_bô_ªad
(&
br
, 48);

376 
˘x
->
avc_¥ofûe
 = (
ngx_uöt_t
Ë
	`ngx_πmp_bô_ªad_8
(&
br
);

377 
˘x
->
avc_com∑t
 = (
ngx_uöt_t
Ë
	`ngx_πmp_bô_ªad_8
(&
br
);

378 
˘x
->
avc_Àvñ
 = (
ngx_uöt_t
Ë
	`ngx_πmp_bô_ªad_8
(&
br
);

381 
˘x
->
avc_«l_byãs
 = (
ngx_uöt_t
Ë((
	`ngx_πmp_bô_ªad_8
(&
br
) & 0x03) + 1);

384 i‡((
	`ngx_πmp_bô_ªad_8
(&
br
) & 0x1f) == 0) {

389 
	`ngx_πmp_bô_ªad
(&
br
, 16);

392 i‡(
	`ngx_πmp_bô_ªad_8
(&
br
) != 0x67) {

399 
¥ofûe_idc
 = (
ngx_uöt_t
Ë
	`ngx_πmp_bô_ªad
(&
br
, 8);

402 
	`ngx_πmp_bô_ªad
(&
br
, 8);

405 
	`ngx_πmp_bô_ªad
(&
br
, 8);

408 
	`ngx_πmp_bô_ªad_gﬁomb
(&
br
);

410 i‡(
¥ofûe_idc
 == 100 ||Örofile_idc == 110 ||

411 
¥ofûe_idc
 == 122 ||Örofile_idc == 244 ||Örofile_idc == 44 ||

412 
¥ofûe_idc
 == 83 ||Örofile_idc == 86 ||Örofile_idc == 118)

415 
cf_idc
 = (
ngx_uöt_t
Ë
	`ngx_πmp_bô_ªad_gﬁomb
(&
br
);

417 i‡(
cf_idc
 == 3) {

420 
	`ngx_πmp_bô_ªad
(&
br
, 1);

424 
	`ngx_πmp_bô_ªad_gﬁomb
(&
br
);

427 
	`ngx_πmp_bô_ªad_gﬁomb
(&
br
);

430 
	`ngx_πmp_bô_ªad
(&
br
, 1);

433 i‡(
	`ngx_πmp_bô_ªad
(&
br
, 1)) {

435 
n
 = 0;Ç < (
cf_idc
 != 3 ? 8u : 12u);Ç++) {

438 i‡(
	`ngx_πmp_bô_ªad
(&
br
, 1)) {

451 
	`ngx_πmp_bô_ªad_gﬁomb
(&
br
);

454 
	`ngx_πmp_bô_ªad_gﬁomb
(&
br
)) {

458 
	`ngx_πmp_bô_ªad_gﬁomb
(&
br
);

464 
	`ngx_πmp_bô_ªad
(&
br
, 1);

467 
	`ngx_πmp_bô_ªad_gﬁomb
(&
br
);

470 
	`ngx_πmp_bô_ªad_gﬁomb
(&
br
);

473 
num_ªf_‰ames
 = (
ngx_uöt_t
Ë
	`ngx_πmp_bô_ªad_gﬁomb
(&
br
);

475 
n
 = 0;Ç < 
num_ªf_‰ames
;Ç++) {

478 
	`ngx_πmp_bô_ªad_gﬁomb
(&
br
);

483 
˘x
->
avc_ªf_‰ames
 = (
ngx_uöt_t
Ë
	`ngx_πmp_bô_ªad_gﬁomb
(&
br
);

486 
	`ngx_πmp_bô_ªad
(&
br
, 1);

489 
width
 = (
ngx_uöt_t
Ë
	`ngx_πmp_bô_ªad_gﬁomb
(&
br
);

492 
height
 = (
ngx_uöt_t
Ë
	`ngx_πmp_bô_ªad_gﬁomb
(&
br
);

495 
‰ame_mbs_⁄ly
 = (
ngx_uöt_t
Ë
	`ngx_πmp_bô_ªad
(&
br
, 1);

497 i‡(!
‰ame_mbs_⁄ly
) {

500 
	`ngx_πmp_bô_ªad
(&
br
, 1);

504 
	`ngx_πmp_bô_ªad
(&
br
, 1);

507 i‡(
	`ngx_πmp_bô_ªad
(&
br
, 1)) {

509 
¸›_À·
 = (
ngx_uöt_t
Ë
	`ngx_πmp_bô_ªad_gﬁomb
(&
br
);

510 
¸›_right
 = (
ngx_uöt_t
Ë
	`ngx_πmp_bô_ªad_gﬁomb
(&
br
);

511 
¸›_t›
 = (
ngx_uöt_t
Ë
	`ngx_πmp_bô_ªad_gﬁomb
(&
br
);

512 
¸›_bŸtom
 = (
ngx_uöt_t
Ë
	`ngx_πmp_bô_ªad_gﬁomb
(&
br
);

516 
¸›_À·
 = 0;

517 
¸›_right
 = 0;

518 
¸›_t›
 = 0;

519 
¸›_bŸtom
 = 0;

522 
˘x
->
width
 = (width + 1Ë* 16 - (
¸›_À·
 + 
¸›_right
) * 2;

523 
˘x
->
height
 = (2 - 
‰ame_mbs_⁄ly
) * (height + 1) * 16 -

524 (
¸›_t›
 + 
¸›_bŸtom
) * 2;

526 
	`ngx_log_debug7
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

530 
˘x
->
avc_¥ofûe
, ctx->
avc_com∑t
, ctx->
avc_Àvñ
,

531 
˘x
->
avc_«l_byãs
, ctx->
avc_ªf_‰ames
,

532 
˘x
->
width
, ctx->
height
);

533 
	}
}

536 #i‡(
NGX_DEBUG
)

538 
	$ngx_πmp_codec_dump_hódî
(
ngx_πmp_£ssi⁄_t
 *
s
, c⁄° *
ty≥
,

539 
ngx_chaö_t
 *
ö
)

541 
u_ch¨
 
buf
[256], *
p
, *
µ
;

542 
u_ch¨
 
hex
[] = "0123456789abcdef";

544 
µ
 = 
buf
, 
p
 = 
ö
->buf->
pos
;

545 
p
 < 
ö
->
buf
->
œ°
 && 
µ
 < buf + (buf) - 1;

546 ++
p
)

548 *
µ
++ = 
hex
[*
p
 >> 4];

549 *
µ
++ = 
hex
[*
p
 & 0x0f];

552 *
µ
 = 0;

554 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

555 "codec: %†hódî %s", 
ty≥
, 
buf
);

556 
	}
}

560 
ngx_öt_t


561 
	$ngx_πmp_codec_ªc⁄°ru˘_mëa
(
ngx_πmp_£ssi⁄_t
 *
s
)

563 
ngx_πmp_codec_˘x_t
 *
˘x
;

564 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

565 
ngx_öt_t
 
rc
;

568 
width
;

569 
height
;

570 
duøti⁄
;

571 
‰ame_øã
;

572 
video_d©a_øã
;

573 
video_codec_id
;

574 
audio_d©a_øã
;

575 
audio_codec_id
;

576 
u_ch¨
 
¥ofûe
[32];

577 
u_ch¨
 
Àvñ
[32];

578 } 
v
;

580 
ngx_πmp_amf_ñt_t
 
out_öf
[] = {

582 { 
NGX_RTMP_AMF_STRING
,

583 
	`ngx_°rög
("Server"),

586 { 
NGX_RTMP_AMF_NUMBER
,

587 
	`ngx_°rög
("width"),

588 &
v
.
width
, 0 },

590 { 
NGX_RTMP_AMF_NUMBER
,

591 
	`ngx_°rög
("height"),

592 &
v
.
height
, 0 },

594 { 
NGX_RTMP_AMF_NUMBER
,

595 
	`ngx_°rög
("displayWidth"),

596 &
v
.
width
, 0 },

598 { 
NGX_RTMP_AMF_NUMBER
,

599 
	`ngx_°rög
("displayHeight"),

600 &
v
.
height
, 0 },

602 { 
NGX_RTMP_AMF_NUMBER
,

603 
	`ngx_°rög
("duration"),

604 &
v
.
duøti⁄
, 0 },

606 { 
NGX_RTMP_AMF_NUMBER
,

607 
	`ngx_°rög
("framerate"),

608 &
v
.
‰ame_øã
, 0 },

610 { 
NGX_RTMP_AMF_NUMBER
,

611 
	`ngx_°rög
("fps"),

612 &
v
.
‰ame_øã
, 0 },

614 { 
NGX_RTMP_AMF_NUMBER
,

615 
	`ngx_°rög
("videodatarate"),

616 &
v
.
video_d©a_øã
, 0 },

618 { 
NGX_RTMP_AMF_NUMBER
,

619 
	`ngx_°rög
("videocodecid"),

620 &
v
.
video_codec_id
, 0 },

622 { 
NGX_RTMP_AMF_NUMBER
,

623 
	`ngx_°rög
("audiodatarate"),

624 &
v
.
audio_d©a_øã
, 0 },

626 { 
NGX_RTMP_AMF_NUMBER
,

627 
	`ngx_°rög
("audiocodecid"),

628 &
v
.
audio_codec_id
, 0 },

630 { 
NGX_RTMP_AMF_STRING
,

631 
	`ngx_°rög
("profile"),

632 &
v
.
¥ofûe
, (v.profile) },

634 { 
NGX_RTMP_AMF_STRING
,

635 
	`ngx_°rög
("level"),

636 &
v
.
Àvñ
, (v.level) },

639 
ngx_πmp_amf_ñt_t
 
out_ñts
[] = {

641 { 
NGX_RTMP_AMF_STRING
,

642 
ngx_nuŒ_°rög
,

645 { 
NGX_RTMP_AMF_OBJECT
,

646 
ngx_nuŒ_°rög
,

647 
out_öf
, (out_inf) },

650 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

651 i‡(
˘x
 =
NULL
) {

652  
NGX_OK
;

655 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

657 i‡(
˘x
->
mëa
) {

658 
	`ngx_πmp_‰ì_sh¨ed_chaö
(
cscf
, 
˘x
->
mëa
);

659 
˘x
->
mëa
 = 
NULL
;

662 
v
.
width
 = 
˘x
->width;

663 
v
.
height
 = 
˘x
->height;

664 
v
.
duøti⁄
 = 
˘x
->duration;

665 
v
.
‰ame_øã
 = 
˘x
->frame_rate;

666 
v
.
video_d©a_øã
 = 
˘x
->video_data_rate;

667 
v
.
video_codec_id
 = 
˘x
->video_codec_id;

668 
v
.
audio_d©a_øã
 = 
˘x
->audio_data_rate;

669 
v
.
audio_codec_id
 = 
˘x
->audio_codec_id;

670 
	`ngx_mem˝y
(
v
.
¥ofûe
, 
˘x
->profile, (ctx->profile));

671 
	`ngx_mem˝y
(
v
.
Àvñ
, 
˘x
->level, (ctx->level));

673 
rc
 = 
	`ngx_πmp_≠≥nd_amf
(
s
, &
˘x
->
mëa
, 
NULL
, 
out_ñts
,

674 (
out_ñts
) / (out_elts[0]));

675 i‡(
rc
 !
NGX_OK
 || 
˘x
->
mëa
 =
NULL
) {

676  
NGX_ERROR
;

679  
	`ngx_πmp_codec_¥ï¨e_mëa
(
s
, 0);

680 
	}
}

683 
ngx_öt_t


684 
	$ngx_πmp_codec_c›y_mëa
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

685 
ngx_chaö_t
 *
ö
)

687 
ngx_πmp_codec_˘x_t
 *
˘x
;

688 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

690 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

692 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

694 i‡(
˘x
->
mëa
) {

695 
	`ngx_πmp_‰ì_sh¨ed_chaö
(
cscf
, 
˘x
->
mëa
);

698 
˘x
->
mëa
 = 
	`ngx_πmp_≠≥nd_sh¨ed_bufs
(
cscf
, 
NULL
, 
ö
);

700 i‡(
˘x
->
mëa
 =
NULL
) {

701  
NGX_ERROR
;

704  
	`ngx_πmp_codec_¥ï¨e_mëa
(
s
, 
h
->
time°amp
);

705 
	}
}

708 
ngx_öt_t


709 
	$ngx_πmp_codec_¥ï¨e_mëa
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
time°amp
)

711 
ngx_πmp_hódî_t
 
h
;

712 
ngx_πmp_codec_˘x_t
 *
˘x
;

714 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

716 
	`ngx_memzîo
(&
h
, (h));

717 
h
.
csid
 = 
NGX_RTMP_CSID_AMF
;

718 
h
.
msid
 = 
NGX_RTMP_MSID
;

719 
h
.
ty≥
 = 
NGX_RTMP_MSG_AMF_META
;

720 
h
.
time°amp
 =Åimestamp;

721 
	`ngx_πmp_¥ï¨e_mesßge
(
s
, &
h
, 
NULL
, 
˘x
->
mëa
);

723 
˘x
->
mëa_vîsi⁄
 = 
	`ngx_πmp_codec_gë_√xt_vîsi⁄
();

725  
NGX_OK
;

726 
	}
}

729 
ngx_öt_t


730 
	$ngx_πmp_codec_mëa_d©a
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

731 
ngx_chaö_t
 *
ö
)

733 
ngx_πmp_codec_≠p_c⁄f_t
 *
ˇcf
;

734 
ngx_πmp_codec_˘x_t
 *
˘x
;

735 
ngx_uöt_t
 
skù
;

738 
width
;

739 
height
;

740 
duøti⁄
;

741 
‰ame_øã
;

742 
video_d©a_øã
;

743 
video_codec_id_n
;

744 
u_ch¨
 
video_codec_id_s
[32];

745 
audio_d©a_øã
;

746 
audio_codec_id_n
;

747 
u_ch¨
 
audio_codec_id_s
[32];

748 
u_ch¨
 
¥ofûe
[32];

749 
u_ch¨
 
Àvñ
[32];

750 } 
v
;

752 
ngx_πmp_amf_ñt_t
 
ö_video_codec_id
[] = {

754 { 
NGX_RTMP_AMF_NUMBER
,

755 
ngx_nuŒ_°rög
,

756 &
v
.
video_codec_id_n
, 0 },

758 { 
NGX_RTMP_AMF_STRING
,

759 
ngx_nuŒ_°rög
,

760 &
v
.
video_codec_id_s
, (v.video_codec_id_s) },

763 
ngx_πmp_amf_ñt_t
 
ö_audio_codec_id
[] = {

765 { 
NGX_RTMP_AMF_NUMBER
,

766 
ngx_nuŒ_°rög
,

767 &
v
.
audio_codec_id_n
, 0 },

769 { 
NGX_RTMP_AMF_STRING
,

770 
ngx_nuŒ_°rög
,

771 &
v
.
audio_codec_id_s
, (v.audio_codec_id_s) },

774 
ngx_πmp_amf_ñt_t
 
ö_öf
[] = {

776 { 
NGX_RTMP_AMF_NUMBER
,

777 
	`ngx_°rög
("width"),

778 &
v
.
width
, 0 },

780 { 
NGX_RTMP_AMF_NUMBER
,

781 
	`ngx_°rög
("height"),

782 &
v
.
height
, 0 },

784 { 
NGX_RTMP_AMF_NUMBER
,

785 
	`ngx_°rög
("duration"),

786 &
v
.
duøti⁄
, 0 },

788 { 
NGX_RTMP_AMF_NUMBER
,

789 
	`ngx_°rög
("framerate"),

790 &
v
.
‰ame_øã
, 0 },

792 { 
NGX_RTMP_AMF_NUMBER
,

793 
	`ngx_°rög
("fps"),

794 &
v
.
‰ame_øã
, 0 },

796 { 
NGX_RTMP_AMF_NUMBER
,

797 
	`ngx_°rög
("videodatarate"),

798 &
v
.
video_d©a_øã
, 0 },

800 { 
NGX_RTMP_AMF_VARIANT
,

801 
	`ngx_°rög
("videocodecid"),

802 
ö_video_codec_id
, (in_video_codec_id) },

804 { 
NGX_RTMP_AMF_NUMBER
,

805 
	`ngx_°rög
("audiodatarate"),

806 &
v
.
audio_d©a_øã
, 0 },

808 { 
NGX_RTMP_AMF_VARIANT
,

809 
	`ngx_°rög
("audiocodecid"),

810 
ö_audio_codec_id
, (in_audio_codec_id) },

812 { 
NGX_RTMP_AMF_STRING
,

813 
	`ngx_°rög
("profile"),

814 &
v
.
¥ofûe
, (v.profile) },

816 { 
NGX_RTMP_AMF_STRING
,

817 
	`ngx_°rög
("level"),

818 &
v
.
Àvñ
, (v.level) },

821 
ngx_πmp_amf_ñt_t
 
ö_ñts
[] = {

823 { 
NGX_RTMP_AMF_STRING
,

824 
ngx_nuŒ_°rög
,

825 
NULL
, 0 },

827 { 
NGX_RTMP_AMF_OBJECT
,

828 
ngx_nuŒ_°rög
,

829 
ö_öf
, (in_inf) },

832 
ˇcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_codec_moduÀ
);

834 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

835 i‡(
˘x
 =
NULL
) {

836 
˘x
 = 
	`ngx_pˇŒoc
(
s
->
c⁄√˘i⁄
->
poﬁ
, (
ngx_πmp_codec_˘x_t
));

837 
	`ngx_πmp_£t_˘x
(
s
, 
˘x
, 
ngx_πmp_codec_moduÀ
);

840 
	`ngx_memzîo
(&
v
, (v));

844 
v
.
audio_codec_id_n
 = -1;

847 
skù
 = !(
ö
->
buf
->
œ°
 > in->buf->
pos


848 && *
ö
->
buf
->
pos
 =
NGX_RTMP_AMF_STRING
);

849 i‡(
	`ngx_πmp_ª˚ive_amf
(
s
, 
ö
, 
ö_ñts
 + 
skù
,

850 (
ö_ñts
Ë/ (ö_ñts[0]Ë- 
skù
))

852 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

854  
NGX_OK
;

857 
˘x
->
width
 = (
ngx_uöt_t
Ë
v
.width;

858 
˘x
->
height
 = (
ngx_uöt_t
Ë
v
.height;

859 
˘x
->
duøti⁄
 = (
ngx_uöt_t
Ë
v
.duration;

860 
˘x
->
‰ame_øã
 = (
ngx_uöt_t
Ë
v
.frame_rate;

861 
˘x
->
video_d©a_øã
 = (
ngx_uöt_t
Ë
v
.video_data_rate;

862 
˘x
->
video_codec_id
 = (
ngx_uöt_t
Ë
v
.
video_codec_id_n
;

863 
˘x
->
audio_d©a_øã
 = (
ngx_uöt_t
Ë
v
.audio_data_rate;

864 
˘x
->
audio_codec_id
 = (
v
.
audio_codec_id_n
 == -1

865 ? 0 : 
v
.
audio_codec_id_n
 == 0

866 ? 
NGX_RTMP_AUDIO_UNCOMPRESSED
 : (
ngx_uöt_t
Ë
v
.
audio_codec_id_n
);

867 
	`ngx_mem˝y
(
˘x
->
¥ofûe
, 
v
.profile, (v.profile));

868 
	`ngx_mem˝y
(
˘x
->
Àvñ
, 
v
.level, (v.level));

870 
	`ngx_log_debug8
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

874 
˘x
->
width
, ctx->
height
, ctx->
duøti⁄
, ctx->
‰ame_øã
,

875 
	`ngx_πmp_gë_video_codec_«me
(
˘x
->
video_codec_id
),

876 
˘x
->
video_codec_id
,

877 
	`ngx_πmp_gë_audio_codec_«me
(
˘x
->
audio_codec_id
),

878 
˘x
->
audio_codec_id
);

880 
ˇcf
->
mëa
) {

881 
NGX_RTMP_CODEC_META_ON
:

882  
	`ngx_πmp_codec_ªc⁄°ru˘_mëa
(
s
);

883 
NGX_RTMP_CODEC_META_COPY
:

884  
	`ngx_πmp_codec_c›y_mëa
(
s
, 
h
, 
ö
);

889  
NGX_OK
;

890 
	}
}

894 
	$ngx_πmp_codec_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
)

896 
ngx_πmp_codec_≠p_c⁄f_t
 *
ˇcf
;

898 
ˇcf
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_codec_≠p_c⁄f_t
));

899 i‡(
ˇcf
 =
NULL
) {

900  
NULL
;

903 
ˇcf
->
mëa
 = 
NGX_CONF_UNSET_UINT
;

905  
ˇcf
;

906 
	}
}

910 
	$ngx_πmp_codec_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
∑ª¡
, *
chûd
)

912 
ngx_πmp_codec_≠p_c⁄f_t
 *
¥ev
 = 
∑ª¡
;

913 
ngx_πmp_codec_≠p_c⁄f_t
 *
c⁄f
 = 
chûd
;

915 
	`ngx_c⁄f_mîge_uöt_vÆue
(
c⁄f
->
mëa
, 
¥ev
->mëa, 
NGX_RTMP_CODEC_META_ON
);

917  
NGX_CONF_OK
;

918 
	}
}

921 
ngx_öt_t


922 
	$ngx_πmp_codec_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
)

924 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
;

925 
ngx_πmp_h™dÀr_±
 *
h
;

926 
ngx_πmp_amf_h™dÀr_t
 *
ch
;

928 
cmcf
 = 
	`ngx_πmp_c⁄f_gë_moduÀ_maö_c⁄f
(
cf
, 
ngx_πmp_c‹e_moduÀ
);

930 
h
 = 
	`ngx_¨øy_push
(&
cmcf
->
evíts
[
NGX_RTMP_MSG_AUDIO
]);

931 *
h
 = 
ngx_πmp_codec_av
;

933 
h
 = 
	`ngx_¨øy_push
(&
cmcf
->
evíts
[
NGX_RTMP_MSG_VIDEO
]);

934 *
h
 = 
ngx_πmp_codec_av
;

936 
h
 = 
	`ngx_¨øy_push
(&
cmcf
->
evíts
[
NGX_RTMP_DISCONNECT
]);

937 *
h
 = 
ngx_πmp_codec_disc⁄√˘
;

940 
ch
 = 
	`ngx_¨øy_push
(&
cmcf
->
amf
);

941 i‡(
ch
 =
NULL
) {

942  
NGX_ERROR
;

944 
	`ngx_°r_£t
(&
ch
->
«me
, "@setDataFrame");

945 
ch
->
h™dÀr
 = 
ngx_πmp_codec_mëa_d©a
;

947 
ch
 = 
	`ngx_¨øy_push
(&
cmcf
->
amf
);

948 i‡(
ch
 =
NULL
) {

949  
NGX_ERROR
;

951 
	`ngx_°r_£t
(&
ch
->
«me
, "onMetaData");

952 
ch
->
h™dÀr
 = 
ngx_πmp_codec_mëa_d©a
;

955  
NGX_OK
;

956 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_codec_module.h

7 #i‚de‡
_NGX_RTMP_CODEC_H_INCLUDED_


8 
	#_NGX_RTMP_CODEC_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

13 
	~"ngx_πmp.h
"

20 
	mNGX_RTMP_AUDIO_UNCOMPRESSED
 = 16,

21 
	mNGX_RTMP_AUDIO_ADPCM
 = 1,

22 
	mNGX_RTMP_AUDIO_MP3
 = 2,

23 
	mNGX_RTMP_AUDIO_LINEAR_LE
 = 3,

24 
	mNGX_RTMP_AUDIO_NELLY16
 = 4,

25 
	mNGX_RTMP_AUDIO_NELLY8
 = 5,

26 
	mNGX_RTMP_AUDIO_NELLY
 = 6,

27 
	mNGX_RTMP_AUDIO_G711A
 = 7,

28 
	mNGX_RTMP_AUDIO_G711U
 = 8,

29 
	mNGX_RTMP_AUDIO_AAC
 = 10,

30 
	mNGX_RTMP_AUDIO_SPEEX
 = 11,

31 
	mNGX_RTMP_AUDIO_MP3_8
 = 14,

32 
	mNGX_RTMP_AUDIO_DEVSPEC
 = 15,

38 
	mNGX_RTMP_VIDEO_JPEG
 = 1,

39 
	mNGX_RTMP_VIDEO_SORENSON_H263
 = 2,

40 
	mNGX_RTMP_VIDEO_SCREEN
 = 3,

41 
	mNGX_RTMP_VIDEO_ON2_VP6
 = 4,

42 
	mNGX_RTMP_VIDEO_ON2_VP6_ALPHA
 = 5,

43 
	mNGX_RTMP_VIDEO_SCREEN2
 = 6,

44 
	mNGX_RTMP_VIDEO_H264
 = 7

48 
u_ch¨
 * 
ngx_πmp_gë_audio_codec_«me
(
ngx_uöt_t
 
id
);

49 
u_ch¨
 * 
ngx_πmp_gë_video_codec_«me
(
ngx_uöt_t
 
id
);

53 
ngx_uöt_t
 
	mwidth
;

54 
ngx_uöt_t
 
	mheight
;

55 
ngx_uöt_t
 
	mduøti⁄
;

56 
ngx_uöt_t
 
	m‰ame_øã
;

57 
ngx_uöt_t
 
	mvideo_d©a_øã
;

58 
ngx_uöt_t
 
	mvideo_codec_id
;

59 
ngx_uöt_t
 
	maudio_d©a_øã
;

60 
ngx_uöt_t
 
	maudio_codec_id
;

61 
ngx_uöt_t
 
	mØc_¥ofûe
;

62 
ngx_uöt_t
 
	mØc_ch™_c⁄f
;

63 
ngx_uöt_t
 
	mØc_sbr
;

64 
ngx_uöt_t
 
	mØc_ps
;

65 
ngx_uöt_t
 
	mavc_¥ofûe
;

66 
ngx_uöt_t
 
	mavc_com∑t
;

67 
ngx_uöt_t
 
	mavc_Àvñ
;

68 
ngx_uöt_t
 
	mavc_«l_byãs
;

69 
ngx_uöt_t
 
	mavc_ªf_‰ames
;

70 
ngx_uöt_t
 
	mßm∂e_øã
;

71 
ngx_uöt_t
 
	mßm∂e_size
;

72 
ngx_uöt_t
 
	maudio_ch™√ls
;

73 
u_ch¨
 
	m¥ofûe
[32];

74 
u_ch¨
 
	mÀvñ
[32];

76 
ngx_chaö_t
 *
	mavc_hódî
;

77 
ngx_chaö_t
 *
	mØc_hódî
;

79 
ngx_chaö_t
 *
	mmëa
;

80 
ngx_uöt_t
 
	mmëa_vîsi⁄
;

81 } 
	tngx_πmp_codec_˘x_t
;

84 
ngx_moduÀ_t
 
ngx_πmp_codec_moduÀ
;

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_control_module.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~<ngx_hâp.h
>

10 
	~"ngx_πmp.h
"

11 
	~"ngx_πmp_live_moduÀ.h
"

12 
	~"ngx_πmp_ªc‹d_moduÀ.h
"

15 *
ngx_πmp_c⁄åﬁ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

16 * 
ngx_πmp_c⁄åﬁ_¸óã_loc_c⁄f
(
ngx_c⁄f_t
 *
cf
);

17 * 
ngx_πmp_c⁄åﬁ_mîge_loc_c⁄f
(
ngx_c⁄f_t
 *
cf
,

18 *
∑ª¡
, *
chûd
);

21 c⁄° * (*
	tngx_πmp_c⁄åﬁ_h™dÀr_t
)(
	tngx_hâp_ªque°_t
 *
	tr
,

22 
	tngx_πmp_£ssi⁄_t
 *);

25 
	#NGX_RTMP_CONTROL_ALL
 0xff

	)

26 
	#NGX_RTMP_CONTROL_RECORD
 0x01

	)

27 
	#NGX_RTMP_CONTROL_DROP
 0x02

	)

28 
	#NGX_RTMP_CONTROL_REDIRECT
 0x04

	)

32 
	mNGX_RTMP_CONTROL_FILTER_CLIENT
 = 0,

33 
	mNGX_RTMP_CONTROL_FILTER_PUBLISHER
,

34 
	mNGX_RTMP_CONTROL_FILTER_SUBSCRIBER


39 
ngx_uöt_t
 
	mcou¡
;

40 
ngx_°r_t
 
	m∑th
;

41 
ngx_uöt_t
 
	mfûãr
;

42 
ngx_°r_t
 
	mmëhod
;

43 
ngx_¨øy_t
 
	m£ssi⁄s
;

44 } 
	tngx_πmp_c⁄åﬁ_˘x_t
;

47 
ngx_uöt_t
 
	mc⁄åﬁ
;

48 
ngx_Êag_t
 
	mcc_ªc‹d_mode
;

49 } 
	tngx_πmp_c⁄åﬁ_loc_c⁄f_t
;

52 
ngx_c⁄f_bômask_t
 
	gngx_πmp_c⁄åﬁ_masks
[] = {

53 { 
ngx_°rög
("Æl"), 
NGX_RTMP_CONTROL_ALL
 },

54 { 
ngx_°rög
("ªc‹d"), 
NGX_RTMP_CONTROL_RECORD
 },

55 { 
ngx_°rög
("dr›"), 
NGX_RTMP_CONTROL_DROP
 },

56 { 
ngx_°rög
("ªdúe˘"), 
NGX_RTMP_CONTROL_REDIRECT
 },

57 { 
ngx_nuŒ_°rög
, 0 }

61 
ngx_comm™d_t
 
	gngx_πmp_c⁄åﬁ_comm™ds
[] = {

63 { 
ngx_°rög
("rtmp_control"),

64 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

65 
ngx_πmp_c⁄åﬁ
,

66 
NGX_HTTP_LOC_CONF_OFFSET
,

67 
off£tof
(
ngx_πmp_c⁄åﬁ_loc_c⁄f_t
, 
c⁄åﬁ
),

68 
ngx_πmp_c⁄åﬁ_masks
 },

71 { 
ngx_°rög
("cc_record_mode"),

72 
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

73 
ngx_c⁄f_£t_Êag_¶Ÿ
,

74 
NGX_HTTP_LOC_CONF_OFFSET
,

75 
off£tof
(
ngx_πmp_c⁄åﬁ_loc_c⁄f_t
, 
cc_ªc‹d_mode
),

76 
NULL
 },

79 
ngx_nuŒ_comm™d


83 
ngx_hâp_moduÀ_t
 
	gngx_πmp_c⁄åﬁ_moduÀ_˘x
 = {

84 
NULL
,

85 
NULL
,

87 
NULL
,

88 
NULL
,

90 
NULL
,

91 
NULL
,

93 
ngx_πmp_c⁄åﬁ_¸óã_loc_c⁄f
,

94 
ngx_πmp_c⁄åﬁ_mîge_loc_c⁄f
,

98 
ngx_moduÀ_t
 
	gngx_πmp_c⁄åﬁ_moduÀ
 = {

99 
NGX_MODULE_V1
,

100 &
ngx_πmp_c⁄åﬁ_moduÀ_˘x
,

101 
ngx_πmp_c⁄åﬁ_comm™ds
,

102 
NGX_HTTP_MODULE
,

103 
NULL
,

104 
NULL
,

105 
NULL
,

106 
NULL
,

107 
NULL
,

108 
NULL
,

109 
NULL
,

110 
NGX_MODULE_V1_PADDING


115 
ngx_öt_t


116 
	$ngx_föd_queue
(
ngx_queue_t
 *
queue
, 
u_ch¨
 *
«me
)

118 
ngx_öt_t
 
Êag
 = 0;

119 
ngx_queue_t
 *
q
;

121 
q
 = 
	`ngx_queue_hód
(
queue
);

122 
q
 !
	`ngx_queue_£¡öñ
(
queue
);

123 
q
 = 
	`ngx_queue_√xt
(q))

125 
ngx_°ªam_öfo
 *
ªs
 = 
	`ngx_queue_d©a
(
q
,Çgx_°ªam_öfo, 
que
);

127 i‡(
	`ngx_°rcmp
(
ªs
->
°ªam_«me
, 
«me
) == 0) {

128 
Êag
 = 1;

132  
Êag
;

133 
	}
};

137 
	$ngx_queue_ö£π
(
ngx_queue_t
 *
queue
, 
ngx_°ªam_öfo
 *
tmp_öfo
)

139 
	`ngx_queue_öô
(&
tmp_öfo
->
que
);

140 
	`ngx_queue_ö£π_hód
(
queue
, &
tmp_öfo
->
que
);

141 
	}
}

145 
	$ngx_queue_ªmove_°©us
(
ngx_queue_t
 *
queue
, 
u_ch¨
 *
«me
)

147 
ngx_queue_t
 *
q
;

149 
q
 = 
	`ngx_queue_hód
(
queue
);

150 
q
 !
	`ngx_queue_£¡öñ
(
queue
);

151 
q
 = 
	`ngx_queue_√xt
(q))

153 
ngx_°ªam_öfo
 *
ªs
 = 
	`ngx_queue_d©a
(
q
,Çgx_°ªam_öfo, 
que
);

155 i‡(
	`ngx_°rcmp
(
ªs
->
°ªam_«me
, 
«me
) == 0) {

156 
	`ngx_queue_ªmove
(&
ªs
->
que
);

160 
	}
}

183 
	$ngx_πmp_c⁄åﬁ_ªc‹d_h™dÀr
(
ngx_hâp_ªque°_t
 *
r
, 
ngx_πmp_£ssi⁄_t
 *
s
)

185 
ngx_öt_t
 
rc
;

186 
ngx_°r_t
 
ªc
;

187 
ngx_uöt_t
 
∫
;

188 
ngx_πmp_ªc‹d_˘x_t
 *
r˘
;

189 
ngx_πmp_c⁄åﬁ_˘x_t
 *
˘x
;

190 
ngx_πmp_c‹e_≠p_c⁄f_t
 *
ˇcf
;

191 
ngx_πmp_ªc‹d_≠p_c⁄f_t
 *
øcf
;

192 
ngx_πmp_c⁄åﬁ_loc_c⁄f_t
 *
Œcf
;

194 
Œcf
 = 
	`ngx_hâp_gë_moduÀ_loc_c⁄f
(
r
, 
ngx_πmp_c⁄åﬁ_moduÀ
);

196 
ˇcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

197 
øcf
 = 
ˇcf
->
≠p_c⁄f
[
ngx_πmp_ªc‹d_moduÀ
.
˘x_ödex
];

199 i‡(
	`ngx_hâp_¨g
(
r
, (
u_ch¨
 *Ë"ªc", ("ªc"Ë- 1, &
ªc
Ë!
NGX_OK
) {

200 
ªc
.
Àn
 = 0;

203 
∫
 = 
	`ngx_πmp_ªc‹d_föd
(
øcf
, &
ªc
);

204 i‡(
∫
 =
NGX_CONF_UNSET_UINT
) {

208 
˘x
 = 
	`ngx_hâp_gë_moduÀ_˘x
(
r
, 
ngx_πmp_c⁄åﬁ_moduÀ
);

209 
r˘
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªc‹d_moduÀ
);

212 i‡(
˘x
->
mëhod
.
Àn
 == ("start") - 1 &&

213 
	`ngx_°∫cmp
(
˘x
->
mëhod
.
d©a
, "°¨t", ctx->mëhod.
Àn
) == 0)

216 i‡(
Œcf
->
cc_ªc‹d_mode
 == 1)

219 i‡(
	`ngx_föd_queue
(
ngx_πmp_ªc‹d_maö_c⁄f
->
queue
, 
r˘
->
«me
) == 0)

221 
ngx_°ªam_öfo
 *
tmp_öfo
;

222 
tmp_öfo
 = (
ngx_°ªam_öfo
 *)
	`ngx_pˇŒoc
(
ngx_cy˛e
->
poﬁ
, (ngx_stream_info));

223 
tmp_öfo
->
is_vÆid
 = 1;

224 
	`ngx_˝y°∫
(
tmp_öfo
->
°ªam_«me
, 
r˘
->
«me
, 
NGX_RTMP_MAX_NAME
);

226 
	`ngx_queue_ö£π
(
ngx_πmp_ªc‹d_maö_c⁄f
->
queue
, 
tmp_öfo
);

229 
rc
 = 
	`ngx_πmp_ªc‹d_›í
(
s
, 
∫
, &
˘x
->
∑th
);

230 } i‡(
˘x
->
mëhod
.
Àn
 == ("stop") - 1 &&

231 
	`ngx_°∫cmp
(
˘x
->
mëhod
.
d©a
, "°›", ctx->mëhod.
Àn
) == 0)

233 i‡(
Œcf
->
cc_ªc‹d_mode
 == 1)

236 i‡(
	`ngx_föd_queue
(
ngx_πmp_ªc‹d_maö_c⁄f
->
queue
, 
r˘
->
«me
) == 1) {

237 
	`ngx_queue_ªmove_°©us
(
ngx_πmp_ªc‹d_maö_c⁄f
->
queue
, 
r˘
->
«me
);

240 
rc
 = 
	`ngx_πmp_ªc‹d_˛o£
(
s
, 
∫
, &
˘x
->
∑th
);

246 i‡(
rc
 =
NGX_ERROR
) {

250  
NGX_CONF_OK
;

251 
	}
}

255 
	$ngx_πmp_c⁄åﬁ_dr›_h™dÀr
(
ngx_hâp_ªque°_t
 *
r
, 
ngx_πmp_£ssi⁄_t
 *
s
)

257 
ngx_πmp_c⁄åﬁ_˘x_t
 *
˘x
;

259 
˘x
 = 
	`ngx_hâp_gë_moduÀ_˘x
(
r
, 
ngx_πmp_c⁄åﬁ_moduÀ
);

261 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

263 ++
˘x
->
cou¡
;

265  
NGX_CONF_OK
;

266 
	}
}

270 
	$ngx_πmp_c⁄åﬁ_ªdúe˘_h™dÀr
(
ngx_hâp_ªque°_t
 *
r
, 
ngx_πmp_£ssi⁄_t
 *
s
)

272 
ngx_°r_t
 
«me
;

273 
ngx_πmp_∂ay_t
 
v∂ay
;

274 
ngx_πmp_publish_t
 
vpublish
;

275 
ngx_πmp_live_˘x_t
 *
l˘x
;

276 
ngx_πmp_c⁄åﬁ_˘x_t
 *
˘x
;

277 
ngx_πmp_˛o£_°ªam_t
 
vc
;

279 i‡(
	`ngx_hâp_¨g
(
r
, (
u_ch¨
 *Ë"√w«me", ("√w«me"Ë- 1, &
«me
)

280 !
NGX_OK
)

285 i‡(
«me
.
Àn
 >
NGX_RTMP_MAX_NAME
) {

286 
«me
.
Àn
 = 
NGX_RTMP_MAX_NAME
 - 1;

289 
˘x
 = 
	`ngx_hâp_gë_moduÀ_˘x
(
r
, 
ngx_πmp_c⁄åﬁ_moduÀ
);

290 
˘x
->
cou¡
++;

292 
	`ngx_memzîo
(&
vc
, (
ngx_πmp_˛o£_°ªam_t
));

295 
	`ngx_πmp_˛o£_°ªam
(
s
, &
vc
);

297 
l˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_live_moduÀ
);

299 i‡(
l˘x
 &&Ü˘x->
publishög
) {

302 
	`ngx_memzîo
(&
vpublish
, (
ngx_πmp_publish_t
));

304 
	`ngx_mem˝y
(
vpublish
.
«me
,Çame.
d©a
,Çame.
Àn
);

306 
	`ngx_πmp_cmd_fûl_¨gs
(
vpublish
.
«me
, vpublish.
¨gs
);

308 i‡(
	`ngx_πmp_publish
(
s
, &
vpublish
Ë!
NGX_OK
) {

315 
	`ngx_memzîo
(&
v∂ay
, (
ngx_πmp_∂ay_t
));

317 
	`ngx_mem˝y
(
v∂ay
.
«me
,Çame.
d©a
,Çame.
Àn
);

319 
	`ngx_πmp_cmd_fûl_¨gs
(
v∂ay
.
«me
, v∂ay.
¨gs
);

321 i‡(
	`ngx_πmp_∂ay
(
s
, &
v∂ay
Ë!
NGX_OK
) {

326  
NGX_CONF_OK
;

327 
	}
}

331 
	$ngx_πmp_c⁄åﬁ_wÆk_£ssi⁄
(
ngx_hâp_ªque°_t
 *
r
,

332 
ngx_πmp_live_˘x_t
 *
l˘x
)

334 
ngx_°r_t
 
addr
, *
∑ddr
, 
˛õ¡id
;

335 
ngx_πmp_£ssi⁄_t
 *
s
, **
ss
;

336 
ngx_πmp_c⁄åﬁ_˘x_t
 *
˘x
;

338 
s
 = 
l˘x
->
£ssi⁄
;

340 i‡(
s
 =
NULL
 || s->
c⁄√˘i⁄
 == NULL) {

341  
NGX_CONF_OK
;

344 i‡(
	`ngx_hâp_¨g
(
r
, (
u_ch¨
 *Ë"addr", ("addr"Ë- 1, &
addr
)

345 =
NGX_OK
)

347 
∑ddr
 = &
s
->
c⁄√˘i⁄
->
addr_ãxt
;

348 i‡(
∑ddr
->
Àn
 !
addr
.len ||

349 
	`ngx_°∫cmp
(
∑ddr
->
d©a
, 
addr
.d©a,áddr.
Àn
))

351  
NGX_CONF_OK
;

355 i‡(
	`ngx_hâp_¨g
(
r
, (
u_ch¨
 *) "clientid", ("clientid") - 1,

356 &
˛õ¡id
)

357 =
NGX_OK
)

359 i‡(
s
->
c⁄√˘i⁄
->
numbî
 !=

360 (
ngx_uöt_t
Ë
	`ngx_©oi
(
˛õ¡id
.
d©a
, clõ¡id.
Àn
))

362  
NGX_CONF_OK
;

366 
˘x
 = 
	`ngx_hâp_gë_moduÀ_˘x
(
r
, 
ngx_πmp_c⁄åﬁ_moduÀ
);

368 
˘x
->
fûãr
) {

369 
NGX_RTMP_CONTROL_FILTER_PUBLISHER
:

370 i‡(!
l˘x
->
publishög
) {

371  
NGX_CONF_OK
;

375 
NGX_RTMP_CONTROL_FILTER_SUBSCRIBER
:

376 i‡(
l˘x
->
publishög
) {

377  
NGX_CONF_OK
;

381 
NGX_RTMP_CONTROL_FILTER_CLIENT
:

385 
ss
 = 
	`ngx_¨øy_push
(&
˘x
->
£ssi⁄s
);

386 i‡(
ss
 =
NULL
) {

390 *
ss
 = 
s
;

392  
NGX_CONF_OK
;

393 
	}
}

397 
	$ngx_πmp_c⁄åﬁ_wÆk_°ªam
(
ngx_hâp_ªque°_t
 *
r
,

398 
ngx_πmp_live_°ªam_t
 *
ls
)

400 c⁄° *
s
;

401 
ngx_πmp_live_˘x_t
 *
l˘x
;

403 
l˘x
 = 
ls
->
˘x
;Ü˘x;Ü˘x =Ü˘x->
√xt
) {

404 
s
 = 
	`ngx_πmp_c⁄åﬁ_wÆk_£ssi⁄
(
r
, 
l˘x
);

405 i‡(
s
 !
NGX_CONF_OK
) {

406  
s
;

410  
NGX_CONF_OK
;

411 
	}
}

415 
	$ngx_πmp_c⁄åﬁ_wÆk_≠p
(
ngx_hâp_ªque°_t
 *
r
,

416 
ngx_πmp_c‹e_≠p_c⁄f_t
 *
ˇcf
)

418 
size_t
 
Àn
;

419 
ngx_°r_t
 
«me
;

420 c⁄° *
s
;

421 
ngx_uöt_t
 
n
;

422 
ngx_πmp_live_°ªam_t
 *
ls
;

423 
ngx_πmp_live_≠p_c⁄f_t
 *
œcf
;

425 
œcf
 = 
ˇcf
->
≠p_c⁄f
[
ngx_πmp_live_moduÀ
.
˘x_ödex
];

428 i‡(
	`ngx_hâp_¨g
(
r
, (
u_ch¨
 *Ë"«me", ("«me"Ë- 1, &
«me
Ë!
NGX_OK
)

430 
n
 = 0;Ç < (
ngx_uöt_t
Ë
œcf
->
nbuckës
; ++n) {

431 
ls
 = 
œcf
->
°ªams
[
n
];Üs;Ü†ls->
√xt
) {

432 
s
 = 
	`ngx_πmp_c⁄åﬁ_wÆk_°ªam
(
r
, 
ls
);

433 i‡(
s
 !
NGX_CONF_OK
) {

434  
s
;

439  
NGX_CONF_OK
;

442 
n
 = 0;

443 
ls
 = 
œcf
->
°ªams
[
	`ngx_hash_key
(
«me
.
d©a
,Çame.
Àn
Ë%Üacf->
nbuckës
];

444 
ls
;Ü†ls->
√xt
)

446 
n
 = 1;

447 
Àn
 = 
	`ngx_°æí
(
ls
->
«me
);

448 i‡(
«me
.
Àn
 !À¿|| 
	`ngx_°∫cmp
“ame.
d©a
, 
ls
->name,Çame.len)) {

452 
s
 = 
	`ngx_πmp_c⁄åﬁ_wÆk_°ªam
(
r
, 
ls
);

453 i‡(
s
 !
NGX_CONF_OK
) {

454  
s
;

460 i‡(0 =
n
) {

461 
ngx_°ªam_öfo
 *
tmp_öfo
;

462 
ngx_πmp_c⁄åﬁ_˘x_t
 *
˘x
;

464 
˘x
 = 
	`ngx_hâp_gë_moduÀ_˘x
(
r
, 
ngx_πmp_c⁄åﬁ_moduÀ
);

465 
tmp_öfo
 = (
ngx_°ªam_öfo
 *)
	`ngx_pˇŒoc
(
ngx_cy˛e
->
poﬁ
, (ngx_stream_info));

466 
tmp_öfo
->
is_vÆid
 = 1;

467 
	`ngx_˝y°∫
(
tmp_öfo
->
°ªam_«me
, 
«me
.
d©a
,Çame.
Àn
 + 1);

468 i‡(
˘x
->
mëhod
.
Àn
 == ("start") - 1 &&

469 
	`ngx_°∫cmp
(
˘x
->
mëhod
.
d©a
, "°¨t", ctx->mëhod.
Àn
) == 0)

471 i‡(
	`ngx_föd_queue
(
ngx_πmp_ªc‹d_maö_c⁄f
->
queue
, 
tmp_öfo
->
°ªam_«me
) == 0) {

472 
	`ngx_queue_ö£π
(
ngx_πmp_ªc‹d_maö_c⁄f
->
queue
, 
tmp_öfo
);

475 i‡(
˘x
->
mëhod
.
Àn
 == ("stop") - 1 &&

476 
	`ngx_°∫cmp
(
˘x
->
mëhod
.
d©a
, "°›", ctx->mëhod.
Àn
) == 0)

478 i‡(
	`ngx_föd_queue
(
ngx_πmp_ªc‹d_maö_c⁄f
->
queue
, 
tmp_öfo
->
°ªam_«me
) == 1) {

479 
	`ngx_queue_ªmove_°©us
(
ngx_πmp_ªc‹d_maö_c⁄f
->
queue
, 
tmp_öfo
->
°ªam_«me
);

485  
NGX_CONF_OK
;

486 
	}
}

490 
	$ngx_πmp_c⁄åﬁ_wÆk_£rvî
(
ngx_hâp_ªque°_t
 *
r
,

491 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
)

493 
ngx_°r_t
 
≠p
;

494 
ngx_uöt_t
 
n
;

495 c⁄° *
s
;

496 
ngx_πmp_c‹e_≠p_c⁄f_t
 **
pˇcf
;

498 i‡(
	`ngx_hâp_¨g
(
r
, (
u_ch¨
 *Ë"≠p", ("≠p"Ë- 1, &
≠p
Ë!
NGX_OK
) {

499 
≠p
.
Àn
 = 0;

502 
pˇcf
 = 
cscf
->
≠∂iˇti⁄s
.
ñts
;

504 
n
 = 0;Ç < 
cscf
->
≠∂iˇti⁄s
.
√…s
; ++n, ++
pˇcf
) {

505 i‡(
≠p
.
Àn
 && ((*
pˇcf
)->
«me
.len !=ápp.len ||

506 
	`ngx_°∫cmp
((*
pˇcf
)->
«me
.
d©a
, 
≠p
.d©a,áµ.
Àn
)))

511 
s
 = 
	`ngx_πmp_c⁄åﬁ_wÆk_≠p
(
r
, *
pˇcf
);

512 i‡(
s
 !
NGX_CONF_OK
) {

513  
s
;

517  
NGX_CONF_OK
;

518 
	}
}

522 
	$ngx_πmp_c⁄åﬁ_wÆk
(
ngx_hâp_ªque°_t
 *
r
, 
ngx_πmp_c⁄åﬁ_h™dÀr_t
 
h
)

524 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
 = 
ngx_πmp_c‹e_maö_c⁄f
;

526 
ngx_°r_t
 
§v
;

527 
ngx_uöt_t
 
¢
, 
n
;

528 c⁄° *
msg
;

529 
ngx_πmp_£ssi⁄_t
 **
s
;

530 
ngx_πmp_c⁄åﬁ_˘x_t
 *
˘x
;

531 
ngx_πmp_c‹e_§v_c⁄f_t
 **
pcscf
;

533 
¢
 = 0;

534 i‡(
	`ngx_hâp_¨g
(
r
, (
u_ch¨
 *Ë"§v", ("§v"Ë- 1, &
§v
Ë=
NGX_OK
) {

535 
¢
 = 
	`ngx_©oi
(
§v
.
d©a
, srv.
Àn
);

538 i‡(
¢
 >
cmcf
->
£rvîs
.
√…s
) {

542 
pcscf
 = 
cmcf
->
£rvîs
.
ñts
;

543 
pcscf
 +
¢
;

545 
msg
 = 
	`ngx_πmp_c⁄åﬁ_wÆk_£rvî
(
r
, *
pcscf
);

546 i‡(
msg
 !
NGX_CONF_OK
) {

547  
msg
;

550 
˘x
 = 
	`ngx_hâp_gë_moduÀ_˘x
(
r
, 
ngx_πmp_c⁄åﬁ_moduÀ
);

552 
s
 = 
˘x
->
£ssi⁄s
.
ñts
;

553 
n
 = 0;Ç < 
˘x
->
£ssi⁄s
.
√…s
;Ç++) {

554 
msg
 = 
	`h
(
r
, 
s
[
n
]);

555 i‡(
msg
 !
NGX_CONF_OK
) {

556  
msg
;

560  
NGX_CONF_OK
;

561 
	}
}

564 
ngx_öt_t


565 
	$ngx_πmp_c⁄åﬁ_ªc‹d
(
ngx_hâp_ªque°_t
 *
r
, 
ngx_°r_t
 *
mëhod
)

567 
ngx_buf_t
 *
b
;

568 c⁄° *
msg
;

569 
ngx_chaö_t
 
˛
;

570 
ngx_πmp_c⁄åﬁ_˘x_t
 *
˘x
;

572 
˘x
 = 
	`ngx_hâp_gë_moduÀ_˘x
(
r
, 
ngx_πmp_c⁄åﬁ_moduÀ
);

573 
˘x
->
fûãr
 = 
NGX_RTMP_CONTROL_FILTER_PUBLISHER
;

575 
msg
 = 
	`ngx_πmp_c⁄åﬁ_wÆk
(
r
, 
ngx_πmp_c⁄åﬁ_ªc‹d_h™dÀr
);

576 i‡(
msg
 !
NGX_CONF_OK
) {

577 
îr‹
;

580 i‡(
˘x
->
∑th
.
Àn
 == 0) {

581  
NGX_HTTP_NO_CONTENT
;

586 
r
->
hódîs_out
.
°©us
 = 
NGX_HTTP_OK
;

587 
r
->
hódîs_out
.
c⁄ã¡_Àngth_n
 = 
˘x
->
∑th
.
Àn
;

589 
b
 = 
	`ngx_¸óã_ãmp_buf
(
r
->
poﬁ
, 
˘x
->
∑th
.
Àn
);

590 i‡(
b
 =
NULL
) {

591 
îr‹
;

594 
	`ngx_memzîo
(&
˛
, (cl));

595 
˛
.
buf
 = 
b
;

597 
b
->
œ°
 = 
	`ngx_˝ymem
(b->
pos
, 
˘x
->
∑th
.
d©a
, ctx->∑th.
Àn
);

598 
b
->
œ°_buf
 = 1;

600 
	`ngx_hâp_£nd_hódî
(
r
);

602  
	`ngx_hâp_ouçut_fûãr
(
r
, &
˛
);

604 
îr‹
:

605  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

606 
	}
}

609 
ngx_öt_t


610 
	$ngx_πmp_c⁄åﬁ_dr›
(
ngx_hâp_ªque°_t
 *
r
, 
ngx_°r_t
 *
mëhod
)

612 
size_t
 
Àn
;

613 
u_ch¨
 *
p
;

614 
ngx_buf_t
 *
b
;

615 
ngx_chaö_t
 
˛
;

616 c⁄° *
msg
;

617 
ngx_πmp_c⁄åﬁ_˘x_t
 *
˘x
;

619 
˘x
 = 
	`ngx_hâp_gë_moduÀ_˘x
(
r
, 
ngx_πmp_c⁄åﬁ_moduÀ
);

621 i‡(
˘x
->
mëhod
.
Àn
 == ("publisher") - 1 &&

622 
	`ngx_memcmp
(
˘x
->
mëhod
.
d©a
, "publishî", ctx->mëhod.
Àn
) == 0)

624 
˘x
->
fûãr
 = 
NGX_RTMP_CONTROL_FILTER_PUBLISHER
;

626 } i‡(
˘x
->
mëhod
.
Àn
 == ("subscriber") - 1 &&

627 
	`ngx_memcmp
(
˘x
->
mëhod
.
d©a
, "subs¸ibî", ctx->mëhod.
Àn
)

630 
˘x
->
fûãr
 = 
NGX_RTMP_CONTROL_FILTER_SUBSCRIBER
;

632 } i‡(
mëhod
->
Àn
 == ("client") - 1 &&

633 
	`ngx_memcmp
(
˘x
->
mëhod
.
d©a
, "˛õ¡", ctx->mëhod.
Àn
) == 0)

635 
˘x
->
fûãr
 = 
NGX_RTMP_CONTROL_FILTER_CLIENT
;

638 
msg
 = "Undefined filter";

639 
îr‹
;

642 
msg
 = 
	`ngx_πmp_c⁄åﬁ_wÆk
(
r
, 
ngx_πmp_c⁄åﬁ_dr›_h™dÀr
);

643 i‡(
msg
 !
NGX_CONF_OK
) {

644 
îr‹
;

649 
Àn
 = 
NGX_INT_T_LEN
;

651 
p
 = 
	`ngx_∑Œoc
(
r
->
c⁄√˘i⁄
->
poﬁ
, 
Àn
);

652 i‡(
p
 =
NULL
) {

653  
NGX_ERROR
;

656 
Àn
 = (
size_t
Ë(
	`ngx_¢¥ötf
(
p
,Üí, "%ui", 
˘x
->
cou¡
) -Ö);

658 
r
->
hódîs_out
.
°©us
 = 
NGX_HTTP_OK
;

659 
r
->
hódîs_out
.
c⁄ã¡_Àngth_n
 = 
Àn
;

661 
b
 = 
	`ngx_ˇŒoc_buf
(
r
->
poﬁ
);

662 i‡(
b
 =
NULL
) {

663 
îr‹
;

666 
b
->
°¨t
 = b->
pos
 = 
p
;

667 
b
->
íd
 = b->
œ°
 = 
p
 + 
Àn
;

668 
b
->
ãmp‹¨y
 = 1;

669 
b
->
œ°_buf
 = 1;

671 
	`ngx_memzîo
(&
˛
, (cl));

672 
˛
.
buf
 = 
b
;

674 
	`ngx_hâp_£nd_hódî
(
r
);

676  
	`ngx_hâp_ouçut_fûãr
(
r
, &
˛
);

678 
îr‹
:

679  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

680 
	}
}

683 
ngx_öt_t


684 
	$ngx_πmp_c⁄åﬁ_ªdúe˘
(
ngx_hâp_ªque°_t
 *
r
, 
ngx_°r_t
 *
mëhod
)

686 
size_t
 
Àn
;

687 
u_ch¨
 *
p
;

688 
ngx_buf_t
 *
b
;

689 
ngx_chaö_t
 
˛
;

690 c⁄° *
msg
;

691 
ngx_πmp_c⁄åﬁ_˘x_t
 *
˘x
;

693 
˘x
 = 
	`ngx_hâp_gë_moduÀ_˘x
(
r
, 
ngx_πmp_c⁄åﬁ_moduÀ
);

695 i‡(
˘x
->
mëhod
.
Àn
 == ("publisher") - 1 &&

696 
	`ngx_memcmp
(
˘x
->
mëhod
.
d©a
, "publishî", ctx->mëhod.
Àn
) == 0)

698 
˘x
->
fûãr
 = 
NGX_RTMP_CONTROL_FILTER_PUBLISHER
;

700 } i‡(
˘x
->
mëhod
.
Àn
 == ("subscriber") - 1 &&

701 
	`ngx_memcmp
(
˘x
->
mëhod
.
d©a
, "subs¸ibî", ctx->mëhod.
Àn
)

704 
˘x
->
fûãr
 = 
NGX_RTMP_CONTROL_FILTER_SUBSCRIBER
;

706 } i‡(
˘x
->
mëhod
.
Àn
 == ("client") - 1 &&

707 
	`ngx_memcmp
(
˘x
->
mëhod
.
d©a
, "˛õ¡", ctx->mëhod.
Àn
) == 0)

709 
˘x
->
fûãr
 = 
NGX_RTMP_CONTROL_FILTER_CLIENT
;

712 
msg
 = "Undefined filter";

713 
îr‹
;

716 
msg
 = 
	`ngx_πmp_c⁄åﬁ_wÆk
(
r
, 
ngx_πmp_c⁄åﬁ_ªdúe˘_h™dÀr
);

717 i‡(
msg
 !
NGX_CONF_OK
) {

718 
îr‹
;

723 
Àn
 = 
NGX_INT_T_LEN
;

725 
p
 = 
	`ngx_∑Œoc
(
r
->
c⁄√˘i⁄
->
poﬁ
, 
Àn
);

726 i‡(
p
 =
NULL
) {

727 
îr‹
;

730 
Àn
 = (
size_t
Ë(
	`ngx_¢¥ötf
(
p
,Üí, "%ui", 
˘x
->
cou¡
) -Ö);

732 
r
->
hódîs_out
.
°©us
 = 
NGX_HTTP_OK
;

733 
r
->
hódîs_out
.
c⁄ã¡_Àngth_n
 = 
Àn
;

735 
b
 = 
	`ngx_ˇŒoc_buf
(
r
->
poﬁ
);

736 i‡(
b
 =
NULL
) {

737 
îr‹
;

740 
b
->
°¨t
 = b->
pos
 = 
p
;

741 
b
->
íd
 = b->
œ°
 = 
p
 + 
Àn
;

742 
b
->
ãmp‹¨y
 = 1;

743 
b
->
œ°_buf
 = 1;

745 
	`ngx_memzîo
(&
˛
, (cl));

746 
˛
.
buf
 = 
b
;

748 
	`ngx_hâp_£nd_hódî
(
r
);

750  
	`ngx_hâp_ouçut_fûãr
(
r
, &
˛
);

752 
îr‹
:

753  
NGX_HTTP_INTERNAL_SERVER_ERROR
;

754 
	}
}

757 
ngx_öt_t


758 
	$ngx_πmp_c⁄åﬁ_h™dÀr
(
ngx_hâp_ªque°_t
 *
r
)

760 
u_ch¨
 *
p
;

761 
ngx_°r_t
 
£˘i⁄
, 
mëhod
;

762 
ngx_uöt_t
 
n
;

763 
ngx_πmp_c⁄åﬁ_˘x_t
 *
˘x
;

764 
ngx_πmp_c⁄åﬁ_loc_c⁄f_t
 *
Œcf
;

766 
Œcf
 = 
	`ngx_hâp_gë_moduÀ_loc_c⁄f
(
r
, 
ngx_πmp_c⁄åﬁ_moduÀ
);

767 i‡(
Œcf
->
c⁄åﬁ
 == 0) {

768  
NGX_DECLINED
;

774 
	`ngx_°r_nuŒ
(&
£˘i⁄
);

775 
	`ngx_°r_nuŒ
(&
mëhod
);

777 
n
 = 
r
->
uri
.
Àn
;Ç; --n) {

778 
p
 = &
r
->
uri
.
d©a
[
n
 - 1];

780 i‡(*
p
 != '/') {

784 i‡(
mëhod
.
d©a
) {

785 
£˘i⁄
.
d©a
 = 
p
 + 1;

786 
£˘i⁄
.
Àn
 = 
mëhod
.
d©a
 - section.data - 1;

790 
mëhod
.
d©a
 = 
p
 + 1;

791 
mëhod
.
Àn
 = 
r
->
uri
.
d©a
 +Ñ->uri.len - method.data;

794 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
r
->
c⁄√˘i⁄
->
log
, 0,

796 &
£˘i⁄
, &
mëhod
);

798 
˘x
 = 
	`ngx_pˇŒoc
(
r
->
poﬁ
, (
ngx_πmp_c⁄åﬁ_˘x_t
));

799 i‡(
˘x
 =
NULL
) {

800  
NGX_ERROR
;

803 
	`ngx_hâp_£t_˘x
(
r
, 
˘x
, 
ngx_πmp_c⁄åﬁ_moduÀ
);

805 i‡(
	`ngx_¨øy_öô
(&
˘x
->
£ssi⁄s
, 
r
->
poﬁ
, 1, (*)Ë!
NGX_OK
) {

806  
NGX_ERROR
;

809 
˘x
->
mëhod
 = method;

811 
	#NGX_RTMP_CONTROL_SECTION
(
Êag
, 
£˙ame
) \

812 i‡(
Œcf
->
c⁄åﬁ
 & 
NGX_RTMP_CONTROL_
##
Êag
 && \

813 
£˘i⁄
.
Àn
 == (#secname) - 1 && \

814 
	`ngx_°∫cmp
(
£˘i⁄
.
d©a
, #secname, (#secname) - 1) == 0) \

816  
ngx_πmp_c⁄åﬁ_
##
	`£˙ame
(
r
, &
mëhod
); \

817 }

	)

820 
	`NGX_RTMP_CONTROL_SECTION
(
RECORD
, 
ªc‹d
);

821 
	`NGX_RTMP_CONTROL_SECTION
(
DROP
, 
dr›
);

822 
	`NGX_RTMP_CONTROL_SECTION
(
REDIRECT
, 
ªdúe˘
);

824 #unde‡
NGX_RTMP_CONTROL_SECTION


826  
NGX_DECLINED
;

827 
	}
}

831 
	$ngx_πmp_c⁄åﬁ_¸óã_loc_c⁄f
(
ngx_c⁄f_t
 *
cf
)

833 
ngx_πmp_c⁄åﬁ_loc_c⁄f_t
 *
c⁄f
;

835 
c⁄f
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_c⁄åﬁ_loc_c⁄f_t
));

836 i‡(
c⁄f
 =
NULL
) {

837  
NULL
;

840 
c⁄f
->
c⁄åﬁ
 = 0;

841 
c⁄f
->
cc_ªc‹d_mode
 = 
NGX_CONF_UNSET
;

843  
c⁄f
;

844 
	}
}

848 
	$ngx_πmp_c⁄åﬁ_mîge_loc_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
∑ª¡
, *
chûd
)

850 
ngx_πmp_c⁄åﬁ_loc_c⁄f_t
 *
¥ev
 = 
∑ª¡
;

851 
ngx_πmp_c⁄åﬁ_loc_c⁄f_t
 *
c⁄f
 = 
chûd
;

853 
	`ngx_c⁄f_mîge_bômask_vÆue
(
c⁄f
->
c⁄åﬁ
, 
¥ev
->control, 0);

854 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
cc_ªc‹d_mode
, 
¥ev
->cc_record_mode, 0);

856  
NGX_CONF_OK
;

857 
	}
}

861 
	$ngx_πmp_c⁄åﬁ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

863 
ngx_hâp_c‹e_loc_c⁄f_t
 *
˛cf
;

865 
˛cf
 = 
	`ngx_hâp_c⁄f_gë_moduÀ_loc_c⁄f
(
cf
, 
ngx_hâp_c‹e_moduÀ
);

866 
˛cf
->
h™dÀr
 = 
ngx_πmp_c⁄åﬁ_h™dÀr
;

868  
	`ngx_c⁄f_£t_bômask_¶Ÿ
(
cf
, 
cmd
, 
c⁄f
);

869 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_core_module.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~<ngx_evít.h
>

10 
	~<ngöx.h
>

11 
	~"ngx_πmp.h
"

14 *
ngx_πmp_c‹e_¸óã_maö_c⁄f
(
ngx_c⁄f_t
 *
cf
);

15 *
ngx_πmp_c‹e_¸óã_§v_c⁄f
(
ngx_c⁄f_t
 *
cf
);

16 *
ngx_πmp_c‹e_mîge_§v_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
∑ª¡
,

17 *
chûd
);

18 *
ngx_πmp_c‹e_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
);

19 *
ngx_πmp_c‹e_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
∑ª¡
,

20 *
chûd
);

21 *
ngx_πmp_c‹e_£rvî
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
,

22 *
c⁄f
);

23 *
ngx_πmp_c‹e_li°í
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
,

24 *
c⁄f
);

25 *
ngx_πmp_c‹e_≠∂iˇti⁄
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
,

26 *
c⁄f
);

29 
ngx_πmp_c‹e_maö_c⁄f_t
 *
	gngx_πmp_c‹e_maö_c⁄f
;

32 
ngx_c⁄f_dïªˇãd_t
 
	gngx_c⁄f_dïªˇãd_so_kì∑live
 = {

33 
ngx_c⁄f_dïªˇãd
, "so_keepalive",

38 
ngx_comm™d_t
 
	gngx_πmp_c‹e_comm™ds
[] = {

40 { 
ngx_°rög
("server"),

41 
NGX_RTMP_MAIN_CONF
|
NGX_CONF_BLOCK
|
NGX_CONF_NOARGS
,

42 
ngx_πmp_c‹e_£rvî
,

45 
NULL
 },

47 { 
ngx_°rög
("listen"),

48 
NGX_RTMP_SRV_CONF
|
NGX_CONF_TAKE12
,

49 
ngx_πmp_c‹e_li°í
,

50 
NGX_RTMP_SRV_CONF_OFFSET
,

52 
NULL
 },

54 { 
ngx_°rög
("application"),

55 
NGX_RTMP_SRV_CONF
|
NGX_CONF_BLOCK
|
NGX_CONF_TAKE1
,

56 
ngx_πmp_c‹e_≠∂iˇti⁄
,

57 
NGX_RTMP_SRV_CONF_OFFSET
,

59 
NULL
 },

61 { 
ngx_°rög
("so_keepalive"),

62 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_CONF_FLAG
,

63 
ngx_c⁄f_£t_Êag_¶Ÿ
,

64 
NGX_RTMP_SRV_CONF_OFFSET
,

65 
off£tof
(
ngx_πmp_c‹e_§v_c⁄f_t
, 
so_kì∑live
),

66 &
ngx_c⁄f_dïªˇãd_so_kì∑live
 },

68 { 
ngx_°rög
("timeout"),

69 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_CONF_TAKE1
,

70 
ngx_c⁄f_£t_m£c_¶Ÿ
,

71 
NGX_RTMP_SRV_CONF_OFFSET
,

72 
off£tof
(
ngx_πmp_c‹e_§v_c⁄f_t
, 
timeout
),

73 
NULL
 },

75 { 
ngx_°rög
("ping"),

76 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_CONF_TAKE1
,

77 
ngx_c⁄f_£t_m£c_¶Ÿ
,

78 
NGX_RTMP_SRV_CONF_OFFSET
,

79 
off£tof
(
ngx_πmp_c‹e_§v_c⁄f_t
, 
pög
),

80 
NULL
 },

82 { 
ngx_°rög
("ping_timeout"),

83 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_CONF_TAKE1
,

84 
ngx_c⁄f_£t_m£c_¶Ÿ
,

85 
NGX_RTMP_SRV_CONF_OFFSET
,

86 
off£tof
(
ngx_πmp_c‹e_§v_c⁄f_t
, 
pög_timeout
),

87 
NULL
 },

89 { 
ngx_°rög
("max_streams"),

90 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_CONF_TAKE1
,

91 
ngx_c⁄f_£t_num_¶Ÿ
,

92 
NGX_RTMP_SRV_CONF_OFFSET
,

93 
off£tof
(
ngx_πmp_c‹e_§v_c⁄f_t
, 
max_°ªams
),

94 
NULL
 },

96 { 
ngx_°rög
("ack_window"),

97 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_CONF_TAKE1
,

98 
ngx_c⁄f_£t_num_¶Ÿ
,

99 
NGX_RTMP_SRV_CONF_OFFSET
,

100 
off£tof
(
ngx_πmp_c‹e_§v_c⁄f_t
, 
ack_wödow
),

101 
NULL
 },

103 { 
ngx_°rög
("chunk_size"),

104 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_CONF_TAKE1
,

105 
ngx_c⁄f_£t_num_¶Ÿ
,

106 
NGX_RTMP_SRV_CONF_OFFSET
,

107 
off£tof
(
ngx_πmp_c‹e_§v_c⁄f_t
, 
chunk_size
),

108 
NULL
 },

110 { 
ngx_°rög
("max_message"),

111 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_CONF_TAKE1
,

112 
ngx_c⁄f_£t_size_¶Ÿ
,

113 
NGX_RTMP_SRV_CONF_OFFSET
,

114 
off£tof
(
ngx_πmp_c‹e_§v_c⁄f_t
, 
max_mesßge
),

115 
NULL
 },

117 { 
ngx_°rög
("out_queue"),

118 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_CONF_TAKE1
,

119 
ngx_c⁄f_£t_size_¶Ÿ
,

120 
NGX_RTMP_SRV_CONF_OFFSET
,

121 
off£tof
(
ngx_πmp_c‹e_§v_c⁄f_t
, 
out_queue
),

122 
NULL
 },

124 { 
ngx_°rög
("out_cork"),

125 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_CONF_TAKE1
,

126 
ngx_c⁄f_£t_size_¶Ÿ
,

127 
NGX_RTMP_SRV_CONF_OFFSET
,

128 
off£tof
(
ngx_πmp_c‹e_§v_c⁄f_t
, 
out_c‹k
),

129 
NULL
 },

131 { 
ngx_°rög
("busy"),

132 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_CONF_TAKE1
,

133 
ngx_c⁄f_£t_Êag_¶Ÿ
,

134 
NGX_RTMP_SRV_CONF_OFFSET
,

135 
off£tof
(
ngx_πmp_c‹e_§v_c⁄f_t
, 
busy
),

136 
NULL
 },

139 { 
ngx_°rög
("play_time_fix"),

140 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

141 
ngx_c⁄f_£t_Êag_¶Ÿ
,

142 
NGX_RTMP_SRV_CONF_OFFSET
,

143 
off£tof
(
ngx_πmp_c‹e_§v_c⁄f_t
, 
∂ay_time_fix
),

144 
NULL
 },

146 { 
ngx_°rög
("publish_time_fix"),

147 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

148 
ngx_c⁄f_£t_Êag_¶Ÿ
,

149 
NGX_RTMP_SRV_CONF_OFFSET
,

150 
off£tof
(
ngx_πmp_c‹e_§v_c⁄f_t
, 
publish_time_fix
),

151 
NULL
 },

153 { 
ngx_°rög
("buflen"),

154 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_CONF_TAKE1
,

155 
ngx_c⁄f_£t_m£c_¶Ÿ
,

156 
NGX_RTMP_SRV_CONF_OFFSET
,

157 
off£tof
(
ngx_πmp_c‹e_§v_c⁄f_t
, 
buÊí
),

158 
NULL
 },

160 
ngx_nuŒ_comm™d


164 
ngx_πmp_moduÀ_t
 
	gngx_πmp_c‹e_moduÀ_˘x
 = {

165 
NULL
,

166 
NULL
,

167 
ngx_πmp_c‹e_¸óã_maö_c⁄f
,

168 
NULL
,

169 
ngx_πmp_c‹e_¸óã_§v_c⁄f
,

170 
ngx_πmp_c‹e_mîge_§v_c⁄f
,

171 
ngx_πmp_c‹e_¸óã_≠p_c⁄f
,

172 
ngx_πmp_c‹e_mîge_≠p_c⁄f


176 
ngx_moduÀ_t
 
	gngx_πmp_c‹e_moduÀ
 = {

177 
NGX_MODULE_V1
,

178 &
ngx_πmp_c‹e_moduÀ_˘x
,

179 
ngx_πmp_c‹e_comm™ds
,

180 
NGX_RTMP_MODULE
,

181 
NULL
,

182 
NULL
,

183 
NULL
,

184 
NULL
,

185 
NULL
,

186 
NULL
,

187 
NULL
,

188 
NGX_MODULE_V1_PADDING


193 
	$ngx_πmp_c‹e_¸óã_maö_c⁄f
(
ngx_c⁄f_t
 *
cf
)

195 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
;

197 
cmcf
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_c‹e_maö_c⁄f_t
));

198 i‡(
cmcf
 =
NULL
) {

199  
NULL
;

202 
ngx_πmp_c‹e_maö_c⁄f
 = 
cmcf
;

204 i‡(
	`ngx_¨øy_öô
(&
cmcf
->
£rvîs
, 
cf
->
poﬁ
, 4,

205 (
ngx_πmp_c‹e_§v_c⁄f_t
 *))

206 !
NGX_OK
)

208  
NULL
;

211 i‡(
	`ngx_¨øy_öô
(&
cmcf
->
li°í
, 
cf
->
poﬁ
, 4, (
ngx_πmp_li°í_t
))

212 !
NGX_OK
)

214  
NULL
;

217  
cmcf
;

218 
	}
}

222 
	$ngx_πmp_c‹e_¸óã_§v_c⁄f
(
ngx_c⁄f_t
 *
cf
)

224 
ngx_πmp_c‹e_§v_c⁄f_t
 *
c⁄f
;

226 
c⁄f
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_c‹e_§v_c⁄f_t
));

227 i‡(
c⁄f
 =
NULL
) {

228  
NULL
;

231 i‡(
	`ngx_¨øy_öô
(&
c⁄f
->
≠∂iˇti⁄s
, 
cf
->
poﬁ
, 4,

232 (
ngx_πmp_c‹e_≠p_c⁄f_t
 *))

233 !
NGX_OK
)

235  
NULL
;

238 
c⁄f
->
timeout
 = 
NGX_CONF_UNSET_MSEC
;

239 
c⁄f
->
pög
 = 
NGX_CONF_UNSET_MSEC
;

240 
c⁄f
->
pög_timeout
 = 
NGX_CONF_UNSET_MSEC
;

241 
c⁄f
->
so_kì∑live
 = 
NGX_CONF_UNSET
;

242 
c⁄f
->
max_°ªams
 = 
NGX_CONF_UNSET
;

243 
c⁄f
->
chunk_size
 = 
NGX_CONF_UNSET
;

244 
c⁄f
->
ack_wödow
 = 
NGX_CONF_UNSET_UINT
;

245 
c⁄f
->
max_mesßge
 = 
NGX_CONF_UNSET_SIZE
;

246 
c⁄f
->
out_queue
 = 
NGX_CONF_UNSET_SIZE
;

247 
c⁄f
->
out_c‹k
 = 
NGX_CONF_UNSET_SIZE
;

248 
c⁄f
->
∂ay_time_fix
 = 
NGX_CONF_UNSET
;

249 
c⁄f
->
publish_time_fix
 = 
NGX_CONF_UNSET
;

250 
c⁄f
->
buÊí
 = 
NGX_CONF_UNSET_MSEC
;

251 
c⁄f
->
busy
 = 
NGX_CONF_UNSET
;

253  
c⁄f
;

254 
	}
}

258 
	$ngx_πmp_c‹e_mîge_§v_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
∑ª¡
, *
chûd
)

260 
ngx_πmp_c‹e_§v_c⁄f_t
 *
¥ev
 = 
∑ª¡
;

261 
ngx_πmp_c‹e_§v_c⁄f_t
 *
c⁄f
 = 
chûd
;

263 
	`ngx_c⁄f_mîge_m£c_vÆue
(
c⁄f
->
timeout
, 
¥ev
->timeout, 60000);

264 
	`ngx_c⁄f_mîge_m£c_vÆue
(
c⁄f
->
pög
, 
¥ev
->ping, 60000);

265 
	`ngx_c⁄f_mîge_m£c_vÆue
(
c⁄f
->
pög_timeout
, 
¥ev
->ping_timeout, 30000);

267 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
so_kì∑live
, 
¥ev
->so_keepalive, 0);

268 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
max_°ªams
, 
¥ev
->max_streams, 32);

269 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
chunk_size
, 
¥ev
->chunk_size, 4096);

270 
	`ngx_c⁄f_mîge_uöt_vÆue
(
c⁄f
->
ack_wödow
, 
¥ev
->ack_window, 5000000);

271 
	`ngx_c⁄f_mîge_size_vÆue
(
c⁄f
->
max_mesßge
, 
¥ev
->max_message,

273 
	`ngx_c⁄f_mîge_size_vÆue
(
c⁄f
->
out_queue
, 
¥ev
->out_queue, 256);

274 
	`ngx_c⁄f_mîge_size_vÆue
(
c⁄f
->
out_c‹k
, 
¥ev
->out_cork,

275 
c⁄f
->
out_queue
 / 8);

276 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
∂ay_time_fix
, 
¥ev
->play_time_fix, 1);

277 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
publish_time_fix
, 
¥ev
->publish_time_fix, 1);

278 
	`ngx_c⁄f_mîge_m£c_vÆue
(
c⁄f
->
buÊí
, 
¥ev
->buflen, 1000);

279 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
busy
, 
¥ev
->busy, 0);

281 i‡(
¥ev
->
poﬁ
 =
NULL
) {

282 
¥ev
->
poﬁ
 = 
	`ngx_¸óã_poﬁ
(4096, &
cf
->
cy˛e
->
√w_log
);

283 i‡(
¥ev
->
poﬁ
 =
NULL
) {

284  
NGX_CONF_ERROR
;

288 
c⁄f
->
poﬁ
 = 
¥ev
->pool;

290  
NGX_CONF_OK
;

291 
	}
}

295 
	$ngx_πmp_c‹e_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
)

297 
ngx_πmp_c‹e_≠p_c⁄f_t
 *
c⁄f
;

299 
c⁄f
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_c‹e_≠p_c⁄f_t
));

300 i‡(
c⁄f
 =
NULL
) {

301  
NULL
;

304 i‡(
	`ngx_¨øy_öô
(&
c⁄f
->
≠∂iˇti⁄s
, 
cf
->
poﬁ
, 1,

305 (
ngx_πmp_c‹e_≠p_c⁄f_t
 *))

306 !
NGX_OK
)

308  
NULL
;

311  
c⁄f
;

312 
	}
}

316 
	$ngx_πmp_c‹e_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
∑ª¡
, *
chûd
)

318 
ngx_πmp_c‹e_≠p_c⁄f_t
 *
¥ev
 = 
∑ª¡
;

319 
ngx_πmp_c‹e_≠p_c⁄f_t
 *
c⁄f
 = 
chûd
;

321 ()
¥ev
;

322 ()
c⁄f
;

324  
NGX_CONF_OK
;

325 
	}
}

329 
	$ngx_πmp_c‹e_£rvî
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

331 *
rv
;

332 *
mc⁄f
;

333 
ngx_uöt_t
 
m
;

334 
ngx_c⁄f_t
 
pcf
;

335 
ngx_πmp_moduÀ_t
 *
moduÀ
;

336 
ngx_πmp_c⁄f_˘x_t
 *
˘x
, *
πmp_˘x
;

337 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
, **
cscÂ
;

338 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
;

340 
˘x
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_c⁄f_˘x_t
));

341 i‡(
˘x
 =
NULL
) {

342  
NGX_CONF_ERROR
;

345 
πmp_˘x
 = 
cf
->
˘x
;

346 
˘x
->
maö_c⁄f
 = 
πmp_˘x
->main_conf;

350 
˘x
->
§v_c⁄f
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (*Ë* 
ngx_πmp_max_moduÀ
);

351 i‡(
˘x
->
§v_c⁄f
 =
NULL
) {

352  
NGX_CONF_ERROR
;

355 
˘x
->
≠p_c⁄f
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (*Ë* 
ngx_πmp_max_moduÀ
);

356 i‡(
˘x
->
≠p_c⁄f
 =
NULL
) {

357  
NGX_CONF_ERROR
;

360 
m
 = 0; 
ngx_moduÀs
[m]; m++) {

361 i‡(
ngx_moduÀs
[
m
]->
ty≥
 !
NGX_RTMP_MODULE
) {

365 
moduÀ
 = 
ngx_moduÀs
[
m
]->
˘x
;

367 i‡(
moduÀ
->
¸óã_§v_c⁄f
) {

368 
mc⁄f
 = 
moduÀ
->
	`¸óã_§v_c⁄f
(
cf
);

369 i‡(
mc⁄f
 =
NULL
) {

370  
NGX_CONF_ERROR
;

373 
˘x
->
§v_c⁄f
[
ngx_moduÀs
[
m
]->
˘x_ödex
] = 
mc⁄f
;

376 i‡(
moduÀ
->
¸óã_≠p_c⁄f
) {

377 
mc⁄f
 = 
moduÀ
->
	`¸óã_≠p_c⁄f
(
cf
);

378 i‡(
mc⁄f
 =
NULL
) {

379  
NGX_CONF_ERROR
;

382 
˘x
->
≠p_c⁄f
[
ngx_moduÀs
[
m
]->
˘x_ödex
] = 
mc⁄f
;

388 
cscf
 = 
˘x
->
§v_c⁄f
[
ngx_πmp_c‹e_moduÀ
.
˘x_ödex
];

389 
cscf
->
˘x
 = ctx;

391 
cmcf
 = 
˘x
->
maö_c⁄f
[
ngx_πmp_c‹e_moduÀ
.
˘x_ödex
];

393 
cscÂ
 = 
	`ngx_¨øy_push
(&
cmcf
->
£rvîs
);

394 i‡(
cscÂ
 =
NULL
) {

395  
NGX_CONF_ERROR
;

398 *
cscÂ
 = 
cscf
;

403 
pcf
 = *
cf
;

404 
cf
->
˘x
 = ctx;

405 
cf
->
cmd_ty≥
 = 
NGX_RTMP_SRV_CONF
;

407 
rv
 = 
	`ngx_c⁄f_∑r£
(
cf
, 
NULL
);

409 *
cf
 = 
pcf
;

411  
rv
;

412 
	}
}

416 
	$ngx_πmp_c‹e_≠∂iˇti⁄
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

418 *
rv
;

419 
ngx_öt_t
 
i
;

420 
ngx_°r_t
 *
vÆue
;

421 
ngx_c⁄f_t
 
ßve
;

422 
ngx_πmp_moduÀ_t
 *
moduÀ
;

423 
ngx_πmp_c⁄f_˘x_t
 *
˘x
, *
p˘x
;

424 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

425 
ngx_πmp_c‹e_≠p_c⁄f_t
 *
ˇcf
, **
ˇcÂ
;

427 
˘x
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_c⁄f_˘x_t
));

428 i‡(
˘x
 =
NULL
) {

429  
NGX_CONF_ERROR
;

432 
p˘x
 = 
cf
->
˘x
;

433 
˘x
->
maö_c⁄f
 = 
p˘x
->main_conf;

434 
˘x
->
§v_c⁄f
 = 
p˘x
->srv_conf;

436 
˘x
->
≠p_c⁄f
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (*Ë* 
ngx_πmp_max_moduÀ
);

437 i‡(
˘x
->
≠p_c⁄f
 =
NULL
) {

438  
NGX_CONF_ERROR
;

441 
i
 = 0; 
ngx_moduÀs
[i]; i++) {

442 i‡(
ngx_moduÀs
[
i
]->
ty≥
 !
NGX_RTMP_MODULE
) {

446 
moduÀ
 = 
ngx_moduÀs
[
i
]->
˘x
;

448 i‡(
moduÀ
->
¸óã_≠p_c⁄f
) {

449 
˘x
->
≠p_c⁄f
[
ngx_moduÀs
[
i
]->
˘x_ödex
] =

450 
moduÀ
->
	`¸óã_≠p_c⁄f
(
cf
);

451 i‡(
˘x
->
≠p_c⁄f
[
ngx_moduÀs
[
i
]->
˘x_ödex
] =
NULL
) {

452  
NGX_CONF_ERROR
;

457 
ˇcf
 = 
˘x
->
≠p_c⁄f
[
ngx_πmp_c‹e_moduÀ
.
˘x_ödex
];

458 
ˇcf
->
≠p_c⁄f
 = 
˘x
->app_conf;

460 
vÆue
 = 
cf
->
¨gs
->
ñts
;

462 
ˇcf
->
«me
 = 
vÆue
[1];

463 
cscf
 = 
p˘x
->
§v_c⁄f
[
ngx_πmp_c‹e_moduÀ
.
˘x_ödex
];

465 
ˇcÂ
 = 
	`ngx_¨øy_push
(&
cscf
->
≠∂iˇti⁄s
);

466 i‡(
ˇcÂ
 =
NULL
) {

467  
NGX_CONF_ERROR
;

470 *
ˇcÂ
 = 
ˇcf
;

472 
ßve
 = *
cf
;

473 
cf
->
˘x
 = ctx;

474 
cf
->
cmd_ty≥
 = 
NGX_RTMP_APP_CONF
;

476 
rv
 = 
	`ngx_c⁄f_∑r£
(
cf
, 
NULL
);

478 *
cf

ßve
;

480  
rv
;

481 
	}
}

485 
	$ngx_πmp_c‹e_li°í
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

487 
size_t
 
Àn
, 
off
;

488 
ö_p‹t_t
 
p‹t
;

489 
ngx_°r_t
 *
vÆue
;

490 
ngx_uæ_t
 
u
;

491 
ngx_uöt_t
 
i
, 
m
;

492 
sockaddr
 *
ß
;

493 
ngx_πmp_li°í_t
 *
ls
;

494 
sockaddr_ö
 *
sö
;

495 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
;

496 #i‡(
NGX_HAVE_INET6
)

497 
sockaddr_ö6
 *
sö6
;

500 
vÆue
 = 
cf
->
¨gs
->
ñts
;

502 
	`ngx_memzîo
(&
u
, (
ngx_uæ_t
));

504 
u
.
uæ
 = 
vÆue
[1];

505 
u
.
li°í
 = 1;

507 i‡(
	`ngx_∑r£_uæ
(
cf
->
poﬁ
, &
u
Ë!
NGX_OK
) {

508 i‡(
u
.
îr
) {

509 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

511 
u
.
îr
, &u.
uæ
);

514  
NGX_CONF_ERROR
;

517 
cmcf
 = 
	`ngx_πmp_c⁄f_gë_moduÀ_maö_c⁄f
(
cf
, 
ngx_πmp_c‹e_moduÀ
);

519 
ls
 = 
cmcf
->
li°í
.
ñts
;

521 
i
 = 0; i < 
cmcf
->
li°í
.
√…s
; i++) {

523 
ß
 = (
sockaddr
 *Ë
ls
[
i
].sockaddr;

525 i‡(
ß
->
ß_Ámûy
 !
u
.
Ámûy
) {

529 
ß
->
ß_Ámûy
) {

531 #i‡(
NGX_HAVE_INET6
)

532 
AF_INET6
:

533 
off
 = 
	`off£tof
(
sockaddr_ö6
, 
sö6_addr
);

534 
Àn
 = 16;

535 
sö6
 = (
sockaddr_ö6
 *Ë
ß
;

536 
p‹t
 = 
sö6
->
sö6_p‹t
;

541 
off
 = 
	`off£tof
(
sockaddr_ö
, 
sö_addr
);

542 
Àn
 = 4;

543 
sö
 = (
sockaddr_ö
 *Ë
ß
;

544 
p‹t
 = 
sö
->
sö_p‹t
;

548 i‡(
	`ngx_memcmp
(
ls
[
i
].
sockaddr
 + 
off
, 
u
.sockadd∏+ off, 
Àn
) != 0) {

552 i‡(
p‹t
 !
u
.port) {

556 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

557 "du∂iˇã \"%V\"áddªs†™dÖ‹à∑ú", &
u
.
uæ
);

558  
NGX_CONF_ERROR
;

561 
ls
 = 
	`ngx_¨øy_push
(&
cmcf
->
li°í
);

562 i‡(
ls
 =
NULL
) {

563  
NGX_CONF_ERROR
;

566 
	`ngx_memzîo
(
ls
, (
ngx_πmp_li°í_t
));

568 
	`ngx_mem˝y
(
ls
->
sockaddr
, 
u
.sockaddr, u.
sockÀn
);

570 
ls
->
sockÀn
 = 
u
.socklen;

571 
ls
->
wûdˇrd
 = 
u
.wildcard;

572 
ls
->
˘x
 = 
cf
->ctx;

574 
m
 = 0; 
ngx_moduÀs
[m]; m++) {

575 i‡(
ngx_moduÀs
[
m
]->
ty≥
 !
NGX_RTMP_MODULE
) {

580 
i
 = 2; i < 
cf
->
¨gs
->
√…s
; i++) {

582 i‡(
	`ngx_°rcmp
(
vÆue
[
i
].
d©a
, "bind") == 0) {

583 
ls
->
böd
 = 1;

587 i‡(
	`ngx_°∫cmp
(
vÆue
[
i
].
d©a
, "ipv6only=o", 10) == 0) {

588 #i‡(
NGX_HAVE_INET6
 && 
deföed
 
IPV6_V6ONLY
)

589 
sockaddr
 *
ß
;

590 
u_ch¨
 
buf
[
NGX_SOCKADDR_STRLEN
];

592 
ß
 = (
sockaddr
 *Ë
ls
->sockaddr;

594 i‡(
ß
->
ß_Ámûy
 =
AF_INET6
) {

596 i‡(
	`ngx_°rcmp
(&
vÆue
[
i
].
d©a
[10], "n") == 0) {

597 
ls
->
ùv6⁄ly
 = 1;

599 } i‡(
	`ngx_°rcmp
(&
vÆue
[
i
].
d©a
[10], "ff") == 0) {

600 
ls
->
ùv6⁄ly
 = 0;

603 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

605 &
vÆue
[
i
].
d©a
[9]);

606  
NGX_CONF_ERROR
;

609 
ls
->
böd
 = 1;

612 
Àn
 = 
	`ngx_sock_¡›
(
ß
,

613 #i‡(
ngöx_vîsi⁄
 >= 1005003)

614 
ls
->
sockÀn
,

616 
buf
, 
NGX_SOCKADDR_STRLEN
, 1);

618 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

620 "⁄ádd∏\"%*s\", ign‹ed", 
Àn
, 
buf
);

625 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

628  
NGX_CONF_ERROR
;

632 i‡(
	`ngx_°∫cmp
(
vÆue
[
i
].
d©a
, "so_keepalive=", 13) == 0) {

634 i‡(
	`ngx_°rcmp
(&
vÆue
[
i
].
d©a
[13], "on") == 0) {

635 
ls
->
so_kì∑live
 = 1;

637 } i‡(
	`ngx_°rcmp
(&
vÆue
[
i
].
d©a
[13], "off") == 0) {

638 
ls
->
so_kì∑live
 = 2;

642 #i‡(
NGX_HAVE_KEEPALIVE_TUNABLE
)

643 
u_ch¨
 *
p
, *
íd
;

644 
ngx_°r_t
 
s
;

646 
íd
 = 
vÆue
[
i
].
d©a
 + vÆue[i].
Àn
;

647 
s
.
d©a
 = 
vÆue
[
i
].data + 13;

649 
p
 = 
	`ngx_°æchr
(
s
.
d©a
, 
íd
, ':');

650 i‡(
p
 =
NULL
) {

651 
p
 = 
íd
;

654 i‡(
p
 > 
s
.
d©a
) {

655 
s
.
Àn
 = 
p
 - s.
d©a
;

657 
ls
->
t˝_kìpidÀ
 = 
	`ngx_∑r£_time
(&
s
, 1);

658 i‡(
ls
->
t˝_kìpidÀ
 =(
time_t
Ë
NGX_ERROR
) {

659 
övÆid_so_kì∑live
;

663 
s
.
d©a
 = (
p
 < 
íd
) ? (p + 1) :Énd;

665 
p
 = 
	`ngx_°æchr
(
s
.
d©a
, 
íd
, ':');

666 i‡(
p
 =
NULL
) {

667 
p
 = 
íd
;

670 i‡(
p
 > 
s
.
d©a
) {

671 
s
.
Àn
 = 
p
 - s.
d©a
;

673 
ls
->
t˝_kìpötvl
 = 
	`ngx_∑r£_time
(&
s
, 1);

674 i‡(
ls
->
t˝_kìpötvl
 =(
time_t
Ë
NGX_ERROR
) {

675 
övÆid_so_kì∑live
;

679 
s
.
d©a
 = (
p
 < 
íd
) ? (p + 1) :Énd;

681 i‡(
s
.
d©a
 < 
íd
) {

682 
s
.
Àn
 = 
íd
 - s.
d©a
;

684 
ls
->
t˝_kìp˙t
 = 
	`ngx_©oi
(
s
.
d©a
, s.
Àn
);

685 i‡(
ls
->
t˝_kìp˙t
 =
NGX_ERROR
) {

686 
övÆid_so_kì∑live
;

690 i‡(
ls
->
t˝_kìpidÀ
 =0 &&Üs->
t˝_kìpötvl
 == 0

691 && 
ls
->
t˝_kìp˙t
 == 0)

693 
övÆid_so_kì∑live
;

696 
ls
->
so_kì∑live
 = 1;

700 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

703  
NGX_CONF_ERROR
;

708 
ls
->
böd
 = 1;

712 #i‡(
NGX_HAVE_KEEPALIVE_TUNABLE
)

713 
övÆid_so_kì∑live
:

715 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

717 &
vÆue
[
i
].
d©a
[13]);

718  
NGX_CONF_ERROR
;

722 i‡(
	`ngx_°rcmp
(
vÆue
[
i
].
d©a
, "proxy_protocol") == 0) {

723 
ls
->
¥oxy_¥Ÿocﬁ
 = 1;

727 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

728 "thêövÆid \"%V\"Ö¨amëî", &
vÆue
[
i
]);

729  
NGX_CONF_ERROR
;

732  
NGX_CONF_OK
;

733 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_eval.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp_evÆ.h
"

12 
	#NGX_RTMP_EVAL_BUFLEN
 16

	)

16 
	$ngx_πmp_evÆ_£ssi⁄_°r
(*
˘x
, 
ngx_πmp_evÆ_t
 *
e
, 
ngx_°r_t
 *
ªt
)

18 *
ªt
 = *(
ngx_°r_t
 *Ë((
u_ch¨
 *Ë
˘x
 + 
e
->
off£t
);

19 
	}
}

23 
	$ngx_πmp_evÆ_c⁄√˘i⁄_°r
(*
˘x
, 
ngx_πmp_evÆ_t
 *
e
, 
ngx_°r_t
 *
ªt
)

25 
ngx_πmp_£ssi⁄_t
 *
s
 = 
˘x
;

27 *
ªt
 = *(
ngx_°r_t
 *Ë((
u_ch¨
 *Ë
s
->
c⁄√˘i⁄
 + 
e
->
off£t
);

28 
	}
}

31 
ngx_πmp_evÆ_t
 
	gngx_πmp_evÆ_£ssi⁄
[] = {

33 { 
ngx_°rög
("app"),

34 
ngx_πmp_evÆ_£ssi⁄_°r
,

35 
off£tof
(
ngx_πmp_£ssi⁄_t
, 
≠p
) },

37 { 
ngx_°rög
("flashver"),

38 
ngx_πmp_evÆ_£ssi⁄_°r
,

39 
off£tof
(
ngx_πmp_£ssi⁄_t
, 
Êashvî
) },

41 { 
ngx_°rög
("swfurl"),

42 
ngx_πmp_evÆ_£ssi⁄_°r
,

43 
off£tof
(
ngx_πmp_£ssi⁄_t
, 
swf_uæ
) },

45 { 
ngx_°rög
("tcurl"),

46 
ngx_πmp_evÆ_£ssi⁄_°r
,

47 
off£tof
(
ngx_πmp_£ssi⁄_t
, 
tc_uæ
) },

49 { 
ngx_°rög
("pageurl"),

50 
ngx_πmp_evÆ_£ssi⁄_°r
,

51 
off£tof
(
ngx_πmp_£ssi⁄_t
, 
∑ge_uæ
) },

53 { 
ngx_°rög
("addr"),

54 
ngx_πmp_evÆ_c⁄√˘i⁄_°r
,

55 
off£tof
(
ngx_c⁄√˘i⁄_t
, 
addr_ãxt
) },

57 
ngx_πmp_nuŒ_evÆ


62 
	$ngx_πmp_evÆ_≠≥nd
(
ngx_buf_t
 *
b
, *
d©a
, 
size_t
 
Àn
, 
ngx_log_t
 *
log
)

64 
size_t
 
buf_Àn
;

66 i‡(
b
->
œ°
 + 
Àn
 > b->
íd
) {

67 
buf_Àn
 = 2 * (
b
->
œ°
 - b->
pos
Ë+ 
Àn
;

69 
b
->
°¨t
 = 
	`ngx_Æloc
(
buf_Àn
, 
log
);

70 i‡(
b
->
°¨t
 =
NULL
) {

74 
b
->
œ°
 = 
	`ngx_˝ymem
(b->
°¨t
, b->
pos
, b->last - b->pos);

75 
b
->
pos
 = b->
°¨t
;

76 
b
->
íd
 = b->
°¨t
 + 
buf_Àn
;

79 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, 
d©a
, 
Àn
);

80 
	}
}

84 
	$ngx_πmp_evÆ_≠≥nd_v¨
(*
˘x
, 
ngx_buf_t
 *
b
, 
ngx_πmp_evÆ_t
 **
e
,

85 
ngx_°r_t
 *
«me
, 
ngx_log_t
 *
log
)

87 
ngx_uöt_t
 
k
;

88 
ngx_°r_t
 
v
;

89 
ngx_πmp_evÆ_t
 *
ì
;

91 ; *
e
; ++e) {

92 
k
 = 0, 
ì
 = *
e
;Ée->
h™dÀr
; ++k, ++ee) {

93 i‡(
ì
->
«me
.
Àn
 ==Çame->len &&

94 
	`ngx_memcmp
(
ì
->
«me
.
d©a
,Çame->d©a,Çame->
Àn
) == 0)

96 
ì
->
	`h™dÀr
(
˘x
,Ée, &
v
);

97 
	`ngx_πmp_evÆ_≠≥nd
(
b
, 
v
.
d©a
, v.
Àn
, 
log
);

101 
	}
}

104 
ngx_öt_t


105 
	$ngx_πmp_evÆ
(*
˘x
, 
ngx_°r_t
 *
ö
, 
ngx_πmp_evÆ_t
 **
e
,Çgx_°r_à*
out
,

106 
ngx_log_t
 *
log
)

108 
u_ch¨
 
c
, *
p
;

109 
ngx_°r_t
 
«me
;

110 
ngx_buf_t
 
b
;

111 
ngx_uöt_t
 
n
;

114 
NORMAL
,

115 
ESCAPE
,

116 
NAME
,

117 
SNAME


118 } 
°©e
 = 
NORMAL
;

120 
b
.
pos
 = b.
œ°
 = b.
°¨t
 = 
	`ngx_Æloc
(
NGX_RTMP_EVAL_BUFLEN
, 
log
);

121 i‡(
b
.
pos
 =
NULL
) {

122  
NGX_ERROR
;

125 
b
.
íd
 = b.
pos
 + 
NGX_RTMP_EVAL_BUFLEN
;

126 
«me
.
d©a
 = 
NULL
;

128 
n
 = 0;Ç < 
ö
->
Àn
; ++n) {

129 
p
 = &
ö
->
d©a
[
n
];

130 
c
 = *
p
;

132 
°©e
) {

133 
SNAME
:

134 i‡(
c
 != '}') {

138 
«me
.
Àn
 = 
p
 -Çame.
d©a
;

139 
	`ngx_πmp_evÆ_≠≥nd_v¨
(
˘x
, &
b
, 
e
, &
«me
, 
log
);

141 
°©e
 = 
NORMAL
;

145 
NAME
:

146 i‡(
c
 ='{' && 
«me
.
d©a
 =
p
) {

147 ++
«me
.
d©a
;

148 
°©e
 = 
SNAME
;

151 i‡((
c
 >= 'a' && c <= 'z') || (c >= 'A' && c <= 'Z')) {

155 
«me
.
Àn
 = 
p
 -Çame.
d©a
;

156 
	`ngx_πmp_evÆ_≠≥nd_v¨
(
˘x
, &
b
, 
e
, &
«me
, 
log
);

158 
NORMAL
:

159 
c
) {

161 
«me
.
d©a
 = 
p
 + 1;

162 
°©e
 = 
NAME
;

165 
°©e
 = 
ESCAPE
;

169 
ESCAPE
:

170 
	`ngx_πmp_evÆ_≠≥nd
(&
b
, &
c
, 1, 
log
);

171 
°©e
 = 
NORMAL
;

177 i‡(
°©e
 =
NAME
) {

178 
p
 = &
ö
->
d©a
[
n
];

179 
«me
.
Àn
 = 
p
 -Çame.
d©a
;

180 
	`ngx_πmp_evÆ_≠≥nd_v¨
(
˘x
, &
b
, 
e
, &
«me
, 
log
);

183 
c
 = 0;

184 
	`ngx_πmp_evÆ_≠≥nd
(&
b
, &
c
, 1, 
log
);

186 
out
->
d©a
 = 
b
.
pos
;

187 
out
->
Àn
 = 
b
.
œ°
 - b.
pos
 - 1;

189  
NGX_OK
;

190 
	}
}

193 
ngx_öt_t


194 
	$ngx_πmp_evÆ_°ªams
(
ngx_°r_t
 *
ö
)

196 #i‡!(
NGX_WIN32
)

197 
ngx_öt_t
 
mode
, 
¸óã
, 
v
, 
˛o£_§c
;

198 
ngx_fd_t
 
d°
, 
§c
;

199 
u_ch¨
 *
∑th
;

201 
∑th
 = 
ö
->
d©a
;

203 *
∑th
 >= '0' && *path <= '9') {

204 
∑th
++;

207 (Ë*
∑th
) {

211 
v
 = (
∑th
 =
ö
->
d©a
 ? 1 : 
	`ngx_©oi
(in->data,Öath - in->data));

212 i‡(
v
 =
NGX_ERROR
) {

213  
NGX_ERROR
;

216 
d°
 = (
ngx_fd_t
Ë
v
;

217 
mode
 = 
NGX_FILE_WRONLY
;

218 
¸óã
 = 
NGX_FILE_TRUNCATE
;

219 
∑th
++;

221 i‡(*
∑th
 =(
u_ch¨
) '>') {

222 
mode
 = 
NGX_FILE_APPEND
;

223 
¸óã
 = 
NGX_FILE_CREATE_OR_OPEN
;

224 
∑th
++;

231 
v
 = (
∑th
 =
ö
->
d©a
 ? 0 : 
	`ngx_©oi
(in->data,Öath - in->data));

232 i‡(
v
 =
NGX_ERROR
) {

233  
NGX_ERROR
;

236 
d°
 = (
ngx_fd_t
Ë
v
;

237 
mode
 = 
NGX_FILE_RDONLY
;

238 
¸óã
 = 
NGX_FILE_OPEN
;

239 
∑th
++;

245  
NGX_DONE
;

248 i‡(*
∑th
 =(
u_ch¨
) '&') {

250 
∑th
++;

251 
v
 = 
	`ngx_©oi
(
∑th
, 
ö
->
d©a
 + in->
Àn
 -Öath);

252 i‡(
v
 =
NGX_ERROR
) {

253  
NGX_ERROR
;

255 
§c
 = (
ngx_fd_t
Ë
v
;

256 
˛o£_§c
 = 0;

260 
§c
 = 
	`ngx_›í_fûe
(
∑th
, 
mode
, 
¸óã
, 
NGX_FILE_DEFAULT_ACCESS
);

261 i‡(
§c
 =
NGX_INVALID_FILE
) {

262  
NGX_ERROR
;

264 
˛o£_§c
 = 1;

268 i‡(
§c
 =
d°
) {

269  
NGX_OK
;

272 
	`dup2
(
§c
, 
d°
);

274 i‡(
˛o£_§c
) {

275 
	`ngx_˛o£_fûe
(
§c
);

277  
NGX_OK
;

280  
NGX_DONE
;

282 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_eval.h

7 #i‚de‡
_NGX_RTMP_EVAL_H_INCLUDED_


8 
	#_NGX_RTMP_EVAL_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

13 
	~"ngx_πmp.h
"

16 
ngx_πmp_evÆ_s
 
	tngx_πmp_evÆ_t
;

19 (* 
	tngx_πmp_evÆ_±
)(*
	t˘x
, 
	tngx_πmp_evÆ_t
 *
	te
,

20 
	tngx_°r_t
 *
	tªt
);

23 
	sngx_πmp_evÆ_s
 {

24 
ngx_°r_t
 
«me
;

25 
ngx_πmp_evÆ_±
 
h™dÀr
;

26 
ngx_uöt_t
 
off£t
;

30 
	#ngx_πmp_nuŒ_evÆ
 { 
ngx_nuŒ_°rög
, 
NULL
, 0 
	}

	)
}

34 
ngx_πmp_evÆ_t
 
ngx_πmp_evÆ_£ssi⁄
[];

37 
ngx_öt_t
 
ngx_πmp_evÆ
(*
˘x
, 
ngx_°r_t
 *
ö
, 
ngx_πmp_evÆ_t
 **
e
,

38 
ngx_°r_t
 *
out
, 
ngx_log_t
 *
log
);

41 
ngx_öt_t
 
ngx_πmp_evÆ_°ªams
(
ngx_°r_t
 *
ö
);

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_exec_module.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp_cmd_moduÀ.h
"

10 
	~"ngx_πmp_ªc‹d_moduÀ.h
"

11 
	~"ngx_πmp_evÆ.h
"

12 
	~<°dlib.h
>

14 #ifde‡
NGX_LINUX


15 
	~<uni°d.h
>

19 #i‡!(
NGX_WIN32
)

20 
ngx_πmp_publish_±
 
	g√xt_publish
;

21 
ngx_πmp_∂ay_±
 
	g√xt_∂ay
;

22 
ngx_πmp_˛o£_°ªam_±
 
	g√xt_˛o£_°ªam
;

23 
ngx_πmp_ªc‹d_d⁄e_±
 
	g√xt_ªc‹d_d⁄e
;

27 
ngx_öt_t
 
ngx_πmp_exec_öô_¥o˚ss
(
ngx_cy˛e_t
 *
cy˛e
);

28 
ngx_öt_t
 
ngx_πmp_exec_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
);

29 * 
ngx_πmp_exec_¸óã_maö_c⁄f
(
ngx_c⁄f_t
 *
cf
);

30 * 
ngx_πmp_exec_öô_maö_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
c⁄f
);

31 * 
ngx_πmp_exec_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
);

32 * 
ngx_πmp_exec_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
,

33 *
∑ª¡
, *
chûd
);

36 * 
ngx_πmp_exec_c⁄f
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
,

37 *
c⁄f
);

38 *
ngx_πmp_exec_kûl_sig«l
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
,

39 *
c⁄f
);

42 
	#NGX_RTMP_EXEC_RESPAWN
 0x01

	)

43 
	#NGX_RTMP_EXEC_KILL
 0x02

	)

46 
	#NGX_RTMP_EXEC_PUBLISHING
 0x01

	)

47 
	#NGX_RTMP_EXEC_PLAYING
 0x02

	)

51 
	mNGX_RTMP_EXEC_PUSH
,

52 
	mNGX_RTMP_EXEC_PULL
,

54 
	mNGX_RTMP_EXEC_PUBLISH
,

55 
	mNGX_RTMP_EXEC_PUBLISH_DONE
,

56 
	mNGX_RTMP_EXEC_PLAY
,

57 
	mNGX_RTMP_EXEC_PLAY_DONE
,

58 
	mNGX_RTMP_EXEC_RECORD_DONE
,

60 
	mNGX_RTMP_EXEC_MAX
,

62 
	mNGX_RTMP_EXEC_STATIC


67 
ngx_°r_t
 
	mid
;

68 
ngx_uöt_t
 
	mty≥
;

69 
ngx_°r_t
 
	mcmd
;

70 
ngx_¨øy_t
 
	m¨gs
;

71 
ngx_¨øy_t
 
	m«mes
;

72 } 
	tngx_πmp_exec_c⁄f_t
;

76 
ngx_πmp_exec_c⁄f_t
 *
	mc⁄f
;

77 
ngx_log_t
 *
	mlog
;

78 
ngx_πmp_evÆ_t
 **
	mevÆ
;

79 *
	mevÆ_˘x
;

80 
	ma˘ive
:1;

81 
	mm™aged
:1;

82 
ngx_pid_t
 
	mpid
;

83 
ngx_pid_t
 *
	mßve_pid
;

84 
	mpùefd
;

85 
ngx_c⁄√˘i⁄_t
 
	mdummy_c⁄n
;

86 
ngx_evít_t
 
	mªad_evt
, 
	mwrôe_evt
;

87 
ngx_evít_t
 
	mª•awn_evt
;

88 
ngx_m£c_t
 
	mª•awn_timeout
;

89 
ngx_öt_t
 
	mkûl_sig«l
;

90 } 
	tngx_πmp_exec_t
;

94 
ngx_¨øy_t
 
	m°©ic_c⁄f
;

95 
ngx_¨øy_t
 
	m°©ic_exec
;

96 
ngx_m£c_t
 
	mª•awn_timeout
;

97 
ngx_öt_t
 
	mkûl_sig«l
;

98 
ngx_log_t
 *
	mlog
;

99 } 
	tngx_πmp_exec_maö_c⁄f_t
;

102 
ngx_πmp_exec_puŒ_˘x_s
 
	tngx_πmp_exec_puŒ_˘x_t
;

104 
	sngx_πmp_exec_puŒ_˘x_s
 {

105 
ngx_poﬁ_t
 *
	mpoﬁ
;

106 
ngx_uöt_t
 
	mcou¡î
;

107 
ngx_°r_t
 
	m«me
;

108 
ngx_°r_t
 
	m≠p
;

109 
ngx_¨øy_t
 
	mpuŒ_exec
;

110 
ngx_πmp_exec_puŒ_˘x_t
 *
	m√xt
;

115 
ngx_öt_t
 
	ma˘ive
;

116 
ngx_¨øy_t
 
	mc⁄f
[
NGX_RTMP_EXEC_MAX
];

118 
ngx_Êag_t
 
	mª•awn
;

119 
ngx_Êag_t
 
	m›ti⁄s
;

120 
ngx_uöt_t
 
	mnbuckës
;

121 
ngx_πmp_exec_puŒ_˘x_t
 **
	mpuŒ
;

122 } 
	tngx_πmp_exec_≠p_c⁄f_t
;

126 
ngx_uöt_t
 
	mÊags
;

127 
ngx_°r_t
 
	m∑th
;

128 
ngx_°r_t
 
	mfûíame
;

129 
ngx_°r_t
 
	mba£«me
;

130 
ngx_°r_t
 
	mdú«me
;

131 
ngx_°r_t
 
	mªc‹dî
;

132 
u_ch¨
 
	m«me
[
NGX_RTMP_MAX_NAME
];

133 
u_ch¨
 
	m¨gs
[
NGX_RTMP_MAX_ARGS
];

134 
ngx_¨øy_t
 
	mpush_exec
;

135 
ngx_πmp_exec_puŒ_˘x_t
 *
	mpuŒ
;

136 } 
	tngx_πmp_exec_˘x_t
;

139 #i‡!(
NGX_WIN32
)

140 
ngx_πmp_exec_ª•awn
(
ngx_evít_t
 *
ev
);

141 
ngx_öt_t
 
ngx_πmp_exec_kûl
(
ngx_πmp_exec_t
 *
e
,Çgx_öt_à
kûl_sig«l
);

142 
ngx_öt_t
 
ngx_πmp_exec_run
(
ngx_πmp_exec_t
 *
e
);

146 
ngx_comm™d_t
 
	gngx_πmp_exec_comm™ds
[] = {

155 { 
ngx_°rög
("exec"),

156 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_1MORE
,

157 
ngx_πmp_exec_c⁄f
,

158 
NGX_RTMP_APP_CONF_OFFSET
,

159 
off£tof
(
ngx_πmp_exec_≠p_c⁄f_t
, 
c⁄f
) +

160 
NGX_RTMP_EXEC_PUSH
 * (
ngx_¨øy_t
),

161 
NULL
 },

163 { 
ngx_°rög
("exec_push"),

164 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_1MORE
,

165 
ngx_πmp_exec_c⁄f
,

166 
NGX_RTMP_APP_CONF_OFFSET
,

167 
off£tof
(
ngx_πmp_exec_≠p_c⁄f_t
, 
c⁄f
) +

168 
NGX_RTMP_EXEC_PUSH
 * (
ngx_¨øy_t
),

169 
NULL
 },

171 { 
ngx_°rög
("exec_pull"),

172 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_1MORE
,

173 
ngx_πmp_exec_c⁄f
,

174 
NGX_RTMP_APP_CONF_OFFSET
,

175 
off£tof
(
ngx_πmp_exec_≠p_c⁄f_t
, 
c⁄f
) +

176 
NGX_RTMP_EXEC_PULL
 * (
ngx_¨øy_t
),

177 
NULL
 },

179 { 
ngx_°rög
("exec_publish"),

180 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_1MORE
,

181 
ngx_πmp_exec_c⁄f
,

182 
NGX_RTMP_APP_CONF_OFFSET
,

183 
off£tof
(
ngx_πmp_exec_≠p_c⁄f_t
, 
c⁄f
) +

184 
NGX_RTMP_EXEC_PUBLISH
 * (
ngx_¨øy_t
),

185 
NULL
 },

187 { 
ngx_°rög
("exec_publish_done"),

188 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_1MORE
,

189 
ngx_πmp_exec_c⁄f
,

190 
NGX_RTMP_APP_CONF_OFFSET
,

191 
off£tof
(
ngx_πmp_exec_≠p_c⁄f_t
, 
c⁄f
) +

192 
NGX_RTMP_EXEC_PUBLISH_DONE
 * (
ngx_¨øy_t
),

193 
NULL
 },

195 { 
ngx_°rög
("exec_play"),

196 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_1MORE
,

197 
ngx_πmp_exec_c⁄f
,

198 
NGX_RTMP_APP_CONF_OFFSET
,

199 
off£tof
(
ngx_πmp_exec_≠p_c⁄f_t
, 
c⁄f
) +

200 
NGX_RTMP_EXEC_PLAY
 * (
ngx_¨øy_t
),

201 
NULL
 },

203 { 
ngx_°rög
("exec_play_done"),

204 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_1MORE
,

205 
ngx_πmp_exec_c⁄f
,

206 
NGX_RTMP_APP_CONF_OFFSET
,

207 
off£tof
(
ngx_πmp_exec_≠p_c⁄f_t
, 
c⁄f
) +

208 
NGX_RTMP_EXEC_PLAY_DONE
 * (
ngx_¨øy_t
),

209 
NULL
 },

211 { 
ngx_°rög
("exec_record_done"),

212 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_RTMP_REC_CONF
|

213 
NGX_CONF_1MORE
,

214 
ngx_πmp_exec_c⁄f
,

215 
NGX_RTMP_APP_CONF_OFFSET
,

216 
off£tof
(
ngx_πmp_exec_≠p_c⁄f_t
, 
c⁄f
) +

217 
NGX_RTMP_EXEC_RECORD_DONE
 * (
ngx_¨øy_t
),

218 
NULL
 },

220 { 
ngx_°rög
("exec_static"),

221 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_1MORE
,

222 
ngx_πmp_exec_c⁄f
,

223 
NGX_RTMP_MAIN_CONF_OFFSET
,

224 
off£tof
(
ngx_πmp_exec_maö_c⁄f_t
, 
°©ic_c⁄f
),

225 
NULL
 },

227 { 
ngx_°rög
("respawn"),

228 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

229 
ngx_c⁄f_£t_Êag_¶Ÿ
,

230 
NGX_RTMP_APP_CONF_OFFSET
,

231 
off£tof
(
ngx_πmp_exec_≠p_c⁄f_t
, 
ª•awn
),

232 
NULL
 },

234 { 
ngx_°rög
("respawn_timeout"),

235 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

236 
ngx_c⁄f_£t_m£c_¶Ÿ
,

237 
NGX_RTMP_MAIN_CONF_OFFSET
,

238 
off£tof
(
ngx_πmp_exec_maö_c⁄f_t
, 
ª•awn_timeout
),

239 
NULL
 },

241 { 
ngx_°rög
("exec_kill_signal"),

242 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

243 
ngx_πmp_exec_kûl_sig«l
,

244 
NGX_RTMP_MAIN_CONF_OFFSET
,

246 
NULL
 },

248 { 
ngx_°rög
("exec_options"),

249 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

250 
ngx_c⁄f_£t_Êag_¶Ÿ
,

251 
NGX_RTMP_APP_CONF_OFFSET
,

252 
off£tof
(
ngx_πmp_exec_≠p_c⁄f_t
, 
›ti⁄s
),

253 
NULL
 },

255 
ngx_nuŒ_comm™d


259 
ngx_πmp_moduÀ_t
 
	gngx_πmp_exec_moduÀ_˘x
 = {

260 
NULL
,

261 
ngx_πmp_exec_po°c⁄figuøti⁄
,

262 
ngx_πmp_exec_¸óã_maö_c⁄f
,

263 
ngx_πmp_exec_öô_maö_c⁄f
,

264 
NULL
,

265 
NULL
,

266 
ngx_πmp_exec_¸óã_≠p_c⁄f
,

267 
ngx_πmp_exec_mîge_≠p_c⁄f


271 
ngx_moduÀ_t
 
	gngx_πmp_exec_moduÀ
 = {

272 
NGX_MODULE_V1
,

273 &
ngx_πmp_exec_moduÀ_˘x
,

274 
ngx_πmp_exec_comm™ds
,

275 
NGX_RTMP_MODULE
,

276 
NULL
,

277 
NULL
,

278 
ngx_πmp_exec_öô_¥o˚ss
,

279 
NULL
,

280 
NULL
,

281 
NULL
,

282 
NULL
,

283 
NGX_MODULE_V1_PADDING


288 
	$ngx_πmp_exec_evÆ_˘x_c°r
(*
s˘x
, 
ngx_πmp_evÆ_t
 *
e
, 
ngx_°r_t
 *
ªt
)

290 
ngx_πmp_£ssi⁄_t
 *
s
 = 
s˘x
;

292 
ngx_πmp_exec_˘x_t
 *
˘x
;

294 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_exec_moduÀ
);

295 i‡(
˘x
 =
NULL
) {

296 
ªt
->
Àn
 = 0;

300 
ªt
->
d©a
 = (
u_ch¨
 *Ë
˘x
 + 
e
->
off£t
;

301 
ªt
->
Àn
 = 
	`ngx_°æí
‘ë->
d©a
);

302 
	}
}

306 
	$ngx_πmp_exec_evÆ_˘x_°r
(*
s˘x
, 
ngx_πmp_evÆ_t
 *
e
, 
ngx_°r_t
 *
ªt
)

308 
ngx_πmp_£ssi⁄_t
 *
s
 = 
s˘x
;

310 
ngx_πmp_exec_˘x_t
 *
˘x
;

312 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_exec_moduÀ
);

313 i‡(
˘x
 =
NULL
) {

314 
ªt
->
Àn
 = 0;

318 *
ªt
 = * (
ngx_°r_t
 *Ë((
u_ch¨
 *Ë
˘x
 + 
e
->
off£t
);

319 
	}
}

323 
	$ngx_πmp_exec_evÆ_p˘x_°r
(*
˘x
, 
ngx_πmp_evÆ_t
 *
e
, 
ngx_°r_t
 *
ªt
)

325 *
ªt
 = *(
ngx_°r_t
 *Ë((
u_ch¨
 *Ë
˘x
 + 
e
->
off£t
);

326 
	}
}

329 
ngx_πmp_evÆ_t
 
	gngx_πmp_exec_push_•ecific_evÆ
[] = {

331 { 
ngx_°rög
("name"),

332 
ngx_πmp_exec_evÆ_˘x_c°r
,

333 
off£tof
(
ngx_πmp_exec_˘x_t
, 
«me
) },

335 { 
ngx_°rög
("args"),

336 
ngx_πmp_exec_evÆ_˘x_c°r
,

337 
off£tof
(
ngx_πmp_exec_˘x_t
, 
¨gs
) },

339 
ngx_πmp_nuŒ_evÆ


343 
ngx_πmp_evÆ_t
 * 
	gngx_πmp_exec_push_evÆ
[] = {

344 
ngx_πmp_evÆ_£ssi⁄
,

345 
ngx_πmp_exec_push_•ecific_evÆ
,

346 
NULL


350 
ngx_πmp_evÆ_t
 
	gngx_πmp_exec_puŒ_•ecific_evÆ
[] = {

352 { 
ngx_°rög
("name"),

353 
ngx_πmp_exec_evÆ_p˘x_°r
,

354 
off£tof
(
ngx_πmp_exec_puŒ_˘x_t
, 
«me
) },

356 { 
ngx_°rög
("app"),

357 
ngx_πmp_exec_evÆ_p˘x_°r
,

358 
off£tof
(
ngx_πmp_exec_puŒ_˘x_t
, 
≠p
) },

360 
ngx_πmp_nuŒ_evÆ


364 
ngx_πmp_evÆ_t
 * 
	gngx_πmp_exec_puŒ_evÆ
[] = {

365 
ngx_πmp_exec_puŒ_•ecific_evÆ
,

366 
NULL


370 
ngx_πmp_evÆ_t
 
	gngx_πmp_exec_evít_•ecific_evÆ
[] = {

372 { 
ngx_°rög
("name"),

373 
ngx_πmp_exec_evÆ_˘x_c°r
,

374 
off£tof
(
ngx_πmp_exec_˘x_t
, 
«me
) },

376 { 
ngx_°rög
("args"),

377 
ngx_πmp_exec_evÆ_˘x_c°r
,

378 
off£tof
(
ngx_πmp_exec_˘x_t
, 
¨gs
) },

380 { 
ngx_°rög
("path"),

381 
ngx_πmp_exec_evÆ_˘x_°r
,

382 
off£tof
(
ngx_πmp_exec_˘x_t
, 
∑th
) },

384 { 
ngx_°rög
("filename"),

385 
ngx_πmp_exec_evÆ_˘x_°r
,

386 
off£tof
(
ngx_πmp_exec_˘x_t
, 
fûíame
) },

388 { 
ngx_°rög
("basename"),

389 
ngx_πmp_exec_evÆ_˘x_°r
,

390 
off£tof
(
ngx_πmp_exec_˘x_t
, 
ba£«me
) },

392 { 
ngx_°rög
("dirname"),

393 
ngx_πmp_exec_evÆ_˘x_°r
,

394 
off£tof
(
ngx_πmp_exec_˘x_t
, 
dú«me
) },

396 { 
ngx_°rög
("recorder"),

397 
ngx_πmp_exec_evÆ_˘x_°r
,

398 
off£tof
(
ngx_πmp_exec_˘x_t
, 
ªc‹dî
) },

400 
ngx_πmp_nuŒ_evÆ


404 
ngx_πmp_evÆ_t
 * 
	gngx_πmp_exec_evít_evÆ
[] = {

405 
ngx_πmp_evÆ_£ssi⁄
,

406 
ngx_πmp_exec_evít_•ecific_evÆ
,

407 
NULL


412 
	$ngx_πmp_exec_¸óã_maö_c⁄f
(
ngx_c⁄f_t
 *
cf
)

414 
ngx_πmp_exec_maö_c⁄f_t
 *
emcf
;

416 
emcf
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_exec_maö_c⁄f_t
));

417 i‡(
emcf
 =
NULL
) {

418  
NULL
;

421 
emcf
->
ª•awn_timeout
 = 
NGX_CONF_UNSET_MSEC
;

422 
emcf
->
kûl_sig«l
 = 
NGX_CONF_UNSET
;

424 i‡(
	`ngx_¨øy_öô
(&
emcf
->
°©ic_c⁄f
, 
cf
->
poﬁ
, 1,

425 (
ngx_πmp_exec_c⁄f_t
)Ë!
NGX_OK
)

427  
NULL
;

430  
emcf
;

431 
	}
}

435 
	$ngx_πmp_exec_öô_maö_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
c⁄f
)

437 
ngx_πmp_exec_maö_c⁄f_t
 *
emcf
 = 
c⁄f
;

438 
ngx_πmp_exec_c⁄f_t
 *
ec
;

439 
ngx_πmp_exec_t
 *
e
;

440 
ngx_uöt_t
 
n
;

442 i‡(
emcf
->
ª•awn_timeout
 =
NGX_CONF_UNSET_MSEC
) {

443 
emcf
->
ª•awn_timeout
 = 5000;

446 #i‡!(
NGX_WIN32
)

447 i‡(
emcf
->
kûl_sig«l
 =
NGX_CONF_UNSET
) {

448 
emcf
->
kûl_sig«l
 = 
SIGKILL
;

452 i‡(
	`ngx_¨øy_öô
(&
emcf
->
°©ic_exec
, 
cf
->
poﬁ
,

453 
emcf
->
°©ic_c⁄f
.
√…s
,

454 (
ngx_πmp_exec_t
)Ë!
NGX_OK
)

456  
NGX_CONF_ERROR
;

459 
e
 = 
	`ngx_¨øy_push_n
(&
emcf
->
°©ic_exec
,Émcf->
°©ic_c⁄f
.
√…s
);

460 i‡(
e
 =
NULL
) {

461  
NGX_CONF_ERROR
;

464 
emcf
->
log
 = &
cf
->
cy˛e
->
√w_log
;

466 
ec
 = 
emcf
->
°©ic_c⁄f
.
ñts
;

468 
n
 = 0;Ç < 
emcf
->
°©ic_c⁄f
.
√…s
;Ç++, 
e
++, 
ec
++) {

469 
	`ngx_memzîo
(
e
, (*e));

470 
e
->
c⁄f
 = 
ec
;

471 
e
->
m™aged
 = 1;

472 
e
->
log
 = 
emcf
->log;

473 
e
->
ª•awn_timeout
 = 
emcf
->respawn_timeout;

474 
e
->
kûl_sig«l
 = 
emcf
->kill_signal;

477  
NGX_CONF_OK
;

478 
	}
}

482 
	$ngx_πmp_exec_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
)

484 
ngx_πmp_exec_≠p_c⁄f_t
 *
ócf
;

486 
ócf
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_exec_≠p_c⁄f_t
));

487 i‡(
ócf
 =
NULL
) {

488  
NULL
;

491 
ócf
->
ª•awn
 = 
NGX_CONF_UNSET
;

492 
ócf
->
›ti⁄s
 = 
NGX_CONF_UNSET
;

493 
ócf
->
nbuckës
 = 
NGX_CONF_UNSET_UINT
;

495  
ócf
;

496 
	}
}

499 
ngx_öt_t


500 
	$ngx_πmp_exec_mîge_c⁄fs
(
ngx_¨øy_t
 *
c⁄f
,Çgx_¨øy_à*
¥ev
)

502 
size_t
 
n
;

503 
ngx_πmp_exec_c⁄f_t
 *
ec
, *
≥c
;

505 i‡(
¥ev
->
√…s
 == 0) {

506  
NGX_OK
;

509 i‡(
c⁄f
->
√…s
 == 0) {

510 *
c⁄f
 = *
¥ev
;

511  
NGX_OK
;

514 
ec
 = 
	`ngx_¨øy_push_n
(
c⁄f
, 
¥ev
->
√…s
);

515 i‡(
ec
 =
NULL
) {

516  
NGX_ERROR
;

519 
≥c
 = 
¥ev
->
ñts
;

520 
n
 = 0;Ç < 
¥ev
->
√…s
;Ç++, 
ec
++, 
≥c
++) {

521 *
ec
 = *
≥c
;

524  
NGX_OK
;

525 
	}
}

529 
	$ngx_πmp_exec_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
∑ª¡
, *
chûd
)

531 
ngx_πmp_exec_≠p_c⁄f_t
 *
¥ev
 = 
∑ª¡
;

532 
ngx_πmp_exec_≠p_c⁄f_t
 *
c⁄f
 = 
chûd
;

534 
ngx_uöt_t
 
n
;

536 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
ª•awn
, 
¥ev
->respawn, 1);

537 
	`ngx_c⁄f_mîge_uöt_vÆue
(
c⁄f
->
nbuckës
, 
¥ev
->nbuckets, 1024);

539 
n
 = 0;Ç < 
NGX_RTMP_EXEC_MAX
;Ç++) {

540 i‡(
	`ngx_πmp_exec_mîge_c⁄fs
(&
c⁄f
->c⁄f[
n
], &
¥ev
->c⁄f[n]Ë!
NGX_OK
)

542  
NGX_CONF_ERROR
;

545 i‡(
c⁄f
->c⁄f[
n
].
√…s
) {

546 
c⁄f
->
a˘ive
 = 1;

547 
¥ev
->
a˘ive
 = 1;

551 i‡(
c⁄f
->c⁄f[
NGX_RTMP_EXEC_PULL
].
√…s
 > 0) {

552 
c⁄f
->
puŒ
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (*Ë* c⁄f->
nbuckës
);

553 i‡(
c⁄f
->
puŒ
 =
NULL
) {

554  
NGX_CONF_ERROR
;

558  
NGX_CONF_OK
;

559 
	}
}

562 
ngx_öt_t


563 
	$ngx_πmp_exec_öô_¥o˚ss
(
ngx_cy˛e_t
 *
cy˛e
)

565 #i‡!(
NGX_WIN32
)

566 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
 = 
ngx_πmp_c‹e_maö_c⁄f
;

567 
ngx_πmp_c‹e_§v_c⁄f_t
 **
cscf
;

568 
ngx_πmp_c⁄f_˘x_t
 *
c˘x
;

569 
ngx_πmp_exec_maö_c⁄f_t
 *
emcf
;

570 
ngx_πmp_exec_t
 *
e
;

571 
ngx_uöt_t
 
n
;

573 i‡(
cmcf
 =
NULL
 || cmcf->
£rvîs
.
√…s
 == 0) {

574  
NGX_OK
;

578 i‡(
ngx_¥o˚ss_¶Ÿ
) {

579  
NGX_OK
;

582 
cscf
 = 
cmcf
->
£rvîs
.
ñts
;

583 
c˘x
 = (*
cscf
)->
˘x
;

584 
emcf
 = 
c˘x
->
maö_c⁄f
[
ngx_πmp_exec_moduÀ
.
˘x_ödex
];

597 
e
 = 
emcf
->
°©ic_exec
.
ñts
;

598 
n
 = 0;Ç < 
emcf
->
°©ic_exec
.
√…s
; ++n, ++
e
) {

599 
e
->
ª•awn_evt
.
d©a
 =É;

600 
e
->
ª•awn_evt
.
log
 =É->log;

601 
e
->
ª•awn_evt
.
h™dÀr
 = 
ngx_πmp_exec_ª•awn
;

602 
	`ngx_po°_evít
((&
e
->
ª•awn_evt
), &
ngx_πmp_öô_queue
);

606  
NGX_OK
;

607 
	}
}

610 #i‡!(
NGX_WIN32
)

612 
	$ngx_πmp_exec_ª•awn
(
ngx_evít_t
 *
ev
)

614 
	`ngx_πmp_exec_run
((
ngx_πmp_exec_t
 *Ë
ev
->
d©a
);

615 
	}
}

619 
	$ngx_πmp_exec_chûd_dód
(
ngx_evít_t
 *
ev
)

621 
ngx_c⁄√˘i⁄_t
 *
dummy_c⁄n
 = 
ev
->
d©a
;

622 
ngx_πmp_exec_t
 *
e
;

624 
e
 = 
dummy_c⁄n
->
d©a
;

626 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
e
->
log
, 0,

627 "exec: chûd %uòexôed; %s", (
ngx_öt_t
Ë
e
->
pid
,

628 
e
->
ª•awn_timeout
 =
NGX_CONF_UNSET_MSEC
 ? "respawning" :

631 
	`ngx_πmp_exec_kûl
(
e
, 0);

633 i‡(
e
->
ª•awn_timeout
 =
NGX_CONF_UNSET_MSEC
) {

637 i‡(
e
->
ª•awn_timeout
 == 0) {

638 
	`ngx_πmp_exec_run
(
e
);

642 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
e
->
log
, 0,

643 "exec: sheduÀÑe•aw¿%Mm£c", 
e
->
ª•awn_timeout
);

645 
e
->
ª•awn_evt
.
d©a
 =É;

646 
e
->
ª•awn_evt
.
log
 =É->log;

647 
e
->
ª•awn_evt
.
h™dÀr
 = 
ngx_πmp_exec_ª•awn
;

649 
	`ngx_add_timî
(&
e
->
ª•awn_evt
,É->
ª•awn_timeout
);

650 
	}
}

653 
ngx_öt_t


654 
	$ngx_πmp_exec_kûl
(
ngx_πmp_exec_t
 *
e
, 
ngx_öt_t
 
kûl_sig«l
)

656 i‡(
e
->
ª•awn_evt
.
timî_£t
) {

657 
	`ngx_dñ_timî
(&
e
->
ª•awn_evt
);

660 i‡(
e
->
ªad_evt
.
a˘ive
) {

661 
	`ngx_dñ_evít
(&
e
->
ªad_evt
, 
NGX_READ_EVENT
, 0);

664 i‡(
e
->
a˘ive
 == 0) {

665  
NGX_OK
;

668 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
e
->
log
, 0,

669 "exec:Åîmö©ög chûd %ui", (
ngx_öt_t
Ë
e
->
pid
);

671 
e
->
a˘ive
 = 0;

672 
	`˛o£
(
e
->
pùefd
);

673 i‡(
e
->
ßve_pid
) {

674 *
e
->
ßve_pid
 = 
NGX_INVALID_PID
;

677 i‡(
kûl_sig«l
 == 0) {

678  
NGX_OK
;

681 i‡(
	`kûl
(
e
->
pid
, 
kûl_sig«l
) == -1) {

682 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
e
->
log
, 
ngx_î∫o
,

683 "exec: kû»ÁûedÖid=%i", (
ngx_öt_t
Ë
e
->
pid
);

685 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
e
->
log
, 0,

686 "exec: kûÀdÖid=%i", (
ngx_öt_t
Ë
e
->
pid
);

689  
NGX_OK
;

690 
	}
}

693 
ngx_öt_t


694 
	$ngx_πmp_exec_run
(
ngx_πmp_exec_t
 *
e
)

696 
fd
, 
ªt
, 
maxfd
, 
pùefd
[2];

697 **
¨gs
, **
¨g_out
;

698 
ngx_pid_t
 
pid
;

699 
ngx_°r_t
 *
¨g_ö
, 
a
;

700 
ngx_uöt_t
 
n
;

701 
ngx_πmp_exec_c⁄f_t
 *
ec
;

703 
ec
 = 
e
->
c⁄f
;

705 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
e
->
log
, 0,

707 
e
->
m™aged
 ? "m™aged" : "unm™aged", &
ec
->
cmd
);

709 
pùefd
[0] = -1;

710 
pùefd
[1] = -1;

712 i‡(
e
->
m™aged
) {

714 i‡(
e
->
a˘ive
) {

715 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
e
->
log
, 0,

716 "exec:áÃódyá˘ivê'%V'", &
ec
->
cmd
);

717  
NGX_OK
;

720 i‡(
	`pùe
(
pùefd
) == -1) {

721 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
e
->
log
, 
ngx_î∫o
,

723  
NGX_ERROR
;

728 
ªt
 = 
	`f˙é
(
pùefd
[1], 
F_GETFD
);

730 i‡(
ªt
 != -1) {

731 
ªt
 &~
FD_CLOEXEC
;

732 
ªt
 = 
	`f˙é
(
pùefd
[1], 
F_SETFD
,Ñet);

735 i‡(
ªt
 == -1) {

737 
	`˛o£
(
pùefd
[0]);

738 
	`˛o£
(
pùefd
[1]);

740 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
e
->
log
, 
ngx_î∫o
,

743  
NGX_ERROR
;

747 
pid
 = 
	`f‹k
();

749 
pid
) {

755 i‡(
pùefd
[0] != -1) {

756 
	`˛o£
(
pùefd
[0]);

759 i‡(
pùefd
[1] != -1) {

760 
	`˛o£
(
pùefd
[1]);

763 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
e
->
log
, 
ngx_î∫o
,

766  
NGX_ERROR
;

772 #i‡(
NGX_LINUX
)

773 i‡(
e
->
m™aged
) {

774 
	`¥˘l
(
PR_SET_PDEATHSIG
, 
e
->
kûl_sig«l
, 0, 0, 0);

780 
maxfd
 = 
	`sysc⁄f
(
_SC_OPEN_MAX
);

781 
fd
 = 0; fd < 
maxfd
; ++fd) {

782 i‡(
fd
 =
pùefd
[1]) {

786 
	`˛o£
(
fd
);

789 
fd
 = 
	`›í
("/dev/nuŒ", 
O_RDWR
);

791 
	`dup2
(
fd
, 
STDIN_FILENO
);

792 
	`dup2
(
fd
, 
STDOUT_FILENO
);

793 
	`dup2
(
fd
, 
STDERR_FILENO
);

795 
¨gs
 = 
	`ngx_Æloc
((
ec
->¨gs.
√…s
 + 2Ë* (*), 
e
->
log
);

796 i‡(
¨gs
 =
NULL
) {

797 
	`exô
(1);

800 
¨g_ö
 = 
ec
->
¨gs
.
ñts
;

801 
¨g_out
 = 
¨gs
;

802 *
¨g_out
++ = (*Ë
ec
->
cmd
.
d©a
;

804 
n
 = 0;Ç < 
ec
->
¨gs
.
√…s
;Ç++, ++
¨g_ö
) {

806 i‡(
e
->
evÆ
 =
NULL
) {

807 
a
 = *
¨g_ö
;

809 
	`ngx_πmp_evÆ
(
e
->
evÆ_˘x
, 
¨g_ö
,É->
evÆ
, &
a
,É->
log
);

812 i‡(
	`ngx_πmp_evÆ_°ªams
(&
a
Ë!
NGX_DONE
) {

816 *
¨g_out
++ = (*Ë
a
.
d©a
;

819 *
¨g_out
 = 
NULL
;

821 #i‡(
NGX_DEBUG
)

823 **
p
;

825 
p
 = 
¨gs
; *p;Ö++) {

826 
	`ngx_wrôe_fd
(
STDERR_FILENO
, "'", 1);

827 
	`ngx_wrôe_fd
(
STDERR_FILENO
, *
p
, 
	`°æí
(*p));

828 
	`ngx_wrôe_fd
(
STDERR_FILENO
, "' ", 2);

831 
	`ngx_wrôe_fd
(
STDERR_FILENO
, "\n", 1);

835 i‡(
	`execvp
((*Ë
ec
->
cmd
.
d©a
, 
¨gs
) == -1) {

836 *
msg
;

838 
msg
 = 
	`°ªº‹
(
î∫o
);

840 
	`ngx_wrôe_fd
(
STDERR_FILENO
, "execvpÉrror: ", 14);

841 
	`ngx_wrôe_fd
(
STDERR_FILENO
, 
msg
, 
	`°æí
(msg));

842 
	`ngx_wrôe_fd
(
STDERR_FILENO
, "\n", 1);

844 
	`exô
(1);

853 i‡(
pùefd
[1] != -1) {

854 
	`˛o£
(
pùefd
[1]);

857 i‡(
pùefd
[0] != -1) {

859 
e
->
a˘ive
 = 1;

860 
e
->
pid
 =Öid;

861 
e
->
pùefd
 =Öipefd[0];

863 i‡(
e
->
ßve_pid
) {

864 *
e
->
ßve_pid
 = 
pid
;

867 
e
->
dummy_c⁄n
.
fd
 =É->
pùefd
;

868 
e
->
dummy_c⁄n
.
d©a
 =É;

869 
e
->
dummy_c⁄n
.
ªad
 = &e->
ªad_evt
;

870 
e
->
dummy_c⁄n
.
wrôe
 = &e->
wrôe_evt
;

871 
e
->
ªad_evt
.
d©a
 = &e->
dummy_c⁄n
;

872 
e
->
wrôe_evt
.
d©a
 = &e->
dummy_c⁄n
;

874 
e
->
ªad_evt
.
log
 =É->log;

875 
e
->
ªad_evt
.
h™dÀr
 = 
ngx_πmp_exec_chûd_dód
;

877 i‡(
	`ngx_add_evít
(&
e
->
ªad_evt
, 
NGX_READ_EVENT
, 0Ë!
NGX_OK
) {

878 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
e
->
log
, 
ngx_î∫o
,

883 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
e
->
log
, 0,

885 &
ec
->
cmd
, (
ngx_öt_t
Ë
pid
);

889  
NGX_OK
;

890 
	}
}

893 
ngx_öt_t


894 
	$ngx_πmp_exec_öô_˘x
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 
«me
[
NGX_RTMP_MAX_NAME
],

895 
u_ch¨
 
¨gs
[
NGX_RTMP_MAX_ARGS
], 
ngx_uöt_t
 
Êags
)

897 
ngx_uöt_t
 
n
;

898 
ngx_¨øy_t
 *
push_c⁄f
;

899 
ngx_πmp_exec_t
 *
e
;

900 
ngx_πmp_exec_˘x_t
 *
˘x
;

901 
ngx_πmp_exec_c⁄f_t
 *
ec
;

902 
ngx_πmp_exec_≠p_c⁄f_t
 *
ócf
;

903 
ngx_πmp_exec_maö_c⁄f_t
 *
emcf
;

905 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_exec_moduÀ
);

907 i‡(
˘x
 !
NULL
) {

908 
d⁄e
;

911 
˘x
 = 
	`ngx_pˇŒoc
(
s
->
c⁄√˘i⁄
->
poﬁ
, (
ngx_πmp_exec_˘x_t
));

913 i‡(
˘x
 =
NULL
) {

914  
NGX_ERROR
;

917 
	`ngx_πmp_£t_˘x
(
s
, 
˘x
, 
ngx_πmp_exec_moduÀ
);

919 
ócf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_exec_moduÀ
);

921 
emcf
 = 
	`ngx_πmp_gë_moduÀ_maö_c⁄f
(
s
, 
ngx_πmp_exec_moduÀ
);

923 
push_c⁄f
 = &
ócf
->
c⁄f
[
NGX_RTMP_EXEC_PUSH
];

925 i‡(
push_c⁄f
->
√…s
 > 0) {

927 i‡(
	`ngx_¨øy_öô
(&
˘x
->
push_exec
, 
s
->
c⁄√˘i⁄
->
poﬁ
,

928 
push_c⁄f
->
√…s
,

929 (
ngx_πmp_exec_t
)Ë!
NGX_OK
)

931  
NGX_ERROR
;

934 
e
 = 
	`ngx_¨øy_push_n
(&
˘x
->
push_exec
, 
push_c⁄f
->
√…s
);

936 i‡(
e
 =
NULL
) {

937  
NGX_ERROR
;

940 
ec
 = 
push_c⁄f
->
ñts
;

942 
n
 = 0;Ç < 
push_c⁄f
->
√…s
;Ç++, 
e
++, 
ec
++) {

943 
	`ngx_memzîo
(
e
, (*e));

944 
e
->
c⁄f
 = 
ec
;

945 
e
->
m™aged
 = 1;

946 
e
->
log
 = 
s
->
c⁄√˘i⁄
->log;

947 
e
->
evÆ
 = 
ngx_πmp_exec_push_evÆ
;

948 
e
->
evÆ_˘x
 = 
s
;

949 
e
->
kûl_sig«l
 = 
emcf
->kill_signal;

950 
e
->
ª•awn_timeout
 = (
ócf
->
ª•awn
 ? 
emcf
->respawn_timeout :

951 
NGX_CONF_UNSET_MSEC
);

955 
d⁄e
:

957 
	`ngx_mem˝y
(
˘x
->
«me
,Çame, 
NGX_RTMP_MAX_NAME
);

958 
	`ngx_mem˝y
(
˘x
->
¨gs
,árgs, 
NGX_RTMP_MAX_ARGS
);

960 
˘x
->
Êags
 |= flags;

962  
NGX_OK
;

963 
	}
}

966 
ngx_öt_t


967 
	$ngx_πmp_exec_öô_puŒ_˘x
(
ngx_πmp_£ssi⁄_t
 *
s
,

968 
u_ch¨
 
«me
[
NGX_RTMP_MAX_NAME
])

970 
size_t
 
Àn
;

971 
ngx_uöt_t
 
n
;

972 
ngx_poﬁ_t
 *
poﬁ
;

973 
ngx_¨øy_t
 *
puŒ_c⁄f
;

974 
ngx_πmp_exec_t
 *
e
;

975 
ngx_πmp_exec_˘x_t
 *
˘x
;

976 
ngx_πmp_exec_c⁄f_t
 *
ec
;

977 
ngx_πmp_exec_puŒ_˘x_t
 *
p˘x
, **
µ˘x
;

978 
ngx_πmp_exec_≠p_c⁄f_t
 *
ócf
;

979 
ngx_πmp_exec_maö_c⁄f_t
 *
emcf
;

981 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_exec_moduÀ
);

982 i‡(
˘x
->
puŒ
 !
NULL
) {

983  
NGX_OK
;

986 
ócf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_exec_moduÀ
);

988 
puŒ_c⁄f
 = &
ócf
->
c⁄f
[
NGX_RTMP_EXEC_PULL
];

990 i‡(
puŒ_c⁄f
->
√…s
 == 0) {

991  
NGX_OK
;

994 
emcf
 = 
	`ngx_πmp_gë_moduÀ_maö_c⁄f
(
s
, 
ngx_πmp_exec_moduÀ
);

996 
Àn
 = 
	`ngx_°æí
(
«me
);

998 
µ˘x
 = &
ócf
->
puŒ
[
	`ngx_hash_key
(
«me
, 
Àn
Ë%Éacf->
nbuckës
];

1000 ; *
µ˘x
;Öp˘x = &(*µ˘x)->
√xt
) {

1001 
p˘x
 = *
µ˘x
;

1003 i‡(
p˘x
->
«me
.
Àn
 ==Üen &&

1004 
	`ngx_°∫cmp
(
«me
, 
p˘x
->«me.
d©a
, 
Àn
) == 0)

1006 
d⁄e
;

1010 
poﬁ
 = 
	`ngx_¸óã_poﬁ
(4096, 
emcf
->
log
);

1011 i‡(
poﬁ
 =
NULL
) {

1012  
NGX_ERROR
;

1015 
p˘x
 = 
	`ngx_pˇŒoc
(
poﬁ
, (
ngx_πmp_exec_puŒ_˘x_t
));

1016 i‡(
p˘x
 =
NULL
) {

1017 
îr‹
;

1020 
p˘x
->
poﬁ
 =Öool;

1021 
p˘x
->
«me
.
Àn
 =Üen;

1022 
p˘x
->
«me
.
d©a
 = 
	`ngx_∑Œoc
(
poﬁ
, 
Àn
);

1024 i‡(
p˘x
->
«me
.
d©a
 =
NULL
) {

1025 
îr‹
;

1028 
	`ngx_mem˝y
(
p˘x
->
«me
.
d©a
,Çame, 
Àn
);

1030 
p˘x
->
≠p
.
Àn
 = 
s
->app.len;

1031 
p˘x
->
≠p
.
d©a
 = 
	`ngx_∑Œoc
(
poﬁ
, 
s
->≠p.
Àn
);

1033 i‡(
p˘x
->
≠p
.
d©a
 =
NULL
) {

1034 
îr‹
;

1037 
	`ngx_mem˝y
(
p˘x
->
≠p
.
d©a
, 
s
->≠p.d©a, s->≠p.
Àn
);

1039 i‡(
	`ngx_¨øy_öô
(&
p˘x
->
puŒ_exec
, 
poﬁ
, 
puŒ_c⁄f
->
√…s
,

1040 (
ngx_πmp_exec_t
)Ë!
NGX_OK
)

1042 
îr‹
;

1045 
e
 = 
	`ngx_¨øy_push_n
(&
p˘x
->
puŒ_exec
, 
puŒ_c⁄f
->
√…s
);

1046 i‡(
e
 =
NULL
) {

1047 
îr‹
;

1050 
ec
 = 
puŒ_c⁄f
->
ñts
;

1051 
n
 = 0;Ç < 
puŒ_c⁄f
->
√…s
;Ç++, 
e
++, 
ec
++) {

1052 
	`ngx_memzîo
(
e
, (*e));

1053 
e
->
c⁄f
 = 
ec
;

1054 
e
->
m™aged
 = 1;

1055 
e
->
log
 = 
emcf
->log;

1056 
e
->
evÆ
 = 
ngx_πmp_exec_puŒ_evÆ
;

1057 
e
->
evÆ_˘x
 = 
p˘x
;

1058 
e
->
kûl_sig«l
 = 
emcf
->kill_signal;

1059 
e
->
ª•awn_timeout
 = (
ócf
->
ª•awn
 ? 
emcf
->respawn_timeout :

1060 
NGX_CONF_UNSET_MSEC
);

1063 *
µ˘x
 = 
p˘x
;

1065 
d⁄e
:

1067 
˘x
->
puŒ
 = 
p˘x
;

1068 
˘x
->
puŒ
->
cou¡î
++;

1070  
NGX_OK
;

1072 
îr‹
:

1074 
	`ngx_de°roy_poﬁ
(
poﬁ
);

1076  
NGX_ERROR
;

1077 
	}
}

1080 
ngx_öt_t


1081 
	$ngx_πmp_exec_fûãr
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_exec_c⁄f_t
 *
ec
)

1083 
size_t
 
Àn
;

1084 
ngx_°r_t
 *
v
;

1085 
ngx_uöt_t
 
n
;

1086 
ngx_πmp_exec_˘x_t
 *
˘x
;

1088 i‡(
ec
->
«mes
.
√…s
 == 0) {

1089  
NGX_OK
;

1092 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_exec_moduÀ
);

1094 
Àn
 = 
	`ngx_°æí
(
˘x
->
«me
);

1096 
v
 = 
ec
->
«mes
.
ñts
;

1097 
n
 = 0;Ç < 
ec
->
«mes
.
√…s
;Ç++, 
s
++) {

1098 i‡(
v
->
Àn
 =À¿&& 
	`ngx_°∫cmp
(v->
d©a
, 
˘x
->
«me
,Üen) == 0) {

1099  
NGX_OK
;

1103  
NGX_DECLINED
;

1104 
	}
}

1108 
	$ngx_πmp_exec_unm™aged
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_¨øy_t
 *
e
, c⁄° *
›
)

1110 
ngx_uöt_t
 
n
;

1111 
ngx_πmp_exec_t
 
í
;

1112 
ngx_πmp_exec_c⁄f_t
 *
ec
;

1114 i‡(
e
->
√…s
 == 0) {

1118 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1119 "exec: %†%uz unm™aged comm™d(s)", 
›
, 
e
->
√…s
);

1121 
ec
 = 
e
->
ñts
;

1122 
n
 = 0;Ç < 
e
->
√…s
;Ç++, 
ec
++) {

1123 i‡(
	`ngx_πmp_exec_fûãr
(
s
, 
ec
Ë!
NGX_OK
) {

1127 
	`ngx_memzîo
(&
í
, (
ngx_πmp_exec_t
));

1129 
í
.
c⁄f
 = 
ec
;

1130 
í
.
evÆ
 = 
ngx_πmp_exec_evít_evÆ
;

1131 
í
.
evÆ_˘x
 = 
s
;

1132 
í
.
log
 = 
s
->
c⁄√˘i⁄
->log;

1134 
	`ngx_πmp_exec_run
(&
í
);

1136 
	}
}

1140 
	$ngx_πmp_exec_m™aged
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_¨øy_t
 *
e
, c⁄° *
›
)

1142 
ngx_uöt_t
 
n
;

1143 
ngx_πmp_exec_t
 *
í
;

1145 i‡(
e
->
√…s
 == 0) {

1149 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1150 "exec: %†%uz m™aged comm™d(s)", 
›
, 
e
->
√…s
);

1152 
í
 = 
e
->
ñts
;

1153 
n
 = 0;Ç < 
e
->
√…s
;Ç++, 
í
++) {

1154 i‡(
	`ngx_πmp_exec_fûãr
(
s
, 
í
->
c⁄f
Ë=
NGX_OK
) {

1155 
	`ngx_πmp_exec_run
(
í
);

1158 
	}
}

1161 
ngx_öt_t


1162 
	$ngx_πmp_exec_publish
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_publish_t
 *
v
)

1164 
ngx_πmp_exec_˘x_t
 *
˘x
;

1165 
ngx_πmp_exec_≠p_c⁄f_t
 *
ócf
;

1167 
ócf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_exec_moduÀ
);

1169 i‡(
ócf
 =
NULL
 || !ócf->
a˘ive
) {

1170 
√xt
;

1173 i‡(
s
->
auto_pushed
) {

1174 
√xt
;

1177 i‡(
	`ngx_πmp_exec_öô_˘x
(
s
, 
v
->
«me
, v->
¨gs
, 
NGX_RTMP_EXEC_PUBLISHING
)

1178 !
NGX_OK
)

1180 
√xt
;

1183 
	`ngx_πmp_exec_unm™aged
(
s
, &
ócf
->
c⁄f
[
NGX_RTMP_EXEC_PUBLISH
], "publish");

1185 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_exec_moduÀ
);

1187 
	`ngx_πmp_exec_m™aged
(
s
, &
˘x
->
push_exec
, "push");

1189 
√xt
:

1190  
	`√xt_publish
(
s
, 
v
);

1191 
	}
}

1194 
ngx_öt_t


1195 
	$ngx_πmp_exec_∂ay
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_∂ay_t
 *
v
)

1197 
ngx_πmp_exec_˘x_t
 *
˘x
;

1198 
ngx_πmp_exec_puŒ_˘x_t
 *
p˘x
;

1199 
ngx_πmp_exec_≠p_c⁄f_t
 *
ócf
;

1201 
ócf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_exec_moduÀ
);

1203 i‡(
ócf
 =
NULL
 || !ócf->
a˘ive
) {

1204 
√xt
;

1207 i‡(
	`ngx_πmp_exec_öô_˘x
(
s
, 
v
->
«me
, v->
¨gs
, 
NGX_RTMP_EXEC_PLAYING
)

1208 !
NGX_OK
)

1210 
√xt
;

1213 
	`ngx_πmp_exec_unm™aged
(
s
, &
ócf
->
c⁄f
[
NGX_RTMP_EXEC_PLAY
], "play");

1215 i‡(
	`ngx_πmp_exec_öô_puŒ_˘x
(
s
, 
v
->
«me
Ë!
NGX_OK
) {

1216 
√xt
;

1219 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_exec_moduÀ
);

1220 
p˘x
 = 
˘x
->
puŒ
;

1222 i‡(
p˘x
 &&Ö˘x->
cou¡î
 == 1) {

1223 
	`ngx_πmp_exec_m™aged
(
s
, &
p˘x
->
puŒ_exec
, "pull");

1226 
√xt
:

1227  
	`√xt_∂ay
(
s
, 
v
);

1228 
	}
}

1231 
ngx_öt_t


1232 
	$ngx_πmp_exec_˛o£_°ªam
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_˛o£_°ªam_t
 *
v
)

1234 
size_t
 
n
;

1235 
ngx_πmp_exec_t
 *
e
;

1236 
ngx_πmp_exec_˘x_t
 *
˘x
;

1237 
ngx_πmp_exec_puŒ_˘x_t
 *
p˘x
, **
µ˘x
;

1238 
ngx_πmp_exec_≠p_c⁄f_t
 *
ócf
;

1240 
ócf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_exec_moduÀ
);

1241 i‡(
ócf
 =
NULL
) {

1242 
√xt
;

1245 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_exec_moduÀ
);

1246 i‡(
˘x
 =
NULL
) {

1247 
√xt
;

1250 i‡(
˘x
->
Êags
 & 
NGX_RTMP_EXEC_PUBLISHING
) {

1251 
	`ngx_πmp_exec_unm™aged
(
s
, &
ócf
->
c⁄f
[
NGX_RTMP_EXEC_PUBLISH_DONE
],

1255 i‡(
˘x
->
Êags
 & 
NGX_RTMP_EXEC_PLAYING
) {

1256 
	`ngx_πmp_exec_unm™aged
(
s
, &
ócf
->
c⁄f
[
NGX_RTMP_EXEC_PLAY_DONE
],

1260 
˘x
->
Êags
 = 0;

1262 i‡(
˘x
->
push_exec
.
√…s
 > 0) {

1263 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1265 
˘x
->
push_exec
.
√…s
);

1267 
e
 = 
˘x
->
push_exec
.
ñts
;

1268 
n
 = 0;Ç < 
˘x
->
push_exec
.
√…s
;Ç++, 
e
++) {

1269 
	`ngx_πmp_exec_kûl
(
e
,É->
kûl_sig«l
);

1273 
p˘x
 = 
˘x
->
puŒ
;

1275 i‡(
p˘x
 && --p˘x->
cou¡î
 == 0) {

1276 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1278 
p˘x
->
puŒ_exec
.
√…s
);

1280 
e
 = 
p˘x
->
puŒ_exec
.
ñts
;

1281 
n
 = 0;Ç < 
p˘x
->
puŒ_exec
.
√…s
;Ç++, 
e
++) {

1282 
	`ngx_πmp_exec_kûl
(
e
,É->
kûl_sig«l
);

1285 
µ˘x
 = &
ócf
->
puŒ
[
	`ngx_hash_key
(
p˘x
->
«me
.
d©a
,Ö˘x->«me.
Àn
) %

1286 
ócf
->
nbuckës
];

1288 ; *
µ˘x
;Öp˘x = &(*µ˘x)->
√xt
) {

1289 i‡(
p˘x
 =*
µ˘x
) {

1290 *
µ˘x
 = 
p˘x
->
√xt
;

1295 
	`ngx_de°roy_poﬁ
(
p˘x
->
poﬁ
);

1298 
˘x
->
puŒ
 = 
NULL
;

1300 
√xt
:

1301  
	`√xt_˛o£_°ªam
(
s
, 
v
);

1302 
	}
}

1305 
ngx_öt_t


1306 
	$ngx_πmp_exec_ªc‹d_d⁄e
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_ªc‹d_d⁄e_t
 *
v
)

1308 
u_ch¨
 
c
;

1309 
ngx_uöt_t
 
ext
, 
dú
;

1310 
ngx_πmp_exec_˘x_t
 *
˘x
;

1311 
ngx_πmp_exec_≠p_c⁄f_t
 *
ócf
;

1313 i‡(
s
->
auto_pushed
) {

1314 
√xt
;

1317 
ócf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_exec_moduÀ
);

1318 i‡(
ócf
 =
NULL
 || !ócf->
a˘ive
) {

1319 
√xt
;

1322 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_exec_moduÀ
);

1323 i‡(
˘x
 =
NULL
) {

1324 
√xt
;

1327 
˘x
->
ªc‹dî
 = 
v
->recorder;

1328 
˘x
->
∑th
 = 
v
->path;

1330 
˘x
->
dú«me
.
d©a
 = ctx->
∑th
.data;

1331 
˘x
->
dú«me
.
Àn
 = 0;

1333 
dú
 = 
˘x
->
∑th
.
Àn
; dir > 0; dir--) {

1334 
c
 = 
˘x
->
∑th
.
d©a
[
dú
 - 1];

1335 i‡(
c
 == '/' || c == '\\') {

1336 
˘x
->
dú«me
.
Àn
 = 
dú
 - 1;

1341 
˘x
->
fûíame
.
d©a
 = ctx->
∑th
.d©®+ 
dú
;

1342 
˘x
->
fûíame
.
Àn
 = ctx->
∑th
.À¿- 
dú
;

1344 
˘x
->
ba£«me
 = ctx->
fûíame
;

1346 
ext
 = 
˘x
->
fûíame
.
Àn
;Éxt > 0;Éxt--) {

1347 i‡(
˘x
->
fûíame
.
d©a
[
ext
 - 1] == '.') {

1348 
˘x
->
ba£«me
.
Àn
 = 
ext
 - 1;

1353 
	`ngx_πmp_exec_unm™aged
(
s
, &
ócf
->
c⁄f
[
NGX_RTMP_EXEC_RECORD_DONE
],

1356 
	`ngx_°r_nuŒ
(&
v
->
ªc‹dî
);

1357 
	`ngx_°r_nuŒ
(&
v
->
∑th
);

1359 
√xt
:

1360  
	`√xt_ªc‹d_d⁄e
(
s
, 
v
);

1361 
	}
}

1366 
	$ngx_πmp_exec_c⁄f
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1368 *
p
 = 
c⁄f
;

1370 
size_t
 
n
, 
«rgs
;

1371 
ngx_°r_t
 *
s
, *
vÆue
, 
v
;

1372 
ngx_¨øy_t
 *
c⁄fs
;

1373 
ngx_πmp_exec_c⁄f_t
 *
ec
;

1374 
ngx_πmp_exec_≠p_c⁄f_t
 *
ócf
;

1376 
c⁄fs
 = (
ngx_¨øy_t
 *Ë(
p
 + 
cmd
->
off£t
);

1378 
ócf
 = 
	`ngx_πmp_c⁄f_gë_moduÀ_≠p_c⁄f
(
cf
, 
ngx_πmp_exec_moduÀ
);

1380 i‡(
c⁄fs
->
«Œoc
 =0 && 
	`ngx_¨øy_öô
(c⁄fs, 
cf
->
poﬁ
, 1,

1381 (
ngx_πmp_exec_c⁄f_t
))

1382 !
NGX_OK
)

1384  
NGX_CONF_ERROR
;

1387 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1389 
ec
 = 
	`ngx_¨øy_push
(
c⁄fs
);

1390 i‡(
ec
 =
NULL
) {

1391  
NGX_CONF_ERROR
;

1394 
	`ngx_memzîo
(
ec
, (
ngx_πmp_exec_c⁄f_t
));

1398 
ec
->
ty≥
 = 
NGX_CONF_UNSET_UINT
;

1399 
ec
->
cmd
 = 
vÆue
[1];

1401 i‡(
	`ngx_¨øy_öô
(&
ec
->
«mes
, 
cf
->
poﬁ
, 1, (
ngx_°r_t
)Ë!
NGX_OK
) {

1402  
NGX_CONF_ERROR
;

1405 i‡(
cf
->
¨gs
->
√…s
 == 2) {

1406  
NGX_CONF_OK
;

1409 
«rgs
 = 
cf
->
¨gs
->
√…s
 - 2;

1410 i‡(
	`ngx_¨øy_öô
(&
ec
->
¨gs
, 
cf
->
poﬁ
, 
«rgs
, (
ngx_°r_t
)Ë!
NGX_OK
)

1412  
NGX_CONF_ERROR
;

1415 
n
 = 2;Ç < 
cf
->
¨gs
->
√…s
;Ç++) {

1417 
v
 = 
vÆue
[
n
];

1419 i‡(
ócf
->
›ti⁄s
 == 1) {

1421 i‡(
v
.
Àn
 >5 && 
	`ngx_°∫cmp
(v.
d©a
, "name=", 5) == 0) {

1423 
s
 = 
	`ngx_¨øy_push
(&
ec
->
«mes
);

1424 i‡(
s
 =
NULL
) {

1425  
NGX_CONF_ERROR
;

1428 
v
.
d©a
 += 5;

1429 
v
.
Àn
 -= 5;

1431 *
s
 = 
v
;

1437 
s
 = 
	`ngx_¨øy_push
(&
ec
->
¨gs
);

1438 i‡(
s
 =
NULL
) {

1439  
NGX_CONF_ERROR
;

1442 *
s
 = 
v
;

1445  
NGX_CONF_OK
;

1446 
	}
}

1532 
	$ngx_πmp_exec_kûl_sig«l
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1534 
ngx_πmp_exec_maö_c⁄f_t
 *
emcf
 = 
c⁄f
;

1536 
ngx_°r_t
 *
vÆue
;

1538 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1539 
vÆue
++;

1541 
emcf
->
kûl_sig«l
 = 
	`ngx_©oi
(
vÆue
->
d©a
, vÆue->
Àn
);

1542 i‡(
emcf
->
kûl_sig«l
 !
NGX_ERROR
) {

1543  
NGX_CONF_OK
;

1546 
	#NGX_RMTP_EXEC_SIGNAL
(
«me
) \

1547 i‡(
vÆue
->
Àn
 == (#name) - 1 && \

1548 
	`ngx_°∫ˇ£cmp
(
vÆue
->
d©a
, (
u_ch¨
 *Ë#«me, vÆue->
Àn
) == 0) \

1550 
emcf
->
kûl_sig«l
 = 
SIG
##
«me
; \

1551  
NGX_CONF_OK
; \

1552 }

	)

1556 #i‡!(
NGX_WIN32
)

1557 
	`NGX_RMTP_EXEC_SIGNAL
(
HUP
);

1558 
	`NGX_RMTP_EXEC_SIGNAL
(
INT
);

1559 
	`NGX_RMTP_EXEC_SIGNAL
(
QUIT
);

1560 
	`NGX_RMTP_EXEC_SIGNAL
(
ILL
);

1561 
	`NGX_RMTP_EXEC_SIGNAL
(
ABRT
);

1562 
	`NGX_RMTP_EXEC_SIGNAL
(
FPE
);

1563 
	`NGX_RMTP_EXEC_SIGNAL
(
KILL
);

1564 
	`NGX_RMTP_EXEC_SIGNAL
(
SEGV
);

1565 
	`NGX_RMTP_EXEC_SIGNAL
(
PIPE
);

1566 
	`NGX_RMTP_EXEC_SIGNAL
(
ALRM
);

1567 
	`NGX_RMTP_EXEC_SIGNAL
(
TERM
);

1568 
	`NGX_RMTP_EXEC_SIGNAL
(
USR1
);

1569 
	`NGX_RMTP_EXEC_SIGNAL
(
USR2
);

1570 
	`NGX_RMTP_EXEC_SIGNAL
(
CHLD
);

1571 
	`NGX_RMTP_EXEC_SIGNAL
(
CONT
);

1572 
	`NGX_RMTP_EXEC_SIGNAL
(
STOP
);

1573 
	`NGX_RMTP_EXEC_SIGNAL
(
TSTP
);

1574 
	`NGX_RMTP_EXEC_SIGNAL
(
TTIN
);

1575 
	`NGX_RMTP_EXEC_SIGNAL
(
TTOU
);

1578 #unde‡
NGX_RMTP_EXEC_SIGNAL


1581 
	}
}

1584 
ngx_öt_t


1585 
	$ngx_πmp_exec_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
)

1587 #i‡!(
NGX_WIN32
)

1589 
√xt_publish
 = 
ngx_πmp_publish
;

1590 
ngx_πmp_publish
 = 
ngx_πmp_exec_publish
;

1592 
√xt_∂ay
 = 
ngx_πmp_∂ay
;

1593 
ngx_πmp_∂ay
 = 
ngx_πmp_exec_∂ay
;

1595 
√xt_˛o£_°ªam
 = 
ngx_πmp_˛o£_°ªam
;

1596 
ngx_πmp_˛o£_°ªam
 = 
ngx_πmp_exec_˛o£_°ªam
;

1598 
√xt_ªc‹d_d⁄e
 = 
ngx_πmp_ªc‹d_d⁄e
;

1599 
ngx_πmp_ªc‹d_d⁄e
 = 
ngx_πmp_exec_ªc‹d_d⁄e
;

1603  
NGX_OK
;

1604 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_flv_module.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp_∂ay_moduÀ.h
"

10 
	~"ngx_πmp_codec_moduÀ.h
"

11 
	~"ngx_πmp_°ªams.h
"

14 
ngx_öt_t
 
ngx_πmp_Êv_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
);

15 
ngx_πmp_Êv_ªad_mëa
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
);

16 
ngx_öt_t
 
ngx_πmp_Êv_time°amp_to_off£t
(
ngx_πmp_£ssi⁄_t
 *
s
,

17 
ngx_fûe_t
 *
f
, 
ngx_öt_t
 
time°amp
);

18 
ngx_öt_t
 
ngx_πmp_Êv_öô
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
,

19 
ngx_öt_t
 
aödex
,Çgx_öt_à
vödex
);

20 
ngx_öt_t
 
ngx_πmp_Êv_°¨t
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
);

21 
ngx_öt_t
 
ngx_πmp_Êv_£ek
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
,

22 
ngx_uöt_t
 
off£t
);

23 
ngx_öt_t
 
ngx_πmp_Êv_°›
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
);

24 
ngx_öt_t
 
ngx_πmp_Êv_£nd
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
,

25 
ngx_uöt_t
 *
ts
);

29 
ngx_uöt_t
 
	m√…s
;

30 
ngx_uöt_t
 
	moff£t
;

31 } 
	tngx_πmp_Êv_ödex_t
;

35 
ngx_öt_t
 
	moff£t
;

36 
ngx_öt_t
 
	m°¨t_time°amp
;

37 
ngx_evít_t
 
	mwrôe_evt
;

38 
uöt32_t
 
	mœ°_audio
;

39 
uöt32_t
 
	mœ°_video
;

40 
ngx_uöt_t
 
	mmsg_mask
;

41 
uöt32_t
 
	mïoch
;

43 
	mmëa_ªad
:1;

44 
ngx_πmp_Êv_ödex_t
 
	mfûïosôi⁄s
;

45 
ngx_πmp_Êv_ödex_t
 
	mtimes
;

46 } 
	tngx_πmp_Êv_˘x_t
;

49 
	#NGX_RTMP_FLV_BUFFER
 (1024*1024)

	)

50 
	#NGX_RTMP_FLV_BUFLEN_ADDON
 1000

	)

51 
	#NGX_RTMP_FLV_TAG_HEADER
 11

	)

52 
	#NGX_RTMP_FLV_DATA_OFFSET
 13

	)

55 
u_ch¨
 
	gngx_πmp_Êv_buf„r
[

56 
NGX_RTMP_FLV_BUFFER
];

57 
u_ch¨
 
	gngx_πmp_Êv_hódî
[

58 
NGX_RTMP_FLV_TAG_HEADER
];

61 
ngx_πmp_moduÀ_t
 
	gngx_πmp_Êv_moduÀ_˘x
 = {

62 
NULL
,

63 
ngx_πmp_Êv_po°c⁄figuøti⁄
,

64 
NULL
,

65 
NULL
,

66 
NULL
,

67 
NULL
,

68 
NULL
,

69 
NULL


73 
ngx_moduÀ_t
 
	gngx_πmp_Êv_moduÀ
 = {

74 
NGX_MODULE_V1
,

75 &
ngx_πmp_Êv_moduÀ_˘x
,

76 
NULL
,

77 
NGX_RTMP_MODULE
,

78 
NULL
,

79 
NULL
,

80 
NULL
,

81 
NULL
,

82 
NULL
,

83 
NULL
,

84 
NULL
,

85 
NGX_MODULE_V1_PADDING


89 
ngx_öt_t


90 
	$ngx_πmp_Êv_fûl_ödex
(
ngx_πmp_amf_˘x_t
 *
˘x
, 
ngx_πmp_Êv_ödex_t
 *
idx
)

92 
uöt32_t
 
√…s
;

93 
ngx_buf_t
 *
b
;

99 
b
 = 
˘x
->
lök
->
buf
;

101 i‡(
b
->
œ°
 - b->
pos
 < (
ngx_öt_t
Ë
˘x
->
off£t
 + 4) {

102  
NGX_ERROR
;

105 
	`ngx_πmp_rmem˝y
(&
√…s
, 
b
->
pos
 + 
˘x
->
off£t
, 4);

107 
idx
->
√…s
 =Çelts;

108 
idx
->
off£t
 = 
˘x
->offset + 4;

110  
NGX_OK
;

111 
	}
}

114 
ngx_öt_t


115 
	$ngx_πmp_Êv_öô_ödex
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_chaö_t
 *
ö
)

117 
ngx_πmp_Êv_˘x_t
 *
˘x
;

119 
ngx_πmp_amf_˘x_t
 
fûïosôi⁄s_˘x
;

120 
ngx_πmp_amf_˘x_t
 
times_˘x
;

122 
ngx_πmp_amf_ñt_t
 
ö_key‰ames
[] = {

124 { 
NGX_RTMP_AMF_ARRAY
 | 
NGX_RTMP_AMF_CONTEXT
,

125 
	`ngx_°rög
("filepositions"),

126 &
fûïosôi⁄s_˘x
, 0 },

128 { 
NGX_RTMP_AMF_ARRAY
 | 
NGX_RTMP_AMF_CONTEXT
,

129 
	`ngx_°rög
("times"),

130 &
times_˘x
, 0 }

133 
ngx_πmp_amf_ñt_t
 
ö_öf
[] = {

135 { 
NGX_RTMP_AMF_OBJECT
,

136 
	`ngx_°rög
("keyframes"),

137 
ö_key‰ames
, (in_keyframes) }

140 
ngx_πmp_amf_ñt_t
 
ö_ñts
[] = {

142 { 
NGX_RTMP_AMF_STRING
,

143 
ngx_nuŒ_°rög
,

144 
NULL
, 0 },

146 { 
NGX_RTMP_AMF_OBJECT
,

147 
ngx_nuŒ_°rög
,

148 
ö_öf
, (in_inf) },

151 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_Êv_moduÀ
);

153 i‡(
˘x
 =
NULL
 || 
ö
 == NULL) {

154  
NGX_OK
;

157 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

160 
	`ngx_memzîo
(&
fûïosôi⁄s_˘x
, (filepositions_ctx));

161 
	`ngx_memzîo
(&
times_˘x
, (times_ctx));

163 i‡(
	`ngx_πmp_ª˚ive_amf
(
s
, 
ö
, 
ö_ñts
,

164 (
ö_ñts
) / (in_elts[0])))

166 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

168  
NGX_OK
;

171 i‡(
fûïosôi⁄s_˘x
.
lök
 && 
	`ngx_πmp_Êv_fûl_ödex
(&filepositions_ctx,

172 &
˘x
->
fûïosôi⁄s
)

173 !
NGX_OK
)

175 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

177  
NGX_ERROR
;

180 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

182 
˘x
->
fûïosôi⁄s
.
√…s
, ctx->fûïosôi⁄s.
off£t
);

184 i‡(
times_˘x
.
lök
 && 
	`ngx_πmp_Êv_fûl_ödex
(&times_ctx,

185 &
˘x
->
times
)

186 !
NGX_OK
)

188 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

190  
NGX_ERROR
;

193 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

195 
˘x
->
times
.
√…s
, ctx->times.
off£t
);

197  
NGX_OK
;

198 
	}
}

202 
	$ngx_πmp_Êv_ödex_vÆue
(*
§c
)

204 
v
;

206 
	`ngx_πmp_rmem˝y
(&
v
, 
§c
, 8);

208  
v
;

209 
	}
}

212 
ngx_öt_t


213 
	$ngx_πmp_Êv_time°amp_to_off£t
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
,

214 
ngx_öt_t
 
time°amp
)

216 
ngx_πmp_Êv_˘x_t
 *
˘x
;

217 
ssize_t
 
n
, 
size
;

218 
ngx_uöt_t
 
off£t
, 
ödex
, 
ªt
, 
√…s
;

219 
v
;

221 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_Êv_moduÀ
);

223 i‡(
˘x
 =
NULL
) {

224 
ªwöd
;

227 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

229 
time°amp
);

231 i‡(
˘x
->
mëa_ªad
 == 0) {

232 
	`ngx_πmp_Êv_ªad_mëa
(
s
, 
f
);

233 
˘x
->
mëa_ªad
 = 1;

236 i‡(
time°amp
 <0 || 
˘x
->
fûïosôi⁄s
.
√…s
 == 0

237 || 
˘x
->
times
.
√…s
 == 0)

239 
ªwöd
;

243 
off£t
 = 
NGX_RTMP_FLV_DATA_OFFSET
 + 
NGX_RTMP_FLV_TAG_HEADER
 +

244 
˘x
->
times
.
off£t
;

247 
√…s
 = 
	`ngx_mö
(
˘x
->
times
.√…s, (
ngx_πmp_Êv_buf„r
) / 9);

248 
size
 = 
√…s
 * 9;

250 
n
 = 
	`ngx_ªad_fûe
(
f
, 
ngx_πmp_Êv_buf„r
, 
size
, 
off£t
);

252 i‡(
n
 !
size
) {

253 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

255 
ªwöd
;

259 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

260 "Êv:Üooku∞time†√…s=%ui", 
√…s
);

262 
ödex
 = 0; index < 
√…s
 - 1; ++index) {

263 
v
 = 
	`ngx_πmp_Êv_ödex_vÆue
(
ngx_πmp_Êv_buf„r
 +

264 
ödex
 * 9 + 1) * 1000;

266 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

268 
ödex
, (
ngx_uöt_t
Ë
v
);

270 i‡(
time°amp
 < 
v
) {

275 i‡(
ödex
 >
˘x
->
fûïosôi⁄s
.
√…s
) {

276 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

278 
ödex
, 
˘x
->
fûïosôi⁄s
.
√…s
);

279 
ªwöd
;

283 
off£t
 = 
NGX_RTMP_FLV_DATA_OFFSET
 + 
NGX_RTMP_FLV_TAG_HEADER
 +

284 
˘x
->
fûïosôi⁄s
.
off£t
 + 
ödex
 * 9;

286 
n
 = 
	`ngx_ªad_fûe
(
f
, 
ngx_πmp_Êv_buf„r
, 8, 
off£t
 + 1);

288 i‡(
n
 != 8) {

289 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

291 
ªwöd
;

294 
ªt
 = (
ngx_uöt_t
Ë
	`ngx_πmp_Êv_ödex_vÆue
(
ngx_πmp_Êv_buf„r
);

296 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

298 
time°amp
, 
ªt
);

300  
ªt
;

302 
ªwöd
:

303 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

305 
time°amp
);

307  
NGX_RTMP_FLV_DATA_OFFSET
;

308 
	}
}

312 
	$ngx_πmp_Êv_ªad_mëa
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
)

314 
ngx_πmp_Êv_˘x_t
 *
˘x
;

315 
ssize_t
 
n
;

316 
ngx_πmp_hódî_t
 
h
;

317 
ngx_chaö_t
 *
out
, 
ö
;

318 
ngx_buf_t
 
ö_buf
;

319 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

320 
uöt32_t
 
size
;

322 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

324 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_Êv_moduÀ
);

326 i‡(
˘x
 =
NULL
) {

330 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

334 
n
 = 
	`ngx_ªad_fûe
(
f
, 
ngx_πmp_Êv_hódî
, (ngx_rtmp_flv_header),

335 
NGX_RTMP_FLV_DATA_OFFSET
);

337 i‡(
n
 !(
ngx_πmp_Êv_hódî
)) {

338 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

343 i‡(
ngx_πmp_Êv_hódî
[0] !
NGX_RTMP_MSG_AMF_META
) {

344 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

349 
	`ngx_memzîo
(&
h
, (h));

351 
h
.
ty≥
 = 
NGX_RTMP_MSG_AMF_META
;

352 
h
.
msid
 = 
NGX_RTMP_MSID
;

353 
h
.
csid
 = 
NGX_RTMP_CSID_AMF
;

355 
size
 = 0;

356 
	`ngx_πmp_rmem˝y
(&
size
, 
ngx_πmp_Êv_hódî
 + 1, 3);

358 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

359 "Êv: mëad©®size=%D", 
size
);

361 i‡(
size
 > (
ngx_πmp_Êv_buf„r
)) {

362 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

368 
n
 = 
	`ngx_ªad_fûe
(
f
, 
ngx_πmp_Êv_buf„r
, 
size
,

369 (
ngx_πmp_Êv_hódî
) +

370 
NGX_RTMP_FLV_DATA_OFFSET
);

372 i‡(
n
 !(
ssize_t
Ë
size
) {

373 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

379 
	`ngx_memzîo
(&
ö
, (in));

380 
	`ngx_memzîo
(&
ö_buf
, (in_buf));

382 
ö
.
buf
 = &
ö_buf
;

383 
ö_buf
.
pos
 = 
ngx_πmp_Êv_buf„r
;

384 
ö_buf
.
œ°
 = 
ngx_πmp_Êv_buf„r
 + 
size
;

386 
	`ngx_πmp_Êv_öô_ödex
(
s
, &
ö
);

389 
out
 = 
	`ngx_πmp_≠≥nd_sh¨ed_bufs
(
cscf
, 
NULL
, &
ö
);

391 
	`ngx_πmp_¥ï¨e_mesßge
(
s
, &
h
, 
NULL
, 
out
);

392 
	`ngx_πmp_£nd_mesßge
(
s
, 
out
, 0);

393 
	`ngx_πmp_‰ì_sh¨ed_chaö
(
cscf
, 
out
);

394 
	}
}

397 
ngx_öt_t


398 
	$ngx_πmp_Êv_£nd
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
, 
ngx_uöt_t
 *
ts
)

400 
ngx_πmp_Êv_˘x_t
 *
˘x
;

401 
uöt32_t
 
œ°_time°amp
;

402 
ngx_πmp_hódî_t
 
h
, 
lh
;

403 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

404 
ngx_chaö_t
 *
out
, 
ö
;

405 
ngx_buf_t
 
ö_buf
;

406 
ngx_öt_t
 
rc
;

407 
ssize_t
 
n
;

408 
uöt32_t
 
buÊí
, 
íd_time°amp
, 
size
;

410 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

412 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_Êv_moduÀ
);

414 i‡(
˘x
 =
NULL
) {

415  
NGX_ERROR
;

418 i‡(
˘x
->
off£t
 == -1) {

419 
˘x
->
off£t
 = 
	`ngx_πmp_Êv_time°amp_to_off£t
(
s
, 
f
,

420 
˘x
->
°¨t_time°amp
);

421 
˘x
->
°¨t_time°amp
 = -1;

424 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

425 "Êv:ÑódÅagáàoff£t=%i", 
˘x
->
off£t
);

428 
n
 = 
	`ngx_ªad_fûe
(
f
, 
ngx_πmp_Êv_hódî
,

429 (
ngx_πmp_Êv_hódî
), 
˘x
->
off£t
);

431 i‡(
n
 !(
ngx_πmp_Êv_hódî
)) {

432 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

434  
NGX_DONE
;

438 
	`ngx_memzîo
(&
h
, (h));

440 
h
.
msid
 = 
NGX_RTMP_MSID
;

441 
h
.
ty≥
 = 
ngx_πmp_Êv_hódî
[0];

443 
size
 = 0;

445 
	`ngx_πmp_rmem˝y
(&
size
, 
ngx_πmp_Êv_hódî
 + 1, 3);

446 
	`ngx_πmp_rmem˝y
(&
h
.
time°amp
, 
ngx_πmp_Êv_hódî
 + 4, 3);

448 ((
u_ch¨
 *Ë&
h
.
time°amp
)[3] = 
ngx_πmp_Êv_hódî
[7];

450 
˘x
->
off£t
 +((
ngx_πmp_Êv_hódî
Ë+ 
size
 + 4);

452 
œ°_time°amp
 = 0;

454 
h
.
ty≥
) {

456 
NGX_RTMP_MSG_AUDIO
:

457 
h
.
csid
 = 
NGX_RTMP_CSID_AUDIO
;

458 
œ°_time°amp
 = 
˘x
->
œ°_audio
;

459 
˘x
->
œ°_audio
 = 
h
.
time°amp
;

462 
NGX_RTMP_MSG_VIDEO
:

463 
h
.
csid
 = 
NGX_RTMP_CSID_VIDEO
;

464 
œ°_time°amp
 = 
˘x
->
œ°_video
;

465 
˘x
->
œ°_video
 = 
h
.
time°amp
;

469  
NGX_OK
;

472 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

475 (
ngx_öt_t
Ë
h
.
ty≥
,
size
, h.
time°amp
, 
œ°_time°amp
);

477 
lh
 = 
h
;

478 
lh
.
time°amp
 = 
œ°_time°amp
;

480 i‡(
size
 > (
ngx_πmp_Êv_buf„r
)) {

481 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

482 "Êv:Åoÿbig mesßge: %D>%uz", 
size
,

483 (
ngx_πmp_Êv_buf„r
));

484 
√xt
;

488 
n
 = 
	`ngx_ªad_fûe
(
f
, 
ngx_πmp_Êv_buf„r
, 
size
,

489 
˘x
->
off£t
 - 
size
 - 4);

491 i‡(
n
 !(
ssize_t
Ë
size
) {

492 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

494  
NGX_ERROR
;

498 
	`ngx_memzîo
(&
ö
, (in));

499 
	`ngx_memzîo
(&
ö_buf
, (in_buf));

501 
ö
.
buf
 = &
ö_buf
;

502 
ö_buf
.
pos
 = 
ngx_πmp_Êv_buf„r
;

503 
ö_buf
.
œ°
 = 
ngx_πmp_Êv_buf„r
 + 
size
;

506 
out
 = 
	`ngx_πmp_≠≥nd_sh¨ed_bufs
(
cscf
, 
NULL
, &
ö
);

508 
	`ngx_πmp_¥ï¨e_mesßge
(
s
, &
h
, 
˘x
->
msg_mask
 & (1 << h.
ty≥
) ?

509 &
lh
 : 
NULL
, 
out
);

510 
rc
 = 
	`ngx_πmp_£nd_mesßge
(
s
, 
out
, 0);

511 
	`ngx_πmp_‰ì_sh¨ed_chaö
(
cscf
, 
out
);

513 i‡(
rc
 =
NGX_AGAIN
) {

514  
NGX_AGAIN
;

517 i‡(
rc
 !
NGX_OK
) {

518  
NGX_ERROR
;

521 
˘x
->
msg_mask
 |(1 << 
h
.
ty≥
);

523 
√xt
:

524 i‡(
˘x
->
°¨t_time°amp
 == -1) {

525 
˘x
->
°¨t_time°amp
 = 
h
.
time°amp
;

526 
˘x
->
ïoch
 = 
ngx_cuºít_m£c
;

528 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

529 "Êv: sèπ_time°amp=%i", 
˘x
->
°¨t_time°amp
);

530  
NGX_OK
;

533 
buÊí
 = 
s
->buÊí + 
NGX_RTMP_FLV_BUFLEN_ADDON
;

535 
íd_time°amp
 = (
ngx_cuºít_m£c
 - 
˘x
->
ïoch
) +

536 
˘x
->
°¨t_time°amp
 + 
buÊí
;

538 
	`ngx_log_debug5
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

540 
h
.
time°amp
 > 
íd_time°amp
 ? "schedule" : "advance",

541 
h
.
time°amp
 > 
íd_time°amp
 ? h.timestamp -Énd_timestamp : 0,

542 
h
.
time°amp
, 
íd_time°amp
, (
ngx_öt_t
Ë
buÊí
);

544 
s
->
cuºít_time
 = 
h
.
time°amp
;

547 i‡(
h
.
time°amp
 > 
íd_time°amp
) {

548  
h
.
time°amp
 - 
íd_time°amp
;

551  
NGX_OK
;

552 
	}
}

555 
ngx_öt_t


556 
	$ngx_πmp_Êv_öô
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
, 
ngx_öt_t
 
aödex
,

557 
ngx_öt_t
 
vödex
)

559 
ngx_πmp_Êv_˘x_t
 *
˘x
;

561 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_Êv_moduÀ
);

563 i‡(
˘x
 =
NULL
) {

564 
˘x
 = 
	`ngx_∑Œoc
(
s
->
c⁄√˘i⁄
->
poﬁ
, (
ngx_πmp_Êv_˘x_t
));

566 i‡(
˘x
 =
NULL
) {

567  
NGX_ERROR
;

570 
	`ngx_πmp_£t_˘x
(
s
, 
˘x
, 
ngx_πmp_Êv_moduÀ
);

573 
	`ngx_memzîo
(
˘x
, (*ctx));

575  
NGX_OK
;

576 
	}
}

579 
ngx_öt_t


580 
	$ngx_πmp_Êv_°¨t
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
)

582 
ngx_πmp_Êv_˘x_t
 *
˘x
;

584 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_Êv_moduÀ
);

586 i‡(
˘x
 =
NULL
) {

587  
NGX_OK
;

590 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

593 
˘x
->
off£t
 = -1;

594 
˘x
->
msg_mask
 = 0;

596  
NGX_OK
;

597 
	}
}

600 
ngx_öt_t


601 
	$ngx_πmp_Êv_£ek
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
, 
ngx_uöt_t
 
time°amp
)

603 
ngx_πmp_Êv_˘x_t
 *
˘x
;

605 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_Êv_moduÀ
);

607 i‡(
˘x
 =
NULL
) {

608  
NGX_OK
;

611 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

612 "Êv: sìkÅime°amp=%ui", 
time°amp
);

614 
˘x
->
°¨t_time°amp
 = 
time°amp
;

615 
˘x
->
ïoch
 = 
ngx_cuºít_m£c
;

616 
˘x
->
off£t
 = -1;

617 
˘x
->
msg_mask
 = 0;

619  
NGX_OK
;

620 
	}
}

623 
ngx_öt_t


624 
	$ngx_πmp_Êv_°›
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
)

626 
ngx_πmp_Êv_˘x_t
 *
˘x
;

628 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_Êv_moduÀ
);

630 i‡(
˘x
 =
NULL
) {

631  
NGX_OK
;

634 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

637  
NGX_OK
;

638 
	}
}

641 
ngx_öt_t


642 
	$ngx_πmp_Êv_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
)

644 
ngx_πmp_∂ay_maö_c⁄f_t
 *
pmcf
;

645 
ngx_πmp_∂ay_fmt_t
 **
pfmt
, *
fmt
;

647 
pmcf
 = 
	`ngx_πmp_c⁄f_gë_moduÀ_maö_c⁄f
(
cf
, 
ngx_πmp_∂ay_moduÀ
);

649 
pfmt
 = 
	`ngx_¨øy_push
(&
pmcf
->
fmts
);

651 i‡(
pfmt
 =
NULL
) {

652  
NGX_ERROR
;

655 
fmt
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_∂ay_fmt_t
));

657 i‡(
fmt
 =
NULL
) {

658  
NGX_ERROR
;

661 *
pfmt
 = 
fmt
;

663 
	`ngx_°r_£t
(&
fmt
->
«me
, "flv-format");

665 
	`ngx_°r_nuŒ
(&
fmt
->
pfx
);

666 
	`ngx_°r_£t
(&
fmt
->
sfx
, ".flv");

668 
fmt
->
öô
 = 
ngx_πmp_Êv_öô
;

669 
fmt
->
°¨t
 = 
ngx_πmp_Êv_°¨t
;

670 
fmt
->
£ek
 = 
ngx_πmp_Êv_£ek
;

671 
fmt
->
°›
 = 
ngx_πmp_Êv_°›
;

672 
fmt
->
£nd
 = 
ngx_πmp_Êv_£nd
;

674  
NGX_OK
;

675 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_handler.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp.h
"

10 
	~"ngx_πmp_amf.h
"

13 
ngx_πmp_ªcv
(
ngx_evít_t
 *
ªv
);

14 
ngx_πmp_£nd
(
ngx_evít_t
 *
ªv
);

15 
ngx_πmp_pög
(
ngx_evít_t
 *
ªv
);

16 
ngx_öt_t
 
ngx_πmp_föÆize_£t_chunk_size
(
ngx_πmp_£ssi⁄_t
 *
s
);

19 
ngx_uöt_t
 
	gngx_πmp_«c˚±ed
;

22 
ngx_πmp_b™dwidth_t
 
	gngx_πmp_bw_out
;

23 
ngx_πmp_b™dwidth_t
 
	gngx_πmp_bw_ö
;

26 #ifde‡
NGX_DEBUG


28 
	$ngx_πmp_mesßge_ty≥
(
uöt8_t
 
ty≥
)

30 * 
ty≥s
[] = {

56  
ty≥
 < (
ty≥s
) / (types[0])

57 ? 
ty≥s
[
ty≥
]

59 
	}
}

63 
	$ngx_πmp_u£r_mesßge_ty≥
(
uöt16_t
 
evt
)

65 * 
evts
[] = {

76  
evt
 < (
evts
) / (evts[0])

77 ? 
evts
[
evt
]

79 
	}
}

84 
	$ngx_πmp_cy˛e
(
ngx_πmp_£ssi⁄_t
 *
s
)

86 
ngx_c⁄√˘i⁄_t
 *
c
;

88 
c
 = 
s
->
c⁄√˘i⁄
;

89 
c
->
ªad
->
h™dÀr
 = 
ngx_πmp_ªcv
;

90 
c
->
wrôe
->
h™dÀr
 = 
ngx_πmp_£nd
;

92 
s
->
pög_evt
.
d©a
 = 
c
;

93 
s
->
pög_evt
.
log
 = 
c
->log;

94 
s
->
pög_evt
.
h™dÀr
 = 
ngx_πmp_pög
;

95 
	`ngx_πmp_ª£t_pög
(
s
);

97 
	`ngx_πmp_ªcv
(
c
->
ªad
);

98 
	}
}

101 
ngx_chaö_t
 *

102 
	$ngx_πmp_Æloc_ö_buf
(
ngx_πmp_£ssi⁄_t
 *
s
)

104 
ngx_chaö_t
 *
˛
;

105 
ngx_buf_t
 *
b
;

106 
size_t
 
size
;

108 i‡((
˛
 = 
	`ngx_Æloc_chaö_lök
(
s
->
ö_poﬁ
)Ë=
NULL


109 || (
˛
->
buf
 = 
	`ngx_ˇŒoc_buf
(
s
->
ö_poﬁ
)Ë=
NULL
)

111  
NULL
;

114 
˛
->
√xt
 = 
NULL
;

115 
b
 = 
˛
->
buf
;

116 
size
 = 
s
->
ö_chunk_size
 + 
NGX_RTMP_MAX_CHUNK_HEADER
;

118 
b
->
°¨t
 = b->
œ°
 = b->
pos
 = 
	`ngx_∑Œoc
(
s
->
ö_poﬁ
, 
size
);

119 i‡(
b
->
°¨t
 =
NULL
) {

120  
NULL
;

122 
b
->
íd
 = b->
°¨t
 + 
size
;

124  
˛
;

125 
	}
}

129 
	$ngx_πmp_ª£t_pög
(
ngx_πmp_£ssi⁄_t
 *
s
)

131 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

133 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

134 i‡(
cscf
->
pög
 == 0) {

138 
s
->
pög_a˘ive
 = 0;

139 
s
->
pög_ª£t
 = 0;

140 
	`ngx_add_timî
(&
s
->
pög_evt
, 
cscf
->
pög
);

142 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

143 "pög: waô %Mms", 
cscf
->
pög
);

144 
	}
}

148 
	$ngx_πmp_pög
(
ngx_evít_t
 *
≥v
)

150 
ngx_c⁄√˘i⁄_t
 *
c
;

151 
ngx_πmp_£ssi⁄_t
 *
s
;

152 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

154 
c
 = 
≥v
->
d©a
;

155 
s
 = 
c
->
d©a
;

157 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

160 i‡(
s
->
pög_ª£t
) {

161 
	`ngx_πmp_ª£t_pög
(
s
);

165 i‡(
s
->
pög_a˘ive
) {

166 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
c
->
log
, 0,

168 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

172 i‡(
cscf
->
busy
) {

173 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
c
->
log
, 0,

175 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

179 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

180 "pög: scheduÀ %Mms", 
cscf
->
pög_timeout
);

182 i‡(
	`ngx_πmp_£nd_pög_ªque°
(
s
, (
uöt32_t
)
ngx_cuºít_m£c
Ë!
NGX_OK
) {

183 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

187 
s
->
pög_a˘ive
 = 1;

188 
	`ngx_add_timî
(
≥v
, 
cscf
->
pög_timeout
);

189 
	}
}

193 
	$ngx_πmp_ªcv
(
ngx_evít_t
 *
ªv
)

195 
ngx_öt_t
 
n
;

196 
ngx_c⁄√˘i⁄_t
 *
c
;

197 
ngx_πmp_£ssi⁄_t
 *
s
;

198 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

199 
ngx_πmp_hódî_t
 *
h
;

200 
ngx_πmp_°ªam_t
 *
°
, *
°0
;

201 
ngx_chaö_t
 *
ö
, *
hód
;

202 
ngx_buf_t
 *
b
;

203 
u_ch¨
 *
p
, *
µ
, *
ﬁd_pos
;

204 
size_t
 
size
, 
fsize
, 
ﬁd_size
;

205 
uöt8_t
 
fmt
, 
ext
;

206 
uöt32_t
 
csid
, 
time°amp
;

208 
c
 = 
ªv
->
d©a
;

209 
s
 = 
c
->
d©a
;

210 
b
 = 
NULL
;

211 
ﬁd_pos
 = 
NULL
;

212 
ﬁd_size
 = 0;

213 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

215 i‡(
c
->
de°royed
) {

221 
°
 = &
s
->
ö_°ªams
[s->
ö_csid
];

224 i‡(
°
->
ö
 =
NULL
) {

225 
°
->
ö
 = 
	`ngx_πmp_Æloc_ö_buf
(
s
);

226 i‡(
°
->
ö
 =
NULL
) {

227 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
c
->
log
, 0,

229 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

234 
h
 = &
°
->
hdr
;

235 
ö
 = 
°
->in;

236 
b
 = 
ö
->
buf
;

238 i‡(
ﬁd_size
) {

240 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
c
->
log
, 0,

241 "ªusög f‹mîlyÑód d©a: %d", 
ﬁd_size
);

243 
b
->
pos
 = b->
°¨t
;

244 
b
->
œ°
 = 
	`ngx_movemem
(b->
pos
, 
ﬁd_pos
, 
ﬁd_size
);

246 i‡(
s
->
ö_chunk_size_ch™gög
) {

247 
	`ngx_πmp_föÆize_£t_chunk_size
(
s
);

252 i‡(
ﬁd_pos
) {

253 
b
->
pos
 = b->
œ°
 = b->
°¨t
;

256 
n
 = 
c
->
	`ªcv
(c, 
b
->
œ°
, b->
íd
 - b->last);

258 i‡(
n
 =
NGX_ERROR
 ||Ç == 0) {

259 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

263 i‡(
n
 =
NGX_AGAIN
) {

264 i‡(
	`ngx_h™dÀ_ªad_evít
(
c
->
ªad
, 0Ë!
NGX_OK
) {

265 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

270 
s
->
pög_ª£t
 = 1;

271 
	`ngx_πmp_upd©e_b™dwidth
(&
ngx_πmp_bw_ö
, 
n
);

272 
b
->
œ°
 +
n
;

273 
s
->
ö_byãs
 +
n
;

275 i‡(
s
->
ö_byãs
 >= 0xf0000000) {

276 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
c
->
log
, 0,

278 
s
->
ö_byãs
 = 0;

279 
s
->
ö_œ°_ack
 = 0;

282 i‡(
s
->
ack_size
 && s->
ö_byãs
 - s->
ö_œ°_ack
 >= s->ack_size) {

284 
s
->
ö_œ°_ack
 = s->
ö_byãs
;

286 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
c
->
log
, 0,

287 "£ndög RTMP ACK(%uD)", 
s
->
ö_byãs
);

289 i‡(
	`ngx_πmp_£nd_ack
(
s
, s->
ö_byãs
)) {

290 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

296 
ﬁd_pos
 = 
NULL
;

297 
ﬁd_size
 = 0;

300 i‡(
b
->
pos
 =b->
°¨t
) {

301 
p
 = 
b
->
pos
;

304 
fmt
 = (*
p
 >> 6) & 0x03;

305 
csid
 = *
p
++ & 0x3f;

307 i‡(
csid
 == 0) {

308 i‡(
b
->
œ°
 - 
p
 < 1)

310 
csid
 = 64;

311 
csid
 +*(
uöt8_t
*)
p
++;

313 } i‡(
csid
 == 1) {

314 i‡(
b
->
œ°
 - 
p
 < 2)

316 
csid
 = 64;

317 
csid
 +*(
uöt8_t
*)
p
++;

318 
csid
 +(
uöt32_t
)256 * (*(
uöt8_t
*)
p
++);

321 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
c
->
log
, 0,

323 ()
fmt
, 
csid
);

325 i‡(
csid
 >(
uöt32_t
)
cscf
->
max_°ªams
) {

326 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
c
->
log
, 0,

328 
csid
, 
cscf
->
max_°ªams
);

329 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

334 i‡(
s
->
ö_csid
 == 0) {

337 
°
->
ö
 = st->ö->
√xt
;

340 
s
->
ö_csid
 = 
csid
;

341 
°
 = &
s
->
ö_°ªams
[
csid
];

342 i‡(
°
->
ö
 =
NULL
) {

343 
ö
->
√xt
 = in;

345 
ö
->
√xt
 = 
°
->in->next;

346 
°
->
ö
->
√xt
 = in;

348 
°
->
ö
 = in;

349 
h
 = &
°
->
hdr
;

350 
h
->
csid
 = csid;

353 
ext
 = 
°
->ext;

354 
time°amp
 = 
°
->
dtime
;

355 i‡(
fmt
 <= 2 ) {

356 i‡(
b
->
œ°
 - 
p
 < 3)

360 
µ
 = (
u_ch¨
*)&
time°amp
;

361 
µ
[2] = *
p
++;

362 
µ
[1] = *
p
++;

363 
µ
[0] = *
p
++;

364 
µ
[3] = 0;

366 
ext
 = (
time°amp
 == 0x00ffffff);

368 i‡(
fmt
 <= 1) {

369 i‡(
b
->
œ°
 - 
p
 < 4)

375 
µ
 = (
u_ch¨
*)&
h
->
mÀn
;

376 
µ
[2] = *
p
++;

377 
µ
[1] = *
p
++;

378 
µ
[0] = *
p
++;

379 
µ
[3] = 0;

380 
h
->
ty≥
 = *(
uöt8_t
*)
p
++;

382 i‡(
fmt
 == 0) {

383 i‡(
b
->
œ°
 - 
p
 < 4)

387 
µ
 = (
u_ch¨
*)&
h
->
msid
;

388 
µ
[0] = *
p
++;

389 
µ
[1] = *
p
++;

390 
µ
[2] = *
p
++;

391 
µ
[3] = *
p
++;

397 i‡(
ext
) {

398 i‡(
b
->
œ°
 - 
p
 < 4)

400 
µ
 = (
u_ch¨
*)&
time°amp
;

401 
µ
[3] = *
p
++;

402 
µ
[2] = *
p
++;

403 
µ
[1] = *
p
++;

404 
µ
[0] = *
p
++;

407 i‡(
°
->
Àn
 == 0) {

413 
°
->
ext
 = (exà&& 
cscf
->
publish_time_fix
);

414 i‡(
fmt
) {

415 
°
->
dtime
 = 
time°amp
;

417 
h
->
time°amp
 =Åimestamp;

418 
°
->
dtime
 = 0;

422 
	`ngx_log_debug8
(
NGX_LOG_DEBUG_RTMP
, 
c
->
log
, 0,

425 ()
fmt
, 
	`ngx_πmp_mesßge_ty≥
(
h
->
ty≥
), ()h->type,

426 
h
->
time°amp
, 
°
->
dtime
, h->
mÀn
, st->
Àn
, h->
msid
);

429 
b
->
pos
 = 
p
;

431 i‡(
h
->
mÀn
 > 
cscf
->
max_mesßge
) {

432 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
c
->
log
, 0,

433 "toÿbig mesßge: %uz", 
cscf
->
max_mesßge
);

434 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

439 
size
 = 
b
->
œ°
 - b->
pos
;

440 
fsize
 = 
h
->
mÀn
 - 
°
->
Àn
;

442 i‡(
size
 < 
	`ngx_mö
(
fsize
, 
s
->
ö_chunk_size
))

447 i‡(
fsize
 > 
s
->
ö_chunk_size
) {

449 
°
->
Àn
 +
s
->
ö_chunk_size
;

450 
b
->
œ°
 = b->
pos
 + 
s
->
ö_chunk_size
;

451 
ﬁd_pos
 = 
b
->
œ°
;

452 
ﬁd_size
 = 
size
 - 
s
->
ö_chunk_size
;

456 
hód
 = 
°
->
ö
->
√xt
;

457 
°
->
ö
->
√xt
 = 
NULL
;

458 
b
->
œ°
 = b->
pos
 + 
fsize
;

459 
ﬁd_pos
 = 
b
->
œ°
;

460 
ﬁd_size
 = 
size
 - 
fsize
;

461 
°
->
Àn
 = 0;

462 
h
->
time°amp
 +
°
->
dtime
;

464 i‡(
	`ngx_πmp_ª˚ive_mesßge
(
s
, 
h
, 
hód
Ë!
NGX_OK
) {

465 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

469 i‡(
s
->
ö_chunk_size_ch™gög
) {

471 i‡(!
ﬁd_size
) {

472 
	`ngx_πmp_föÆize_£t_chunk_size
(
s
);

477 
°0
 = &
s
->
ö_°ªams
[0];

478 
°
->
ö
->
√xt
 = 
°0
->in;

479 
°0
->
ö
 = 
hód
;

480 
°
->
ö
 = 
NULL
;

484 
s
->
ö_csid
 = 0;

486 
	}
}

490 
	$ngx_πmp_£nd
(
ngx_evít_t
 *
wev
)

492 
ngx_c⁄√˘i⁄_t
 *
c
;

493 
ngx_πmp_£ssi⁄_t
 *
s
;

494 
ngx_öt_t
 
n
;

495 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

497 
c
 = 
wev
->
d©a
;

498 
s
 = 
c
->
d©a
;

500 i‡(
c
->
de°royed
) {

504 i‡(
wev
->
timedout
) {

505 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
,

507 
c
->
timedout
 = 1;

508 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

512 i‡(
wev
->
timî_£t
) {

513 
	`ngx_dñ_timî
(
wev
);

516 i‡(
s
->
out_chaö
 =
NULL
 && s->
out_pos
 !s->
out_œ°
) {

517 
s
->
out_chaö
 = s->
out
[s->
out_pos
];

518 
s
->
out_bpos
 = s->
out_chaö
->
buf
->
pos
;

521 
s
->
out_chaö
) {

522 
n
 = 
c
->
	`£nd
(c, 
s
->
out_bpos
, s->
out_chaö
->
buf
->
œ°
 - s->out_bpos);

524 i‡(
n
 =
NGX_AGAIN
 ||Ç == 0) {

525 
	`ngx_add_timî
(
c
->
wrôe
, 
s
->
timeout
);

526 i‡(
	`ngx_h™dÀ_wrôe_evít
(
c
->
wrôe
, 0Ë!
NGX_OK
) {

527 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

532 i‡(
n
 < 0) {

533 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

537 
s
->
out_byãs
 +
n
;

538 
s
->
pög_ª£t
 = 1;

539 
	`ngx_πmp_upd©e_b™dwidth
(&
ngx_πmp_bw_out
, 
n
);

540 
s
->
out_bpos
 +
n
;

541 i‡(
s
->
out_bpos
 =s->
out_chaö
->
buf
->
œ°
) {

542 
s
->
out_chaö
 = s->out_chaö->
√xt
;

543 i‡(
s
->
out_chaö
 =
NULL
) {

544 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

545 
	`ngx_πmp_‰ì_sh¨ed_chaö
(
cscf
, 
s
->
out
[s->
out_pos
]);

546 ++
s
->
out_pos
;

547 
s
->
out_pos
 %s->
out_queue
;

548 i‡(
s
->
out_pos
 =s->
out_œ°
) {

551 
s
->
out_chaö
 = s->
out
[s->
out_pos
];

553 
s
->
out_bpos
 = s->
out_chaö
->
buf
->
pos
;

557 i‡(
wev
->
a˘ive
) {

558 
	`ngx_dñ_evít
(
wev
, 
NGX_WRITE_EVENT
, 0);

561 
	`ngx_evít_¥o˚ss_po°ed
((
ngx_cy˛e_t
 *Ë
ngx_cy˛e
, &
s
->
po°ed_dry_evíts
);

562 
	}
}

566 
	$ngx_πmp_¥ï¨e_mesßge
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

567 
ngx_πmp_hódî_t
 *
lh
, 
ngx_chaö_t
 *
out
)

569 
ngx_chaö_t
 *
l
;

570 
u_ch¨
 *
p
, *
µ
;

571 
ngx_öt_t
 
hsize
, 
thsize
, 
nbufs
;

572 
uöt32_t
 
mÀn
, 
time°amp
, 
ext_time°amp
;

573 
uöt8_t
 
hdrsize
[] = { 12, 8, 4, 1 };

574 
u_ch¨
 
th
[7];

575 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

576 
uöt8_t
 
fmt
;

577 
ngx_c⁄√˘i⁄_t
 *
c
;

579 
c
 = 
s
->
c⁄√˘i⁄
;

580 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

582 i‡(
h
->
csid
 >(
uöt32_t
)
cscf
->
max_°ªams
) {

583 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
c
->
log
, 0,

585 
h
->
csid
, 
cscf
->
max_°ªams
);

586 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

591 
mÀn
 = 0;

592 
nbufs
 = 0;

593 
l
 = 
out
;Ü;Ü =Ü->
√xt
) {

594 
mÀn
 +(
l
->
buf
->
œ°
 -Ü->buf->
pos
);

595 ++
nbufs
;

598 
fmt
 = 0;

599 i‡(
lh
 &&Üh->
csid
 && 
h
->
msid
 ==Üh->msid) {

600 ++
fmt
;

601 i‡(
h
->
ty≥
 =
lh
->ty≥ && 
mÀn
 && mlen ==Üh->mlen) {

602 ++
fmt
;

603 i‡(
h
->
time°amp
 =
lh
->timestamp) {

604 ++
fmt
;

607 
time°amp
 = 
h
->time°am∞- 
lh
->timestamp;

609 
time°amp
 = 
h
->timestamp;

617 
hsize
 = 
hdrsize
[
fmt
];

619 
	`ngx_log_debug8
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

622 
	`ngx_πmp_mesßge_ty≥
(
h
->
ty≥
), ()h->ty≥, ()
fmt
,

623 
h
->
csid
, 
time°amp
, 
mÀn
, h->
msid
, 
nbufs
);

625 
ext_time°amp
 = 0;

626 i‡(
time°amp
 >= 0x00ffffff) {

627 
ext_time°amp
 = 
time°amp
;

628 
time°amp
 = 0x00ffffff;

629 
hsize
 += 4;

632 i‡(
h
->
csid
 >= 64) {

633 ++
hsize
;

634 i‡(
h
->
csid
 >= 320) {

635 ++
hsize
;

640 
out
->
buf
->
pos
 -
hsize
;

641 
p
 = 
out
->
buf
->
pos
;

644 *
p
 = (
fmt
 << 6);

645 i‡(
h
->
csid
 >= 2 && h->csid <= 63) {

646 *
p
++ |(((
uöt8_t
)
h
->
csid
) & 0x3f);

647 } i‡(
h
->
csid
 >= 64 && h->csid < 320) {

648 ++
p
;

649 *
p
++ = (
uöt8_t
)(
h
->
csid
 - 64);

651 *
p
++ |= 1;

652 *
p
++ = (
uöt8_t
)(
h
->
csid
 - 64);

653 *
p
++ = (
uöt8_t
)((
h
->
csid
 - 64) >> 8);

657 
thsize
 = 
p
 - 
out
->
buf
->
pos
;

658 
	`ngx_mem˝y
(
th
, 
out
->
buf
->
pos
, 
thsize
);

659 
th
[0] |= 0xc0;

662 i‡(
fmt
 <= 2) {

663 
µ
 = (
u_ch¨
*)&
time°amp
;

664 *
p
++ = 
µ
[2];

665 *
p
++ = 
µ
[1];

666 *
p
++ = 
µ
[0];

667 i‡(
fmt
 <= 1) {

668 
µ
 = (
u_ch¨
*)&
mÀn
;

669 *
p
++ = 
µ
[2];

670 *
p
++ = 
µ
[1];

671 *
p
++ = 
µ
[0];

672 *
p
++ = 
h
->
ty≥
;

673 i‡(
fmt
 == 0) {

674 
µ
 = (
u_ch¨
*)&
h
->
msid
;

675 *
p
++ = 
µ
[0];

676 *
p
++ = 
µ
[1];

677 *
p
++ = 
µ
[2];

678 *
p
++ = 
µ
[3];

684 i‡(
ext_time°amp
) {

685 
µ
 = (
u_ch¨
*)&
ext_time°amp
;

686 *
p
++ = 
µ
[3];

687 *
p
++ = 
µ
[2];

688 *
p
++ = 
µ
[1];

689 *
p
++ = 
µ
[0];

695 i‡(
cscf
->
∂ay_time_fix
) {

696 
	`ngx_mem˝y
(&
th
[
thsize
], 
p
 - 4, 4);

697 
thsize
 += 4;

702 
out
 = out->
√xt
; out; out = out->next) {

703 
out
->
buf
->
pos
 -
thsize
;

704 
	`ngx_mem˝y
(
out
->
buf
->
pos
, 
th
, 
thsize
);

706 
	}
}

709 
ngx_öt_t


710 
	$ngx_πmp_£nd_mesßge
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_chaö_t
 *
out
,

711 
ngx_uöt_t
 
¥i‹ôy
)

713 
ngx_uöt_t
 
nmsg
;

715 
nmsg
 = (
s
->
out_œ°
 - s->
out_pos
Ë% s->
out_queue
 + 1;

717 i‡(
¥i‹ôy
 > 3) {

718 
¥i‹ôy
 = 3;

723 i‡(
nmsg
 + 
¥i‹ôy
 * 
s
->
out_queue
 / 4 >= s->out_queue) {

724 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

726 
nmsg
, 
¥i‹ôy
);

727  
NGX_AGAIN
;

730 
s
->
out
[s->
out_œ°
++] = out;

731 
s
->
out_œ°
 %s->
out_queue
;

733 
	`ngx_πmp_acquúe_sh¨ed_chaö
(
out
);

735 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

737 
nmsg
, 
¥i‹ôy
, 
s
->
out_œ°
);

739 i‡(
¥i‹ôy
 && 
s
->
out_buf„r
 && 
nmsg
 < s->
out_c‹k
) {

740  
NGX_OK
;

743 i‡(!
s
->
c⁄√˘i⁄
->
wrôe
->
a˘ive
) {

744 
	`ngx_πmp_£nd
(
s
->
c⁄√˘i⁄
->
wrôe
);

748  
NGX_OK
;

749 
	}
}

752 
ngx_öt_t


753 
	$ngx_πmp_ª˚ive_mesßge
(
ngx_πmp_£ssi⁄_t
 *
s
,

754 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
)

756 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
;

757 
ngx_¨øy_t
 *
evhs
;

758 
size_t
 
n
;

759 
ngx_πmp_h™dÀr_±
 *
evh
;

761 
cmcf
 = 
	`ngx_πmp_gë_moduÀ_maö_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

763 #ifde‡
NGX_DEBUG


765 
nbufs
;

766 
ngx_chaö_t
 *
ch
;

768 
nbufs
 = 1, 
ch
 = 
ö
;

769 
ch
->
√xt
;

770 
ch
 = ch->
√xt
, ++
nbufs
);

772 
	`ngx_log_debug7
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

775 
	`ngx_πmp_mesßge_ty≥
(
h
->
ty≥
), ()h->type,

776 
h
->
csid
, h->
time°amp
, h->
mÀn
, h->
msid
, 
nbufs
);

780 i‡(
h
->
ty≥
 > 
NGX_RTMP_MSG_MAX
) {

781 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

782 "u√x≥˘ed RTMP mesßgêty≥: %d", ()
h
->
ty≥
);

783  
NGX_OK
;

786 
evhs
 = &
cmcf
->
evíts
[
h
->
ty≥
];

787 
evh
 = 
evhs
->
ñts
;

789 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

790 "nh™dÀrs: %d", 
evhs
->
√…s
);

792 
n
 = 0;Ç < 
evhs
->
√…s
; ++n, ++
evh
) {

793 i‡(!
evh
) {

796 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

797 "ˇŒög h™dÀ∏%d", 
n
);

799 (*
evh
)(
s
, 
h
, 
ö
)) {

800 
NGX_ERROR
:

801 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

802 "h™dÀ∏%d faûed", 
n
);

803  
NGX_ERROR
;

804 
NGX_DONE
:

805  
NGX_OK
;

809  
NGX_OK
;

810 
	}
}

813 
ngx_öt_t


814 
	$ngx_πmp_£t_chunk_size
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_uöt_t
 
size
)

816 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

817 
ngx_chaö_t
 *
li
, *
Êi
, *
lo
, *
Êo
;

818 
ngx_buf_t
 *
bi
, *
bo
;

819 
ngx_öt_t
 
n
;

821 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

822 "£âög chunk_size=%ui", 
size
);

824 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

826 
s
->
ö_ﬁd_poﬁ
 = s->
ö_poﬁ
;

827 
s
->
ö_chunk_size
 = 
size
;

828 
s
->
ö_poﬁ
 = 
	`ngx_¸óã_poﬁ
(4096, s->
c⁄√˘i⁄
->
log
);

831 i‡(
s
->
ö_ﬁd_poﬁ
) {

832 
s
->
ö_chunk_size_ch™gög
 = 1;

833 
s
->
ö_°ªams
[0].
ö
 = 
NULL
;

835 
n
 = 1;Ç < 
cscf
->
max_°ªams
; ++n) {

840 
li
 = 
s
->
ö_°ªams
[
n
].
ö
;

841 i‡(
li
 =
NULL
 ||Üi->
√xt
 == NULL) {

842 
s
->
ö_°ªams
[
n
].
ö
 = 
NULL
;

846 
li
 =Üi->
√xt
;

847 
Êi
 = 
li
;

848 
lo
 = 
	`ngx_πmp_Æloc_ö_buf
(
s
);

849 i‡(
lo
 =
NULL
) {

850  
NGX_ERROR
;

852 
Êo
 = 
lo
;

854 
bi
 = 
li
->
buf
;

855 
bo
 = 
lo
->
buf
;

857 i‡(
bo
->
íd
 - bo->
œ°
 >
bi
->œ° - bi->
pos
) {

858 
bo
->
œ°
 = 
	`ngx_˝ymem
(bo->œ°, 
bi
->
pos
,

859 
bi
->
œ°
 - bi->
pos
);

860 
li
 =Üi->
√xt
;

861 i‡(
li
 =
Êi
) {

862 
lo
->
√xt
 = 
Êo
;

863 
s
->
ö_°ªams
[
n
].
ö
 = 
lo
;

869 
bi
->
pos
 +(
	`ngx_˝ymem
(
bo
->
œ°
, bi->pos,

870 
bo
->
íd
 - bo->
œ°
) - bo->last);

871 
lo
->
√xt
 = 
	`ngx_πmp_Æloc_ö_buf
(
s
);

872 
lo
 =Üo->
√xt
;

873 i‡(
lo
 =
NULL
) {

874  
NGX_ERROR
;

880  
NGX_OK
;

881 
	}
}

884 
ngx_öt_t


885 
	$ngx_πmp_föÆize_£t_chunk_size
(
ngx_πmp_£ssi⁄_t
 *
s
)

887 i‡(
s
->
ö_chunk_size_ch™gög
 && s->
ö_ﬁd_poﬁ
) {

888 
	`ngx_de°roy_poﬁ
(
s
->
ö_ﬁd_poﬁ
);

889 
s
->
ö_ﬁd_poﬁ
 = 
NULL
;

890 
s
->
ö_chunk_size_ch™gög
 = 0;

892  
NGX_OK
;

893 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_handshake.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp.h
"

11 
	~<›ís¶/hmac.h
>

12 
	~<›ís¶/sha.h
>

15 
ngx_πmp_h™dshake_£nd
(
ngx_evít_t
 *
wev
);

16 
ngx_πmp_h™dshake_ªcv
(
ngx_evít_t
 *
ªv
);

17 
ngx_πmp_h™dshake_d⁄e
(
ngx_πmp_£ssi⁄_t
 *
s
);

37 
u_ch¨


38 
	gngx_πmp_£rvî_key
[] = {

50 
u_ch¨


51 
	gngx_πmp_˛õ¡_key
[] = {

62 c⁄° 
u_ch¨


63 
	gngx_πmp_£rvî_vîsi⁄
[4] = {

68 c⁄° 
u_ch¨


69 
	gngx_πmp_˛õ¡_vîsi⁄
[4] = {

74 
	#NGX_RTMP_HANDSHAKE_KEYLEN
 
SHA256_DIGEST_LENGTH


	)

75 
	#NGX_RTMP_HANDSHAKE_BUFSIZE
 1537

	)

78 
	#NGX_RTMP_HANDSHAKE_SERVER_RECV_CHALLENGE
 1

	)

79 
	#NGX_RTMP_HANDSHAKE_SERVER_SEND_CHALLENGE
 2

	)

80 
	#NGX_RTMP_HANDSHAKE_SERVER_SEND_RESPONSE
 3

	)

81 
	#NGX_RTMP_HANDSHAKE_SERVER_RECV_RESPONSE
 4

	)

82 
	#NGX_RTMP_HANDSHAKE_SERVER_DONE
 5

	)

85 
	#NGX_RTMP_HANDSHAKE_CLIENT_SEND_CHALLENGE
 6

	)

86 
	#NGX_RTMP_HANDSHAKE_CLIENT_RECV_CHALLENGE
 7

	)

87 
	#NGX_RTMP_HANDSHAKE_CLIENT_RECV_RESPONSE
 8

	)

88 
	#NGX_RTMP_HANDSHAKE_CLIENT_SEND_RESPONSE
 9

	)

89 
	#NGX_RTMP_HANDSHAKE_CLIENT_DONE
 10

	)

92 
ngx_°r_t
 
	gngx_πmp_£rvî_fuŒ_key


93 { (
ngx_πmp_£rvî_key
),Çgx_rtmp_server_key };

94 
ngx_°r_t
 
	gngx_πmp_£rvî_∑πül_key


95 { 36, 
ngx_πmp_£rvî_key
 };

97 
ngx_°r_t
 
	gngx_πmp_˛õ¡_fuŒ_key


98 { (
ngx_πmp_˛õ¡_key
),Çgx_rtmp_client_key };

99 
ngx_°r_t
 
	gngx_πmp_˛õ¡_∑πül_key


100 { 30, 
ngx_πmp_˛õ¡_key
 };

103 
ngx_öt_t


104 
	$ngx_πmp_make_dige°
(
ngx_°r_t
 *
key
, 
ngx_buf_t
 *
§c
,

105 
u_ch¨
 *
skù
, u_ch¨ *
d°
, 
ngx_log_t
 *
log
)

107 
HMAC_CTX
 
hmac
;

108 
hmac_öôülized
;

109 
Àn
;

111 i‡(!
hmac_öôülized
) {

112 
	`HMAC_CTX_öô
(&
hmac
);

113 
hmac_öôülized
 = 1;

116 
	`HMAC_Inô_ex
(&
hmac
, 
key
->
d©a
, key->
Àn
, 
	`EVP_sha256
(), 
NULL
);

118 i‡(
skù
 && 
§c
->
pos
 <skù && skù <§c->
œ°
) {

119 i‡(
skù
 !
§c
->
pos
) {

120 
	`HMAC_Upd©e
(&
hmac
, 
§c
->
pos
, 
skù
 - src->pos);

122 i‡(
§c
->
œ°
 !
skù
 + 
NGX_RTMP_HANDSHAKE_KEYLEN
) {

123 
	`HMAC_Upd©e
(&
hmac
, 
skù
 + 
NGX_RTMP_HANDSHAKE_KEYLEN
,

124 
§c
->
œ°
 - 
skù
 - 
NGX_RTMP_HANDSHAKE_KEYLEN
);

127 
	`HMAC_Upd©e
(&
hmac
, 
§c
->
pos
, src->
œ°
 - src->pos);

130 
	`HMAC_FöÆ
(&
hmac
, 
d°
, &
Àn
);

132  
NGX_OK
;

133 
	}
}

136 
ngx_öt_t


137 
	$ngx_πmp_föd_dige°
(
ngx_buf_t
 *
b
, 
ngx_°r_t
 *
key
, 
size_t
 
ba£
, 
ngx_log_t
 *
log
)

139 
size_t
 
n
, 
offs
;

140 
u_ch¨
 
dige°
[
NGX_RTMP_HANDSHAKE_KEYLEN
];

141 
u_ch¨
 *
p
;

143 
offs
 = 0;

144 
n
 = 0;Ç < 4; ++n) {

145 
offs
 +
b
->
pos
[
ba£
 + 
n
];

147 
offs
 = (off†% 728Ë+ 
ba£
 + 4;

148 
p
 = 
b
->
pos
 + 
offs
;

150 i‡(
	`ngx_πmp_make_dige°
(
key
, 
b
, 
p
, 
dige°
, 
log
Ë!
NGX_OK
) {

151  
NGX_ERROR
;

154 i‡(
	`ngx_memcmp
(
dige°
, 
p
, 
NGX_RTMP_HANDSHAKE_KEYLEN
) == 0) {

155  
offs
;

158  
NGX_ERROR
;

159 
	}
}

162 
ngx_öt_t


163 
	$ngx_πmp_wrôe_dige°
(
ngx_buf_t
 *
b
, 
ngx_°r_t
 *
key
, 
size_t
 
ba£
,

164 
ngx_log_t
 *
log
)

166 
size_t
 
n
, 
offs
;

167 
u_ch¨
 *
p
;

169 
offs
 = 0;

170 
n
 = 8;Ç < 12; ++n) {

171 
offs
 +
b
->
pos
[
ba£
 + 
n
];

173 
offs
 = (off†% 728Ë+ 
ba£
 + 12;

174 
p
 = 
b
->
pos
 + 
offs
;

176 i‡(
	`ngx_πmp_make_dige°
(
key
, 
b
, 
p
,Ö, 
log
Ë!
NGX_OK
) {

177  
NGX_ERROR
;

180  
NGX_OK
;

181 
	}
}

185 
	$ngx_πmp_fûl_øndom_buf„r
(
ngx_buf_t
 *
b
)

187 ; 
b
->
œ°
 !b->
íd
; ++b->last) {

188 *
b
->
œ°
 = (
u_ch¨
Ë
	`ønd
();

190 
	}
}

193 
ngx_buf_t
 *

194 
	$ngx_πmp_Æloc_h™dshake_buf„r
(
ngx_πmp_£ssi⁄_t
 *
s
)

196 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

197 
ngx_chaö_t
 *
˛
;

198 
ngx_buf_t
 *
b
;

200 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

203 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

205 i‡(
cscf
->
‰ì_hs
) {

206 
˛
 = 
cscf
->
‰ì_hs
;

207 
b
 = 
˛
->
buf
;

208 
cscf
->
‰ì_hs
 = 
˛
->
√xt
;

209 
	`ngx_‰ì_chaö
(
cscf
->
poﬁ
, 
˛
);

212 
b
 = 
	`ngx_pˇŒoc
(
cscf
->
poﬁ
, (
ngx_buf_t
));

213 i‡(
b
 =
NULL
) {

214  
NULL
;

216 
b
->
mem‹y
 = 1;

217 
b
->
°¨t
 = 
	`ngx_pˇŒoc
(
cscf
->
poﬁ
, 
NGX_RTMP_HANDSHAKE_BUFSIZE
);

218 i‡(
b
->
°¨t
 =
NULL
) {

219  
NULL
;

221 
b
->
íd
 = b->
°¨t
 + 
NGX_RTMP_HANDSHAKE_BUFSIZE
;

224 
b
->
pos
 = b->
œ°
 = b->
°¨t
;

226  
b
;

227 
	}
}

231 
	$ngx_πmp_‰ì_h™dshake_buf„rs
(
ngx_πmp_£ssi⁄_t
 *
s
)

233 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

234 
ngx_chaö_t
 *
˛
;

236 i‡(
s
->
hs_buf
 =
NULL
) {

239 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

240 
˛
 = 
	`ngx_Æloc_chaö_lök
(
cscf
->
poﬁ
);

241 i‡(
˛
 =
NULL
) {

244 
˛
->
buf
 = 
s
->
hs_buf
;

245 
˛
->
√xt
 = 
cscf
->
‰ì_hs
;

246 
cscf
->
‰ì_hs
 = 
˛
;

247 
s
->
hs_buf
 = 
NULL
;

248 
	}
}

251 
ngx_öt_t


252 
	$ngx_πmp_h™dshake_¸óã_chÆÀnge
(
ngx_πmp_£ssi⁄_t
 *
s
,

253 c⁄° 
u_ch¨
 
vîsi⁄
[4], 
ngx_°r_t
 *
key
)

255 
ngx_buf_t
 *
b
;

257 
b
 = 
s
->
hs_buf
;

258 
b
->
œ°
 = b->
pos
 = b->
°¨t
;

259 *
b
->
œ°
++ = '\x03';

260 
b
->
œ°
 = 
	`ngx_πmp_r˝ymem
(b->œ°, &
s
->
ïoch
, 4);

261 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, 
vîsi⁄
, 4);

262 
	`ngx_πmp_fûl_øndom_buf„r
(
b
);

263 ++
b
->
pos
;

264 i‡(
	`ngx_πmp_wrôe_dige°
(
b
, 
key
, 0, 
s
->
c⁄√˘i⁄
->
log
Ë!
NGX_OK
) {

265  
NGX_ERROR
;

267 --
b
->
pos
;

268  
NGX_OK
;

269 
	}
}

272 
ngx_öt_t


273 
	$ngx_πmp_h™dshake_∑r£_chÆÀnge
(
ngx_πmp_£ssi⁄_t
 *
s
,

274 
ngx_°r_t
 *
≥î_key
,Çgx_°r_à*
key
)

276 
ngx_buf_t
 *
b
;

277 
u_ch¨
 *
p
;

278 
ngx_öt_t
 
offs
;

280 
b
 = 
s
->
hs_buf
;

281 i‡(*
b
->
pos
 != '\x03') {

282 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

284 (
ngx_öt_t
)*
b
->
pos
);

285  
NGX_ERROR
;

287 ++
b
->
pos
;

288 
s
->
≥î_ïoch
 = 0;

289 
	`ngx_πmp_rmem˝y
(&
s
->
≥î_ïoch
, 
b
->
pos
, 4);

291 
p
 = 
b
->
pos
 + 4;

292 
	`ngx_log_debug5
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

294 (
ngx_öt_t
)
p
[3], (ngx_int_t)p[2],

295 (
ngx_öt_t
)
p
[1], (ngx_int_t)p[0],

296 (
uöt32_t
)
s
->
≥î_ïoch
);

297 i‡(*(
uöt32_t
 *)
p
 == 0) {

298 
s
->
hs_ﬁd
 = 1;

299  
NGX_OK
;

302 
offs
 = 
	`ngx_πmp_föd_dige°
(
b
, 
≥î_key
, 772, 
s
->
c⁄√˘i⁄
->
log
);

303 i‡(
offs
 =
NGX_ERROR
) {

304 
offs
 = 
	`ngx_πmp_föd_dige°
(
b
, 
≥î_key
, 8, 
s
->
c⁄√˘i⁄
->
log
);

306 i‡(
offs
 =
NGX_ERROR
) {

307 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

309 
s
->
hs_ﬁd
 = 1;

310  
NGX_OK
;

312 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

313 "h™dshake: dige° foundáàpos=%i", 
offs
);

314 
b
->
pos
 +
offs
;

315 
b
->
œ°
 = b->
pos
 + 
NGX_RTMP_HANDSHAKE_KEYLEN
;

316 
s
->
hs_dige°
 = 
	`ngx_∑Œoc
(s->
c⁄√˘i⁄
->
poﬁ
, 
NGX_RTMP_HANDSHAKE_KEYLEN
);

317 i‡(
	`ngx_πmp_make_dige°
(
key
, 
b
, 
NULL
, 
s
->
hs_dige°
, s->
c⁄√˘i⁄
->
log
)

318 !
NGX_OK
)

320  
NGX_ERROR
;

322  
NGX_OK
;

323 
	}
}

326 
ngx_öt_t


327 
	$ngx_πmp_h™dshake_¸óã_ª•⁄£
(
ngx_πmp_£ssi⁄_t
 *
s
)

329 
ngx_buf_t
 *
b
;

330 
u_ch¨
 *
p
;

331 
ngx_°r_t
 
key
;

333 
b
 = 
s
->
hs_buf
;

334 
b
->
pos
 = b->
œ°
 = b->
°¨t
 + 1;

335 
	`ngx_πmp_fûl_øndom_buf„r
(
b
);

336 i‡(
s
->
hs_dige°
) {

337 
p
 = 
b
->
œ°
 - 
NGX_RTMP_HANDSHAKE_KEYLEN
;

338 
key
.
d©a
 = 
s
->
hs_dige°
;

339 
key
.
Àn
 = 
NGX_RTMP_HANDSHAKE_KEYLEN
;

340 i‡(
	`ngx_πmp_make_dige°
(&
key
, 
b
, 
p
,Ö, 
s
->
c⁄√˘i⁄
->
log
Ë!
NGX_OK
) {

341  
NGX_ERROR
;

345  
NGX_OK
;

346 
	}
}

350 
	$ngx_πmp_h™dshake_d⁄e
(
ngx_πmp_£ssi⁄_t
 *
s
)

352 
	`ngx_πmp_‰ì_h™dshake_buf„rs
(
s
);

354 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

357 i‡(
	`ngx_πmp_fúe_evít
(
s
, 
NGX_RTMP_HANDSHAKE_DONE
,

358 
NULL
, NULLË!
NGX_OK
)

360 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

364 
	`ngx_πmp_cy˛e
(
s
);

365 
	}
}

369 
	$ngx_πmp_h™dshake_ªcv
(
ngx_evít_t
 *
ªv
)

371 
ssize_t
 
n
;

372 
ngx_c⁄√˘i⁄_t
 *
c
;

373 
ngx_πmp_£ssi⁄_t
 *
s
;

374 
ngx_buf_t
 *
b
;

376 
c
 = 
ªv
->
d©a
;

377 
s
 = 
c
->
d©a
;

379 i‡(
c
->
de°royed
) {

383 i‡(
ªv
->
timedout
) {

384 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
,

386 
c
->
timedout
 = 1;

387 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

391 i‡(
ªv
->
timî_£t
) {

392 
	`ngx_dñ_timî
(
ªv
);

395 
b
 = 
s
->
hs_buf
;

397 
b
->
œ°
 !b->
íd
) {

398 
n
 = 
c
->
	`ªcv
(c, 
b
->
œ°
, b->
íd
 - b->last);

400 i‡(
n
 =
NGX_ERROR
 ||Ç == 0) {

401 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

405 i‡(
n
 =
NGX_AGAIN
) {

406 
	`ngx_add_timî
(
ªv
, 
s
->
timeout
);

407 i‡(
	`ngx_h™dÀ_ªad_evít
(
c
->
ªad
, 0Ë!
NGX_OK
) {

408 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

413 
b
->
œ°
 +
n
;

416 i‡(
ªv
->
a˘ive
) {

417 
	`ngx_dñ_evít
(
ªv
, 
NGX_READ_EVENT
, 0);

420 ++
s
->
hs_°age
;

421 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

422 "h™dshake: sègê%ui", 
s
->
hs_°age
);

424 
s
->
hs_°age
) {

425 
NGX_RTMP_HANDSHAKE_SERVER_SEND_CHALLENGE
:

426 i‡(
	`ngx_πmp_h™dshake_∑r£_chÆÀnge
(
s
,

427 &
ngx_πmp_˛õ¡_∑πül_key
,

428 &
ngx_πmp_£rvî_fuŒ_key
Ë!
NGX_OK
)

430 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
c
->
log
, 0,

432 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

435 i‡(
s
->
hs_ﬁd
) {

436 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

438 
s
->
hs_buf
->
pos
 = s->hs_buf->
°¨t
;

439 
s
->
hs_buf
->
œ°
 = s->hs_buf->
íd
;

440 } i‡(
	`ngx_πmp_h™dshake_¸óã_chÆÀnge
(
s
,

441 
ngx_πmp_£rvî_vîsi⁄
,

442 &
ngx_πmp_£rvî_∑πül_key
Ë!
NGX_OK
)

444 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
c
->
log
, 0,

446 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

449 
	`ngx_πmp_h™dshake_£nd
(
c
->
wrôe
);

452 
NGX_RTMP_HANDSHAKE_SERVER_DONE
:

453 
	`ngx_πmp_h™dshake_d⁄e
(
s
);

456 
NGX_RTMP_HANDSHAKE_CLIENT_RECV_RESPONSE
:

457 i‡(
	`ngx_πmp_h™dshake_∑r£_chÆÀnge
(
s
,

458 &
ngx_πmp_£rvî_∑πül_key
,

459 &
ngx_πmp_˛õ¡_fuŒ_key
Ë!
NGX_OK
)

461 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
c
->
log
, 0,

463 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

466 
s
->
hs_buf
->
pos
 = s->hs_buf->
œ°
 = s->hs_buf->
°¨t
 + 1;

467 
	`ngx_πmp_h™dshake_ªcv
(
c
->
ªad
);

470 
NGX_RTMP_HANDSHAKE_CLIENT_SEND_RESPONSE
:

471 i‡(
	`ngx_πmp_h™dshake_¸óã_ª•⁄£
(
s
Ë!
NGX_OK
) {

472 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
c
->
log
, 0,

474 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

477 
	`ngx_πmp_h™dshake_£nd
(
c
->
wrôe
);

480 
	}
}

484 
	$ngx_πmp_h™dshake_£nd
(
ngx_evít_t
 *
wev
)

486 
ngx_öt_t
 
n
;

487 
ngx_c⁄√˘i⁄_t
 *
c
;

488 
ngx_πmp_£ssi⁄_t
 *
s
;

489 
ngx_buf_t
 *
b
;

491 
c
 = 
wev
->
d©a
;

492 
s
 = 
c
->
d©a
;

494 i‡(
c
->
de°royed
) {

498 i‡(
wev
->
timedout
) {

499 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
,

501 
c
->
timedout
 = 1;

502 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

506 i‡(
wev
->
timî_£t
) {

507 
	`ngx_dñ_timî
(
wev
);

510 
b
 = 
s
->
hs_buf
;

512 
b
->
pos
 !b->
œ°
) {

513 
n
 = 
c
->
	`£nd
(c, 
b
->
pos
, b->
œ°
 - b->pos);

515 i‡(
n
 =
NGX_ERROR
) {

516 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

520 i‡(
n
 =
NGX_AGAIN
 ||Ç == 0) {

521 
	`ngx_add_timî
(
c
->
wrôe
, 
s
->
timeout
);

522 i‡(
	`ngx_h™dÀ_wrôe_evít
(
c
->
wrôe
, 0Ë!
NGX_OK
) {

523 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

528 
b
->
pos
 +
n
;

531 i‡(
wev
->
a˘ive
) {

532 
	`ngx_dñ_evít
(
wev
, 
NGX_WRITE_EVENT
, 0);

535 ++
s
->
hs_°age
;

536 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

537 "h™dshake: sègê%ui", 
s
->
hs_°age
);

539 
s
->
hs_°age
) {

540 
NGX_RTMP_HANDSHAKE_SERVER_SEND_RESPONSE
:

541 i‡(
s
->
hs_ﬁd
) {

542 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

544 
s
->
hs_buf
->
pos
 = s->hs_buf->
°¨t
 + 1;

545 
s
->
hs_buf
->
œ°
 = s->hs_buf->
íd
;

546 } i‡(
	`ngx_πmp_h™dshake_¸óã_ª•⁄£
(
s
Ë!
NGX_OK
) {

547 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
c
->
log
, 0,

549 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

552 
	`ngx_πmp_h™dshake_£nd
(
wev
);

555 
NGX_RTMP_HANDSHAKE_SERVER_RECV_RESPONSE
:

556 
s
->
hs_buf
->
pos
 = s->hs_buf->
œ°
 = s->hs_buf->
°¨t
 + 1;

557 
	`ngx_πmp_h™dshake_ªcv
(
c
->
ªad
);

560 
NGX_RTMP_HANDSHAKE_CLIENT_RECV_CHALLENGE
:

561 
s
->
hs_buf
->
pos
 = s->hs_buf->
œ°
 = s->hs_buf->
°¨t
;

562 
	`ngx_πmp_h™dshake_ªcv
(
c
->
ªad
);

565 
NGX_RTMP_HANDSHAKE_CLIENT_DONE
:

566 
	`ngx_πmp_h™dshake_d⁄e
(
s
);

569 
	}
}

573 
	$ngx_πmp_h™dshake
(
ngx_πmp_£ssi⁄_t
 *
s
)

575 
ngx_c⁄√˘i⁄_t
 *
c
;

577 
c
 = 
s
->
c⁄√˘i⁄
;

578 
c
->
ªad
->
h™dÀr
 = 
ngx_πmp_h™dshake_ªcv
;

579 
c
->
wrôe
->
h™dÀr
 = 
ngx_πmp_h™dshake_£nd
;

581 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

584 
s
->
hs_buf
 = 
	`ngx_πmp_Æloc_h™dshake_buf„r
(s);

585 
s
->
hs_°age
 = 
NGX_RTMP_HANDSHAKE_SERVER_RECV_CHALLENGE
;

587 
	`ngx_πmp_h™dshake_ªcv
(
c
->
ªad
);

588 
	}
}

592 
	$ngx_πmp_˛õ¡_h™dshake
(
ngx_πmp_£ssi⁄_t
 *
s
, 
async
)

594 
ngx_c⁄√˘i⁄_t
 *
c
;

596 
c
 = 
s
->
c⁄√˘i⁄
;

597 
c
->
ªad
->
h™dÀr
 = 
ngx_πmp_h™dshake_ªcv
;

598 
c
->
wrôe
->
h™dÀr
 = 
ngx_πmp_h™dshake_£nd
;

600 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

603 
s
->
hs_buf
 = 
	`ngx_πmp_Æloc_h™dshake_buf„r
(s);

604 
s
->
hs_°age
 = 
NGX_RTMP_HANDSHAKE_CLIENT_SEND_CHALLENGE
;

606 i‡(
	`ngx_πmp_h™dshake_¸óã_chÆÀnge
(
s
,

607 
ngx_πmp_˛õ¡_vîsi⁄
,

608 &
ngx_πmp_˛õ¡_∑πül_key
Ë!
NGX_OK
)

610 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

614 i‡(
async
) {

615 
	`ngx_add_timî
(
c
->
wrôe
, 
s
->
timeout
);

616 i‡(
	`ngx_h™dÀ_wrôe_evít
(
c
->
wrôe
, 0Ë!
NGX_OK
) {

617 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

622 
	`ngx_πmp_h™dshake_£nd
(
c
->
wrôe
);

623 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_init.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp.h
"

10 
	~"ngx_πmp_¥oxy_¥Ÿocﬁ.h
"

13 
ngx_πmp_˛o£_c⁄√˘i⁄
(
ngx_c⁄√˘i⁄_t
 *
c
);

14 
u_ch¨
 * 
ngx_πmp_log_îr‹
(
ngx_log_t
 *
log
, u_ch¨ *
buf
, 
size_t
 
Àn
);

18 
	$ngx_πmp_öô_c⁄√˘i⁄
(
ngx_c⁄√˘i⁄_t
 *
c
)

20 
ngx_uöt_t
 
i
;

21 
ngx_πmp_p‹t_t
 *
p‹t
;

22 
sockaddr
 *
ß
;

23 
sockaddr_ö
 *
sö
;

24 
ngx_πmp_ö_addr_t
 *
addr
;

25 
ngx_πmp_£ssi⁄_t
 *
s
;

26 
ngx_πmp_addr_c⁄f_t
 *
addr_c⁄f
;

27 
ngx_öt_t
 
unix_sockë
;

28 #i‡(
NGX_HAVE_INET6
)

29 
sockaddr_ö6
 *
sö6
;

30 
ngx_πmp_ö6_addr_t
 *
addr6
;

33 ++
ngx_πmp_«c˚±ed
;

39 
p‹t
 = 
c
->
li°íög
->
£rvîs
;

40 
unix_sockë
 = 0;

42 i‡(
p‹t
->
«ddrs
 > 1) {

52 i‡(
	`ngx_c⁄√˘i⁄_loˇl_sockaddr
(
c
, 
NULL
, 0Ë!
NGX_OK
) {

53 
	`ngx_πmp_˛o£_c⁄√˘i⁄
(
c
);

57 
ß
 = 
c
->
loˇl_sockaddr
;

59 
ß
->
ß_Ámûy
) {

61 #i‡(
NGX_HAVE_INET6
)

62 
AF_INET6
:

63 
sö6
 = (
sockaddr_ö6
 *Ë
ß
;

65 
addr6
 = 
p‹t
->
addrs
;

69 
i
 = 0; i < 
p‹t
->
«ddrs
 - 1; i++) {

70 i‡(
	`ngx_memcmp
(&
addr6
[
i
].addr6, &
sö6
->
sö6_addr
, 16) == 0) {

75 
addr_c⁄f
 = &
addr6
[
i
].
c⁄f
;

80 
AF_UNIX
:

81 
unix_sockë
 = 1;

84 
sö
 = (
sockaddr_ö
 *Ë
ß
;

86 
addr
 = 
p‹t
->
addrs
;

90 
i
 = 0; i < 
p‹t
->
«ddrs
 - 1; i++) {

91 i‡(
addr
[
i
].add∏=
sö
->
sö_addr
.
s_addr
) {

96 
addr_c⁄f
 = &
addr
[
i
].
c⁄f
;

102 
c
->
loˇl_sockaddr
->
ß_Ámûy
) {

104 #i‡(
NGX_HAVE_INET6
)

105 
AF_INET6
:

106 
addr6
 = 
p‹t
->
addrs
;

107 
addr_c⁄f
 = &
addr6
[0].
c⁄f
;

111 
AF_UNIX
:

112 
unix_sockë
 = 1;

115 
addr
 = 
p‹t
->
addrs
;

116 
addr_c⁄f
 = &
addr
[0].
c⁄f
;

121 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
c
->
log
, 0, "*%ui client connected '%V'",

122 
c
->
numbî
, &c->
addr_ãxt
);

124 
s
 = 
	`ngx_πmp_öô_£ssi⁄
(
c
, 
addr_c⁄f
);

125 i‡(
s
 =
NULL
) {

132 
s
->
auto_pushed
 = 
unix_sockë
;

134 i‡(
addr_c⁄f
->
¥oxy_¥Ÿocﬁ
) {

135 
	`ngx_πmp_¥oxy_¥Ÿocﬁ
(
s
);

138 
	`ngx_πmp_h™dshake
(
s
);

140 
	}
}

143 
ngx_πmp_£ssi⁄_t
 *

144 
	$ngx_πmp_öô_£ssi⁄
(
ngx_c⁄√˘i⁄_t
 *
c
, 
ngx_πmp_addr_c⁄f_t
 *
addr_c⁄f
)

146 
ngx_πmp_£ssi⁄_t
 *
s
;

147 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

148 
ngx_πmp_îr‹_log_˘x_t
 *
˘x
;

150 
s
 = 
	`ngx_pˇŒoc
(
c
->
poﬁ
, (
ngx_πmp_£ssi⁄_t
) +

151 (
ngx_chaö_t
 *Ë* ((
ngx_πmp_c‹e_§v_c⁄f_t
 *)

152 
addr_c⁄f
->
˘x
-> 
§v_c⁄f
[
ngx_πmp_c‹e_moduÀ


153 .
˘x_ödex
])->
out_queue
);

154 i‡(
s
 =
NULL
) {

155 
	`ngx_πmp_˛o£_c⁄√˘i⁄
(
c
);

156  
NULL
;

159 
s
->
maö_c⁄f
 = 
addr_c⁄f
->
˘x
->main_conf;

160 
s
->
§v_c⁄f
 = 
addr_c⁄f
->
˘x
->srv_conf;

162 
s
->
addr_ãxt
 = &
addr_c⁄f
->addr_text;

164 
c
->
d©a
 = 
s
;

165 
s
->
c⁄√˘i⁄
 = 
c
;

167 
˘x
 = 
	`ngx_∑Œoc
(
c
->
poﬁ
, (
ngx_πmp_îr‹_log_˘x_t
));

168 i‡(
˘x
 =
NULL
) {

169 
	`ngx_πmp_˛o£_c⁄√˘i⁄
(
c
);

170  
NULL
;

173 
˘x
->
˛õ¡
 = &
c
->
addr_ãxt
;

174 
˘x
->
£ssi⁄
 = 
s
;

176 
c
->
log
->
c⁄√˘i⁄
 = c->
numbî
;

177 
c
->
log
->
h™dÀr
 = 
ngx_πmp_log_îr‹
;

178 
c
->
log
->
d©a
 = 
˘x
;

179 
c
->
log
->
a˘i⁄
 = 
NULL
;

181 
c
->
log_îr‹
 = 
NGX_ERROR_INFO
;

183 
s
->
˘x
 = 
	`ngx_pˇŒoc
(
c
->
poﬁ
, (*Ë* 
ngx_πmp_max_moduÀ
);

184 i‡(
s
->
˘x
 =
NULL
) {

185 
	`ngx_πmp_˛o£_c⁄√˘i⁄
(
c
);

186  
NULL
;

189 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

191 
s
->
out_queue
 = 
cscf
->out_queue;

192 
s
->
out_c‹k
 = 
cscf
->out_cork;

193 
s
->
ö_°ªams
 = 
	`ngx_pˇŒoc
(
c
->
poﬁ
, (
ngx_πmp_°ªam_t
)

194 * 
cscf
->
max_°ªams
);

195 i‡(
s
->
ö_°ªams
 =
NULL
) {

196 
	`ngx_πmp_˛o£_c⁄√˘i⁄
(
c
);

197  
NULL
;

200 #i‡(
ngöx_vîsi⁄
 >= 1007005)

201 
	`ngx_queue_öô
(&
s
->
po°ed_dry_evíts
);

204 
s
->
ïoch
 = 
ngx_cuºít_m£c
;

205 
s
->
timeout
 = 
cscf
->timeout;

206 
s
->
buÊí
 = 
cscf
->buflen;

207 
	`ngx_πmp_£t_chunk_size
(
s
, 
NGX_RTMP_DEFAULT_CHUNK_SIZE
);

210 i‡(
	`ngx_πmp_fúe_evít
(
s
, 
NGX_RTMP_CONNECT
, 
NULL
, NULLË!
NGX_OK
) {

211 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

212  
NULL
;

215  
s
;

216 
	}
}

219 
u_ch¨
 *

220 
	$ngx_πmp_log_îr‹
(
ngx_log_t
 *
log
, 
u_ch¨
 *
buf
, 
size_t
 
Àn
)

222 
u_ch¨
 *
p
;

223 
ngx_πmp_£ssi⁄_t
 *
s
;

224 
ngx_πmp_îr‹_log_˘x_t
 *
˘x
;

226 i‡(
log
->
a˘i⁄
) {

227 
p
 = 
	`ngx_¢¥ötf
(
buf
, 
Àn
, " whûê%s", 
log
->
a˘i⁄
);

228 
Àn
 -
p
 - 
buf
;

229 
buf
 = 
p
;

232 
˘x
 = 
log
->
d©a
;

234 
p
 = 
	`ngx_¢¥ötf
(
buf
, 
Àn
, ", clõ¡: %V", 
˘x
->
˛õ¡
);

235 
Àn
 -
p
 - 
buf
;

236 
buf
 = 
p
;

238 
s
 = 
˘x
->
£ssi⁄
;

240 i‡(
s
 =
NULL
) {

241  
p
;

244 
p
 = 
	`ngx_¢¥ötf
(
buf
, 
Àn
, ", sîvî: %V", 
s
->
addr_ãxt
);

245 
Àn
 -
p
 - 
buf
;

246 
buf
 = 
p
;

248  
p
;

249 
	}
}

253 
	$ngx_πmp_˛o£_c⁄√˘i⁄
(
ngx_c⁄√˘i⁄_t
 *
c
)

255 
ngx_poﬁ_t
 *
poﬁ
;

257 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
c
->
log
, 0, "close connection");

259 #i‡(
NGX_STAT_STUB
)

260 (Ë
	`ngx_©omic_„tch_add
(
ngx_°©_a˘ive
, -1);

263 
poﬁ
 = 
c
->pool;

264 
	`ngx_˛o£_c⁄√˘i⁄
(
c
);

265 
	`ngx_de°roy_poﬁ
(
poﬁ
);

266 
	}
}

270 
	$ngx_πmp_˛o£_£ssi⁄_h™dÀr
(
ngx_evít_t
 *
e
)

272 
ngx_πmp_£ssi⁄_t
 *
s
;

273 
ngx_c⁄√˘i⁄_t
 *
c
;

274 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

276 
s
 = 
e
->
d©a
;

277 
c
 = 
s
->
c⁄√˘i⁄
;

279 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

281 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
c
->
log
, 0, "close session");

283 
	`ngx_πmp_fúe_evít
(
s
, 
NGX_RTMP_DISCONNECT
, 
NULL
, NULL);

285 i‡(
s
->
pög_evt
.
timî_£t
) {

286 
	`ngx_dñ_timî
(&
s
->
pög_evt
);

289 i‡(
s
->
ö_ﬁd_poﬁ
) {

290 
	`ngx_de°roy_poﬁ
(
s
->
ö_ﬁd_poﬁ
);

293 i‡(
s
->
ö_poﬁ
) {

294 
	`ngx_de°roy_poﬁ
(
s
->
ö_poﬁ
);

297 
	`ngx_πmp_‰ì_h™dshake_buf„rs
(
s
);

299 
s
->
out_pos
 !s->
out_œ°
) {

300 
	`ngx_πmp_‰ì_sh¨ed_chaö
(
cscf
, 
s
->
out
[s->
out_pos
++]);

301 
s
->
out_pos
 %s->
out_queue
;

304 
	`ngx_πmp_˛o£_c⁄√˘i⁄
(
c
);

305 
	}
}

309 
	$ngx_πmp_föÆize_£ssi⁄
(
ngx_πmp_£ssi⁄_t
 *
s
)

311 
ngx_evít_t
 *
e
;

312 
ngx_c⁄√˘i⁄_t
 *
c
;

314 
c
 = 
s
->
c⁄√˘i⁄
;

315 i‡(
c
->
de°royed
) {

319 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
c
->
log
, 0, "finalize session");

321 
c
->
de°royed
 = 1;

322 
e
 = &
s
->
˛o£
;

323 
e
->
d©a
 = 
s
;

324 
e
->
h™dÀr
 = 
ngx_πmp_˛o£_£ssi⁄_h™dÀr
;

325 
e
->
log
 = 
c
->log;

327 
	`ngx_po°_evít
(
e
, &
ngx_po°ed_evíts
);

328 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_limit_module.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp.h
"

13 
ngx_öt_t
 
	mmax_c⁄n
;

14 
ngx_shm_z⁄e_t
 *
	mshm_z⁄e
;

15 } 
	tngx_πmp_limô_maö_c⁄f_t
;

18 
ngx_°r_t
 
	gshm_«me
 = 
ngx_°rög
("rtmp_limit");

21 
ngx_öt_t
 
ngx_πmp_limô_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
);

22 *
ngx_πmp_limô_¸óã_maö_c⁄f
(
ngx_c⁄f_t
 *
cf
);

25 
ngx_comm™d_t
 
	gngx_πmp_limô_comm™ds
[] = {

27 { 
ngx_°rög
("max_connections"),

28 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

29 
ngx_c⁄f_£t_num_¶Ÿ
,

30 
NGX_RTMP_MAIN_CONF_OFFSET
,

31 
off£tof
(
ngx_πmp_limô_maö_c⁄f_t
, 
max_c⁄n
),

32 
NULL
 },

34 
ngx_nuŒ_comm™d


38 
ngx_πmp_moduÀ_t
 
	gngx_πmp_limô_moduÀ_˘x
 = {

39 
NULL
,

40 
ngx_πmp_limô_po°c⁄figuøti⁄
,

41 
ngx_πmp_limô_¸óã_maö_c⁄f
,

42 
NULL
,

43 
NULL
,

44 
NULL
,

45 
NULL
,

46 
NULL


50 
ngx_moduÀ_t
 
	gngx_πmp_limô_moduÀ
 = {

51 
NGX_MODULE_V1
,

52 &
ngx_πmp_limô_moduÀ_˘x
,

53 
ngx_πmp_limô_comm™ds
,

54 
NGX_RTMP_MODULE
,

55 
NULL
,

56 
NULL
,

57 
NULL
,

58 
NULL
,

59 
NULL
,

60 
NULL
,

61 
NULL
,

62 
NGX_MODULE_V1_PADDING


67 
	$ngx_πmp_limô_¸óã_maö_c⁄f
(
ngx_c⁄f_t
 *
cf
)

69 
ngx_πmp_limô_maö_c⁄f_t
 *
lmcf
;

71 
lmcf
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_limô_maö_c⁄f_t
));

72 i‡(
lmcf
 =
NULL
) {

73  
NULL
;

76 
lmcf
->
max_c⁄n
 = 
NGX_CONF_UNSET
;

78  
lmcf
;

79 
	}
}

82 
ngx_öt_t


83 
	$ngx_πmp_limô_c⁄√˘
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

84 
ngx_chaö_t
 *
ö
)

86 
ngx_πmp_limô_maö_c⁄f_t
 *
lmcf
;

87 
ngx_¶ab_poﬁ_t
 *
shpoﬁ
;

88 
ngx_shm_z⁄e_t
 *
shm_z⁄e
;

89 
uöt32_t
 *
nc⁄n
, 
n
;

90 
ngx_öt_t
 
rc
;

92 
lmcf
 = 
	`ngx_πmp_gë_moduÀ_maö_c⁄f
(
s
, 
ngx_πmp_limô_moduÀ
);

93 i‡(
lmcf
->
max_c⁄n
 =
NGX_CONF_UNSET
) {

94  
NGX_OK
;

97 
shm_z⁄e
 = 
lmcf
->shm_zone;

98 
shpoﬁ
 = (
ngx_¶ab_poﬁ_t
 *Ë
shm_z⁄e
->
shm
.
addr
;

99 
nc⁄n
 = 
shm_z⁄e
->
d©a
;

101 
	`ngx_shmtx_lock
(&
shpoﬁ
->
muãx
);

102 
n
 = ++*
nc⁄n
;

103 
	`ngx_shmtx_u∆ock
(&
shpoﬁ
->
muãx
);

105 
rc
 = 
n
 > (
ngx_uöt_t
Ë
lmcf
->
max_c⁄n
 ? 
NGX_ERROR
 : 
NGX_OK
;

107 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

108 "limô: in¯c⁄e˘i⁄ cou¡î: %uD", 
n
);

110 i‡(
rc
 !
NGX_OK
) {

111 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

113 
n
, 
lmcf
->
max_c⁄n
);

116  
rc
;

117 
	}
}

120 
ngx_öt_t


121 
	$ngx_πmp_limô_disc⁄√˘
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

122 
ngx_chaö_t
 *
ö
)

124 
ngx_πmp_limô_maö_c⁄f_t
 *
lmcf
;

125 
ngx_¶ab_poﬁ_t
 *
shpoﬁ
;

126 
ngx_shm_z⁄e_t
 *
shm_z⁄e
;

127 
uöt32_t
 *
nc⁄n
, 
n
;

129 
lmcf
 = 
	`ngx_πmp_gë_moduÀ_maö_c⁄f
(
s
, 
ngx_πmp_limô_moduÀ
);

130 i‡(
lmcf
->
max_c⁄n
 =
NGX_CONF_UNSET
) {

131  
NGX_OK
;

134 
shm_z⁄e
 = 
lmcf
->shm_zone;

135 
shpoﬁ
 = (
ngx_¶ab_poﬁ_t
 *Ë
shm_z⁄e
->
shm
.
addr
;

136 
nc⁄n
 = 
shm_z⁄e
->
d©a
;

138 
	`ngx_shmtx_lock
(&
shpoﬁ
->
muãx
);

139 
n
 = --*
nc⁄n
;

140 
	`ngx_shmtx_u∆ock
(&
shpoﬁ
->
muãx
);

142 (Ë
n
;

143 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

144 "limô: de¯c⁄e˘i⁄ cou¡î: %uD", 
n
);

146  
NGX_OK
;

147 
	}
}

150 
ngx_öt_t


151 
	$ngx_πmp_limô_shm_öô
(
ngx_shm_z⁄e_t
 *
shm_z⁄e
, *
d©a
)

153 
ngx_¶ab_poﬁ_t
 *
shpoﬁ
;

154 
uöt32_t
 *
nc⁄n
;

156 i‡(
d©a
) {

157 
shm_z⁄e
->
d©a
 = data;

158  
NGX_OK
;

161 
shpoﬁ
 = (
ngx_¶ab_poﬁ_t
 *Ë
shm_z⁄e
->
shm
.
addr
;

163 
nc⁄n
 = 
	`ngx_¶ab_Æloc
(
shpoﬁ
, 4);

164 i‡(
nc⁄n
 =
NULL
) {

165  
NGX_ERROR
;

168 *
nc⁄n
 = 0;

170 
shm_z⁄e
->
d©a
 = 
nc⁄n
;

172  
NGX_OK
;

173 
	}
}

176 
ngx_öt_t


177 
	$ngx_πmp_limô_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
)

179 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
;

180 
ngx_πmp_limô_maö_c⁄f_t
 *
lmcf
;

181 
ngx_πmp_h™dÀr_±
 *
h
;

183 
cmcf
 = 
	`ngx_πmp_c⁄f_gë_moduÀ_maö_c⁄f
(
cf
, 
ngx_πmp_c‹e_moduÀ
);

185 
h
 = 
	`ngx_¨øy_push
(&
cmcf
->
evíts
[
NGX_RTMP_CONNECT
]);

186 *
h
 = 
ngx_πmp_limô_c⁄√˘
;

188 
h
 = 
	`ngx_¨øy_push
(&
cmcf
->
evíts
[
NGX_RTMP_DISCONNECT
]);

189 *
h
 = 
ngx_πmp_limô_disc⁄√˘
;

191 
lmcf
 = 
	`ngx_πmp_c⁄f_gë_moduÀ_maö_c⁄f
(
cf
, 
ngx_πmp_limô_moduÀ
);

192 i‡(
lmcf
->
max_c⁄n
 =
NGX_CONF_UNSET
) {

193  
NGX_OK
;

196 
lmcf
->
shm_z⁄e
 = 
	`ngx_sh¨ed_mem‹y_add
(
cf
, &
shm_«me
, 
ngx_∑gesize
 * 2,

197 &
ngx_πmp_limô_moduÀ
);

198 i‡(
lmcf
->
shm_z⁄e
 =
NULL
) {

199  
NGX_ERROR
;

202 
lmcf
->
shm_z⁄e
->
öô
 = 
ngx_πmp_limô_shm_öô
;

204  
NGX_OK
;

205 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_live_module.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp_live_moduÀ.h
"

10 
	~"ngx_πmp_cmd_moduÀ.h
"

11 
	~"ngx_πmp_codec_moduÀ.h
"

14 
ngx_πmp_publish_±
 
	g√xt_publish
;

15 
ngx_πmp_∂ay_±
 
	g√xt_∂ay
;

16 
ngx_πmp_˛o£_°ªam_±
 
	g√xt_˛o£_°ªam
;

17 
ngx_πmp_∑u£_±
 
	g√xt_∑u£
;

18 
ngx_πmp_°ªam_begö_±
 
	g√xt_°ªam_begö
;

19 
ngx_πmp_°ªam_eof_±
 
	g√xt_°ªam_eof
;

22 
ngx_öt_t
 
ngx_πmp_live_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
);

23 * 
ngx_πmp_live_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
);

24 * 
ngx_πmp_live_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
,

25 *
∑ª¡
, *
chûd
);

26 *
ngx_πmp_live_£t_m£c_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
,

27 *
c⁄f
);

28 
ngx_πmp_live_°¨t
(
ngx_πmp_£ssi⁄_t
 *
s
);

29 
ngx_πmp_live_°›
(
ngx_πmp_£ssi⁄_t
 *
s
);

32 
ngx_comm™d_t
 
	gngx_πmp_live_comm™ds
[] = {

34 { 
ngx_°rög
("live"),

35 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

36 
ngx_c⁄f_£t_Êag_¶Ÿ
,

37 
NGX_RTMP_APP_CONF_OFFSET
,

38 
off£tof
(
ngx_πmp_live_≠p_c⁄f_t
, 
live
),

39 
NULL
 },

41 { 
ngx_°rög
("stream_buckets"),

42 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

43 
ngx_c⁄f_£t_°r_¶Ÿ
,

44 
NGX_RTMP_APP_CONF_OFFSET
,

45 
off£tof
(
ngx_πmp_live_≠p_c⁄f_t
, 
nbuckës
),

46 
NULL
 },

48 { 
ngx_°rög
("buffer"),

49 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

50 
ngx_c⁄f_£t_m£c_¶Ÿ
,

51 
NGX_RTMP_APP_CONF_OFFSET
,

52 
off£tof
(
ngx_πmp_live_≠p_c⁄f_t
, 
buÊí
),

53 
NULL
 },

55 { 
ngx_°rög
("sync"),

56 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

57 
ngx_πmp_live_£t_m£c_¶Ÿ
,

58 
NGX_RTMP_APP_CONF_OFFSET
,

59 
off£tof
(
ngx_πmp_live_≠p_c⁄f_t
, 
sync
),

60 
NULL
 },

62 { 
ngx_°rög
("interleave"),

63 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

64 
ngx_c⁄f_£t_Êag_¶Ÿ
,

65 
NGX_RTMP_APP_CONF_OFFSET
,

66 
off£tof
(
ngx_πmp_live_≠p_c⁄f_t
, 
öãæóve
),

67 
NULL
 },

69 { 
ngx_°rög
("wait_key"),

70 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

71 
ngx_c⁄f_£t_Êag_¶Ÿ
,

72 
NGX_RTMP_APP_CONF_OFFSET
,

73 
off£tof
(
ngx_πmp_live_≠p_c⁄f_t
, 
waô_key
),

74 
NULL
 },

76 { 
ngx_°rög
("wait_video"),

77 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

78 
ngx_c⁄f_£t_Êag_¶Ÿ
,

79 
NGX_RTMP_APP_CONF_OFFSET
,

80 
off£tof
(
ngx_πmp_live_≠p_c⁄f_t
, 
waô_video
),

81 
NULL
 },

83 { 
ngx_°rög
("publish_notify"),

84 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

85 
ngx_c⁄f_£t_Êag_¶Ÿ
,

86 
NGX_RTMP_APP_CONF_OFFSET
,

87 
off£tof
(
ngx_πmp_live_≠p_c⁄f_t
, 
publish_nŸify
),

88 
NULL
 },

90 { 
ngx_°rög
("play_restart"),

91 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

92 
ngx_c⁄f_£t_Êag_¶Ÿ
,

93 
NGX_RTMP_APP_CONF_OFFSET
,

94 
off£tof
(
ngx_πmp_live_≠p_c⁄f_t
, 
∂ay_ª°¨t
),

95 
NULL
 },

97 { 
ngx_°rög
("idle_streams"),

98 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

99 
ngx_c⁄f_£t_Êag_¶Ÿ
,

100 
NGX_RTMP_APP_CONF_OFFSET
,

101 
off£tof
(
ngx_πmp_live_≠p_c⁄f_t
, 
idÀ_°ªams
),

102 
NULL
 },

104 { 
ngx_°rög
("drop_idle_publisher"),

105 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

106 
ngx_πmp_live_£t_m£c_¶Ÿ
,

107 
NGX_RTMP_APP_CONF_OFFSET
,

108 
off£tof
(
ngx_πmp_live_≠p_c⁄f_t
, 
idÀ_timeout
),

109 
NULL
 },

111 
ngx_nuŒ_comm™d


115 
ngx_πmp_moduÀ_t
 
	gngx_πmp_live_moduÀ_˘x
 = {

116 
NULL
,

117 
ngx_πmp_live_po°c⁄figuøti⁄
,

118 
NULL
,

119 
NULL
,

120 
NULL
,

121 
NULL
,

122 
ngx_πmp_live_¸óã_≠p_c⁄f
,

123 
ngx_πmp_live_mîge_≠p_c⁄f


127 
ngx_moduÀ_t
 
	gngx_πmp_live_moduÀ
 = {

128 
NGX_MODULE_V1
,

129 &
ngx_πmp_live_moduÀ_˘x
,

130 
ngx_πmp_live_comm™ds
,

131 
NGX_RTMP_MODULE
,

132 
NULL
,

133 
NULL
,

134 
NULL
,

135 
NULL
,

136 
NULL
,

137 
NULL
,

138 
NULL
,

139 
NGX_MODULE_V1_PADDING


144 
	$ngx_πmp_live_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
)

146 
ngx_πmp_live_≠p_c⁄f_t
 *
œcf
;

148 
œcf
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_live_≠p_c⁄f_t
));

149 i‡(
œcf
 =
NULL
) {

150  
NULL
;

153 
œcf
->
live
 = 
NGX_CONF_UNSET
;

154 
œcf
->
nbuckës
 = 
NGX_CONF_UNSET
;

155 
œcf
->
buÊí
 = 
NGX_CONF_UNSET_MSEC
;

156 
œcf
->
sync
 = 
NGX_CONF_UNSET_MSEC
;

157 
œcf
->
idÀ_timeout
 = 
NGX_CONF_UNSET_MSEC
;

158 
œcf
->
öãæóve
 = 
NGX_CONF_UNSET
;

159 
œcf
->
waô_key
 = 
NGX_CONF_UNSET
;

160 
œcf
->
waô_video
 = 
NGX_CONF_UNSET
;

161 
œcf
->
publish_nŸify
 = 
NGX_CONF_UNSET
;

162 
œcf
->
∂ay_ª°¨t
 = 
NGX_CONF_UNSET
;

163 
œcf
->
idÀ_°ªams
 = 
NGX_CONF_UNSET
;

165  
œcf
;

166 
	}
}

170 
	$ngx_πmp_live_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
∑ª¡
, *
chûd
)

172 
ngx_πmp_live_≠p_c⁄f_t
 *
¥ev
 = 
∑ª¡
;

173 
ngx_πmp_live_≠p_c⁄f_t
 *
c⁄f
 = 
chûd
;

175 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
live
, 
¥ev
->live, 0);

176 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
nbuckës
, 
¥ev
->nbuckets, 1024);

177 
	`ngx_c⁄f_mîge_m£c_vÆue
(
c⁄f
->
buÊí
, 
¥ev
->buflen, 0);

178 
	`ngx_c⁄f_mîge_m£c_vÆue
(
c⁄f
->
sync
, 
¥ev
->sync, 300);

179 
	`ngx_c⁄f_mîge_m£c_vÆue
(
c⁄f
->
idÀ_timeout
, 
¥ev
->idle_timeout, 0);

180 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
öãæóve
, 
¥ev
->interleave, 0);

181 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
waô_key
, 
¥ev
->wait_key, 1);

182 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
waô_video
, 
¥ev
->wait_video, 0);

183 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
publish_nŸify
, 
¥ev
->publish_notify, 0);

184 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
∂ay_ª°¨t
, 
¥ev
->play_restart, 0);

185 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
idÀ_°ªams
, 
¥ev
->idle_streams, 1);

187 
c⁄f
->
poﬁ
 = 
	`ngx_¸óã_poﬁ
(4096, &
cf
->
cy˛e
->
√w_log
);

188 i‡(
c⁄f
->
poﬁ
 =
NULL
) {

189  
NGX_CONF_ERROR
;

192 
c⁄f
->
°ªams
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
,

193 (
ngx_πmp_live_°ªam_t
 *Ë* 
c⁄f
->
nbuckës
);

195  
NGX_CONF_OK
;

196 
	}
}

200 
	$ngx_πmp_live_£t_m£c_¶Ÿ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

202 *
p
 = 
c⁄f
;

203 
ngx_°r_t
 *
vÆue
;

204 
ngx_m£c_t
 *
m•
;

206 
m•
 = (
ngx_m£c_t
 *Ë(
p
 + 
cmd
->
off£t
);

208 
vÆue
 = 
cf
->
¨gs
->
ñts
;

210 i‡(
vÆue
[1].
Àn
 == ("off") - 1 &&

211 
	`ngx_°∫ˇ£cmp
(
vÆue
[1].
d©a
, (
u_ch¨
 *Ë"off", vÆue[1].
Àn
) == 0)

213 *
m•
 = 0;

214  
NGX_CONF_OK
;

217  
	`ngx_c⁄f_£t_m£c_¶Ÿ
(
cf
, 
cmd
, 
c⁄f
);

218 
	}
}

221 
ngx_πmp_live_°ªam_t
 **

222 
	$ngx_πmp_live_gë_°ªam
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
«me
, 
¸óã
)

224 
ngx_πmp_live_≠p_c⁄f_t
 *
œcf
;

225 
ngx_πmp_live_°ªam_t
 **
°ªam
;

226 
size_t
 
Àn
;

228 
œcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_live_moduÀ
);

229 i‡(
œcf
 =
NULL
) {

230  
NULL
;

233 
Àn
 = 
	`ngx_°æí
(
«me
);

234 
°ªam
 = &
œcf
->
°ªams
[
	`ngx_hash_key
(
«me
, 
Àn
Ë%Üacf->
nbuckës
];

236 ; *
°ªam
; såóm = &(*°ªam)->
√xt
) {

237 i‡(
	`ngx_°rcmp
(
«me
, (*
°ªam
)->name) == 0) {

238  
°ªam
;

242 i‡(!
¸óã
) {

243  
NULL
;

246 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

247 "live: cª©ê°ªam '%s'", 
«me
);

249 i‡(
œcf
->
‰ì_°ªams
) {

250 *
°ªam
 = 
œcf
->
‰ì_°ªams
;

251 
œcf
->
‰ì_°ªams
 =Üacf->‰ì_°ªams->
√xt
;

253 *
°ªam
 = 
	`ngx_∑Œoc
(
œcf
->
poﬁ
, (
ngx_πmp_live_°ªam_t
));

255 
	`ngx_memzîo
(*
°ªam
, (
ngx_πmp_live_°ªam_t
));

256 
	`ngx_mem˝y
((*
°ªam
)->
«me
,Çame,

257 
	`ngx_mö
(((*
°ªam
)->
«me
Ë- 1, 
Àn
));

258 (*
°ªam
)->
ïoch
 = 
ngx_cuºít_m£c
;

260  
°ªam
;

261 
	}
}

265 
	$ngx_πmp_live_idÀ
(
ngx_evít_t
 *
≥v
)

267 
ngx_c⁄√˘i⁄_t
 *
c
;

268 
ngx_πmp_£ssi⁄_t
 *
s
;

270 
c
 = 
≥v
->
d©a
;

271 
s
 = 
c
->
d©a
;

273 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

276 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

277 
	}
}

281 
	$ngx_πmp_live_£t_°©us
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_chaö_t
 *
c⁄åﬁ
,

282 
ngx_chaö_t
 **
°©us
, 
size_t
 
n°©us
,

283 
a˘ive
)

285 
ngx_πmp_live_≠p_c⁄f_t
 *
œcf
;

286 
ngx_πmp_live_˘x_t
 *
˘x
, *
p˘x
;

287 
ngx_chaö_t
 **
˛
;

288 
ngx_evít_t
 *
e
;

289 
size_t
 
n
;

291 
œcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_live_moduÀ
);

293 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_live_moduÀ
);

295 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

296 "live: sëá˘ive=%ui", 
a˘ive
);

298 i‡(
˘x
->
a˘ive
 ==áctive) {

299 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

300 "live: unch™gedá˘ive=%ui", 
a˘ive
);

304 
˘x
->
a˘ive
 =áctive;

306 i‡(
˘x
->
publishög
) {

310 i‡(
œcf
->
idÀ_timeout
) {

311 
e
 = &
˘x
->
idÀ_evt
;

313 i‡(
a˘ive
 && !
˘x
->
idÀ_evt
.
timî_£t
) {

314 
e
->
d©a
 = 
s
->
c⁄√˘i⁄
;

315 
e
->
log
 = 
s
->
c⁄√˘i⁄
->log;

316 
e
->
h™dÀr
 = 
ngx_πmp_live_idÀ
;

318 
	`ngx_add_timî
(
e
, 
œcf
->
idÀ_timeout
);

320 } i‡(!
a˘ive
 && 
˘x
->
idÀ_evt
.
timî_£t
) {

321 
	`ngx_dñ_timî
(
e
);

325 
˘x
->
°ªam
->
a˘ive
 =áctive;

327 
p˘x
 = 
˘x
->
°ªam
->˘x;Ö˘x;Ö˘x =Ö˘x->
√xt
) {

328 i‡(
p˘x
->
publishög
 == 0) {

329 
	`ngx_πmp_live_£t_°©us
(
p˘x
->
£ssi⁄
, 
c⁄åﬁ
, 
°©us
,

330 
n°©us
, 
a˘ive
);

339 i‡(
c⁄åﬁ
 && 
	`ngx_πmp_£nd_mesßge
(
s
, c⁄åﬁ, 0Ë!
NGX_OK
) {

340 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

344 i‡(!
˘x
->
sûít
) {

345 
˛
 = 
°©us
;

347 
n
 = 0;Ç < 
n°©us
; ++n, ++
˛
) {

348 i‡(*
˛
 && 
	`ngx_πmp_£nd_mesßge
(
s
, *˛, 0Ë!
NGX_OK
) {

349 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

355 
˘x
->
cs
[0].
a˘ive
 = 0;

356 
˘x
->
cs
[0].
dr›≥d
 = 0;

358 
˘x
->
cs
[1].
a˘ive
 = 0;

359 
˘x
->
cs
[1].
dr›≥d
 = 0;

360 
	}
}

364 
	$ngx_πmp_live_°¨t
(
ngx_πmp_£ssi⁄_t
 *
s
)

366 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

367 
ngx_πmp_live_≠p_c⁄f_t
 *
œcf
;

368 
ngx_chaö_t
 *
c⁄åﬁ
;

369 
ngx_chaö_t
 *
°©us
[3];

370 
size_t
 
n
, 
n°©us
;

372 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

374 
œcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_live_moduÀ
);

376 
c⁄åﬁ
 = 
	`ngx_πmp_¸óã_°ªam_begö
(
s
, 
NGX_RTMP_MSID
);

378 
n°©us
 = 0;

380 i‡(
œcf
->
∂ay_ª°¨t
) {

381 
°©us
[
n°©us
++] = 
	`ngx_πmp_¸óã_°©us
(
s
, "NetStream.Play.Start",

383 
°©us
[
n°©us
++] = 
	`ngx_πmp_¸óã_ßm∂e_ac˚ss
(
s
);

386 i‡(
œcf
->
publish_nŸify
) {

387 
°©us
[
n°©us
++] = 
	`ngx_πmp_¸óã_°©us
(
s
,

392 
	`ngx_πmp_live_£t_°©us
(
s
, 
c⁄åﬁ
, 
°©us
, 
n°©us
, 1);

394 i‡(
c⁄åﬁ
) {

395 
	`ngx_πmp_‰ì_sh¨ed_chaö
(
cscf
, 
c⁄åﬁ
);

398 
n
 = 0;Ç < 
n°©us
; ++n) {

399 
	`ngx_πmp_‰ì_sh¨ed_chaö
(
cscf
, 
°©us
[
n
]);

401 
	}
}

405 
	$ngx_πmp_live_°›
(
ngx_πmp_£ssi⁄_t
 *
s
)

407 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

408 
ngx_πmp_live_≠p_c⁄f_t
 *
œcf
;

409 
ngx_chaö_t
 *
c⁄åﬁ
;

410 
ngx_chaö_t
 *
°©us
[3];

411 
size_t
 
n
, 
n°©us
;

413 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

415 
œcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_live_moduÀ
);

417 
c⁄åﬁ
 = 
	`ngx_πmp_¸óã_°ªam_eof
(
s
, 
NGX_RTMP_MSID
);

419 
n°©us
 = 0;

421 i‡(
œcf
->
∂ay_ª°¨t
) {

422 
°©us
[
n°©us
++] = 
	`ngx_πmp_¸óã_°©us
(
s
, "NetStream.Play.Stop",

426 i‡(
œcf
->
publish_nŸify
) {

427 
°©us
[
n°©us
++] = 
	`ngx_πmp_¸óã_°©us
(
s
,

432 
	`ngx_πmp_live_£t_°©us
(
s
, 
c⁄åﬁ
, 
°©us
, 
n°©us
, 0);

434 i‡(
c⁄åﬁ
) {

435 
	`ngx_πmp_‰ì_sh¨ed_chaö
(
cscf
, 
c⁄åﬁ
);

438 
n
 = 0;Ç < 
n°©us
; ++n) {

439 
	`ngx_πmp_‰ì_sh¨ed_chaö
(
cscf
, 
°©us
[
n
]);

441 
	}
}

444 
ngx_öt_t


445 
	$ngx_πmp_live_°ªam_begö
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_°ªam_begö_t
 *
v
)

447 
ngx_πmp_live_˘x_t
 *
˘x
;

449 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_live_moduÀ
);

451 i‡(
˘x
 =
NULL
 || ctx->
°ªam
 =NULL || !˘x->
publishög
) {

452 
√xt
;

455 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

458 
	`ngx_πmp_live_°¨t
(
s
);

460 
√xt
:

461  
	`√xt_°ªam_begö
(
s
, 
v
);

462 
	}
}

465 
ngx_öt_t


466 
	$ngx_πmp_live_°ªam_eof
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_°ªam_eof_t
 *
v
)

468 
ngx_πmp_live_˘x_t
 *
˘x
;

470 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_live_moduÀ
);

472 i‡(
˘x
 =
NULL
 || ctx->
°ªam
 =NULL || !˘x->
publishög
) {

473 
√xt
;

476 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

479 
	`ngx_πmp_live_°›
(
s
);

481 
√xt
:

482  
	`√xt_°ªam_eof
(
s
, 
v
);

483 
	}
}

487 
	$ngx_πmp_live_joö
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
«me
, 
publishî
)

489 
ngx_πmp_live_˘x_t
 *
˘x
;

490 
ngx_πmp_live_°ªam_t
 **
°ªam
;

491 
ngx_πmp_live_≠p_c⁄f_t
 *
œcf
;

493 
œcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_live_moduÀ
);

494 i‡(
œcf
 =
NULL
) {

498 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_live_moduÀ
);

499 i‡(
˘x
 && ctx->
°ªam
) {

500 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

505 i‡(
˘x
 =
NULL
) {

506 
˘x
 = 
	`ngx_∑Œoc
(
s
->
c⁄√˘i⁄
->
poﬁ
, (
ngx_πmp_live_˘x_t
));

507 
	`ngx_πmp_£t_˘x
(
s
, 
˘x
, 
ngx_πmp_live_moduÀ
);

510 
	`ngx_memzîo
(
˘x
, (*ctx));

512 
˘x
->
£ssi⁄
 = 
s
;

514 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

515 "live: joö '%s'", 
«me
);

517 
°ªam
 = 
	`ngx_πmp_live_gë_°ªam
(
s
, 
«me
, 
publishî
 || 
œcf
->
idÀ_°ªams
);

519 i‡(
°ªam
 =
NULL
 ||

520 !(
publishî
 || (*
°ªam
)->
publishög
 || 
œcf
->
idÀ_°ªams
))

522 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

525 
	`ngx_πmp_£nd_°©us
(
s
, "NetStream.Play.StreamNotFound", "error",

528 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

533 i‡(
publishî
) {

534 i‡((*
°ªam
)->
publishög
) {

535 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

538 
	`ngx_πmp_£nd_°©us
(
s
, "NetStream.Publish.BadName", "error",

544 (*
°ªam
)->
publishög
 = 1;

547 
˘x
->
°ªam
 = *stream;

548 
˘x
->
publishög
 = 
publishî
;

549 
˘x
->
√xt
 = (*
°ªam
)->ctx;

551 (*
°ªam
)->
˘x
 = ctx;

553 i‡(
œcf
->
buÊí
) {

554 
s
->
out_buf„r
 = 1;

557 
˘x
->
cs
[0].
csid
 = 
NGX_RTMP_CSID_VIDEO
;

558 
˘x
->
cs
[1].
csid
 = 
NGX_RTMP_CSID_AUDIO
;

560 i‡(!
˘x
->
publishög
 && ctx->
°ªam
->
a˘ive
) {

561 
	`ngx_πmp_live_°¨t
(
s
);

563 
	}
}

566 
ngx_öt_t


567 
	$ngx_πmp_live_˛o£_°ªam
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_˛o£_°ªam_t
 *
v
)

569 
ngx_πmp_£ssi⁄_t
 *
ss
;

570 
ngx_πmp_live_˘x_t
 *
˘x
, **
c˘x
, *
p˘x
;

571 
ngx_πmp_live_°ªam_t
 **
°ªam
;

572 
ngx_πmp_live_≠p_c⁄f_t
 *
œcf
;

574 
œcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_live_moduÀ
);

575 i‡(
œcf
 =
NULL
) {

576 
√xt
;

579 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_live_moduÀ
);

580 i‡(
˘x
 =
NULL
) {

581 
√xt
;

584 i‡(
˘x
->
°ªam
 =
NULL
) {

585 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

587 
√xt
;

590 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

591 "live:Üóvê'%s'", 
˘x
->
°ªam
->
«me
);

593 i‡(
˘x
->
°ªam
->
publishög
 && ctx->publishing) {

594 
˘x
->
°ªam
->
publishög
 = 0;

597 
c˘x
 = &
˘x
->
°ªam
->˘x; *c˘x; c˘x = &(*c˘x)->
√xt
) {

598 i‡(*
c˘x
 =
˘x
) {

599 *
c˘x
 = 
˘x
->
√xt
;

604 i‡(
˘x
->
publishög
 || ctx->
°ªam
->
a˘ive
) {

605 
	`ngx_πmp_live_°›
(
s
);

608 i‡(
˘x
->
publishög
) {

609 
	`ngx_πmp_£nd_°©us
(
s
, "NetStream.Unpublish.Success",

611 i‡(!
œcf
->
idÀ_°ªams
) {

612 
p˘x
 = 
˘x
->
°ªam
->˘x;Ö˘x;Ö˘x =Ö˘x->
√xt
) {

613 i‡(
p˘x
->
publishög
 == 0) {

614 
ss
 = 
p˘x
->
£ssi⁄
;

615 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
ss
->
c⁄√˘i⁄
->
log
, 0,

617 
	`ngx_πmp_föÆize_£ssi⁄
(
ss
);

623 i‡(
˘x
->
°ªam
->ctx) {

624 
˘x
->
°ªam
 = 
NULL
;

625 
√xt
;

628 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

630 
˘x
->
°ªam
->
«me
);

632 
°ªam
 = 
	`ngx_πmp_live_gë_°ªam
(
s
, 
˘x
->°ªam->
«me
, 0);

633 i‡(
°ªam
 =
NULL
) {

634 
√xt
;

636 *
°ªam
 = (*°ªam)->
√xt
;

638 
˘x
->
°ªam
->
√xt
 = 
œcf
->
‰ì_°ªams
;

639 
œcf
->
‰ì_°ªams
 = 
˘x
->
°ªam
;

640 
˘x
->
°ªam
 = 
NULL
;

642 i‡(!
˘x
->
sûít
 && !˘x->
publishög
 && !
œcf
->
∂ay_ª°¨t
) {

643 
	`ngx_πmp_£nd_°©us
(
s
, "NetStream.Play.Stop", "status", "StopÜive");

646 
√xt
:

647  
	`√xt_˛o£_°ªam
(
s
, 
v
);

648 
	}
}

651 
ngx_öt_t


652 
	$ngx_πmp_live_∑u£
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_∑u£_t
 *
v
)

654 
ngx_πmp_live_˘x_t
 *
˘x
;

656 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_live_moduÀ
);

658 i‡(
˘x
 =
NULL
 || ctx->
°ªam
 == NULL) {

659 
√xt
;

662 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

664 (
ngx_öt_t
Ë
v
->
∑u£
, v->
posôi⁄
);

666 i‡(
v
->
∑u£
) {

667 i‡(
	`ngx_πmp_£nd_°©us
(
s
, "NetStream.Pause.Notify", "status",

669 !
NGX_OK
)

671  
NGX_ERROR
;

674 
˘x
->
∑u£d
 = 1;

676 
	`ngx_πmp_live_°›
(
s
);

679 i‡(
	`ngx_πmp_£nd_°©us
(
s
, "NetStream.Unpause.Notify", "status",

681 !
NGX_OK
)

683  
NGX_ERROR
;

686 
˘x
->
∑u£d
 = 0;

688 
	`ngx_πmp_live_°¨t
(
s
);

691 
√xt
:

692  
	`√xt_∑u£
(
s
, 
v
);

693 
	}
}

695 
ngx_öt_t


696 
	$ngx_πmp_live_av
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

697 
ngx_chaö_t
 *
ö
)

699 
ngx_πmp_live_˘x_t
 *
˘x
, *
p˘x
;

700 
ngx_πmp_codec_˘x_t
 *
codec_˘x
;

701 
ngx_chaö_t
 *
hódî
, *
cohódî
, *
mëa
,

702 *
≠kt
, *
Øpkt
, *
ac›kt
, *
Ωkt
;

703 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

704 
ngx_πmp_live_≠p_c⁄f_t
 *
œcf
;

705 
ngx_πmp_£ssi⁄_t
 *
ss
;

706 
ngx_πmp_hódî_t
 
ch
, 
lh
, 
˛h
;

707 
ngx_öt_t
 
rc
, 
m™d©‹y
, 
dummy_audio
;

708 
ngx_uöt_t
 
¥io
;

709 
ngx_uöt_t
 
≥îs
;

710 
ngx_uöt_t
 
mëa_vîsi⁄
;

711 
ngx_uöt_t
 
csidx
;

712 
uöt32_t
 
dñè
;

713 
ngx_πmp_live_chunk_°ªam_t
 *
cs
;

714 #ifde‡
NGX_DEBUG


715 c⁄° *
ty≥_s
;

717 
ty≥_s
 = (
h
->
ty≥
 =
NGX_RTMP_MSG_VIDEO
 ? "video" : "audio");

720 
œcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_live_moduÀ
);

721 i‡(
œcf
 =
NULL
) {

722  
NGX_ERROR
;

725 i‡(!
œcf
->
live
 || 
ö
 =
NULL
 || in->
buf
 == NULL) {

726  
NGX_OK
;

729 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_live_moduÀ
);

730 i‡(
˘x
 =
NULL
 || ctx->
°ªam
 == NULL) {

731  
NGX_OK
;

734 i‡(
˘x
->
publishög
 == 0) {

735 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

736 "live: %†‰omÇ⁄-publishî", 
ty≥_s
);

737  
NGX_OK
;

740 i‡(!
˘x
->
°ªam
->
a˘ive
) {

741 
	`ngx_πmp_live_°¨t
(
s
);

744 i‡(
˘x
->
idÀ_evt
.
timî_£t
) {

745 
	`ngx_add_timî
(&
˘x
->
idÀ_evt
, 
œcf
->
idÀ_timeout
);

748 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

750 
ty≥_s
, 
h
->
time°amp
);

752 
s
->
cuºít_time
 = 
h
->
time°amp
;

754 
≥îs
 = 0;

755 
≠kt
 = 
NULL
;

756 
Øpkt
 = 
NULL
;

757 
ac›kt
 = 
NULL
;

758 
hódî
 = 
NULL
;

759 
cohódî
 = 
NULL
;

760 
mëa
 = 
NULL
;

761 
mëa_vîsi⁄
 = 0;

762 
m™d©‹y
 = 0;

764 
¥io
 = (
h
->
ty≥
 =
NGX_RTMP_MSG_VIDEO
 ?

765 
	`ngx_πmp_gë_video_‰ame_ty≥
(
ö
) : 0);

767 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

769 
csidx
 = !(
œcf
->
öãæóve
 || 
h
->
ty≥
 =
NGX_RTMP_MSG_VIDEO
);

771 
cs
 = &
˘x
->cs[
csidx
];

773 
	`ngx_memzîo
(&
ch
, (ch));

775 
ch
.
time°amp
 = 
h
->timestamp;

776 
ch
.
msid
 = 
NGX_RTMP_MSID
;

777 
ch
.
csid
 = 
cs
->csid;

778 
ch
.
ty≥
 = 
h
->type;

780 
lh
 = 
ch
;

782 i‡(
cs
->
a˘ive
) {

783 
lh
.
time°amp
 = 
cs
->timestamp;

786 
˛h
 = 
lh
;

787 
˛h
.
ty≥
 = (
h
->ty≥ =
NGX_RTMP_MSG_AUDIO
 ? 
NGX_RTMP_MSG_VIDEO
 :

788 
NGX_RTMP_MSG_AUDIO
);

790 
cs
->
a˘ive
 = 1;

791 
cs
->
time°amp
 = 
ch
.timestamp;

793 
dñè
 = 
ch
.
time°amp
 - 
lh
.timestamp;

805 
Ωkt
 = 
	`ngx_πmp_≠≥nd_sh¨ed_bufs
(
cscf
, 
NULL
, 
ö
);

807 
	`ngx_πmp_¥ï¨e_mesßge
(
s
, &
ch
, &
lh
, 
Ωkt
);

809 
codec_˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

811 i‡(
codec_˘x
) {

813 i‡(
h
->
ty≥
 =
NGX_RTMP_MSG_AUDIO
) {

814 
hódî
 = 
codec_˘x
->
Øc_hódî
;

816 i‡(
œcf
->
öãæóve
) {

817 
cohódî
 = 
codec_˘x
->
avc_hódî
;

820 i‡(
codec_˘x
->
audio_codec_id
 =
NGX_RTMP_AUDIO_AAC
 &&

821 
	`ngx_πmp_is_codec_hódî
(
ö
))

823 
¥io
 = 0;

824 
m™d©‹y
 = 1;

828 
hódî
 = 
codec_˘x
->
avc_hódî
;

830 i‡(
œcf
->
öãæóve
) {

831 
cohódî
 = 
codec_˘x
->
Øc_hódî
;

834 i‡(
codec_˘x
->
video_codec_id
 =
NGX_RTMP_VIDEO_H264
 &&

835 
	`ngx_πmp_is_codec_hódî
(
ö
))

837 
¥io
 = 0;

838 
m™d©‹y
 = 1;

842 i‡(
codec_˘x
->
mëa
) {

843 
mëa
 = 
codec_˘x
->meta;

844 
mëa_vîsi⁄
 = 
codec_˘x
->meta_version;

850 
p˘x
 = 
˘x
->
°ªam
->˘x;Ö˘x;Ö˘x =Ö˘x->
√xt
) {

851 i‡(
p˘x
 =
˘x
 ||Ö˘x->
∑u£d
) {

855 
ss
 = 
p˘x
->
£ssi⁄
;

856 
cs
 = &
p˘x
->cs[
csidx
];

860 i‡(
mëa
 && 
mëa_vîsi⁄
 !
p˘x
->meta_version) {

861 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
ss
->
c⁄√˘i⁄
->
log
, 0,

864 i‡(
	`ngx_πmp_£nd_mesßge
(
ss
, 
mëa
, 0Ë=
NGX_OK
) {

865 
p˘x
->
mëa_vîsi⁄
 = meta_version;

871 i‡(
cs
->
a˘ive
 && (
œcf
->
sync
 && cs->
dr›≥d
 >Üacf->sync)) {

872 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
ss
->
c⁄√˘i⁄
->
log
, 0,

873 "live: syn¯%†dr›≥d=%uD", 
ty≥_s
, 
cs
->
dr›≥d
);

875 
cs
->
a˘ive
 = 0;

876 
cs
->
dr›≥d
 = 0;

881 i‡(!
cs
->
a˘ive
) {

883 i‡(
m™d©‹y
) {

884 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
ss
->
c⁄√˘i⁄
->
log
, 0,

889 i‡(
œcf
->
waô_video
 && 
h
->
ty≥
 =
NGX_RTMP_MSG_AUDIO
 &&

890 !
p˘x
->
cs
[0].
a˘ive
)

892 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
ss
->
c⁄√˘i⁄
->
log
, 0,

897 i‡(
œcf
->
waô_key
 && 
¥io
 !
NGX_RTMP_VIDEO_KEY_FRAME
 &&

898 (
œcf
->
öãæóve
 || 
h
->
ty≥
 =
NGX_RTMP_MSG_VIDEO
))

900 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
ss
->
c⁄√˘i⁄
->
log
, 0,

905 
dummy_audio
 = 0;

906 i‡(
œcf
->
waô_video
 && 
h
->
ty≥
 =
NGX_RTMP_MSG_VIDEO
 &&

907 !
p˘x
->
cs
[1].
a˘ive
)

909 
dummy_audio
 = 1;

910 i‡(
Øpkt
 =
NULL
) {

911 
Øpkt
 = 
	`ngx_πmp_Æloc_sh¨ed_buf
(
cscf
);

912 
	`ngx_πmp_¥ï¨e_mesßge
(
s
, &
˛h
, 
NULL
, 
Øpkt
);

916 i‡(
hódî
 || 
cohódî
) {

920 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
ss
->
c⁄√˘i⁄
->
log
, 0,

922 
ty≥_s
, 
lh
.
time°amp
);

924 i‡(
hódî
) {

925 i‡(
≠kt
 =
NULL
) {

926 
≠kt
 = 
	`ngx_πmp_≠≥nd_sh¨ed_bufs
(
cscf
, 
NULL
, 
hódî
);

927 
	`ngx_πmp_¥ï¨e_mesßge
(
s
, &
lh
, 
NULL
, 
≠kt
);

930 
rc
 = 
	`ngx_πmp_£nd_mesßge
(
ss
, 
≠kt
, 0);

931 i‡(
rc
 !
NGX_OK
) {

936 i‡(
cohódî
) {

937 i‡(
ac›kt
 =
NULL
) {

938 
ac›kt
 = 
	`ngx_πmp_≠≥nd_sh¨ed_bufs
(
cscf
, 
NULL
, 
cohódî
);

939 
	`ngx_πmp_¥ï¨e_mesßge
(
s
, &
˛h
, 
NULL
, 
ac›kt
);

942 
rc
 = 
	`ngx_πmp_£nd_mesßge
(
ss
, 
ac›kt
, 0);

943 i‡(
rc
 !
NGX_OK
) {

947 } i‡(
dummy_audio
) {

948 
	`ngx_πmp_£nd_mesßge
(
ss
, 
Øpkt
, 0);

951 
cs
->
time°amp
 = 
lh
.timestamp;

952 
cs
->
a˘ive
 = 1;

953 
ss
->
cuºít_time
 = 
cs
->
time°amp
;

959 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
ss
->
c⁄√˘i⁄
->
log
, 0,

961 
ty≥_s
, 
ch
.
time°amp
);

963 i‡(
≠kt
 =
NULL
) {

964 
≠kt
 = 
	`ngx_πmp_≠≥nd_sh¨ed_bufs
(
cscf
, 
NULL
, 
ö
);

965 
	`ngx_πmp_¥ï¨e_mesßge
(
s
, &
ch
, 
NULL
, 
≠kt
);

968 
rc
 = 
	`ngx_πmp_£nd_mesßge
(
ss
, 
≠kt
, 
¥io
);

969 i‡(
rc
 !
NGX_OK
) {

973 
cs
->
time°amp
 = 
ch
.timestamp;

974 
cs
->
a˘ive
 = 1;

975 
ss
->
cuºít_time
 = 
cs
->
time°amp
;

977 ++
≥îs
;

979 i‡(
dummy_audio
) {

980 
	`ngx_πmp_£nd_mesßge
(
ss
, 
Øpkt
, 0);

989 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
ss
->
c⁄√˘i⁄
->
log
, 0,

991 
ty≥_s
, 
dñè
);

993 i‡(
	`ngx_πmp_£nd_mesßge
(
ss
, 
Ωkt
, 
¥io
Ë!
NGX_OK
) {

994 ++
p˘x
->
ndr›≥d
;

996 
cs
->
dr›≥d
 +
dñè
;

998 i‡(
m™d©‹y
) {

999 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
ss
->
c⁄√˘i⁄
->
log
, 0,

1001 
	`ngx_πmp_föÆize_£ssi⁄
(
ss
);

1007 
cs
->
time°amp
 +
dñè
;

1008 ++
≥îs
;

1009 
ss
->
cuºít_time
 = 
cs
->
time°amp
;

1012 i‡(
Ωkt
) {

1013 
	`ngx_πmp_‰ì_sh¨ed_chaö
(
cscf
, 
Ωkt
);

1016 i‡(
≠kt
) {

1017 
	`ngx_πmp_‰ì_sh¨ed_chaö
(
cscf
, 
≠kt
);

1020 i‡(
Øpkt
) {

1021 
	`ngx_πmp_‰ì_sh¨ed_chaö
(
cscf
, 
Øpkt
);

1024 i‡(
ac›kt
) {

1025 
	`ngx_πmp_‰ì_sh¨ed_chaö
(
cscf
, 
ac›kt
);

1028 
	`ngx_πmp_upd©e_b™dwidth
(&
˘x
->
°ªam
->
bw_ö
, 
h
->
mÀn
);

1029 
	`ngx_πmp_upd©e_b™dwidth
(&
˘x
->
°ªam
->
bw_out
, 
h
->
mÀn
 * 
≥îs
);

1031 
	`ngx_πmp_upd©e_b™dwidth
(
h
->
ty≥
 =
NGX_RTMP_MSG_AUDIO
 ?

1032 &
˘x
->
°ªam
->
bw_ö_audio
 :

1033 &
˘x
->
°ªam
->
bw_ö_video
,

1034 
h
->
mÀn
);

1036  
NGX_OK
;

1037 
	}
}

1040 
ngx_öt_t


1041 
	$ngx_πmp_live_publish
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_publish_t
 *
v
)

1043 
ngx_πmp_live_≠p_c⁄f_t
 *
œcf
;

1044 
ngx_πmp_live_˘x_t
 *
˘x
;

1046 
œcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_live_moduÀ
);

1048 i‡(
œcf
 =
NULL
 || !œcf->
live
) {

1049 
√xt
;

1052 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1054 
v
->
«me
, v->
ty≥
);

1058 
	`ngx_πmp_live_joö
(
s
, 
v
->
«me
, 1);

1060 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_live_moduÀ
);

1061 i‡(
˘x
 =
NULL
 || !˘x->
publishög
) {

1062 
√xt
;

1065 
˘x
->
sûít
 = 
v
->silent;

1067 i‡(!
˘x
->
sûít
) {

1068 
	`ngx_πmp_£nd_°©us
(
s
, "NetStream.Publish.Start",

1072 
√xt
:

1073  
	`√xt_publish
(
s
, 
v
);

1074 
	}
}

1077 
ngx_öt_t


1078 
	$ngx_πmp_live_∂ay
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_∂ay_t
 *
v
)

1080 
ngx_πmp_live_≠p_c⁄f_t
 *
œcf
;

1081 
ngx_πmp_live_˘x_t
 *
˘x
;

1083 
œcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_live_moduÀ
);

1085 i‡(
œcf
 =
NULL
 || !œcf->
live
) {

1086 
√xt
;

1089 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1091 
v
->
«me
, (
uöt32_t
Ëv->
°¨t
,

1092 (
uöt32_t
Ë
v
->
duøti⁄
, (uöt32_tËv->
ª£t
);

1096 
	`ngx_πmp_live_joö
(
s
, 
v
->
«me
, 0);

1098 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_live_moduÀ
);

1099 i‡(
˘x
 =
NULL
) {

1100 
√xt
;

1103 
˘x
->
sûít
 = 
v
->silent;

1105 i‡(!
˘x
->
sûít
 && !
œcf
->
∂ay_ª°¨t
) {

1106 
	`ngx_πmp_£nd_°©us
(
s
, "NetStream.Play.Start",

1108 
	`ngx_πmp_£nd_ßm∂e_ac˚ss
(
s
);

1111 
√xt
:

1112  
	`√xt_∂ay
(
s
, 
v
);

1113 
	}
}

1116 
ngx_öt_t


1117 
	$ngx_πmp_live_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
)

1119 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
;

1120 
ngx_πmp_h™dÀr_±
 *
h
;

1122 
cmcf
 = 
	`ngx_πmp_c⁄f_gë_moduÀ_maö_c⁄f
(
cf
, 
ngx_πmp_c‹e_moduÀ
);

1126 
h
 = 
	`ngx_¨øy_push
(&
cmcf
->
evíts
[
NGX_RTMP_MSG_AUDIO
]);

1127 *
h
 = 
ngx_πmp_live_av
;

1129 
h
 = 
	`ngx_¨øy_push
(&
cmcf
->
evíts
[
NGX_RTMP_MSG_VIDEO
]);

1130 *
h
 = 
ngx_πmp_live_av
;

1134 
√xt_publish
 = 
ngx_πmp_publish
;

1135 
ngx_πmp_publish
 = 
ngx_πmp_live_publish
;

1137 
√xt_∂ay
 = 
ngx_πmp_∂ay
;

1138 
ngx_πmp_∂ay
 = 
ngx_πmp_live_∂ay
;

1140 
√xt_˛o£_°ªam
 = 
ngx_πmp_˛o£_°ªam
;

1141 
ngx_πmp_˛o£_°ªam
 = 
ngx_πmp_live_˛o£_°ªam
;

1143 
√xt_∑u£
 = 
ngx_πmp_∑u£
;

1144 
ngx_πmp_∑u£
 = 
ngx_πmp_live_∑u£
;

1146 
√xt_°ªam_begö
 = 
ngx_πmp_°ªam_begö
;

1147 
ngx_πmp_°ªam_begö
 = 
ngx_πmp_live_°ªam_begö
;

1149 
√xt_°ªam_eof
 = 
ngx_πmp_°ªam_eof
;

1150 
ngx_πmp_°ªam_eof
 = 
ngx_πmp_live_°ªam_eof
;

1152  
NGX_OK
;

1153 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_live_module.h

7 #i‚de‡
_NGX_RTMP_LIVE_H_INCLUDED_


8 
	#_NGX_RTMP_LIVE_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

13 
	~"ngx_πmp.h
"

14 
	~"ngx_πmp_cmd_moduÀ.h
"

15 
	~"ngx_πmp_b™dwidth.h
"

16 
	~"ngx_πmp_°ªams.h
"

19 
ngx_πmp_live_˘x_s
 
	tngx_πmp_live_˘x_t
;

20 
ngx_πmp_live_°ªam_s
 
	tngx_πmp_live_°ªam_t
;

24 
	ma˘ive
:1;

25 
uöt32_t
 
	mtime°amp
;

26 
uöt32_t
 
	mcsid
;

27 
uöt32_t
 
	mdr›≥d
;

28 } 
	tngx_πmp_live_chunk_°ªam_t
;

31 
	sngx_πmp_live_˘x_s
 {

32 
ngx_πmp_£ssi⁄_t
 *
	m£ssi⁄
;

33 
ngx_πmp_live_°ªam_t
 *
	m°ªam
;

34 
ngx_πmp_live_˘x_t
 *
	m√xt
;

35 
ngx_uöt_t
 
	mndr›≥d
;

36 
ngx_πmp_live_chunk_°ªam_t
 
	mcs
[2];

37 
ngx_uöt_t
 
	mmëa_vîsi⁄
;

38 
ngx_evít_t
 
	midÀ_evt
;

39 
	ma˘ive
:1;

40 
	mpublishög
:1;

41 
	msûít
:1;

42 
	m∑u£d
:1;

46 
	sngx_πmp_live_°ªam_s
 {

47 
u_ch¨
 
	m«me
[
NGX_RTMP_MAX_NAME
];

48 
ngx_πmp_live_°ªam_t
 *
	m√xt
;

49 
ngx_πmp_live_˘x_t
 *
	m˘x
;

50 
ngx_πmp_b™dwidth_t
 
	mbw_ö
;

51 
ngx_πmp_b™dwidth_t
 
	mbw_ö_audio
;

52 
ngx_πmp_b™dwidth_t
 
	mbw_ö_video
;

53 
ngx_πmp_b™dwidth_t
 
	mbw_out
;

54 
ngx_m£c_t
 
	mïoch
;

55 
	ma˘ive
:1;

56 
	mpublishög
:1;

61 
ngx_öt_t
 
	mnbuckës
;

62 
ngx_πmp_live_°ªam_t
 **
	m°ªams
;

63 
ngx_Êag_t
 
	mlive
;

64 
ngx_Êag_t
 
	mmëa
;

65 
ngx_m£c_t
 
	msync
;

66 
ngx_m£c_t
 
	midÀ_timeout
;

67 
ngx_Êag_t
 
	m©c
;

68 
ngx_Êag_t
 
	möãæóve
;

69 
ngx_Êag_t
 
	mwaô_key
;

70 
ngx_Êag_t
 
	mwaô_video
;

71 
ngx_Êag_t
 
	mpublish_nŸify
;

72 
ngx_Êag_t
 
	m∂ay_ª°¨t
;

73 
ngx_Êag_t
 
	midÀ_°ªams
;

74 
ngx_m£c_t
 
	mbuÊí
;

75 
ngx_poﬁ_t
 *
	mpoﬁ
;

76 
ngx_πmp_live_°ªam_t
 *
	m‰ì_°ªams
;

77 } 
	tngx_πmp_live_≠p_c⁄f_t
;

80 
ngx_moduÀ_t
 
ngx_πmp_live_moduÀ
;

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_log_module.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp_cmd_moduÀ.h
"

12 
ngx_πmp_publish_±
 
	g√xt_publish
;

13 
ngx_πmp_∂ay_±
 
	g√xt_∂ay
;

16 
ngx_öt_t
 
ngx_πmp_log_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
);

17 *
ngx_πmp_log_¸óã_maö_c⁄f
(
ngx_c⁄f_t
 *
cf
);

18 * 
ngx_πmp_log_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
);

19 * 
ngx_πmp_log_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
,

20 *
∑ª¡
, *
chûd
);

21 * 
ngx_πmp_log_£t_log
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
,

22 *
c⁄f
);

23 * 
ngx_πmp_log_£t_f‹m©
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
,

24 *
c⁄f
);

25 * 
ngx_πmp_log_compûe_f‹m©
(
ngx_c⁄f_t
 *
cf
, 
ngx_¨øy_t
 *
›s
,

26 
ngx_¨øy_t
 *
¨gs
, 
ngx_uöt_t
 
s
);

29 
ngx_πmp_log_›_s
 
	tngx_πmp_log_›_t
;

32 
	$size_t
 (*
	tngx_πmp_log_›_gëÀn_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

33 
	tngx_πmp_log_›_t
 *
	t›
);

34 
u_ch¨
 * (*
	tngx_πmp_log_›_gëd©a_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

35 
	tu_ch¨
 *
	tbuf
, 
	tngx_πmp_log_›_t
 *
	tlog
);

38 
	sngx_πmp_log_›_s
 {

39 
ngx_πmp_log_›_gëÀn_±
 
gëÀn
;

40 
ngx_πmp_log_›_gëd©a_±
 
gëd©a
;

41 
ngx_°r_t
 
vÆue
;

42 
ngx_uöt_t
 
off£t
;

47 
ngx_°r_t
 
«me
;

48 
ngx_πmp_log_›_gëÀn_±
 
gëÀn
;

49 
ngx_πmp_log_›_gëd©a_±
 
gëd©a
;

50 
ngx_uöt_t
 
off£t
;

51 } 
	tngx_πmp_log_v¨_t
;

55 
ngx_°r_t
 
«me
;

56 
ngx_¨øy_t
 *
›s
;

57 } 
	tngx_πmp_log_fmt_t
;

61 
ngx_›í_fûe_t
 *
fûe
;

62 
time_t
 
disk_fuŒ_time
;

63 
time_t
 
îr‹_log_time
;

64 
ngx_πmp_log_fmt_t
 *
f‹m©
;

65 } 
	tngx_πmp_log_t
;

69 
ngx_¨øy_t
 *
logs
;

70 
ngx_uöt_t
 
off
;

71 } 
	tngx_πmp_log_≠p_c⁄f_t
;

75 
ngx_¨øy_t
 
f‹m©s
;

76 
ngx_uöt_t
 
comböed_u£d
;

77 } 
	tngx_πmp_log_maö_c⁄f_t
;

81 
∂ay
:1;

82 
publish
:1;

83 
u_ch¨
 
«me
[
NGX_RTMP_MAX_NAME
];

84 
u_ch¨
 
¨gs
[
NGX_RTMP_MAX_ARGS
];

85 } 
	tngx_πmp_log_˘x_t
;

88 
ngx_°r_t
 
ngx_πmp_ac˚ss_log
 = 
	`ngx_°rög
(
NGX_HTTP_LOG_PATH
);

91 
ngx_comm™d_t
 
ngx_πmp_log_comm™ds
[] = {

93 { 
	`ngx_°rög
("access_log"),

94 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE12
,

95 
ngx_πmp_log_£t_log
,

96 
NGX_RTMP_APP_CONF_OFFSET
,

98 
NULL
 },

100 { 
	`ngx_°rög
("log_format"),

101 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_2MORE
,

102 
ngx_πmp_log_£t_f‹m©
,

103 
NGX_RTMP_MAIN_CONF_OFFSET
,

105 
NULL
 },

107 
ngx_nuŒ_comm™d


108 
	}
};

111 
ngx_πmp_moduÀ_t
 
	gngx_πmp_log_moduÀ_˘x
 = {

112 
NULL
,

113 
ngx_πmp_log_po°c⁄figuøti⁄
,

114 
ngx_πmp_log_¸óã_maö_c⁄f
,

115 
NULL
,

116 
NULL
,

117 
NULL
,

118 
ngx_πmp_log_¸óã_≠p_c⁄f
,

119 
ngx_πmp_log_mîge_≠p_c⁄f


123 
ngx_moduÀ_t
 
	gngx_πmp_log_moduÀ
 = {

124 
NGX_MODULE_V1
,

125 &
ngx_πmp_log_moduÀ_˘x
,

126 
ngx_πmp_log_comm™ds
,

127 
NGX_RTMP_MODULE
,

128 
NULL
,

129 
NULL
,

130 
NULL
,

131 
NULL
,

132 
NULL
,

133 
NULL
,

134 
NULL
,

135 
NGX_MODULE_V1_PADDING


139 
ngx_°r_t
 
	gngx_πmp_comböed_fmt
 =

140 
ngx_°rög
("$remote_addr [$time_local] $command "

146 
size_t


147 
	$ngx_πmp_log_v¨_deÁu…_gëÀn
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_log_›_t
 *
›
)

149  
›
->
vÆue
.
Àn
;

150 
	}
}

153 
u_ch¨
 *

154 
	$ngx_πmp_log_v¨_deÁu…_gëd©a
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
buf
,

155 
ngx_πmp_log_›_t
 *
›
)

157  
	`ngx_˝ymem
(
buf
, 
›
->
vÆue
.
d©a
, op->vÆue.
Àn
);

158 
	}
}

161 
size_t


162 
	$ngx_πmp_log_v¨_c⁄√˘i⁄_gëÀn
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_log_›_t
 *
›
)

164  
NGX_INT_T_LEN
;

165 
	}
}

167 
u_ch¨
 *

168 
	$ngx_πmp_log_v¨_c⁄√˘i⁄_gëd©a
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
buf
,

169 
ngx_πmp_log_›_t
 *
›
)

171  
	`ngx_•rötf
(
buf
, "%ui", (
ngx_uöt_t
Ë
s
->
c⁄√˘i⁄
->
numbî
);

172 
	}
}

175 
size_t


176 
	$ngx_πmp_log_v¨_ªmŸe_addr_gëÀn
(
ngx_πmp_£ssi⁄_t
 *
s
,

177 
ngx_πmp_log_›_t
 *
›
)

179  
s
->
c⁄√˘i⁄
->
addr_ãxt
.
Àn
;

180 
	}
}

183 
u_ch¨
 *

184 
	$ngx_πmp_log_v¨_ªmŸe_addr_gëd©a
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
buf
,

185 
ngx_πmp_log_›_t
 *
›
)

187  
	`ngx_˝ymem
(
buf
, 
s
->
c⁄√˘i⁄
->
addr_ãxt
.
d©a
,

188 
s
->
c⁄√˘i⁄
->
addr_ãxt
.
Àn
);

189 
	}
}

192 
size_t


193 
	$ngx_πmp_log_v¨_m£c_gëÀn
(
ngx_πmp_£ssi⁄_t
 *
s
,

194 
ngx_πmp_log_›_t
 *
›
)

196  
NGX_TIME_T_LEN
 + 4;

197 
	}
}

200 
u_ch¨
 *

201 
	$ngx_πmp_log_v¨_m£c_gëd©a
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
buf
,

202 
ngx_πmp_log_›_t
 *
›
)

204 
ngx_time_t
 *
ç
;

206 
ç
 = 
	`ngx_timeofday
();

208  
	`ngx_•rötf
(
buf
, "%T.%03M", 
ç
->
£c
,Åp->
m£c
);

209 
	}
}

212 
size_t


213 
	$ngx_πmp_log_v¨_£ssi⁄_°rög_gëÀn
(
ngx_πmp_£ssi⁄_t
 *
s
,

214 
ngx_πmp_log_›_t
 *
›
)

216  ((
ngx_°r_t
 *Ë((
u_ch¨
 *Ë
s
 + 
›
->
off£t
))->
Àn
;

217 
	}
}

220 
u_ch¨
 *

221 
	$ngx_πmp_log_v¨_£ssi⁄_°rög_gëd©a
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
buf
,

222 
ngx_πmp_log_›_t
 *
›
)

224 
ngx_°r_t
 *
°r
;

226 
°r
 = (
ngx_°r_t
 *Ë((
u_ch¨
 *Ë
s
 + 
›
->
off£t
);

228  
	`ngx_˝ymem
(
buf
, 
°r
->
d©a
, så->
Àn
);

229 
	}
}

232 
size_t


233 
	$ngx_πmp_log_v¨_comm™d_gëÀn
(
ngx_πmp_£ssi⁄_t
 *
s
,

234 
ngx_πmp_log_›_t
 *
›
)

237 
	}
}

240 
u_ch¨
 *

241 
	$ngx_πmp_log_v¨_comm™d_gëd©a
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
buf
,

242 
ngx_πmp_log_›_t
 *
›
)

244 
ngx_πmp_log_˘x_t
 *
˘x
;

245 
ngx_°r_t
 *
cmd
;

246 
ngx_uöt_t
 
n
;

248 
ngx_°r_t
 
comm™ds
[] = {

249 
	`ngx_°rög
("NONE"),

250 
	`ngx_°rög
("PLAY"),

251 
	`ngx_°rög
("PUBLISH"),

252 
	`ngx_°rög
("PLAY+PUBLISH")

255 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_log_moduÀ
);

257 
n
 = 
˘x
 ? (˘x->
∂ay
 + ctx->
publish
 * 2) : 0;

259 
cmd
 = &
comm™ds
[
n
];

261  
	`ngx_˝ymem
(
buf
, 
cmd
->
d©a
, cmd->
Àn
);

262 
	}
}

265 
size_t


266 
	$ngx_πmp_log_v¨_c⁄ãxt_c°rög_gëÀn
(
ngx_πmp_£ssi⁄_t
 *
s
,

267 
ngx_πmp_log_›_t
 *
›
)

269  
	`ngx_max
(
NGX_RTMP_MAX_NAME
, 
NGX_RTMP_MAX_ARGS
);

270 
	}
}

273 
u_ch¨
 *

274 
	$ngx_πmp_log_v¨_c⁄ãxt_c°rög_gëd©a
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
buf
,

275 
ngx_πmp_log_›_t
 *
›
)

277 
ngx_πmp_log_˘x_t
 *
˘x
;

278 
u_ch¨
 *
p
;

280 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_log_moduÀ
);

281 i‡(
˘x
 =
NULL
) {

282  
buf
;

285 
p
 = (
u_ch¨
 *Ë
˘x
 + 
›
->
off£t
;

286 *
p
) {

287 *
buf
++ = *
p
++;

290  
buf
;

291 
	}
}

294 
size_t


295 
	$ngx_πmp_log_v¨_£ssi⁄_uöt32_gëÀn
(
ngx_πmp_£ssi⁄_t
 *
s
,

296 
ngx_πmp_log_›_t
 *
›
)

298  
NGX_INT32_LEN
;

299 
	}
}

302 
u_ch¨
 *

303 
	$ngx_πmp_log_v¨_£ssi⁄_uöt32_gëd©a
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
buf
,

304 
ngx_πmp_log_›_t
 *
›
)

306 
uöt32_t
 *
v
;

308 
v
 = (
uöt32_t
 *Ë((
uöt8_t
 *Ë
s
 + 
›
->
off£t
);

310  
	`ngx_•rötf
(
buf
, "%uD", *
v
);

311 
	}
}

314 
size_t


315 
	$ngx_πmp_log_v¨_time_loˇl_gëÀn
(
ngx_πmp_£ssi⁄_t
 *
s
,

316 
ngx_πmp_log_›_t
 *
›
)

318  
ngx_ˇched_hâp_log_time
.
Àn
;

319 
	}
}

322 
u_ch¨
 *

323 
	$ngx_πmp_log_v¨_time_loˇl_gëd©a
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
buf
,

324 
ngx_πmp_log_›_t
 *
›
)

326  
	`ngx_˝ymem
(
buf
, 
ngx_ˇched_hâp_log_time
.
d©a
,

327 
ngx_ˇched_hâp_log_time
.
Àn
);

328 
	}
}

331 
size_t


332 
	$ngx_πmp_log_v¨_£ssi⁄_time_gëÀn
(
ngx_πmp_£ssi⁄_t
 *
s
,

333 
ngx_πmp_log_›_t
 *
›
)

335  
NGX_INT64_LEN
;

336 
	}
}

339 
u_ch¨
 *

340 
	$ngx_πmp_log_v¨_£ssi⁄_time_gëd©a
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
buf
,

341 
ngx_πmp_log_›_t
 *
›
)

343  
	`ngx_•rötf
(
buf
, "%L",

344 (
öt64_t
Ë(
ngx_cuºít_m£c
 - 
s
->
ïoch
) / 1000);

345 
	}
}

348 
size_t


349 
	$ngx_πmp_log_v¨_£ssi⁄_ªadabÀ_time_gëÀn
(
ngx_πmp_£ssi⁄_t
 *
s
,

350 
ngx_πmp_log_›_t
 *
›
)

352  
NGX_INT_T_LEN
 + ("d 23h 59m 59s") - 1;

353 
	}
}

356 
u_ch¨
 *

357 
	$ngx_πmp_log_v¨_£ssi⁄_ªadabÀ_time_gëd©a
(
ngx_πmp_£ssi⁄_t
 *
s
,

358 
u_ch¨
 *
buf
, 
ngx_πmp_log_›_t
 *
›
)

360 
öt64_t
 
v
;

361 
ngx_uöt_t
 
days
, 
hours
, 
möuãs
, 
£c⁄ds
;

363 
v
 = (
ngx_cuºít_m£c
 - 
s
->
ïoch
) / 1000;

365 
days
 = (
ngx_uöt_t
Ë(
v
 / (60 * 60 * 24));

366 
hours
 = (
ngx_uöt_t
Ë(
v
 / (60 * 60) % 24);

367 
möuãs
 = (
ngx_uöt_t
Ë(
v
 / 60 % 60);

368 
£c⁄ds
 = (
ngx_uöt_t
Ë(
v
 % 60);

370 i‡(
days
) {

371 
buf
 = 
	`ngx_•rötf
(buf, "%uid ", 
days
);

374 i‡(
days
 || 
hours
) {

375 
buf
 = 
	`ngx_•rötf
(buf, "%uih ", 
hours
);

378 i‡(
days
 || 
hours
 || 
möuãs
) {

379 
buf
 = 
	`ngx_•rötf
(buf, "%uim ", 
möuãs
);

382 
buf
 = 
	`ngx_•rötf
(buf, "%uis", 
£c⁄ds
);

384  
buf
;

385 
	}
}

388 
ngx_πmp_log_v¨_t
 
	gngx_πmp_log_v¨s
[] = {

389 { 
ngx_°rög
("connection"),

390 
ngx_πmp_log_v¨_c⁄√˘i⁄_gëÀn
,

391 
ngx_πmp_log_v¨_c⁄√˘i⁄_gëd©a
,

394 { 
ngx_°rög
("remote_addr"),

395 
ngx_πmp_log_v¨_ªmŸe_addr_gëÀn
,

396 
ngx_πmp_log_v¨_ªmŸe_addr_gëd©a
,

399 { 
ngx_°rög
("app"),

400 
ngx_πmp_log_v¨_£ssi⁄_°rög_gëÀn
,

401 
ngx_πmp_log_v¨_£ssi⁄_°rög_gëd©a
,

402 
off£tof
(
ngx_πmp_£ssi⁄_t
, 
≠p
) },

404 { 
ngx_°rög
("flashver"),

405 
ngx_πmp_log_v¨_£ssi⁄_°rög_gëÀn
,

406 
ngx_πmp_log_v¨_£ssi⁄_°rög_gëd©a
,

407 
off£tof
(
ngx_πmp_£ssi⁄_t
, 
Êashvî
) },

409 { 
ngx_°rög
("swfurl"),

410 
ngx_πmp_log_v¨_£ssi⁄_°rög_gëÀn
,

411 
ngx_πmp_log_v¨_£ssi⁄_°rög_gëd©a
,

412 
off£tof
(
ngx_πmp_£ssi⁄_t
, 
swf_uæ
) },

414 { 
ngx_°rög
("tcurl"),

415 
ngx_πmp_log_v¨_£ssi⁄_°rög_gëÀn
,

416 
ngx_πmp_log_v¨_£ssi⁄_°rög_gëd©a
,

417 
off£tof
(
ngx_πmp_£ssi⁄_t
, 
tc_uæ
) },

419 { 
ngx_°rög
("pageurl"),

420 
ngx_πmp_log_v¨_£ssi⁄_°rög_gëÀn
,

421 
ngx_πmp_log_v¨_£ssi⁄_°rög_gëd©a
,

422 
off£tof
(
ngx_πmp_£ssi⁄_t
, 
∑ge_uæ
) },

424 { 
ngx_°rög
("command"),

425 
ngx_πmp_log_v¨_comm™d_gëÀn
,

426 
ngx_πmp_log_v¨_comm™d_gëd©a
,

429 { 
ngx_°rög
("name"),

430 
ngx_πmp_log_v¨_c⁄ãxt_c°rög_gëÀn
,

431 
ngx_πmp_log_v¨_c⁄ãxt_c°rög_gëd©a
,

432 
off£tof
(
ngx_πmp_log_˘x_t
, 
«me
) },

434 { 
ngx_°rög
("args"),

435 
ngx_πmp_log_v¨_c⁄ãxt_c°rög_gëÀn
,

436 
ngx_πmp_log_v¨_c⁄ãxt_c°rög_gëd©a
,

437 
off£tof
(
ngx_πmp_log_˘x_t
, 
¨gs
) },

439 { 
ngx_°rög
("bytes_sent"),

440 
ngx_πmp_log_v¨_£ssi⁄_uöt32_gëÀn
,

441 
ngx_πmp_log_v¨_£ssi⁄_uöt32_gëd©a
,

442 
off£tof
(
ngx_πmp_£ssi⁄_t
, 
out_byãs
) },

444 { 
ngx_°rög
("bytes_received"),

445 
ngx_πmp_log_v¨_£ssi⁄_uöt32_gëÀn
,

446 
ngx_πmp_log_v¨_£ssi⁄_uöt32_gëd©a
,

447 
off£tof
(
ngx_πmp_£ssi⁄_t
, 
ö_byãs
) },

449 { 
ngx_°rög
("time_local"),

450 
ngx_πmp_log_v¨_time_loˇl_gëÀn
,

451 
ngx_πmp_log_v¨_time_loˇl_gëd©a
,

454 { 
ngx_°rög
("msec"),

455 
ngx_πmp_log_v¨_m£c_gëÀn
,

456 
ngx_πmp_log_v¨_m£c_gëd©a
,

459 { 
ngx_°rög
("session_time"),

460 
ngx_πmp_log_v¨_£ssi⁄_time_gëÀn
,

461 
ngx_πmp_log_v¨_£ssi⁄_time_gëd©a
,

464 { 
ngx_°rög
("session_readable_time"),

465 
ngx_πmp_log_v¨_£ssi⁄_ªadabÀ_time_gëÀn
,

466 
ngx_πmp_log_v¨_£ssi⁄_ªadabÀ_time_gëd©a
,

469 { 
ngx_nuŒ_°rög
, 
NULL
, NULL, 0 }

474 
	$ngx_πmp_log_¸óã_maö_c⁄f
(
ngx_c⁄f_t
 *
cf
)

476 
ngx_πmp_log_maö_c⁄f_t
 *
lmcf
;

477 
ngx_πmp_log_fmt_t
 *
fmt
;

479 
lmcf
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_log_maö_c⁄f_t
));

480 i‡(
lmcf
 =
NULL
) {

481  
NULL
;

484 i‡(
	`ngx_¨øy_öô
(&
lmcf
->
f‹m©s
, 
cf
->
poﬁ
, 4, (
ngx_πmp_log_fmt_t
))

485 !
NGX_OK
)

487  
NULL
;

490 
fmt
 = 
	`ngx_¨øy_push
(&
lmcf
->
f‹m©s
);

491 i‡(
fmt
 =
NULL
) {

492  
NULL
;

495 
	`ngx_°r_£t
(&
fmt
->
«me
, "combined");

497 
fmt
->
›s
 = 
	`ngx_¨øy_¸óã
(
cf
->
poﬁ
, 16, (
ngx_πmp_log_›_t
));

498 i‡(
fmt
->
›s
 =
NULL
) {

499  
NULL
;

502  
lmcf
;

504 
	}
}

508 
	$ngx_πmp_log_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
)

510 
ngx_πmp_log_≠p_c⁄f_t
 *
œcf
;

512 
œcf
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_log_≠p_c⁄f_t
));

513 i‡(
œcf
 =
NULL
) {

514  
NULL
;

517  
œcf
;

518 
	}
}

522 
	$ngx_πmp_log_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
∑ª¡
, *
chûd
)

524 
ngx_πmp_log_≠p_c⁄f_t
 *
¥ev
 = 
∑ª¡
;

525 
ngx_πmp_log_≠p_c⁄f_t
 *
c⁄f
 = 
chûd
;

526 
ngx_πmp_log_maö_c⁄f_t
 *
lmcf
;

527 
ngx_πmp_log_fmt_t
 *
fmt
;

528 
ngx_πmp_log_t
 *
log
;

530 i‡(
c⁄f
->
logs
 || c⁄f->
off
) {

531  
NGX_OK
;

534 
c⁄f
->
logs
 = 
¥ev
->logs;

535 
c⁄f
->
off
 = 
¥ev
->off;

537 i‡(
c⁄f
->
logs
 || c⁄f->
off
) {

538  
NGX_OK
;

541 
c⁄f
->
logs
 = 
	`ngx_¨øy_¸óã
(
cf
->
poﬁ
, 2, (
ngx_πmp_log_t
));

542 i‡(
c⁄f
->
logs
 =
NULL
) {

543  
NGX_CONF_ERROR
;

546 
log
 = 
	`ngx_¨øy_push
(
c⁄f
->
logs
);

547 i‡(
log
 =
NULL
) {

548  
NGX_CONF_ERROR
;

551 
log
->
fûe
 = 
	`ngx_c⁄f_›í_fûe
(
cf
->
cy˛e
, &
ngx_πmp_ac˚ss_log
);

552 i‡(
log
->
fûe
 =
NULL
) {

553  
NGX_CONF_ERROR
;

556 
log
->
disk_fuŒ_time
 = 0;

557 
log
->
îr‹_log_time
 = 0;

559 
lmcf
 = 
	`ngx_πmp_c⁄f_gë_moduÀ_maö_c⁄f
(
cf
, 
ngx_πmp_log_moduÀ
);

560 
fmt
 = 
lmcf
->
f‹m©s
.
ñts
;

562 
log
->
f‹m©
 = &
fmt
[0];

563 
lmcf
->
comböed_u£d
 = 1;

565  
NGX_CONF_OK
;

566 
	}
}

570 
	$ngx_πmp_log_£t_log
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

572 
ngx_πmp_log_≠p_c⁄f_t
 *
œcf
 = 
c⁄f
;

574 
ngx_πmp_log_maö_c⁄f_t
 *
lmcf
;

575 
ngx_πmp_log_fmt_t
 *
fmt
;

576 
ngx_πmp_log_t
 *
log
;

577 
ngx_°r_t
 *
vÆue
, 
«me
;

578 
ngx_uöt_t
 
n
;

580 
vÆue
 = 
cf
->
¨gs
->
ñts
;

582 i‡(
	`ngx_°rcmp
(
vÆue
[1].
d©a
, "off") == 0) {

583 
œcf
->
off
 = 1;

584  
NGX_CONF_OK
;

587 i‡(
œcf
->
logs
 =
NULL
) {

588 
œcf
->
logs
 = 
	`ngx_¨øy_¸óã
(
cf
->
poﬁ
, 2, (
ngx_πmp_log_t
));

589 i‡(
œcf
->
logs
 =
NULL
) {

590  
NGX_CONF_ERROR
;

594 
log
 = 
	`ngx_¨øy_push
(
œcf
->
logs
);

595 i‡(
log
 =
NULL
) {

596  
NGX_CONF_ERROR
;

599 
	`ngx_memzîo
(
log
, (*log));

601 
lmcf
 = 
	`ngx_πmp_c⁄f_gë_moduÀ_maö_c⁄f
(
cf
, 
ngx_πmp_log_moduÀ
);

603 
log
->
fûe
 = 
	`ngx_c⁄f_›í_fûe
(
cf
->
cy˛e
, &
vÆue
[1]);

604 i‡(
log
->
fûe
 =
NULL
) {

605  
NGX_CONF_ERROR
;

608 i‡(
cf
->
¨gs
->
√…s
 == 2) {

609 
	`ngx_°r_£t
(&
«me
, "combined");

610 
lmcf
->
comböed_u£d
 = 1;

613 
«me
 = 
vÆue
[2];

614 i‡(
	`ngx_°rcmp
(
«me
.
d©a
, "combined") == 0) {

615 
lmcf
->
comböed_u£d
 = 1;

619 
fmt
 = 
lmcf
->
f‹m©s
.
ñts
;

620 
n
 = 0;Ç < 
lmcf
->
f‹m©s
.
√…s
; ++n, ++
fmt
) {

621 i‡(
fmt
->
«me
.
Àn
 ==Çame.len &&

622 
	`ngx_°∫ˇ£cmp
(
fmt
->
«me
.
d©a
,Çame.d©a,Çame.
Àn
) == 0)

624 
log
->
f‹m©
 = 
fmt
;

629 i‡(
log
->
f‹m©
 =
NULL
) {

630 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_WARN
, 
cf
, 0, "unknownÜog format \"%V\"",

631 &
«me
);

632  
NGX_CONF_ERROR
;

635  
NGX_CONF_OK
;

636 
	}
}

640 
	$ngx_πmp_log_£t_f‹m©
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

642 
ngx_πmp_log_maö_c⁄f_t
 *
lmcf
 = 
c⁄f
;

643 
ngx_πmp_log_fmt_t
 *
fmt
;

644 
ngx_°r_t
 *
vÆue
;

645 
ngx_uöt_t
 
i
;

647 
vÆue
 = 
cf
->
¨gs
->
ñts
;

649 i‡(
cf
->
cmd_ty≥
 !
NGX_RTMP_MAIN_CONF
) {

650 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_WARN
, 
cf
, 0,

655 
fmt
 = 
lmcf
->
f‹m©s
.
ñts
;

656 
i
 = 0; i < 
lmcf
->
f‹m©s
.
√…s
; i++) {

657 i‡(
fmt
[
i
].
«me
.
Àn
 =
vÆue
[1].len &&

658 
	`ngx_°rcmp
(
fmt
[
i
].
«me
.
d©a
, 
vÆue
[1].data) == 0)

660 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

662 &
vÆue
[1]);

663  
NGX_CONF_ERROR
;

667 
fmt
 = 
	`ngx_¨øy_push
(&
lmcf
->
f‹m©s
);

668 i‡(
fmt
 =
NULL
) {

669  
NGX_CONF_ERROR
;

672 
fmt
->
«me
 = 
vÆue
[1];

674 
fmt
->
›s
 = 
	`ngx_¨øy_¸óã
(
cf
->
poﬁ
, 16, (
ngx_πmp_log_›_t
));

675 i‡(
fmt
->
›s
 =
NULL
) {

676  
NGX_CONF_ERROR
;

679  
	`ngx_πmp_log_compûe_f‹m©
(
cf
, 
fmt
->
›s
, cf->
¨gs
, 2);

680 
	}
}

684 
	$ngx_πmp_log_compûe_f‹m©
(
ngx_c⁄f_t
 *
cf
, 
ngx_¨øy_t
 *
›s
,Çgx_¨øy_à*
¨gs
,

685 
ngx_uöt_t
 
s
)

687 
size_t
 
i
, 
Àn
;

688 
u_ch¨
 *
d©a
, *
d
, 
c
;

689 
ngx_uöt_t
 
bøckë
;

690 
ngx_°r_t
 *
vÆue
, 
v¨
;

691 
ngx_πmp_log_›_t
 *
›
;

692 
ngx_πmp_log_v¨_t
 *
v
;

694 
vÆue
 = 
¨gs
->
ñts
;

696 ; 
s
 < 
¨gs
->
√…s
; ++s) {

697 
i
 = 0;

699 
Àn
 = 
vÆue
[
s
].len;

700 
d
 = 
vÆue
[
s
].
d©a
;

702 
i
 < 
Àn
) {

704 
›
 = 
	`ngx_¨øy_push
(
›s
);

705 i‡(
›
 =
NULL
) {

706  
NGX_CONF_ERROR
;

709 
	`ngx_memzîo
(
›
, (*op));

711 
d©a
 = &
d
[
i
];

713 i‡(
d
[
i
] == '$') {

714 i‡(++
i
 =
Àn
) {

715 
övÆid
;

718 i‡(
d
[
i
] == '{') {

719 
bøckë
 = 1;

720 i‡(++
i
 =
Àn
) {

721 
övÆid
;

724 
bøckë
 = 0;

727 
v¨
.
d©a
 = &
d
[
i
];

729 
v¨
.
Àn
 = 0; 
i
 <Üen; ++i, ++var.len) {

730 
c
 = 
d
[
i
];

732 i‡(
c
 ='}' && 
bøckë
) {

733 ++
i
;

734 
bøckë
 = 0;

738 i‡((
c
 >= 'A' && c <= 'Z') ||

739 (
c
 >= 'a' && c <= 'z') ||

740 (
c
 >= '0' && c <= '9') ||

741 (
c
 == '_'))

749 i‡(
bøckë
) {

750 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

752 &
v¨
);

753  
NGX_CONF_ERROR
;

756 i‡(
v¨
.
Àn
 == 0) {

757 
övÆid
;

760 
v
 = 
ngx_πmp_log_v¨s
; v->
«me
.
Àn
; ++v) {

761 i‡(
v
->
«me
.
Àn
 =
v¨
.len &&

762 
	`ngx_°∫cmp
(
v
->
«me
.
d©a
, 
v¨
.d©a, v¨.
Àn
) == 0)

764 
›
->
gëÀn
 = 
v
->getlen;

765 
›
->
gëd©a
 = 
v
->getdata;

766 
›
->
off£t
 = 
v
->offset;

771 i‡(
v
->
«me
.
Àn
 == 0) {

772 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

773 "unknow¿v¨übÀ \"%V\"", &
v¨
);

774  
NGX_CONF_ERROR
;

780 ++
i
;

782 
i
 < 
Àn
 && 
d
[i] != '$') {

783 ++
i
;

786 
›
->
gëÀn
 = 
ngx_πmp_log_v¨_deÁu…_gëÀn
;

787 
›
->
gëd©a
 = 
ngx_πmp_log_v¨_deÁu…_gëd©a
;

789 
›
->
vÆue
.
Àn
 = &
d
[
i
] - 
d©a
;

791 
›
->
vÆue
.
d©a
 = 
	`ngx_≤Æloc
(
cf
->
poﬁ
, op->vÆue.
Àn
);

792 i‡(
›
->
vÆue
.
d©a
 =
NULL
) {

793  
NGX_CONF_ERROR
;

796 
	`ngx_mem˝y
(
›
->
vÆue
.
d©a
, d©a, op->vÆue.
Àn
);

800  
NGX_CONF_OK
;

802 
övÆid
:

804 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0, "övÆidÖ¨amëî \"%s\"", 
d©a
);

806  
NGX_CONF_ERROR
;

807 
	}
}

810 
ngx_πmp_log_˘x_t
 *

811 
	$ngx_πmp_log_£t_«mes
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
«me
, u_ch¨ *
¨gs
)

813 
ngx_πmp_log_˘x_t
 *
˘x
;

815 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_log_moduÀ
);

816 i‡(
˘x
 =
NULL
) {

817 
˘x
 = 
	`ngx_pˇŒoc
(
s
->
c⁄√˘i⁄
->
poﬁ
, (
ngx_πmp_log_˘x_t
));

818 i‡(
˘x
 =
NULL
) {

819  
NULL
;

822 
	`ngx_πmp_£t_˘x
(
s
, 
˘x
, 
ngx_πmp_log_moduÀ
);

825 
	`ngx_mem˝y
(
˘x
->
«me
,Çame, 
NGX_RTMP_MAX_NAME
);

826 
	`ngx_mem˝y
(
˘x
->
¨gs
,árgs, 
NGX_RTMP_MAX_ARGS
);

828  
˘x
;

829 
	}
}

832 
ngx_öt_t


833 
	$ngx_πmp_log_publish
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_publish_t
 *
v
)

835 
ngx_πmp_log_˘x_t
 *
˘x
;

837 i‡(
s
->
auto_pushed
 || s->
ªœy
) {

838 
√xt
;

841 
˘x
 = 
	`ngx_πmp_log_£t_«mes
(
s
, 
v
->
«me
, v->
¨gs
);

842 i‡(
˘x
 =
NULL
) {

843 
√xt
;

846 
˘x
->
publish
 = 1;

848 
√xt
:

849  
	`√xt_publish
(
s
, 
v
);

850 
	}
}

853 
ngx_öt_t


854 
	$ngx_πmp_log_∂ay
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_∂ay_t
 *
v
)

856 
ngx_πmp_log_˘x_t
 *
˘x
;

858 i‡(
s
->
auto_pushed
 || s->
ªœy
) {

859 
√xt
;

862 
˘x
 = 
	`ngx_πmp_log_£t_«mes
(
s
, 
v
->
«me
, v->
¨gs
);

863 i‡(
˘x
 =
NULL
) {

864 
√xt
;

867 
˘x
->
∂ay
 = 1;

869 
√xt
:

870  
	`√xt_∂ay
(
s
, 
v
);

871 
	}
}

875 
	$ngx_πmp_log_wrôe
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_log_t
 *
log
, 
u_ch¨
 *
buf
,

876 
size_t
 
Àn
)

878 
u_ch¨
 *
«me
;

879 
time_t
 
now
;

880 
ssize_t
 
n
;

881 
îr
;

883 
îr
 = 0;

884 
«me
 = 
log
->
fûe
->«me.
d©a
;

885 
n
 = 
	`ngx_wrôe_fd
(
log
->
fûe
->
fd
, 
buf
, 
Àn
);

887 i‡(
n
 =(
ssize_t
Ë
Àn
) {

891 
now
 = 
	`ngx_time
();

893 i‡(
n
 == -1) {

894 
îr
 = 
ngx_î∫o
;

896 i‡(
îr
 =
NGX_ENOSPC
) {

897 
log
->
disk_fuŒ_time
 = 
now
;

900 i‡(
now
 - 
log
->
îr‹_log_time
 > 59) {

901 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
s
->
c⁄√˘i⁄
->
log
, 
îr
,

902 
ngx_wrôe_fd_n
 "Åÿ\"%s\" faûed", 
«me
);

903 
log
->
îr‹_log_time
 = 
now
;

907 i‡(
now
 - 
log
->
îr‹_log_time
 > 59) {

908 
	`ngx_log_îr‹
(
NGX_LOG_ALERT
, 
s
->
c⁄√˘i⁄
->
log
, 
îr
,

909 
ngx_wrôe_fd_n
 "Åo \"%s\" was incomplete: %z of %uz",

910 
«me
, 
n
, 
Àn
);

911 
log
->
îr‹_log_time
 = 
now
;

913 
	}
}

916 
ngx_öt_t


917 
	$ngx_πmp_log_disc⁄√˘
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

918 
ngx_chaö_t
 *
ö
)

920 
ngx_πmp_log_≠p_c⁄f_t
 *
œcf
;

921 
ngx_πmp_log_t
 *
log
;

922 
ngx_πmp_log_›_t
 *
›
;

923 
ngx_uöt_t
 
n
, 
i
;

924 
u_ch¨
 *
löe
, *
p
;

925 
size_t
 
Àn
;

927 i‡(
s
->
auto_pushed
 || s->
ªœy
) {

928  
NGX_OK
;

931 
œcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_log_moduÀ
);

932 i‡(
œcf
 =
NULL
 ||Üacf->
off
 ||Üacf->
logs
 == NULL) {

933  
NGX_OK
;

936 
log
 = 
œcf
->
logs
->
ñts
;

937 
i
 = 0; i < 
œcf
->
logs
->
√…s
; ++i, ++
log
) {

939 i‡(
	`ngx_time
(Ë=
log
->
disk_fuŒ_time
) {

945 
Àn
 = 0;

946 
›
 = 
log
->
f‹m©
->
›s
->
ñts
;

947 
n
 = 0;Ç < 
log
->
f‹m©
->
›s
->
√…s
; ++n, ++
›
) {

948 
Àn
 +
›
->
	`gëÀn
(
s
, op);

951 
Àn
 +
NGX_LINEFEED_SIZE
;

953 
löe
 = 
	`ngx_∑Œoc
(
s
->
c⁄√˘i⁄
->
poﬁ
, 
Àn
);

954 i‡(
löe
 =
NULL
) {

955  
NGX_OK
;

958 
p
 = 
löe
;

959 
›
 = 
log
->
f‹m©
->
›s
->
ñts
;

960 
n
 = 0;Ç < 
log
->
f‹m©
->
›s
->
√…s
; ++n, ++
›
) {

961 
p
 = 
›
->
	`gëd©a
(
s
,Ö, op);

964 
	`ngx_löe„ed
(
p
);

966 
	`ngx_πmp_log_wrôe
(
s
, 
log
, 
löe
, 
p
 -Üine);

969  
NGX_OK
;

970 
	}
}

973 
ngx_öt_t


974 
	$ngx_πmp_log_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
)

976 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
;

977 
ngx_πmp_h™dÀr_±
 *
h
;

978 
ngx_πmp_log_maö_c⁄f_t
 *
lmcf
;

979 
ngx_¨øy_t
 
a
;

980 
ngx_πmp_log_fmt_t
 *
fmt
;

981 
ngx_°r_t
 *
vÆue
;

983 
lmcf
 = 
	`ngx_πmp_c⁄f_gë_moduÀ_maö_c⁄f
(
cf
, 
ngx_πmp_log_moduÀ
);

984 i‡(
lmcf
->
comböed_u£d
) {

985 i‡(
	`ngx_¨øy_öô
(&
a
, 
cf
->
poﬁ
, 1, (
ngx_°r_t
)Ë!
NGX_OK
) {

986  
NGX_ERROR
;

989 
vÆue
 = 
	`ngx_¨øy_push
(&
a
);

990 i‡(
vÆue
 =
NULL
) {

991  
NGX_ERROR
;

994 *
vÆue
 = 
ngx_πmp_comböed_fmt
;

995 
fmt
 = 
lmcf
->
f‹m©s
.
ñts
;

997 i‡(
	`ngx_πmp_log_compûe_f‹m©
(
cf
, 
fmt
->
›s
, &
a
, 0)

998 !
NGX_CONF_OK
)

1000  
NGX_ERROR
;

1004 
cmcf
 = 
	`ngx_πmp_c⁄f_gë_moduÀ_maö_c⁄f
(
cf
, 
ngx_πmp_c‹e_moduÀ
);

1006 
h
 = 
	`ngx_¨øy_push
(&
cmcf
->
evíts
[
NGX_RTMP_DISCONNECT
]);

1007 *
h
 = 
ngx_πmp_log_disc⁄√˘
;

1009 
√xt_publish
 = 
ngx_πmp_publish
;

1010 
ngx_πmp_publish
 = 
ngx_πmp_log_publish
;

1012 
√xt_∂ay
 = 
ngx_πmp_∂ay
;

1013 
ngx_πmp_∂ay
 = 
ngx_πmp_log_∂ay
;

1015  
NGX_OK
;

1016 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_mp4_module.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp_∂ay_moduÀ.h
"

10 
	~"ngx_πmp_codec_moduÀ.h
"

11 
	~"ngx_πmp_°ªams.h
"

14 
ngx_öt_t
 
ngx_πmp_mp4_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
);

15 
ngx_öt_t
 
ngx_πmp_mp4_öô
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
,

16 
ngx_öt_t
 
aödex
,Çgx_öt_à
vödex
);

17 
ngx_öt_t
 
ngx_πmp_mp4_d⁄e
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
);

18 
ngx_öt_t
 
ngx_πmp_mp4_°¨t
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
);

19 
ngx_öt_t
 
ngx_πmp_mp4_£ek
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
,

20 
ngx_uöt_t
 
off£t
);

21 
ngx_öt_t
 
ngx_πmp_mp4_°›
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
);

22 
ngx_öt_t
 
ngx_πmp_mp4_£nd
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
,

23 
ngx_uöt_t
 *
ts
);

24 
ngx_öt_t
 
ngx_πmp_mp4_ª£t
(
ngx_πmp_£ssi⁄_t
 *
s
);

27 
	#NGX_RTMP_MP4_MAX_FRAMES
 8

	)

30 #¥agm®
∑ck
(
push
,4)

35 #i‡(
NGX_WIN32
)

36 #¥agm®
w¨nög
(
push
)

37 #¥agm®
w¨nög
(
dißbÀ
:4200)

42 
uöt32_t
 
	mfú°_chunk
;

43 
uöt32_t
 
	mßm∂es_≥r_chunk
;

44 
uöt32_t
 
	mßm∂e_des¸±i⁄_ödex
;

45 } 
	tngx_πmp_mp4_chunk_íåy_t
;

49 
uöt32_t
 
	mvîsi⁄_Êags
;

50 
uöt32_t
 
	míåy_cou¡
;

51 
ngx_πmp_mp4_chunk_íåy_t
 
	míåõs
[0];

52 } 
	tngx_πmp_mp4_chunks_t
;

56 
uöt32_t
 
	mßm∂e_cou¡
;

57 
uöt32_t
 
	mßm∂e_dñè
;

58 } 
	tngx_πmp_mp4_time_íåy_t
;

62 
uöt32_t
 
	mvîsi⁄_Êags
;

63 
uöt32_t
 
	míåy_cou¡
;

64 
ngx_πmp_mp4_time_íåy_t
 
	míåõs
[0];

65 } 
	tngx_πmp_mp4_times_t
;

69 
uöt32_t
 
	mßm∂e_cou¡
;

70 
uöt32_t
 
	mßm∂e_off£t
;

71 } 
	tngx_πmp_mp4_dñay_íåy_t
;

75 
uöt32_t
 
	mvîsi⁄_Êags
;

76 
uöt32_t
 
	míåy_cou¡
;

77 
ngx_πmp_mp4_dñay_íåy_t
 
	míåõs
[0];

78 } 
	tngx_πmp_mp4_dñays_t
;

82 
uöt32_t
 
	mvîsi⁄_Êags
;

83 
uöt32_t
 
	míåy_cou¡
;

84 
uöt32_t
 
	míåõs
[0];

85 } 
	tngx_πmp_mp4_keys_t
;

89 
uöt32_t
 
	mvîsi⁄_Êags
;

90 
uöt32_t
 
	mßm∂e_size
;

91 
uöt32_t
 
	mßm∂e_cou¡
;

92 
uöt32_t
 
	míåõs
[0];

93 } 
	tngx_πmp_mp4_sizes_t
;

97 
uöt32_t
 
	mvîsi⁄_Êags
;

98 
uöt32_t
 
	mfõld_size
;

99 
uöt32_t
 
	mßm∂e_cou¡
;

100 
uöt32_t
 
	míåõs
[0];

101 } 
	tngx_πmp_mp4_sizes2_t
;

105 
uöt32_t
 
	mvîsi⁄_Êags
;

106 
uöt32_t
 
	míåy_cou¡
;

107 
uöt32_t
 
	míåõs
[0];

108 } 
	tngx_πmp_mp4_off£ts_t
;

112 
uöt32_t
 
	mvîsi⁄_Êags
;

113 
uöt32_t
 
	míåy_cou¡
;

114 
uöt64_t
 
	míåõs
[0];

115 } 
	tngx_πmp_mp4_off£ts64_t
;

118 #i‡(
NGX_WIN32
)

119 #¥agm®
w¨nög
(
p›
)

123 #¥agm®
∑ck
(
p›
)

127 
uöt32_t
 
	mtime°amp
;

128 
uöt32_t
 
	mœ°_time°amp
;

129 
off_t
 
	moff£t
;

130 
size_t
 
	msize
;

131 
ngx_öt_t
 
	mkey
;

132 
uöt32_t
 
	mdñay
;

134 
	mnŸ_fú°
:1;

135 
	mvÆid
:1;

137 
ngx_uöt_t
 
	mpos
;

139 
ngx_uöt_t
 
	mkey_pos
;

141 
ngx_uöt_t
 
	mchunk
;

142 
ngx_uöt_t
 
	mchunk_pos
;

143 
ngx_uöt_t
 
	mchunk_cou¡
;

145 
ngx_uöt_t
 
	mtime_pos
;

146 
ngx_uöt_t
 
	mtime_cou¡
;

148 
ngx_uöt_t
 
	mdñay_pos
;

149 
ngx_uöt_t
 
	mdñay_cou¡
;

151 
ngx_uöt_t
 
	msize_pos
;

152 } 
	tngx_πmp_mp4_curs‹_t
;

156 
ngx_uöt_t
 
	mid
;

158 
ngx_öt_t
 
	mty≥
;

159 
ngx_öt_t
 
	mcodec
;

160 
uöt32_t
 
	mcsid
;

161 
u_ch¨
 
	mfhdr
;

162 
ngx_öt_t
 
	mtime_sˇÀ
;

163 
uöt64_t
 
	mduøti⁄
;

165 
u_ch¨
 *
	mhódî
;

166 
size_t
 
	mhódî_size
;

167 
	mhódî_£¡
:1;

169 
ngx_πmp_mp4_times_t
 *
	mtimes
;

170 
ngx_πmp_mp4_dñays_t
 *
	mdñays
;

171 
ngx_πmp_mp4_keys_t
 *
	mkeys
;

172 
ngx_πmp_mp4_chunks_t
 *
	mchunks
;

173 
ngx_πmp_mp4_sizes_t
 *
	msizes
;

174 
ngx_πmp_mp4_sizes2_t
 *
	msizes2
;

175 
ngx_πmp_mp4_off£ts_t
 *
	moff£ts
;

176 
ngx_πmp_mp4_off£ts64_t
 *
	moff£ts64
;

177 
ngx_πmp_mp4_curs‹_t
 
	mcurs‹
;

178 } 
	tngx_πmp_mp4_åack_t
;

182 *
	mmm≠ed
;

183 
size_t
 
	mmm≠ed_size
;

184 
ngx_fd_t
 
	mexåa
;

186 
	mmëa_£¡
:1;

188 
ngx_πmp_mp4_åack_t
 
	måacks
[2];

189 
ngx_πmp_mp4_åack_t
 *
	måack
;

190 
ngx_uöt_t
 
	m¡øcks
;

192 
ngx_uöt_t
 
	mwidth
;

193 
ngx_uöt_t
 
	mheight
;

194 
ngx_uöt_t
 
	mnch™√ls
;

195 
ngx_uöt_t
 
	mßm∂e_size
;

196 
ngx_uöt_t
 
	mßm∂e_øã
;

198 
ngx_öt_t
 
	m©øcks
, 
	mvåacks
;

199 
ngx_öt_t
 
	maödex
, 
	mvödex
;

201 
uöt32_t
 
	m°¨t_time°amp
, 
	mïoch
;

202 } 
	tngx_πmp_mp4_˘x_t
;

205 
	#ngx_πmp_mp4_make_èg
(
a
, 
b
, 
c
, 
d
) \

206 ((
uöt32_t
)
d
 << 24 | (uöt32_t)
c
 << 16 | (uöt32_t)
b
 << 8 | (uöt32_t)
a
)

	)

209 
ngx_ölöe
 
uöt32_t


210 
	$ngx_πmp_mp4_to_πmp_time°amp
(
ngx_πmp_mp4_åack_t
 *
t
, 
uöt64_t
 
ts
)

212  (
uöt32_t
Ë(
ts
 * 1000 / 
t
->
time_sˇÀ
);

213 
	}
}

216 
ngx_ölöe
 
uöt32_t


217 
	$ngx_πmp_mp4_‰om_πmp_time°amp
(
ngx_πmp_mp4_åack_t
 *
t
, 
uöt32_t
 
ts
)

219  (
uöt64_t
Ë
ts
 * 
t
->
time_sˇÀ
 / 1000;

220 
	}
}

223 
	#NGX_RTMP_MP4_BUFLEN_ADDON
 1000

	)

226 
u_ch¨
 
	gngx_πmp_mp4_buf„r
[1024*1024];

229 #i‡(
NGX_WIN32
)

231 
	$ngx_πmp_mp4_mm≠
(
ngx_fd_t
 
fd
, 
size_t
 
size
, 
off_t
 
off£t
,Çgx_fd_à*
exåa
)

233 *
d©a
;

235 *
exåa
 = 
	`Cª©eFûeM≠pög
(
fd
, 
NULL
, 
PAGE_READONLY
,

236 (
DWORD
Ë((
uöt64_t
Ë
size
 >> 32),

237 (
DWORD
Ë(
size
 & 0xffffffff),

238 
NULL
);

239 i‡(*
exåa
 =
NULL
) {

240  
NULL
;

243 
d©a
 = 
	`M≠VõwOfFûe
(*
exåa
, 
FILE_MAP_READ
,

244 (
DWORD
Ë((
uöt64_t
Ë
off£t
 >> 32),

245 (
DWORD
Ë(
off£t
 & 0xffffffff),

246 
size
);

248 i‡(
d©a
 =
NULL
) {

249 
	`Clo£H™dÀ
(*
exåa
);

257  
d©a
;

258 
	}
}

261 
ngx_öt_t


262 
	$ngx_πmp_mp4_munm≠
(*
d©a
, 
size_t
 
size
, 
ngx_fd_t
 *
exåa
)

264 
ngx_öt_t
 
rc
;

266 
rc
 = 
NGX_OK
;

268 i‡(
	`Unm≠VõwOfFûe
(
d©a
) == 0) {

269 
rc
 = 
NGX_ERROR
;

272 i‡(
	`Clo£H™dÀ
(*
exåa
) == 0) {

273 
rc
 = 
NGX_ERROR
;

276  
rc
;

277 
	}
}

282 
	$ngx_πmp_mp4_mm≠
(
ngx_fd_t
 
fd
, 
size_t
 
size
, 
off_t
 
off£t
,Çgx_fd_à*
exåa
)

284 *
d©a
;

286 
d©a
 = 
	`mm≠
(
NULL
, 
size
, 
PROT_READ
, 
MAP_SHARED
, 
fd
, 
off£t
);

290  
d©a
 =
MAP_FAILED
 ? 
NULL
 : data;

291 
	}
}

294 
ngx_öt_t


295 
	$ngx_πmp_mp4_munm≠
(*
d©a
, 
size_t
 
size
, 
ngx_fd_t
 *
exåa
)

297  
	`munm≠
(
d©a
, 
size
);

298 
	}
}

303 
ngx_öt_t
 
ngx_πmp_mp4_∑r£
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

304 
u_ch¨
 *
œ°
);

305 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_åak
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

306 
u_ch¨
 *
œ°
);

307 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_mdhd
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

308 
u_ch¨
 *
œ°
);

309 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_hdÃ
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

310 
u_ch¨
 *
œ°
);

311 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_°sd
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

312 
u_ch¨
 *
œ°
);

313 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_°sc
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

314 
u_ch¨
 *
œ°
);

315 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_°ts
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

316 
u_ch¨
 *
œ°
);

317 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_˘ts
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

318 
u_ch¨
 *
œ°
);

319 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_°ss
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

320 
u_ch¨
 *
œ°
);

321 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_°sz
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

322 
u_ch¨
 *
œ°
);

323 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_°z2
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

324 
u_ch¨
 *
œ°
);

325 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_°co
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

326 
u_ch¨
 *
œ°
);

327 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_co64
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

328 
u_ch¨
 *
œ°
);

329 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_avc1
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

330 
u_ch¨
 *
œ°
);

331 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_avcC
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

332 
u_ch¨
 *
œ°
);

333 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_mp4a
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

334 
u_ch¨
 *
œ°
);

335 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_mp4v
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

336 
u_ch¨
 *
œ°
);

337 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_esds
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

338 
u_ch¨
 *
œ°
);

339 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_mp3
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

340 
u_ch¨
 *
œ°
);

341 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_nmos
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

342 
u_ch¨
 *
œ°
);

343 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_•ex
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

344 
u_ch¨
 *
œ°
);

347 
	$ngx_öt_t
 (*
	tngx_πmp_mp4_box_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
, 
	tu_ch¨
 *
	tpos
,

348 
	tu_ch¨
 *
	tœ°
);

351 
uöt32_t
 
èg
;

352 
ngx_πmp_mp4_box_±
 
h™dÀr
;

353 } 
	tngx_πmp_mp4_box_t
;

356 
ngx_πmp_mp4_box_t
 
ngx_πmp_mp4_boxes
[] = {

357 { 
	`ngx_πmp_mp4_make_èg
('t','r','a','k'), 
ngx_πmp_mp4_∑r£_åak
 },

358 { 
	`ngx_πmp_mp4_make_èg
('m','d','i','a'), 
ngx_πmp_mp4_∑r£
 },

359 { 
	`ngx_πmp_mp4_make_èg
('m','d','h','d'), 
ngx_πmp_mp4_∑r£_mdhd
 },

360 { 
	`ngx_πmp_mp4_make_èg
('h','d','l','r'), 
ngx_πmp_mp4_∑r£_hdÃ
 },

361 { 
	`ngx_πmp_mp4_make_èg
('m','i','n','f'), 
ngx_πmp_mp4_∑r£
 },

362 { 
	`ngx_πmp_mp4_make_èg
('s','t','b','l'), 
ngx_πmp_mp4_∑r£
 },

363 { 
	`ngx_πmp_mp4_make_èg
('s','t','s','d'), 
ngx_πmp_mp4_∑r£_°sd
 },

364 { 
	`ngx_πmp_mp4_make_èg
('s','t','s','c'), 
ngx_πmp_mp4_∑r£_°sc
 },

365 { 
	`ngx_πmp_mp4_make_èg
('s','t','t','s'), 
ngx_πmp_mp4_∑r£_°ts
 },

366 { 
	`ngx_πmp_mp4_make_èg
('c','t','t','s'), 
ngx_πmp_mp4_∑r£_˘ts
 },

367 { 
	`ngx_πmp_mp4_make_èg
('s','t','s','s'), 
ngx_πmp_mp4_∑r£_°ss
 },

368 { 
	`ngx_πmp_mp4_make_èg
('s','t','s','z'), 
ngx_πmp_mp4_∑r£_°sz
 },

369 { 
	`ngx_πmp_mp4_make_èg
('s','t','z','2'), 
ngx_πmp_mp4_∑r£_°z2
 },

370 { 
	`ngx_πmp_mp4_make_èg
('s','t','c','o'), 
ngx_πmp_mp4_∑r£_°co
 },

371 { 
	`ngx_πmp_mp4_make_èg
('c','o','6','4'), 
ngx_πmp_mp4_∑r£_co64
 },

372 { 
	`ngx_πmp_mp4_make_èg
('a','v','c','1'), 
ngx_πmp_mp4_∑r£_avc1
 },

373 { 
	`ngx_πmp_mp4_make_èg
('a','v','c','C'), 
ngx_πmp_mp4_∑r£_avcC
 },

374 { 
	`ngx_πmp_mp4_make_èg
('m','p','4','a'), 
ngx_πmp_mp4_∑r£_mp4a
 },

375 { 
	`ngx_πmp_mp4_make_èg
('m','p','4','v'), 
ngx_πmp_mp4_∑r£_mp4v
 },

376 { 
	`ngx_πmp_mp4_make_èg
('e','s','d','s'), 
ngx_πmp_mp4_∑r£_esds
 },

377 { 
	`ngx_πmp_mp4_make_èg
('.','m','p','3'), 
ngx_πmp_mp4_∑r£_mp3
 },

378 { 
	`ngx_πmp_mp4_make_èg
('n','m','o','s'), 
ngx_πmp_mp4_∑r£_nmos
 },

379 { 
	`ngx_πmp_mp4_make_èg
('s','p','e','x'), 
ngx_πmp_mp4_∑r£_•ex
 },

380 { 
	`ngx_πmp_mp4_make_èg
('w','a','v','e'), 
ngx_πmp_mp4_∑r£
 }

381 
	}
};

384 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_des¸
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

385 
u_ch¨
 *
œ°
);

386 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_es
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

387 
u_ch¨
 *
œ°
);

388 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_dc
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

389 
u_ch¨
 *
œ°
);

390 
ngx_öt_t
 
ngx_πmp_mp4_∑r£_ds
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
,

391 
u_ch¨
 *
œ°
);

394 
	$ngx_öt_t
 (*
	tngx_πmp_mp4_des¸ùt‹_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

395 
	tu_ch¨
 *
	tpos
, u_ch¨ *
	tœ°
);

398 
uöt8_t
 
èg
;

399 
ngx_πmp_mp4_des¸ùt‹_±
 
h™dÀr
;

400 } 
	tngx_πmp_mp4_des¸ùt‹_t
;

403 
ngx_πmp_mp4_des¸ùt‹_t
 
ngx_πmp_mp4_des¸ùt‹s
[] = {

404 { 0x03, 
ngx_πmp_mp4_∑r£_es
 },

405 { 0x04, 
ngx_πmp_mp4_∑r£_dc
 },

406 { 0x05, 
ngx_πmp_mp4_∑r£_ds
 }

407 
	}
};

410 
ngx_πmp_moduÀ_t
 
	gngx_πmp_mp4_moduÀ_˘x
 = {

411 
NULL
,

412 
ngx_πmp_mp4_po°c⁄figuøti⁄
,

413 
NULL
,

414 
NULL
,

415 
NULL
,

416 
NULL
,

417 
NULL
,

418 
NULL


422 
ngx_moduÀ_t
 
	gngx_πmp_mp4_moduÀ
 = {

423 
NGX_MODULE_V1
,

424 &
ngx_πmp_mp4_moduÀ_˘x
,

425 
NULL
,

426 
NGX_RTMP_MODULE
,

427 
NULL
,

428 
NULL
,

429 
NULL
,

430 
NULL
,

431 
NULL
,

432 
NULL
,

433 
NULL
,

434 
NGX_MODULE_V1_PADDING


438 
ngx_öt_t


439 
	$ngx_πmp_mp4_∑r£_åak
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

441 
ngx_πmp_mp4_˘x_t
 *
˘x
;

443 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

445 i‡(
˘x
->
åack
) {

446  
NGX_OK
;

449 
˘x
->
åack
 = (˘x->
¡øcks
 =(˘x->
åacks
) / (ctx->tracks[0]))

450 ? 
NULL
 : &
˘x
->
åacks
[˘x->
¡øcks
];

452 i‡(
˘x
->
åack
) {

453 
	`ngx_memzîo
(
˘x
->
åack
, (*ctx->track));

454 
˘x
->
åack
->
id
 = ctx->
¡øcks
;

456 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

457 "mp4:ÅryögÅøck %ui", 
˘x
->
¡øcks
);

460 i‡(
	`ngx_πmp_mp4_∑r£
(
s
, 
pos
, 
œ°
Ë!
NGX_OK
) {

461  
NGX_ERROR
;

464 i‡(
˘x
->
åack
 && ctx->åack->
ty≥
 &&

465 (
˘x
->
¡øcks
 == 0 ||

466 
˘x
->
åacks
[0].
ty≥
 !˘x->åacks[˘x->
¡øcks
].type))

468 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

469 "mp4:áddögÅøck %ui", 
˘x
->
¡øcks
);

471 i‡(
˘x
->
åack
->
ty≥
 =
NGX_RTMP_MSG_AUDIO
) {

472 i‡(
˘x
->
©øcks
++ !˘x->
aödex
) {

473 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

475 
˘x
->
©øcks
 - 1, ctx->
aödex
);

476 
˘x
->
åack
 = 
NULL
;

477  
NGX_OK
;

481 i‡(
˘x
->
våacks
++ !˘x->
vödex
) {

482 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

484 
˘x
->
våacks
 - 1, ctx->
vödex
);

485 
˘x
->
åack
 = 
NULL
;

486  
NGX_OK
;

490 ++
˘x
->
¡øcks
;

493 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

494 "mp4: ign‹ögÅøck %ui", 
˘x
->
¡øcks
);

497 
˘x
->
åack
 = 
NULL
;

499  
NGX_OK
;

500 
	}
}

503 
ngx_öt_t


504 
	$ngx_πmp_mp4_∑r£_mdhd
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

506 
ngx_πmp_mp4_˘x_t
 *
˘x
;

507 
ngx_πmp_mp4_åack_t
 *
t
;

508 
uöt8_t
 
vîsi⁄
;

510 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

512 i‡(
˘x
->
åack
 =
NULL
) {

513  
NGX_OK
;

516 
t
 = 
˘x
->
åack
;

518 i‡(
pos
 + 1 > 
œ°
) {

519  
NGX_ERROR
;

522 
vîsi⁄
 = *(
uöt8_t
 *Ë
pos
;

524 
vîsi⁄
) {

526 i‡(
pos
 + 20 > 
œ°
) {

527  
NGX_ERROR
;

530 
pos
 += 12;

531 
t
->
time_sˇÀ
 = 
	`ngx_πmp_r32
(*(
uöt32_t
 *Ë
pos
);

532 
pos
 += 4;

533 
t
->
duøti⁄
 = 
	`ngx_πmp_r32
(*(
uöt32_t
 *Ë
pos
);

537 i‡(
pos
 + 28 > 
œ°
) {

538  
NGX_ERROR
;

541 
pos
 += 20;

542 
t
->
time_sˇÀ
 = 
	`ngx_πmp_r32
(*(
uöt32_t
 *Ë
pos
);

543 
pos
 += 4;

544 
t
->
duøti⁄
 = 
	`ngx_πmp_r64
(*(
uöt64_t
 *Ë
pos
);

548  
NGX_ERROR
;

551 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

553 
t
->
time_sˇÀ
,Å->
duøti⁄
);

555  
NGX_OK
;

556 
	}
}

559 
ngx_öt_t


560 
	$ngx_πmp_mp4_∑r£_hdÃ
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

562 
ngx_πmp_mp4_˘x_t
 *
˘x
;

563 
uöt32_t
 
ty≥
;

565 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

567 i‡(
˘x
->
åack
 =
NULL
) {

568  
NGX_OK
;

571 i‡(
pos
 + 12 > 
œ°
) {

572  
NGX_ERROR
;

575 
ty≥
 = *(
uöt32_t
 *)(
pos
 + 8);

577 i‡(
ty≥
 =
	`ngx_πmp_mp4_make_èg
('v','i','d','e')) {

578 
˘x
->
åack
->
ty≥
 = 
NGX_RTMP_MSG_VIDEO
;

579 
˘x
->
åack
->
csid
 = 
NGX_RTMP_CSID_VIDEO
;

581 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

584 } i‡(
ty≥
 =
	`ngx_πmp_mp4_make_èg
('s','o','u','n')) {

585 
˘x
->
åack
->
ty≥
 = 
NGX_RTMP_MSG_AUDIO
;

586 
˘x
->
åack
->
csid
 = 
NGX_RTMP_CSID_AUDIO
;

588 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

591 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

595  
NGX_OK
;

596 
	}
}

599 
ngx_öt_t


600 
	$ngx_πmp_mp4_∑r£_video
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
,

601 
ngx_öt_t
 
codec
)

603 
ngx_πmp_mp4_˘x_t
 *
˘x
;

605 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

607 i‡(
˘x
->
åack
 =
NULL
) {

608  
NGX_OK
;

611 
˘x
->
åack
->
codec
 = codec;

613 i‡(
pos
 + 78 > 
œ°
) {

614  
NGX_ERROR
;

617 
pos
 += 24;

619 
˘x
->
width
 = 
	`ngx_πmp_r16
(*(
uöt16_t
 *Ë
pos
);

621 
pos
 += 2;

623 
˘x
->
height
 = 
	`ngx_πmp_r16
(*(
uöt16_t
 *Ë
pos
);

625 
pos
 += 52;

627 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

629 
codec
, 
˘x
->
width
, ctx->
height
);

631 i‡(
	`ngx_πmp_mp4_∑r£
(
s
, 
pos
, 
œ°
Ë!
NGX_OK
) {

632  
NGX_ERROR
;

635 
˘x
->
åack
->
fhdr
 = (
u_ch¨
Ë˘x->åack->
codec
;

637  
NGX_OK
;

638 
	}
}

641 
ngx_öt_t


642 
	$ngx_πmp_mp4_∑r£_audio
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
,

643 
ngx_öt_t
 
codec
)

645 
ngx_πmp_mp4_˘x_t
 *
˘x
;

646 
u_ch¨
 *
p
;

647 
ngx_uöt_t
 
vîsi⁄
;

649 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

651 i‡(
˘x
->
åack
 =
NULL
) {

652  
NGX_OK
;

655 
˘x
->
åack
->
codec
 = codec;

657 i‡(
pos
 + 28 > 
œ°
) {

658  
NGX_ERROR
;

661 
pos
 += 8;

663 
vîsi⁄
 = 
	`ngx_πmp_r16
(*(
uöt16_t
 *Ë
pos
);

665 
pos
 += 8;

667 
˘x
->
nch™√ls
 = 
	`ngx_πmp_r16
(*(
uöt16_t
 *Ë
pos
);

669 
pos
 += 2;

671 
˘x
->
ßm∂e_size
 = 
	`ngx_πmp_r16
(*(
uöt16_t
 *Ë
pos
);

673 
pos
 += 6;

675 
˘x
->
ßm∂e_øã
 = 
	`ngx_πmp_r16
(*(
uöt16_t
 *Ë
pos
);

677 
pos
 += 4;

679 
p
 = &
˘x
->
åack
->
fhdr
;

681 *
p
 = 0;

683 i‡(
˘x
->
nch™√ls
 == 2) {

684 *
p
 |= 0x01;

687 i‡(
˘x
->
ßm∂e_size
 == 16) {

688 *
p
 |= 0x02;

691 
˘x
->
ßm∂e_øã
) {

696 *
p
 |= 0x04;

700 *
p
 |= 0x08;

704 *
p
 |= 0x0c;

708 
	`ngx_log_debug5
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

711 
vîsi⁄
, 
codec
, 
˘x
->
nch™√ls
, ctx->
ßm∂e_size
,

712 
˘x
->
ßm∂e_øã
);

714 
vîsi⁄
) {

716 
pos
 += 16;

720 
pos
 += 36;

723 i‡(
pos
 > 
œ°
) {

724  
NGX_ERROR
;

727 i‡(
	`ngx_πmp_mp4_∑r£
(
s
, 
pos
, 
œ°
Ë!
NGX_OK
) {

728  
NGX_ERROR
;

731 *
p
 |(
˘x
->
åack
->
codec
 << 4);

733  
NGX_OK
;

734 
	}
}

737 
ngx_öt_t


738 
	$ngx_πmp_mp4_∑r£_avc1
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

740  
	`ngx_πmp_mp4_∑r£_video
(
s
, 
pos
, 
œ°
, 
NGX_RTMP_VIDEO_H264
);

741 
	}
}

744 
ngx_öt_t


745 
	$ngx_πmp_mp4_∑r£_mp4v
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

747  
	`ngx_πmp_mp4_∑r£_video
(
s
, 
pos
, 
œ°
, 
NGX_RTMP_VIDEO_H264
);

748 
	}
}

751 
ngx_öt_t


752 
	$ngx_πmp_mp4_∑r£_avcC
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

754 
ngx_πmp_mp4_˘x_t
 *
˘x
;

756 i‡(
pos
 =
œ°
) {

757  
NGX_OK
;

760 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

762 i‡(
˘x
->
åack
 =
NULL
 || ctx->åack->
codec
 !
NGX_RTMP_VIDEO_H264
) {

763  
NGX_OK
;

766 
˘x
->
åack
->
hódî
 = 
pos
;

767 
˘x
->
åack
->
hódî_size
 = (
size_t
Ë(
œ°
 - 
pos
);

769 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

771 
˘x
->
åack
->
hódî_size
);

773  
NGX_OK
;

774 
	}
}

777 
ngx_öt_t


778 
	$ngx_πmp_mp4_∑r£_mp4a
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

780  
	`ngx_πmp_mp4_∑r£_audio
(
s
, 
pos
, 
œ°
, 
NGX_RTMP_AUDIO_MP3
);

781 
	}
}

784 
ngx_öt_t


785 
	$ngx_πmp_mp4_∑r£_ds
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

787 
ngx_πmp_mp4_˘x_t
 *
˘x
;

788 
ngx_πmp_mp4_åack_t
 *
t
;

790 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

792 
t
 = 
˘x
->
åack
;

794 i‡(
t
 =
NULL
) {

795  
NGX_OK
;

798 
t
->
hódî
 = 
pos
;

799 
t
->
hódî_size
 = (
size_t
Ë(
œ°
 - 
pos
);

801 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

802 "mp4: decodî hódî size=%uz", 
t
->
hódî_size
);

804  
NGX_OK
;

805 
	}
}

808 
ngx_öt_t


809 
	$ngx_πmp_mp4_∑r£_dc
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

811 
uöt8_t
 
id
;

812 
ngx_πmp_mp4_˘x_t
 *
˘x
;

813 
ngx_öt_t
 *
pc
;

815 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

817 i‡(
˘x
->
åack
 =
NULL
) {

818  
NGX_OK
;

821 i‡(
pos
 + 13 > 
œ°
) {

822  
NGX_ERROR
;

825 
id
 = * (
uöt8_t
 *Ë
pos
;

826 
pos
 += 13;

827 
pc
 = &
˘x
->
åack
->
codec
;

829 
id
) {

831 *
pc
 = 
NGX_RTMP_VIDEO_H264
;

838 *
pc
 = 
NGX_RTMP_AUDIO_AAC
;

843 *
pc
 = 
NGX_RTMP_AUDIO_MP3
;

847 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

849 (
ngx_öt_t
Ë
id
, *
pc
);

851  
	`ngx_πmp_mp4_∑r£_des¸
(
s
, 
pos
, 
œ°
);

852 
	}
}

855 
ngx_öt_t


856 
	$ngx_πmp_mp4_∑r£_es
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

858 
uöt16_t
 
id
;

859 
uöt8_t
 
Êags
;

861 i‡(
pos
 + 3 > 
œ°
) {

862  
NGX_ERROR
;

865 
id
 = 
	`ngx_πmp_r16
(*(
uöt16_t
 *Ë
pos
);

866 
pos
 += 2;

868 
Êags
 = *(
uöt8_t
 *Ë
pos
;

869 ++
pos
;

871 i‡(
Êags
 & 0x80) {

872 
pos
 += 2;

875 i‡(
Êags
 & 0x40) {

876  
NGX_OK
;

879 i‡(
Êags
 & 0x20) {

880 
pos
 += 2;

883 i‡(
pos
 > 
œ°
) {

884  
NGX_ERROR
;

887 (Ë
id
;

889 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

891 (
ngx_öt_t
Ë
id
, (ngx_öt_tË
Êags
);

893  
	`ngx_πmp_mp4_∑r£_des¸
(
s
, 
pos
, 
œ°
);

894 
	}
}

897 
ngx_öt_t


898 
	$ngx_πmp_mp4_∑r£_des¸
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

900 
uöt8_t
 
èg
, 
v
;

901 
uöt32_t
 
size
;

902 
ngx_uöt_t
 
n
, 
ndesc
;

903 
ngx_πmp_mp4_des¸ùt‹_t
 *
ds
;

905 
ndesc
 = (
ngx_πmp_mp4_des¸ùt‹s
)

906 / (
ngx_πmp_mp4_des¸ùt‹s
[0]);

908 
pos
 < 
œ°
) {

909 
èg
 = *(
uöt8_t
 *Ë
pos
++;

911 
size
 = 0, 
n
 = 0;Ç < 4; ++n) {

912 i‡(
pos
 =
œ°
) {

913  
NGX_ERROR
;

916 
v
 = *(
uöt8_t
 *Ë
pos
++;

918 
size
 = (sizê<< 7Ë| (
v
 & 0x7f);

920 i‡(!(
v
 & 0x80)) {

925 i‡(
pos
 + 
size
 > 
œ°
) {

926  
NGX_ERROR
;

929 
ds
 = 
ngx_πmp_mp4_des¸ùt‹s
;;

931 
n
 = 0;Ç < 
ndesc
; ++n, ++
ds
) {

932 i‡(
èg
 =
ds
->tag) {

937 i‡(
n
 =
ndesc
) {

938 
ds
 = 
NULL
;

941 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

943 
ds
 ? "" : " unh™dÀd", (
ngx_öt_t
Ë
èg
, 
size
);

945 i‡(
ds
 && ds->
	`h™dÀr
(
s
, 
pos
,Öo†+ 
size
Ë!
NGX_OK
) {

946  
NGX_ERROR
;

949 
pos
 +
size
;

952  
NGX_OK
;

953 
	}
}

956 
ngx_öt_t


957 
	$ngx_πmp_mp4_∑r£_esds
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

959 i‡(
pos
 + 4 > 
œ°
) {

960  
NGX_ERROR
;

963 
pos
 += 4;

965  
	`ngx_πmp_mp4_∑r£_des¸
(
s
, 
pos
, 
œ°
);

966 
	}
}

969 
ngx_öt_t


970 
	$ngx_πmp_mp4_∑r£_mp3
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

972  
	`ngx_πmp_mp4_∑r£_audio
(
s
, 
pos
, 
œ°
, 
NGX_RTMP_AUDIO_MP3
);

973 
	}
}

976 
ngx_öt_t


977 
	$ngx_πmp_mp4_∑r£_nmos
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

979  
	`ngx_πmp_mp4_∑r£_audio
(
s
, 
pos
, 
œ°
, 
NGX_RTMP_AUDIO_NELLY
);

980 
	}
}

983 
ngx_öt_t


984 
	$ngx_πmp_mp4_∑r£_•ex
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

986  
	`ngx_πmp_mp4_∑r£_audio
(
s
, 
pos
, 
œ°
, 
NGX_RTMP_AUDIO_SPEEX
);

987 
	}
}

990 
ngx_öt_t


991 
	$ngx_πmp_mp4_∑r£_°sd
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

993 i‡(
pos
 + 8 > 
œ°
) {

994  
NGX_ERROR
;

997 
pos
 += 8;

999 
	`ngx_πmp_mp4_∑r£
(
s
, 
pos
, 
œ°
);

1001  
NGX_OK
;

1002 
	}
}

1005 
ngx_öt_t


1006 
	$ngx_πmp_mp4_∑r£_°sc
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

1008 
ngx_πmp_mp4_˘x_t
 *
˘x
;

1009 
ngx_πmp_mp4_åack_t
 *
t
;

1011 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

1013 
t
 = 
˘x
->
åack
;

1015 i‡(
t
 =
NULL
) {

1016  
NGX_OK
;

1019 
t
->
chunks
 = (
ngx_πmp_mp4_chunks_t
 *Ë
pos
;

1021 i‡(
pos
 + (*
t
->
chunks
Ë+ 
	`ngx_πmp_r32
—->chunks->
íåy_cou¡
) *

1022 (
t
->
chunks
->
íåõs
[0])

1023 <
œ°
)

1025 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1027 
	`ngx_πmp_r32
(
t
->
chunks
->
íåy_cou¡
));

1028  
NGX_OK
;

1031 
t
->
chunks
 = 
NULL
;

1032  
NGX_ERROR
;

1033 
	}
}

1036 
ngx_öt_t


1037 
	$ngx_πmp_mp4_∑r£_°ts
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

1039 
ngx_πmp_mp4_˘x_t
 *
˘x
;

1040 
ngx_πmp_mp4_åack_t
 *
t
;

1042 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

1044 
t
 = 
˘x
->
åack
;

1046 i‡(
t
 =
NULL
) {

1047  
NGX_OK
;

1050 
t
->
times
 = (
ngx_πmp_mp4_times_t
 *Ë
pos
;

1052 i‡(
pos
 + (*
t
->
times
Ë+ 
	`ngx_πmp_r32
—->times->
íåy_cou¡
) *

1053 (
t
->
times
->
íåõs
[0])

1054 <
œ°
)

1056 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1058 
	`ngx_πmp_r32
(
t
->
times
->
íåy_cou¡
));

1059  
NGX_OK
;

1062 
t
->
times
 = 
NULL
;

1063  
NGX_ERROR
;

1064 
	}
}

1067 
ngx_öt_t


1068 
	$ngx_πmp_mp4_∑r£_˘ts
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

1070 
ngx_πmp_mp4_˘x_t
 *
˘x
;

1071 
ngx_πmp_mp4_åack_t
 *
t
;

1073 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

1075 
t
 = 
˘x
->
åack
;

1077 i‡(
t
 =
NULL
) {

1078  
NGX_OK
;

1081 
t
->
dñays
 = (
ngx_πmp_mp4_dñays_t
 *Ë
pos
;

1083 i‡(
pos
 + (*
t
->
dñays
Ë+ 
	`ngx_πmp_r32
—->dñays->
íåy_cou¡
) *

1084 (
t
->
dñays
->
íåõs
[0])

1085 <
œ°
)

1087 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1089 
	`ngx_πmp_r32
(
t
->
dñays
->
íåy_cou¡
));

1090  
NGX_OK
;

1093 
t
->
dñays
 = 
NULL
;

1094  
NGX_ERROR
;

1095 
	}
}

1098 
ngx_öt_t


1099 
	$ngx_πmp_mp4_∑r£_°ss
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

1101 
ngx_πmp_mp4_˘x_t
 *
˘x
;

1102 
ngx_πmp_mp4_åack_t
 *
t
;

1104 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

1106 
t
 = 
˘x
->
åack
;

1108 i‡(
t
 =
NULL
) {

1109  
NGX_OK
;

1112 
t
->
keys
 = (
ngx_πmp_mp4_keys_t
 *Ë
pos
;

1114 i‡(
pos
 + (*
t
->
keys
Ë+ 
	`ngx_πmp_r32
—->keys->
íåy_cou¡
) *

1115 (
t
->
keys
->
íåõs
[0])

1116 <
œ°
)

1118 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1120 
	`ngx_πmp_r32
(
t
->
keys
->
íåy_cou¡
));

1121  
NGX_OK
;

1124 
t
->
keys
 = 
NULL
;

1125  
NGX_ERROR
;

1126 
	}
}

1129 
ngx_öt_t


1130 
	$ngx_πmp_mp4_∑r£_°sz
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

1132 
ngx_πmp_mp4_˘x_t
 *
˘x
;

1133 
ngx_πmp_mp4_åack_t
 *
t
;

1135 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

1137 
t
 = 
˘x
->
åack
;

1139 i‡(
t
 =
NULL
) {

1140  
NGX_OK
;

1143 
t
->
sizes
 = (
ngx_πmp_mp4_sizes_t
 *Ë
pos
;

1145 i‡(
pos
 + (*
t
->
sizes
Ë<
œ°
 &&Å->sizes->
ßm∂e_size
) {

1146 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1148 
	`ngx_πmp_r32
(
t
->
sizes
->
ßm∂e_size
));

1149  
NGX_OK
;

1152 i‡(
pos
 + (*
t
->
sizes
Ë+ 
	`ngx_πmp_r32
—->sizes->
ßm∂e_cou¡
) *

1153 (
t
->
sizes
->
íåõs
[0])

1154 <
œ°
)

1157 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1159 
	`ngx_πmp_r32
(
t
->
sizes
->
ßm∂e_cou¡
));

1160  
NGX_OK
;

1163 
t
->
sizes
 = 
NULL
;

1164  
NGX_ERROR
;

1165 
	}
}

1168 
ngx_öt_t


1169 
	$ngx_πmp_mp4_∑r£_°z2
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

1171 
ngx_πmp_mp4_˘x_t
 *
˘x
;

1172 
ngx_πmp_mp4_åack_t
 *
t
;

1174 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

1176 
t
 = 
˘x
->
åack
;

1178 i‡(
t
 =
NULL
) {

1179  
NGX_OK
;

1182 
t
->
sizes2
 = (
ngx_πmp_mp4_sizes2_t
 *Ë
pos
;

1184 i‡(
pos
 + (*
t
->
sizes
Ë+ 
	`ngx_πmp_r32
—->
sizes2
->
ßm∂e_cou¡
) *

1185 
	`ngx_πmp_r32
(
t
->
sizes2
->
fõld_size
) / 8

1186 <
œ°
)

1188 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1190 
	`ngx_πmp_r32
(
t
->
sizes2
->
fõld_size
),

1191 
	`ngx_πmp_r32
(
t
->
sizes2
->
ßm∂e_cou¡
));

1192  
NGX_OK
;

1195 
t
->
sizes2
 = 
NULL
;

1196  
NGX_ERROR
;

1197 
	}
}

1200 
ngx_öt_t


1201 
	$ngx_πmp_mp4_∑r£_°co
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

1203 
ngx_πmp_mp4_˘x_t
 *
˘x
;

1204 
ngx_πmp_mp4_åack_t
 *
t
;

1206 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

1208 
t
 = 
˘x
->
åack
;

1210 i‡(
t
 =
NULL
) {

1211  
NGX_OK
;

1214 
t
->
off£ts
 = (
ngx_πmp_mp4_off£ts_t
 *Ë
pos
;

1216 i‡(
pos
 + (*
t
->
off£ts
Ë+ 
	`ngx_πmp_r32
—->off£ts->
íåy_cou¡
) *

1217 (
t
->
off£ts
->
íåõs
[0])

1218 <
œ°
)

1220 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1222 
	`ngx_πmp_r32
(
t
->
off£ts
->
íåy_cou¡
));

1223  
NGX_OK
;

1226 
t
->
off£ts
 = 
NULL
;

1227  
NGX_ERROR
;

1228 
	}
}

1231 
ngx_öt_t


1232 
	$ngx_πmp_mp4_∑r£_co64
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

1234 
ngx_πmp_mp4_˘x_t
 *
˘x
;

1235 
ngx_πmp_mp4_åack_t
 *
t
;

1237 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

1239 
t
 = 
˘x
->
åack
;

1241 i‡(
t
 =
NULL
) {

1242  
NGX_OK
;

1245 
t
->
off£ts64
 = (
ngx_πmp_mp4_off£ts64_t
 *Ë
pos
;

1247 i‡(
pos
 + (*
t
->
off£ts64
Ë+ 
	`ngx_πmp_r32
—->off£ts64->
íåy_cou¡
) *

1248 (
t
->
off£ts64
->
íåõs
[0])

1249 <
œ°
)

1251 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1253 
	`ngx_πmp_r32
(
t
->
off£ts64
->
íåy_cou¡
));

1254  
NGX_OK
;

1257 
t
->
off£ts64
 = 
NULL
;

1258  
NGX_ERROR
;

1259 
	}
}

1262 
ngx_öt_t


1263 
	$ngx_πmp_mp4_∑r£
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
pos
, u_ch¨ *
œ°
)

1265 
uöt32_t
 *
hdr
, 
èg
;

1266 
size_t
 
size
, 
nboxes
;

1267 
ngx_uöt_t
 
n
;

1268 
ngx_πmp_mp4_box_t
 *
b
;

1270 
pos
 !
œ°
) {

1271 i‡(
pos
 + 8 > 
œ°
) {

1272 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1273 "mp4:ÅoÿsmÆ»box: size=%i", 
œ°
 - 
pos
);

1274  
NGX_ERROR
;

1277 
hdr
 = (
uöt32_t
 *Ë
pos
;

1278 
size
 = 
	`ngx_πmp_r32
(
hdr
[0]);

1279 
èg
 = 
hdr
[1];

1281 i‡(
pos
 + 
size
 > 
œ°
) {

1282 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

1284 4, &
èg
, 
size
);

1285  
NGX_ERROR
;

1288 
b
 = 
ngx_πmp_mp4_boxes
;

1289 
nboxes
 = (
ngx_πmp_mp4_boxes
) / (ngx_rtmp_mp4_boxes[0]);

1291 
n
 = 0;Ç < 
nboxes
 && 
b
->
èg
 !=Åag; ++n, ++b);

1293 i‡(
n
 =
nboxes
) {

1294 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1295 "mp4: box unh™dÀd '%*s'", 4, &
èg
);

1297 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1298 "mp4: box '%*s'", 4, &
èg
);

1299 
b
->
	`h™dÀr
(
s
, 
pos
 + 8,Öo†+ 
size
);

1302 
pos
 +
size
;

1305  
NGX_OK
;

1306 
	}
}

1309 
ngx_öt_t


1310 
	$ngx_πmp_mp4_√xt_time
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_mp4_åack_t
 *
t
)

1312 
ngx_πmp_mp4_curs‹_t
 *
¸
;

1313 
ngx_πmp_mp4_time_íåy_t
 *
ã
;

1315 i‡(
t
->
times
 =
NULL
) {

1316  
NGX_ERROR
;

1319 
¸
 = &
t
->
curs‹
;

1321 i‡(
¸
->
time_pos
 >
	`ngx_πmp_r32
(
t
->
times
->
íåy_cou¡
)) {

1322 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1324 
t
->
id
, 
¸
->
time_pos
,

1325 
	`ngx_πmp_r32
(
t
->
times
->
íåy_cou¡
));

1327  
NGX_ERROR
;

1330 
ã
 = &
t
->
times
->
íåõs
[
¸
->
time_pos
];

1332 
¸
->
œ°_time°amp
 = cr->
time°amp
;

1333 
¸
->
time°amp
 +
	`ngx_πmp_r32
(
ã
->
ßm∂e_dñè
);

1335 
¸
->
nŸ_fú°
 = 1;

1337 
	`ngx_log_debug8
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1339 
t
->
id
, 
¸
->
pos
, cr->
time_pos
,

1340 
	`ngx_πmp_r32
(
t
->
times
->
íåy_cou¡
),

1341 
¸
->
time_cou¡
, 
	`ngx_πmp_r32
(
ã
->
ßm∂e_cou¡
),

1342 
	`ngx_πmp_r32
(
ã
->
ßm∂e_dñè
),

1343 
¸
->
time°amp
);

1345 
¸
->
time_cou¡
++;

1346 
¸
->
pos
++;

1348 i‡(
¸
->
time_cou¡
 >
	`ngx_πmp_r32
(
ã
->
ßm∂e_cou¡
)) {

1349 
¸
->
time_pos
++;

1350 
¸
->
time_cou¡
 = 0;

1353  
NGX_OK
;

1354 
	}
}

1357 
ngx_öt_t


1358 
	$ngx_πmp_mp4_£ek_time
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_mp4_åack_t
 *
t
,

1359 
uöt32_t
 
time°amp
)

1361 
ngx_πmp_mp4_curs‹_t
 *
¸
;

1362 
ngx_πmp_mp4_time_íåy_t
 *
ã
;

1363 
uöt32_t
 
dt
;

1365 i‡(
t
->
times
 =
NULL
) {

1366  
NGX_ERROR
;

1369 
¸
 = &
t
->
curs‹
;

1371 
ã
 = 
t
->
times
->
íåõs
;

1373 
¸
->
time_pos
 < 
	`ngx_πmp_r32
(
t
->
times
->
íåy_cou¡
)) {

1374 
dt
 = 
	`ngx_πmp_r32
(
ã
->
ßm∂e_dñè
Ë*Çgx_πmp_r32—e->
ßm∂e_cou¡
);

1376 i‡(
¸
->
time°amp
 + 
dt
 >=Åimestamp) {

1377 i‡(
ã
->
ßm∂e_dñè
 == 0) {

1378  
NGX_ERROR
;

1381 
¸
->
time_cou¡
 = (
time°amp
 - cr->timestamp) /

1382 
	`ngx_πmp_r32
(
ã
->
ßm∂e_dñè
);

1383 
¸
->
time°amp
 +
	`ngx_πmp_r32
(
ã
->
ßm∂e_dñè
Ë* cr->
time_cou¡
;

1384 
¸
->
pos
 +¸->
time_cou¡
;

1389 
¸
->
time°amp
 +
dt
;

1390 
¸
->
pos
 +
	`ngx_πmp_r32
(
ã
->
ßm∂e_cou¡
);

1391 
¸
->
time_pos
++;

1392 
ã
++;

1395 i‡(
¸
->
time_pos
 >
	`ngx_πmp_r32
(
t
->
times
->
íåy_cou¡
)) {

1396 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1398 
t
->
id
, 
¸
->
time_pos
,

1399 
	`ngx_πmp_r32
(
t
->
times
->
íåy_cou¡
));

1401  
NGX_ERROR
;

1404 
	`ngx_log_debug8
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1407 
t
->
id
, 
¸
->
pos
, cr->
time_pos
,

1408 
	`ngx_πmp_r32
(
t
->
times
->
íåy_cou¡
),

1409 
¸
->
time_cou¡
,

1410 
	`ngx_πmp_r32
(
ã
->
ßm∂e_cou¡
),

1411 
	`ngx_πmp_r32
(
ã
->
ßm∂e_dñè
),

1412 
¸
->
time°amp
);

1414  
NGX_OK
;

1415 
	}
}

1418 
ngx_öt_t


1419 
	$ngx_πmp_mp4_upd©e_off£t
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_mp4_åack_t
 *
t
)

1421 
ngx_πmp_mp4_curs‹_t
 *
¸
;

1422 
ngx_uöt_t
 
chunk
;

1424 
¸
 = &
t
->
curs‹
;

1426 i‡(
¸
->
chunk
 < 1) {

1427 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1429 
t
->
id
, 
¸
->
chunk
);

1430  
NGX_ERROR
;

1433 
chunk
 = 
¸
->chunk - 1;

1435 i‡(
t
->
off£ts
) {

1436 i‡(
chunk
 >
	`ngx_πmp_r32
(
t
->
off£ts
->
íåy_cou¡
)) {

1437 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1439 
t
->
id
, 
¸
->
chunk
,

1440 
	`ngx_πmp_r32
(
t
->
off£ts
->
íåy_cou¡
));

1442  
NGX_ERROR
;

1445 
¸
->
off£t
 = (
off_t
Ë
	`ngx_πmp_r32
(
t
->
off£ts
->
íåõs
[
chunk
]);

1446 
¸
->
size
 = 0;

1448 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1450 
t
->
id
, 
¸
->
chunk
,

1451 
	`ngx_πmp_r32
(
t
->
off£ts
->
íåy_cou¡
),

1452 
¸
->
off£t
);

1454  
NGX_OK
;

1457 i‡(
t
->
off£ts64
) {

1458 i‡(
chunk
 >
	`ngx_πmp_r32
(
t
->
off£ts64
->
íåy_cou¡
)) {

1459 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1461 
t
->
id
, 
¸
->
chunk
,

1462 
	`ngx_πmp_r32
(
t
->
off£ts
->
íåy_cou¡
));

1464  
NGX_ERROR
;

1467 
¸
->
off£t
 = (
off_t
Ë
	`ngx_πmp_r64
(
t
->
off£ts64
->
íåõs
[
chunk
]);

1468 
¸
->
size
 = 0;

1470 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1472 
t
->
id
, 
¸
->
chunk
,

1473 
	`ngx_πmp_r32
(
t
->
off£ts
->
íåy_cou¡
),

1474 
¸
->
off£t
);

1476  
NGX_OK
;

1479  
NGX_ERROR
;

1480 
	}
}

1483 
ngx_öt_t


1484 
	$ngx_πmp_mp4_√xt_chunk
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_mp4_åack_t
 *
t
)

1486 
ngx_πmp_mp4_curs‹_t
 *
¸
;

1487 
ngx_πmp_mp4_chunk_íåy_t
 *
˚
, *
n˚
;

1488 
ngx_öt_t
 
√w_chunk
;

1490 i‡(
t
->
chunks
 =
NULL
) {

1491  
NGX_OK
;

1494 
¸
 = &
t
->
curs‹
;

1496 i‡(
¸
->
chunk_pos
 >
	`ngx_πmp_r32
(
t
->
chunks
->
íåy_cou¡
)) {

1497 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1499 
t
->
id
, 
¸
->
chunk_pos
,

1500 
	`ngx_πmp_r32
(
t
->
chunks
->
íåy_cou¡
));

1502  
NGX_ERROR
;

1505 
˚
 = &
t
->
chunks
->
íåõs
[
¸
->
chunk_pos
];

1507 
¸
->
chunk_cou¡
++;

1509 i‡(
¸
->
chunk_cou¡
 >
	`ngx_πmp_r32
(
˚
->
ßm∂es_≥r_chunk
)) {

1510 
¸
->
chunk_cou¡
 = 0;

1511 
¸
->
chunk
++;

1513 i‡(
¸
->
chunk_pos
 + 1 < 
	`ngx_πmp_r32
(
t
->
chunks
->
íåy_cou¡
)) {

1514 
n˚
 = 
˚
 + 1;

1515 i‡(
¸
->
chunk
 >
	`ngx_πmp_r32
(
n˚
->
fú°_chunk
)) {

1516 
¸
->
chunk_pos
++;

1517 
˚
 = 
n˚
;

1521 
√w_chunk
 = 1;

1524 
√w_chunk
 = 0;

1527 
	`ngx_log_debug7
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1529 
t
->
id
, 
¸
->
chunk_pos
,

1530 
	`ngx_πmp_r32
(
t
->
chunks
->
íåy_cou¡
),

1531 
	`ngx_πmp_r32
(
˚
->
fú°_chunk
),

1532 
¸
->
chunk
, cr->
chunk_cou¡
,

1533 
	`ngx_πmp_r32
(
˚
->
ßm∂es_≥r_chunk
));

1536 i‡(
√w_chunk
) {

1537  
	`ngx_πmp_mp4_upd©e_off£t
(
s
, 
t
);

1540  
NGX_OK
;

1541 
	}
}

1544 
ngx_öt_t


1545 
	$ngx_πmp_mp4_£ek_chunk
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_mp4_åack_t
 *
t
)

1547 
ngx_πmp_mp4_curs‹_t
 *
¸
;

1548 
ngx_πmp_mp4_chunk_íåy_t
 *
˚
, *
n˚
;

1549 
ngx_uöt_t
 
pos
, 
dpos
, 
dchunk
;

1551 
¸
 = &
t
->
curs‹
;

1553 i‡(
t
->
chunks
 =
NULL
 ||Å->chunks->
íåy_cou¡
 == 0) {

1554 
¸
->
chunk
 = 1;

1555  
NGX_OK
;

1558 
˚
 = 
t
->
chunks
->
íåõs
;

1559 
pos
 = 0;

1561 
¸
->
chunk_pos
 + 1 < 
	`ngx_πmp_r32
(
t
->
chunks
->
íåy_cou¡
)) {

1562 
n˚
 = 
˚
 + 1;

1564 
dpos
 = (
	`ngx_πmp_r32
(
n˚
->
fú°_chunk
) -

1565 
	`ngx_πmp_r32
(
˚
->
fú°_chunk
)) *

1566 
	`ngx_πmp_r32
(
˚
->
ßm∂es_≥r_chunk
);

1568 i‡(
pos
 + 
dpos
 > 
¸
->pos) {

1572 
pos
 +
dpos
;

1573 
˚
++;

1574 
¸
->
chunk_pos
++;

1577 i‡(
˚
->
ßm∂es_≥r_chunk
 == 0) {

1578  
NGX_ERROR
;

1581 
dchunk
 = (
¸
->
pos
 -ÖosË/ 
	`ngx_πmp_r32
(
˚
->
ßm∂es_≥r_chunk
);

1583 
¸
->
chunk
 = 
	`ngx_πmp_r32
(
˚
->
fú°_chunk
Ë+ 
dchunk
;

1584 
¸
->
chunk_pos
 = (
ngx_uöt_t
Ë(
˚
 - 
t
->
chunks
->
íåõs
);

1585 
¸
->
chunk_cou¡
 = (
ngx_uöt_t
Ë(¸->
pos
 -Öo†- 
dchunk
 *

1586 
	`ngx_πmp_r32
(
˚
->
ßm∂es_≥r_chunk
));

1588 
	`ngx_log_debug7
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1590 
t
->
id
, 
¸
->
chunk_pos
,

1591 
	`ngx_πmp_r32
(
t
->
chunks
->
íåy_cou¡
),

1592 
	`ngx_πmp_r32
(
˚
->
fú°_chunk
),

1593 
¸
->
chunk
, cr->
chunk_cou¡
,

1594 
	`ngx_πmp_r32
(
˚
->
ßm∂es_≥r_chunk
));

1596  
	`ngx_πmp_mp4_upd©e_off£t
(
s
, 
t
);

1597 
	}
}

1600 
ngx_öt_t


1601 
	$ngx_πmp_mp4_√xt_size
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_mp4_åack_t
 *
t
)

1603 
ngx_πmp_mp4_curs‹_t
 *
¸
;

1605 
¸
 = &
t
->
curs‹
;

1607 
¸
->
off£t
 +¸->
size
;

1609 i‡(
t
->
sizes
) {

1610 i‡(
t
->
sizes
->
ßm∂e_size
) {

1611 
¸
->
size
 = 
	`ngx_πmp_r32
(
t
->
sizes
->
ßm∂e_size
);

1613 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1615 
t
->
id
, 
¸
->
size
);

1617  
NGX_OK
;

1620 
¸
->
size_pos
++;

1622 i‡(
¸
->
size_pos
 >
	`ngx_πmp_r32
(
t
->
sizes
->
ßm∂e_cou¡
)) {

1623 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1625 
t
->
id
, 
¸
->
size_pos
,

1626 
	`ngx_πmp_r32
(
t
->
sizes
->
ßm∂e_cou¡
));

1628  
NGX_ERROR
;

1631 
¸
->
size
 = 
	`ngx_πmp_r32
(
t
->
sizes
->
íåõs
[¸->
size_pos
]);

1633 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1635 
t
->
id
, 
¸
->
size_pos
,

1636 
	`ngx_πmp_r32
(
t
->
sizes
->
ßm∂e_cou¡
),

1637 
¸
->
size
);

1639  
NGX_OK
;

1642 i‡(
t
->
sizes2
) {

1643 i‡(
¸
->
size_pos
 >
	`ngx_πmp_r32
(
t
->
sizes2
->
ßm∂e_cou¡
)) {

1644 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1646 
t
->
id
, 
¸
->
size_pos
,

1647 
	`ngx_πmp_r32
(
t
->
sizes2
->
ßm∂e_cou¡
));

1649  
NGX_ERROR
;

1654  
NGX_OK
;

1657  
NGX_ERROR
;

1658 
	}
}

1661 
ngx_öt_t


1662 
	$ngx_πmp_mp4_£ek_size
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_mp4_åack_t
 *
t
)

1664 
ngx_πmp_mp4_curs‹_t
 *
¸
;

1665 
ngx_uöt_t
 
pos
;

1667 
¸
 = &
t
->
curs‹
;

1669 i‡(
¸
->
chunk_cou¡
 > cr->
pos
) {

1670  
NGX_ERROR
;

1673 i‡(
t
->
sizes
) {

1674 i‡(
t
->
sizes
->
ßm∂e_size
) {

1675 
¸
->
size
 = 
	`ngx_πmp_r32
(
t
->
sizes
->
ßm∂e_size
);

1677 
¸
->
off£t
 +¸->
size
 * cr->
chunk_cou¡
;

1679 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1681 
t
->
id
, 
¸
->
size
);

1683  
NGX_OK
;

1686 i‡(
¸
->
pos
 >
	`ngx_πmp_r32
(
t
->
sizes
->
ßm∂e_cou¡
)) {

1687 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1689 
t
->
id
, 
¸
->
pos
,

1690 
	`ngx_πmp_r32
(
t
->
sizes
->
ßm∂e_cou¡
));

1692  
NGX_ERROR
;

1695 
pos
 = 1;Öo†<
¸
->
chunk_cou¡
; ++pos) {

1696 
¸
->
off£t
 +
	`ngx_πmp_r32
(
t
->
sizes
->
íåõs
[¸->
pos
 -Öos]);

1699 
¸
->
size_pos
 = cr->
pos
;

1700 
¸
->
size
 = 
	`ngx_πmp_r32
(
t
->
sizes
->
íåõs
[¸->
size_pos
]);

1702 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1704 
t
->
id
, 
¸
->
size_pos
,

1705 
	`ngx_πmp_r32
(
t
->
sizes
->
ßm∂e_cou¡
),

1706 
¸
->
size
);

1708  
NGX_OK
;

1711 i‡(
t
->
sizes2
) {

1712 i‡(
¸
->
size_pos
 >
	`ngx_πmp_r32
(
t
->
sizes2
->
ßm∂e_cou¡
)) {

1713 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1715 
t
->
id
, 
¸
->
size_pos
,

1716 
	`ngx_πmp_r32
(
t
->
sizes
->
ßm∂e_cou¡
));

1718  
NGX_ERROR
;

1721 
¸
->
size_pos
 = cr->
pos
;

1724  
NGX_OK
;

1727  
NGX_ERROR
;

1728 
	}
}

1731 
ngx_öt_t


1732 
	$ngx_πmp_mp4_√xt_key
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_mp4_åack_t
 *
t
)

1734 
ngx_πmp_mp4_curs‹_t
 *
¸
;

1735 
uöt32_t
 *
ke
;

1737 
¸
 = &
t
->
curs‹
;

1739 i‡(
t
->
keys
 =
NULL
) {

1740  
NGX_OK
;

1743 i‡(
¸
->
key
) {

1744 
¸
->
key_pos
++;

1747 i‡(
¸
->
key_pos
 >
	`ngx_πmp_r32
(
t
->
keys
->
íåy_cou¡
)) {

1748 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1750 
t
->
id
, 
¸
->
key_pos
,

1751 
	`ngx_πmp_r32
(
t
->
keys
->
íåy_cou¡
));

1753 
¸
->
key
 = 0;

1755  
NGX_OK
;

1758 
ke
 = &
t
->
keys
->
íåõs
[
¸
->
key_pos
];

1759 
¸
->
key
 = (¸->
pos
 + 1 =
	`ngx_πmp_r32
(*
ke
));

1761 
	`ngx_log_debug6
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1763 
t
->
id
, 
¸
->
key_pos
,

1764 
	`ngx_πmp_r32
(
t
->
keys
->
íåy_cou¡
),

1765 
¸
->
pos
, 
	`ngx_πmp_r32
(*
ke
),

1766 
¸
->
key
 ? "match" : "miss");

1768  
NGX_OK
;

1769 
	}
}

1772 
ngx_öt_t


1773 
	$ngx_πmp_mp4_£ek_key
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_mp4_åack_t
 *
t
)

1775 
ngx_πmp_mp4_curs‹_t
 *
¸
;

1776 
uöt32_t
 *
ke
;

1777 
ngx_öt_t
 
dpos
;

1779 
¸
 = &
t
->
curs‹
;

1781 i‡(
t
->
keys
 =
NULL
) {

1782  
NGX_OK
;

1785 
¸
->
key_pos
 < 
	`ngx_πmp_r32
(
t
->
keys
->
íåy_cou¡
)) {

1786 i‡(
	`ngx_πmp_r32
(
t
->
keys
->
íåõs
[
¸
->
key_pos
]Ë> cr->
pos
) {

1790 
¸
->
key_pos
++;

1793 i‡(
¸
->
key_pos
 >
	`ngx_πmp_r32
(
t
->
keys
->
íåy_cou¡
)) {

1794 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1796 
t
->
id
, 
¸
->
key_pos
,

1797 
	`ngx_πmp_r32
(
t
->
keys
->
íåy_cou¡
));

1798  
NGX_OK
;

1801 
ke
 = &
t
->
keys
->
íåõs
[
¸
->
key_pos
];

1805 
dpos
 = 
	`ngx_πmp_r32
(*
ke
Ë- 
¸
->
pos
 - 1;

1806 
¸
->
key
 = 1;

1809 ; 
dpos
 > 0; --dpos) {

1810 
	`ngx_πmp_mp4_√xt_time
(
s
, 
t
);

1815 
	`ngx_log_debug6
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1817 
t
->
id
, 
¸
->
key_pos
,

1818 
	`ngx_πmp_r32
(
t
->
keys
->
íåy_cou¡
),

1819 
¸
->
pos
, 
	`ngx_πmp_r32
(*
ke
),

1820 
¸
->
key
 ? "match" : "miss");

1822  
NGX_OK
;

1823 
	}
}

1826 
ngx_öt_t


1827 
	$ngx_πmp_mp4_√xt_dñay
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_mp4_åack_t
 *
t
)

1829 
ngx_πmp_mp4_curs‹_t
 *
¸
;

1830 
ngx_πmp_mp4_dñay_íåy_t
 *
de
;

1832 
¸
 = &
t
->
curs‹
;

1834 i‡(
t
->
dñays
 =
NULL
) {

1835  
NGX_OK
;

1838 i‡(
¸
->
dñay_pos
 >
	`ngx_πmp_r32
(
t
->
dñays
->
íåy_cou¡
)) {

1839 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1841 
t
->
id
, 
¸
->
dñay_pos
,

1842 
	`ngx_πmp_r32
(
t
->
dñays
->
íåy_cou¡
));

1844  
NGX_OK
;

1847 
¸
->
dñay_cou¡
++;

1848 
de
 = &
t
->
dñays
->
íåõs
[
¸
->
dñay_pos
];

1850 i‡(
¸
->
dñay_cou¡
 >
	`ngx_πmp_r32
(
de
->
ßm∂e_cou¡
)) {

1851 
¸
->
dñay_pos
++;

1852 
de
++;

1853 
¸
->
dñay_cou¡
 = 0;

1856 i‡(
¸
->
dñay_pos
 >
	`ngx_πmp_r32
(
t
->
dñays
->
íåy_cou¡
)) {

1857 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1859 
t
->
id
, 
¸
->
dñay_pos
,

1860 
	`ngx_πmp_r32
(
t
->
dñays
->
íåy_cou¡
));

1862  
NGX_OK
;

1865 
¸
->
dñay
 = 
	`ngx_πmp_r32
(
de
->
ßm∂e_off£t
);

1867 
	`ngx_log_debug6
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1869 
t
->
id
, 
¸
->
dñay_pos
,

1870 
	`ngx_πmp_r32
(
t
->
dñays
->
íåy_cou¡
),

1871 
¸
->
dñay_cou¡
,

1872 
	`ngx_πmp_r32
(
de
->
ßm∂e_cou¡
), 
¸
->
dñay
);

1874  
NGX_OK
;

1875 
	}
}

1878 
ngx_öt_t


1879 
	$ngx_πmp_mp4_£ek_dñay
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_mp4_åack_t
 *
t
)

1881 
ngx_πmp_mp4_curs‹_t
 *
¸
;

1882 
ngx_πmp_mp4_dñay_íåy_t
 *
de
;

1883 
uöt32_t
 
pos
, 
dpos
;

1885 
¸
 = &
t
->
curs‹
;

1887 i‡(
t
->
dñays
 =
NULL
) {

1888  
NGX_OK
;

1891 
pos
 = 0;

1892 
de
 = 
t
->
dñays
->
íåõs
;

1894 
¸
->
dñay_pos
 < 
	`ngx_πmp_r32
(
t
->
dñays
->
íåy_cou¡
)) {

1895 
dpos
 = 
	`ngx_πmp_r32
(
de
->
ßm∂e_cou¡
);

1897 i‡(
pos
 + 
dpos
 > 
¸
->pos) {

1898 
¸
->
dñay_cou¡
 = cr->
pos
 -Öos;

1899 
¸
->
dñay
 = 
	`ngx_πmp_r32
(
de
->
ßm∂e_off£t
);

1903 
¸
->
dñay_pos
++;

1904 
pos
 +
dpos
;

1905 
de
++;

1908 i‡(
¸
->
dñay_pos
 >
	`ngx_πmp_r32
(
t
->
dñays
->
íåy_cou¡
)) {

1909 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1911 
t
->
id
, 
¸
->
dñay_pos
,

1912 
	`ngx_πmp_r32
(
t
->
dñays
->
íåy_cou¡
));

1914  
NGX_OK
;

1917 
	`ngx_log_debug6
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1919 
t
->
id
, 
¸
->
dñay_pos
,

1920 
	`ngx_πmp_r32
(
t
->
dñays
->
íåy_cou¡
),

1921 
¸
->
dñay_cou¡
,

1922 
	`ngx_πmp_r32
(
de
->
ßm∂e_cou¡
), 
¸
->
dñay
);

1924  
NGX_OK
;

1925 
	}
}

1928 
ngx_öt_t


1929 
	$ngx_πmp_mp4_√xt
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_mp4_åack_t
 *
t
)

1931 i‡(
	`ngx_πmp_mp4_√xt_time
(
s
, 
t
Ë!
NGX_OK
 ||

1932 
	`ngx_πmp_mp4_√xt_key
(
s
, 
t
Ë!
NGX_OK
 ||

1933 
	`ngx_πmp_mp4_√xt_chunk
(
s
, 
t
Ë!
NGX_OK
 ||

1934 
	`ngx_πmp_mp4_√xt_size
(
s
, 
t
Ë!
NGX_OK
 ||

1935 
	`ngx_πmp_mp4_√xt_dñay
(
s
, 
t
Ë!
NGX_OK
)

1937 
t
->
curs‹
.
vÆid
 = 0;

1938  
NGX_ERROR
;

1941 
t
->
curs‹
.
vÆid
 = 1;

1942  
NGX_OK
;

1943 
	}
}

1946 
ngx_öt_t


1947 
	$ngx_πmp_mp4_£nd_mëa
(
ngx_πmp_£ssi⁄_t
 *
s
)

1949 
ngx_πmp_mp4_˘x_t
 *
˘x
;

1950 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

1951 
ngx_öt_t
 
rc
;

1952 
ngx_uöt_t
 
n
;

1953 
ngx_πmp_hódî_t
 
h
;

1954 
ngx_chaö_t
 *
out
;

1955 
ngx_πmp_mp4_åack_t
 *
t
;

1956 
d
;

1959 
width
;

1960 
height
;

1961 
duøti⁄
;

1962 
video_codec_id
;

1963 
audio_codec_id
;

1964 
audio_ßm∂e_øã
;

1965 } 
v
;

1967 
ngx_πmp_amf_ñt_t
 
out_öf
[] = {

1969 { 
NGX_RTMP_AMF_NUMBER
,

1970 
	`ngx_°rög
("width"),

1971 &
v
.
width
, 0 },

1973 { 
NGX_RTMP_AMF_NUMBER
,

1974 
	`ngx_°rög
("height"),

1975 &
v
.
height
, 0 },

1977 { 
NGX_RTMP_AMF_NUMBER
,

1978 
	`ngx_°rög
("displayWidth"),

1979 &
v
.
width
, 0 },

1981 { 
NGX_RTMP_AMF_NUMBER
,

1982 
	`ngx_°rög
("displayHeight"),

1983 &
v
.
height
, 0 },

1985 { 
NGX_RTMP_AMF_NUMBER
,

1986 
	`ngx_°rög
("duration"),

1987 &
v
.
duøti⁄
, 0 },

1989 { 
NGX_RTMP_AMF_NUMBER
,

1990 
	`ngx_°rög
("videocodecid"),

1991 &
v
.
video_codec_id
, 0 },

1993 { 
NGX_RTMP_AMF_NUMBER
,

1994 
	`ngx_°rög
("audiocodecid"),

1995 &
v
.
audio_codec_id
, 0 },

1997 { 
NGX_RTMP_AMF_NUMBER
,

1998 
	`ngx_°rög
("audiosamplerate"),

1999 &
v
.
audio_ßm∂e_øã
, 0 },

2002 
ngx_πmp_amf_ñt_t
 
out_ñts
[] = {

2004 { 
NGX_RTMP_AMF_STRING
,

2005 
ngx_nuŒ_°rög
,

2008 { 
NGX_RTMP_AMF_OBJECT
,

2009 
ngx_nuŒ_°rög
,

2010 
out_öf
, (out_inf) },

2013 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

2014 i‡(
˘x
 =
NULL
) {

2015  
NGX_OK
;

2018 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

2020 
	`ngx_memzîo
(&
v
, (v));

2022 
v
.
width
 = 
˘x
->width;

2023 
v
.
height
 = 
˘x
->height;

2024 
v
.
audio_ßm∂e_øã
 = 
˘x
->
ßm∂e_øã
;

2026 
t
 = &
˘x
->
åacks
[0];

2027 
n
 = 0;Ç < 
˘x
->
¡øcks
; ++n, ++
t
) {

2028 
d
 = 
	`ngx_πmp_mp4_to_πmp_time°amp
(
t
,Å->
duøti⁄
) / 1000.;

2030 i‡(
v
.
duøti⁄
 < 
d
) {

2031 
v
.
duøti⁄
 = 
d
;

2034 
t
->
ty≥
) {

2035 
NGX_RTMP_MSG_AUDIO
:

2036 
v
.
audio_codec_id
 = 
t
->
codec
;

2038 
NGX_RTMP_MSG_VIDEO
:

2039 
v
.
video_codec_id
 = 
t
->
codec
;

2044 
out
 = 
NULL
;

2045 
rc
 = 
	`ngx_πmp_≠≥nd_amf
(
s
, &
out
, 
NULL
, 
out_ñts
,

2046 (
out_ñts
) / (out_elts[0]));

2047 i‡(
rc
 !
NGX_OK
 || 
out
 =
NULL
) {

2048  
NGX_ERROR
;

2051 
	`ngx_memzîo
(&
h
, (h));

2053 
h
.
csid
 = 
NGX_RTMP_CSID_AMF
;

2054 
h
.
msid
 = 
NGX_RTMP_MSID
;

2055 
h
.
ty≥
 = 
NGX_RTMP_MSG_AMF_META
;

2057 
	`ngx_πmp_¥ï¨e_mesßge
(
s
, &
h
, 
NULL
, 
out
);

2058 
rc
 = 
	`ngx_πmp_£nd_mesßge
(
s
, 
out
, 0);

2059 
	`ngx_πmp_‰ì_sh¨ed_chaö
(
cscf
, 
out
);

2061  
rc
;

2062 
	}
}

2065 
ngx_öt_t


2066 
	$ngx_πmp_mp4_£ek_åack
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_mp4_åack_t
 *
t
,

2067 
ngx_öt_t
 
time°amp
)

2069 
ngx_πmp_mp4_curs‹_t
 *
¸
;

2071 
¸
 = &
t
->
curs‹
;

2072 
	`ngx_memzîo
(
¸
, (*cr));

2074 i‡(
	`ngx_πmp_mp4_£ek_time
(
s
, 
t
, 
	`ngx_πmp_mp4_‰om_πmp_time°amp
(

2075 
t
, 
time°amp
)Ë!
NGX_OK
 ||

2076 
	`ngx_πmp_mp4_£ek_key
(
s
, 
t
Ë!
NGX_OK
 ||

2077 
	`ngx_πmp_mp4_£ek_chunk
(
s
, 
t
Ë!
NGX_OK
 ||

2078 
	`ngx_πmp_mp4_£ek_size
(
s
, 
t
Ë!
NGX_OK
 ||

2079 
	`ngx_πmp_mp4_£ek_dñay
(
s
, 
t
Ë!
NGX_OK
)

2081  
NGX_ERROR
;

2084 
¸
->
vÆid
 = 1;

2085  
NGX_OK
;

2086 
	}
}

2089 
ngx_öt_t


2090 
	$ngx_πmp_mp4_£nd
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
, 
ngx_uöt_t
 *
ts
)

2092 
ngx_πmp_mp4_˘x_t
 *
˘x
;

2093 
ngx_buf_t
 
ö_buf
;

2094 
ngx_πmp_hódî_t
 
h
, 
lh
;

2095 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

2096 
ngx_chaö_t
 *
out
, 
ö
;

2097 
ngx_πmp_mp4_åack_t
 *
t
, *
cur_t
;

2098 
ngx_πmp_mp4_curs‹_t
 *
¸
, *
cur_¸
;

2099 
uöt32_t
 
buÊí
, 
íd_time°amp
,

2100 
time°amp
, 
œ°_time°amp
, 
rdñay
,

2101 
cur_time°amp
;

2102 
ssize_t
 
ªt
;

2103 
u_ch¨
 
fhdr
[5];

2104 
size_t
 
fhdr_size
;

2105 
ngx_öt_t
 
rc
;

2106 
ngx_uöt_t
 
n
, 
cou¡î
;

2108 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

2110 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

2112 i‡(
˘x
 =
NULL
) {

2113  
NGX_ERROR
;

2116 i‡(!
˘x
->
mëa_£¡
) {

2117 
rc
 = 
	`ngx_πmp_mp4_£nd_mëa
(
s
);

2119 i‡(
rc
 =
NGX_OK
) {

2120 
˘x
->
mëa_£¡
 = 1;

2123  
rc
;

2126 
buÊí
 = 
s
->buÊí + 
NGX_RTMP_MP4_BUFLEN_ADDON
;

2128 
cou¡î
 = 0;

2129 
œ°_time°amp
 = 0;

2130 
íd_time°amp
 = 
˘x
->
°¨t_time°amp
 +

2131 (
ngx_cuºít_m£c
 - 
˘x
->
ïoch
Ë+ 
buÊí
;

2134 
cou¡î
++;

2135 i‡(
cou¡î
 > 
NGX_RTMP_MP4_MAX_FRAMES
) {

2136  
NGX_OK
;

2139 
time°amp
 = 0;

2140 
t
 = 
NULL
;

2142 
n
 = 0;Ç < 
˘x
->
¡øcks
;Ç++) {

2143 
cur_t
 = &
˘x
->
åacks
[
n
];

2144 
cur_¸
 = &
cur_t
->
curs‹
;

2146 i‡(!
cur_¸
->
vÆid
) {

2150 
cur_time°amp
 = 
	`ngx_πmp_mp4_to_πmp_time°amp
(
cur_t
,

2151 
cur_¸
->
time°amp
);

2153 i‡(
t
 =
NULL
 || 
cur_time°amp
 < 
time°amp
) {

2154 
time°amp
 = 
cur_time°amp
;

2155 
t
 = 
cur_t
;

2159 i‡(
t
 =
NULL
) {

2160 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

2162  
NGX_DONE
;

2165 i‡(
time°amp
 > 
íd_time°amp
) {

2166 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

2168 
t
->
id
, 
time°amp
, 
íd_time°amp
);

2170 i‡(
ts
) {

2171 *
ts
 = 
œ°_time°amp
;

2174  (
uöt32_t
Ë(
time°amp
 - 
íd_time°amp
);

2177 
¸
 = &
t
->
curs‹
;

2179 
œ°_time°amp
 = 
	`ngx_πmp_mp4_to_πmp_time°amp
(
t
, 
¸
->last_timestamp);

2181 
	`ngx_memzîo
(&
h
, (h));

2183 
h
.
msid
 = 
NGX_RTMP_MSID
;

2184 
h
.
ty≥
 = (
uöt8_t
Ë
t
->type;

2185 
h
.
csid
 = 
t
->csid;

2187 
lh
 = 
h
;

2189 
h
.
time°amp
 =Åimestamp;

2190 
lh
.
time°amp
 = 
œ°_time°amp
;

2192 
	`ngx_memzîo
(&
ö
, (in));

2193 
	`ngx_memzîo
(&
ö_buf
, (in_buf));

2195 i‡(
t
->
hódî
 && !t->
hódî_£¡
) {

2196 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

2198 
t
->
id
,Å->
hódî_size
);

2200 
fhdr
[0] = 
t
->fhdr;

2201 
fhdr
[1] = 0;

2203 i‡(
t
->
ty≥
 =
NGX_RTMP_MSG_VIDEO
) {

2204 
fhdr
[0] |= 0x10;

2205 
fhdr
[2] = fhdr[3] = fhdr[4] = 0;

2206 
fhdr_size
 = 5;

2208 
fhdr_size
 = 2;

2211 
ö
.
buf
 = &
ö_buf
;

2212 
ö_buf
.
pos
 = 
fhdr
;

2213 
ö_buf
.
œ°
 = 
fhdr
 + 
fhdr_size
;

2215 
out
 = 
	`ngx_πmp_≠≥nd_sh¨ed_bufs
(
cscf
, 
NULL
, &
ö
);

2217 
ö
.
buf
 = &
ö_buf
;

2218 
ö_buf
.
pos
 = 
t
->
hódî
;

2219 
ö_buf
.
œ°
 = 
t
->
hódî
 +Å->
hódî_size
;

2221 
	`ngx_πmp_≠≥nd_sh¨ed_bufs
(
cscf
, 
out
, &
ö
);

2223 
	`ngx_πmp_¥ï¨e_mesßge
(
s
, &
h
, 
NULL
, 
out
);

2224 
rc
 = 
	`ngx_πmp_£nd_mesßge
(
s
, 
out
, 0);

2225 
	`ngx_πmp_‰ì_sh¨ed_chaö
(
cscf
, 
out
);

2227 i‡(
rc
 =
NGX_AGAIN
) {

2228  
NGX_AGAIN
;

2231 
t
->
hódî_£¡
 = 1;

2234 
	`ngx_log_debug5
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

2237 
t
->
id
, 
¸
->
off£t
, cr->
size
, 
time°amp
,

2238 
œ°_time°amp
);

2240 
ngx_πmp_mp4_buf„r
[0] = 
t
->
fhdr
;

2241 
fhdr_size
 = 1;

2243 i‡(
t
->
ty≥
 =
NGX_RTMP_MSG_VIDEO
) {

2244 i‡(
¸
->
key
) {

2245 
ngx_πmp_mp4_buf„r
[0] |= 0x10;

2246 } i‡(
¸
->
dñay
) {

2247 
ngx_πmp_mp4_buf„r
[0] |= 0x20;

2249 
ngx_πmp_mp4_buf„r
[0] |= 0x30;

2252 i‡(
t
->
hódî
) {

2253 
fhdr_size
 = 5;

2255 
rdñay
 = 
	`ngx_πmp_mp4_to_πmp_time°amp
(
t
, 
¸
->
dñay
);

2257 
ngx_πmp_mp4_buf„r
[1] = 1;

2258 
ngx_πmp_mp4_buf„r
[2] = (
rdñay
 >> 16) & 0xff;

2259 
ngx_πmp_mp4_buf„r
[3] = (
rdñay
 >> 8) & 0xff;

2260 
ngx_πmp_mp4_buf„r
[4] = 
rdñay
 & 0xff;

2264 i‡(
t
->
hódî
) {

2265 
fhdr_size
 = 2;

2266 
ngx_πmp_mp4_buf„r
[1] = 1;

2270 i‡(
¸
->
size
 + 
fhdr_size
 > (
ngx_πmp_mp4_buf„r
)) {

2271 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

2273 
t
->
id
, 
¸
->
size
, (
ngx_πmp_mp4_buf„r
));

2274 
√xt
;

2277 
ªt
 = 
	`ngx_ªad_fûe
(
f
, 
ngx_πmp_mp4_buf„r
 + 
fhdr_size
,

2278 
¸
->
size
, cr->
off£t
);

2280 i‡(
ªt
 !(
ssize_t
Ë
¸
->
size
) {

2281 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

2282 "mp4:Åøck#%uòcouldÇŸÑód føme", 
t
->
id
);

2283 
√xt
;

2286 
ö
.
buf
 = &
ö_buf
;

2287 
ö_buf
.
pos
 = 
ngx_πmp_mp4_buf„r
;

2288 
ö_buf
.
œ°
 = 
ngx_πmp_mp4_buf„r
 + 
¸
->
size
 + 
fhdr_size
;

2290 
out
 = 
	`ngx_πmp_≠≥nd_sh¨ed_bufs
(
cscf
, 
NULL
, &
ö
);

2292 
	`ngx_πmp_¥ï¨e_mesßge
(
s
, &
h
, 
¸
->
nŸ_fú°
 ? &
lh
 : 
NULL
, 
out
);

2293 
rc
 = 
	`ngx_πmp_£nd_mesßge
(
s
, 
out
, 0);

2294 
	`ngx_πmp_‰ì_sh¨ed_chaö
(
cscf
, 
out
);

2296 i‡(
rc
 =
NGX_AGAIN
) {

2297  
NGX_AGAIN
;

2300 
s
->
cuºít_time
 = 
time°amp
;

2302 
√xt
:

2303 i‡(
	`ngx_πmp_mp4_√xt
(
s
, 
t
Ë!
NGX_OK
) {

2304  
NGX_DONE
;

2307 
	}
}

2310 
ngx_öt_t


2311 
	$ngx_πmp_mp4_öô
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
, 
ngx_öt_t
 
aödex
,

2312 
ngx_öt_t
 
vödex
)

2314 
ngx_πmp_mp4_˘x_t
 *
˘x
;

2315 
uöt32_t
 
hdr
[2];

2316 
ssize_t
 
n
;

2317 
size_t
 
off£t
, 
∑ge_off£t
, 
size
, 
shi·
;

2318 
uöt64_t
 
exãnded_size
;

2319 
ngx_fûe_öfo_t
 
fi
;

2321 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

2323 i‡(
˘x
 =
NULL
) {

2324 
˘x
 = 
	`ngx_∑Œoc
(
s
->
c⁄√˘i⁄
->
poﬁ
, (
ngx_πmp_mp4_˘x_t
));

2326 i‡(
˘x
 =
NULL
) {

2327  
NGX_ERROR
;

2330 
	`ngx_πmp_£t_˘x
(
s
, 
˘x
, 
ngx_πmp_mp4_moduÀ
);

2333 
	`ngx_memzîo
(
˘x
, (*ctx));

2335 
˘x
->
aödex
 =áindex;

2336 
˘x
->
vödex
 = vindex;

2338 
off£t
 = 0;

2339 
size
 = 0;

2342 
n
 = 
	`ngx_ªad_fûe
(
f
, (
u_ch¨
 *Ë&
hdr
, (hdr), 
off£t
);

2344 i‡(
n
 !(
hdr
)) {

2345 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

2347 "whûê£¨chög f‹ moov box", 
off£t
);

2348  
NGX_ERROR
;

2351 
size
 = (
size_t
Ë
	`ngx_πmp_r32
(
hdr
[0]);

2352 
shi·
 = (
hdr
);

2354 i‡(
size
 == 1) {

2355 
n
 = 
	`ngx_ªad_fûe
(
f
, (
u_ch¨
 *Ë&
exãnded_size
,

2356 (
exãnded_size
), 
off£t
 + (
hdr
));

2358 i‡(
n
 !(
exãnded_size
)) {

2359 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

2361 "whûê£¨chög f‹ moov box", 
off£t
 + 8);

2362  
NGX_ERROR
;

2365 
size
 = (
size_t
Ë
	`ngx_πmp_r64
(
exãnded_size
);

2366 
shi·
 +(
exãnded_size
);

2368 } i‡(
size
 == 0) {

2369 i‡(
	`ngx_fd_öfo
(
f
->
fd
, &
fi
Ë=
NGX_FILE_ERROR
) {

2370 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

2371 "mp4: " 
ngx_fd_öfo_n
 " failed");

2372  
NGX_ERROR
;

2374 
size
 = 
	`ngx_fûe_size
(&
fi
Ë- 
off£t
;

2377 i‡(
hdr
[1] =
	`ngx_πmp_mp4_make_èg
('m','o','o','v')) {

2378 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

2383 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

2384 "mp4: skùpög box '%*s'", 4, 
hdr
 + 1);

2386 
off£t
 +
size
;

2389 i‡(
size
 < 
shi·
) {

2390  
NGX_ERROR
;

2393 
size
 -
shi·
;

2394 
off£t
 +
shi·
;

2396 
∑ge_off£t
 = 
off£t
 & (
ngx_∑gesize
 - 1);

2397 
˘x
->
mm≠ed_size
 = 
∑ge_off£t
 + 
size
;

2399 
˘x
->
mm≠ed
 = 
	`ngx_πmp_mp4_mm≠
(
f
->
fd
, ctx->
mm≠ed_size
,

2400 
off£t
 - 
∑ge_off£t
, &
˘x
->
exåa
);

2401 i‡(
˘x
->
mm≠ed
 =
NULL
) {

2402 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

2404 
off£t
, 
size
);

2405  
NGX_ERROR
;

2408  
	`ngx_πmp_mp4_∑r£
(
s
, (
u_ch¨
 *Ë
˘x
->
mm≠ed
 + 
∑ge_off£t
,

2409 (
u_ch¨
 *Ë
˘x
->
mm≠ed
 + 
∑ge_off£t
 + 
size
);

2410 
	}
}

2413 
ngx_öt_t


2414 
	$ngx_πmp_mp4_d⁄e
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
)

2416 
ngx_πmp_mp4_˘x_t
 *
˘x
;

2418 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

2420 i‡(
˘x
 =
NULL
 || ctx->
mm≠ed
 == NULL) {

2421  
NGX_OK
;

2424 i‡(
	`ngx_πmp_mp4_munm≠
(
˘x
->
mm≠ed
, ctx->
mm≠ed_size
, &˘x->
exåa
)

2425 !
NGX_OK
)

2427 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

2429  
NGX_ERROR
;

2432 
˘x
->
mm≠ed
 = 
NULL
;

2433 
˘x
->
mm≠ed_size
 = 0;

2435  
NGX_OK
;

2436 
	}
}

2439 
ngx_öt_t


2440 
	$ngx_πmp_mp4_£ek
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
, 
ngx_uöt_t
 
time°amp
)

2442 
ngx_πmp_mp4_˘x_t
 *
˘x
;

2443 
ngx_πmp_mp4_åack_t
 *
t
;

2444 
ngx_uöt_t
 
n
;

2446 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

2448 i‡(
˘x
 =
NULL
) {

2449  
NGX_OK
;

2452 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

2453 "mp4: sìkÅime°amp=%ui", 
time°amp
);

2455 
n
 = 0;Ç < 
˘x
->
¡øcks
; ++n) {

2456 
t
 = &
˘x
->
åacks
[
n
];

2458 i‡(
t
->
ty≥
 !
NGX_RTMP_MSG_VIDEO
) {

2462 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

2463 "mp4:Åøck#%uò£ek video", 
n
);

2465 
	`ngx_πmp_mp4_£ek_åack
(
s
, 
t
, 
time°amp
);

2467 
time°amp
 = 
	`ngx_πmp_mp4_to_πmp_time°amp
(
t
,Å->
curs‹
.timestamp);

2472 
n
 = 0;Ç < 
˘x
->
¡øcks
; ++n) {

2473 
t
 = &
˘x
->
åacks
[
n
];

2475 i‡(
t
->
ty≥
 =
NGX_RTMP_MSG_VIDEO
) {

2479 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

2480 "mp4:Åøck#%uò£ek", 
n
);

2482 
	`ngx_πmp_mp4_£ek_åack
(
s
, &
˘x
->
åacks
[
n
], 
time°amp
);

2485 
˘x
->
°¨t_time°amp
 = 
time°amp
;

2486 
˘x
->
ïoch
 = 
ngx_cuºít_m£c
;

2488  
	`ngx_πmp_mp4_ª£t
(
s
);

2489 
	}
}

2492 
ngx_öt_t


2493 
	$ngx_πmp_mp4_°¨t
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
)

2495 
ngx_πmp_mp4_˘x_t
 *
˘x
;

2497 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

2499 i‡(
˘x
 =
NULL
) {

2500  
NGX_OK
;

2503 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

2504 "mp4: sèπÅime°amp=%uD", 
˘x
->
°¨t_time°amp
);

2506 
˘x
->
ïoch
 = 
ngx_cuºít_m£c
;

2508  
NGX_OK
;

2509 
	}
}

2512 
ngx_öt_t


2513 
	$ngx_πmp_mp4_ª£t
(
ngx_πmp_£ssi⁄_t
 *
s
)

2515 
ngx_πmp_mp4_˘x_t
 *
˘x
;

2516 
ngx_πmp_mp4_curs‹_t
 *
¸
;

2517 
ngx_πmp_mp4_åack_t
 *
t
;

2518 
ngx_uöt_t
 
n
;

2520 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

2522 i‡(
˘x
 =
NULL
) {

2523  
NGX_OK
;

2526 
t
 = &
˘x
->
åacks
[0];

2527 
n
 = 0;Ç < 
˘x
->
¡øcks
; ++n, ++
t
) {

2528 
¸
 = &
t
->
curs‹
;

2529 
¸
->
nŸ_fú°
 = 0;

2532  
NGX_OK
;

2533 
	}
}

2536 
ngx_öt_t


2537 
	$ngx_πmp_mp4_°›
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_fûe_t
 *
f
)

2539 
ngx_πmp_mp4_˘x_t
 *
˘x
;

2541 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_mp4_moduÀ
);

2543 i‡(
˘x
 =
NULL
) {

2544  
NGX_OK
;

2547 
˘x
->
°¨t_time°amp
 +(
ngx_cuºít_m£c
 - ctx->
ïoch
);

2549 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

2550 "mp4: st›Åime°amp=%uD", 
˘x
->
°¨t_time°amp
);

2552  
NGX_OK
;

2553 
	}
}

2556 
ngx_öt_t


2557 
	$ngx_πmp_mp4_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
)

2559 
ngx_πmp_∂ay_maö_c⁄f_t
 *
pmcf
;

2560 
ngx_πmp_∂ay_fmt_t
 **
pfmt
, *
fmt
;

2562 
pmcf
 = 
	`ngx_πmp_c⁄f_gë_moduÀ_maö_c⁄f
(
cf
, 
ngx_πmp_∂ay_moduÀ
);

2564 
pfmt
 = 
	`ngx_¨øy_push
(&
pmcf
->
fmts
);

2566 i‡(
pfmt
 =
NULL
) {

2567  
NGX_ERROR
;

2570 
fmt
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_∂ay_fmt_t
));

2572 i‡(
fmt
 =
NULL
) {

2573  
NGX_ERROR
;

2576 *
pfmt
 = 
fmt
;

2578 
	`ngx_°r_£t
(&
fmt
->
«me
, "mp4-format");

2580 
	`ngx_°r_£t
(&
fmt
->
pfx
, "mp4:");

2581 
	`ngx_°r_£t
(&
fmt
->
sfx
, ".mp4");

2583 
fmt
->
öô
 = 
ngx_πmp_mp4_öô
;

2584 
fmt
->
d⁄e
 = 
ngx_πmp_mp4_d⁄e
;

2585 
fmt
->
£ek
 = 
ngx_πmp_mp4_£ek
;

2586 
fmt
->
°¨t
 = 
ngx_πmp_mp4_°¨t
;

2587 
fmt
->
°›
 = 
ngx_πmp_mp4_°›
;

2588 
fmt
->
£nd
 = 
ngx_πmp_mp4_£nd
;

2590  
NGX_OK
;

2591 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_netcall_module.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp_√tˇŒ_moduÀ.h
"

12 
ngx_öt_t
 
ngx_πmp_√tˇŒ_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
);

13 * 
ngx_πmp_√tˇŒ_¸óã_§v_c⁄f
(
ngx_c⁄f_t
 *
cf
);

14 * 
ngx_πmp_√tˇŒ_mîge_§v_c⁄f
(
ngx_c⁄f_t
 *
cf
,

15 *
∑ª¡
, *
chûd
);

17 
ngx_πmp_√tˇŒ_˛o£
(
ngx_c⁄√˘i⁄_t
 *
cc
);

18 
ngx_πmp_√tˇŒ_dëach
(
ngx_c⁄√˘i⁄_t
 *
cc
);

20 
ngx_πmp_√tˇŒ_ªcv
(
ngx_evít_t
 *
ªv
);

21 
ngx_πmp_√tˇŒ_£nd
(
ngx_evít_t
 *
wev
);

25 
ngx_m£c_t
 
	mtimeout
;

26 
size_t
 
	mbufsize
;

27 
ngx_log_t
 *
	mlog
;

28 } 
	tngx_πmp_√tˇŒ_§v_c⁄f_t
;

31 
	sngx_πmp_√tˇŒ_£ssi⁄_s
 {

32 
ngx_πmp_£ssi⁄_t
 *
	m£ssi⁄
;

33 
ngx_≥î_c⁄√˘i⁄_t
 *
	mpc
;

34 
ngx_uæ_t
 *
	muæ
;

35 
ngx_πmp_√tˇŒ_£ssi⁄_s
 *
	m√xt
;

36 *
	m¨g
;

37 
ngx_πmp_√tˇŒ_h™dÀ_±
 
	mh™dÀ
;

38 
ngx_πmp_√tˇŒ_fûãr_±
 
	mfûãr
;

39 
ngx_πmp_√tˇŒ_sök_±
 
	msök
;

40 
ngx_chaö_t
 *
	mö
;

41 
ngx_chaö_t
 *
	möœ°
;

42 
ngx_chaö_t
 *
	mout
;

43 
ngx_m£c_t
 
	mtimeout
;

44 
	mdëached
:1;

45 
size_t
 
	mbufsize
;

46 } 
	tngx_πmp_√tˇŒ_£ssi⁄_t
;

50 
ngx_πmp_√tˇŒ_£ssi⁄_t
 *
	mcs
;

51 } 
	tngx_πmp_√tˇŒ_˘x_t
;

54 
ngx_comm™d_t
 
	gngx_πmp_√tˇŒ_comm™ds
[] = {

56 { 
ngx_°rög
("netcall_timeout"),

57 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_CONF_TAKE1
,

58 
ngx_c⁄f_£t_m£c_¶Ÿ
,

59 
NGX_RTMP_SRV_CONF_OFFSET
,

60 
off£tof
(
ngx_πmp_√tˇŒ_§v_c⁄f_t
, 
timeout
),

61 
NULL
 },

63 { 
ngx_°rög
("netcall_buffer"),

64 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_CONF_TAKE1
,

65 
ngx_c⁄f_£t_size_¶Ÿ
,

66 
NGX_RTMP_SRV_CONF_OFFSET
,

67 
off£tof
(
ngx_πmp_√tˇŒ_§v_c⁄f_t
, 
bufsize
),

68 
NULL
 },

70 
ngx_nuŒ_comm™d


74 
ngx_πmp_moduÀ_t
 
	gngx_πmp_√tˇŒ_moduÀ_˘x
 = {

75 
NULL
,

76 
ngx_πmp_√tˇŒ_po°c⁄figuøti⁄
,

77 
NULL
,

78 
NULL
,

79 
ngx_πmp_√tˇŒ_¸óã_§v_c⁄f
,

80 
ngx_πmp_√tˇŒ_mîge_§v_c⁄f
,

81 
NULL
,

82 
NULL


86 
ngx_moduÀ_t
 
	gngx_πmp_√tˇŒ_moduÀ
 = {

87 
NGX_MODULE_V1
,

88 &
ngx_πmp_√tˇŒ_moduÀ_˘x
,

89 
ngx_πmp_√tˇŒ_comm™ds
,

90 
NGX_RTMP_MODULE
,

91 
NULL
,

92 
NULL
,

93 
NULL
,

94 
NULL
,

95 
NULL
,

96 
NULL
,

97 
NULL
,

98 
NGX_MODULE_V1_PADDING


103 
	$ngx_πmp_√tˇŒ_¸óã_§v_c⁄f
(
ngx_c⁄f_t
 *
cf
)

105 
ngx_πmp_√tˇŒ_§v_c⁄f_t
 *
nscf
;

107 
nscf
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_√tˇŒ_§v_c⁄f_t
));

108 i‡(
nscf
 =
NULL
) {

109  
NULL
;

112 
nscf
->
timeout
 = 
NGX_CONF_UNSET_MSEC
;

113 
nscf
->
bufsize
 = 
NGX_CONF_UNSET_SIZE
;

115 
nscf
->
log
 = &
cf
->
cy˛e
->
√w_log
;

117  
nscf
;

118 
	}
}

122 
	$ngx_πmp_√tˇŒ_mîge_§v_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
∑ª¡
, *
chûd
)

124 
ngx_πmp_√tˇŒ_§v_c⁄f_t
 *
¥ev
 = 
∑ª¡
;

125 
ngx_πmp_√tˇŒ_§v_c⁄f_t
 *
c⁄f
 = 
chûd
;

127 
	`ngx_c⁄f_mîge_m£c_vÆue
(
c⁄f
->
timeout
, 
¥ev
->timeout, 10000);

128 
	`ngx_c⁄f_mîge_size_vÆue
(
c⁄f
->
bufsize
, 
¥ev
->bufsize, 1024);

130  
NGX_CONF_OK
;

131 
	}
}

134 
ngx_öt_t


135 
	$ngx_πmp_√tˇŒ_disc⁄√˘
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

136 
ngx_chaö_t
 *
ö
)

138 
ngx_πmp_√tˇŒ_˘x_t
 *
˘x
;

139 
ngx_πmp_√tˇŒ_£ssi⁄_t
 *
cs
;

141 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_√tˇŒ_moduÀ
);

143 i‡(
˘x
) {

144 
cs
 = 
˘x
->cs; cs; c†cs->
√xt
) {

145 
	`ngx_πmp_√tˇŒ_dëach
(
cs
->
pc
->
c⁄√˘i⁄
);

149  
NGX_OK
;

150 
	}
}

153 
ngx_öt_t


154 
	$ngx_πmp_√tˇŒ_gë_≥î
(
ngx_≥î_c⁄√˘i⁄_t
 *
pc
, *
d©a
)

156 
ngx_πmp_√tˇŒ_£ssi⁄_t
 *
cs
 = 
d©a
;

158 
pc
->
sockaddr
 =(sockadd∏*)&
cs
->
uæ
->sockaddr;

159 
pc
->
sockÀn
 = 
cs
->
uæ
->socklen;

160 
pc
->
«me
 = &
cs
->
uæ
->
ho°
;

162  
NGX_OK
;

163 
	}
}

167 
	$ngx_πmp_√tˇŒ_‰ì_≥î
(
ngx_≥î_c⁄√˘i⁄_t
 *
pc
, *
d©a
,

168 
ngx_uöt_t
 
°©e
)

170 
	}
}

173 
ngx_öt_t


174 
	$ngx_πmp_√tˇŒ_¸óã
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_√tˇŒ_öô_t
 *
ci
)

176 
ngx_πmp_√tˇŒ_˘x_t
 *
˘x
;

177 
ngx_≥î_c⁄√˘i⁄_t
 *
pc
;

178 
ngx_πmp_√tˇŒ_£ssi⁄_t
 *
cs
;

179 
ngx_πmp_√tˇŒ_§v_c⁄f_t
 *
nscf
;

180 
ngx_c⁄√˘i⁄_t
 *
c
, *
cc
;

181 
ngx_poﬁ_t
 *
poﬁ
;

182 
ngx_öt_t
 
rc
;

184 
poﬁ
 = 
NULL
;

185 
c
 = 
s
->
c⁄√˘i⁄
;

187 
nscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_√tˇŒ_moduÀ
);

188 i‡(
nscf
 =
NULL
) {

189 
îr‹
;

193 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_√tˇŒ_moduÀ
);

194 i‡(
˘x
 =
NULL
) {

195 
˘x
 = 
	`ngx_pˇŒoc
(
c
->
poﬁ
,

196 (
ngx_πmp_√tˇŒ_˘x_t
));

197 i‡(
˘x
 =
NULL
) {

198  
NGX_ERROR
;

200 
	`ngx_πmp_£t_˘x
(
s
, 
˘x
, 
ngx_πmp_√tˇŒ_moduÀ
);

207 
poﬁ
 = 
	`ngx_¸óã_poﬁ
(4096, 
nscf
->
log
);

208 i‡(
poﬁ
 =
NULL
) {

209 
îr‹
;

212 
pc
 = 
	`ngx_pˇŒoc
(
poﬁ
, (
ngx_≥î_c⁄√˘i⁄_t
));

213 i‡(
pc
 =
NULL
) {

214 
îr‹
;

217 
cs
 = 
	`ngx_pˇŒoc
(
poﬁ
, (
ngx_πmp_√tˇŒ_£ssi⁄_t
));

218 i‡(
cs
 =
NULL
) {

219 
îr‹
;

223 i‡(
ci
->
¨gsize
) {

224 
cs
->
¨g
 = 
	`ngx_pˇŒoc
(
poﬁ
, 
ci
->
¨gsize
);

225 i‡(
cs
->
¨g
 =
NULL
) {

226 
îr‹
;

228 
	`ngx_mem˝y
(
cs
->
¨g
, 
ci
->¨g, ci->
¨gsize
);

231 
cs
->
timeout
 = 
nscf
->timeout;

232 
cs
->
bufsize
 = 
nscf
->bufsize;

233 
cs
->
uæ
 = 
ci
->url;

234 
cs
->
£ssi⁄
 = 
s
;

235 
cs
->
fûãr
 = 
ci
->filter;

236 
cs
->
sök
 = 
ci
->sink;

237 
cs
->
h™dÀ
 = 
ci
->handle;

238 i‡(
cs
->
h™dÀ
 =
NULL
) {

239 
cs
->
dëached
 = 1;

242 
pc
->
log
 = 
nscf
->log;

243 
pc
->
gë
 = 
ngx_πmp_√tˇŒ_gë_≥î
;

244 
pc
->
‰ì
 = 
ngx_πmp_√tˇŒ_‰ì_≥î
;

245 
pc
->
d©a
 = 
cs
;

248 
rc
 = 
	`ngx_evít_c⁄√˘_≥î
(
pc
);

249 i‡(
rc
 !
NGX_OK
 &&Ñ¯!
NGX_AGAIN
 ) {

250 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

252 
îr‹
;

255 
cc
 = 
pc
->
c⁄√˘i⁄
;

256 
cc
->
d©a
 = 
cs
;

257 
cc
->
poﬁ
 =Öool;

258 
cs
->
pc
 =Öc;

260 
cs
->
out
 = 
ci
->
	`¸óã
(
s
, ci->
¨g
, 
poﬁ
);

261 i‡(
cs
->
out
 =
NULL
) {

262 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

264 
	`ngx_˛o£_c⁄√˘i⁄
(
pc
->
c⁄√˘i⁄
);

265 
îr‹
;

268 
cc
->
wrôe
->
h™dÀr
 = 
ngx_πmp_√tˇŒ_£nd
;

269 
cc
->
ªad
->
h™dÀr
 = 
ngx_πmp_√tˇŒ_ªcv
;

271 i‡(!
cs
->
dëached
) {

272 
cs
->
√xt
 = 
˘x
->cs;

273 
˘x
->
cs
 = cs;

276 
	`ngx_πmp_√tˇŒ_£nd
(
cc
->
wrôe
);

278  
c
->
de°royed
 ? 
NGX_ERROR
 : 
NGX_OK
;

280 
îr‹
:

281 i‡(
poﬁ
) {

282 
	`ngx_de°roy_poﬁ
(
poﬁ
);

285  
NGX_ERROR
;

286 
	}
}

290 
	$ngx_πmp_√tˇŒ_˛o£
(
ngx_c⁄√˘i⁄_t
 *
cc
)

292 
ngx_πmp_√tˇŒ_£ssi⁄_t
 *
cs
, **
css
;

293 
ngx_poﬁ_t
 *
poﬁ
;

294 
ngx_πmp_£ssi⁄_t
 *
s
;

295 
ngx_πmp_√tˇŒ_˘x_t
 *
˘x
;

296 
ngx_buf_t
 *
b
;

298 
cs
 = 
cc
->
d©a
;

300 i‡(
cc
->
de°royed
) {

304 
cc
->
de°royed
 = 1;

306 i‡(!
cs
->
dëached
) {

307 
s
 = 
cs
->
£ssi⁄
;

308 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_√tˇŒ_moduÀ
);

310 i‡(
cs
->
ö
 && cs->
sök
) {

311 
cs
->
	`sök
(cs->
£ssi⁄
, cs->
ö
);

313 
b
 = 
cs
->
ö
->
buf
;

314 
b
->
pos
 = b->
œ°
 = b->
°¨t
;

318 
css
 = &
˘x
->
cs
; *css; cs†&((*css)->
√xt
)) {

319 i‡(*
css
 =
cs
) {

320 *
css
 = 
cs
->
√xt
;

325 i‡(
cs
->
h™dÀ
 && cs->
	`h™dÀ
(
s
, cs->
¨g
, cs->
ö
Ë!
NGX_OK
) {

326 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

330 
poﬁ
 = 
cc
->pool;

331 
	`ngx_˛o£_c⁄√˘i⁄
(
cc
);

332 
	`ngx_de°roy_poﬁ
(
poﬁ
);

333 
	}
}

337 
	$ngx_πmp_√tˇŒ_dëach
(
ngx_c⁄√˘i⁄_t
 *
cc
)

339 
ngx_πmp_√tˇŒ_£ssi⁄_t
 *
cs
;

341 
cs
 = 
cc
->
d©a
;

342 
cs
->
dëached
 = 1;

343 
	}
}

347 
	$ngx_πmp_√tˇŒ_ªcv
(
ngx_evít_t
 *
ªv
)

349 
ngx_πmp_√tˇŒ_£ssi⁄_t
 *
cs
;

350 
ngx_c⁄√˘i⁄_t
 *
cc
;

351 
ngx_chaö_t
 *
˛
;

352 
ngx_öt_t
 
n
;

353 
ngx_buf_t
 *
b
;

355 
cc
 = 
ªv
->
d©a
;

356 
cs
 = 
cc
->
d©a
;

358 i‡(
cc
->
de°royed
) {

362 i‡(
ªv
->
timedout
) {

363 
cc
->
timedout
 = 1;

364 
	`ngx_πmp_√tˇŒ_˛o£
(
cc
);

368 i‡(
ªv
->
timî_£t
) {

369 
	`ngx_dñ_timî
(
ªv
);

374 i‡(
cs
->
öœ°
 =
NULL
 ||

375 
cs
->
öœ°
->
buf
->
œ°
 =cs->öœ°->buf->
íd
)

377 i‡(
cs
->
ö
 && cs->
sök
) {

378 i‡(!
cs
->
dëached
) {

379 i‡(
cs
->
	`sök
(cs->
£ssi⁄
, cs->
ö
Ë!
NGX_OK
) {

380 
	`ngx_πmp_√tˇŒ_˛o£
(
cc
);

385 
b
 = 
cs
->
ö
->
buf
;

386 
b
->
pos
 = b->
œ°
 = b->
°¨t
;

389 
˛
 = 
	`ngx_Æloc_chaö_lök
(
cc
->
poﬁ
);

390 i‡(
˛
 =
NULL
) {

391 
	`ngx_πmp_√tˇŒ_˛o£
(
cc
);

395 
˛
->
√xt
 = 
NULL
;

397 
˛
->
buf
 = 
	`ngx_¸óã_ãmp_buf
(
cc
->
poﬁ
, 
cs
->
bufsize
);

398 i‡(
˛
->
buf
 =
NULL
) {

399 
	`ngx_πmp_√tˇŒ_˛o£
(
cc
);

403 i‡(
cs
->
ö
 =
NULL
) {

404 
cs
->
ö
 = 
˛
;

406 
cs
->
öœ°
->
√xt
 = 
˛
;

409 
cs
->
öœ°
 = 
˛
;

413 
b
 = 
cs
->
öœ°
->
buf
;

415 
n
 = 
cc
->
	`ªcv
(cc, 
b
->
œ°
, b->
íd
 - b->last);

417 i‡(
n
 =
NGX_ERROR
 ||Ç == 0) {

418 
	`ngx_πmp_√tˇŒ_˛o£
(
cc
);

422 i‡(
n
 =
NGX_AGAIN
) {

423 i‡(
cs
->
fûãr
 && cs->
ö


424 && 
cs
->
	`fûãr
(cs->
ö
Ë!
NGX_AGAIN
)

426 
	`ngx_πmp_√tˇŒ_˛o£
(
cc
);

430 
	`ngx_add_timî
(
ªv
, 
cs
->
timeout
);

431 i‡(
	`ngx_h™dÀ_ªad_evít
(
ªv
, 0Ë!
NGX_OK
) {

432 
	`ngx_πmp_√tˇŒ_˛o£
(
cc
);

437 
b
->
œ°
 +
n
;

439 
	}
}

443 
	$ngx_πmp_√tˇŒ_£nd
(
ngx_evít_t
 *
wev
)

445 
ngx_πmp_√tˇŒ_£ssi⁄_t
 *
cs
;

446 
ngx_c⁄√˘i⁄_t
 *
cc
;

447 
ngx_chaö_t
 *
˛
;

449 
cc
 = 
wev
->
d©a
;

450 
cs
 = 
cc
->
d©a
;

452 i‡(
cc
->
de°royed
) {

456 i‡(
wev
->
timedout
) {

457 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
cc
->
log
, 
NGX_ETIMEDOUT
,

459 
cc
->
timedout
 = 1;

460 
	`ngx_πmp_√tˇŒ_˛o£
(
cc
);

464 i‡(
wev
->
timî_£t
) {

465 
	`ngx_dñ_timî
(
wev
);

468 
˛
 = 
cc
->
	`£nd_chaö
(cc, 
cs
->
out
, 0);

470 i‡(
˛
 =
NGX_CHAIN_ERROR
) {

471 
	`ngx_πmp_√tˇŒ_˛o£
(
cc
);

475 
cs
->
out
 = 
˛
;

478 i‡(
˛
) {

479 
	`ngx_add_timî
(
wev
, 
cs
->
timeout
);

480 i‡(
	`ngx_h™dÀ_wrôe_evít
(
wev
, 0Ë!
NGX_OK
) {

481 
	`ngx_πmp_√tˇŒ_˛o£
(
cc
);

488 
	`ngx_dñ_evít
(
wev
, 
NGX_WRITE_EVENT
, 0);

490 
	`ngx_πmp_√tˇŒ_ªcv
(
cc
->
ªad
);

491 
	}
}

494 
ngx_chaö_t
 *

495 
	$ngx_πmp_√tˇŒ_hâp_f‹m©_ªque°
(
ngx_öt_t
 
mëhod
, 
ngx_°r_t
 *
ho°
,

496 
ngx_°r_t
 *
uri
, 
ngx_chaö_t
 *
¨gs
,

497 
ngx_chaö_t
 *
body
, 
ngx_poﬁ_t
 *
poﬁ
,

498 
ngx_°r_t
 *
c⁄ã¡_ty≥
)

500 
ngx_chaö_t
 *
Æ
, *
bl
, *
ªt
;

501 
ngx_buf_t
 *
b
;

502 
size_t
 
c⁄ã¡_Àngth
;

503 c⁄° *
mëhods
[2] = { "GET", "POST" };

504 c⁄° 
rq_tm∂
[] = " HTTP/1.0\r\n"

511 
c⁄ã¡_Àngth
 = 0;

512 
Æ
 = 
body
;ál;á»Æ->
√xt
) {

513 
b
 = 
Æ
->
buf
;

514 
c⁄ã¡_Àngth
 +(
b
->
œ°
 - b->
pos
);

519 
Æ
 = 
	`ngx_Æloc_chaö_lök
(
poﬁ
);

520 i‡(
Æ
 =
NULL
) {

521  
NULL
;

524 
b
 = 
	`ngx_¸óã_ãmp_buf
(
poﬁ
, ("POST") +

525 
uri
->
Àn
);

526 i‡(
b
 =
NULL
) {

527  
NULL
;

530 
b
->
œ°
 = 
	`ngx_¢¥ötf
(b->œ°, b->
íd
 - b->last, "%s %V",

531 
mëhods
[
mëhod
], 
uri
);

533 
Æ
->
buf
 = 
b
;

535 
ªt
 = 
Æ
;

537 i‡(
¨gs
) {

538 *
b
->
œ°
++ = '?';

539 
Æ
->
√xt
 = 
¨gs
;

540 
Æ
 = 
¨gs
;ál->
√xt
;ál =ál->next);

545 
bl
 = 
	`ngx_Æloc_chaö_lök
(
poﬁ
);

546 i‡(
bl
 =
NULL
) {

547  
NULL
;

550 
b
 = 
	`ngx_¸óã_ãmp_buf
(
poﬁ
, (
rq_tm∂
Ë+ 
ho°
->
Àn
 +

551 
c⁄ã¡_ty≥
->
Àn
 + 
NGX_SIZE_T_LEN
);

552 i‡(
b
 =
NULL
) {

553  
NULL
;

556 
bl
->
buf
 = 
b
;

558 
b
->
œ°
 = 
	`ngx_¢¥ötf
(b->œ°, b->
íd
 - b->œ°, 
rq_tm∂
,

559 
ho°
, 
c⁄ã¡_ty≥
, 
c⁄ã¡_Àngth
);

561 
Æ
->
√xt
 = 
bl
;

562 
bl
->
√xt
 = 
body
;

564  
ªt
;

565 
	}
}

568 
ngx_chaö_t
 *

569 
	$ngx_πmp_√tˇŒ_hâp_f‹m©_£ssi⁄
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_poﬁ_t
 *
poﬁ
)

571 
ngx_chaö_t
 *
˛
;

572 
ngx_buf_t
 *
b
;

573 
ngx_°r_t
 *
addr_ãxt
;

575 
addr_ãxt
 = &
s
->
c⁄√˘i⁄
->addr_text;

577 
˛
 = 
	`ngx_Æloc_chaö_lök
(
poﬁ
);

578 i‡(
˛
 =
NULL
) {

579  
NULL
;

582 
b
 = 
	`ngx_¸óã_ãmp_buf
(
poﬁ
,

583 ("≠p="Ë- 1 + 
s
->
≠p
.
Àn
 * 3 +

584 ("&Êashvî="Ë- 1 + 
s
->
Êashvî
.
Àn
 * 3 +

585 ("&swfuæ="Ë- 1 + 
s
->
swf_uæ
.
Àn
 * 3 +

586 ("&tcuæ="Ë- 1 + 
s
->
tc_uæ
.
Àn
 * 3 +

587 ("&∑geuæ="Ë- 1 + 
s
->
∑ge_uæ
.
Àn
 * 3 +

588 ("&addr="Ë- 1 + 
addr_ãxt
->
Àn
 * 3 +

589 ("&˛õ¡id="Ë- 1 + 
NGX_INT_T_LEN


592 i‡(
b
 =
NULL
) {

593  
NULL
;

596 
˛
->
buf
 = 
b
;

597 
˛
->
√xt
 = 
NULL
;

599 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "app=", ("app=") - 1);

600 
b
->
œ°
 = (
u_ch¨
*Ë
	`ngx_esˇ≥_uri
(b->œ°, 
s
->
≠p
.
d©a
, s->≠p.
Àn
,

601 
NGX_ESCAPE_ARGS
);

603 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&flashver=",

605 
b
->
œ°
 = (
u_ch¨
*Ë
	`ngx_esˇ≥_uri
(b->œ°, 
s
->
Êashvî
.
d©a
,

606 
s
->
Êashvî
.
Àn
, 
NGX_ESCAPE_ARGS
);

608 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&swfurl=",

610 
b
->
œ°
 = (
u_ch¨
*Ë
	`ngx_esˇ≥_uri
(b->œ°, 
s
->
swf_uæ
.
d©a
,

611 
s
->
swf_uæ
.
Àn
, 
NGX_ESCAPE_ARGS
);

613 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&tcurl=",

615 
b
->
œ°
 = (
u_ch¨
*Ë
	`ngx_esˇ≥_uri
(b->œ°, 
s
->
tc_uæ
.
d©a
,

616 
s
->
tc_uæ
.
Àn
, 
NGX_ESCAPE_ARGS
);

618 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&pageurl=",

620 
b
->
œ°
 = (
u_ch¨
*Ë
	`ngx_esˇ≥_uri
(b->œ°, 
s
->
∑ge_uæ
.
d©a
,

621 
s
->
∑ge_uæ
.
Àn
, 
NGX_ESCAPE_ARGS
);

623 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&addr=", ("&addr=") - 1);

624 
b
->
œ°
 = (
u_ch¨
*Ë
	`ngx_esˇ≥_uri
(b->œ°, 
addr_ãxt
->
d©a
,

625 
addr_ãxt
->
Àn
, 
NGX_ESCAPE_ARGS
);

627 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&clientid=",

629 
b
->
œ°
 = 
	`ngx_•rötf
(b->œ°, "%ui", (
ngx_uöt_t
Ë
s
->
c⁄√˘i⁄
->
numbî
);

631  
˛
;

632 
	}
}

635 
ngx_chaö_t
 *

636 
	$ngx_πmp_√tˇŒ_hâp_skù_hódî
(
ngx_chaö_t
 *
ö
)

638 
ngx_buf_t
 *
b
;

642 
n‹mÆ
,

643 
lf
,

644 
lf¸


645 } 
°©e
 = 
n‹mÆ
;

647 i‡(
ö
 =
NULL
) {

648  
NULL
;

651 
b
 = 
ö
->
buf
;

655 
b
->
pos
 =b->
œ°
) {

656 
ö
 = in->
√xt
;

657 i‡(
ö
 =
NULL
) {

658  
NULL
;

660 
b
 = 
ö
->
buf
;

663 *
b
->
pos
++) {

665 
°©e
 = (°©ê=
lf
Ë? 
lf¸
 : 
n‹mÆ
;

669 i‡(
°©e
 !
n‹mÆ
) {

670  
ö
;

672 
°©e
 = 
lf
;

676 
°©e
 = 
n‹mÆ
;

679 
	}
}

682 
ngx_chaö_t
 *

683 
	$ngx_πmp_√tˇŒ_memˇche_£t
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_poﬁ_t
 *
poﬁ
,

684 
ngx_°r_t
 *
key
,Çgx_°r_à*
vÆue
, 
ngx_uöt_t
 
Êags
,Çgx_uöt_à
£c
)

686 
ngx_chaö_t
 *
˛
;

687 
ngx_buf_t
 *
b
;

689 
˛
 = 
	`ngx_Æloc_chaö_lök
(
poﬁ
);

690 i‡(
˛
 =
NULL
) {

691  
NULL
;

694 
b
 = 
	`ngx_¸óã_ãmp_buf
(
poﬁ
, ("£à"Ë- 1 + 
key
->
Àn
 +

695 (1 + 
NGX_INT_T_LEN
) * 3 +

696 (("\r\n"Ë- 1Ë* 2 + 
vÆue
->
Àn
);

698 i‡(
b
 =
NULL
) {

699  
NULL
;

702 
˛
->
√xt
 = 
NULL
;

703 
˛
->
buf
 = 
b
;

705 
b
->
œ°
 = 
	`ngx_•rötf
(b->
pos
, "set %V %ui %ui %ui\r\n%V\r\n",

706 
key
, 
Êags
, 
£c
, (
ngx_uöt_t
Ë
vÆue
->
Àn
, value);

708  
˛
;

709 
	}
}

712 
ngx_öt_t


713 
	$ngx_πmp_√tˇŒ_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
)

715 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
;

716 
ngx_πmp_h™dÀr_±
 *
h
;

718 
cmcf
 = 
	`ngx_πmp_c⁄f_gë_moduÀ_maö_c⁄f
(
cf
, 
ngx_πmp_c‹e_moduÀ
);

720 
h
 = 
	`ngx_¨øy_push
(&
cmcf
->
evíts
[
NGX_RTMP_DISCONNECT
]);

721 *
h
 = 
ngx_πmp_√tˇŒ_disc⁄√˘
;

723  
NGX_OK
;

724 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_netcall_module.h

7 #i‚de‡
_NGX_RTMP_NETCALL_H_INCLUDED_


8 
	#_NGX_RTMP_NETCALL_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

13 
	~"ngx_πmp.h
"

16 
	gngx_chaö_t
 * (*
	tngx_πmp_√tˇŒ_¸óã_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

17 *
	t¨g
, 
	tngx_poﬁ_t
 *
	tpoﬁ
);

18 
	$ngx_öt_t
 (*
	tngx_πmp_√tˇŒ_fûãr_±
)(
	tngx_chaö_t
 *
	tö
);

19 
	$ngx_öt_t
 (*
	tngx_πmp_√tˇŒ_sök_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

20 
	tngx_chaö_t
 *
	tö
);

21 
	$ngx_öt_t
 (*
	tngx_πmp_√tˇŒ_h™dÀ_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

22 *
	t¨g
, 
	tngx_chaö_t
 *
	tö
);

24 
	#NGX_RTMP_NETCALL_HTTP_GET
 0

	)

25 
	#NGX_RTMP_NETCALL_HTTP_POST
 1

	)

38 
ngx_uæ_t
 *
uæ
;

39 
ngx_πmp_√tˇŒ_¸óã_±
 
¸óã
;

40 
ngx_πmp_√tˇŒ_fûãr_±
 
fûãr
;

41 
ngx_πmp_√tˇŒ_sök_±
 
sök
;

42 
ngx_πmp_√tˇŒ_h™dÀ_±
 
h™dÀ
;

43 *
¨g
;

44 
size_t
 
¨gsize
;

45 } 
	tngx_πmp_√tˇŒ_öô_t
;

48 
ngx_öt_t
 
	`ngx_πmp_√tˇŒ_¸óã
(
ngx_πmp_£ssi⁄_t
 *
s
,

49 
ngx_πmp_√tˇŒ_öô_t
 *
ci
);

53 
ngx_chaö_t
 * 
	`ngx_πmp_√tˇŒ_hâp_f‹m©_£ssi⁄
(
ngx_πmp_£ssi⁄_t
 *
s
,

54 
ngx_poﬁ_t
 *
poﬁ
);

55 
ngx_chaö_t
 * 
	`ngx_πmp_√tˇŒ_hâp_f‹m©_ªque°
(
ngx_öt_t
 
mëhod
,

56 
ngx_°r_t
 *
ho°
,Çgx_°r_à*
uri
, 
ngx_chaö_t
 *
¨gs
,Çgx_chaö_à*
body
,

57 
ngx_poﬁ_t
 *
poﬁ
, 
ngx_°r_t
 *
c⁄ã¡_ty≥
);

58 
ngx_chaö_t
 * 
	`ngx_πmp_√tˇŒ_hâp_skù_hódî
“gx_chaö_à*
ö
);

62 
ngx_chaö_t
 * 
	`ngx_πmp_√tˇŒ_memˇche_£t
(
ngx_πmp_£ssi⁄_t
 *
s
,

63 
ngx_poﬁ_t
 *
poﬁ
, 
ngx_°r_t
 *
key
,Çgx_°r_à*
vÆue
,

64 
ngx_uöt_t
 
Êags
,Çgx_uöt_à
£c
);

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_notify_module.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~<ngx_md5.h
>

10 
	~"ngx_πmp.h
"

11 
	~"ngx_πmp_cmd_moduÀ.h
"

12 
	~"ngx_πmp_√tˇŒ_moduÀ.h
"

13 
	~"ngx_πmp_ªc‹d_moduÀ.h
"

14 
	~"ngx_πmp_ªœy_moduÀ.h
"

17 
ngx_πmp_c⁄√˘_±
 
	g√xt_c⁄√˘
;

18 
ngx_πmp_disc⁄√˘_±
 
	g√xt_disc⁄√˘
;

19 
ngx_πmp_publish_±
 
	g√xt_publish
;

20 
ngx_πmp_∂ay_±
 
	g√xt_∂ay
;

21 
ngx_πmp_˛o£_°ªam_±
 
	g√xt_˛o£_°ªam
;

22 
ngx_πmp_ªc‹d_d⁄e_±
 
	g√xt_ªc‹d_d⁄e
;

25 *
ngx_πmp_nŸify_⁄_§v_evít
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
,

26 *
c⁄f
);

27 *
ngx_πmp_nŸify_⁄_≠p_evít
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
,

28 *
c⁄f
);

29 *
ngx_πmp_nŸify_mëhod
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
,

30 *
c⁄f
);

31 
ngx_öt_t
 
ngx_πmp_nŸify_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
);

32 * 
ngx_πmp_nŸify_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
);

33 * 
ngx_πmp_nŸify_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
,

34 *
∑ª¡
, *
chûd
);

35 *
ngx_πmp_nŸify_¸óã_§v_c⁄f
(
ngx_c⁄f_t
 *
cf
);

36 *
ngx_πmp_nŸify_mîge_§v_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
∑ª¡
,

37 *
chûd
);

38 
ngx_öt_t
 
ngx_πmp_nŸify_d⁄e
(
ngx_πmp_£ssi⁄_t
 *
s
, *
cb«me
,

39 
ngx_uöt_t
 
uæ_idx
);

42 
ngx_°r_t
 
	gngx_πmp_nŸify_uæícoded
 =

43 
ngx_°rög
("application/x-www-form-urlencoded");

46 
	#NGX_RTMP_NOTIFY_PUBLISHING
 0x01

	)

47 
	#NGX_RTMP_NOTIFY_PLAYING
 0x02

	)

51 
	mNGX_RTMP_NOTIFY_PLAY
,

52 
	mNGX_RTMP_NOTIFY_PUBLISH
,

53 
	mNGX_RTMP_NOTIFY_PLAY_DONE
,

54 
	mNGX_RTMP_NOTIFY_PUBLISH_DONE
,

55 
	mNGX_RTMP_NOTIFY_DONE
,

56 
	mNGX_RTMP_NOTIFY_RECORD_DONE
,

57 
	mNGX_RTMP_NOTIFY_UPDATE
,

58 
	mNGX_RTMP_NOTIFY_APP_MAX


63 
	mNGX_RTMP_NOTIFY_CONNECT
,

64 
	mNGX_RTMP_NOTIFY_DISCONNECT
,

65 
	mNGX_RTMP_NOTIFY_SRV_MAX


70 
ngx_uæ_t
 *
	muæ
[
NGX_RTMP_NOTIFY_APP_MAX
];

71 
ngx_Êag_t
 
	ma˘ive
;

72 
ngx_uöt_t
 
	mmëhod
;

73 
ngx_m£c_t
 
	mupd©e_timeout
;

74 
ngx_Êag_t
 
	mupd©e_°ri˘
;

75 
ngx_Êag_t
 
	mªœy_ªdúe˘
;

76 } 
	tngx_πmp_nŸify_≠p_c⁄f_t
;

80 
ngx_uæ_t
 *
	muæ
[
NGX_RTMP_NOTIFY_SRV_MAX
];

81 
ngx_uöt_t
 
	mmëhod
;

82 } 
	tngx_πmp_nŸify_§v_c⁄f_t
;

86 
ngx_uöt_t
 
	mÊags
;

87 
u_ch¨
 
	m«me
[
NGX_RTMP_MAX_NAME
];

88 
u_ch¨
 
	m¨gs
[
NGX_RTMP_MAX_ARGS
];

89 
ngx_evít_t
 
	mupd©e_evt
;

90 
time_t
 
	m°¨t
;

91 } 
	tngx_πmp_nŸify_˘x_t
;

95 
u_ch¨
 *
	mcb«me
;

96 
ngx_uöt_t
 
	muæ_idx
;

97 } 
	tngx_πmp_nŸify_d⁄e_t
;

100 
ngx_comm™d_t
 
	gngx_πmp_nŸify_comm™ds
[] = {

102 { 
ngx_°rög
("on_connect"),

103 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_CONF_TAKE1
,

104 
ngx_πmp_nŸify_⁄_§v_evít
,

105 
NGX_RTMP_SRV_CONF_OFFSET
,

107 
NULL
 },

109 { 
ngx_°rög
("on_disconnect"),

110 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_CONF_TAKE1
,

111 
ngx_πmp_nŸify_⁄_§v_evít
,

112 
NGX_RTMP_SRV_CONF_OFFSET
,

114 
NULL
 },

116 { 
ngx_°rög
("on_publish"),

117 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

118 
ngx_πmp_nŸify_⁄_≠p_evít
,

119 
NGX_RTMP_APP_CONF_OFFSET
,

121 
NULL
 },

123 { 
ngx_°rög
("on_play"),

124 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

125 
ngx_πmp_nŸify_⁄_≠p_evít
,

126 
NGX_RTMP_APP_CONF_OFFSET
,

128 
NULL
 },

130 { 
ngx_°rög
("on_publish_done"),

131 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

132 
ngx_πmp_nŸify_⁄_≠p_evít
,

133 
NGX_RTMP_APP_CONF_OFFSET
,

135 
NULL
 },

137 { 
ngx_°rög
("on_play_done"),

138 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

139 
ngx_πmp_nŸify_⁄_≠p_evít
,

140 
NGX_RTMP_APP_CONF_OFFSET
,

142 
NULL
 },

144 { 
ngx_°rög
("on_done"),

145 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

146 
ngx_πmp_nŸify_⁄_≠p_evít
,

147 
NGX_RTMP_APP_CONF_OFFSET
,

149 
NULL
 },

151 { 
ngx_°rög
("on_record_done"),

152 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_RTMP_REC_CONF
|

153 
NGX_CONF_TAKE1
,

154 
ngx_πmp_nŸify_⁄_≠p_evít
,

155 
NGX_RTMP_APP_CONF_OFFSET
,

157 
NULL
 },

159 { 
ngx_°rög
("on_update"),

160 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

161 
ngx_πmp_nŸify_⁄_≠p_evít
,

162 
NGX_RTMP_APP_CONF_OFFSET
,

164 
NULL
 },

166 { 
ngx_°rög
("notify_method"),

167 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

168 
ngx_πmp_nŸify_mëhod
,

169 
NGX_RTMP_APP_CONF_OFFSET
,

171 
NULL
 },

173 { 
ngx_°rög
("notify_update_timeout"),

174 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

175 
ngx_c⁄f_£t_m£c_¶Ÿ
,

176 
NGX_RTMP_APP_CONF_OFFSET
,

177 
off£tof
(
ngx_πmp_nŸify_≠p_c⁄f_t
, 
upd©e_timeout
),

178 
NULL
 },

180 { 
ngx_°rög
("notify_update_strict"),

181 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

182 
ngx_c⁄f_£t_Êag_¶Ÿ
,

183 
NGX_RTMP_APP_CONF_OFFSET
,

184 
off£tof
(
ngx_πmp_nŸify_≠p_c⁄f_t
, 
upd©e_°ri˘
),

185 
NULL
 },

187 { 
ngx_°rög
("notify_relay_redirect"),

188 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

189 
ngx_c⁄f_£t_Êag_¶Ÿ
,

190 
NGX_RTMP_APP_CONF_OFFSET
,

191 
off£tof
(
ngx_πmp_nŸify_≠p_c⁄f_t
, 
ªœy_ªdúe˘
),

192 
NULL
 },

194 
ngx_nuŒ_comm™d


198 
ngx_πmp_moduÀ_t
 
	gngx_πmp_nŸify_moduÀ_˘x
 = {

199 
NULL
,

200 
ngx_πmp_nŸify_po°c⁄figuøti⁄
,

201 
NULL
,

202 
NULL
,

203 
ngx_πmp_nŸify_¸óã_§v_c⁄f
,

204 
ngx_πmp_nŸify_mîge_§v_c⁄f
,

205 
ngx_πmp_nŸify_¸óã_≠p_c⁄f
,

206 
ngx_πmp_nŸify_mîge_≠p_c⁄f


210 
ngx_moduÀ_t
 
	gngx_πmp_nŸify_moduÀ
 = {

211 
NGX_MODULE_V1
,

212 &
ngx_πmp_nŸify_moduÀ_˘x
,

213 
ngx_πmp_nŸify_comm™ds
,

214 
NGX_RTMP_MODULE
,

215 
NULL
,

216 
NULL
,

217 
NULL
,

218 
NULL
,

219 
NULL
,

220 
NULL
,

221 
NULL
,

222 
NGX_MODULE_V1_PADDING


227 
	$ngx_πmp_nŸify_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
)

229 
ngx_πmp_nŸify_≠p_c⁄f_t
 *
«cf
;

230 
ngx_uöt_t
 
n
;

232 
«cf
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_nŸify_≠p_c⁄f_t
));

233 i‡(
«cf
 =
NULL
) {

234  
NULL
;

237 
n
 = 0;Ç < 
NGX_RTMP_NOTIFY_APP_MAX
; ++n) {

238 
«cf
->
uæ
[
n
] = 
NGX_CONF_UNSET_PTR
;

241 
«cf
->
mëhod
 = 
NGX_CONF_UNSET_UINT
;

242 
«cf
->
upd©e_timeout
 = 
NGX_CONF_UNSET_MSEC
;

243 
«cf
->
upd©e_°ri˘
 = 
NGX_CONF_UNSET
;

244 
«cf
->
ªœy_ªdúe˘
 = 
NGX_CONF_UNSET
;

246  
«cf
;

247 
	}
}

251 
	$ngx_πmp_nŸify_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
∑ª¡
, *
chûd
)

253 
ngx_πmp_nŸify_≠p_c⁄f_t
 *
¥ev
 = 
∑ª¡
;

254 
ngx_πmp_nŸify_≠p_c⁄f_t
 *
c⁄f
 = 
chûd
;

255 
ngx_uöt_t
 
n
;

257 
n
 = 0;Ç < 
NGX_RTMP_NOTIFY_APP_MAX
; ++n) {

258 
	`ngx_c⁄f_mîge_±r_vÆue
(
c⁄f
->
uæ
[
n
], 
¥ev
->uæ[n], 
NULL
);

259 i‡(
c⁄f
->
uæ
[
n
]) {

260 
c⁄f
->
a˘ive
 = 1;

264 i‡(
c⁄f
->
a˘ive
) {

265 
¥ev
->
a˘ive
 = 1;

268 
	`ngx_c⁄f_mîge_uöt_vÆue
(
c⁄f
->
mëhod
, 
¥ev
->method,

269 
NGX_RTMP_NETCALL_HTTP_POST
);

270 
	`ngx_c⁄f_mîge_m£c_vÆue
(
c⁄f
->
upd©e_timeout
, 
¥ev
->update_timeout,

272 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
upd©e_°ri˘
, 
¥ev
->update_strict, 0);

273 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
ªœy_ªdúe˘
, 
¥ev
->relay_redirect, 0);

275  
NGX_CONF_OK
;

276 
	}
}

280 
	$ngx_πmp_nŸify_¸óã_§v_c⁄f
(
ngx_c⁄f_t
 *
cf
)

282 
ngx_πmp_nŸify_§v_c⁄f_t
 *
nscf
;

283 
ngx_uöt_t
 
n
;

285 
nscf
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_nŸify_§v_c⁄f_t
));

286 i‡(
nscf
 =
NULL
) {

287  
NULL
;

290 
n
 = 0;Ç < 
NGX_RTMP_NOTIFY_SRV_MAX
; ++n) {

291 
nscf
->
uæ
[
n
] = 
NGX_CONF_UNSET_PTR
;

294 
nscf
->
mëhod
 = 
NGX_CONF_UNSET_UINT
;

296  
nscf
;

297 
	}
}

301 
	$ngx_πmp_nŸify_mîge_§v_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
∑ª¡
, *
chûd
)

303 
ngx_πmp_nŸify_§v_c⁄f_t
 *
¥ev
 = 
∑ª¡
;

304 
ngx_πmp_nŸify_§v_c⁄f_t
 *
c⁄f
 = 
chûd
;

305 
ngx_uöt_t
 
n
;

307 
n
 = 0;Ç < 
NGX_RTMP_NOTIFY_SRV_MAX
; ++n) {

308 
	`ngx_c⁄f_mîge_±r_vÆue
(
c⁄f
->
uæ
[
n
], 
¥ev
->uæ[n], 
NULL
);

311 
	`ngx_c⁄f_mîge_uöt_vÆue
(
c⁄f
->
mëhod
, 
¥ev
->method,

312 
NGX_RTMP_NETCALL_HTTP_POST
);

314  
NGX_CONF_OK
;

315 
	}
}

318 
ngx_chaö_t
 *

319 
	$ngx_πmp_nŸify_¸óã_ªque°
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_poﬁ_t
 *
poﬁ
,

320 
ngx_uöt_t
 
uæ_idx
, 
ngx_chaö_t
 *
¨gs
)

322 
ngx_πmp_nŸify_≠p_c⁄f_t
 *
«cf
;

323 
ngx_chaö_t
 *
Æ
, *
bl
, *
˛
;

324 
ngx_uæ_t
 *
uæ
;

326 
«cf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_nŸify_moduÀ
);

328 
uæ
 = 
«cf
->uæ[
uæ_idx
];

330 
Æ
 = 
	`ngx_πmp_√tˇŒ_hâp_f‹m©_£ssi⁄
(
s
, 
poﬁ
);

331 i‡(
Æ
 =
NULL
) {

332  
NULL
;

335 
Æ
->
√xt
 = 
¨gs
;

337 
bl
 = 
NULL
;

339 i‡(
«cf
->
mëhod
 =
NGX_RTMP_NETCALL_HTTP_POST
) {

340 
˛
 = 
Æ
;

341 
Æ
 = 
bl
;

342 
bl
 = 
˛
;

345  
	`ngx_πmp_√tˇŒ_hâp_f‹m©_ªque°
(
«cf
->
mëhod
, &
uæ
->
ho°
,

346 &
uæ
->
uri
, 
Æ
, 
bl
, 
poﬁ
,

347 &
ngx_πmp_nŸify_uæícoded
);

348 
	}
}

351 
ngx_chaö_t
 *

352 
	$ngx_πmp_nŸify_c⁄√˘_¸óã
(
ngx_πmp_£ssi⁄_t
 *
s
, *
¨g
,

353 
ngx_poﬁ_t
 *
poﬁ
)

355 
ngx_πmp_c⁄√˘_t
 *
v
 = 
¨g
;

357 
ngx_πmp_nŸify_§v_c⁄f_t
 *
nscf
;

358 
ngx_uæ_t
 *
uæ
;

359 
ngx_chaö_t
 *
Æ
, *
bl
;

360 
ngx_buf_t
 *
b
;

361 
ngx_°r_t
 *
addr_ãxt
;

362 
size_t
 
≠p_Àn
, 
¨gs_Àn
, 
Êashvî_Àn
,

363 
swf_uæ_Àn
, 
tc_uæ_Àn
, 
∑ge_uæ_Àn
;

365 
nscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_nŸify_moduÀ
);

367 
Æ
 = 
	`ngx_Æloc_chaö_lök
(
poﬁ
);

368 i‡(
Æ
 =
NULL
) {

369  
NULL
;

376 
≠p_Àn
 = 
	`ngx_°æí
(
v
->
≠p
);

377 
¨gs_Àn
 = 
	`ngx_°æí
(
v
->
¨gs
);

378 
Êashvî_Àn
 = 
	`ngx_°æí
(
v
->
Êashvî
);

379 
swf_uæ_Àn
 = 
	`ngx_°æí
(
v
->
swf_uæ
);

380 
tc_uæ_Àn
 = 
	`ngx_°æí
(
v
->
tc_uæ
);

381 
∑ge_uæ_Àn
 = 
	`ngx_°æí
(
v
->
∑ge_uæ
);

383 
addr_ãxt
 = &
s
->
c⁄√˘i⁄
->addr_text;

385 
b
 = 
	`ngx_¸óã_ãmp_buf
(
poﬁ
,

387 ("&≠p="Ë- 1 + 
≠p_Àn
 * 3 +

388 ("&Êashvî="Ë- 1 + 
Êashvî_Àn
 * 3 +

389 ("&swfuæ="Ë- 1 + 
swf_uæ_Àn
 * 3 +

390 ("&tcuæ="Ë- 1 + 
tc_uæ_Àn
 * 3 +

391 ("&∑geuæ="Ë- 1 + 
∑ge_uæ_Àn
 * 3 +

392 ("&addr="Ë- 1 + 
addr_ãxt
->
Àn
 * 3 +

393 ("&ïoch="Ë- 1 + 
NGX_INT32_LEN
 +

394 1 + 
¨gs_Àn


397 i‡(
b
 =
NULL
) {

398  
NULL
;

401 
Æ
->
buf
 = 
b
;

402 
Æ
->
√xt
 = 
NULL
;

404 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "app=", ("app=") - 1);

405 
b
->
œ°
 = (
u_ch¨
*Ë
	`ngx_esˇ≥_uri
(b->œ°, 
v
->
≠p
, 
≠p_Àn
,

406 
NGX_ESCAPE_ARGS
);

408 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&flashver=",

410 
b
->
œ°
 = (
u_ch¨
*Ë
	`ngx_esˇ≥_uri
(b->œ°, 
v
->
Êashvî
, 
Êashvî_Àn
,

411 
NGX_ESCAPE_ARGS
);

413 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&swfurl=",

415 
b
->
œ°
 = (
u_ch¨
*Ë
	`ngx_esˇ≥_uri
(b->œ°, 
v
->
swf_uæ
, 
swf_uæ_Àn
,

416 
NGX_ESCAPE_ARGS
);

418 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&tcurl=",

420 
b
->
œ°
 = (
u_ch¨
*Ë
	`ngx_esˇ≥_uri
(b->œ°, 
v
->
tc_uæ
, 
tc_uæ_Àn
,

421 
NGX_ESCAPE_ARGS
);

423 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&pageurl=",

425 
b
->
œ°
 = (
u_ch¨
*Ë
	`ngx_esˇ≥_uri
(b->œ°, 
v
->
∑ge_uæ
, 
∑ge_uæ_Àn
,

426 
NGX_ESCAPE_ARGS
);

428 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&addr=", ("&addr=") -1);

429 
b
->
œ°
 = (
u_ch¨
*Ë
	`ngx_esˇ≥_uri
(b->œ°, 
addr_ãxt
->
d©a
,

430 
addr_ãxt
->
Àn
, 
NGX_ESCAPE_ARGS
);

432 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&epoch=", ("&epoch=") -1);

433 
b
->
œ°
 = 
	`ngx_•rötf
(b->œ°, "%uD", (
uöt32_t
Ë
s
->
ïoch
);

435 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&call=connect",

438 i‡(
¨gs_Àn
) {

439 *
b
->
œ°
++ = '&';

440 
b
->
œ°
 = (
u_ch¨
 *Ë
	`ngx_˝ymem
(b->œ°, 
v
->
¨gs
, 
¨gs_Àn
);

443 
uæ
 = 
nscf
->uæ[
NGX_RTMP_NOTIFY_CONNECT
];

445 
bl
 = 
NULL
;

447 i‡(
nscf
->
mëhod
 =
NGX_RTMP_NETCALL_HTTP_POST
) {

448 
bl
 = 
Æ
;

449 
Æ
 = 
NULL
;

452  
	`ngx_πmp_√tˇŒ_hâp_f‹m©_ªque°
(
nscf
->
mëhod
, &
uæ
->
ho°
,

453 &
uæ
->
uri
, 
Æ
, 
bl
, 
poﬁ
,

454 &
ngx_πmp_nŸify_uæícoded
);

455 
	}
}

458 
ngx_chaö_t
 *

459 
	$ngx_πmp_nŸify_disc⁄√˘_¸óã
(
ngx_πmp_£ssi⁄_t
 *
s
, *
¨g
,

460 
ngx_poﬁ_t
 *
poﬁ
)

462 
ngx_πmp_nŸify_§v_c⁄f_t
 *
nscf
;

463 
ngx_uæ_t
 *
uæ
;

464 
ngx_chaö_t
 *
Æ
, *
bl
, *
∂
;

465 
ngx_buf_t
 *
b
;

467 
nscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_nŸify_moduÀ
);

469 
∂
 = 
	`ngx_Æloc_chaö_lök
(
poﬁ
);

470 i‡(
∂
 =
NULL
) {

471  
NULL
;

474 
b
 = 
	`ngx_¸óã_ãmp_buf
(
poﬁ
,

476 ("&≠p="Ë+ 
s
->
≠p
.
Àn
 * 3 +

477 1 + 
s
->
¨gs
.
Àn
);

478 i‡(
b
 =
NULL
) {

479  
NULL
;

482 
∂
->
buf
 = 
b
;

483 
∂
->
√xt
 = 
NULL
;

485 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&call=disconnect",

488 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&app=", ("&app=") - 1);

489 
b
->
œ°
 = (
u_ch¨
*Ë
	`ngx_esˇ≥_uri
(b->œ°, 
s
->
≠p
.
d©a
, s->≠p.
Àn
,

490 
NGX_ESCAPE_ARGS
);

492 i‡(
s
->
¨gs
.
Àn
) {

493 *
b
->
œ°
++ = '&';

494 
b
->
œ°
 = (
u_ch¨
 *Ë
	`ngx_˝ymem
(b->œ°, 
s
->
¨gs
.
d©a
, s->¨gs.
Àn
);

497 
uæ
 = 
nscf
->uæ[
NGX_RTMP_NOTIFY_DISCONNECT
];

499 
Æ
 = 
	`ngx_πmp_√tˇŒ_hâp_f‹m©_£ssi⁄
(
s
, 
poﬁ
);

500 i‡(
Æ
 =
NULL
) {

501  
NULL
;

504 
Æ
->
√xt
 = 
∂
;

506 
bl
 = 
NULL
;

508 i‡(
nscf
->
mëhod
 =
NGX_RTMP_NETCALL_HTTP_POST
) {

509 
bl
 = 
Æ
;

510 
Æ
 = 
NULL
;

513  
	`ngx_πmp_√tˇŒ_hâp_f‹m©_ªque°
(
nscf
->
mëhod
, &
uæ
->
ho°
,

514 &
uæ
->
uri
, 
Æ
, 
bl
, 
poﬁ
,

515 &
ngx_πmp_nŸify_uæícoded
);

516 
	}
}

519 
ngx_chaö_t
 *

520 
	$ngx_πmp_nŸify_publish_¸óã
(
ngx_πmp_£ssi⁄_t
 *
s
, *
¨g
,

521 
ngx_poﬁ_t
 *
poﬁ
)

523 
ngx_πmp_publish_t
 *
v
 = 
¨g
;

525 
ngx_chaö_t
 *
∂
;

526 
ngx_buf_t
 *
b
;

527 
size_t
 
«me_Àn
, 
ty≥_Àn
, 
¨gs_Àn
;

529 
∂
 = 
	`ngx_Æloc_chaö_lök
(
poﬁ
);

530 i‡(
∂
 =
NULL
) {

531  
NULL
;

534 
«me_Àn
 = 
	`ngx_°æí
(
v
->
«me
);

535 
ty≥_Àn
 = 
	`ngx_°æí
(
v
->
ty≥
);

536 
¨gs_Àn
 = 
	`ngx_°æí
(
v
->
¨gs
);

538 
b
 = 
	`ngx_¸óã_ãmp_buf
(
poﬁ
,

540 ("&«me="Ë+ 
«me_Àn
 * 3 +

541 ("&ty≥="Ë+ 
ty≥_Àn
 * 3 +

542 1 + 
¨gs_Àn
);

543 i‡(
b
 =
NULL
) {

544  
NULL
;

547 
∂
->
buf
 = 
b
;

548 
∂
->
√xt
 = 
NULL
;

550 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&call=publish",

553 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&name=", ("&name=") - 1);

554 
b
->
œ°
 = (
u_ch¨
*Ë
	`ngx_esˇ≥_uri
(b->œ°, 
v
->
«me
, 
«me_Àn
,

555 
NGX_ESCAPE_ARGS
);

557 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&type=", ("&type=") - 1);

558 
b
->
œ°
 = (
u_ch¨
*Ë
	`ngx_esˇ≥_uri
(b->œ°, 
v
->
ty≥
, 
ty≥_Àn
,

559 
NGX_ESCAPE_ARGS
);

561 i‡(
¨gs_Àn
) {

562 *
b
->
œ°
++ = '&';

563 
b
->
œ°
 = (
u_ch¨
 *Ë
	`ngx_˝ymem
(b->œ°, 
v
->
¨gs
, 
¨gs_Àn
);

566  
	`ngx_πmp_nŸify_¸óã_ªque°
(
s
, 
poﬁ
, 
NGX_RTMP_NOTIFY_PUBLISH
, 
∂
);

567 
	}
}

570 
ngx_chaö_t
 *

571 
	$ngx_πmp_nŸify_∂ay_¸óã
(
ngx_πmp_£ssi⁄_t
 *
s
, *
¨g
,

572 
ngx_poﬁ_t
 *
poﬁ
)

574 
ngx_πmp_∂ay_t
 *
v
 = 
¨g
;

576 
ngx_chaö_t
 *
∂
;

577 
ngx_buf_t
 *
b
;

578 
size_t
 
«me_Àn
, 
¨gs_Àn
;

580 
∂
 = 
	`ngx_Æloc_chaö_lök
(
poﬁ
);

581 i‡(
∂
 =
NULL
) {

582  
NULL
;

585 
«me_Àn
 = 
	`ngx_°æí
(
v
->
«me
);

586 
¨gs_Àn
 = 
	`ngx_°æí
(
v
->
¨gs
);

588 
b
 = 
	`ngx_¸óã_ãmp_buf
(
poﬁ
,

590 ("&«me="Ë+ 
«me_Àn
 * 3 +

592 
NGX_INT32_LEN
 * 3 + 1 + 
¨gs_Àn
);

593 i‡(
b
 =
NULL
) {

594  
NULL
;

597 
∂
->
buf
 = 
b
;

598 
∂
->
√xt
 = 
NULL
;

600 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&call=play",

603 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&name=", ("&name=") - 1);

604 
b
->
œ°
 = (
u_ch¨
*Ë
	`ngx_esˇ≥_uri
(b->œ°, 
v
->
«me
, 
«me_Àn
,

605 
NGX_ESCAPE_ARGS
);

607 
b
->
œ°
 = 
	`ngx_¢¥ötf
(b->œ°, b->
íd
 - b->last,

609 (
uöt32_t
Ë
v
->
°¨t
, (uöt32_tËv->
duøti⁄
,

610 
v
->
ª£t
 & 1);

612 i‡(
¨gs_Àn
) {

613 *
b
->
œ°
++ = '&';

614 
b
->
œ°
 = (
u_ch¨
 *Ë
	`ngx_˝ymem
(b->œ°, 
v
->
¨gs
, 
¨gs_Àn
);

617  
	`ngx_πmp_nŸify_¸óã_ªque°
(
s
, 
poﬁ
, 
NGX_RTMP_NOTIFY_PLAY
, 
∂
);

618 
	}
}

621 
ngx_chaö_t
 *

622 
	$ngx_πmp_nŸify_d⁄e_¸óã
(
ngx_πmp_£ssi⁄_t
 *
s
, *
¨g
,

623 
ngx_poﬁ_t
 *
poﬁ
)

625 
ngx_πmp_nŸify_d⁄e_t
 *
ds
 = 
¨g
;

627 
ngx_chaö_t
 *
∂
;

628 
ngx_buf_t
 *
b
;

629 
size_t
 
cb«me_Àn
, 
«me_Àn
, 
¨gs_Àn
;

630 
ngx_πmp_nŸify_˘x_t
 *
˘x
;

632 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_nŸify_moduÀ
);

634 
∂
 = 
	`ngx_Æloc_chaö_lök
(
poﬁ
);

635 i‡(
∂
 =
NULL
) {

636  
NULL
;

639 
cb«me_Àn
 = 
	`ngx_°æí
(
ds
->
cb«me
);

640 
«me_Àn
 = 
˘x
 ? 
	`ngx_°æí
(˘x->
«me
) : 0;

641 
¨gs_Àn
 = 
˘x
 ? 
	`ngx_°æí
(˘x->
¨gs
) : 0;

643 
b
 = 
	`ngx_¸óã_ãmp_buf
(
poﬁ
,

644 ("&ˇŒ="Ë+ 
cb«me_Àn
 +

645 ("&«me="Ë+ 
«me_Àn
 * 3 +

646 1 + 
¨gs_Àn
);

647 i‡(
b
 =
NULL
) {

648  
NULL
;

651 
∂
->
buf
 = 
b
;

652 
∂
->
√xt
 = 
NULL
;

654 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&call=", ("&call=") - 1);

655 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, 
ds
->
cb«me
, 
cb«me_Àn
);

657 i‡(
«me_Àn
) {

658 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&name=", ("&name=") - 1);

659 
b
->
œ°
 = (
u_ch¨
*Ë
	`ngx_esˇ≥_uri
(b->œ°, 
˘x
->
«me
, 
«me_Àn
,

660 
NGX_ESCAPE_ARGS
);

663 i‡(
¨gs_Àn
) {

664 *
b
->
œ°
++ = '&';

665 
b
->
œ°
 = (
u_ch¨
 *Ë
	`ngx_˝ymem
(b->œ°, 
˘x
->
¨gs
, 
¨gs_Àn
);

668  
	`ngx_πmp_nŸify_¸óã_ªque°
(
s
, 
poﬁ
, 
ds
->
uæ_idx
, 
∂
);

669 
	}
}

672 
ngx_chaö_t
 *

673 
	$ngx_πmp_nŸify_upd©e_¸óã
(
ngx_πmp_£ssi⁄_t
 *
s
, *
¨g
,

674 
ngx_poﬁ_t
 *
poﬁ
)

676 
ngx_chaö_t
 *
∂
;

677 
ngx_buf_t
 *
b
;

678 
size_t
 
«me_Àn
, 
¨gs_Àn
;

679 
ngx_πmp_nŸify_˘x_t
 *
˘x
;

680 
ngx_°r_t
 
sfx
;

682 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_nŸify_moduÀ
);

684 
∂
 = 
	`ngx_Æloc_chaö_lök
(
poﬁ
);

685 i‡(
∂
 =
NULL
) {

686  
NULL
;

689 i‡(
˘x
->
Êags
 & 
NGX_RTMP_NOTIFY_PUBLISHING
) {

690 
	`ngx_°r_£t
(&
sfx
, "_publish");

691 } i‡(
˘x
->
Êags
 & 
NGX_RTMP_NOTIFY_PLAYING
) {

692 
	`ngx_°r_£t
(&
sfx
, "_play");

694 
	`ngx_°r_nuŒ
(&
sfx
);

697 
«me_Àn
 = 
˘x
 ? 
	`ngx_°æí
(˘x->
«me
) : 0;

698 
¨gs_Àn
 = 
˘x
 ? 
	`ngx_°æí
(˘x->
¨gs
) : 0;

700 
b
 = 
	`ngx_¸óã_ãmp_buf
(
poﬁ
,

701 ("&ˇŒ=upd©e"Ë+ 
sfx
.
Àn
 +

702 ("&time="Ë+ 
NGX_TIME_T_LEN
 +

703 ("&time°amp="Ë+ 
NGX_INT32_LEN
 +

704 ("&«me="Ë+ 
«me_Àn
 * 3 +

705 1 + 
¨gs_Àn
);

706 i‡(
b
 =
NULL
) {

707  
NULL
;

710 
∂
->
buf
 = 
b
;

711 
∂
->
√xt
 = 
NULL
;

713 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&call=update",

715 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, 
sfx
.
d©a
, sfx.
Àn
);

717 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
 *) "&time=",

719 
b
->
œ°
 = 
	`ngx_•rötf
(b->œ°, "%T", 
ngx_ˇched_time
->
£c
 - 
˘x
->
°¨t
);

721 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
 *) "&timestamp=",

723 
b
->
œ°
 = 
	`ngx_•rötf
(b->œ°, "%D", 
s
->
cuºít_time
);

725 i‡(
«me_Àn
) {

726 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&name=", ("&name=") - 1);

727 
b
->
œ°
 = (
u_ch¨
*Ë
	`ngx_esˇ≥_uri
(b->œ°, 
˘x
->
«me
, 
«me_Àn
,

728 
NGX_ESCAPE_ARGS
);

731 i‡(
¨gs_Àn
) {

732 *
b
->
œ°
++ = '&';

733 
b
->
œ°
 = (
u_ch¨
 *Ë
	`ngx_˝ymem
(b->œ°, 
˘x
->
¨gs
, 
¨gs_Àn
);

736  
	`ngx_πmp_nŸify_¸óã_ªque°
(
s
, 
poﬁ
, 
NGX_RTMP_NOTIFY_UPDATE
, 
∂
);

737 
	}
}

740 
ngx_chaö_t
 *

741 
	$ngx_πmp_nŸify_ªc‹d_d⁄e_¸óã
(
ngx_πmp_£ssi⁄_t
 *
s
, *
¨g
,

742 
ngx_poﬁ_t
 *
poﬁ
)

744 
ngx_πmp_ªc‹d_d⁄e_t
 *
v
 = 
¨g
;

746 
ngx_πmp_nŸify_˘x_t
 *
˘x
;

747 
ngx_chaö_t
 *
∂
;

748 
ngx_buf_t
 *
b
;

749 
size_t
 
«me_Àn
, 
¨gs_Àn
;

751 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_nŸify_moduÀ
);

753 
∂
 = 
	`ngx_Æloc_chaö_lök
(
poﬁ
);

754 i‡(
∂
 =
NULL
) {

755  
NULL
;

758 
«me_Àn
 = 
	`ngx_°æí
(
˘x
->
«me
);

759 
¨gs_Àn
 = 
	`ngx_°æí
(
˘x
->
¨gs
);

761 
b
 = 
	`ngx_¸óã_ãmp_buf
(
poﬁ
,

763 ("&ªc‹dî="Ë+ 
v
->
ªc‹dî
.
Àn
 +

764 ("&«me="Ë+ 
«me_Àn
 * 3 +

765 ("&∑th="Ë+ 
v
->
∑th
.
Àn
 * 3 +

766 1 + 
¨gs_Àn
);

767 i‡(
b
 =
NULL
) {

768  
NULL
;

771 
∂
->
buf
 = 
b
;

772 
∂
->
√xt
 = 
NULL
;

774 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&call=record_done",

777 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
 *) "&recorder=",

779 
b
->
œ°
 = (
u_ch¨
*Ë
	`ngx_esˇ≥_uri
(b->œ°, 
v
->
ªc‹dî
.
d©a
,

780 
v
->
ªc‹dî
.
Àn
, 
NGX_ESCAPE_ARGS
);

782 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&name=", ("&name=") - 1);

783 
b
->
œ°
 = (
u_ch¨
*Ë
	`ngx_esˇ≥_uri
(b->œ°, 
˘x
->
«me
, 
«me_Àn
,

784 
NGX_ESCAPE_ARGS
);

786 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, (
u_ch¨
*) "&path=", ("&path=") - 1);

787 
b
->
œ°
 = (
u_ch¨
*Ë
	`ngx_esˇ≥_uri
(b->œ°, 
v
->
∑th
.
d©a
, v->∑th.
Àn
,

788 
NGX_ESCAPE_ARGS
);

790 i‡(
¨gs_Àn
) {

791 *
b
->
œ°
++ = '&';

792 
b
->
œ°
 = (
u_ch¨
 *Ë
	`ngx_˝ymem
(b->œ°, 
˘x
->
¨gs
, 
¨gs_Àn
);

795  
	`ngx_πmp_nŸify_¸óã_ªque°
(
s
, 
poﬁ
, 
NGX_RTMP_NOTIFY_RECORD_DONE
,

796 
∂
);

797 
	}
}

800 
ngx_öt_t


801 
	$ngx_πmp_nŸify_∑r£_hâp_ªtcode
(
ngx_πmp_£ssi⁄_t
 *
s
,

802 
ngx_chaö_t
 *
ö
)

804 
ngx_buf_t
 *
b
;

805 
ngx_öt_t
 
n
;

806 
u_ch¨
 
c
;

810 
n
 = 9;

811 
ö
) {

812 
b
 = 
ö
->
buf
;

813 i‡(
b
->
œ°
 - b->
pos
 > 
n
) {

814 
c
 = 
b
->
pos
[
n
];

815 i‡(
c
 >(
u_ch¨
)'0' && c <= (u_char)'9') {

816 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

817 "nŸify: HTTPÑëcode: %dxx", ()(
c
 - '0'));

818 
c
) {

819 (
u_ch¨
) '2':

820  
NGX_OK
;

821 (
u_ch¨
) '3':

822  
NGX_AGAIN
;

824  
NGX_ERROR
;

828 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

829 "nŸify: invÆid HTTPÑëcode: %d..", ()
c
);

831  
NGX_ERROR
;

833 
n
 -(
b
->
œ°
 - b->
pos
);

834 
ö
 = in->
√xt
;

837 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

845  
NGX_ERROR
;

846 
	}
}

849 
ngx_öt_t


850 
	$ngx_πmp_nŸify_∑r£_hâp_hódî
(
ngx_πmp_£ssi⁄_t
 *
s
,

851 
ngx_chaö_t
 *
ö
, 
ngx_°r_t
 *
«me
, 
u_ch¨
 *
d©a
, 
size_t
 
Àn
)

853 
ngx_buf_t
 *
b
;

854 
ngx_öt_t
 
m©ched
;

855 
u_ch¨
 *
p
, 
c
;

856 
ngx_uöt_t
 
n
;

859 
∑r£_«me
,

860 
∑r£_•a˚
,

861 
∑r£_vÆue
,

862 
∑r£_vÆue_√wlöe


863 } 
°©e
 = 
∑r£_«me
;

865 
n
 = 0;

866 
m©ched
 = 0;

868 
ö
) {

869 
b
 = 
ö
->
buf
;

871 
p
 = 
b
->
pos
;Ö !b->
œ°
; ++p) {

872 
c
 = *
p
;

874 i‡(
c
 == '\r') {

878 
°©e
) {

879 
∑r£_vÆue_√wlöe
:

880 i‡(
c
 == ' ' || c == '\t') {

881 
°©e
 = 
∑r£_•a˚
;

885 i‡(
m©ched
) {

886  
n
;

889 i‡(
c
 == '\n') {

890  
NGX_OK
;

893 
n
 = 0;

894 
°©e
 = 
∑r£_«me
;

896 
∑r£_«me
:

897 
c
) {

899 
m©ched
 = (
n
 =
«me
->
Àn
);

900 
n
 = 0;

901 
°©e
 = 
∑r£_•a˚
;

904 
n
 = 0;

907 i‡(
n
 < 
«me
->
Àn
 &&

908 
	`ngx_tﬁowî
(
c
Ë=ngx_tﬁowî(
«me
->
d©a
[
n
]))

910 ++
n
;

913 
n
 = 
«me
->
Àn
 + 1;

917 
∑r£_•a˚
:

918 i‡(
c
 == ' ' || c == '\t') {

921 
°©e
 = 
∑r£_vÆue
;

923 
∑r£_vÆue
:

924 i‡(
c
 == '\n') {

925 
°©e
 = 
∑r£_vÆue_√wlöe
;

929 i‡(
m©ched
 && 
n
 + 1 < 
Àn
) {

930 
d©a
[
n
++] = 
c
;

937 
ö
 = in->
√xt
;

940  
NGX_OK
;

941 
	}
}

945 
	$ngx_πmp_nŸify_˛ór_Êag
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_uöt_t
 
Êag
)

947 
ngx_πmp_nŸify_˘x_t
 *
˘x
;

949 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_nŸify_moduÀ
);

951 
˘x
->
Êags
 &~
Êag
;

952 
	}
}

955 
ngx_öt_t


956 
	$ngx_πmp_nŸify_c⁄√˘_h™dÀ
(
ngx_πmp_£ssi⁄_t
 *
s
,

957 *
¨g
, 
ngx_chaö_t
 *
ö
)

959 
ngx_πmp_c⁄√˘_t
 *
v
 = 
¨g
;

960 
ngx_öt_t
 
rc
;

961 
u_ch¨
 
≠p
[
NGX_RTMP_MAX_NAME
];

963 
ngx_°r_t
 
loˇti⁄
 = 
	`ngx_°rög
("location");

965 
rc
 = 
	`ngx_πmp_nŸify_∑r£_hâp_ªtcode
(
s
, 
ö
);

966 i‡(
rc
 =
NGX_ERROR
) {

967  
NGX_ERROR
;

970 i‡(
rc
 =
NGX_AGAIN
) {

971 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

974 
rc
 = 
	`ngx_πmp_nŸify_∑r£_hâp_hódî
(
s
, 
ö
, &
loˇti⁄
, 
≠p
,

975 (
≠p
) - 1);

976 i‡(
rc
 > 0) {

977 *
	`ngx_˝ymem
(
v
->
≠p
,áµ, 
rc
) = 0;

978 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

979 "nŸify: c⁄√˘Ñedúe˘Åÿ'%s'", 
v
->
≠p
);

983  
	`√xt_c⁄√˘
(
s
, 
v
);

984 
	}
}

988 
	$ngx_πmp_nŸify_£t_«me
(
u_ch¨
 *
d°
, 
size_t
 
d°_Àn
, u_ch¨ *
§c
,

989 
size_t
 
§c_Àn
)

991 
u_ch¨
 
ªsu…
[16], *
p
;

992 
ngx_md5_t
 
md5
;

994 
	`ngx_md5_öô
(&
md5
);

995 
	`ngx_md5_upd©e
(&
md5
, 
§c
, 
§c_Àn
);

996 
	`ngx_md5_föÆ
(
ªsu…
, &
md5
);

998 
p
 = 
	`ngx_hex_dump
(
d°
, 
ªsu…
, 
	`ngx_mö
((
d°_Àn
 - 1) / 2, 16));

999 *
p
 = '\0';

1000 
	}
}

1003 
ngx_öt_t


1004 
	$ngx_πmp_nŸify_publish_h™dÀ
(
ngx_πmp_£ssi⁄_t
 *
s
,

1005 *
¨g
, 
ngx_chaö_t
 *
ö
)

1007 
ngx_πmp_publish_t
 *
v
 = 
¨g
;

1008 
ngx_öt_t
 
rc
;

1009 
ngx_°r_t
 
loˇl_«me
;

1010 
ngx_πmp_ªœy_èrgë_t
 
èrgë
;

1011 
ngx_uæ_t
 *
u
;

1012 
ngx_πmp_nŸify_≠p_c⁄f_t
 *
«cf
;

1013 
u_ch¨
 
«me
[
NGX_RTMP_MAX_NAME
];

1015 
ngx_°r_t
 
loˇti⁄
 = 
	`ngx_°rög
("location");

1017 
rc
 = 
	`ngx_πmp_nŸify_∑r£_hâp_ªtcode
(
s
, 
ö
);

1018 i‡(
rc
 =
NGX_ERROR
) {

1019 
	`ngx_πmp_nŸify_˛ór_Êag
(
s
, 
NGX_RTMP_NOTIFY_PUBLISHING
);

1020  
NGX_ERROR
;

1023 i‡(
rc
 !
NGX_AGAIN
) {

1024 
√xt
;

1029 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1032 
rc
 = 
	`ngx_πmp_nŸify_∑r£_hâp_hódî
(
s
, 
ö
, &
loˇti⁄
, 
«me
,

1033 (
«me
) - 1);

1034 i‡(
rc
 <= 0) {

1035 
√xt
;

1038 i‡(
	`ngx_°∫ˇ£cmp
(
«me
, (
u_ch¨
 *) "rtmp://", 7)) {

1039 *
	`ngx_˝ymem
(
v
->
«me
,Çame, 
rc
) = 0;

1040 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1041 "nŸify:ÖublishÑedúe˘Åÿ'%s'", 
v
->
«me
);

1042 
√xt
;

1047 
«cf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_nŸify_moduÀ
);

1048 i‡(
«cf
->
ªœy_ªdúe˘
) {

1049 
	`ngx_πmp_nŸify_£t_«me
(
v
->
«me
, 
NGX_RTMP_MAX_NAME
,Çame, (
size_t
Ë
rc
);

1052 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1053 "nŸify:Öush '%s'Åÿ'%*s'", 
v
->
«me
, 
rc
,Çame);

1055 
loˇl_«me
.
d©a
 = 
v
->
«me
;

1056 
loˇl_«me
.
Àn
 = 
	`ngx_°æí
(
v
->
«me
);

1058 
	`ngx_memzîo
(&
èrgë
, (target));

1060 
u
 = &
èrgë
.
uæ
;

1061 
u
->
uæ
 = 
loˇl_«me
;

1062 
u
->
uæ
.
d©a
 = 
«me
 + 7;

1063 
u
->
uæ
.
Àn
 = 
rc
 - 7;

1064 
u
->
deÁu…_p‹t
 = 1935;

1065 
u
->
uri_∑π
 = 1;

1066 
u
->
no_ªsﬁve
 = 1;

1068 i‡(
	`ngx_∑r£_uæ
(
s
->
c⁄√˘i⁄
->
poﬁ
, 
u
Ë!
NGX_OK
) {

1069 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1070 "nŸify:Öush faûed '%V'", &
loˇl_«me
);

1071  
NGX_ERROR
;

1074 
	`ngx_πmp_ªœy_push
(
s
, &
loˇl_«me
, &
èrgë
);

1076 
√xt
:

1078  
	`√xt_publish
(
s
, 
v
);

1079 
	}
}

1082 
ngx_öt_t


1083 
	$ngx_πmp_nŸify_∂ay_h™dÀ
(
ngx_πmp_£ssi⁄_t
 *
s
,

1084 *
¨g
, 
ngx_chaö_t
 *
ö
)

1086 
ngx_πmp_∂ay_t
 *
v
 = 
¨g
;

1087 
ngx_öt_t
 
rc
;

1088 
ngx_°r_t
 
loˇl_«me
;

1089 
ngx_πmp_ªœy_èrgë_t
 
èrgë
;

1090 
ngx_uæ_t
 *
u
;

1091 
ngx_πmp_nŸify_≠p_c⁄f_t
 *
«cf
;

1092 
u_ch¨
 
«me
[
NGX_RTMP_MAX_NAME
];

1094 
ngx_°r_t
 
loˇti⁄
 = 
	`ngx_°rög
("location");

1096 
rc
 = 
	`ngx_πmp_nŸify_∑r£_hâp_ªtcode
(
s
, 
ö
);

1097 i‡(
rc
 =
NGX_ERROR
) {

1098 
	`ngx_πmp_nŸify_˛ór_Êag
(
s
, 
NGX_RTMP_NOTIFY_PLAYING
);

1099  
NGX_ERROR
;

1102 i‡(
rc
 !
NGX_AGAIN
) {

1103 
√xt
;

1108 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1111 
rc
 = 
	`ngx_πmp_nŸify_∑r£_hâp_hódî
(
s
, 
ö
, &
loˇti⁄
, 
«me
,

1112 (
«me
) - 1);

1113 i‡(
rc
 <= 0) {

1114 
√xt
;

1117 i‡(
	`ngx_°∫ˇ£cmp
(
«me
, (
u_ch¨
 *) "rtmp://", 7)) {

1118 *
	`ngx_˝ymem
(
v
->
«me
,Çame, 
rc
) = 0;

1119 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1120 "nŸify:ÖœyÑedúe˘Åÿ'%s'", 
v
->
«me
);

1121 
√xt
;

1126 
«cf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_nŸify_moduÀ
);

1127 i‡(
«cf
->
ªœy_ªdúe˘
) {

1128 
	`ngx_πmp_nŸify_£t_«me
(
v
->
«me
, 
NGX_RTMP_MAX_NAME
,Çame, (
size_t
Ë
rc
);

1131 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1132 "nŸify:ÖuŒ '%s' from '%*s'", 
v
->
«me
, 
rc
,Çame);

1134 
loˇl_«me
.
d©a
 = 
v
->
«me
;

1135 
loˇl_«me
.
Àn
 = 
	`ngx_°æí
(
v
->
«me
);

1137 
	`ngx_memzîo
(&
èrgë
, (target));

1139 
u
 = &
èrgë
.
uæ
;

1140 
u
->
uæ
 = 
loˇl_«me
;

1141 
u
->
uæ
.
d©a
 = 
«me
 + 7;

1142 
u
->
uæ
.
Àn
 = 
rc
 - 7;

1143 
u
->
deÁu…_p‹t
 = 1935;

1144 
u
->
uri_∑π
 = 1;

1145 
u
->
no_ªsﬁve
 = 1;

1147 i‡(
	`ngx_∑r£_uæ
(
s
->
c⁄√˘i⁄
->
poﬁ
, 
u
Ë!
NGX_OK
) {

1148 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1149 "nŸify:ÖuŒ faûed '%V'", &
loˇl_«me
);

1150  
NGX_ERROR
;

1153 
	`ngx_πmp_ªœy_puŒ
(
s
, &
loˇl_«me
, &
èrgë
);

1155 
√xt
:

1157  
	`√xt_∂ay
(
s
, 
v
);

1158 
	}
}

1161 
ngx_öt_t


1162 
	$ngx_πmp_nŸify_upd©e_h™dÀ
(
ngx_πmp_£ssi⁄_t
 *
s
,

1163 *
¨g
, 
ngx_chaö_t
 *
ö
)

1165 
ngx_πmp_nŸify_≠p_c⁄f_t
 *
«cf
;

1166 
ngx_πmp_nŸify_˘x_t
 *
˘x
;

1167 
ngx_öt_t
 
rc
;

1169 
«cf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_nŸify_moduÀ
);

1171 
rc
 = 
	`ngx_πmp_nŸify_∑r£_hâp_ªtcode
(
s
, 
ö
);

1173 i‡((!
«cf
->
upd©e_°ri˘
 && 
rc
 =
NGX_ERROR
) ||

1174 (
«cf
->
upd©e_°ri˘
 && 
rc
 !
NGX_OK
))

1176 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1179  
NGX_ERROR
;

1182 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_nŸify_moduÀ
);

1184 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1186 
«cf
->
upd©e_timeout
);

1188 
	`ngx_add_timî
(&
˘x
->
upd©e_evt
, 
«cf
->
upd©e_timeout
);

1190  
NGX_OK
;

1191 
	}
}

1195 
	$ngx_πmp_nŸify_upd©e
(
ngx_evít_t
 *
e
)

1197 
ngx_c⁄√˘i⁄_t
 *
c
;

1198 
ngx_πmp_£ssi⁄_t
 *
s
;

1199 
ngx_πmp_nŸify_≠p_c⁄f_t
 *
«cf
;

1200 
ngx_πmp_√tˇŒ_öô_t
 
ci
;

1201 
ngx_uæ_t
 *
uæ
;

1203 
c
 = 
e
->
d©a
;

1204 
s
 = 
c
->
d©a
;

1206 
«cf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_nŸify_moduÀ
);

1208 
uæ
 = 
«cf
->uæ[
NGX_RTMP_NOTIFY_UPDATE
];

1210 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1211 "nŸify: upd©ê'%V'", &
uæ
->url);

1213 
	`ngx_memzîo
(&
ci
, (ci));

1215 
ci
.
uæ
 = url;

1216 
ci
.
¸óã
 = 
ngx_πmp_nŸify_upd©e_¸óã
;

1217 
ci
.
h™dÀ
 = 
ngx_πmp_nŸify_upd©e_h™dÀ
;

1219 i‡(
	`ngx_πmp_√tˇŒ_¸óã
(
s
, &
ci
Ë=
NGX_OK
) {

1225 
	`ngx_πmp_nŸify_upd©e_h™dÀ
(
s
, 
NULL
, NULL);

1226 
	}
}

1230 
	$ngx_πmp_nŸify_öô
(
ngx_πmp_£ssi⁄_t
 *
s
,

1231 
u_ch¨
 
«me
[
NGX_RTMP_MAX_NAME
], u_ch¨ 
¨gs
[
NGX_RTMP_MAX_ARGS
],

1232 
ngx_uöt_t
 
Êags
)

1234 
ngx_πmp_nŸify_˘x_t
 *
˘x
;

1235 
ngx_πmp_nŸify_≠p_c⁄f_t
 *
«cf
;

1236 
ngx_evít_t
 *
e
;

1238 
«cf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_nŸify_moduÀ
);

1239 i‡(!
«cf
->
a˘ive
) {

1243 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_nŸify_moduÀ
);

1245 i‡(
˘x
 =
NULL
) {

1246 
˘x
 = 
	`ngx_pˇŒoc
(
s
->
c⁄√˘i⁄
->
poﬁ
, (
ngx_πmp_nŸify_˘x_t
));

1247 i‡(
˘x
 =
NULL
) {

1251 
	`ngx_πmp_£t_˘x
(
s
, 
˘x
, 
ngx_πmp_nŸify_moduÀ
);

1254 
	`ngx_mem˝y
(
˘x
->
«me
,Çame, 
NGX_RTMP_MAX_NAME
);

1255 
	`ngx_mem˝y
(
˘x
->
¨gs
,árgs, 
NGX_RTMP_MAX_ARGS
);

1257 
˘x
->
Êags
 |= flags;

1259 i‡(
«cf
->
uæ
[
NGX_RTMP_NOTIFY_UPDATE
] =
NULL
 ||

1260 
«cf
->
upd©e_timeout
 == 0)

1265 i‡(
˘x
->
upd©e_evt
.
timî_£t
) {

1269 
˘x
->
°¨t
 = 
ngx_ˇched_time
->
£c
;

1271 
e
 = &
˘x
->
upd©e_evt
;

1273 
e
->
d©a
 = 
s
->
c⁄√˘i⁄
;

1274 
e
->
log
 = 
s
->
c⁄√˘i⁄
->log;

1275 
e
->
h™dÀr
 = 
ngx_πmp_nŸify_upd©e
;

1277 
	`ngx_add_timî
(
e
, 
«cf
->
upd©e_timeout
);

1279 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1281 
«cf
->
upd©e_timeout
);

1282 
	}
}

1285 
ngx_öt_t


1286 
	$ngx_πmp_nŸify_c⁄√˘
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_c⁄√˘_t
 *
v
)

1288 
ngx_πmp_nŸify_§v_c⁄f_t
 *
nscf
;

1289 
ngx_πmp_√tˇŒ_öô_t
 
ci
;

1290 
ngx_uæ_t
 *
uæ
;

1292 i‡(
s
->
auto_pushed
 || s->
ªœy
) {

1293 
√xt
;

1296 
nscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_nŸify_moduÀ
);

1298 
uæ
 = 
nscf
->uæ[
NGX_RTMP_NOTIFY_CONNECT
];

1299 i‡(
uæ
 =
NULL
) {

1300 
√xt
;

1303 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1304 "nŸify: c⁄√˘ '%V'", &
uæ
->url);

1306 
	`ngx_memzîo
(&
ci
, (ci));

1308 
ci
.
uæ
 = url;

1309 
ci
.
¸óã
 = 
ngx_πmp_nŸify_c⁄√˘_¸óã
;

1310 
ci
.
h™dÀ
 = 
ngx_πmp_nŸify_c⁄√˘_h™dÀ
;

1311 
ci
.
¨g
 = 
v
;

1312 
ci
.
¨gsize
 = (*
v
);

1314  
	`ngx_πmp_√tˇŒ_¸óã
(
s
, &
ci
);

1316 
√xt
:

1317  
	`√xt_c⁄√˘
(
s
, 
v
);

1318 
	}
}

1321 
ngx_öt_t


1322 
	$ngx_πmp_nŸify_disc⁄√˘
(
ngx_πmp_£ssi⁄_t
 *
s
)

1324 
ngx_πmp_nŸify_§v_c⁄f_t
 *
nscf
;

1325 
ngx_πmp_√tˇŒ_öô_t
 
ci
;

1326 
ngx_uæ_t
 *
uæ
;

1328 i‡(
s
->
auto_pushed
 || s->
ªœy
) {

1329 
√xt
;

1332 
nscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_nŸify_moduÀ
);

1334 
uæ
 = 
nscf
->uæ[
NGX_RTMP_NOTIFY_DISCONNECT
];

1335 i‡(
uæ
 =
NULL
) {

1336 
√xt
;

1339 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1340 "nŸify: disc⁄√˘ '%V'", &
uæ
->url);

1342 
	`ngx_memzîo
(&
ci
, (ci));

1344 
ci
.
uæ
 = url;

1345 
ci
.
¸óã
 = 
ngx_πmp_nŸify_disc⁄√˘_¸óã
;

1347 
	`ngx_πmp_√tˇŒ_¸óã
(
s
, &
ci
);

1349 
√xt
:

1350  
	`√xt_disc⁄√˘
(
s
);

1351 
	}
}

1354 
ngx_öt_t


1355 
	$ngx_πmp_nŸify_publish
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_publish_t
 *
v
)

1357 
ngx_πmp_nŸify_≠p_c⁄f_t
 *
«cf
;

1358 
ngx_πmp_√tˇŒ_öô_t
 
ci
;

1359 
ngx_uæ_t
 *
uæ
;

1361 i‡(
s
->
auto_pushed
) {

1362 
√xt
;

1365 
«cf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_nŸify_moduÀ
);

1366 i‡(
«cf
 =
NULL
) {

1367 
√xt
;

1370 
uæ
 = 
«cf
->uæ[
NGX_RTMP_NOTIFY_PUBLISH
];

1372 
	`ngx_πmp_nŸify_öô
(
s
, 
v
->
«me
, v->
¨gs
, 
NGX_RTMP_NOTIFY_PUBLISHING
);

1374 i‡(
uæ
 =
NULL
) {

1375 
√xt
;

1378 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1379 "nŸify:Öublish '%V'", &
uæ
->url);

1381 
	`ngx_memzîo
(&
ci
, (ci));

1383 
ci
.
uæ
 = url;

1384 
ci
.
¸óã
 = 
ngx_πmp_nŸify_publish_¸óã
;

1385 
ci
.
h™dÀ
 = 
ngx_πmp_nŸify_publish_h™dÀ
;

1386 
ci
.
¨g
 = 
v
;

1387 
ci
.
¨gsize
 = (*
v
);

1389  
	`ngx_πmp_√tˇŒ_¸óã
(
s
, &
ci
);

1391 
√xt
:

1392  
	`√xt_publish
(
s
, 
v
);

1393 
	}
}

1396 
ngx_öt_t


1397 
	$ngx_πmp_nŸify_∂ay
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_∂ay_t
 *
v
)

1399 
ngx_πmp_nŸify_≠p_c⁄f_t
 *
«cf
;

1400 
ngx_πmp_√tˇŒ_öô_t
 
ci
;

1401 
ngx_uæ_t
 *
uæ
;

1403 i‡(
s
->
auto_pushed
) {

1404 
√xt
;

1407 
«cf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_nŸify_moduÀ
);

1408 i‡(
«cf
 =
NULL
) {

1409 
√xt
;

1412 
uæ
 = 
«cf
->uæ[
NGX_RTMP_NOTIFY_PLAY
];

1414 
	`ngx_πmp_nŸify_öô
(
s
, 
v
->
«me
, v->
¨gs
, 
NGX_RTMP_NOTIFY_PLAYING
);

1416 i‡(
uæ
 =
NULL
) {

1417 
√xt
;

1420 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1421 "nŸify:Öœy '%V'", &
uæ
->url);

1423 
	`ngx_memzîo
(&
ci
, (ci));

1425 
ci
.
uæ
 = url;

1426 
ci
.
¸óã
 = 
ngx_πmp_nŸify_∂ay_¸óã
;

1427 
ci
.
h™dÀ
 = 
ngx_πmp_nŸify_∂ay_h™dÀ
;

1428 
ci
.
¨g
 = 
v
;

1429 
ci
.
¨gsize
 = (*
v
);

1431  
	`ngx_πmp_√tˇŒ_¸óã
(
s
, &
ci
);

1433 
√xt
:

1434  
	`√xt_∂ay
(
s
, 
v
);

1435 
	}
}

1438 
ngx_öt_t


1439 
	$ngx_πmp_nŸify_˛o£_°ªam
(
ngx_πmp_£ssi⁄_t
 *
s
,

1440 
ngx_πmp_˛o£_°ªam_t
 *
v
)

1442 
ngx_πmp_nŸify_˘x_t
 *
˘x
;

1443 
ngx_πmp_nŸify_≠p_c⁄f_t
 *
«cf
;

1445 i‡(
s
->
auto_pushed
) {

1446 
√xt
;

1449 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_nŸify_moduÀ
);

1451 i‡(
˘x
 =
NULL
) {

1452 
√xt
;

1455 
«cf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_nŸify_moduÀ
);

1457 i‡(
«cf
 =
NULL
) {

1458 
√xt
;

1461 i‡(
˘x
->
Êags
 & 
NGX_RTMP_NOTIFY_PUBLISHING
) {

1462 
	`ngx_πmp_nŸify_d⁄e
(
s
, "publish_d⁄e", 
NGX_RTMP_NOTIFY_PUBLISH_DONE
);

1465 i‡(
˘x
->
Êags
 & 
NGX_RTMP_NOTIFY_PLAYING
) {

1466 
	`ngx_πmp_nŸify_d⁄e
(
s
, "∂ay_d⁄e", 
NGX_RTMP_NOTIFY_PLAY_DONE
);

1469 i‡(
˘x
->
Êags
) {

1470 
	`ngx_πmp_nŸify_d⁄e
(
s
, "d⁄e", 
NGX_RTMP_NOTIFY_DONE
);

1473 i‡(
˘x
->
upd©e_evt
.
timî_£t
) {

1474 
	`ngx_dñ_timî
(&
˘x
->
upd©e_evt
);

1477 
˘x
->
Êags
 = 0;

1479 
√xt
:

1480  
	`√xt_˛o£_°ªam
(
s
, 
v
);

1481 
	}
}

1484 
ngx_öt_t


1485 
	$ngx_πmp_nŸify_ªc‹d_d⁄e
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_ªc‹d_d⁄e_t
 *
v
)

1487 
ngx_πmp_√tˇŒ_öô_t
 
ci
;

1488 
ngx_πmp_nŸify_≠p_c⁄f_t
 *
«cf
;

1490 i‡(
s
->
auto_pushed
) {

1491 
√xt
;

1494 
«cf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_nŸify_moduÀ
);

1495 i‡(
«cf
 =
NULL
 ||Çacf->
uæ
[
NGX_RTMP_NOTIFY_RECORD_DONE
] == NULL) {

1496 
√xt
;

1499 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1501 &
v
->
ªc‹dî
, &v->
∑th
,

1502 &
«cf
->
uæ
[
NGX_RTMP_NOTIFY_RECORD_DONE
]->url);

1504 
	`ngx_memzîo
(&
ci
, (ci));

1506 
ci
.
uæ
 = 
«cf
->uæ[
NGX_RTMP_NOTIFY_RECORD_DONE
];

1507 
ci
.
¸óã
 = 
ngx_πmp_nŸify_ªc‹d_d⁄e_¸óã
;

1508 
ci
.
¨g
 = 
v
;

1510 
	`ngx_πmp_√tˇŒ_¸óã
(
s
, &
ci
);

1512 
√xt
:

1513  
	`√xt_ªc‹d_d⁄e
(
s
, 
v
);

1514 
	}
}

1517 
ngx_öt_t


1518 
	$ngx_πmp_nŸify_d⁄e
(
ngx_πmp_£ssi⁄_t
 *
s
, *
cb«me
, 
ngx_uöt_t
 
uæ_idx
)

1520 
ngx_πmp_√tˇŒ_öô_t
 
ci
;

1521 
ngx_πmp_nŸify_d⁄e_t
 
ds
;

1522 
ngx_πmp_nŸify_≠p_c⁄f_t
 *
«cf
;

1523 
ngx_uæ_t
 *
uæ
;

1525 
«cf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_nŸify_moduÀ
);

1527 
uæ
 = 
«cf
->uæ[
uæ_idx
];

1528 i‡(
uæ
 =
NULL
) {

1529  
NGX_OK
;

1532 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1533 "nŸify: %†'%V'", 
cb«me
, &
uæ
->url);

1535 
ds
.
cb«me
 = (
u_ch¨
 *) cbname;

1536 
ds
.
uæ_idx
 = url_idx;

1538 
	`ngx_memzîo
(&
ci
, (ci));

1540 
ci
.
uæ
 = url;

1541 
ci
.
¨g
 = &
ds
;

1542 
ci
.
¸óã
 = 
ngx_πmp_nŸify_d⁄e_¸óã
;

1544  
	`ngx_πmp_√tˇŒ_¸óã
(
s
, &
ci
);

1545 
	}
}

1548 
ngx_uæ_t
 *

1549 
	$ngx_πmp_nŸify_∑r£_uæ
(
ngx_c⁄f_t
 *
cf
, 
ngx_°r_t
 *
uæ
)

1551 
ngx_uæ_t
 *
u
;

1552 
size_t
 
add
;

1554 
add
 = 0;

1556 
u
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_uæ_t
));

1557 i‡(
u
 =
NULL
) {

1558  
NULL
;

1561 i‡(
	`ngx_°∫ˇ£cmp
(
uæ
->
d©a
, (
u_ch¨
 *) "http://", 7) == 0) {

1562 
add
 = 7;

1565 
u
->
uæ
.
Àn
 = uæ->À¿- 
add
;

1566 
u
->
uæ
.
d©a
 = uæ->d©®+ 
add
;

1567 
u
->
deÁu…_p‹t
 = 80;

1568 
u
->
uri_∑π
 = 1;

1570 i‡(
	`ngx_∑r£_uæ
(
cf
->
poﬁ
, 
u
Ë!
NGX_OK
) {

1571 i‡(
u
->
îr
) {

1572 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

1573 "%†ö uæ \"%V\"", 
u
->
îr
, &u->
uæ
);

1575  
NULL
;

1578  
u
;

1579 
	}
}

1583 
	$ngx_πmp_nŸify_⁄_§v_evít
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1585 
ngx_πmp_nŸify_§v_c⁄f_t
 *
nscf
 = 
c⁄f
;

1587 
ngx_°r_t
 *
«me
, *
vÆue
;

1588 
ngx_uæ_t
 *
u
;

1589 
ngx_uöt_t
 
n
;

1591 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1593 
u
 = 
	`ngx_πmp_nŸify_∑r£_uæ
(
cf
, &
vÆue
[1]);

1594 i‡(
u
 =
NULL
) {

1595  
NGX_CONF_ERROR
;

1598 
«me
 = &
vÆue
[0];

1600 
n
 = 0;

1602 
«me
->
Àn
) {

1604 
n
 = 
NGX_RTMP_NOTIFY_CONNECT
;

1608 
n
 = 
NGX_RTMP_NOTIFY_DISCONNECT
;

1612 
nscf
->
uæ
[
n
] = 
u
;

1614  
NGX_CONF_OK
;

1615 
	}
}

1619 
	$ngx_πmp_nŸify_⁄_≠p_evít
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1621 
ngx_πmp_nŸify_≠p_c⁄f_t
 *
«cf
 = 
c⁄f
;

1623 
ngx_°r_t
 *
«me
, *
vÆue
;

1624 
ngx_uæ_t
 *
u
;

1625 
ngx_uöt_t
 
n
;

1627 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1629 
u
 = 
	`ngx_πmp_nŸify_∑r£_uæ
(
cf
, &
vÆue
[1]);

1630 i‡(
u
 =
NULL
) {

1631  
NGX_CONF_ERROR
;

1634 
«me
 = &
vÆue
[0];

1636 
n
 = 0;

1638 
«me
->
Àn
) {

1640 i‡(
«me
->
d©a
[3] == 'd') {

1641 
n
 = 
NGX_RTMP_NOTIFY_DONE
;

1643 
n
 = 
NGX_RTMP_NOTIFY_PLAY
;

1648 
n
 = 
NGX_RTMP_NOTIFY_UPDATE
;

1652 
n
 = 
NGX_RTMP_NOTIFY_PUBLISH
;

1656 
n
 = 
NGX_RTMP_NOTIFY_PLAY_DONE
;

1660 
n
 = 
NGX_RTMP_NOTIFY_RECORD_DONE
;

1664 
n
 = 
NGX_RTMP_NOTIFY_PUBLISH_DONE
;

1668 
«cf
->
uæ
[
n
] = 
u
;

1670  
NGX_CONF_OK
;

1671 
	}
}

1675 
	$ngx_πmp_nŸify_mëhod
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1677 
ngx_πmp_nŸify_≠p_c⁄f_t
 *
«cf
 = 
c⁄f
;

1679 
ngx_πmp_nŸify_§v_c⁄f_t
 *
nscf
;

1680 
ngx_°r_t
 *
vÆue
;

1682 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1683 
vÆue
++;

1685 i‡(
vÆue
->
Àn
 == ("get") - 1 &&

1686 
	`ngx_°∫ˇ£cmp
(
vÆue
->
d©a
, (
u_ch¨
 *Ë"gë", vÆue->
Àn
) == 0)

1688 
«cf
->
mëhod
 = 
NGX_RTMP_NETCALL_HTTP_GET
;

1690 } i‡(
vÆue
->
Àn
 == ("post") - 1 &&

1691 
	`ngx_°∫ˇ£cmp
(
vÆue
->
d©a
, (
u_ch¨
 *Ë"po°", vÆue->
Àn
) == 0)

1693 
«cf
->
mëhod
 = 
NGX_RTMP_NETCALL_HTTP_POST
;

1699 
nscf
 = 
	`ngx_πmp_c⁄f_gë_moduÀ_§v_c⁄f
(
cf
, 
ngx_πmp_nŸify_moduÀ
);

1700 
nscf
->
mëhod
 = 
«cf
->method;

1702  
NGX_CONF_OK
;

1703 
	}
}

1706 
ngx_öt_t


1707 
	$ngx_πmp_nŸify_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
)

1709 
√xt_c⁄√˘
 = 
ngx_πmp_c⁄√˘
;

1710 
ngx_πmp_c⁄√˘
 = 
ngx_πmp_nŸify_c⁄√˘
;

1712 
√xt_disc⁄√˘
 = 
ngx_πmp_disc⁄√˘
;

1713 
ngx_πmp_disc⁄√˘
 = 
ngx_πmp_nŸify_disc⁄√˘
;

1715 
√xt_publish
 = 
ngx_πmp_publish
;

1716 
ngx_πmp_publish
 = 
ngx_πmp_nŸify_publish
;

1718 
√xt_∂ay
 = 
ngx_πmp_∂ay
;

1719 
ngx_πmp_∂ay
 = 
ngx_πmp_nŸify_∂ay
;

1721 
√xt_˛o£_°ªam
 = 
ngx_πmp_˛o£_°ªam
;

1722 
ngx_πmp_˛o£_°ªam
 = 
ngx_πmp_nŸify_˛o£_°ªam
;

1724 
√xt_ªc‹d_d⁄e
 = 
ngx_πmp_ªc‹d_d⁄e
;

1725 
ngx_πmp_ªc‹d_d⁄e
 = 
ngx_πmp_nŸify_ªc‹d_d⁄e
;

1727  
NGX_OK
;

1728 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_play_module.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~<ngöx.h
>

10 
	~"ngx_πmp_∂ay_moduÀ.h
"

11 
	~"ngx_πmp_cmd_moduÀ.h
"

12 
	~"ngx_πmp_√tˇŒ_moduÀ.h
"

13 
	~"ngx_πmp_°ªams.h
"

16 
ngx_πmp_∂ay_±
 
	g√xt_∂ay
;

17 
ngx_πmp_˛o£_°ªam_±
 
	g√xt_˛o£_°ªam
;

18 
ngx_πmp_£ek_±
 
	g√xt_£ek
;

19 
ngx_πmp_∑u£_±
 
	g√xt_∑u£
;

22 *
ngx_πmp_∂ay_uæ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
,

23 *
c⁄f
);

24 *
ngx_πmp_∂ay_¸óã_maö_c⁄f
(
ngx_c⁄f_t
 *
cf
);

25 
ngx_öt_t
 
ngx_πmp_∂ay_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
);

26 * 
ngx_πmp_∂ay_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
);

27 * 
ngx_πmp_∂ay_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
,

28 *
∑ª¡
, *
chûd
);

30 
ngx_öt_t
 
ngx_πmp_∂ay_do_öô
(
ngx_πmp_£ssi⁄_t
 *
s
);

31 
ngx_öt_t
 
ngx_πmp_∂ay_do_d⁄e
(
ngx_πmp_£ssi⁄_t
 *
s
);

32 
ngx_öt_t
 
ngx_πmp_∂ay_do_°¨t
(
ngx_πmp_£ssi⁄_t
 *
s
);

33 
ngx_öt_t
 
ngx_πmp_∂ay_do_°›
(
ngx_πmp_£ssi⁄_t
 *
s
);

34 
ngx_öt_t
 
ngx_πmp_∂ay_do_£ek
(
ngx_πmp_£ssi⁄_t
 *
s
,

35 
ngx_uöt_t
 
time°amp
);

37 
ngx_öt_t
 
ngx_πmp_∂ay_∂ay
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_∂ay_t
 *
v
);

38 
ngx_öt_t
 
ngx_πmp_∂ay_£ek
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_£ek_t
 *
v
);

39 
ngx_öt_t
 
ngx_πmp_∂ay_∑u£
(
ngx_πmp_£ssi⁄_t
 *
s
,

40 
ngx_πmp_∑u£_t
 *
v
);

41 
ngx_πmp_∂ay_£nd
(
ngx_evít_t
 *
e
);

42 
ngx_öt_t
 
ngx_πmp_∂ay_›í
(
ngx_πmp_£ssi⁄_t
 *
s
, 
°¨t
);

43 
ngx_öt_t
 
ngx_πmp_∂ay_ªmŸe_h™dÀ
(
ngx_πmp_£ssi⁄_t
 *
s
,

44 *
¨g
, 
ngx_chaö_t
 *
ö
);

45 
ngx_chaö_t
 * 
ngx_πmp_∂ay_ªmŸe_¸óã
(
ngx_πmp_£ssi⁄_t
 *
s
,

46 *
¨g
, 
ngx_poﬁ_t
 *
poﬁ
);

47 
ngx_öt_t
 
ngx_πmp_∂ay_›í_ªmŸe
(
ngx_πmp_£ssi⁄_t
 *
s
,

48 
ngx_πmp_∂ay_t
 *
v
);

49 
ngx_öt_t
 
ngx_πmp_∂ay_√xt_íåy
(
ngx_πmp_£ssi⁄_t
 *
s
,

50 
ngx_πmp_∂ay_t
 *
v
);

51 
ngx_πmp_∂ay_íåy_t
 * 
ngx_πmp_∂ay_gë_cuºít_íåy
(

52 
ngx_πmp_£ssi⁄_t
 *
s
);

53 
ngx_πmp_∂ay_˛ónup_loˇl_fûe
(
ngx_πmp_£ssi⁄_t
 *
s
);

54 
ngx_πmp_∂ay_c›y_loˇl_fûe
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
«me
);

55 
u_ch¨
 * 
ngx_πmp_∂ay_gë_loˇl_fûe_∑th
(
ngx_πmp_£ssi⁄_t
 *
s
);

58 
ngx_comm™d_t
 
	gngx_πmp_∂ay_comm™ds
[] = {

60 { 
ngx_°rög
("play"),

61 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_1MORE
,

62 
ngx_πmp_∂ay_uæ
,

63 
NGX_RTMP_APP_CONF_OFFSET
,

65 
NULL
 },

67 { 
ngx_°rög
("play_temp_path"),

68 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

69 
ngx_c⁄f_£t_°r_¶Ÿ
,

70 
NGX_RTMP_APP_CONF_OFFSET
,

71 
off£tof
(
ngx_πmp_∂ay_≠p_c⁄f_t
, 
ãmp_∑th
),

72 
NULL
 },

74 { 
ngx_°rög
("play_local_path"),

75 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

76 
ngx_c⁄f_£t_°r_¶Ÿ
,

77 
NGX_RTMP_APP_CONF_OFFSET
,

78 
off£tof
(
ngx_πmp_∂ay_≠p_c⁄f_t
, 
loˇl_∑th
),

79 
NULL
 },

81 
ngx_nuŒ_comm™d


85 
ngx_πmp_moduÀ_t
 
	gngx_πmp_∂ay_moduÀ_˘x
 = {

86 
NULL
,

87 
ngx_πmp_∂ay_po°c⁄figuøti⁄
,

88 
ngx_πmp_∂ay_¸óã_maö_c⁄f
,

89 
NULL
,

90 
NULL
,

91 
NULL
,

92 
ngx_πmp_∂ay_¸óã_≠p_c⁄f
,

93 
ngx_πmp_∂ay_mîge_≠p_c⁄f


97 
ngx_moduÀ_t
 
	gngx_πmp_∂ay_moduÀ
 = {

98 
NGX_MODULE_V1
,

99 &
ngx_πmp_∂ay_moduÀ_˘x
,

100 
ngx_πmp_∂ay_comm™ds
,

101 
NGX_RTMP_MODULE
,

102 
NULL
,

103 
NULL
,

104 
NULL
,

105 
NULL
,

106 
NULL
,

107 
NULL
,

108 
NULL
,

109 
NGX_MODULE_V1_PADDING


113 
	#NGX_RTMP_PLAY_TMP_FILE
 "ngöx-πmp-vod."

	)

117 
	$ngx_πmp_∂ay_¸óã_maö_c⁄f
(
ngx_c⁄f_t
 *
cf
)

119 
ngx_πmp_∂ay_maö_c⁄f_t
 *
pmcf
;

121 
pmcf
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_∂ay_maö_c⁄f_t
));

122 i‡(
pmcf
 =
NULL
) {

123  
NULL
;

126 i‡(
	`ngx_¨øy_öô
(&
pmcf
->
fmts
, 
cf
->
poﬁ
, 1,

127 (
ngx_πmp_∂ay_fmt_t
 *))

128 !
NGX_OK
)

130  
NULL
;

133  
pmcf
;

134 
	}
}

138 
	$ngx_πmp_∂ay_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
)

140 
ngx_πmp_∂ay_≠p_c⁄f_t
 *
∑cf
;

142 
∑cf
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_∂ay_≠p_c⁄f_t
));

143 i‡(
∑cf
 =
NULL
) {

144  
NULL
;

147 
∑cf
->
nbuckës
 = 1024;

149  
∑cf
;

150 
	}
}

154 
	$ngx_πmp_∂ay_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
∑ª¡
, *
chûd
)

156 
ngx_πmp_∂ay_≠p_c⁄f_t
 *
¥ev
 = 
∑ª¡
;

157 
ngx_πmp_∂ay_≠p_c⁄f_t
 *
c⁄f
 = 
chûd
;

158 
ngx_πmp_∂ay_íåy_t
 **
µe
;

160 
	`ngx_c⁄f_mîge_°r_vÆue
(
c⁄f
->
ãmp_∑th
, 
¥ev
->temp_path, "/tmp");

161 
	`ngx_c⁄f_mîge_°r_vÆue
(
c⁄f
->
loˇl_∑th
, 
¥ev
->local_path, "");

163 i‡(
¥ev
->
íåõs
.
√…s
 == 0) {

164 
d⁄e
;

167 i‡(
c⁄f
->
íåõs
.
√…s
 == 0) {

168 
c⁄f
->
íåõs
 = 
¥ev
->entries;

169 
d⁄e
;

172 
µe
 = 
	`ngx_¨øy_push_n
(&
c⁄f
->
íåõs
, 
¥ev
->íåõs.
√…s
);

173 i‡(
µe
 =
NULL
) {

174  
NGX_CONF_ERROR
;

177 
	`ngx_mem˝y
(
µe
, 
¥ev
->
íåõs
.
ñts
,Öªv->íåõs.
√…s
 * (*));

179 
d⁄e
:

181 i‡(
c⁄f
->
íåõs
.
√…s
 == 0) {

182  
NGX_CONF_OK
;

185 
c⁄f
->
˘x
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (*Ë* c⁄f->
nbuckës
);

186 i‡(
c⁄f
->
˘x
 =
NULL
) {

187  
NGX_CONF_ERROR
;

190  
NGX_CONF_OK
;

191 
	}
}

194 
ngx_öt_t


195 
	$ngx_πmp_∂ay_joö
(
ngx_πmp_£ssi⁄_t
 *
s
)

197 
ngx_πmp_∂ay_˘x_t
 *
˘x
, **
p˘x
;

198 
ngx_πmp_∂ay_≠p_c⁄f_t
 *
∑cf
;

199 
ngx_uöt_t
 
h
;

201 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

204 
∑cf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_∂ay_moduÀ
);

206 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_∂ay_moduÀ
);

207 i‡(
˘x
 =
NULL
 || ctx->
joöed
) {

208  
NGX_ERROR
;

211 
h
 = 
	`ngx_hash_key
(
˘x
->
«me
, 
	`ngx_°æí
(ctx->name));

212 
p˘x
 = &
∑cf
->
˘x
[
h
 %Öacf->
nbuckës
];

214 *
p˘x
) {

215 i‡(!
	`ngx_°∫cmp
((*
p˘x
)->
«me
, 
˘x
->«me, 
NGX_RTMP_MAX_NAME
)) {

218 
p˘x
 = &(*p˘x)->
√xt
;

221 
˘x
->
√xt
 = *
p˘x
;

222 *
p˘x
 = 
˘x
;

223 
˘x
->
joöed
 = 1;

225  
NGX_OK
;

226 
	}
}

229 
ngx_öt_t


230 
	$ngx_πmp_∂ay_Àave
(
ngx_πmp_£ssi⁄_t
 *
s
)

232 
ngx_πmp_∂ay_˘x_t
 *
˘x
, **
p˘x
;

233 
ngx_πmp_∂ay_≠p_c⁄f_t
 *
∑cf
;

234 
ngx_uöt_t
 
h
;

236 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

239 
∑cf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_∂ay_moduÀ
);

241 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_∂ay_moduÀ
);

242 i‡(
˘x
 =
NULL
 || !˘x->
joöed
) {

243  
NGX_ERROR
;

246 
h
 = 
	`ngx_hash_key
(
˘x
->
«me
, 
	`ngx_°æí
(ctx->name));

247 
p˘x
 = &
∑cf
->
˘x
[
h
 %Öacf->
nbuckës
];

249 *
p˘x
 && *p˘x !
˘x
) {

250 
p˘x
 = &(*p˘x)->
√xt
;

253 i‡(*
p˘x
 =
NULL
) {

254  
NGX_ERROR
;

257 *
p˘x
 = (*p˘x)->
√xt
;

258 
˘x
->
joöed
 = 0;

260  
NGX_OK
;

261 
	}
}

265 
	$ngx_πmp_∂ay_£nd
(
ngx_evít_t
 *
e
)

267 
ngx_πmp_£ssi⁄_t
 *
s
 = 
e
->
d©a
;

268 
ngx_πmp_∂ay_˘x_t
 *
˘x
;

269 
ngx_öt_t
 
rc
;

270 
ngx_uöt_t
 
ts
;

272 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_∂ay_moduÀ
);

274 i‡(
˘x
 =
NULL
 || ctx->
fmt
 =NULL || ctx->fmt->
£nd
 == NULL) {

278 
ts
 = 0;

280 
rc
 = 
˘x
->
fmt
->
	`£nd
(
s
, &˘x->
fûe
, &
ts
);

282 i‡(
rc
 > 0) {

283 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

284 "∂ay: síd scheduÀ %i", 
rc
);

286 
	`ngx_add_timî
(
e
, 
rc
);

290 i‡(
rc
 =
NGX_AGAIN
) {

291 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

294 
	`ngx_po°_evít
(
e
, &
s
->
po°ed_dry_evíts
);

298 i‡(
rc
 =
NGX_OK
) {

299 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

302 
	`ngx_po°_evít
(
e
, &
ngx_po°ed_evíts
);

307 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

310 
	`ngx_πmp_£nd_°ªam_eof
(
s
, 
NGX_RTMP_MSID
);

312 
	`ngx_πmp_£nd_∂ay_°©us
(
s
, "NëSåóm.Pœy.Com∂ëe", "°©us", 
ts
, 0);

314 
	`ngx_πmp_£nd_°©us
(
s
, "NetStream.Play.Stop", "status", "Stopped");

315 
	}
}

318 
ngx_öt_t


319 
	$ngx_πmp_∂ay_do_öô
(
ngx_πmp_£ssi⁄_t
 *
s
)

321 
ngx_πmp_∂ay_˘x_t
 *
˘x
;

323 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_∂ay_moduÀ
);

325 i‡(
˘x
 =
NULL
) {

326  
NGX_ERROR
;

329 i‡(
˘x
->
fmt
 && ctx->fmt->
öô
 &&

330 
˘x
->
fmt
->
	`öô
(
s
, &˘x->
fûe
, ctx->
aödex
, ctx->
vödex
Ë!
NGX_OK
)

332  
NGX_ERROR
;

335  
NGX_OK
;

336 
	}
}

339 
ngx_öt_t


340 
	$ngx_πmp_∂ay_do_d⁄e
(
ngx_πmp_£ssi⁄_t
 *
s
)

342 
ngx_πmp_∂ay_˘x_t
 *
˘x
;

344 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_∂ay_moduÀ
);

346 i‡(
˘x
 =
NULL
) {

347  
NGX_ERROR
;

350 i‡(
˘x
->
fmt
 && ctx->fmt->
d⁄e
 &&

351 
˘x
->
fmt
->
	`d⁄e
(
s
, &˘x->
fûe
Ë!
NGX_OK
)

353  
NGX_ERROR
;

356  
NGX_OK
;

357 
	}
}

360 
ngx_öt_t


361 
	$ngx_πmp_∂ay_do_°¨t
(
ngx_πmp_£ssi⁄_t
 *
s
)

363 
ngx_πmp_∂ay_˘x_t
 *
˘x
;

365 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_∂ay_moduÀ
);

367 i‡(
˘x
 =
NULL
) {

368  
NGX_ERROR
;

371 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

374 i‡(
˘x
->
fmt
 && ctx->fmt->
°¨t
 &&

375 
˘x
->
fmt
->
	`°¨t
(
s
, &˘x->
fûe
Ë!
NGX_OK
)

377  
NGX_ERROR
;

380 
	`ngx_po°_evít
((&
˘x
->
£nd_evt
), &
ngx_po°ed_evíts
);

382 
˘x
->
∂ayög
 = 1;

384  
NGX_OK
;

385 
	}
}

388 
ngx_öt_t


389 
	$ngx_πmp_∂ay_do_£ek
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_uöt_t
 
time°amp
)

391 
ngx_πmp_∂ay_˘x_t
 *
˘x
;

393 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_∂ay_moduÀ
);

395 i‡(
˘x
 =
NULL
) {

396  
NGX_ERROR
;

399 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

400 "∂ay: sìkÅime°amp=%ui", 
time°amp
);

402 i‡(
˘x
->
fmt
 && ctx->fmt->
£ek
 &&

403 
˘x
->
fmt
->
	`£ek
(
s
, &˘x->
fûe
, 
time°amp
Ë!
NGX_OK
)

405  
NGX_ERROR
;

408 i‡(
˘x
->
∂ayög
) {

409 
	`ngx_po°_evít
((&
˘x
->
£nd_evt
), &
ngx_po°ed_evíts
);

412  
NGX_OK
;

413 
	}
}

416 
ngx_öt_t


417 
	$ngx_πmp_∂ay_do_°›
(
ngx_πmp_£ssi⁄_t
 *
s
)

419 
ngx_πmp_∂ay_˘x_t
 *
˘x
;

421 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_∂ay_moduÀ
);

423 i‡(
˘x
 =
NULL
) {

424  
NGX_ERROR
;

427 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

430 i‡(
˘x
->
£nd_evt
.
timî_£t
) {

431 
	`ngx_dñ_timî
(&
˘x
->
£nd_evt
);

434 #i‡(
ngöx_vîsi⁄
 >= 1007005)

435 i‡(
˘x
->
£nd_evt
.
po°ed
)

437 i‡(
˘x
->
£nd_evt
.
¥ev
)

440 
	`ngx_dñëe_po°ed_evít
((&
˘x
->
£nd_evt
));

443 i‡(
˘x
->
fmt
 && ctx->fmt->
°›
 &&

444 
˘x
->
fmt
->
	`°›
(
s
, &˘x->
fûe
Ë!
NGX_OK
)

446  
NGX_ERROR
;

449 
˘x
->
∂ayög
 = 0;

451  
NGX_OK
;

452 
	}
}

457 
u_ch¨
 *

458 
	$ngx_πmp_∂ay_gë_loˇl_fûe_∑th
(
ngx_πmp_£ssi⁄_t
 *
s
)

460 
ngx_πmp_∂ay_≠p_c⁄f_t
 *
∑cf
;

461 
ngx_πmp_∂ay_˘x_t
 *
˘x
;

462 
u_ch¨
 *
p
;

463 
u_ch¨
 
∑th
[
NGX_MAX_PATH
 + 1];

465 
∑cf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_∂ay_moduÀ
);

467 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_∂ay_moduÀ
);

469 
p
 = 
	`ngx_¢¥ötf
(
∑th
, 
NGX_MAX_PATH
, "%V/" 
NGX_RTMP_PLAY_TMP_FILE
 "%ui",

470 &
∑cf
->
ãmp_∑th
, 
˘x
->
fûe_id
);

471 *
p
 = 0;

473  
∑th
;

474 
	}
}

478 
	$ngx_πmp_∂ay_c›y_loˇl_fûe
(
ngx_πmp_£ssi⁄_t
 *
s
, 
u_ch¨
 *
«me
)

480 
ngx_πmp_∂ay_≠p_c⁄f_t
 *
∑cf
;

481 
ngx_πmp_∂ay_˘x_t
 *
˘x
;

482 
u_ch¨
 *
∑th
, *
p
;

483 
u_ch¨
 
d∑th
[
NGX_MAX_PATH
 + 1];

485 
∑cf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_∂ay_moduÀ
);

486 i‡(
∑cf
 =
NULL
) {

490 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_∂ay_moduÀ
);

491 i‡(
˘x
 =
NULL
 || ctx->
fûe_id
 == 0) {

495 
∑th
 = 
	`ngx_πmp_∂ay_gë_loˇl_fûe_∑th
(
s
);

497 
p
 = 
	`ngx_¢¥ötf
(
d∑th
, 
NGX_MAX_PATH
, "%V/%s%V", &
∑cf
->
loˇl_∑th
,

498 
«me
 + 
˘x
->
pfx_size
, &˘x->
sfx
);

499 *
p
 = 0;

501 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

502 "∂ay: c›yÜoˇ»fûê'%s'Åÿ'%s'", 
∑th
, 
d∑th
);

504 i‡(
	`ngx_ª«me_fûe
(
∑th
, 
d∑th
) == 0) {

505 
˘x
->
fûe_id
 = 0;

509 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

511 
∑th
, 
d∑th
);

513 
	`ngx_πmp_∂ay_˛ónup_loˇl_fûe
(
s
);

514 
	}
}

518 
	$ngx_πmp_∂ay_˛ónup_loˇl_fûe
(
ngx_πmp_£ssi⁄_t
 *
s
)

520 
ngx_πmp_∂ay_˘x_t
 *
˘x
;

521 
u_ch¨
 *
∑th
;

523 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_∂ay_moduÀ
);

524 i‡(
˘x
 =
NULL
 || ctx->
fûe_id
 == 0) {

528 
∑th
 = 
	`ngx_πmp_∂ay_gë_loˇl_fûe_∑th
(
s
);

530 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

531 "∂ay: dñëögÜoˇ»fûê'%s'", 
∑th
);

533 
˘x
->
fûe_id
 = 0;

535 
	`ngx_dñëe_fûe
(
∑th
);

536 
	}
}

539 
ngx_öt_t


540 
	$ngx_πmp_∂ay_˛o£_°ªam
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_˛o£_°ªam_t
 *
v
)

542 
ngx_πmp_∂ay_˘x_t
 *
˘x
;

544 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_∂ay_moduÀ
);

545 i‡(
˘x
 =
NULL
) {

546 
√xt
;

549 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

552 
	`ngx_πmp_∂ay_do_°›
(
s
);

554 
	`ngx_πmp_∂ay_do_d⁄e
(
s
);

556 i‡(
˘x
->
fûe
.
fd
 !
NGX_INVALID_FILE
) {

557 
	`ngx_˛o£_fûe
(
˘x
->
fûe
.
fd
);

558 
˘x
->
fûe
.
fd
 = 
NGX_INVALID_FILE
;

560 
	`ngx_πmp_£nd_°ªam_eof
(
s
, 
NGX_RTMP_MSID
);

562 
	`ngx_πmp_£nd_°©us
(
s
, "NetStream.Play.Stop", "status",

566 i‡(
˘x
->
fûe_id
) {

567 
	`ngx_πmp_∂ay_˛ónup_loˇl_fûe
(
s
);

570 
	`ngx_πmp_∂ay_Àave
(
s
);

572 
√xt
:

573  
	`√xt_˛o£_°ªam
(
s
, 
v
);

574 
	}
}

577 
ngx_öt_t


578 
	$ngx_πmp_∂ay_£ek
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_£ek_t
 *
v
)

580 
ngx_πmp_∂ay_˘x_t
 *
˘x
;

582 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_∂ay_moduÀ
);

583 i‡(
˘x
 =
NULL
 || ctx->
fûe
.
fd
 =
NGX_INVALID_FILE
) {

584 
√xt
;

587 i‡(!
˘x
->
›íed
) {

588 
˘x
->
po°_£ek
 = (
ngx_uöt_t
Ë
v
->
off£t
;

589 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

590 "∂ay:Öo° sìk=%ui", 
˘x
->
po°_£ek
);

591 
√xt
;

594 i‡(
	`ngx_πmp_£nd_°ªam_eof
(
s
, 
NGX_RTMP_MSID
Ë!
NGX_OK
) {

595  
NGX_ERROR
;

598 
	`ngx_πmp_∂ay_do_£ek
(
s
, (
ngx_uöt_t
Ë
v
->
off£t
);

600 i‡(
	`ngx_πmp_£nd_°©us
(
s
, "NetStream.Seek.Notify", "status", "Seeking")

601 !
NGX_OK
)

603  
NGX_ERROR
;

606 i‡(
	`ngx_πmp_£nd_°ªam_begö
(
s
, 
NGX_RTMP_MSID
Ë!
NGX_OK
) {

607  
NGX_ERROR
;

610 
√xt
:

611  
	`√xt_£ek
(
s
, 
v
);

612 
	}
}

615 
ngx_öt_t


616 
	$ngx_πmp_∂ay_∑u£
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_∑u£_t
 *
v
)

618 
ngx_πmp_∂ay_˘x_t
 *
˘x
;

620 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_∂ay_moduÀ
);

622 i‡(
˘x
 =
NULL
 || ctx->
fûe
.
fd
 =
NGX_INVALID_FILE
) {

623 
√xt
;

626 i‡(!
˘x
->
›íed
) {

627 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

629 
√xt
;

632 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

634 (
ngx_öt_t
Ë
v
->
∑u£
, v->
posôi⁄
);

636 i‡(
v
->
∑u£
) {

637 i‡(
	`ngx_πmp_£nd_°©us
(
s
, "NetStream.Pause.Notify", "status",

639 !
NGX_OK
)

641  
NGX_ERROR
;

644 
	`ngx_πmp_∂ay_do_°›
(
s
);

647 i‡(
	`ngx_πmp_£nd_°©us
(
s
, "NetStream.Unpause.Notify", "status",

649 !
NGX_OK
)

651  
NGX_ERROR
;

654 
	`ngx_πmp_∂ay_do_°¨t
(
s
);

657 
√xt
:

658  
	`√xt_∑u£
(
s
, 
v
);

659 
	}
}

662 
ngx_öt_t


663 
	$ngx_πmp_∂ay_∑r£_ödex
(
ty≥
, 
u_ch¨
 *
¨gs
)

665 
u_ch¨
 *
p
, 
c
;

666 
u_ch¨
 
«me
[] = "xindex=";

668 
«me
[0] = (
u_ch¨
Ë
ty≥
;

671 
p
 = (
u_ch¨
 *Ë
	`ngx_°r°r
(
¨gs
, 
«me
);

672 i‡(
p
 =
NULL
) {

676 i‡(
p
 !
¨gs
) {

677 
c
 = *(
p
 - 1);

678 i‡(
c
 != '?' && c != '&') {

679 
¨gs
 = 
p
 + 1;

684  
	`©oi
((*Ë
p
 + ((
«me
) - 1));

686 
	}
}

689 
ngx_öt_t


690 
	$ngx_πmp_∂ay_∂ay
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_∂ay_t
 *
v
)

692 
ngx_πmp_∂ay_maö_c⁄f_t
 *
pmcf
;

693 
ngx_πmp_∂ay_≠p_c⁄f_t
 *
∑cf
;

694 
ngx_πmp_∂ay_˘x_t
 *
˘x
;

695 
u_ch¨
 *
p
;

696 
ngx_πmp_∂ay_fmt_t
 *
fmt
, **
pfmt
;

697 
ngx_°r_t
 *
pfx
, *
sfx
;

698 
ngx_°r_t
 
«me
;

699 
ngx_uöt_t
 
n
;

701 
pmcf
 = 
	`ngx_πmp_gë_moduÀ_maö_c⁄f
(
s
, 
ngx_πmp_∂ay_moduÀ
);

703 
∑cf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_∂ay_moduÀ
);

705 i‡(
∑cf
 =
NULL
 ||Öacf->
íåõs
.
√…s
 == 0) {

706 
√xt
;

709 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

711 
v
->
«me
, (
ngx_öt_t
Ëv->
°¨t
);

713 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_∂ay_moduÀ
);

715 i‡(
˘x
 && ctx->
fûe
.
fd
 !
NGX_INVALID_FILE
) {

716 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

718 
√xt
;

723 
p
 = 
v
->
«me
; *p; ++p) {

724 i‡(
	`ngx_∑th_£∑øt‹
(
p
[0]) &&

725 
p
[1] == '.' &&Ö[2] == '.' &&

726 
	`ngx_∑th_£∑øt‹
(
p
[3]))

728 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

729 "∂ay: badÇamê'%s'", 
v
->
«me
);

730  
NGX_ERROR
;

734 i‡(
˘x
 =
NULL
) {

735 
˘x
 = 
	`ngx_∑Œoc
(
s
->
c⁄√˘i⁄
->
poﬁ
, (
ngx_πmp_∂ay_˘x_t
));

736 
	`ngx_πmp_£t_˘x
(
s
, 
˘x
, 
ngx_πmp_∂ay_moduÀ
);

739 
	`ngx_memzîo
(
˘x
, (*ctx));

741 
˘x
->
£ssi⁄
 = 
s
;

742 
˘x
->
aödex
 = 
	`ngx_πmp_∂ay_∑r£_ödex
('a', 
v
->
¨gs
);

743 
˘x
->
vödex
 = 
	`ngx_πmp_∂ay_∑r£_ödex
('v', 
v
->
¨gs
);

745 
˘x
->
fûe
.
log
 = 
s
->
c⁄√˘i⁄
->log;

747 
	`ngx_mem˝y
(
˘x
->
«me
, 
v
->«me, 
NGX_RTMP_MAX_NAME
);

749 
«me
.
Àn
 = 
	`ngx_°æí
(
v
->name);

750 
«me
.
d©a
 = 
v
->name;

752 
pfmt
 = 
pmcf
->
fmts
.
ñts
;

754 
n
 = 0;Ç < 
pmcf
->
fmts
.
√…s
; ++n, ++
pfmt
) {

755 
fmt
 = *
pfmt
;

757 
pfx
 = &
fmt
->pfx;

758 
sfx
 = &
fmt
->sfx;

760 i‡(
pfx
->
Àn
 =0 && 
˘x
->
fmt
 =
NULL
) {

761 
˘x
->
fmt
 = fmt;

764 i‡(
pfx
->
Àn
 && 
«me
.len >=Öfx->len &&

765 
	`ngx_°∫ˇ£cmp
(
pfx
->
d©a
, 
«me
.d©a,Öfx->
Àn
) == 0)

767 
˘x
->
pfx_size
 = 
pfx
->
Àn
;

768 
˘x
->
fmt
 = fmt;

773 i‡(
«me
.
Àn
 >
sfx
->len &&

774 
	`ngx_°∫ˇ£cmp
(
sfx
->
d©a
, 
«me
.d©®+Çame.
Àn
 - sfx->len,

775 
sfx
->
Àn
) == 0)

777 
˘x
->
fmt
 = fmt;

781 i‡(
˘x
->
fmt
 =
NULL
) {

782 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

784 
√xt
;

787 
˘x
->
fûe
.
fd
 = 
NGX_INVALID_FILE
;

788 
˘x
->
√¡ry
 = 
NGX_CONF_UNSET_UINT
;

789 
˘x
->
po°_£ek
 = 
NGX_CONF_UNSET_UINT
;

791 
sfx
 = &
˘x
->
fmt
->sfx;

793 i‡(
«me
.
Àn
 < 
sfx
->len ||

794 
	`ngx_°∫ˇ£cmp
(
sfx
->
d©a
, 
«me
.d©®+Çame.
Àn
 - sfx->len,

795 
sfx
->
Àn
))

797 
˘x
->
sfx
 = *sfx;

800 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

801 "∂ay: fmt=%V", &
˘x
->
fmt
->
«me
);

803  
	`ngx_πmp_∂ay_√xt_íåy
(
s
, 
v
);

805 
√xt
:

806  
	`√xt_∂ay
(
s
, 
v
);

807 
	}
}

810 
ngx_öt_t


811 
	$ngx_πmp_∂ay_√xt_íåy
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_∂ay_t
 *
v
)

813 
ngx_πmp_∂ay_≠p_c⁄f_t
 *
∑cf
;

814 
ngx_πmp_∂ay_˘x_t
 *
˘x
;

815 
ngx_πmp_∂ay_íåy_t
 *
≥
;

816 
u_ch¨
 *
p
;

817 
u_ch¨
 
∑th
[
NGX_MAX_PATH
 + 1];

819 
∑cf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_∂ay_moduÀ
);

821 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_∂ay_moduÀ
);

825 i‡(
˘x
->
fûe
.
fd
 !
NGX_INVALID_FILE
) {

826 
	`ngx_˛o£_fûe
(
˘x
->
fûe
.
fd
);

827 
˘x
->
fûe
.
fd
 = 
NGX_INVALID_FILE
;

830 i‡(
˘x
->
fûe_id
) {

831 
	`ngx_πmp_∂ay_˛ónup_loˇl_fûe
(
s
);

834 
˘x
->
√¡ry
 = (˘x->√¡ry =
NGX_CONF_UNSET_UINT
 ?

835 0 : 
˘x
->
√¡ry
 + 1);

837 i‡(
˘x
->
√¡ry
 >
∑cf
->
íåõs
.
√…s
) {

838 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

841 
	`ngx_πmp_£nd_°©us
(
s
, "NetStream.Play.StreamNotFound", "error",

846 
≥
 = 
	`ngx_πmp_∂ay_gë_cuºít_íåy
(
s
);

848 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

850 
≥
->
uæ
 ? "remote" : "local",

851 
˘x
->
√¡ry
 + 1, 
∑cf
->
íåõs
.
√…s
,

852 
≥
->
uæ
 ? &≥->uæ->uæ :Öe->
roŸ
);

856 i‡(
≥
->
uæ
) {

857  
	`ngx_πmp_∂ay_›í_ªmŸe
(
s
, 
v
);

862 
p
 = 
	`ngx_¢¥ötf
(
∑th
, 
NGX_MAX_PATH
, "%V/%s%V",

863 
≥
->
roŸ
, 
v
->
«me
 + 
˘x
->
pfx_size
, &˘x->
sfx
);

864 *
p
 = 0;

866 
˘x
->
fûe
.
fd
 = 
	`ngx_›í_fûe
(
∑th
, 
NGX_FILE_RDONLY
, 
NGX_FILE_OPEN
,

867 
NGX_FILE_DEFAULT_ACCESS
);

869 i‡(
˘x
->
fûe
.
fd
 =
NGX_INVALID_FILE
) {

870 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

871 "∂ay:Éº‹ o≥nög fûê'%s'", 
∑th
);

875 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

876 "∂ay: o≥¿loˇ»fûê'%s'", 
∑th
);

878 i‡(
	`ngx_πmp_∂ay_›í
(
s
, 
v
->
°¨t
Ë!
NGX_OK
) {

879  
NGX_ERROR
;

885  
	`√xt_∂ay
(
s
, 
v
);

886 
	}
}

889 
ngx_öt_t


890 
	$ngx_πmp_∂ay_›í
(
ngx_πmp_£ssi⁄_t
 *
s
, 
°¨t
)

892 
ngx_πmp_∂ay_˘x_t
 *
˘x
;

893 
ngx_evít_t
 *
e
;

894 
ngx_uöt_t
 
time°amp
;

896 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_∂ay_moduÀ
);

898 i‡(
˘x
->
fûe
.
fd
 =
NGX_INVALID_FILE
) {

899  
NGX_ERROR
;

902 i‡(
	`ngx_πmp_£nd_°ªam_begö
(
s
, 
NGX_RTMP_MSID
Ë!
NGX_OK
) {

903  
NGX_ERROR
;

906 i‡(
	`ngx_πmp_£nd_°©us
(
s
, "NetStream.Play.Start", "status",

908 !
NGX_OK
)

910  
NGX_ERROR
;

913 i‡(
	`ngx_πmp_∂ay_joö
(
s
Ë!
NGX_OK
) {

914  
NGX_ERROR
;

917 
e
 = &
˘x
->
£nd_evt
;

918 
e
->
d©a
 = 
s
;

919 
e
->
h™dÀr
 = 
ngx_πmp_∂ay_£nd
;

920 
e
->
log
 = 
s
->
c⁄√˘i⁄
->log;

922 
	`ngx_πmp_£nd_ªc‹ded
(
s
, 1);

924 i‡(
	`ngx_πmp_£nd_ßm∂e_ac˚ss
(
s
Ë!
NGX_OK
) {

925  
NGX_ERROR
;

928 i‡(
	`ngx_πmp_∂ay_do_öô
(
s
Ë!
NGX_OK
) {

929  
NGX_ERROR
;

932 
time°amp
 = 
˘x
->
po°_£ek
 !
NGX_CONF_UNSET_UINT
 ? ctx->post_seek :

933 (
°¨t
 < 0 ? 0 : (
ngx_uöt_t
) start);

935 i‡(
	`ngx_πmp_∂ay_do_£ek
(
s
, 
time°amp
Ë!
NGX_OK
) {

936  
NGX_ERROR
;

939 i‡(
	`ngx_πmp_∂ay_do_°¨t
(
s
Ë!
NGX_OK
) {

940  
NGX_ERROR
;

943 
˘x
->
›íed
 = 1;

945  
NGX_OK
;

946 
	}
}

949 
ngx_chaö_t
 *

950 
	$ngx_πmp_∂ay_ªmŸe_¸óã
(
ngx_πmp_£ssi⁄_t
 *
s
, *
¨g
, 
ngx_poﬁ_t
 *
poﬁ
)

952 
ngx_πmp_∂ay_t
 *
v
 = 
¨g
;

954 
ngx_πmp_∂ay_˘x_t
 *
˘x
;

955 
ngx_πmp_∂ay_íåy_t
 *
≥
;

956 
ngx_°r_t
 *
addr_ãxt
, 
uri
;

957 
u_ch¨
 *
p
, *
«me
;

958 
size_t
 
¨gs_Àn
, 
«me_Àn
, 
Àn
;

959 
ngx_°r_t
 
ãxt_∂aö
 = 
	`ngx_°rög
("text/plain");

961 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_∂ay_moduÀ
);

963 
≥
 = 
	`ngx_πmp_∂ay_gë_cuºít_íåy
(
s
);

965 
«me
 = 
v
->«mê+ 
˘x
->
pfx_size
;

967 
«me_Àn
 = 
	`ngx_°æí
(
«me
);

968 
¨gs_Àn
 = 
	`ngx_°æí
(
v
->
¨gs
);

969 
addr_ãxt
 = &
s
->
c⁄√˘i⁄
->addr_text;

971 
Àn
 = 
≥
->
uæ
->
uri
.len + 1 +

972 
«me_Àn
 + 
˘x
->
sfx
.
Àn
 +

973 ("?addr="Ë+ 
addr_ãxt
->
Àn
 * 3 +

974 1 + 
¨gs_Àn
;

976 
uri
.
d©a
 = 
	`ngx_∑Œoc
(
poﬁ
, 
Àn
);

977 i‡(
uri
.
d©a
 =
NULL
) {

978  
NULL
;

981 
p
 = 
uri
.
d©a
;

983 
p
 = 
	`ngx_˝ymem
’, 
≥
->
uæ
->
uri
.
d©a
,Öe->uæ->uri.
Àn
);

985 i‡(
p
 =
uri
.
d©a
 ||Ö[-1] != '/') {

986 *
p
++ = '/';

989 
p
 = 
	`ngx_˝ymem
’, 
«me
, 
«me_Àn
);

990 
p
 = 
	`ngx_˝ymem
’, 
˘x
->
sfx
.
d©a
, ctx->sfx.
Àn
);

991 
p
 = 
	`ngx_˝ymem
’, (
u_ch¨
*)"?addr=", ("&addr=") -1);

992 
p
 = (
u_ch¨
*)
	`ngx_esˇ≥_uri
’, 
addr_ãxt
->
d©a
,áddr_ãxt->
Àn
,

993 
NGX_ESCAPE_ARGS
);

994 i‡(
¨gs_Àn
) {

995 *
p
++ = '&';

996 
p
 = (
u_ch¨
 *Ë
	`ngx_˝ymem
’, 
v
->
¨gs
, 
¨gs_Àn
);

999 
uri
.
Àn
 = 
p
 - uri.
d©a
;

1001  
	`ngx_πmp_√tˇŒ_hâp_f‹m©_ªque°
(
NGX_RTMP_NETCALL_HTTP_GET
,

1002 &
≥
->
uæ
->
ho°
, &
uri
,

1003 
NULL
, NULL, 
poﬁ
, &
ãxt_∂aö
);

1004 
	}
}

1007 
ngx_öt_t


1008 
	$ngx_πmp_∂ay_ªmŸe_h™dÀ
(
ngx_πmp_£ssi⁄_t
 *
s
, *
¨g
, 
ngx_chaö_t
 *
ö
)

1010 
ngx_πmp_∂ay_t
 *
v
 = 
¨g
;

1012 
ngx_πmp_∂ay_˘x_t
 *
˘x
;

1014 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_∂ay_moduÀ
);

1016 i‡(
˘x
->
nbody
 == 0) {

1017  
	`ngx_πmp_∂ay_√xt_íåy
(
s
, 
v
);

1020 i‡(
˘x
->
fûe_id
) {

1021 
	`ngx_πmp_∂ay_c›y_loˇl_fûe
(
s
, 
v
->
«me
);

1024 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1027 i‡(
	`ngx_πmp_∂ay_›í
(
s
, 
v
->
°¨t
Ë!
NGX_OK
) {

1028  
NGX_ERROR
;

1031  
	`√xt_∂ay
(
s
, (
ngx_πmp_∂ay_t
 *)
¨g
);

1032 
	}
}

1035 
ngx_öt_t


1036 
	$ngx_πmp_∂ay_ªmŸe_sök
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_chaö_t
 *
ö
)

1038 
ngx_πmp_∂ay_˘x_t
 *
˘x
;

1039 
ngx_buf_t
 *
b
;

1040 
ngx_öt_t
 
rc
;

1042 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_∂ay_moduÀ
);

1045 
ö
 && 
˘x
->
n¸s
 != 2) {

1046 
b
 = 
ö
->
buf
;

1048 ; 
b
->
pos
 !b->
œ°
 && 
˘x
->
n¸s
 != 2; ++b->pos) {

1049 *
b
->
pos
) {

1051 ++
˘x
->
n¸s
;

1055 
˘x
->
n¸s
 = 0;

1058 i‡(++
˘x
->
nhódî
 =10 && *
b
->
pos
 !(
u_ch¨
) '2') {

1059 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1061 *
b
->
pos
);

1062  
NGX_ERROR
;

1066 i‡(
b
->
pos
 =b->
œ°
) {

1067 
ö
 = in->
√xt
;

1072 ; 
ö
; i¿ö->
√xt
) {

1073 
b
 = 
ö
->
buf
;

1075 i‡(
b
->
pos
 =b->
œ°
) {

1079 
rc
 = 
	`ngx_wrôe_fd
(
˘x
->
fûe
.
fd
, 
b
->
pos
, b->
œ°
 - b->pos);

1081 i‡(
rc
 =
NGX_ERROR
) {

1082 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

1084  
NGX_ERROR
;

1087 
˘x
->
nbody
 +
rc
;

1090  
NGX_OK
;

1091 
	}
}

1094 
ngx_πmp_∂ay_íåy_t
 *

1095 
	$ngx_πmp_∂ay_gë_cuºít_íåy
(
ngx_πmp_£ssi⁄_t
 *
s
)

1097 
ngx_πmp_∂ay_≠p_c⁄f_t
 *
∑cf
;

1098 
ngx_πmp_∂ay_˘x_t
 *
˘x
;

1099 
ngx_πmp_∂ay_íåy_t
 **
µe
;

1101 
∑cf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_∂ay_moduÀ
);

1103 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_∂ay_moduÀ
);

1105 
µe
 = 
∑cf
->
íåõs
.
ñts
;

1107  
µe
[
˘x
->
√¡ry
];

1108 
	}
}

1111 
ngx_öt_t


1112 
	$ngx_πmp_∂ay_›í_ªmŸe
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_∂ay_t
 *
v
)

1114 
ngx_πmp_∂ay_≠p_c⁄f_t
 *
∑cf
;

1115 
ngx_πmp_∂ay_˘x_t
 *
˘x
;

1116 
ngx_πmp_∂ay_íåy_t
 *
≥
;

1117 
ngx_πmp_√tˇŒ_öô_t
 
ci
;

1118 
u_ch¨
 *
∑th
;

1119 
ngx_îr_t
 
îr
;

1120 
ngx_uöt_t
 
fûe_id
;

1122 
∑cf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_∂ay_moduÀ
);

1124 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_∂ay_moduÀ
);

1126 
˘x
->
n¸s
 = 0;

1127 
˘x
->
nhódî
 = 0;

1128 
˘x
->
nbody
 = 0;

1131 
˘x
->
fûe_id
 = ++file_id;

1134 i‡(
˘x
->
fûe_id
 == 0) {

1138 
∑th
 = 
	`ngx_πmp_∂ay_gë_loˇl_fûe_∑th
(
s
);

1140 
˘x
->
fûe
.
fd
 = 
	`ngx_›í_ãmpfûe
(
∑th
, 
∑cf
->
loˇl_∑th
.
Àn
, 0);

1142 i‡(
∑cf
->
loˇl_∑th
.
Àn
 == 0) {

1143 
˘x
->
fûe_id
 = 0;

1146 i‡(
˘x
->
fûe
.
fd
 !
NGX_INVALID_FILE
) {

1150 
îr
 = 
ngx_î∫o
;

1152 i‡(
îr
 !
NGX_EEXIST
) {

1153 
˘x
->
fûe_id
 = 0;

1155 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 
îr
,

1158  
NGX_ERROR
;

1162 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1164 
∑th
, 
˘x
->
fûe_id
);

1166 
≥
 = 
	`ngx_πmp_∂ay_gë_cuºít_íåy
(
s
);

1168 
	`ngx_memzîo
(&
ci
, (ci));

1170 
ci
.
uæ
 = 
≥
->url;

1171 
ci
.
¸óã
 = 
ngx_πmp_∂ay_ªmŸe_¸óã
;

1172 
ci
.
sök
 = 
ngx_πmp_∂ay_ªmŸe_sök
;

1173 
ci
.
h™dÀ
 = 
ngx_πmp_∂ay_ªmŸe_h™dÀ
;

1174 
ci
.
¨g
 = 
v
;

1175 
ci
.
¨gsize
 = (*
v
);

1177  
	`ngx_πmp_√tˇŒ_¸óã
(
s
, &
ci
);

1178 
	}
}

1182 
	$ngx_πmp_∂ay_uæ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1184 
ngx_πmp_∂ay_≠p_c⁄f_t
 *
∑cf
 = 
c⁄f
;

1186 
ngx_πmp_∂ay_íåy_t
 *
≥
, **
µe
;

1187 
ngx_°r_t
 
uæ
;

1188 
ngx_uæ_t
 *
u
;

1189 
size_t
 
add
, 
n
;

1190 
ngx_°r_t
 *
vÆue
;

1192 i‡(
∑cf
->
íåõs
.
«Œoc
 == 0 &&

1193 
	`ngx_¨øy_öô
(&
∑cf
->
íåõs
, 
cf
->
poﬁ
, 1, (*)Ë!
NGX_OK
)

1195  
NGX_CONF_ERROR
;

1198 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1200 
n
 = 1;Ç < 
cf
->
¨gs
->
√…s
; ++n) {

1202 
µe
 = 
	`ngx_¨øy_push
(&
∑cf
->
íåõs
);

1203 i‡(
µe
 =
NULL
) {

1204  
NGX_CONF_ERROR
;

1207 
≥
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_∂ay_íåy_t
));

1208 i‡(
≥
 =
NULL
) {

1209  
NGX_CONF_ERROR
;

1212 *
µe
 = 
≥
;

1214 i‡(
	`ngx_°∫ˇ£cmp
(
vÆue
[
n
].
d©a
, (
u_ch¨
 *) "http://", 7)) {

1218 
≥
->
roŸ
 = 
	`ngx_∑Œoc
(
cf
->
poﬁ
, (
ngx_°r_t
));

1219 i‡(
≥
->
roŸ
 =
NULL
) {

1220  
NGX_CONF_ERROR
;

1223 *
≥
->
roŸ
 = 
vÆue
[
n
];

1230 
uæ
 = 
vÆue
[
n
];

1232 
add
 = ("http://") - 1;

1234 
uæ
.
d©a
 +
add
;

1235 
uæ
.
Àn
 -
add
;

1237 
u
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_uæ_t
));

1238 i‡(
u
 =
NULL
) {

1239  
NGX_CONF_ERROR
;

1242 
u
->
uæ
.
Àn
 = url.len;

1243 
u
->
uæ
.
d©a
 = url.data;

1244 
u
->
deÁu…_p‹t
 = 80;

1245 
u
->
uri_∑π
 = 1;

1247 i‡(
	`ngx_∑r£_uæ
(
cf
->
poﬁ
, 
u
Ë!
NGX_OK
) {

1248 i‡(
u
->
îr
) {

1249 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

1250 "%†ö uæ \"%V\"", 
u
->
îr
, &u->
uæ
);

1252  
NGX_CONF_ERROR
;

1255 
≥
->
uæ
 = 
u
;

1258  
NGX_CONF_OK
;

1259 
	}
}

1262 
ngx_öt_t


1263 
	$ngx_πmp_∂ay_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
)

1265 
√xt_∂ay
 = 
ngx_πmp_∂ay
;

1266 
ngx_πmp_∂ay
 = 
ngx_πmp_∂ay_∂ay
;

1268 
√xt_˛o£_°ªam
 = 
ngx_πmp_˛o£_°ªam
;

1269 
ngx_πmp_˛o£_°ªam
 = 
ngx_πmp_∂ay_˛o£_°ªam
;

1271 
√xt_£ek
 = 
ngx_πmp_£ek
;

1272 
ngx_πmp_£ek
 = 
ngx_πmp_∂ay_£ek
;

1274 
√xt_∑u£
 = 
ngx_πmp_∑u£
;

1275 
ngx_πmp_∑u£
 = 
ngx_πmp_∂ay_∑u£
;

1277  
NGX_OK
;

1278 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_play_module.h

7 #i‚de‡
_NGX_RTMP_PLAY_H_INCLUDED_


8 
	#_NGX_RTMP_PLAY_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

13 
	~"ngx_πmp.h
"

14 
	~"ngx_πmp_cmd_moduÀ.h
"

17 
	$ngx_öt_t
 (*
	tngx_πmp_∂ay_öô_±
Ë(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

18 
	tngx_fûe_t
 *
	tf
, 
	tngx_öt_t
 
	taödex
,Çgx_öt_à
	tvödex
);

19 
	$ngx_öt_t
 (*
	tngx_πmp_∂ay_d⁄e_±
Ë(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

20 
	tngx_fûe_t
 *
	tf
);

21 
	$ngx_öt_t
 (*
	tngx_πmp_∂ay_°¨t_±
Ë(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

22 
	tngx_fûe_t
 *
	tf
);

23 
	$ngx_öt_t
 (*
	tngx_πmp_∂ay_£ek_±
Ë(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

24 
	tngx_fûe_t
 *
	tf
, 
	tngx_uöt_t
 
	toffs
);

25 
	$ngx_öt_t
 (*
	tngx_πmp_∂ay_°›_±
Ë(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

26 
	tngx_fûe_t
 *
	tf
);

27 
	$ngx_öt_t
 (*
	tngx_πmp_∂ay_£nd_±
Ë(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

28 
	tngx_fûe_t
 *
	tf
, 
	tngx_uöt_t
 *
	tts
);

32 
ngx_°r_t
 
«me
;

33 
ngx_°r_t
 
pfx
;

34 
ngx_°r_t
 
sfx
;

36 
ngx_πmp_∂ay_öô_±
 
öô
;

37 
ngx_πmp_∂ay_d⁄e_±
 
d⁄e
;

38 
ngx_πmp_∂ay_°¨t_±
 
°¨t
;

39 
ngx_πmp_∂ay_£ek_±
 
£ek
;

40 
ngx_πmp_∂ay_°›_±
 
°›
;

41 
ngx_πmp_∂ay_£nd_±
 
£nd
;

42 } 
	tngx_πmp_∂ay_fmt_t
;

45 
ngx_πmp_∂ay_˘x_s
 
	tngx_πmp_∂ay_˘x_t
;

48 
	sngx_πmp_∂ay_˘x_s
 {

49 
ngx_πmp_£ssi⁄_t
 *
£ssi⁄
;

50 
ngx_fûe_t
 
fûe
;

51 
ngx_πmp_∂ay_fmt_t
 *
fmt
;

52 
ngx_evít_t
 
£nd_evt
;

53 
∂ayög
:1;

54 
›íed
:1;

55 
joöed
:1;

56 
ngx_uöt_t
 
n¸s
;

57 
ngx_uöt_t
 
nhódî
;

58 
ngx_uöt_t
 
nbody
;

59 
size_t
 
pfx_size
;

60 
ngx_°r_t
 
sfx
;

61 
ngx_uöt_t
 
fûe_id
;

62 
ngx_öt_t
 
aödex
, 
vödex
;

63 
ngx_uöt_t
 
√¡ry
;

64 
ngx_uöt_t
 
po°_£ek
;

65 
u_ch¨
 
«me
[
NGX_RTMP_MAX_NAME
];

66 
ngx_πmp_∂ay_˘x_t
 *
√xt
;

71 
ngx_°r_t
 *
roŸ
;

72 
ngx_uæ_t
 *
uæ
;

73 } 
	tngx_πmp_∂ay_íåy_t
;

77 
ngx_°r_t
 
ãmp_∑th
;

78 
ngx_°r_t
 
loˇl_∑th
;

79 
ngx_¨øy_t
 
íåõs
;

80 
ngx_uöt_t
 
nbuckës
;

81 
ngx_πmp_∂ay_˘x_t
 **
˘x
;

82 } 
	tngx_πmp_∂ay_≠p_c⁄f_t
;

86 
ngx_¨øy_t
 
fmts
;

87 } 
	tngx_πmp_∂ay_maö_c⁄f_t
;

90 
ngx_moduÀ_t
 
ngx_πmp_∂ay_moduÀ
;

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_proxy_protocol.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~<ngöx.h
>

10 
	~"ngx_πmp_¥oxy_¥Ÿocﬁ.h
"

13 
ngx_πmp_¥oxy_¥Ÿocﬁ_ªcv
(
ngx_evít_t
 *
ªv
);

17 
	$ngx_πmp_¥oxy_¥Ÿocﬁ
(
ngx_πmp_£ssi⁄_t
 *
s
)

19 
ngx_evít_t
 *
ªv
;

20 
ngx_c⁄√˘i⁄_t
 *
c
;

22 
c
 = 
s
->
c⁄√˘i⁄
;

23 
ªv
 = 
c
->
ªad
;

24 
ªv
->
h™dÀr
 = 
ngx_πmp_¥oxy_¥Ÿocﬁ_ªcv
;

26 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

29 i‡(
ªv
->
ªady
) {

32 i‡(
ngx_u£_ac˚±_muãx
) {

33 
	`ngx_po°_evít
(
ªv
, &
ngx_po°ed_evíts
);

37 
ªv
->
	`h™dÀr
(rev);

41 
	`ngx_add_timî
(
ªv
, 
s
->
timeout
);

43 i‡(
	`ngx_h™dÀ_ªad_evít
(
ªv
, 0Ë!
NGX_OK
) {

44 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

47 
	}
}

51 
	$ngx_πmp_¥oxy_¥Ÿocﬁ_ªcv
(
ngx_evít_t
 *
ªv
)

53 
u_ch¨
 
buf
[107], *
p
, *
µ
, *
ãxt
;

54 
size_t
 
Àn
;

55 
ssize_t
 
n
;

56 
ngx_îr_t
 
îr
;

57 
ngx_öt_t
 
i
;

58 
ngx_addr_t
 
addr
;

59 
ngx_c⁄√˘i⁄_t
 *
c
;

60 
ngx_πmp_£ssi⁄_t
 *
s
;

62 
c
 = 
ªv
->
d©a
;

63 
s
 = 
c
->
d©a
;

65 i‡(
c
->
de°royed
) {

69 i‡(
ªv
->
timedout
) {

70 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
,

72 
c
->
timedout
 = 1;

73 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

77 i‡(
ªv
->
timî_£t
) {

78 
	`ngx_dñ_timî
(
ªv
);

81 
n
 = 
	`ªcv
(
c
->
fd
, (*Ë
buf
, (buf), 
MSG_PEEK
);

83 
îr
 = 
ngx_sockë_î∫o
;

85 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
c
->
log
, 0, "ªcv(): %d", 
n
);

87 i‡(
n
 == -1) {

89 i‡(
îr
 =
NGX_EAGAIN
) {

90 
	`ngx_add_timî
(
ªv
, 
s
->
timeout
);

92 i‡(
	`ngx_h™dÀ_ªad_evít
(
c
->
ªad
, 0Ë!
NGX_OK
) {

93 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

99 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

104 
p
 = 
buf
;

106 i‡(
n
 <8 && 
	`ngx_°∫cmp
(
p
, "PROXY ", 6) != 0) {

107 
bad_hódî
;

110 
n
 -= 6;

111 
p
 += 6;

113 
	`ngx_memzîo
(&
addr
, (
ngx_addr_t
));

115 i‡(
n
 >7 && 
	`ngx_°∫cmp
(
p
, "UNKNOWN", 7) == 0) {

116 
n
 -= 7;

117 
p
 += 7;

118 
skù
;

121 i‡(
n
 < 5 || 
	`ngx_°∫cmp
(
p
, "TCP", 3) != 0

122 || (
p
[3] != '4' &&Ö[3] != '6') ||Ö[4] != ' ')

124 
bad_hódî
;

127 
n
 -= 5;

128 
p
 += 5;

130 
µ
 = 
	`ngx_°æchr
(
p
,Ö + 
n
, ' ');

132 i‡(
µ
 =
NULL
) {

133 
bad_hódî
;

136 i‡(
	`ngx_∑r£_addr
(
s
->
c⁄√˘i⁄
->
poﬁ
, &
addr
, 
p
, 
µ
 -ÖË!
NGX_OK
) {

137 
bad_hódî
;

140 
n
 -
µ
 - 
p
;

141 
p
 = 
µ
;

143 
skù
:

145 
i
 = 0; i + 1 < 
n
; i++) {

146 i‡(
p
[
i
] =
CR
 &&Ö[ò+ 1] =
LF
) {

151 i‡(
i
 + 1 >
n
) {

152 
bad_hódî
;

155 
n
 = 
p
 - 
buf
 + 
i
 + 2;

157 i‡(
c
->
	`ªcv
(c, 
buf
, 
n
) !=Ç) {

158 
Áûed
;

161 i‡(
addr
.
sockÀn
) {

162 
ãxt
 = 
	`ngx_∑Œoc
(
s
->
c⁄√˘i⁄
->
poﬁ
, 
NGX_SOCKADDR_STRLEN
);

164 i‡(
ãxt
 =
NULL
) {

165 
Áûed
;

168 
Àn
 = 
	`ngx_sock_¡›
(
addr
.
sockaddr
,

169 #i‡(
ngöx_vîsi⁄
 >= 1005003)

170 
addr
.
sockÀn
,

172 
ãxt
, 
NGX_SOCKADDR_STRLEN
, 0);

173 i‡(
Àn
 == 0) {

174 
Áûed
;

177 
c
->
sockaddr
 = 
addr
.sockaddr;

178 
c
->
sockÀn
 = 
addr
.socklen;

179 
c
->
addr_ãxt
.
d©a
 = 
ãxt
;

180 
c
->
addr_ãxt
.
Àn
 =Üen;

182 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
c
->
log
, 0,

183 "¥oxy_¥Ÿocﬁ:ÑemŸe_addr:'%V'", &
c
->
addr_ãxt
);

186 
	`ngx_πmp_h™dshake
(
s
);

190 
bad_hódî
:

192 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
c
->
log
, 0, "proxy_protocol: bad header");

194 
Áûed
:

196 
	`ngx_πmp_föÆize_£ssi⁄
(
s
);

197 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_proxy_protocol.h

7 #i‚de‡
_NGX_RTMP_PROXY_PROTOCOL_H_INCLUDED_


8 
	#_NGX_RTMP_PROXY_PROTOCOL_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

13 
	~"ngx_πmp.h
"

16 
ngx_πmp_¥oxy_¥Ÿocﬁ
(
ngx_πmp_£ssi⁄_t
 *
c
);

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_receive.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp.h
"

10 
	~"ngx_πmp_amf.h
"

11 
	~"ngx_πmp_cmd_moduÀ.h
"

12 
	~<°rög.h
>

15 
ngx_öt_t


16 
	$ngx_πmp_¥Ÿocﬁ_mesßge_h™dÀr
(
ngx_πmp_£ssi⁄_t
 *
s
,

17 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
)

19 
ngx_buf_t
 *
b
;

20 
u_ch¨
 *
p
;

21 
uöt32_t
 
vÆ
;

22 
uöt8_t
 
limô
;

24 
b
 = 
ö
->
buf
;

26 i‡(
b
->
œ°
 - b->
pos
 < 4) {

27 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

29 ()
h
->
ty≥
, 
b
->
œ°
 - b->
pos
);

30  
NGX_OK
;

33 
p
 = (
u_ch¨
*)&
vÆ
;

34 
p
[0] = 
b
->
pos
[3];

35 
p
[1] = 
b
->
pos
[2];

36 
p
[2] = 
b
->
pos
[1];

37 
p
[3] = 
b
->
pos
[0];

39 
h
->
ty≥
) {

40 
NGX_RTMP_MSG_CHUNK_SIZE
:

42 
	`ngx_πmp_£t_chunk_size
(
s
, 
vÆ
);

45 
NGX_RTMP_MSG_ABORT
:

49 
NGX_RTMP_MSG_ACK
:

51 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

52 "ª˚ivêack seq=%uD", 
vÆ
);

55 
NGX_RTMP_MSG_ACK_SIZE
:

57 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

58 "ª˚ivêack_size=%uD", 
vÆ
);

59 
s
->
ack_size
 = 
vÆ
;

62 
NGX_RTMP_MSG_BANDWIDTH
:

63 i‡(
b
->
œ°
 - b->
pos
 >= 5) {

64 
limô
 = *(
uöt8_t
*)&
b
->
pos
[4];

66 ()
vÆ
;

67 ()
limô
;

69 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

71 
vÆ
, ()
limô
);

79  
NGX_ERROR
;

82  
NGX_OK
;

83 
	}
}

86 
ngx_öt_t


87 
	$ngx_πmp_u£r_mesßge_h™dÀr
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

88 
ngx_chaö_t
 *
ö
)

90 
ngx_buf_t
 *
b
;

91 
u_ch¨
 *
p
;

92 
uöt16_t
 
evt
;

93 
uöt32_t
 
vÆ
;

95 
b
 = 
ö
->
buf
;

97 i‡(
b
->
œ°
 - b->
pos
 < 6) {

98 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

100 
b
->
œ°
 - b->
pos
);

101  
NGX_OK
;

104 
p
 = (
u_ch¨
*)&
evt
;

106 
p
[0] = 
b
->
pos
[1];

107 
p
[1] = 
b
->
pos
[0];

109 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

111 
	`ngx_πmp_u£r_mesßge_ty≥
(
evt
), (
ngx_öt_t
)Évt);

113 
p
 = (
u_ch¨
 *Ë&
vÆ
;

115 
p
[0] = 
b
->
pos
[5];

116 
p
[1] = 
b
->
pos
[4];

117 
p
[2] = 
b
->
pos
[3];

118 
p
[3] = 
b
->
pos
[2];

120 
evt
) {

121 
NGX_RTMP_USER_STREAM_BEGIN
:

123 
ngx_πmp_°ªam_begö_t
 
v
;

125 
v
.
msid
 = 
vÆ
;

127 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

128 "ª˚ive: såóm_begö msid=%uD", 
v
.
msid
);

130  
	`ngx_πmp_°ªam_begö
(
s
, &
v
);

133 
NGX_RTMP_USER_STREAM_EOF
:

135 
ngx_πmp_°ªam_eof_t
 
v
;

137 
v
.
msid
 = 
vÆ
;

139 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

140 "ª˚ive: såóm_eo‡msid=%uD", 
v
.
msid
);

142  
	`ngx_πmp_°ªam_eof
(
s
, &
v
);

145 
NGX_RTMP_USER_STREAM_DRY
:

147 
ngx_πmp_°ªam_dry_t
 
v
;

149 
v
.
msid
 = 
vÆ
;

151 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

152 "ª˚ive: såóm_dry msid=%uD", 
v
.
msid
);

154  
	`ngx_πmp_°ªam_dry
(
s
, &
v
);

157 
NGX_RTMP_USER_SET_BUFLEN
:

159 
ngx_πmp_£t_buÊí_t
 
v
;

161 
v
.
msid
 = 
vÆ
;

163 i‡(
b
->
œ°
 - b->
pos
 < 10) {

164  
NGX_OK
;

167 
p
 = (
u_ch¨
 *Ë&
v
.
buÊí
;

169 
p
[0] = 
b
->
pos
[9];

170 
p
[1] = 
b
->
pos
[8];

171 
p
[2] = 
b
->
pos
[7];

172 
p
[3] = 
b
->
pos
[6];

174 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

176 
v
.
msid
, v.
buÊí
);

179 
s
->
buÊí
 = 
v
.buflen;

181  
	`ngx_πmp_£t_buÊí
(
s
, &
v
);

184 
NGX_RTMP_USER_RECORDED
:

186 
ngx_πmp_ªc‹ded_t
 
v
;

188 
v
.
msid
 = 
vÆ
;

190 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

191 "ª˚ive:Ñec‹ded msid=%uD", 
v
.
msid
);

193  
	`ngx_πmp_ªc‹ded
(
s
, &
v
);

196 
NGX_RTMP_USER_PING_REQUEST
:

197  
	`ngx_πmp_£nd_pög_ª•⁄£
(
s
, 
vÆ
);

199 
NGX_RTMP_USER_PING_RESPONSE
:

203 
	`ngx_πmp_ª£t_pög
(
s
);

205  
NGX_OK
;

208 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

209 "u√x≥˘ed u£∏evít: %i", (
ngx_öt_t
Ë
evt
);

211  
NGX_OK
;

213 
	}
}

216 
ngx_öt_t


217 
	$ngx_πmp_„tch
(
ngx_chaö_t
 **
ö
, 
u_ch¨
 *
ªt
)

219 *
ö
 && (*ö)->
buf
->
pos
 >(*ö)->buf->
œ°
) {

220 *
ö
 = (*ö)->
√xt
;

223 i‡(*
ö
 =
NULL
) {

224  
NGX_DONE
;

227 *
ªt
 = *(*
ö
)->
buf
->
pos
++;

229  
NGX_OK
;

230 
	}
}

233 
ngx_öt_t


234 
	$ngx_πmp_„tch_uöt8
(
ngx_chaö_t
 **
ö
, 
uöt8_t
 *
ªt
)

236  
	`ngx_πmp_„tch
(
ö
, (
u_ch¨
 *Ë
ªt
);

237 
	}
}

240 
ngx_öt_t


241 
	$ngx_πmp_„tch_uöt32
(
ngx_chaö_t
 **
ö
, 
uöt32_t
 *
ªt
, 
ngx_öt_t
 
n
)

243 
u_ch¨
 *
r
 = (u_ch¨ *Ë
ªt
;

244 
ngx_öt_t
 
rc
;

246 *
ªt
 = 0;

248 --
n
 >= 0) {

249 
rc
 = 
	`ngx_πmp_„tch
(
ö
, &
r
[
n
]);

250 i‡(
rc
 !
NGX_OK
) {

251  
rc
;

255  
NGX_OK
;

256 
	}
}

259 
ngx_öt_t


260 
	$ngx_πmp_aggªg©e_mesßge_h™dÀr
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

261 
ngx_chaö_t
 *
ö
)

263 
uöt32_t
 
ba£_time
, 
time°amp
, 
¥ev_size
;

264 
size_t
 
Àn
;

265 
ngx_öt_t
 
fú°
;

266 
u_ch¨
 *
œ°
;

267 
ngx_öt_t
 
rc
;

268 
ngx_buf_t
 *
b
;

269 
ngx_chaö_t
 *
˛
, *
√xt
;

270 
ngx_πmp_hódî_t
 
ch
;

272 
ch
 = *
h
;

274 
fú°
 = 1;

275 
ba£_time
 = 0;

277 
ö
) {

278 i‡(
	`ngx_πmp_„tch_uöt8
(&
ö
, &
ch
.
ty≥
Ë!
NGX_OK
) {

279  
NGX_OK
;

282 i‡(
	`ngx_πmp_„tch_uöt32
(&
ö
, &
ch
.
mÀn
, 3Ë!
NGX_OK
) {

283  
NGX_ERROR
;

286 i‡(
	`ngx_πmp_„tch_uöt32
(&
ö
, &
time°amp
, 3Ë!
NGX_OK
) {

287  
NGX_ERROR
;

290 i‡(
	`ngx_πmp_„tch_uöt8
(&
ö
, (
uöt8_t
 *Ë&
time°amp
 + 3Ë!
NGX_OK
)

292  
NGX_ERROR
;

295 i‡(
	`ngx_πmp_„tch_uöt32
(&
ö
, &
ch
.
msid
, 3Ë!
NGX_OK
)

297  
NGX_ERROR
;

300 i‡(
fú°
) {

301 
ba£_time
 = 
time°amp
;

302 
fú°
 = 0;

305 
	`ngx_log_debug6
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

307 
	`ngx_πmp_mesßge_ty≥
(
ch
.
ty≥
),

308 (
ngx_öt_t
Ë
ch
.
ty≥
, ch.
mÀn
, ch.
time°amp
,

309 
time°amp
 - 
ba£_time
, 
ch
.
msid
);

313 
Àn
 = 0;

314 
˛
 = 
ö
;

315 
˛
) {

316 
b
 = 
˛
->
buf
;

317 
Àn
 +(
b
->
œ°
 - b->
pos
);

318 i‡(
Àn
 > 
ch
.
mÀn
) {

321 
˛
 = cl->
√xt
;

324 i‡(
˛
 =
NULL
) {

325 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

327  
NGX_ERROR
;

330 
√xt
 = 
˛
->next;

331 
˛
->
√xt
 = 
NULL
;

332 
b
 = 
˛
->
buf
;

333 
œ°
 = 
b
->last;

334 
b
->
œ°
 -(
Àn
 - 
ch
.
mÀn
);

338 
ch
.
time°amp
 = 
h
->time°am∞+Åime°am∞- 
ba£_time
;

340 
rc
 = 
	`ngx_πmp_ª˚ive_mesßge
(
s
, &
ch
, 
ö
);

344 
ö
 = 
˛
;

345 
ö
->
√xt
 =Çext;

346 
b
->
pos
 = b->
œ°
;

347 
b
->
œ°
 =Üast;

349 i‡(
rc
 !
NGX_OK
) {

350  
rc
;

355 i‡(
	`ngx_πmp_„tch_uöt32
(&
ö
, &
¥ev_size
, 4Ë!
NGX_OK
) {

356  
NGX_OK
;

359 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

360 "RTMPággªg©ê¥ev_size=%uD", 
¥ev_size
);

363  
NGX_OK
;

364 
	}
}

367 
ngx_öt_t


368 
	$ngx_πmp_amf_mesßge_h™dÀr
(
ngx_πmp_£ssi⁄_t
 *
s
,

369 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
)

371 
ngx_πmp_amf_˘x_t
 
a˘
;

372 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
;

373 
ngx_¨øy_t
 *
ch
;

374 
ngx_πmp_h™dÀr_±
 *
ph
;

375 
size_t
 
Àn
, 
n
;

377 
u_ch¨
 
func
[128];

379 
ngx_πmp_amf_ñt_t
 
ñts
[] = {

381 { 
NGX_RTMP_AMF_STRING
,

382 
ngx_nuŒ_°rög
,

383 
func
, (func) },

388 i‡(
h
->
ty≥
 =
NGX_RTMP_MSG_AMF_SHARED
 ||

389 
h
->
ty≥
 =
NGX_RTMP_MSG_AMF3_SHARED
)

391 
ñts
[0].
ty≥
 |
NGX_RTMP_AMF_TYPELESS
;

393 
ñts
[0].
ty≥
 &~
NGX_RTMP_AMF_TYPELESS
;

396 i‡((
h
->
ty≥
 =
NGX_RTMP_MSG_AMF3_SHARED
 ||

397 
h
->
ty≥
 =
NGX_RTMP_MSG_AMF3_META
 ||

398 
h
->
ty≥
 =
NGX_RTMP_MSG_AMF3_CMD
)

399 && 
ö
->
buf
->
œ°
 > in->buf->
pos
)

401 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

402 "AMF3Öªfix: %ui", (
ngx_öt_t
)*
ö
->
buf
->
pos
);

403 ++
ö
->
buf
->
pos
;

406 
cmcf
 = 
	`ngx_πmp_gë_moduÀ_maö_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

409 
	`ngx_memzîo
(&
a˘
, (act));

410 
a˘
.
lök
 = 
ö
;

411 
a˘
.
log
 = 
s
->
c⁄√˘i⁄
->log;

412 
	`mem£t
(
func
, 0, (func));

414 i‡(
	`ngx_πmp_amf_ªad
(&
a˘
, 
ñts
,

415 (
ñts
Ë/ ”…s[0])Ë!
NGX_OK
)

417 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

419  
NGX_ERROR
;

423 
ö
 = 
a˘
.
lök
;

424 
ö
->
buf
->
pos
 +
a˘
.
off£t
;

426 
Àn
 = 
	`ngx_°æí
(
func
);

428 
ch
 = 
	`ngx_hash_föd
(&
cmcf
->
amf_hash
,

429 
	`ngx_hash_°æow
(
func
, func, 
Àn
), func,Üen);

431 i‡(
ch
 && ch->
√…s
) {

432 
ph
 = 
ch
->
ñts
;

433 
n
 = 0;Ç < 
ch
->
√…s
; ++n, ++
ph
) {

434 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

436 
func
, 
n
, 
ch
->
√…s
);

437 (*
ph
)(
s
, 
h
, 
ö
)) {

438 
NGX_ERROR
:

439  
NGX_ERROR
;

440 
NGX_DONE
:

441  
NGX_OK
;

445 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

446 "AMF cmd '%s'Çÿh™dÀr", 
func
);

449  
NGX_OK
;

450 
	}
}

453 
ngx_öt_t


454 
	$ngx_πmp_ª˚ive_amf
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_chaö_t
 *
ö
,

455 
ngx_πmp_amf_ñt_t
 *
ñts
, 
size_t
 
√…s
)

457 
ngx_πmp_amf_˘x_t
 
a˘
;

459 
	`ngx_memzîo
(&
a˘
, (act));

460 
a˘
.
lök
 = 
ö
;

461 
a˘
.
log
 = 
s
->
c⁄√˘i⁄
->log;

463  
	`ngx_πmp_amf_ªad
(&
a˘
, 
ñts
, 
√…s
);

464 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_record_module.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp.h
"

10 
	~"ngx_πmp_cmd_moduÀ.h
"

11 
	~"ngx_πmp_√tˇŒ_moduÀ.h
"

12 
	~"ngx_πmp_codec_moduÀ.h
"

13 
	~"ngx_πmp_ªc‹d_moduÀ.h
"

16 
ngx_πmp_ªc‹d_d⁄e_±
 
	gngx_πmp_ªc‹d_d⁄e
;

19 
ngx_πmp_publish_±
 
	g√xt_publish
;

20 
ngx_πmp_˛o£_°ªam_±
 
	g√xt_˛o£_°ªam
;

21 
ngx_πmp_°ªam_begö_±
 
	g√xt_°ªam_begö
;

22 
ngx_πmp_°ªam_eof_±
 
	g√xt_°ªam_eof
;

25 *
ngx_πmp_ªc‹d_ªc‹dî
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
,

26 *
c⁄f
);

27 
ngx_öt_t
 
ngx_πmp_ªc‹d_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
);

28 * 
ngx_πmp_ªc‹d_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
);

29 * 
ngx_πmp_ªc‹d_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
,

30 *
∑ª¡
, *
chûd
);

31 
ngx_öt_t
 
ngx_πmp_ªc‹d_wrôe_‰ame
(
ngx_πmp_£ssi⁄_t
 *
s
,

32 
ngx_πmp_ªc‹d_ªc_˘x_t
 *
r˘x
,

33 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
, 
ngx_öt_t
 
öc_n‰ames
);

34 
ngx_öt_t
 
ngx_πmp_ªc‹d_av
(
ngx_πmp_£ssi⁄_t
 *
s
,

35 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
);

36 
ngx_öt_t
 
ngx_πmp_ªc‹d_node_av
(
ngx_πmp_£ssi⁄_t
 *
s
,

37 
ngx_πmp_ªc‹d_ªc_˘x_t
 *
r˘x
, 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
);

38 
ngx_öt_t
 
ngx_πmp_ªc‹d_node_›í
(
ngx_πmp_£ssi⁄_t
 *
s
,

39 
ngx_πmp_ªc‹d_ªc_˘x_t
 *
r˘x
);

40 
ngx_öt_t
 
ngx_πmp_ªc‹d_node_˛o£
(
ngx_πmp_£ssi⁄_t
 *
s
,

41 
ngx_πmp_ªc‹d_ªc_˘x_t
 *
r˘x
);

42 
ngx_πmp_ªc‹d_make_∑th
(
ngx_πmp_£ssi⁄_t
 *
s
,

43 
ngx_πmp_ªc‹d_ªc_˘x_t
 *
r˘x
, 
ngx_°r_t
 *
∑th
);

44 
ngx_öt_t
 
ngx_πmp_ªc‹d_öô
(
ngx_πmp_£ssi⁄_t
 *
s
);

47 
ngx_πmp_ªc‹d_¸óã_maö_c⁄f
(
ngx_c⁄f_t
 *
cf
);

49 
ngx_c⁄f_bômask_t
 
	gngx_πmp_ªc‹d_mask
[] = {

50 { 
ngx_°rög
("off"), 
NGX_RTMP_RECORD_OFF
 },

51 { 
ngx_°rög
("Æl"), 
NGX_RTMP_RECORD_AUDIO
 |

52 
NGX_RTMP_RECORD_VIDEO
 },

53 { 
ngx_°rög
("audio"), 
NGX_RTMP_RECORD_AUDIO
 },

54 { 
ngx_°rög
("video"), 
NGX_RTMP_RECORD_VIDEO
 },

55 { 
ngx_°rög
("key‰ames"), 
NGX_RTMP_RECORD_KEYFRAMES
 },

56 { 
ngx_°rög
("m™uÆ"), 
NGX_RTMP_RECORD_MANUAL
 },

57 { 
ngx_nuŒ_°rög
, 0 }

61 
ngx_comm™d_t
 
	gngx_πmp_ªc‹d_comm™ds
[] = {

63 { 
ngx_°rög
("record"),

64 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|

65 
NGX_RTMP_REC_CONF
|
NGX_CONF_1MORE
,

66 
ngx_c⁄f_£t_bômask_¶Ÿ
,

67 
NGX_RTMP_APP_CONF_OFFSET
,

68 
off£tof
(
ngx_πmp_ªc‹d_≠p_c⁄f_t
, 
Êags
),

69 
ngx_πmp_ªc‹d_mask
 },

71 { 
ngx_°rög
("record_path"),

72 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|

73 
NGX_RTMP_REC_CONF
|
NGX_CONF_TAKE1
,

74 
ngx_c⁄f_£t_°r_¶Ÿ
,

75 
NGX_RTMP_APP_CONF_OFFSET
,

76 
off£tof
(
ngx_πmp_ªc‹d_≠p_c⁄f_t
, 
∑th
),

77 
NULL
 },

79 { 
ngx_°rög
("record_suffix"),

80 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|

81 
NGX_RTMP_REC_CONF
|
NGX_CONF_TAKE1
,

82 
ngx_c⁄f_£t_°r_¶Ÿ
,

83 
NGX_RTMP_APP_CONF_OFFSET
,

84 
off£tof
(
ngx_πmp_ªc‹d_≠p_c⁄f_t
, 
suffix
),

85 
NULL
 },

87 { 
ngx_°rög
("record_unique"),

88 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|

89 
NGX_RTMP_REC_CONF
|
NGX_CONF_TAKE1
,

90 
ngx_c⁄f_£t_Êag_¶Ÿ
,

91 
NGX_RTMP_APP_CONF_OFFSET
,

92 
off£tof
(
ngx_πmp_ªc‹d_≠p_c⁄f_t
, 
unique
),

93 
NULL
 },

95 { 
ngx_°rög
("record_append"),

96 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|

97 
NGX_RTMP_REC_CONF
|
NGX_CONF_TAKE1
,

98 
ngx_c⁄f_£t_Êag_¶Ÿ
,

99 
NGX_RTMP_APP_CONF_OFFSET
,

100 
off£tof
(
ngx_πmp_ªc‹d_≠p_c⁄f_t
, 
≠≥nd
),

101 
NULL
 },

103 { 
ngx_°rög
("record_lock"),

104 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|

105 
NGX_RTMP_REC_CONF
|
NGX_CONF_TAKE1
,

106 
ngx_c⁄f_£t_Êag_¶Ÿ
,

107 
NGX_RTMP_APP_CONF_OFFSET
,

108 
off£tof
(
ngx_πmp_ªc‹d_≠p_c⁄f_t
, 
lock_fûe
),

109 
NULL
 },

111 { 
ngx_°rög
("record_max_size"),

112 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|

113 
NGX_RTMP_REC_CONF
|
NGX_CONF_TAKE1
,

114 
ngx_c⁄f_£t_size_¶Ÿ
,

115 
NGX_RTMP_APP_CONF_OFFSET
,

116 
off£tof
(
ngx_πmp_ªc‹d_≠p_c⁄f_t
, 
max_size
),

117 
NULL
 },

119 { 
ngx_°rög
("record_max_frames"),

120 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|

121 
NGX_RTMP_REC_CONF
|
NGX_CONF_TAKE1
,

122 
ngx_c⁄f_£t_size_¶Ÿ
,

123 
NGX_RTMP_APP_CONF_OFFSET
,

124 
off£tof
(
ngx_πmp_ªc‹d_≠p_c⁄f_t
, 
max_‰ames
),

125 
NULL
 },

127 { 
ngx_°rög
("record_interval"),

128 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|

129 
NGX_RTMP_REC_CONF
|
NGX_CONF_TAKE1
,

130 
ngx_c⁄f_£t_m£c_¶Ÿ
,

131 
NGX_RTMP_APP_CONF_OFFSET
,

132 
off£tof
(
ngx_πmp_ªc‹d_≠p_c⁄f_t
, 
öãrvÆ
),

133 
NULL
 },

135 { 
ngx_°rög
("record_notify"),

136 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|

137 
NGX_RTMP_REC_CONF
|
NGX_CONF_TAKE1
,

138 
ngx_c⁄f_£t_Êag_¶Ÿ
,

139 
NGX_RTMP_APP_CONF_OFFSET
,

140 
off£tof
(
ngx_πmp_ªc‹d_≠p_c⁄f_t
, 
nŸify
),

141 
NULL
 },

143 { 
ngx_°rög
("recorder"),

144 
NGX_RTMP_APP_CONF
|
NGX_CONF_BLOCK
|
NGX_CONF_TAKE1
,

145 
ngx_πmp_ªc‹d_ªc‹dî
,

146 
NGX_RTMP_APP_CONF_OFFSET
,

148 
NULL
 },

150 { 
ngx_°rög
("queue"),

151 
NGX_RTMP_MAIN_CONF
|
NGX_CONF_TAKE1
,

152 
NULL
,

153 
NGX_RTMP_MAIN_CONF_OFFSET
,

154 
off£tof
(
ngx_πmp_ªc‹d_maö_c⁄f_t
, 
queue
),

155 
NULL
 },

158 
ngx_nuŒ_comm™d


162 
ngx_πmp_moduÀ_t
 
	gngx_πmp_ªc‹d_moduÀ_˘x
 = {

163 
NULL
,

164 
ngx_πmp_ªc‹d_po°c⁄figuøti⁄
,

165 
ngx_πmp_ªc‹d_¸óã_maö_c⁄f
,

166 
NULL
,

167 
NULL
,

168 
NULL
,

169 
ngx_πmp_ªc‹d_¸óã_≠p_c⁄f
,

170 
ngx_πmp_ªc‹d_mîge_≠p_c⁄f


174 
ngx_moduÀ_t
 
	gngx_πmp_ªc‹d_moduÀ
 = {

175 
NGX_MODULE_V1
,

176 &
ngx_πmp_ªc‹d_moduÀ_˘x
,

177 
ngx_πmp_ªc‹d_comm™ds
,

178 
NGX_RTMP_MODULE
,

179 
NULL
,

180 
NULL
,

181 
NULL
,

182 
NULL
,

183 
NULL
,

184 
NULL
,

185 
NULL
,

186 
NGX_MODULE_V1_PADDING


191 
	$ngx_πmp_ªc‹d_¸óã_maö_c⁄f
(
ngx_c⁄f_t
 *
cf
)

193 
ngx_πmp_ªc‹d_maö_c⁄f_t
 *
rmcf
;

195 
rmcf
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_ªc‹d_maö_c⁄f_t
));

196 i‡(
rmcf
 =
NULL
) {

197  
NULL
;

200 
rmcf
->
queue
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_queue_t
));

201 
	`ngx_queue_öô
(
rmcf
->
queue
);

203 
ngx_πmp_ªc‹d_maö_c⁄f
 = 
rmcf
;

205  
rmcf
;

206 
	}
}

209 
	$ngx_πmp_ªc‹d_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
)

211 
ngx_πmp_ªc‹d_≠p_c⁄f_t
 *
øcf
;

213 
øcf
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_ªc‹d_≠p_c⁄f_t
));

215 i‡(
øcf
 =
NULL
) {

216  
NULL
;

219 
øcf
->
max_size
 = 
NGX_CONF_UNSET_SIZE
;

220 
øcf
->
max_‰ames
 = 
NGX_CONF_UNSET_SIZE
;

221 
øcf
->
öãrvÆ
 = 
NGX_CONF_UNSET_MSEC
;

222 
øcf
->
unique
 = 
NGX_CONF_UNSET
;

223 
øcf
->
≠≥nd
 = 
NGX_CONF_UNSET
;

224 
øcf
->
lock_fûe
 = 
NGX_CONF_UNSET
;

225 
øcf
->
nŸify
 = 
NGX_CONF_UNSET
;

226 
øcf
->
uæ
 = 
NGX_CONF_UNSET_PTR
;

228 i‡(
	`ngx_¨øy_öô
(&
øcf
->
ªc
, 
cf
->
poﬁ
, 1, (*)Ë!
NGX_OK
) {

229  
NULL
;

232  
øcf
;

233 
	}
}

237 
	$ngx_πmp_ªc‹d_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
∑ª¡
, *
chûd
)

239 
ngx_πmp_ªc‹d_≠p_c⁄f_t
 *
¥ev
 = 
∑ª¡
;

240 
ngx_πmp_ªc‹d_≠p_c⁄f_t
 *
c⁄f
 = 
chûd
;

241 
ngx_πmp_ªc‹d_≠p_c⁄f_t
 **
ºacf
;

243 
	`ngx_c⁄f_mîge_°r_vÆue
(
c⁄f
->
∑th
, 
¥ev
->path, "");

244 
	`ngx_c⁄f_mîge_°r_vÆue
(
c⁄f
->
suffix
, 
¥ev
->suffix, ".flv");

245 
	`ngx_c⁄f_mîge_size_vÆue
(
c⁄f
->
max_size
, 
¥ev
->max_size, 0);

246 
	`ngx_c⁄f_mîge_size_vÆue
(
c⁄f
->
max_‰ames
, 
¥ev
->max_frames, 0);

247 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
unique
, 
¥ev
->unique, 0);

248 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
≠≥nd
, 
¥ev
->append, 0);

249 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
lock_fûe
, 
¥ev
->lock_file, 0);

250 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
nŸify
, 
¥ev
->notify, 0);

251 
	`ngx_c⁄f_mîge_m£c_vÆue
(
c⁄f
->
öãrvÆ
, 
¥ev
->interval,

252 (
ngx_m£c_t
Ë
NGX_CONF_UNSET
);

253 
	`ngx_c⁄f_mîge_bômask_vÆue
(
c⁄f
->
Êags
, 
¥ev
->flags, 0);

254 
	`ngx_c⁄f_mîge_±r_vÆue
(
c⁄f
->
uæ
, 
¥ev
->uæ, 
NULL
);

256 i‡(
c⁄f
->
Êags
) {

257 
ºacf
 = 
	`ngx_¨øy_push
(&
c⁄f
->
ªc
);

258 i‡(
ºacf
 =
NULL
) {

259  
NGX_CONF_ERROR
;

262 *
ºacf
 = 
c⁄f
;

265  
NGX_CONF_OK
;

266 
	}
}

269 
ngx_öt_t


270 
	$ngx_πmp_ªc‹d_wrôe_hódî
(
ngx_fûe_t
 *
fûe
)

272 
u_ch¨
 
Êv_hódî
[] = {

288  
	`ngx_wrôe_fûe
(
fûe
, 
Êv_hódî
, (Êv_hódî), 0Ë=
NGX_ERROR


289 ? 
NGX_ERROR


290 : 
NGX_OK
;

291 
	}
}

294 
ngx_πmp_ªc‹d_ªc_˘x_t
 *

295 
	$ngx_πmp_ªc‹d_gë_node_˘x
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_uöt_t
 
n
)

297 
ngx_πmp_ªc‹d_˘x_t
 *
˘x
;

298 
ngx_πmp_ªc‹d_ªc_˘x_t
 *
r˘x
;

300 i‡(
	`ngx_πmp_ªc‹d_öô
(
s
Ë!
NGX_OK
) {

301  
NULL
;

304 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªc‹d_moduÀ
);

306 i‡(
n
 >
˘x
->
ªc
.
√…s
) {

307  
NULL
;

310 
r˘x
 = 
˘x
->
ªc
.
ñts
;

312  &
r˘x
[
n
];

313 
	}
}

316 
ngx_öt_t


317 
	$ngx_πmp_ªc‹d_›í
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_uöt_t
 
n
, 
ngx_°r_t
 *
∑th
)

319 
ngx_πmp_ªc‹d_ªc_˘x_t
 *
r˘x
;

320 
ngx_öt_t
 
rc
;

322 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

323 "ªc‹d: #%uòm™uÆ o≥n", 
n
);

325 
r˘x
 = 
	`ngx_πmp_ªc‹d_gë_node_˘x
(
s
, 
n
);

327 i‡(
r˘x
 =
NULL
) {

328  
NGX_ERROR
;

331 
rc
 = 
	`ngx_πmp_ªc‹d_node_›í
(
s
, 
r˘x
);

332 i‡(
rc
 !
NGX_OK
) {

333  
rc
;

336 i‡(
∑th
) {

337 
	`ngx_πmp_ªc‹d_make_∑th
(
s
, 
r˘x
, 
∑th
);

340  
NGX_OK
;

341 
	}
}

344 
ngx_öt_t


345 
	$ngx_πmp_ªc‹d_˛o£
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_uöt_t
 
n
, 
ngx_°r_t
 *
∑th
)

347 
ngx_πmp_ªc‹d_ªc_˘x_t
 *
r˘x
;

348 
ngx_öt_t
 
rc
;

350 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

351 "ªc‹d: #%uòm™uÆ clo£", 
n
);

353 
r˘x
 = 
	`ngx_πmp_ªc‹d_gë_node_˘x
(
s
, 
n
);

355 i‡(
r˘x
 =
NULL
) {

356  
NGX_ERROR
;

359 
rc
 = 
	`ngx_πmp_ªc‹d_node_˛o£
(
s
, 
r˘x
);

360 i‡(
rc
 !
NGX_OK
) {

361  
rc
;

364 i‡(
∑th
) {

365 
	`ngx_πmp_ªc‹d_make_∑th
(
s
, 
r˘x
, 
∑th
);

368  
NGX_OK
;

369 
	}
}

372 
ngx_uöt_t


373 
	$ngx_πmp_ªc‹d_föd
(
ngx_πmp_ªc‹d_≠p_c⁄f_t
 *
øcf
, 
ngx_°r_t
 *
id
)

375 
ngx_πmp_ªc‹d_≠p_c⁄f_t
 **
¥acf
, *
ºacf
;

376 
ngx_uöt_t
 
n
;

378 
¥acf
 = 
øcf
->
ªc
.
ñts
;

380 
n
 = 0;Ç < 
øcf
->
ªc
.
√…s
; ++n, ++
¥acf
) {

381 
ºacf
 = *
¥acf
;

383 i‡(
ºacf
->
id
.
Àn
 == id->len &&

384 
	`ngx_°∫cmp
(
ºacf
->
id
.
d©a
, id->d©a, id->
Àn
) == 0)

386  
n
;

390  
NGX_CONF_UNSET_UINT
;

391 
	}
}

394 
ngx_öt_t


395 
	$ngx_πmp_¨g
(
ngx_°r_t
 
§c
, 
u_ch¨
 *
«me
, 
size_t
 
Àn
,Çgx_°r_à*
vÆue
)

397 
u_ch¨
 *
p
, *
œ°
;

399 i‡(
§c
.
Àn
 == 0) {

400  
NGX_DECLINED
;

403 
p
 = 
§c
.
d©a
;

404 
œ°
 = 
p
 + 
§c
.
Àn
;

406  ; 
p
 < 
œ°
;Ö++) {

410 
p
 = 
	`ngx_°æˇ£°∫
’, 
œ°
 - 1, 
«me
, 
Àn
 - 1);

412 i‡(
p
 =
NULL
) {

413  
NGX_DECLINED
;

416 i‡((
p
 =
§c
.
d©a
 || *’ - 1Ë='&'Ë&& *’ + 
Àn
) == '=') {

418 
vÆue
->
d©a
 = 
p
 + 
Àn
 + 1;

420 
p
 = 
	`ngx_°æchr
’, 
œ°
, '&');

422 i‡(
p
 =
NULL
) {

423 
p
 = 
§c
.
d©a
 + src.
Àn
;

426 
vÆue
->
Àn
 = 
p
 - vÆue->
d©a
;

428  
NGX_OK
;

432  
NGX_DECLINED
;

433 
	}
}

438 
	$ngx_πmp_ªc‹d_make_∑th
(
ngx_πmp_£ssi⁄_t
 *
s
,

439 
ngx_πmp_ªc‹d_ªc_˘x_t
 *
r˘x
, 
ngx_°r_t
 *
∑th
)

441 
ngx_πmp_ªc‹d_˘x_t
 *
˘x
;

442 
ngx_πmp_ªc‹d_≠p_c⁄f_t
 *
ºacf
;

443 
u_ch¨
 *
p
, *
l
;

444 
tm
Åm;

446 
u_ch¨
 
buf
[
NGX_TIME_T_LEN
 + 1];

447 
u_ch¨
 
pbuf
[
NGX_MAX_PATH
 + 1];

449 
has_liveid_Êag
 = 0;

451 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªc‹d_moduÀ
);

453 
ºacf
 = 
r˘x
->
c⁄f
;

456 
p
 = 
pbuf
;

457 
l
 = 
pbuf
 + (pbuf) - 1;

459 
p
 = 
	`ngx_˝ymem
’, 
ºacf
->
∑th
.
d©a
,

460 
	`ngx_mö
(
ºacf
->
∑th
.
Àn
, (
size_t
)(
l
 - 
p
 - 1)));

461 *
p
++ = '/';

462 
p
 = (
u_ch¨
 *)
	`ngx_esˇ≥_uri
’, 
˘x
->
«me
, 
	`ngx_mö
(
	`ngx_°æí
(ctx->name),

463 (
size_t
)(
l
 - 
p
)), 
NGX_ESCAPE_URI_COMPONENT
);

468 i‡(
	`ngx_°æí
(
˘x
->
liveid
) != 0) {

469 
has_liveid_Êag
 = 1;

471 i‡(
ºacf
->
unique
) {

472 i‡(
has_liveid_Êag
 == 1) {

473 
p
 = 
	`ngx_˝ymem
’, "-", 
	`ngx_mö
(1, 
l
 -Ö));

474 
p
 = 
	`ngx_˝ymem
’, 
˘x
->
liveid
, 
	`ngx_mö
((sig√d)(
	`ngx_°æí
(˘x->liveid)), 
l
 -Ö));

476 
p
 = 
	`ngx_˝ymem
’, 
buf
, 
	`ngx_mö
(
	`ngx_•rötf
(buf, "-%T",

477 
r˘x
->
time°amp
Ë- 
buf
, 
l
 - 
p
));

482 i‡(
	`ngx_°rchr
(
ºacf
->
suffix
.
d©a
, '%')) {

483 
	`ngx_libc_loˇ…ime
(
r˘x
->
time°amp
, &
tm
);

484 
p
 +
	`°r·ime
((*Ëp, 
l
 -Ö, (*Ë
ºacf
->
suffix
.
d©a
, &
tm
);

486 
p
 = 
	`ngx_˝ymem
’, 
ºacf
->
suffix
.
d©a
,

487 
	`ngx_mö
(
ºacf
->
suffix
.
Àn
, (
size_t
)(
l
 - 
p
)));

490 *
p
 = 0;

491 
∑th
->
d©a
 = 
pbuf
;

492 
∑th
->
Àn
 = 
p
 - 
pbuf
;

494 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

495 "ªc‹d: %VÖ©h: '%V'", &
ºacf
->
id
, 
∑th
);

496 
	}
}

500 
	$ngx_πmp_ªc‹d_nŸify_îr‹
(
ngx_πmp_£ssi⁄_t
 *
s
,

501 
ngx_πmp_ªc‹d_ªc_˘x_t
 *
r˘x
)

503 
ngx_πmp_ªc‹d_≠p_c⁄f_t
 *
ºacf
 = 
r˘x
->
c⁄f
;

505 
r˘x
->
Áûed
 = 1;

507 i‡(!
ºacf
->
nŸify
) {

511 
	`ngx_πmp_£nd_°©us
(
s
, "NetStream.Record.Failed", "error",

512 
ºacf
->
id
.
d©a
 ? (*)Ñracf->id.data : "");

513 
	}
}

516 
ngx_öt_t


517 
	$ngx_πmp_ªc‹d_node_›í
(
ngx_πmp_£ssi⁄_t
 *
s
,

518 
ngx_πmp_ªc‹d_ªc_˘x_t
 *
r˘x
)

520 
ngx_πmp_ªc‹d_≠p_c⁄f_t
 *
ºacf
;

521 
ngx_îr_t
 
îr
;

522 
ngx_°r_t
 
∑th
;

523 
ngx_öt_t
 
mode
, 
¸óã_mode
;

524 
u_ch¨
 
buf
[8], *
p
;

525 
off_t
 
fûe_size
;

526 
uöt32_t
 
èg_size
, 
mÀn
, 
time°amp
;

528 
ºacf
 = 
r˘x
->
c⁄f
;

529 
èg_size
 = 0;

531 i‡(
r˘x
->
fûe
.
fd
 !
NGX_INVALID_FILE
) {

532  
NGX_AGAIN
;

535 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

536 "ªc‹d: %V o≥nög", &
ºacf
->
id
);

538 
	`ngx_memzîo
(
r˘x
, (*rctx));

539 
r˘x
->
c⁄f
 = 
ºacf
;

540 
r˘x
->
œ°
 = *
ngx_ˇched_time
;

541 
r˘x
->
time°amp
 = 
ngx_ˇched_time
->
£c
;

543 
	`ngx_πmp_ªc‹d_make_∑th
(
s
, 
r˘x
, &
∑th
);

545 
mode
 = 
ºacf
->
≠≥nd
 ? 
NGX_FILE_RDWR
 : 
NGX_FILE_WRONLY
;

546 
¸óã_mode
 = 
ºacf
->
≠≥nd
 ? 
NGX_FILE_CREATE_OR_OPEN
 : 
NGX_FILE_TRUNCATE
;

548 
	`ngx_memzîo
(&
r˘x
->
fûe
, (rctx->file));

549 
r˘x
->
fûe
.
off£t
 = 0;

550 
r˘x
->
fûe
.
log
 = 
s
->
c⁄√˘i⁄
->log;

551 
r˘x
->
fûe
.
fd
 = 
	`ngx_›í_fûe
(
∑th
.
d©a
, 
mode
, 
¸óã_mode
,

552 
NGX_FILE_DEFAULT_ACCESS
);

553 
	`ngx_°r_£t
(&
r˘x
->
fûe
.
«me
, "recorded");

555 i‡(
r˘x
->
fûe
.
fd
 =
NGX_INVALID_FILE
) {

556 
îr
 = 
ngx_î∫o
;

558 i‡(
îr
 !
NGX_ENOENT
) {

559 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
s
->
c⁄√˘i⁄
->
log
, 
îr
,

561 &
ºacf
->
id
, &
∑th
);

564 
	`ngx_πmp_ªc‹d_nŸify_îr‹
(
s
, 
r˘x
);

566  
NGX_OK
;

569 #i‡!(
NGX_WIN32
)

570 i‡(
ºacf
->
lock_fûe
) {

571 
îr
 = 
	`ngx_lock_fd
(
r˘x
->
fûe
.
fd
);

572 i‡(
îr
) {

573 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
s
->
c⁄√˘i⁄
->
log
, 
îr
,

574 "ªc‹d: %VÜock faûed", &
ºacf
->
id
);

579 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

580 "ªc‹d: %V o≥√d '%V'", &
ºacf
->
id
, &
∑th
);

582 i‡(
ºacf
->
nŸify
) {

583 
	`ngx_πmp_£nd_°©us
(
s
, "NetStream.Record.Start", "status",

584 
ºacf
->
id
.
d©a
 ? (*)Ñracf->id.data : "");

587 i‡(
ºacf
->
≠≥nd
) {

589 
fûe_size
 = 0;

590 
time°amp
 = 0;

592 #i‡(
NGX_WIN32
)

594 
LONG
 
lo
, 
hi
;

596 
lo
 = 0;

597 
hi
 = 0;

598 
lo
 = 
	`SëFûePoöãr
(
r˘x
->
fûe
.
fd
,Üo, &
hi
, 
FILE_END
);

599 
fûe_size
 = (
lo
 =
INVALID_SET_FILE_POINTER
 ?

600 (
off_t
Ë-1 : (off_tË
hi
 << 32 | (off_tË
lo
);

603 
fûe_size
 = 
	`l£ek
(
r˘x
->
fûe
.
fd
, 0, 
SEEK_END
);

605 i‡(
fûe_size
 =(
off_t
) -1) {

606 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

607 "ªc‹d: %V sìk faûed", &
ºacf
->
id
);

608 
d⁄e
;

611 i‡(
fûe_size
 < 4) {

612 
d⁄e
;

615 i‡(
	`ngx_ªad_fûe
(&
r˘x
->
fûe
, 
buf
, 4, 
fûe_size
 - 4) != 4) {

616 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

617 "ªc‹d: %VÅag sizêªad faûed", &
ºacf
->
id
);

618 
d⁄e
;

621 
p
 = (
u_ch¨
 *Ë&
èg_size
;

622 
p
[0] = 
buf
[3];

623 
p
[1] = 
buf
[2];

624 
p
[2] = 
buf
[1];

625 
p
[3] = 
buf
[0];

627 i‡(
èg_size
 =0 ||Åag_sizê+ 4 > 
fûe_size
) {

628 
fûe_size
 = 0;

629 
d⁄e
;

632 i‡(
	`ngx_ªad_fûe
(&
r˘x
->
fûe
, 
buf
, 8, 
fûe_size
 - 
èg_size
 - 4) != 8)

634 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

635 "ªc‹d: %VÅagÑód faûed", &
ºacf
->
id
);

636 
d⁄e
;

639 
p
 = (
u_ch¨
 *Ë&
mÀn
;

640 
p
[0] = 
buf
[3];

641 
p
[1] = 
buf
[2];

642 
p
[2] = 
buf
[1];

643 
p
[3] = 0;

645 i‡(
èg_size
 !
mÀn
 + 11) {

646 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

648 "èg_size=%uD, mÀn=%uD", &
ºacf
->
id
, 
èg_size
, 
mÀn
);

649 
d⁄e
;

652 
p
 = (
u_ch¨
 *Ë&
time°amp
;

653 
p
[3] = 
buf
[7];

654 
p
[0] = 
buf
[6];

655 
p
[1] = 
buf
[5];

656 
p
[2] = 
buf
[4];

658 
d⁄e
:

659 
r˘x
->
fûe
.
off£t
 = 
fûe_size
;

660 
r˘x
->
time_shi·
 = 
time°amp
;

662 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

664 
fûe_size
, 
time°amp
, 
èg_size
);

667  
NGX_OK
;

668 
	}
}

671 
ngx_öt_t


672 
	$ngx_πmp_ªc‹d_öô
(
ngx_πmp_£ssi⁄_t
 *
s
)

674 
ngx_πmp_ªc‹d_≠p_c⁄f_t
 *
øcf
, **
ºacf
;

675 
ngx_πmp_ªc‹d_ªc_˘x_t
 *
r˘x
;

676 
ngx_πmp_ªc‹d_˘x_t
 *
˘x
;

677 
ngx_uöt_t
 
n
;

679 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªc‹d_moduÀ
);

681 i‡(
˘x
) {

682  
NGX_OK
;

685 
øcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_ªc‹d_moduÀ
);

687 i‡(
øcf
 =
NULL
 ||Ñacf->
ªc
.
√…s
 == 0) {

688  
NGX_OK
;

691 
˘x
 = 
	`ngx_pˇŒoc
(
s
->
c⁄√˘i⁄
->
poﬁ
, (
ngx_πmp_ªc‹d_˘x_t
));

693 i‡(
˘x
 =
NULL
) {

694  
NGX_ERROR
;

697 
	`ngx_πmp_£t_˘x
(
s
, 
˘x
, 
ngx_πmp_ªc‹d_moduÀ
);

699 i‡(
	`ngx_¨øy_öô
(&
˘x
->
ªc
, 
s
->
c⁄√˘i⁄
->
poﬁ
, 
øcf
->ªc.
√…s
,

700 (
ngx_πmp_ªc‹d_ªc_˘x_t
))

701 !
NGX_OK
)

703  
NGX_ERROR
;

706 
ºacf
 = 
øcf
->
ªc
.
ñts
;

708 
r˘x
 = 
	`ngx_¨øy_push_n
(&
˘x
->
ªc
, 
øcf
->ªc.
√…s
);

710 i‡(
r˘x
 =
NULL
) {

711  
NGX_ERROR
;

714 
n
 = 0;Ç < 
øcf
->
ªc
.
√…s
; ++n, ++
ºacf
, ++
r˘x
) {

715 
	`ngx_memzîo
(
r˘x
, (*rctx));

717 
r˘x
->
c⁄f
 = *
ºacf
;

718 
r˘x
->
fûe
.
fd
 = 
NGX_INVALID_FILE
;

721  
NGX_OK
;

722 
	}
}

726 
	$ngx_πmp_ªc‹d_°¨t
(
ngx_πmp_£ssi⁄_t
 *
s
)

728 
ngx_πmp_ªc‹d_≠p_c⁄f_t
 *
øcf
;

729 
ngx_πmp_ªc‹d_ªc_˘x_t
 *
r˘x
;

730 
ngx_πmp_ªc‹d_˘x_t
 *
˘x
;

731 
ngx_uöt_t
 
n
;

733 
øcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_ªc‹d_moduÀ
);

734 i‡(
øcf
 =
NULL
 ||Ñacf->
ªc
.
√…s
 == 0) {

738 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªc‹d_moduÀ
);

739 i‡(
˘x
 =
NULL
) {

743 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

746 
r˘x
 = 
˘x
->
ªc
.
ñts
;

747 
n
 = 0;Ç < 
˘x
->
ªc
.
√…s
; ++n, ++
r˘x
) {

748 i‡(
r˘x
->
c⁄f
->
Êags
 & (
NGX_RTMP_RECORD_OFF
|
NGX_RTMP_RECORD_MANUAL
)) {

751 
	`ngx_πmp_ªc‹d_node_›í
(
s
, 
r˘x
);

753 
	}
}

757 
	$ngx_πmp_ªc‹d_°›
(
ngx_πmp_£ssi⁄_t
 *
s
)

759 
ngx_πmp_ªc‹d_≠p_c⁄f_t
 *
øcf
;

760 
ngx_πmp_ªc‹d_ªc_˘x_t
 *
r˘x
;

761 
ngx_πmp_ªc‹d_˘x_t
 *
˘x
;

762 
ngx_uöt_t
 
n
;

764 
øcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_ªc‹d_moduÀ
);

765 i‡(
øcf
 =
NULL
 ||Ñacf->
ªc
.
√…s
 == 0) {

769 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªc‹d_moduÀ
);

770 i‡(
˘x
 =
NULL
) {

774 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

777 
r˘x
 = 
˘x
->
ªc
.
ñts
;

778 
n
 = 0;Ç < 
˘x
->
ªc
.
√…s
; ++n, ++
r˘x
) {

779 
	`ngx_πmp_ªc‹d_node_˛o£
(
s
, 
r˘x
);

781 
	}
}

784 
ngx_öt_t


785 
	$ngx_πmp_ªc‹d_publish
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_publish_t
 *
v
)

787 
ngx_πmp_ªc‹d_≠p_c⁄f_t
 *
øcf
;

788 
ngx_πmp_ªc‹d_˘x_t
 *
˘x
;

789 
ngx_°r_t
 
tmp_¨gs
;

790 
ngx_°r_t
 
liveid
;

791 
	`¥ötf
("liveid = %s\n", 
liveid
.
d©a
);

792 
u_ch¨
 *
p
;

794 i‡(
s
->
auto_pushed
) {

795 
√xt
;

798 
øcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_ªc‹d_moduÀ
);

800 i‡(
øcf
 =
NULL
 ||Ñacf->
ªc
.
√…s
 == 0) {

801 
√xt
;

804 i‡(
	`ngx_πmp_ªc‹d_öô
(
s
Ë!
NGX_OK
) {

805  
NGX_ERROR
;

808 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

810 
øcf
->
ªc
.
√…s
);

812 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªc‹d_moduÀ
);

814 
	`ngx_mem˝y
(
˘x
->
«me
, 
v
->name, (ctx->name));

815 
	`ngx_mem˝y
(
˘x
->
¨gs
, 
v
->args, (ctx->args));

819 
	`ngx_°r_£t
(&
tmp_¨gs
, 
v
->
¨gs
);

820 
tmp_¨gs
.
Àn
 = 
	`ngx_°æí
(
v
->
¨gs
);

821 
	`¥ötf
("liveid = %s\n", 
liveid
.
d©a
);

822 
	`¥ötf
("tmp_¨g†%s, %d\n", 
tmp_¨gs
.
d©a
,Åmp_¨gs.
Àn
);

823 i‡(
	`ngx_πmp_¨g
(
tmp_¨gs
, (
u_ch¨
 *Ë"liveid", ("liveid"Ë- 1, &
liveid
Ë!
NGX_OK
) {

824 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

826 
˘x
->
¨gs
);

828 
	`¥ötf
("liveid = %s\n", 
liveid
.
d©a
);

829 
	`ngx_mem˝y
(
˘x
->
liveid
,Üiveid.
d©a
, (ctx->liveid));

833 
p
 = 
˘x
->
«me
; *p; ++p) {

834 i‡(
	`ngx_∑th_£∑øt‹
(
p
[0]) &&

835 
p
[1] == '.' &&Ö[2] == '.' &&

836 
	`ngx_∑th_£∑øt‹
(
p
[3]))

838 *
p
 = 0;

843 
	`ngx_πmp_ªc‹d_°¨t
(
s
);

845 
√xt
:

846  
	`√xt_publish
(
s
, 
v
);

847 
	}
}

850 
ngx_öt_t


851 
	$ngx_πmp_ªc‹d_°ªam_begö
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_°ªam_begö_t
 *
v
)

853 i‡(
s
->
auto_pushed
) {

854 
√xt
;

857 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

860 
	`ngx_πmp_ªc‹d_°¨t
(
s
);

862 
√xt
:

863  
	`√xt_°ªam_begö
(
s
, 
v
);

864 
	}
}

867 
ngx_öt_t


868 
	$ngx_πmp_ªc‹d_°ªam_eof
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_°ªam_begö_t
 *
v
)

870 i‡(
s
->
auto_pushed
) {

871 
√xt
;

874 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

877 
	`ngx_πmp_ªc‹d_°›
(
s
);

879 
√xt
:

880  
	`√xt_°ªam_eof
(
s
, 
v
);

881 
	}
}

884 
ngx_öt_t


885 
	$ngx_πmp_ªc‹d_node_˛o£
(
ngx_πmp_£ssi⁄_t
 *
s
,

886 
ngx_πmp_ªc‹d_ªc_˘x_t
 *
r˘x
)

888 
ngx_πmp_ªc‹d_≠p_c⁄f_t
 *
ºacf
;

889 
ngx_îr_t
 
îr
;

890 **
≠p_c⁄f
;

891 
ngx_öt_t
 
rc
;

892 
ngx_πmp_ªc‹d_d⁄e_t
 
v
;

893 
u_ch¨
 
av
;

895 
ºacf
 = 
r˘x
->
c⁄f
;

897 i‡(
r˘x
->
fûe
.
fd
 =
NGX_INVALID_FILE
) {

898  
NGX_AGAIN
;

901 i‡(
r˘x
->
öôülized
) {

902 
av
 = 0;

904 i‡(
r˘x
->
video
) {

905 
av
 |= 0x01;

908 i‡(
r˘x
->
audio
) {

909 
av
 |= 0x04;

912 i‡(
	`ngx_wrôe_fûe
(&
r˘x
->
fûe
, &
av
, 1, 4Ë=
NGX_ERROR
) {

913 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
s
->
c⁄√˘i⁄
->
log
, 
ngx_î∫o
,

914 "ªc‹d: %VÉº‹ wrôögáv mask", &
ºacf
->
id
);

918 i‡(
	`ngx_˛o£_fûe
(
r˘x
->
fûe
.
fd
Ë=
NGX_FILE_ERROR
) {

919 
îr
 = 
ngx_î∫o
;

920 
	`ngx_log_îr‹
(
NGX_LOG_CRIT
, 
s
->
c⁄√˘i⁄
->
log
, 
îr
,

921 "ªc‹d: %VÉº‹ closög fûe", &
ºacf
->
id
);

923 
	`ngx_πmp_ªc‹d_nŸify_îr‹
(
s
, 
r˘x
);

926 
r˘x
->
fûe
.
fd
 = 
NGX_INVALID_FILE
;

928 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

929 "ªc‹d: %V clo£d", &
ºacf
->
id
);

931 i‡(
ºacf
->
nŸify
) {

932 
	`ngx_πmp_£nd_°©us
(
s
, "NetStream.Record.Stop", "status",

933 
ºacf
->
id
.
d©a
 ? (*)Ñracf->id.data : "");

936 
≠p_c⁄f
 = 
s
->app_conf;

938 i‡(
ºacf
->
ªc_c⁄f
) {

939 
s
->
≠p_c⁄f
 = 
ºacf
->
ªc_c⁄f
;

942 
v
.
ªc‹dî
 = 
ºacf
->
id
;

943 
	`ngx_πmp_ªc‹d_make_∑th
(
s
, 
r˘x
, &
v
.
∑th
);

945 
rc
 = 
	`ngx_πmp_ªc‹d_d⁄e
(
s
, &
v
);

947 
s
->
≠p_c⁄f
 =ápp_conf;

949  
rc
;

950 
	}
}

953 
ngx_öt_t


954 
	$ngx_πmp_ªc‹d_˛o£_°ªam
(
ngx_πmp_£ssi⁄_t
 *
s
,

955 
ngx_πmp_˛o£_°ªam_t
 *
v
)

957 i‡(
s
->
auto_pushed
) {

958 
√xt
;

961 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

964 
	`ngx_πmp_ªc‹d_°›
(
s
);

966 
√xt
:

967  
	`√xt_˛o£_°ªam
(
s
, 
v
);

968 
	}
}

971 
ngx_öt_t


972 
	$ngx_πmp_ªc‹d_wrôe_‰ame
(
ngx_πmp_£ssi⁄_t
 *
s
,

973 
ngx_πmp_ªc‹d_ªc_˘x_t
 *
r˘x
,

974 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
,

975 
ngx_öt_t
 
öc_n‰ames
)

977 
u_ch¨
 
hdr
[11], *
p
, *
ph
;

978 
uöt32_t
 
time°amp
, 
èg_size
;

979 
ngx_πmp_ªc‹d_≠p_c⁄f_t
 *
ºacf
;

981 
ºacf
 = 
r˘x
->
c⁄f
;

983 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

985 &
ºacf
->
id
, 
h
->
mÀn
);

987 i‡(
h
->
ty≥
 =
NGX_RTMP_MSG_VIDEO
) {

988 
r˘x
->
video
 = 1;

990 
r˘x
->
audio
 = 1;

993 
time°amp
 = 
h
->time°am∞- 
r˘x
->
ïoch
;

995 i‡((
öt32_t
Ë
time°amp
 < 0) {

996 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

997 "ªc‹d: %V cuàtime°amp=%D", &
ºacf
->
id
, 
time°amp
);

999 
time°amp
 = 0;

1003 
ph
 = 
hdr
;

1005 *
ph
++ = (
u_ch¨
)
h
->
ty≥
;

1007 
p
 = (
u_ch¨
*)&
h
->
mÀn
;

1008 *
ph
++ = 
p
[2];

1009 *
ph
++ = 
p
[1];

1010 *
ph
++ = 
p
[0];

1012 
p
 = (
u_ch¨
*)&
time°amp
;

1013 *
ph
++ = 
p
[2];

1014 *
ph
++ = 
p
[1];

1015 *
ph
++ = 
p
[0];

1016 *
ph
++ = 
p
[3];

1018 *
ph
++ = 0;

1019 *
ph
++ = 0;

1020 *
ph
++ = 0;

1022 
èg_size
 = (
ph
 - 
hdr
Ë+ 
h
->
mÀn
;

1024 i‡(
	`ngx_wrôe_fûe
(&
r˘x
->
fûe
, 
hdr
, 
ph
 - hdr,Ñ˘x->fûe.
off£t
)

1025 =
NGX_ERROR
)

1027 
	`ngx_πmp_ªc‹d_nŸify_îr‹
(
s
, 
r˘x
);

1029 
	`ngx_˛o£_fûe
(
r˘x
->
fûe
.
fd
);

1031  
NGX_ERROR
;

1040 ; 
ö
; i¿ö->
√xt
) {

1041 i‡(
ö
->
buf
->
pos
 =ö->buf->
œ°
) {

1045 i‡(
	`ngx_wrôe_fûe
(&
r˘x
->
fûe
, 
ö
->
buf
->
pos
, in->buf->
œ°


1046 - 
ö
->
buf
->
pos
, 
r˘x
->
fûe
.
off£t
)

1047 =
NGX_ERROR
)

1049  
NGX_ERROR
;

1054 
ph
 = 
hdr
;

1055 
p
 = (
u_ch¨
*)&
èg_size
;

1057 *
ph
++ = 
p
[3];

1058 *
ph
++ = 
p
[2];

1059 *
ph
++ = 
p
[1];

1060 *
ph
++ = 
p
[0];

1062 i‡(
	`ngx_wrôe_fûe
(&
r˘x
->
fûe
, 
hdr
, 
ph
 - hdr,

1063 
r˘x
->
fûe
.
off£t
)

1064 =
NGX_ERROR
)

1066  
NGX_ERROR
;

1069 
r˘x
->
n‰ames
 +
öc_n‰ames
;

1072 i‡((
ºacf
->
max_size
 && 
r˘x
->
fûe
.
off£t
 >(
ngx_öt_t
)Ñracf->max_size) ||

1073 (
ºacf
->
max_‰ames
 && 
r˘x
->
n‰ames
 >=Ñracf->max_frames))

1075 
	`ngx_πmp_ªc‹d_node_˛o£
(
s
, 
r˘x
);

1078  
NGX_OK
;

1079 
	}
}

1082 
size_t


1083 
	$ngx_πmp_ªc‹d_gë_chaö_mÀn
(
ngx_chaö_t
 *
ö
)

1085 
size_t
 
ªt
;

1087 
ªt
 = 0; 
ö
; i¿ö->
√xt
) {

1088 
ªt
 +(
ö
->
buf
->
œ°
 - in->buf->
pos
);

1091  
ªt
;

1092 
	}
}

1095 
ngx_öt_t


1096 
	$ngx_πmp_ªc‹d_av
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

1097 
ngx_chaö_t
 *
ö
)

1099 
ngx_πmp_ªc‹d_˘x_t
 *
˘x
;

1100 
ngx_πmp_ªc‹d_ªc_˘x_t
 *
r˘x
;

1101 
ngx_uöt_t
 
n
;

1103 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªc‹d_moduÀ
);

1105 i‡(
˘x
 =
NULL
) {

1106  
NGX_OK
;

1109 
r˘x
 = 
˘x
->
ªc
.
ñts
;

1111 
n
 = 0;Ç < 
˘x
->
ªc
.
√…s
; ++n, ++
r˘x
) {

1112 
	`ngx_πmp_ªc‹d_node_av
(
s
, 
r˘x
, 
h
, 
ö
);

1115  
NGX_OK
;

1116 
	}
}

1119 
ngx_öt_t


1120 
	$ngx_πmp_ªc‹d_node_av
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_ªc‹d_ªc_˘x_t
 *
r˘x
, 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
)

1122 
ngx_time_t
 
√xt
;

1123 
ngx_πmp_hódî_t
 
ch
;

1124 
ngx_πmp_codec_˘x_t
 *
codec_˘x
;

1125 
ngx_öt_t
 
key‰ame
, 
brk‰ame
;

1126 
ngx_πmp_ªc‹d_≠p_c⁄f_t
 *
ºacf
;

1127 
ngx_πmp_ªc‹d_˘x_t
 *
˘x
;

1128 
ngx_πmp_ªc‹d_maö_c⁄f_t
 *
rmcf
;

1130 
ºacf
 = 
r˘x
->
c⁄f
;

1132 i‡(
ºacf
->
Êags
 & 
NGX_RTMP_RECORD_OFF
) {

1133 
	`ngx_πmp_ªc‹d_node_˛o£
(
s
, 
r˘x
);

1134  
NGX_OK
;

1137 
key‰ame
 = (
h
->
ty≥
 =
NGX_RTMP_MSG_VIDEO
)

1138 ? (
	`ngx_πmp_gë_video_‰ame_ty≥
(
ö
Ë=
NGX_RTMP_VIDEO_KEY_FRAME
)

1141 
brk‰ame
 = (
h
->
ty≥
 =
NGX_RTMP_MSG_VIDEO
)

1142 ? 
key‰ame


1143 : (
ºacf
->
Êags
 & 
NGX_RTMP_RECORD_VIDEO
) == 0;

1146 
rmcf
 = 
	`ngx_πmp_gë_moduÀ_maö_c⁄f
(
s
, 
ngx_πmp_ªc‹d_moduÀ
);

1147 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªc‹d_moduÀ
);

1149 i‡(
brk‰ame
 && (
ºacf
->
Êags
 & 
NGX_RTMP_RECORD_MANUAL
) == 0) {

1152 i‡(
ºacf
->
öãrvÆ
 !(
ngx_m£c_t
Ë
NGX_CONF_UNSET
) {

1154 
√xt
 = 
r˘x
->
œ°
;

1155 
√xt
.
m£c
 +
ºacf
->
öãrvÆ
;

1156 
√xt
.
£c
 +“ext.
m£c
 / 1000);

1157 
√xt
.
m£c
 %= 1000;

1159 i‡(
ngx_ˇched_time
->
£c
 > 
√xt
.sec ||

1160 (
ngx_ˇched_time
->
£c
 =
√xt
.sec &&

1161 
ngx_ˇched_time
->
m£c
 > 
√xt
.msec))

1163 
	`ngx_πmp_ªc‹d_node_˛o£
(
s
, 
r˘x
);

1164 
	`ngx_πmp_ªc‹d_node_›í
(
s
, 
r˘x
);

1167 } i‡(!
r˘x
->
Áûed
) {

1168 
	`ngx_πmp_ªc‹d_node_›í
(
s
, 
r˘x
);

1173 i‡((
ºacf
->
Êags
 & 
NGX_RTMP_RECORD_MANUAL
) &&

1174 (
	`ngx_föd_queue
(
rmcf
->
queue
, 
˘x
->
«me
) == 1))

1176 
	`ngx_πmp_ªc‹d_node_›í
(
s
, 
r˘x
);

1181 i‡((
ºacf
->
Êags
 & 
NGX_RTMP_RECORD_MANUAL
) &&

1182 !
brk‰ame
 && 
r˘x
->
n‰ames
 == 0)

1184  
NGX_OK
;

1187 i‡(
r˘x
->
fûe
.
fd
 =
NGX_INVALID_FILE
) {

1188  
NGX_OK
;

1191 i‡(
h
->
ty≥
 =
NGX_RTMP_MSG_AUDIO
 &&

1192 (
ºacf
->
Êags
 & 
NGX_RTMP_RECORD_AUDIO
) == 0)

1194  
NGX_OK
;

1197 i‡(
h
->
ty≥
 =
NGX_RTMP_MSG_VIDEO
 &&

1198 (
ºacf
->
Êags
 & 
NGX_RTMP_RECORD_VIDEO
) == 0 &&

1199 ((
ºacf
->
Êags
 & 
NGX_RTMP_RECORD_KEYFRAMES
Ë=0 || !
key‰ame
))

1201  
NGX_OK
;

1204 i‡(!
r˘x
->
öôülized
) {

1206 
r˘x
->
öôülized
 = 1;

1207 
r˘x
->
ïoch
 = 
h
->
time°amp
 -Ñ˘x->
time_shi·
;

1209 i‡(
r˘x
->
fûe
.
off£t
 == 0 &&

1210 
	`ngx_πmp_ªc‹d_wrôe_hódî
(&
r˘x
->
fûe
Ë!
NGX_OK
)

1212 
	`ngx_πmp_ªc‹d_node_˛o£
(
s
, 
r˘x
);

1213  
NGX_OK
;

1217 
codec_˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

1218 i‡(
codec_˘x
) {

1219 
ch
 = *
h
;

1222 i‡(!
r˘x
->
Øc_hódî_£¡
 && 
codec_˘x
->
Øc_hódî
 &&

1223 (
ºacf
->
Êags
 & 
NGX_RTMP_RECORD_AUDIO
))

1225 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1226 "ªc‹d: %V wrôög AAC hódî", &
ºacf
->
id
);

1228 
ch
.
ty≥
 = 
NGX_RTMP_MSG_AUDIO
;

1229 
ch
.
mÀn
 = 
	`ngx_πmp_ªc‹d_gë_chaö_mÀn
(
codec_˘x
->
Øc_hódî
);

1231 i‡(
	`ngx_πmp_ªc‹d_wrôe_‰ame
(
s
, 
r˘x
, &
ch
,

1232 
codec_˘x
->
Øc_hódî
, 0)

1233 !
NGX_OK
)

1235  
NGX_OK
;

1238 
r˘x
->
Øc_hódî_£¡
 = 1;

1242 i‡(!
r˘x
->
avc_hódî_£¡
 && 
codec_˘x
->
avc_hódî
 &&

1243 (
ºacf
->
Êags
 & (
NGX_RTMP_RECORD_VIDEO
|

1244 
NGX_RTMP_RECORD_KEYFRAMES
)))

1246 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1247 "ªc‹d: %V wrôög AVC hódî", &
ºacf
->
id
);

1249 
ch
.
ty≥
 = 
NGX_RTMP_MSG_VIDEO
;

1250 
ch
.
mÀn
 = 
	`ngx_πmp_ªc‹d_gë_chaö_mÀn
(
codec_˘x
->
avc_hódî
);

1252 i‡(
	`ngx_πmp_ªc‹d_wrôe_‰ame
(
s
, 
r˘x
, &
ch
,

1253 
codec_˘x
->
avc_hódî
, 0)

1254 !
NGX_OK
)

1256  
NGX_OK
;

1259 
r˘x
->
avc_hódî_£¡
 = 1;

1263 i‡(
h
->
ty≥
 =
NGX_RTMP_MSG_VIDEO
) {

1264 i‡(
codec_˘x
 && codec_˘x->
video_codec_id
 =
NGX_RTMP_VIDEO_H264
 &&

1265 !
r˘x
->
avc_hódî_£¡
)

1267 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1268 "ªc‹d: %V skùpög u¡û H264 hódî", &
ºacf
->
id
);

1269  
NGX_OK
;

1272 i‡(
	`ngx_πmp_gë_video_‰ame_ty≥
(
ö
Ë=
NGX_RTMP_VIDEO_KEY_FRAME
 &&

1273 ((
codec_˘x
 && codec_˘x->
video_codec_id
 !
NGX_RTMP_VIDEO_H264
) ||

1274 !
	`ngx_πmp_is_codec_hódî
(
ö
)))

1276 
r˘x
->
video_key_£¡
 = 1;

1279 i‡(!
r˘x
->
video_key_£¡
) {

1280 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1281 "ªc‹d: %V skùpög u¡û key‰ame", &
ºacf
->
id
);

1282  
NGX_OK
;

1286 i‡(
codec_˘x
 && codec_˘x->
audio_codec_id
 =
NGX_RTMP_AUDIO_AAC
 &&

1287 !
r˘x
->
Øc_hódî_£¡
)

1289 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1290 "ªc‹d: %V skùpög u¡û AAC hódî", &
ºacf
->
id
);

1291  
NGX_OK
;

1295  
	`ngx_πmp_ªc‹d_wrôe_‰ame
(
s
, 
r˘x
, 
h
, 
ö
, 1);

1296 
	}
}

1299 
ngx_öt_t


1300 
	$ngx_πmp_ªc‹d_d⁄e_öô
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_ªc‹d_d⁄e_t
 *
v
)

1302  
NGX_OK
;

1303 
	}
}

1307 
	$ngx_πmp_ªc‹d_ªc‹dî
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1309 *
rv
;

1310 
ngx_öt_t
 
i
;

1311 
ngx_°r_t
 *
vÆue
;

1312 
ngx_c⁄f_t
 
ßve
;

1313 
ngx_πmp_moduÀ_t
 *
moduÀ
;

1314 
ngx_πmp_c‹e_≠p_c⁄f_t
 *
ˇcf
, **
pˇcf
, *
rˇcf
;

1315 
ngx_πmp_ªc‹d_≠p_c⁄f_t
 *
øcf
, **
¥acf
, *
ºacf
;

1316 
ngx_πmp_c⁄f_˘x_t
 *
˘x
, *
p˘x
;

1318 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1320 
ˇcf
 = 
	`ngx_πmp_c⁄f_gë_moduÀ_≠p_c⁄f
(
cf
, 
ngx_πmp_c‹e_moduÀ
);

1322 
øcf
 = 
	`ngx_πmp_c⁄f_gë_moduÀ_≠p_c⁄f
(
cf
, 
ngx_πmp_ªc‹d_moduÀ
);

1324 
˘x
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_c⁄f_˘x_t
));

1325 i‡(
˘x
 =
NULL
) {

1326  
NGX_CONF_ERROR
;

1329 
p˘x
 = 
cf
->
˘x
;

1331 
˘x
->
maö_c⁄f
 = 
p˘x
->main_conf;

1332 
˘x
->
§v_c⁄f
 = 
p˘x
->srv_conf;

1334 
˘x
->
≠p_c⁄f
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (*Ë* 
ngx_πmp_max_moduÀ
);

1335 i‡(
˘x
->
≠p_c⁄f
 =
NULL
) {

1336  
NGX_CONF_ERROR
;

1339 
i
 = 0; 
ngx_moduÀs
[i]; i++) {

1340 i‡(
ngx_moduÀs
[
i
]->
ty≥
 !
NGX_RTMP_MODULE
) {

1344 
moduÀ
 = 
ngx_moduÀs
[
i
]->
˘x
;

1346 i‡(
moduÀ
->
¸óã_≠p_c⁄f
) {

1347 
˘x
->
≠p_c⁄f
[
ngx_moduÀs
[
i
]->
˘x_ödex
] =

1348 
moduÀ
->
	`¸óã_≠p_c⁄f
(
cf
);

1349 i‡(
˘x
->
≠p_c⁄f
[
ngx_moduÀs
[
i
]->
˘x_ödex
] =
NULL
) {

1350  
NGX_CONF_ERROR
;

1356 
rˇcf
 = 
˘x
->
≠p_c⁄f
[
ngx_πmp_c‹e_moduÀ
.
˘x_ödex
];

1357 
rˇcf
->
≠p_c⁄f
 = 
˘x
->app_conf;

1358 
pˇcf
 = 
	`ngx_¨øy_push
(&
ˇcf
->
≠∂iˇti⁄s
);

1359 i‡(
pˇcf
 =
NULL
) {

1360  
NGX_CONF_ERROR
;

1362 *
pˇcf
 = 
rˇcf
;

1365 
ºacf
 = 
˘x
->
≠p_c⁄f
[
ngx_πmp_ªc‹d_moduÀ
.
˘x_ödex
];

1366 
ºacf
->
ªc_c⁄f
 = 
˘x
->
≠p_c⁄f
;

1367 
¥acf
 = 
	`ngx_¨øy_push
(&
øcf
->
ªc
);

1368 i‡(
¥acf
 =
NULL
) {

1369  
NGX_CONF_ERROR
;

1371 *
¥acf
 = 
ºacf
;

1373 
ºacf
->
id
 = 
vÆue
[1];

1376 
ßve
 = *
cf
;

1377 
cf
->
˘x
 = ctx;

1378 
cf
->
cmd_ty≥
 = 
NGX_RTMP_REC_CONF
;

1380 
rv
 = 
	`ngx_c⁄f_∑r£
(
cf
, 
NULL
);

1381 *
cf

ßve
;

1383  
rv
;

1384 
	}
}

1387 
ngx_öt_t


1388 
	$ngx_πmp_ªc‹d_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
)

1390 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
;

1391 
ngx_πmp_h™dÀr_±
 *
h
;

1393 
ngx_πmp_ªc‹d_d⁄e
 = 
ngx_πmp_ªc‹d_d⁄e_öô
;

1395 
cmcf
 = 
	`ngx_πmp_c⁄f_gë_moduÀ_maö_c⁄f
(
cf
, 
ngx_πmp_c‹e_moduÀ
);

1397 
h
 = 
	`ngx_¨øy_push
(&
cmcf
->
evíts
[
NGX_RTMP_MSG_AUDIO
]);

1398 *
h
 = 
ngx_πmp_ªc‹d_av
;

1400 
h
 = 
	`ngx_¨øy_push
(&
cmcf
->
evíts
[
NGX_RTMP_MSG_VIDEO
]);

1401 *
h
 = 
ngx_πmp_ªc‹d_av
;

1403 
√xt_publish
 = 
ngx_πmp_publish
;

1404 
ngx_πmp_publish
 = 
ngx_πmp_ªc‹d_publish
;

1406 
√xt_˛o£_°ªam
 = 
ngx_πmp_˛o£_°ªam
;

1407 
ngx_πmp_˛o£_°ªam
 = 
ngx_πmp_ªc‹d_˛o£_°ªam
;

1409 
√xt_°ªam_begö
 = 
ngx_πmp_°ªam_begö
;

1410 
ngx_πmp_°ªam_begö
 = 
ngx_πmp_ªc‹d_°ªam_begö
;

1412 
√xt_°ªam_eof
 = 
ngx_πmp_°ªam_eof
;

1413 
ngx_πmp_°ªam_eof
 = 
ngx_πmp_ªc‹d_°ªam_eof
;

1415  
NGX_OK
;

1416 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_record_module.h

7 #i‚de‡
_NGX_RTMP_RECORD_H_INCLUDED_


8 
	#_NGX_RTMP_RECORD_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

13 
	~"ngx_πmp.h
"

16 
	#NGX_RTMP_RECORD_OFF
 0x01

	)

17 
	#NGX_RTMP_RECORD_AUDIO
 0x02

	)

18 
	#NGX_RTMP_RECORD_VIDEO
 0x04

	)

19 
	#NGX_RTMP_RECORD_KEYFRAMES
 0x08

	)

20 
	#NGX_RTMP_RECORD_MANUAL
 0x10

	)

25 
ngx_queue_t
 
	mque
;

26 
ngx_Êag_t
 
	mis_vÆid
;

27 
u_ch¨
 
	m°ªam_«me
[
NGX_RTMP_MAX_NAME
];

28 } 
	tngx_°ªam_öfo
;

31 
ngx_queue_t
 *
	mqueue
;

32 } 
	tngx_πmp_ªc‹d_maö_c⁄f_t
;

34 
ngx_πmp_ªc‹d_maö_c⁄f_t
 *
	gngx_πmp_ªc‹d_maö_c⁄f
;

36 
ngx_öt_t
 
ngx_föd_queue
(
ngx_queue_t
 *
queue
, 
u_ch¨
 *
«me
);

37 
ngx_queue_ö£π
(
ngx_queue_t
 *
queue
, 
ngx_°ªam_öfo
 *
tmp_öfo
);

38 
ngx_queue_ªmove_°©us
(
ngx_queue_t
 *
queue
, 
u_ch¨
 *
«me
);

39 
ngx_¥öt_queue
(
ngx_queue_t
 *
queue
);

43 
ngx_°r_t
 
	mid
;

44 
ngx_uöt_t
 
	mÊags
;

45 
ngx_°r_t
 
	m∑th
;

46 
size_t
 
	mmax_size
;

47 
size_t
 
	mmax_‰ames
;

48 
ngx_m£c_t
 
	möãrvÆ
;

49 
ngx_°r_t
 
	msuffix
;

50 
ngx_Êag_t
 
	munique
;

51 
ngx_Êag_t
 
	m≠≥nd
;

52 
ngx_Êag_t
 
	mlock_fûe
;

53 
ngx_Êag_t
 
	mnŸify
;

54 
ngx_uæ_t
 *
	muæ
;

56 **
	mªc_c⁄f
;

57 
ngx_¨øy_t
 
	mªc
;

58 } 
	tngx_πmp_ªc‹d_≠p_c⁄f_t
;

62 
ngx_πmp_ªc‹d_≠p_c⁄f_t
 *
	mc⁄f
;

63 
ngx_fûe_t
 
	mfûe
;

64 
ngx_uöt_t
 
	mn‰ames
;

65 
uöt32_t
 
	mïoch
, 
	mtime_shi·
;

66 
ngx_time_t
 
	mœ°
;

67 
time_t
 
	mtime°amp
;

68 
	mÁûed
:1;

69 
	möôülized
:1;

70 
	mØc_hódî_£¡
:1;

71 
	mavc_hódî_£¡
:1;

72 
	mvideo_key_£¡
:1;

73 
	maudio
:1;

74 
	mvideo
:1;

75 } 
	tngx_πmp_ªc‹d_ªc_˘x_t
;

79 
ngx_¨øy_t
 
	mªc
;

80 
u_ch¨
 
	m«me
[
NGX_RTMP_MAX_NAME
];

81 
u_ch¨
 
	m¨gs
[
NGX_RTMP_MAX_ARGS
];

82 
u_ch¨
 
	mliveid
[
NGX_RTMP_MAX_ARGS
];

83 } 
	tngx_πmp_ªc‹d_˘x_t
;

86 
ngx_uöt_t
 
ngx_πmp_ªc‹d_föd
(
ngx_πmp_ªc‹d_≠p_c⁄f_t
 *
øcf
,

87 
ngx_°r_t
 *
id
);

94 
ngx_öt_t
 
ngx_πmp_ªc‹d_›í
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_uöt_t
 
n
,

95 
ngx_°r_t
 *
∑th
);

96 
ngx_öt_t
 
ngx_πmp_ªc‹d_˛o£
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_uöt_t
 
n
,

97 
ngx_°r_t
 *
∑th
);

101 
ngx_°r_t
 
	mªc‹dî
;

102 
ngx_°r_t
 
	m∑th
;

103 } 
	tngx_πmp_ªc‹d_d⁄e_t
;

106 
	$ngx_öt_t
 (*
	tngx_πmp_ªc‹d_d⁄e_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

107 
	tngx_πmp_ªc‹d_d⁄e_t
 *
	tv
);

110 
ngx_πmp_ªc‹d_d⁄e_±
 
ngx_πmp_ªc‹d_d⁄e
;

113 
ngx_moduÀ_t
 
ngx_πmp_ªc‹d_moduÀ
;

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_relay_module.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp_ªœy_moduÀ.h
"

10 
	~"ngx_πmp_cmd_moduÀ.h
"

13 
ngx_πmp_publish_±
 
	g√xt_publish
;

14 
ngx_πmp_∂ay_±
 
	g√xt_∂ay
;

15 
ngx_πmp_dñëe_°ªam_±
 
	g√xt_dñëe_°ªam
;

16 
ngx_πmp_˛o£_°ªam_±
 
	g√xt_˛o£_°ªam
;

19 
ngx_öt_t
 
ngx_πmp_ªœy_öô_¥o˚ss
(
ngx_cy˛e_t
 *
cy˛e
);

20 
ngx_öt_t
 
ngx_πmp_ªœy_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
);

21 * 
ngx_πmp_ªœy_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
);

22 * 
ngx_πmp_ªœy_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
,

23 *
∑ª¡
, *
chûd
);

24 * 
ngx_πmp_ªœy_push_puŒ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
,

25 *
c⁄f
);

26 
ngx_öt_t
 
ngx_πmp_ªœy_publish
(
ngx_πmp_£ssi⁄_t
 *
s
,

27 
ngx_πmp_publish_t
 *
v
);

28 
ngx_πmp_ªœy_˘x_t
 * 
ngx_πmp_ªœy_¸óã_c⁄√˘i⁄
(

29 
ngx_πmp_c⁄f_˘x_t
 *
c˘x
, 
ngx_°r_t
* 
«me
,

30 
ngx_πmp_ªœy_èrgë_t
 *
èrgë
);

48 
ngx_¨øy_t
 
	mpuŒs
;

49 
ngx_¨øy_t
 
	mpushes
;

50 
ngx_¨øy_t
 
	m°©ic_puŒs
;

51 
ngx_¨øy_t
 
	m°©ic_evíts
;

52 
ngx_log_t
 *
	mlog
;

53 
ngx_uöt_t
 
	mnbuckës
;

54 
ngx_m£c_t
 
	mbuÊí
;

55 
ngx_Êag_t
 
	m£ssi⁄_ªœy
;

56 
ngx_m£c_t
 
	mpush_ªc⁄√˘
;

57 
ngx_m£c_t
 
	mpuŒ_ªc⁄√˘
;

58 
ngx_πmp_ªœy_˘x_t
 **
	m˘x
;

59 } 
	tngx_πmp_ªœy_≠p_c⁄f_t
;

63 
ngx_πmp_c⁄f_˘x_t
 
	mc˘x
;

64 
ngx_πmp_ªœy_èrgë_t
 *
	mèrgë
;

65 } 
	tngx_πmp_ªœy_°©ic_t
;

68 
	#NGX_RTMP_RELAY_CONNECT_TRANS
 1

	)

69 
	#NGX_RTMP_RELAY_CREATE_STREAM_TRANS
 2

	)

72 
	#NGX_RTMP_RELAY_CSID_AMF_INI
 3

	)

73 
	#NGX_RTMP_RELAY_CSID_AMF
 5

	)

74 
	#NGX_RTMP_RELAY_MSID
 1

	)

78 
	#NGX_RTMP_RELAY_FLASHVER
 "LNX.11,1,102,55"

	)

81 
ngx_comm™d_t
 
	gngx_πmp_ªœy_comm™ds
[] = {

83 { 
ngx_°rög
("push"),

84 
NGX_RTMP_APP_CONF
|
NGX_CONF_1MORE
,

85 
ngx_πmp_ªœy_push_puŒ
,

86 
NGX_RTMP_APP_CONF_OFFSET
,

88 
NULL
 },

90 { 
ngx_°rög
("pull"),

91 
NGX_RTMP_APP_CONF
|
NGX_CONF_1MORE
,

92 
ngx_πmp_ªœy_push_puŒ
,

93 
NGX_RTMP_APP_CONF_OFFSET
,

95 
NULL
 },

97 { 
ngx_°rög
("relay_buffer"),

98 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_CONF_TAKE1
,

99 
ngx_c⁄f_£t_m£c_¶Ÿ
,

100 
NGX_RTMP_APP_CONF_OFFSET
,

101 
off£tof
(
ngx_πmp_ªœy_≠p_c⁄f_t
, 
buÊí
),

102 
NULL
 },

104 { 
ngx_°rög
("push_reconnect"),

105 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

106 
ngx_c⁄f_£t_m£c_¶Ÿ
,

107 
NGX_RTMP_APP_CONF_OFFSET
,

108 
off£tof
(
ngx_πmp_ªœy_≠p_c⁄f_t
, 
push_ªc⁄√˘
),

109 
NULL
 },

111 { 
ngx_°rög
("pull_reconnect"),

112 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

113 
ngx_c⁄f_£t_m£c_¶Ÿ
,

114 
NGX_RTMP_APP_CONF_OFFSET
,

115 
off£tof
(
ngx_πmp_ªœy_≠p_c⁄f_t
, 
puŒ_ªc⁄√˘
),

116 
NULL
 },

118 { 
ngx_°rög
("session_relay"),

119 
NGX_RTMP_MAIN_CONF
|
NGX_RTMP_SRV_CONF
|
NGX_RTMP_APP_CONF
|
NGX_CONF_TAKE1
,

120 
ngx_c⁄f_£t_Êag_¶Ÿ
,

121 
NGX_RTMP_APP_CONF_OFFSET
,

122 
off£tof
(
ngx_πmp_ªœy_≠p_c⁄f_t
, 
£ssi⁄_ªœy
),

123 
NULL
 },

126 
ngx_nuŒ_comm™d


130 
ngx_πmp_moduÀ_t
 
	gngx_πmp_ªœy_moduÀ_˘x
 = {

131 
NULL
,

132 
ngx_πmp_ªœy_po°c⁄figuøti⁄
,

133 
NULL
,

134 
NULL
,

135 
NULL
,

136 
NULL
,

137 
ngx_πmp_ªœy_¸óã_≠p_c⁄f
,

138 
ngx_πmp_ªœy_mîge_≠p_c⁄f


142 
ngx_moduÀ_t
 
	gngx_πmp_ªœy_moduÀ
 = {

143 
NGX_MODULE_V1
,

144 &
ngx_πmp_ªœy_moduÀ_˘x
,

145 
ngx_πmp_ªœy_comm™ds
,

146 
NGX_RTMP_MODULE
,

147 
NULL
,

148 
NULL
,

149 
ngx_πmp_ªœy_öô_¥o˚ss
,

150 
NULL
,

151 
NULL
,

152 
NULL
,

153 
NULL
,

154 
NGX_MODULE_V1_PADDING


159 
	$ngx_πmp_ªœy_¸óã_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
)

161 
ngx_πmp_ªœy_≠p_c⁄f_t
 *
øcf
;

163 
øcf
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_ªœy_≠p_c⁄f_t
));

164 i‡(
øcf
 =
NULL
) {

165  
NULL
;

168 i‡(
	`ngx_¨øy_öô
(&
øcf
->
pushes
, 
cf
->
poﬁ
, 1, (*)Ë!
NGX_OK
) {

169  
NULL
;

172 i‡(
	`ngx_¨øy_öô
(&
øcf
->
puŒs
, 
cf
->
poﬁ
, 1, (*)Ë!
NGX_OK
) {

173  
NULL
;

176 i‡(
	`ngx_¨øy_öô
(&
øcf
->
°©ic_puŒs
, 
cf
->
poﬁ
, 1, (*))

177 !
NGX_OK
)

179  
NULL
;

182 i‡(
	`ngx_¨øy_öô
(&
øcf
->
°©ic_evíts
, 
cf
->
poﬁ
, 1, (*))

183 !
NGX_OK
)

185  
NULL
;

188 
øcf
->
nbuckës
 = 1024;

189 
øcf
->
log
 = &
cf
->
cy˛e
->
√w_log
;

190 
øcf
->
buÊí
 = 
NGX_CONF_UNSET_MSEC
;

191 
øcf
->
£ssi⁄_ªœy
 = 
NGX_CONF_UNSET
;

192 
øcf
->
push_ªc⁄√˘
 = 
NGX_CONF_UNSET_MSEC
;

193 
øcf
->
puŒ_ªc⁄√˘
 = 
NGX_CONF_UNSET_MSEC
;

195  
øcf
;

196 
	}
}

200 
	$ngx_πmp_ªœy_mîge_≠p_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
∑ª¡
, *
chûd
)

202 
ngx_πmp_ªœy_≠p_c⁄f_t
 *
¥ev
 = 
∑ª¡
;

203 
ngx_πmp_ªœy_≠p_c⁄f_t
 *
c⁄f
 = 
chûd
;

205 
c⁄f
->
˘x
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_ªœy_˘x_t
 *)

206 * 
c⁄f
->
nbuckës
);

208 
	`ngx_c⁄f_mîge_vÆue
(
c⁄f
->
£ssi⁄_ªœy
, 
¥ev
->session_relay, 0);

209 
	`ngx_c⁄f_mîge_m£c_vÆue
(
c⁄f
->
buÊí
, 
¥ev
->buflen, 5000);

210 
	`ngx_c⁄f_mîge_m£c_vÆue
(
c⁄f
->
push_ªc⁄√˘
, 
¥ev
->push_reconnect,

212 
	`ngx_c⁄f_mîge_m£c_vÆue
(
c⁄f
->
puŒ_ªc⁄√˘
, 
¥ev
->pull_reconnect,

215  
NGX_CONF_OK
;

216 
	}
}

220 
	$ngx_πmp_ªœy_°©ic_puŒ_ªc⁄√˘
(
ngx_evít_t
 *
ev
)

222 
ngx_πmp_ªœy_°©ic_t
 *
rs
 = 
ev
->
d©a
;

224 
ngx_πmp_ªœy_˘x_t
 *
˘x
;

225 
ngx_πmp_ªœy_≠p_c⁄f_t
 *
øcf
;

227 
øcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(&
rs
->
c˘x
, 
ngx_πmp_ªœy_moduÀ
);

229 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
øcf
->
log
, 0,

232 
˘x
 = 
	`ngx_πmp_ªœy_¸óã_c⁄√˘i⁄
(&
rs
->
c˘x
, &rs->
èrgë
->
«me
,

233 
rs
->
èrgë
);

234 i‡(
˘x
) {

235 
˘x
->
£ssi⁄
->
°©ic_ªœy
 = 1;

236 
˘x
->
°©ic_evt
 = 
ev
;

240 
	`ngx_add_timî
(
ev
, 
øcf
->
puŒ_ªc⁄√˘
);

241 
	}
}

245 
	$ngx_πmp_ªœy_push_ªc⁄√˘
(
ngx_evít_t
 *
ev
)

247 
ngx_πmp_£ssi⁄_t
 *
s
 = 
ev
->
d©a
;

249 
ngx_πmp_ªœy_≠p_c⁄f_t
 *
øcf
;

250 
ngx_πmp_ªœy_˘x_t
 *
˘x
, *
p˘x
;

251 
ngx_uöt_t
 
n
;

252 
ngx_πmp_ªœy_èrgë_t
 *
èrgë
, **
t
;

254 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

257 
øcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_ªœy_moduÀ
);

259 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªœy_moduÀ
);

260 i‡(
˘x
 =
NULL
) {

264 
t
 = 
øcf
->
pushes
.
ñts
;

265 
n
 = 0;Ç < 
øcf
->
pushes
.
√…s
; ++n, ++
t
) {

266 
èrgë
 = *
t
;

268 i‡(
èrgë
->
«me
.
Àn
 && (
˘x
->name.len !=Åarget->name.len ||

269 
	`ngx_memcmp
(
˘x
->
«me
.
d©a
, 
èrgë
->«me.d©a, ctx->«me.
Àn
)))

274 
p˘x
 = 
˘x
->
∂ay
;Ö˘x;Ö˘x =Ö˘x->
√xt
) {

275 i‡(
p˘x
->
èg
 =&
ngx_πmp_ªœy_moduÀ
 &&

276 
p˘x
->
d©a
 =
èrgë
)

282 i‡(
p˘x
) {

286 i‡(
	`ngx_πmp_ªœy_push
(
s
, &
˘x
->
«me
, 
èrgë
Ë=
NGX_OK
) {

290 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

293 &
˘x
->
«me
, &
èrgë
->
≠p
, &èrgë->
∂ay_∑th
,

294 &
èrgë
->
uæ
.url);

296 i‡(!
˘x
->
push_evt
.
timî_£t
) {

297 
	`ngx_add_timî
(&
˘x
->
push_evt
, 
øcf
->
push_ªc⁄√˘
);

300 
	}
}

303 
ngx_öt_t


304 
	$ngx_πmp_ªœy_gë_≥î
(
ngx_≥î_c⁄√˘i⁄_t
 *
pc
, *
d©a
)

306  
NGX_OK
;

307 
	}
}

311 
	$ngx_πmp_ªœy_‰ì_≥î
(
ngx_≥î_c⁄√˘i⁄_t
 *
pc
, *
d©a
,

312 
ngx_uöt_t
 
°©e
)

314 
	}
}

317 
	gngx_πmp_ªœy_˘x_t
 * (* 
	tngx_πmp_ªœy_¸óã_˘x_±
)

318 (
	tngx_πmp_£ssi⁄_t
 *
	ts
, 
	tngx_°r_t
 *
	t«me
, 
	tngx_πmp_ªœy_èrgë_t
 *
	tèrgë
);

321 
ngx_öt_t


322 
	$ngx_πmp_ªœy_c›y_°r
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_°r_t
 *
d°
,Çgx_°r_à*
§c
)

324 i‡(
§c
->
Àn
 == 0) {

325  
NGX_OK
;

327 
d°
->
Àn
 = 
§c
->len;

328 
d°
->
d©a
 = 
	`ngx_∑Œoc
(
poﬁ
, 
§c
->
Àn
);

329 i‡(
d°
->
d©a
 =
NULL
) {

330  
NGX_ERROR
;

332 
	`ngx_mem˝y
(
d°
->
d©a
, 
§c
->d©a, src->
Àn
);

333  
NGX_OK
;

334 
	}
}

337 
ngx_πmp_ªœy_˘x_t
 *

338 
	$ngx_πmp_ªœy_¸óã_c⁄√˘i⁄
(
ngx_πmp_c⁄f_˘x_t
 *
c˘x
, 
ngx_°r_t
* 
«me
,

339 
ngx_πmp_ªœy_èrgë_t
 *
èrgë
)

341 
ngx_πmp_ªœy_≠p_c⁄f_t
 *
øcf
;

342 
ngx_πmp_ªœy_˘x_t
 *
r˘x
;

343 
ngx_πmp_addr_c⁄f_t
 *
addr_c⁄f
;

344 
ngx_πmp_c⁄f_˘x_t
 *
addr_˘x
;

345 
ngx_πmp_£ssi⁄_t
 *
rs
;

346 
ngx_≥î_c⁄√˘i⁄_t
 *
pc
;

347 
ngx_c⁄√˘i⁄_t
 *
c
;

348 
ngx_addr_t
 *
addr
;

349 
ngx_poﬁ_t
 *
poﬁ
;

350 
ngx_öt_t
 
rc
;

351 
ngx_°r_t
 
v
, *
uri
;

352 
u_ch¨
 *
fú°
, *
œ°
, *
p
;

354 
øcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
c˘x
, 
ngx_πmp_ªœy_moduÀ
);

356 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
øcf
->
log
, 0,

359 
poﬁ
 = 
NULL
;

360 
poﬁ
 = 
	`ngx_¸óã_poﬁ
(4096, 
øcf
->
log
);

361 i‡(
poﬁ
 =
NULL
) {

362  
NULL
;

365 
r˘x
 = 
	`ngx_pˇŒoc
(
poﬁ
, (
ngx_πmp_ªœy_˘x_t
));

366 i‡(
r˘x
 =
NULL
) {

367 
˛ór
;

370 i‡(
«me
 && 
	`ngx_πmp_ªœy_c›y_°r
(
poﬁ
, &
r˘x
->«me,ÇameË!
NGX_OK
) {

371 
˛ór
;

374 i‡(
	`ngx_πmp_ªœy_c›y_°r
(
poﬁ
, &
r˘x
->
uæ
, &
èrgë
->uæ.uæË!
NGX_OK
) {

375 
˛ór
;

378 
r˘x
->
èg
 = 
èrgë
->tag;

379 
r˘x
->
d©a
 = 
èrgë
->data;

381 
	#NGX_RTMP_RELAY_STR_COPY
(
to
, 
‰om
) \

382 i‡(
	`ngx_πmp_ªœy_c›y_°r
(
poﬁ
, &
r˘x
->
to
, &
èrgë
->
‰om
Ë!
NGX_OK
) { \

383 
˛ór
; \

384 }

	)

386 
	`NGX_RTMP_RELAY_STR_COPY
(
≠p
,ápp);

387 
	`NGX_RTMP_RELAY_STR_COPY
(
tc_uæ
,Åc_url);

388 
	`NGX_RTMP_RELAY_STR_COPY
(
∑ge_uæ
,Öage_url);

389 
	`NGX_RTMP_RELAY_STR_COPY
(
swf_uæ
, swf_url);

390 
	`NGX_RTMP_RELAY_STR_COPY
(
Êash_vî
, flash_ver);

391 
	`NGX_RTMP_RELAY_STR_COPY
(
∂ay_∑th
,Ölay_path);

393 
r˘x
->
live
 = 
èrgë
->live;

394 
r˘x
->
°¨t
 = 
èrgë
->start;

395 
r˘x
->
°›
 = 
èrgë
->stop;

397 #unde‡
NGX_RTMP_RELAY_STR_COPY


399 i‡(
r˘x
->
≠p
.
Àn
 =0 ||Ñ˘x->
∂ay_∑th
.len == 0) {

401 
uri
 = &
èrgë
->
uæ
.uri;

402 
fú°
 = 
uri
->
d©a
;

403 
œ°
 = 
uri
->
d©a
 + uri->
Àn
;

404 i‡(
fú°
 !
œ°
 && *first == '/') {

405 ++
fú°
;

408 i‡(
fú°
 !
œ°
) {

411 
p
 = 
	`ngx_°æchr
(
fú°
, 
œ°
, '/');

412 i‡(
p
 =
NULL
) {

413 
p
 = 
œ°
;

416 i‡(
r˘x
->
≠p
.
Àn
 =0 && 
fú°
 !
p
) {

417 
v
.
d©a
 = 
fú°
;

418 
v
.
Àn
 = 
p
 - 
fú°
;

419 i‡(
	`ngx_πmp_ªœy_c›y_°r
(
poﬁ
, &
r˘x
->
≠p
, &
v
Ë!
NGX_OK
) {

420 
˛ór
;

425 i‡(
p
 !
œ°
) {

426 ++
p
;

429 i‡(
r˘x
->
∂ay_∑th
.
Àn
 =0 && 
p
 !
œ°
) {

430 
v
.
d©a
 = 
p
;

431 
v
.
Àn
 = 
œ°
 - 
p
;

432 i‡(
	`ngx_πmp_ªœy_c›y_°r
(
poﬁ
, &
r˘x
->
∂ay_∑th
, &
v
)

433 !
NGX_OK
)

435 
˛ór
;

441 
pc
 = 
	`ngx_pˇŒoc
(
poﬁ
, (
ngx_≥î_c⁄√˘i⁄_t
));

442 i‡(
pc
 =
NULL
) {

443 
˛ór
;

446 i‡(
èrgë
->
uæ
.
«ddrs
 == 0) {

447 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
øcf
->
log
, 0,

449 
˛ór
;

453 
addr
 = &
èrgë
->
uæ
.
addrs
[èrgë->
cou¡î
 %Å¨gë->uæ.
«ddrs
];

454 
èrgë
->
cou¡î
++;

457 
r˘x
->
log
 = *
øcf
->log;

458 
pc
->
log
 = &
r˘x
->log;

459 
pc
->
gë
 = 
ngx_πmp_ªœy_gë_≥î
;

460 
pc
->
‰ì
 = 
ngx_πmp_ªœy_‰ì_≥î
;

461 
pc
->
«me
 = &
addr
->name;

462 
pc
->
sockÀn
 = 
addr
->socklen;

463 
pc
->
sockaddr
 = (sockadd∏*)
	`ngx_∑Œoc
(
poﬁ
,Öc->
sockÀn
);

464 i‡(
pc
->
sockaddr
 =
NULL
) {

465 
˛ór
;

467 
	`ngx_mem˝y
(
pc
->
sockaddr
, 
addr
->sockaddr,Öc->
sockÀn
);

469 
rc
 = 
	`ngx_evít_c⁄√˘_≥î
(
pc
);

470 i‡(
rc
 !
NGX_OK
 &&Ñ¯!
NGX_AGAIN
 ) {

471 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
øcf
->
log
, 0,

473 
˛ór
;

475 
c
 = 
pc
->
c⁄√˘i⁄
;

476 
c
->
poﬁ
 =Öool;

477 
c
->
addr_ãxt
 = 
r˘x
->
uæ
;

479 
addr_c⁄f
 = 
	`ngx_pˇŒoc
(
poﬁ
, (
ngx_πmp_addr_c⁄f_t
));

480 i‡(
addr_c⁄f
 =
NULL
) {

481 
˛ór
;

483 
addr_˘x
 = 
	`ngx_pˇŒoc
(
poﬁ
, (
ngx_πmp_c⁄f_˘x_t
));

484 i‡(
addr_˘x
 =
NULL
) {

485 
˛ór
;

487 
addr_c⁄f
->
˘x
 = 
addr_˘x
;

488 
addr_˘x
->
maö_c⁄f
 = 
c˘x
->main_conf;

489 
addr_˘x
->
§v_c⁄f
 = 
c˘x
->srv_conf;

490 
	`ngx_°r_£t
(&
addr_c⁄f
->
addr_ãxt
, "ngx-relay");

492 
rs
 = 
	`ngx_πmp_öô_£ssi⁄
(
c
, 
addr_c⁄f
);

493 i‡(
rs
 =
NULL
) {

495  
NULL
;

497 
rs
->
≠p_c⁄f
 = 
c˘x
->app_conf;

498 
rs
->
ªœy
 = 1;

499 
r˘x
->
£ssi⁄
 = 
rs
;

500 
	`ngx_πmp_£t_˘x
(
rs
, 
r˘x
, 
ngx_πmp_ªœy_moduÀ
);

501 
	`ngx_°r_£t
(&
rs
->
Êashvî
, "ngx-local-relay");

503 #i‡(
NGX_STAT_STUB
)

504 (Ë
	`ngx_©omic_„tch_add
(
ngx_°©_a˘ive
, 1);

507 
	`ngx_πmp_˛õ¡_h™dshake
(
rs
, 1);

508  
r˘x
;

510 
˛ór
:

511 i‡(
poﬁ
) {

512 
	`ngx_de°roy_poﬁ
(
poﬁ
);

514  
NULL
;

515 
	}
}

518 
ngx_πmp_ªœy_˘x_t
 *

519 
	$ngx_πmp_ªœy_¸óã_ªmŸe_˘x
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_°r_t
* 
«me
,

520 
ngx_πmp_ªœy_èrgë_t
 *
èrgë
)

522 
ngx_πmp_c⁄f_˘x_t
 
c˘x
;

524 
c˘x
.
≠p_c⁄f
 = 
s
->app_conf;

525 
c˘x
.
§v_c⁄f
 = 
s
->srv_conf;

526 
c˘x
.
maö_c⁄f
 = 
s
->main_conf;

528  
	`ngx_πmp_ªœy_¸óã_c⁄√˘i⁄
(&
c˘x
, 
«me
, 
èrgë
);

529 
	}
}

532 
ngx_πmp_ªœy_˘x_t
 *

533 
	$ngx_πmp_ªœy_¸óã_loˇl_˘x
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_°r_t
 *
«me
,

534 
ngx_πmp_ªœy_èrgë_t
 *
èrgë
)

536 
ngx_πmp_ªœy_˘x_t
 *
˘x
;

538 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

541 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªœy_moduÀ
);

542 i‡(
˘x
 =
NULL
) {

543 
˘x
 = 
	`ngx_pˇŒoc
(
s
->
c⁄√˘i⁄
->
poﬁ
, (
ngx_πmp_ªœy_˘x_t
));

544 i‡(
˘x
 =
NULL
) {

545  
NULL
;

547 
	`ngx_πmp_£t_˘x
(
s
, 
˘x
, 
ngx_πmp_ªœy_moduÀ
);

549 
˘x
->
£ssi⁄
 = 
s
;

551 
˘x
->
push_evt
.
d©a
 = 
s
;

552 
˘x
->
push_evt
.
log
 = 
s
->
c⁄√˘i⁄
->log;

553 
˘x
->
push_evt
.
h™dÀr
 = 
ngx_πmp_ªœy_push_ªc⁄√˘
;

555 i‡(
˘x
->
publish
) {

556  
NULL
;

559 i‡(
	`ngx_πmp_ªœy_c›y_°r
(
s
->
c⁄√˘i⁄
->
poﬁ
, &
˘x
->
«me
,Çame)

560 !
NGX_OK
)

562  
NULL
;

565  
˘x
;

566 
	}
}

569 
ngx_öt_t


570 
	$ngx_πmp_ªœy_¸óã
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_°r_t
 *
«me
,

571 
ngx_πmp_ªœy_èrgë_t
 *
èrgë
,

572 
ngx_πmp_ªœy_¸óã_˘x_±
 
¸óã_publish_˘x
,

573 
ngx_πmp_ªœy_¸óã_˘x_±
 
¸óã_∂ay_˘x
)

575 
ngx_πmp_ªœy_≠p_c⁄f_t
 *
øcf
;

576 
ngx_πmp_ªœy_˘x_t
 *
publish_˘x
, *
∂ay_˘x
, **
c˘x
;

577 
ngx_uöt_t
 
hash
;

580 
øcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_ªœy_moduÀ
);

581 i‡(
øcf
 =
NULL
) {

582  
NGX_ERROR
;

585 
∂ay_˘x
 = 
	`¸óã_∂ay_˘x
(
s
, 
«me
, 
èrgë
);

586 i‡(
∂ay_˘x
 =
NULL
) {

587  
NGX_ERROR
;

590 
hash
 = 
	`ngx_hash_key
(
«me
->
d©a
,Çame->
Àn
);

591 
c˘x
 = &
øcf
->
˘x
[
hash
 %Ñacf->
nbuckës
];

592 ; *
c˘x
; c˘x = &(*c˘x)->
√xt
) {

593 i‡((*
c˘x
)->
«me
.
Àn
 ==Çame->len

594 && !
	`ngx_memcmp
(
«me
->
d©a
, (*
c˘x
)->name.data,

595 
«me
->
Àn
))

601 i‡(*
c˘x
) {

602 
∂ay_˘x
->
publish
 = (*
c˘x
)->publish;

603 
∂ay_˘x
->
√xt
 = (*
c˘x
)->
∂ay
;

604 (*
c˘x
)->
∂ay
 = 
∂ay_˘x
;

605  
NGX_OK
;

608 
publish_˘x
 = 
	`¸óã_publish_˘x
(
s
, 
«me
, 
èrgë
);

609 i‡(
publish_˘x
 =
NULL
) {

610 
	`ngx_πmp_föÆize_£ssi⁄
(
∂ay_˘x
->
£ssi⁄
);

611  
NGX_ERROR
;

614 
publish_˘x
->
publish
 =Öublish_ctx;

615 
publish_˘x
->
∂ay
 = 
∂ay_˘x
;

616 
∂ay_˘x
->
publish
 = 
publish_˘x
;

617 *
c˘x
 = 
publish_˘x
;

619  
NGX_OK
;

620 
	}
}

623 
ngx_öt_t


624 
	$ngx_πmp_ªœy_puŒ
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_°r_t
 *
«me
,

625 
ngx_πmp_ªœy_èrgë_t
 *
èrgë
)

627 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

629 
«me
, &
èrgë
->
≠p
, &èrgë->
∂ay_∑th
, &èrgë->
uæ
.url);

631  
	`ngx_πmp_ªœy_¸óã
(
s
, 
«me
, 
èrgë
,

632 
ngx_πmp_ªœy_¸óã_ªmŸe_˘x
,

633 
ngx_πmp_ªœy_¸óã_loˇl_˘x
);

634 
	}
}

637 
ngx_öt_t


638 
	$ngx_πmp_ªœy_push
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_°r_t
 *
«me
,

639 
ngx_πmp_ªœy_èrgë_t
 *
èrgë
)

641 
	`ngx_log_îr‹
(
NGX_LOG_INFO
, 
s
->
c⁄√˘i⁄
->
log
, 0,

643 
«me
, &
èrgë
->
≠p
, &èrgë->
∂ay_∑th
, &èrgë->
uæ
.url);

645  
	`ngx_πmp_ªœy_¸óã
(
s
, 
«me
, 
èrgë
,

646 
ngx_πmp_ªœy_¸óã_loˇl_˘x
,

647 
ngx_πmp_ªœy_¸óã_ªmŸe_˘x
);

648 
	}
}

651 
ngx_öt_t


652 
	$ngx_πmp_ªœy_publish
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_publish_t
 *
v
)

654 
ngx_πmp_ªœy_≠p_c⁄f_t
 *
øcf
;

655 
ngx_πmp_ªœy_èrgë_t
 *
èrgë
, **
t
;

656 
ngx_°r_t
 
«me
;

657 
size_t
 
n
;

658 
ngx_πmp_ªœy_˘x_t
 *
˘x
;

660 i‡(
s
->
auto_pushed
) {

661 
√xt
;

664 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªœy_moduÀ
);

665 i‡(
˘x
 && 
s
->
ªœy
) {

666 
√xt
;

669 
øcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_ªœy_moduÀ
);

670 i‡(
øcf
 =
NULL
 ||Ñacf->
pushes
.
√…s
 == 0) {

671 
√xt
;

674 
«me
.
Àn
 = 
	`ngx_°æí
(
v
->name);

675 
«me
.
d©a
 = 
v
->name;

677 
t
 = 
øcf
->
pushes
.
ñts
;

678 
n
 = 0;Ç < 
øcf
->
pushes
.
√…s
; ++n, ++
t
) {

679 
èrgë
 = *
t
;

681 i‡(
èrgë
->
«me
.
Àn
 && (name.len !=Åarget->name.len ||

682 
	`ngx_memcmp
(
«me
.
d©a
, 
èrgë
->«me.d©a,Çame.
Àn
)))

687 i‡(
	`ngx_πmp_ªœy_push
(
s
, &
«me
, 
èrgë
Ë=
NGX_OK
) {

691 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

694 &
«me
, &
èrgë
->
≠p
, &èrgë->
∂ay_∑th
,

695 &
èrgë
->
uæ
.url);

697 i‡(!
˘x
->
push_evt
.
timî_£t
) {

698 
	`ngx_add_timî
(&
˘x
->
push_evt
, 
øcf
->
push_ªc⁄√˘
);

702 
√xt
:

703  
	`√xt_publish
(
s
, 
v
);

704 
	}
}

707 
ngx_öt_t


708 
	$ngx_πmp_ªœy_∂ay
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_∂ay_t
 *
v
)

710 
ngx_πmp_ªœy_≠p_c⁄f_t
 *
øcf
;

711 
ngx_πmp_ªœy_èrgë_t
 *
èrgë
, **
t
;

712 
ngx_°r_t
 
«me
;

713 
size_t
 
n
;

714 
ngx_πmp_ªœy_˘x_t
 *
˘x
;

716 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªœy_moduÀ
);

717 i‡(
˘x
 && 
s
->
ªœy
) {

718 
√xt
;

721 
øcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_ªœy_moduÀ
);

722 i‡(
øcf
 =
NULL
 ||Ñacf->
puŒs
.
√…s
 == 0) {

723 
√xt
;

726 
«me
.
Àn
 = 
	`ngx_°æí
(
v
->name);

727 
«me
.
d©a
 = 
v
->name;

729 
t
 = 
øcf
->
puŒs
.
ñts
;

730 
n
 = 0;Ç < 
øcf
->
puŒs
.
√…s
; ++n, ++
t
) {

731 
èrgë
 = *
t
;

733 i‡(
èrgë
->
«me
.
Àn
 && (name.len !=Åarget->name.len ||

734 
	`ngx_memcmp
(
«me
.
d©a
, 
èrgë
->«me.d©a,Çame.
Àn
)))

739 i‡(
	`ngx_πmp_ªœy_puŒ
(
s
, &
«me
, 
èrgë
Ë=
NGX_OK
) {

743 
	`ngx_log_îr‹
(
NGX_LOG_ERR
, 
s
->
c⁄√˘i⁄
->
log
, 0,

746 &
«me
, &
èrgë
->
≠p
, &èrgë->
∂ay_∑th
,

747 &
èrgë
->
uæ
.url);

750 
√xt
:

751  
	`√xt_∂ay
(
s
, 
v
);

752 
	}
}

755 
ngx_öt_t


756 
	$ngx_πmp_ªœy_∂ay_loˇl
(
ngx_πmp_£ssi⁄_t
 *
s
)

758 
ngx_πmp_∂ay_t
 
v
;

759 
ngx_πmp_ªœy_˘x_t
 *
˘x
;

761 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªœy_moduÀ
);

762 i‡(
˘x
 =
NULL
) {

763  
NGX_ERROR
;

766 
	`ngx_memzîo
(&
v
, (
ngx_πmp_∂ay_t
));

767 
v
.
sûít
 = 1;

768 *(
	`ngx_˝ymem
(
v
.
«me
, 
˘x
->«me.
d©a
,

769 
	`ngx_mö
((
v
.
«me
Ë- 1, 
˘x
->«me.
Àn
))) = 0;

771  
	`ngx_πmp_∂ay
(
s
, &
v
);

772 
	}
}

775 
ngx_öt_t


776 
	$ngx_πmp_ªœy_publish_loˇl
(
ngx_πmp_£ssi⁄_t
 *
s
)

778 
ngx_πmp_publish_t
 
v
;

779 
ngx_πmp_ªœy_˘x_t
 *
˘x
;

781 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªœy_moduÀ
);

782 i‡(
˘x
 =
NULL
) {

783  
NGX_ERROR
;

786 
	`ngx_memzîo
(&
v
, (
ngx_πmp_publish_t
));

787 
v
.
sûít
 = 1;

788 *(
	`ngx_˝ymem
(
v
.
«me
, 
˘x
->«me.
d©a
,

789 
	`ngx_mö
((
v
.
«me
Ë- 1, 
˘x
->«me.
Àn
))) = 0;

791  
	`ngx_πmp_publish
(
s
, &
v
);

792 
	}
}

795 
ngx_öt_t


796 
	$ngx_πmp_ªœy_£nd_c⁄√˘
(
ngx_πmp_£ssi⁄_t
 *
s
)

798 
å™s
 = 
NGX_RTMP_RELAY_CONNECT_TRANS
;

799 
acodecs
 = 3575;

800 
vcodecs
 = 252;

802 
ngx_πmp_amf_ñt_t
 
out_cmd
[] = {

804 { 
NGX_RTMP_AMF_STRING
,

805 
	`ngx_°rög
("app"),

806 
NULL
, 0 },

808 { 
NGX_RTMP_AMF_STRING
,

809 
	`ngx_°rög
("tcUrl"),

810 
NULL
, 0 },

812 { 
NGX_RTMP_AMF_STRING
,

813 
	`ngx_°rög
("pageUrl"),

814 
NULL
, 0 },

816 { 
NGX_RTMP_AMF_STRING
,

817 
	`ngx_°rög
("swfUrl"),

818 
NULL
, 0 },

820 { 
NGX_RTMP_AMF_STRING
,

821 
	`ngx_°rög
("flashVer"),

822 
NULL
, 0 },

824 { 
NGX_RTMP_AMF_NUMBER
,

825 
	`ngx_°rög
("audioCodecs"),

826 &
acodecs
, 0 },

828 { 
NGX_RTMP_AMF_NUMBER
,

829 
	`ngx_°rög
("videoCodecs"),

830 &
vcodecs
, 0 }

833 
ngx_πmp_amf_ñt_t
 
out_ñts
[] = {

835 { 
NGX_RTMP_AMF_STRING
,

836 
ngx_nuŒ_°rög
,

839 { 
NGX_RTMP_AMF_NUMBER
,

840 
ngx_nuŒ_°rög
,

841 &
å™s
, 0 },

843 { 
NGX_RTMP_AMF_OBJECT
,

844 
ngx_nuŒ_°rög
,

845 
out_cmd
, (out_cmd) }

848 
ngx_πmp_c‹e_≠p_c⁄f_t
 *
ˇcf
;

849 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

850 
ngx_πmp_ªœy_˘x_t
 *
˘x
;

851 
ngx_πmp_hódî_t
 
h
;

852 
size_t
 
Àn
, 
uæ_Àn
;

853 
u_ch¨
 *
p
, *
uæ_íd
;

856 
ˇcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

857 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

858 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªœy_moduÀ
);

859 i‡(
ˇcf
 =
NULL
 || 
˘x
 == NULL) {

860  
NGX_ERROR
;

864 i‡(
˘x
->
≠p
.
Àn
) {

865 
out_cmd
[0].
d©a
 = 
˘x
->
≠p
.data;

866 
out_cmd
[0].
Àn
 = 
˘x
->
≠p
.len;

868 
out_cmd
[0].
d©a
 = 
ˇcf
->
«me
.data;

869 
out_cmd
[0].
Àn
 = 
ˇcf
->
«me
.len;

873 i‡(
˘x
->
tc_uæ
.
Àn
) {

874 
out_cmd
[1].
d©a
 = 
˘x
->
tc_uæ
.data;

875 
out_cmd
[1].
Àn
 = 
˘x
->
tc_uæ
.len;

877 
Àn
 = ("πmp://"Ë- 1 + 
˘x
->
uæ
.len +

878 ("/"Ë- 1 + 
˘x
->
≠p
.
Àn
;

879 
p
 = 
	`ngx_∑Œoc
(
s
->
c⁄√˘i⁄
->
poﬁ
, 
Àn
);

880 i‡(
p
 =
NULL
) {

881  
NGX_ERROR
;

883 
out_cmd
[1].
d©a
 = 
p
;

884 
p
 = 
	`ngx_˝ymem
(p, "rtmp://", ("rtmp://") - 1);

886 
uæ_Àn
 = 
˘x
->
uæ
.
Àn
;

887 
uæ_íd
 = 
	`ngx_°æchr
(
˘x
->
uæ
.
d©a
, ctx->uæ.d©®+ ctx->uæ.
Àn
, '/');

888 i‡(
uæ_íd
) {

889 
uæ_Àn
 = (
size_t
Ë(
uæ_íd
 - 
˘x
->
uæ
.
d©a
);

892 
p
 = 
	`ngx_˝ymem
’, 
˘x
->
uæ
.
d©a
, 
uæ_Àn
);

893 *
p
++ = '/';

894 
p
 = 
	`ngx_˝ymem
’, 
˘x
->
≠p
.
d©a
, ctx->≠p.
Àn
);

895 
out_cmd
[1].
Àn
 = 
p
 - (
u_ch¨
 *)out_cmd[1].
d©a
;

899 
out_cmd
[2].
d©a
 = 
˘x
->
∑ge_uæ
.data;

900 
out_cmd
[2].
Àn
 = 
˘x
->
∑ge_uæ
.len;

903 
out_cmd
[3].
d©a
 = 
˘x
->
swf_uæ
.data;

904 
out_cmd
[3].
Àn
 = 
˘x
->
swf_uæ
.len;

907 i‡(
˘x
->
Êash_vî
.
Àn
) {

908 
out_cmd
[4].
d©a
 = 
˘x
->
Êash_vî
.data;

909 
out_cmd
[4].
Àn
 = 
˘x
->
Êash_vî
.len;

911 
out_cmd
[4].
d©a
 = 
NGX_RTMP_RELAY_FLASHVER
;

912 
out_cmd
[4].
Àn
 = (
NGX_RTMP_RELAY_FLASHVER
) - 1;

915 
	`ngx_memzîo
(&
h
, (h));

916 
h
.
csid
 = 
NGX_RTMP_RELAY_CSID_AMF_INI
;

917 
h
.
ty≥
 = 
NGX_RTMP_MSG_AMF_CMD
;

919  
	`ngx_πmp_£nd_chunk_size
(
s
, 
cscf
->
chunk_size
Ë!
NGX_OK


920 || 
	`ngx_πmp_£nd_ack_size
(
s
, 
cscf
->
ack_wödow
Ë!
NGX_OK


921 || 
	`ngx_πmp_£nd_amf
(
s
, &
h
, 
out_ñts
,

922 (
out_ñts
Ë/ (out_ñts[0])Ë!
NGX_OK


923 ? 
NGX_ERROR


924 : 
NGX_OK
;

925 
	}
}

928 
ngx_öt_t


929 
	$ngx_πmp_ªœy_£nd_¸óã_°ªam
(
ngx_πmp_£ssi⁄_t
 *
s
)

931 
å™s
 = 
NGX_RTMP_RELAY_CREATE_STREAM_TRANS
;

933 
ngx_πmp_amf_ñt_t
 
out_ñts
[] = {

935 { 
NGX_RTMP_AMF_STRING
,

936 
ngx_nuŒ_°rög
,

939 { 
NGX_RTMP_AMF_NUMBER
,

940 
ngx_nuŒ_°rög
,

941 &
å™s
, 0 },

943 { 
NGX_RTMP_AMF_NULL
,

944 
ngx_nuŒ_°rög
,

945 
NULL
, 0 }

948 
ngx_πmp_hódî_t
 
h
;

951 
	`ngx_memzîo
(&
h
, (h));

952 
h
.
csid
 = 
NGX_RTMP_RELAY_CSID_AMF_INI
;

953 
h
.
ty≥
 = 
NGX_RTMP_MSG_AMF_CMD
;

955  
	`ngx_πmp_£nd_amf
(
s
, &
h
, 
out_ñts
,

956 (
out_ñts
) / (out_elts[0]));

957 
	}
}

960 
ngx_öt_t


961 
	$ngx_πmp_ªœy_£nd_publish
(
ngx_πmp_£ssi⁄_t
 *
s
)

963 
å™s
;

965 
ngx_πmp_amf_ñt_t
 
out_ñts
[] = {

967 { 
NGX_RTMP_AMF_STRING
,

968 
ngx_nuŒ_°rög
,

971 { 
NGX_RTMP_AMF_NUMBER
,

972 
ngx_nuŒ_°rög
,

973 &
å™s
, 0 },

975 { 
NGX_RTMP_AMF_NULL
,

976 
ngx_nuŒ_°rög
,

977 
NULL
, 0 },

979 { 
NGX_RTMP_AMF_STRING
,

980 
ngx_nuŒ_°rög
,

981 
NULL
, 0 },

983 { 
NGX_RTMP_AMF_STRING
,

984 
ngx_nuŒ_°rög
,

988 
ngx_πmp_hódî_t
 
h
;

989 
ngx_πmp_ªœy_˘x_t
 *
˘x
;

992 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªœy_moduÀ
);

993 i‡(
˘x
 =
NULL
) {

994  
NGX_ERROR
;

997 i‡(
˘x
->
∂ay_∑th
.
Àn
) {

998 
out_ñts
[3].
d©a
 = 
˘x
->
∂ay_∑th
.data;

999 
out_ñts
[3].
Àn
 = 
˘x
->
∂ay_∑th
.len;

1001 
out_ñts
[3].
d©a
 = 
˘x
->
«me
.data;

1002 
out_ñts
[3].
Àn
 = 
˘x
->
«me
.len;

1005 
	`ngx_memzîo
(&
h
, (h));

1006 
h
.
csid
 = 
NGX_RTMP_RELAY_CSID_AMF
;

1007 
h
.
msid
 = 
NGX_RTMP_RELAY_MSID
;

1008 
h
.
ty≥
 = 
NGX_RTMP_MSG_AMF_CMD
;

1010  
	`ngx_πmp_£nd_amf
(
s
, &
h
, 
out_ñts
,

1011 (
out_ñts
) / (out_elts[0]));

1012 
	}
}

1015 
ngx_öt_t


1016 
	$ngx_πmp_ªœy_£nd_∂ay
(
ngx_πmp_£ssi⁄_t
 *
s
)

1018 
å™s
;

1019 
°¨t
, 
duøti⁄
;

1021 
ngx_πmp_amf_ñt_t
 
out_ñts
[] = {

1023 { 
NGX_RTMP_AMF_STRING
,

1024 
ngx_nuŒ_°rög
,

1027 { 
NGX_RTMP_AMF_NUMBER
,

1028 
ngx_nuŒ_°rög
,

1029 &
å™s
, 0 },

1031 { 
NGX_RTMP_AMF_NULL
,

1032 
ngx_nuŒ_°rög
,

1033 
NULL
, 0 },

1035 { 
NGX_RTMP_AMF_STRING
,

1036 
ngx_nuŒ_°rög
,

1037 
NULL
, 0 },

1039 { 
NGX_RTMP_AMF_NUMBER
,

1040 
ngx_nuŒ_°rög
,

1041 &
°¨t
, 0 },

1043 { 
NGX_RTMP_AMF_NUMBER
,

1044 
ngx_nuŒ_°rög
,

1045 &
duøti⁄
, 0 },

1048 
ngx_πmp_hódî_t
 
h
;

1049 
ngx_πmp_ªœy_˘x_t
 *
˘x
;

1050 
ngx_πmp_ªœy_≠p_c⁄f_t
 *
øcf
;

1053 
øcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_ªœy_moduÀ
);

1054 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªœy_moduÀ
);

1055 i‡(
øcf
 =
NULL
 || 
˘x
 == NULL) {

1056  
NGX_ERROR
;

1059 i‡(
˘x
->
∂ay_∑th
.
Àn
) {

1060 
out_ñts
[3].
d©a
 = 
˘x
->
∂ay_∑th
.data;

1061 
out_ñts
[3].
Àn
 = 
˘x
->
∂ay_∑th
.len;

1063 
out_ñts
[3].
d©a
 = 
˘x
->
«me
.data;

1064 
out_ñts
[3].
Àn
 = 
˘x
->
«me
.len;

1067 i‡(
˘x
->
live
) {

1068 
°¨t
 = -1000;

1069 
duøti⁄
 = -1000;

1071 
°¨t
 = (
˘x
->start ? ctx->start : -2000);

1072 
duøti⁄
 = (
˘x
->
°›
 ? ctx->°› - ctx->
°¨t
 : -1000);

1075 
	`ngx_memzîo
(&
h
, (h));

1076 
h
.
csid
 = 
NGX_RTMP_RELAY_CSID_AMF
;

1077 
h
.
msid
 = 
NGX_RTMP_RELAY_MSID
;

1078 
h
.
ty≥
 = 
NGX_RTMP_MSG_AMF_CMD
;

1080  
	`ngx_πmp_£nd_amf
(
s
, &
h
, 
out_ñts
,

1081 (
out_ñts
Ë/ (out_ñts[0])Ë!
NGX_OK


1082 || 
	`ngx_πmp_£nd_£t_buÊí
(
s
, 
NGX_RTMP_RELAY_MSID
,

1083 
øcf
->
buÊí
Ë!
NGX_OK


1084 ? 
NGX_ERROR


1085 : 
NGX_OK
;

1086 
	}
}

1089 
ngx_öt_t


1090 
	$ngx_πmp_ªœy_⁄_ªsu…
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

1091 
ngx_chaö_t
 *
ö
)

1093 
ngx_πmp_ªœy_˘x_t
 *
˘x
;

1095 
å™s
;

1096 
u_ch¨
 
Àvñ
[32];

1097 
u_ch¨
 
code
[128];

1098 
u_ch¨
 
desc
[1024];

1099 } 
v
;

1101 
ngx_πmp_amf_ñt_t
 
ö_öf
[] = {

1103 { 
NGX_RTMP_AMF_STRING
,

1104 
	`ngx_°rög
("level"),

1105 &
v
.
Àvñ
, (v.level) },

1107 { 
NGX_RTMP_AMF_STRING
,

1108 
	`ngx_°rög
("code"),

1109 &
v
.
code
, (v.code) },

1111 { 
NGX_RTMP_AMF_STRING
,

1112 
	`ngx_°rög
("description"),

1113 &
v
.
desc
, (v.desc) },

1116 
ngx_πmp_amf_ñt_t
 
ö_ñts
[] = {

1118 { 
NGX_RTMP_AMF_NUMBER
,

1119 
ngx_nuŒ_°rög
,

1120 &
v
.
å™s
, 0 },

1122 { 
NGX_RTMP_AMF_NULL
,

1123 
ngx_nuŒ_°rög
,

1124 
NULL
, 0 },

1126 { 
NGX_RTMP_AMF_OBJECT
,

1127 
ngx_nuŒ_°rög
,

1128 
ö_öf
, (in_inf) },

1132 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªœy_moduÀ
);

1133 i‡(
˘x
 =
NULL
 || !
s
->
ªœy
) {

1134  
NGX_OK
;

1137 
	`ngx_memzîo
(&
v
, (v));

1138 i‡(
	`ngx_πmp_ª˚ive_amf
(
s
, 
ö
, 
ö_ñts
,

1139 (
ö_ñts
) / (in_elts[0])))

1141  
NGX_ERROR
;

1144 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1146 
v
.
Àvñ
, v.
code
, v.
desc
);

1148 (
ngx_öt_t
)
v
.
å™s
) {

1149 
NGX_RTMP_RELAY_CONNECT_TRANS
:

1150  
	`ngx_πmp_ªœy_£nd_¸óã_°ªam
(
s
);

1152 
NGX_RTMP_RELAY_CREATE_STREAM_TRANS
:

1153 i‡(
˘x
->
publish
 !˘x && !
s
->
°©ic_ªœy
) {

1154 i‡(
	`ngx_πmp_ªœy_£nd_publish
(
s
Ë!
NGX_OK
) {

1155  
NGX_ERROR
;

1157  
	`ngx_πmp_ªœy_∂ay_loˇl
(
s
);

1160 i‡(
	`ngx_πmp_ªœy_£nd_∂ay
(
s
Ë!
NGX_OK
) {

1161  
NGX_ERROR
;

1163  
	`ngx_πmp_ªœy_publish_loˇl
(
s
);

1167  
NGX_OK
;

1169 
	}
}

1172 
ngx_öt_t


1173 
	$ngx_πmp_ªœy_⁄_îr‹
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

1174 
ngx_chaö_t
 *
ö
)

1176 
ngx_πmp_ªœy_˘x_t
 *
˘x
;

1178 
å™s
;

1179 
u_ch¨
 
Àvñ
[32];

1180 
u_ch¨
 
code
[128];

1181 
u_ch¨
 
desc
[1024];

1182 } 
v
;

1184 
ngx_πmp_amf_ñt_t
 
ö_öf
[] = {

1186 { 
NGX_RTMP_AMF_STRING
,

1187 
	`ngx_°rög
("level"),

1188 &
v
.
Àvñ
, (v.level) },

1190 { 
NGX_RTMP_AMF_STRING
,

1191 
	`ngx_°rög
("code"),

1192 &
v
.
code
, (v.code) },

1194 { 
NGX_RTMP_AMF_STRING
,

1195 
	`ngx_°rög
("description"),

1196 &
v
.
desc
, (v.desc) },

1199 
ngx_πmp_amf_ñt_t
 
ö_ñts
[] = {

1201 { 
NGX_RTMP_AMF_NUMBER
,

1202 
ngx_nuŒ_°rög
,

1203 &
v
.
å™s
, 0 },

1205 { 
NGX_RTMP_AMF_NULL
,

1206 
ngx_nuŒ_°rög
,

1207 
NULL
, 0 },

1209 { 
NGX_RTMP_AMF_OBJECT
,

1210 
ngx_nuŒ_°rög
,

1211 
ö_öf
, (in_inf) },

1215 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªœy_moduÀ
);

1216 i‡(
˘x
 =
NULL
 || !
s
->
ªœy
) {

1217  
NGX_OK
;

1220 
	`ngx_memzîo
(&
v
, (v));

1221 i‡(
	`ngx_πmp_ª˚ive_amf
(
s
, 
ö
, 
ö_ñts
,

1222 (
ö_ñts
) / (in_elts[0])))

1224  
NGX_ERROR
;

1227 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1229 
v
.
Àvñ
, v.
code
, v.
desc
);

1231  
NGX_OK
;

1232 
	}
}

1235 
ngx_öt_t


1236 
	$ngx_πmp_ªœy_⁄_°©us
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

1237 
ngx_chaö_t
 *
ö
)

1239 
ngx_πmp_ªœy_˘x_t
 *
˘x
;

1241 
å™s
;

1242 
u_ch¨
 
Àvñ
[32];

1243 
u_ch¨
 
code
[128];

1244 
u_ch¨
 
desc
[1024];

1245 } 
v
;

1247 
ngx_πmp_amf_ñt_t
 
ö_öf
[] = {

1249 { 
NGX_RTMP_AMF_STRING
,

1250 
	`ngx_°rög
("level"),

1251 &
v
.
Àvñ
, (v.level) },

1253 { 
NGX_RTMP_AMF_STRING
,

1254 
	`ngx_°rög
("code"),

1255 &
v
.
code
, (v.code) },

1257 { 
NGX_RTMP_AMF_STRING
,

1258 
	`ngx_°rög
("description"),

1259 &
v
.
desc
, (v.desc) },

1262 
ngx_πmp_amf_ñt_t
 
ö_ñts
[] = {

1264 { 
NGX_RTMP_AMF_NUMBER
,

1265 
ngx_nuŒ_°rög
,

1266 &
v
.
å™s
, 0 },

1268 { 
NGX_RTMP_AMF_NULL
,

1269 
ngx_nuŒ_°rög
,

1270 
NULL
, 0 },

1272 { 
NGX_RTMP_AMF_OBJECT
,

1273 
ngx_nuŒ_°rög
,

1274 
ö_öf
, (in_inf) },

1277 
ngx_πmp_amf_ñt_t
 
ö_ñts_mëa
[] = {

1279 { 
NGX_RTMP_AMF_OBJECT
,

1280 
ngx_nuŒ_°rög
,

1281 
ö_öf
, (in_inf) },

1285 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªœy_moduÀ
);

1286 i‡(
˘x
 =
NULL
 || !
s
->
ªœy
) {

1287  
NGX_OK
;

1290 
	`ngx_memzîo
(&
v
, (v));

1291 i‡(
h
->
ty≥
 =
NGX_RTMP_MSG_AMF_META
) {

1292 
	`ngx_πmp_ª˚ive_amf
(
s
, 
ö
, 
ö_ñts_mëa
,

1293 (
ö_ñts_mëa
) / (in_elts_meta[0]));

1295 
	`ngx_πmp_ª˚ive_amf
(
s
, 
ö
, 
ö_ñts
,

1296 (
ö_ñts
) / (in_elts[0]));

1299 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

1301 
v
.
Àvñ
, v.
code
, v.
desc
);

1303  
NGX_OK
;

1304 
	}
}

1307 
ngx_öt_t


1308 
	$ngx_πmp_ªœy_h™dshake_d⁄e
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

1309 
ngx_chaö_t
 *
ö
)

1311 
ngx_πmp_ªœy_˘x_t
 *
˘x
;

1313 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªœy_moduÀ
);

1314 i‡(
˘x
 =
NULL
 || !
s
->
ªœy
) {

1315  
NGX_OK
;

1318  
	`ngx_πmp_ªœy_£nd_c⁄√˘
(
s
);

1319 
	}
}

1323 
	$ngx_πmp_ªœy_˛o£
(
ngx_πmp_£ssi⁄_t
 *
s
)

1325 
ngx_πmp_ªœy_≠p_c⁄f_t
 *
øcf
;

1326 
ngx_πmp_ªœy_˘x_t
 *
˘x
, **
c˘x
;

1327 
ngx_uöt_t
 
hash
;

1329 
øcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_ªœy_moduÀ
);

1331 
˘x
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_ªœy_moduÀ
);

1332 i‡(
˘x
 =
NULL
) {

1336 i‡(
s
->
°©ic_ªœy
) {

1337 
	`ngx_add_timî
(
˘x
->
°©ic_evt
, 
øcf
->
puŒ_ªc⁄√˘
);

1340 i‡(
˘x
->
publish
 =
NULL
) {

1345 i‡(
˘x
->
publish
 != ctx) {

1346 
c˘x
 = &
˘x
->
publish
->
∂ay
; *c˘x; c˘x = &(*c˘x)->
√xt
) {

1347 i‡(*
c˘x
 =
˘x
) {

1348 *
c˘x
 = 
˘x
->
√xt
;

1353 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
˘x
->
£ssi⁄
->
c⁄√˘i⁄
->
log
, 0,

1355 &
˘x
->
≠p
, &˘x->
«me
);

1358 i‡(
s
->
ªœy
 && 
˘x
->
èg
 =&
ngx_πmp_ªœy_moduÀ
 &&

1359 !
˘x
->
publish
->
push_evt
.
timî_£t
)

1361 
	`ngx_add_timî
(&
˘x
->
publish
->
push_evt
, 
øcf
->
push_ªc⁄√˘
);

1364 #ifde‡
NGX_DEBUG


1366 
ngx_uöt_t
 
n
 = 0;

1367 
c˘x
 = &
˘x
->
publish
->
∂ay
; *c˘x; c˘x = &(*c˘x)->
√xt
, ++
n
);

1368 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
˘x
->
£ssi⁄
->
c⁄√˘i⁄
->
log
, 0,

1370 &
˘x
->
≠p
, &˘x->
«me
, 
n
);

1374 i‡(
˘x
->
publish
->
∂ay
 =
NULL
 && ctx->publish->
£ssi⁄
->
ªœy
) {

1375 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
,

1376 
˘x
->
publish
->
£ssi⁄
->
c⁄√˘i⁄
->
log
, 0,

1378 &
˘x
->
≠p
, &˘x->
«me
);

1379 
	`ngx_πmp_föÆize_£ssi⁄
(
˘x
->
publish
->
£ssi⁄
);

1382 
˘x
->
publish
 = 
NULL
;

1388 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
˘x
->
£ssi⁄
->
c⁄√˘i⁄
->
log
, 0,

1390 &
˘x
->
≠p
, &˘x->
«me
);

1392 i‡(
˘x
->
push_evt
.
timî_£t
) {

1393 
	`ngx_dñ_timî
(&
˘x
->
push_evt
);

1396 
c˘x
 = &
˘x
->
∂ay
; *c˘x; c˘x = &(*c˘x)->
√xt
) {

1397 (*
c˘x
)->
publish
 = 
NULL
;

1398 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, (*
c˘x
)->
£ssi⁄
->
c⁄√˘i⁄
->
log
,

1400 &(*
c˘x
)->
≠p
, &(*c˘x)->
«me
);

1401 
	`ngx_πmp_föÆize_£ssi⁄
((*
c˘x
)->
£ssi⁄
);

1403 
˘x
->
publish
 = 
NULL
;

1405 
hash
 = 
	`ngx_hash_key
(
˘x
->
«me
.
d©a
, ctx->«me.
Àn
);

1406 
c˘x
 = &
øcf
->
˘x
[
hash
 %Ñacf->
nbuckës
];

1407 ; *
c˘x
 && *c˘x !
˘x
; c˘x = &(*c˘x)->
√xt
);

1408 i‡(*
c˘x
) {

1409 *
c˘x
 = 
˘x
->
√xt
;

1411 
	}
}

1414 
ngx_öt_t


1415 
	$ngx_πmp_ªœy_˛o£_°ªam
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_˛o£_°ªam_t
 *
v
)

1417 
ngx_πmp_ªœy_≠p_c⁄f_t
 *
øcf
;

1419 
øcf
 = 
	`ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
ngx_πmp_ªœy_moduÀ
);

1420 i‡(
øcf
 && !øcf->
£ssi⁄_ªœy
) {

1421 
	`ngx_πmp_ªœy_˛o£
(
s
);

1424  
	`√xt_˛o£_°ªam
(
s
, 
v
);

1425 
	}
}

1428 
ngx_öt_t


1429 
	$ngx_πmp_ªœy_dñëe_°ªam
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_dñëe_°ªam_t
 *
v
)

1431 
	`ngx_πmp_ªœy_˛o£
(
s
);

1433  
	`√xt_dñëe_°ªam
(
s
, 
v
);

1434 
	}
}

1438 
	$ngx_πmp_ªœy_push_puŒ
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

1440 
ngx_°r_t
 *
vÆue
, 
v
, 
n
;

1441 
ngx_πmp_ªœy_≠p_c⁄f_t
 *
øcf
;

1442 
ngx_πmp_ªœy_èrgë_t
 *
èrgë
, **
t
;

1443 
ngx_uæ_t
 *
u
;

1444 
ngx_uöt_t
 
i
;

1445 
ngx_öt_t
 
is_puŒ
, 
is_°©ic
;

1446 
ngx_evít_t
 **
ì
, *
e
;

1447 
ngx_πmp_ªœy_°©ic_t
 *
rs
;

1448 
u_ch¨
 *
p
;

1450 
vÆue
 = 
cf
->
¨gs
->
ñts
;

1452 
øcf
 = 
	`ngx_πmp_c⁄f_gë_moduÀ_≠p_c⁄f
(
cf
, 
ngx_πmp_ªœy_moduÀ
);

1454 
is_puŒ
 = (
vÆue
[0].
d©a
[3] == 'l');

1455 
is_°©ic
 = 0;

1457 
èrgë
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (*target));

1458 i‡(
èrgë
 =
NULL
) {

1459  
NGX_CONF_ERROR
;

1462 
èrgë
->
èg
 = &
ngx_πmp_ªœy_moduÀ
;

1463 
èrgë
->
d©a
 =Åarget;

1465 
u
 = &
èrgë
->
uæ
;

1466 
u
->
deÁu…_p‹t
 = 1935;

1467 
u
->
uri_∑π
 = 1;

1468 
u
->
uæ
 = 
vÆue
[1];

1470 i‡(
	`ngx_°∫ˇ£cmp
(
u
->
uæ
.
d©a
, (
u_ch¨
 *) "rtmp://", 7) == 0) {

1471 
u
->
uæ
.
d©a
 += 7;

1472 
u
->
uæ
.
Àn
 -= 7;

1475 i‡(
	`ngx_∑r£_uæ
(
cf
->
poﬁ
, 
u
Ë!
NGX_OK
) {

1476 i‡(
u
->
îr
) {

1477 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

1478 "%†ö uæ \"%V\"", 
u
->
îr
, &u->
uæ
);

1480  
NGX_CONF_ERROR
;

1483 
vÆue
 += 2;

1484 
i
 = 2; i < 
cf
->
¨gs
->
√…s
; ++i, ++
vÆue
) {

1485 
p
 = 
	`ngx_°æchr
(
vÆue
->
d©a
, vÆue->d©®+ vÆue->
Àn
, '=');

1487 i‡(
p
 =
NULL
) {

1488 
n
 = *
vÆue
;

1489 
	`ngx_°r_£t
(&
v
, "1");

1492 
n
.
d©a
 = 
vÆue
->data;

1493 
n
.
Àn
 = 
p
 - 
vÆue
->
d©a
;

1495 
v
.
d©a
 = 
p
 + 1;

1496 
v
.
Àn
 = 
vÆue
->
d©a
 + vÆue->À¿- 
p
 - 1;

1499 
	#NGX_RTMP_RELAY_STR_PAR
(
«me
, 
v¨
) \

1500 i‡(
n
.
Àn
 =(
«me
) - 1 \

1501 && 
	`ngx_°∫ˇ£cmp
(
n
.
d©a
, (
u_ch¨
 *Ë
«me
,Ç.
Àn
) == 0) \

1503 
èrgë
->
v¨
 = 
v
; \

1505 }

	)

1507 
	#NGX_RTMP_RELAY_NUM_PAR
(
«me
, 
v¨
) \

1508 i‡(
n
.
Àn
 =(
«me
) - 1 \

1509 && 
	`ngx_°∫ˇ£cmp
(
n
.
d©a
, (
u_ch¨
 *Ë
«me
,Ç.
Àn
) == 0) \

1511 
èrgë
->
v¨
 = 
	`ngx_©oi
(
v
.
d©a
, v.
Àn
); \

1513 }

	)

1515 
	`NGX_RTMP_RELAY_STR_PAR
("≠p", 
≠p
);

1516 
	`NGX_RTMP_RELAY_STR_PAR
("«me", 
«me
);

1517 
	`NGX_RTMP_RELAY_STR_PAR
("tcUæ", 
tc_uæ
);

1518 
	`NGX_RTMP_RELAY_STR_PAR
("∑geUæ", 
∑ge_uæ
);

1519 
	`NGX_RTMP_RELAY_STR_PAR
("swfUæ", 
swf_uæ
);

1520 
	`NGX_RTMP_RELAY_STR_PAR
("ÊashVî", 
Êash_vî
);

1521 
	`NGX_RTMP_RELAY_STR_PAR
("∂ayP©h", 
∂ay_∑th
);

1522 
	`NGX_RTMP_RELAY_NUM_PAR
("live", 
live
);

1523 
	`NGX_RTMP_RELAY_NUM_PAR
("°¨t", 
°¨t
);

1524 
	`NGX_RTMP_RELAY_NUM_PAR
("°›", 
°›
);

1526 #unde‡
NGX_RTMP_RELAY_STR_PAR


1527 #unde‡
NGX_RTMP_RELAY_NUM_PAR


1529 i‡(
n
.
Àn
 == ("static") - 1 &&

1530 
	`ngx_°∫ˇ£cmp
(
n
.
d©a
, (
u_ch¨
 *Ë"°©ic",Ç.
Àn
) == 0 &&

1531 
	`ngx_©oi
(
v
.
d©a
, v.
Àn
))

1533 
is_°©ic
 = 1;

1540 i‡(
is_°©ic
) {

1542 i‡(!
is_puŒ
) {

1543 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

1545  
NGX_CONF_ERROR
;

1548 i‡(
èrgë
->
«me
.
Àn
 == 0) {

1549 
	`ngx_c⁄f_log_îr‹
(
NGX_LOG_EMERG
, 
cf
, 0,

1552  
NGX_CONF_ERROR
;

1555 
ì
 = 
	`ngx_¨øy_push
(&
øcf
->
°©ic_evíts
);

1556 i‡(
ì
 =
NULL
) {

1557  
NGX_CONF_ERROR
;

1560 
e
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_evít_t
));

1561 i‡(
e
 =
NULL
) {

1562  
NGX_CONF_ERROR
;

1565 *
ì
 = 
e
;

1567 
rs
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_ªœy_°©ic_t
));

1568 i‡(
rs
 =
NULL
) {

1569  
NGX_CONF_ERROR
;

1572 
rs
->
èrgë
 =Åarget;

1574 
e
->
d©a
 = 
rs
;

1575 
e
->
log
 = &
cf
->
cy˛e
->
√w_log
;

1576 
e
->
h™dÀr
 = 
ngx_πmp_ªœy_°©ic_puŒ_ªc⁄√˘
;

1578 
t
 = 
	`ngx_¨øy_push
(&
øcf
->
°©ic_puŒs
);

1580 } i‡(
is_puŒ
) {

1581 
t
 = 
	`ngx_¨øy_push
(&
øcf
->
puŒs
);

1584 
t
 = 
	`ngx_¨øy_push
(&
øcf
->
pushes
);

1587 i‡(
t
 =
NULL
) {

1588  
NGX_CONF_ERROR
;

1591 *
t
 = 
èrgë
;

1593  
NGX_CONF_OK
;

1594 
	}
}

1597 
ngx_öt_t


1598 
	$ngx_πmp_ªœy_öô_¥o˚ss
(
ngx_cy˛e_t
 *
cy˛e
)

1600 #i‡!(
NGX_WIN32
)

1601 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
 = 
ngx_πmp_c‹e_maö_c⁄f
;

1602 
ngx_πmp_c‹e_§v_c⁄f_t
 **
pcscf
, *
cscf
;

1603 
ngx_πmp_c‹e_≠p_c⁄f_t
 **
pˇcf
, *
ˇcf
;

1604 
ngx_πmp_ªœy_≠p_c⁄f_t
 *
øcf
;

1605 
ngx_uöt_t
 
n
, 
m
, 
k
;

1606 
ngx_πmp_ªœy_°©ic_t
 *
rs
;

1607 
ngx_πmp_li°í_t
 *
l°
;

1608 
ngx_evít_t
 **
≥vít
, *
evít
;

1610 i‡(
cmcf
 =
NULL
 || cmcf->
li°í
.
√…s
 == 0) {

1611  
NGX_OK
;

1616 i‡(
ngx_¥o˚ss_¶Ÿ
) {

1617  
NGX_OK
;

1620 
l°
 = 
cmcf
->
li°í
.
ñts
;

1622 
pcscf
 = 
cmcf
->
£rvîs
.
ñts
;

1623 
n
 = 0;Ç < 
cmcf
->
£rvîs
.
√…s
; ++n, ++
pcscf
) {

1625 
cscf
 = *
pcscf
;

1626 
pˇcf
 = 
cscf
->
≠∂iˇti⁄s
.
ñts
;

1628 
m
 = 0; m < 
cscf
->
≠∂iˇti⁄s
.
√…s
; ++m, ++
pˇcf
) {

1630 
ˇcf
 = *
pˇcf
;

1631 
øcf
 = 
ˇcf
->
≠p_c⁄f
[
ngx_πmp_ªœy_moduÀ
.
˘x_ödex
];

1632 
≥vít
 = 
øcf
->
°©ic_evíts
.
ñts
;

1634 
k
 = 0; k < 
øcf
->
°©ic_evíts
.
√…s
; ++k, ++
≥vít
) {

1635 
evít
 = *
≥vít
;

1637 
rs
 = 
evít
->
d©a
;

1638 
rs
->
c˘x
 = *
l°
->
˘x
;

1639 
rs
->
c˘x
.
≠p_c⁄f
 = 
ˇcf
->app_conf;

1641 
	`ngx_po°_evít
(
evít
, &
ngx_πmp_öô_queue
);

1646  
NGX_OK
;

1647 
	}
}

1650 
ngx_öt_t


1651 
	$ngx_πmp_ªœy_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
)

1653 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
;

1654 
ngx_πmp_h™dÀr_±
 *
h
;

1655 
ngx_πmp_amf_h™dÀr_t
 *
ch
;

1657 
cmcf
 = 
	`ngx_πmp_c⁄f_gë_moduÀ_maö_c⁄f
(
cf
, 
ngx_πmp_c‹e_moduÀ
);

1660 
h
 = 
	`ngx_¨øy_push
(&
cmcf
->
evíts
[
NGX_RTMP_HANDSHAKE_DONE
]);

1661 *
h
 = 
ngx_πmp_ªœy_h™dshake_d⁄e
;

1664 
√xt_publish
 = 
ngx_πmp_publish
;

1665 
ngx_πmp_publish
 = 
ngx_πmp_ªœy_publish
;

1667 
√xt_∂ay
 = 
ngx_πmp_∂ay
;

1668 
ngx_πmp_∂ay
 = 
ngx_πmp_ªœy_∂ay
;

1670 
√xt_dñëe_°ªam
 = 
ngx_πmp_dñëe_°ªam
;

1671 
ngx_πmp_dñëe_°ªam
 = 
ngx_πmp_ªœy_dñëe_°ªam
;

1673 
√xt_˛o£_°ªam
 = 
ngx_πmp_˛o£_°ªam
;

1674 
ngx_πmp_˛o£_°ªam
 = 
ngx_πmp_ªœy_˛o£_°ªam
;

1677 
ch
 = 
	`ngx_¨øy_push
(&
cmcf
->
amf
);

1678 
	`ngx_°r_£t
(&
ch
->
«me
, "_result");

1679 
ch
->
h™dÀr
 = 
ngx_πmp_ªœy_⁄_ªsu…
;

1681 
ch
 = 
	`ngx_¨øy_push
(&
cmcf
->
amf
);

1682 
	`ngx_°r_£t
(&
ch
->
«me
, "_error");

1683 
ch
->
h™dÀr
 = 
ngx_πmp_ªœy_⁄_îr‹
;

1685 
ch
 = 
	`ngx_¨øy_push
(&
cmcf
->
amf
);

1686 
	`ngx_°r_£t
(&
ch
->
«me
, "onStatus");

1687 
ch
->
h™dÀr
 = 
ngx_πmp_ªœy_⁄_°©us
;

1689  
NGX_OK
;

1690 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_relay_module.h

7 #i‚de‡
_NGX_RTMP_RELAY_H_INCLUDED_


8 
	#_NGX_RTMP_RELAY_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

13 
	~"ngx_πmp.h
"

17 
ngx_uæ_t
 
	muæ
;

18 
ngx_°r_t
 
	m≠p
;

19 
ngx_°r_t
 
	m«me
;

20 
ngx_°r_t
 
	mtc_uæ
;

21 
ngx_°r_t
 
	m∑ge_uæ
;

22 
ngx_°r_t
 
	mswf_uæ
;

23 
ngx_°r_t
 
	mÊash_vî
;

24 
ngx_°r_t
 
	m∂ay_∑th
;

25 
ngx_öt_t
 
	mlive
;

26 
ngx_öt_t
 
	m°¨t
;

27 
ngx_öt_t
 
	m°›
;

29 *
	mèg
;

30 *
	md©a
;

31 
ngx_uöt_t
 
	mcou¡î
;

32 } 
	tngx_πmp_ªœy_èrgë_t
;

35 
ngx_πmp_ªœy_˘x_s
 
	tngx_πmp_ªœy_˘x_t
;

37 
	sngx_πmp_ªœy_˘x_s
 {

38 
ngx_°r_t
 
	m«me
;

39 
ngx_°r_t
 
	muæ
;

40 
ngx_log_t
 
	mlog
;

41 
ngx_πmp_£ssi⁄_t
 *
	m£ssi⁄
;

42 
ngx_πmp_ªœy_˘x_t
 *
	mpublish
;

43 
ngx_πmp_ªœy_˘x_t
 *
	m∂ay
;

44 
ngx_πmp_ªœy_˘x_t
 *
	m√xt
;

46 
ngx_°r_t
 
	m≠p
;

47 
ngx_°r_t
 
	mtc_uæ
;

48 
ngx_°r_t
 
	m∑ge_uæ
;

49 
ngx_°r_t
 
	mswf_uæ
;

50 
ngx_°r_t
 
	mÊash_vî
;

51 
ngx_°r_t
 
	m∂ay_∑th
;

52 
ngx_öt_t
 
	mlive
;

53 
ngx_öt_t
 
	m°¨t
;

54 
ngx_öt_t
 
	m°›
;

56 
ngx_evít_t
 
	mpush_evt
;

57 
ngx_evít_t
 *
	m°©ic_evt
;

58 *
	mèg
;

59 *
	md©a
;

63 
ngx_moduÀ_t
 
ngx_πmp_ªœy_moduÀ
;

66 
ngx_öt_t
 
ngx_πmp_ªœy_puŒ
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_°r_t
 *
«me
,

67 
ngx_πmp_ªœy_èrgë_t
 *
èrgë
);

68 
ngx_öt_t
 
ngx_πmp_ªœy_push
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_°r_t
 *
«me
,

69 
ngx_πmp_ªœy_èrgë_t
 *
èrgë
);

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_send.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp.h
"

10 
	~"ngx_πmp_amf.h
"

11 
	~"ngx_πmp_°ªams.h
"

14 
	#NGX_RTMP_USER_START
(
s
, 
ç
) \

15 
ngx_πmp_hódî_t
 
__h
; \

16 
ngx_chaö_t
 *
__l
; \

17 
ngx_buf_t
 *
__b
; \

18 
ngx_πmp_c‹e_§v_c⁄f_t
 *
__cscf
; \

20 
__cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
( \

21 
s
, 
ngx_πmp_c‹e_moduÀ
); \

22 
	`mem£t
(&
__h
, 0, (__h)); \

23 
__h
.
ty≥
 = 
ç
; \

24 
__h
.
csid
 = 2; \

25 
__l
 = 
	`ngx_πmp_Æloc_sh¨ed_buf
(
__cscf
); \

26 i‡(
__l
 =
NULL
) { \

27  
NULL
; \

29 
__b
 = 
__l
->
buf
;

	)

31 
	#NGX_RTMP_UCTL_START
(
s
, 
ty≥
, 
uty≥
) \

32 
	`NGX_RTMP_USER_START
(
s
, 
ty≥
); \

33 *(
__b
->
œ°
++Ë(
u_ch¨
)((
uty≥
) >> 8); \

34 *(
__b
->
œ°
++Ë(
u_ch¨
)(
uty≥
);

	)

36 
	#NGX_RTMP_USER_OUT1
(
v
) \

37 *(
__b
->
œ°
++Ë((
u_ch¨
*)&
v
)[0];

	)

39 
	#NGX_RTMP_USER_OUT4
(
v
) \

40 *(
__b
->
œ°
++Ë((
u_ch¨
*)&
v
)[3]; \

41 *(
__b
->
œ°
++Ë((
u_ch¨
*)&
v
)[2]; \

42 *(
__b
->
œ°
++Ë((
u_ch¨
*)&
v
)[1]; \

43 *(
__b
->
œ°
++Ë((
u_ch¨
*)&
v
)[0];

	)

45 
	#NGX_RTMP_USER_END
(
s
) \

46 
	`ngx_πmp_¥ï¨e_mesßge
(
s
, &
__h
, 
NULL
, 
__l
); \

47  
__l
;

	)

50 
ngx_öt_t


51 
	$ngx_πmp_£nd_sh¨ed_∑ckë
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_chaö_t
 *
˛
)

53 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

54 
ngx_öt_t
 
rc
;

56 i‡(
˛
 =
NULL
) {

57  
NGX_ERROR
;

60 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

62 
rc
 = 
	`ngx_πmp_£nd_mesßge
(
s
, 
˛
, 0);

64 
	`ngx_πmp_‰ì_sh¨ed_chaö
(
cscf
, 
˛
);

66  
rc
;

67 
	}
}

72 
ngx_chaö_t
 *

73 
	$ngx_πmp_¸óã_chunk_size
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
chunk_size
)

75 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

76 "chunk_size=%uD", 
chunk_size
);

79 
	`NGX_RTMP_USER_START
(
s
, 
NGX_RTMP_MSG_CHUNK_SIZE
);

81 
	`NGX_RTMP_USER_OUT4
(
chunk_size
);

83 
	`NGX_RTMP_USER_END
(
s
);

85 
	}
}

88 
ngx_öt_t


89 
	$ngx_πmp_£nd_chunk_size
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
chunk_size
)

91  
	`ngx_πmp_£nd_sh¨ed_∑ckë
(
s
,

92 
	`ngx_πmp_¸óã_chunk_size
(
s
, 
chunk_size
));

93 
	}
}

96 
ngx_chaö_t
 *

97 
	$ngx_πmp_¸óã_ab‹t
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
csid
)

99 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

100 "¸óã:áb‹àcsid=%uD", 
csid
);

103 
	`NGX_RTMP_USER_START
(
s
, 
NGX_RTMP_MSG_CHUNK_SIZE
);

105 
	`NGX_RTMP_USER_OUT4
(
csid
);

107 
	`NGX_RTMP_USER_END
(
s
);

109 
	}
}

112 
ngx_öt_t


113 
	$ngx_πmp_£nd_ab‹t
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
csid
)

115  
	`ngx_πmp_£nd_sh¨ed_∑ckë
(
s
,

116 
	`ngx_πmp_¸óã_ab‹t
(
s
, 
csid
));

117 
	}
}

120 
ngx_chaö_t
 *

121 
	$ngx_πmp_¸óã_ack
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
£q
)

123 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

124 "¸óã:áck seq=%uD", 
£q
);

127 
	`NGX_RTMP_USER_START
(
s
, 
NGX_RTMP_MSG_ACK
);

129 
	`NGX_RTMP_USER_OUT4
(
£q
);

131 
	`NGX_RTMP_USER_END
(
s
);

133 
	}
}

136 
ngx_öt_t


137 
	$ngx_πmp_£nd_ack
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
£q
)

139  
	`ngx_πmp_£nd_sh¨ed_∑ckë
(
s
,

140 
	`ngx_πmp_¸óã_ack
(
s
, 
£q
));

141 
	}
}

144 
ngx_chaö_t
 *

145 
	$ngx_πmp_¸óã_ack_size
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
ack_size
)

147 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

148 "¸óã:áck_size=%uD", 
ack_size
);

151 
	`NGX_RTMP_USER_START
(
s
, 
NGX_RTMP_MSG_ACK_SIZE
);

153 
	`NGX_RTMP_USER_OUT4
(
ack_size
);

155 
	`NGX_RTMP_USER_END
(
s
);

157 
	}
}

160 
ngx_öt_t


161 
	$ngx_πmp_£nd_ack_size
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
ack_size
)

163  
	`ngx_πmp_£nd_sh¨ed_∑ckë
(
s
,

164 
	`ngx_πmp_¸óã_ack_size
(
s
, 
ack_size
));

165 
	}
}

168 
ngx_chaö_t
 *

169 
	$ngx_πmp_¸óã_b™dwidth
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
ack_size
,

170 
uöt8_t
 
limô_ty≥
)

172 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

174 
ack_size
, ()
limô_ty≥
);

177 
	`NGX_RTMP_USER_START
(
s
, 
NGX_RTMP_MSG_BANDWIDTH
);

179 
	`NGX_RTMP_USER_OUT4
(
ack_size
);

180 
	`NGX_RTMP_USER_OUT1
(
limô_ty≥
);

182 
	`NGX_RTMP_USER_END
(
s
);

184 
	}
}

187 
ngx_öt_t


188 
	$ngx_πmp_£nd_b™dwidth
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
ack_size
,

189 
uöt8_t
 
limô_ty≥
)

191  
	`ngx_πmp_£nd_sh¨ed_∑ckë
(
s
,

192 
	`ngx_πmp_¸óã_b™dwidth
(
s
, 
ack_size
, 
limô_ty≥
));

193 
	}
}

198 
ngx_chaö_t
 *

199 
	$ngx_πmp_¸óã_°ªam_begö
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
msid
)

201 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

202 "¸óã: såóm_begö msid=%uD", 
msid
);

205 
	`NGX_RTMP_UCTL_START
(
s
, 
NGX_RTMP_MSG_USER
, 
NGX_RTMP_USER_STREAM_BEGIN
);

207 
	`NGX_RTMP_USER_OUT4
(
msid
);

209 
	`NGX_RTMP_USER_END
(
s
);

211 
	}
}

214 
ngx_öt_t


215 
	$ngx_πmp_£nd_°ªam_begö
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
msid
)

217  
	`ngx_πmp_£nd_sh¨ed_∑ckë
(
s
,

218 
	`ngx_πmp_¸óã_°ªam_begö
(
s
, 
msid
));

219 
	}
}

222 
ngx_chaö_t
 *

223 
	$ngx_πmp_¸óã_°ªam_eof
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
msid
)

225 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

226 "¸óã: såóm_íd msid=%uD", 
msid
);

229 
	`NGX_RTMP_UCTL_START
(
s
, 
NGX_RTMP_MSG_USER
, 
NGX_RTMP_USER_STREAM_EOF
);

231 
	`NGX_RTMP_USER_OUT4
(
msid
);

233 
	`NGX_RTMP_USER_END
(
s
);

235 
	}
}

238 
ngx_öt_t


239 
	$ngx_πmp_£nd_°ªam_eof
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
msid
)

241  
	`ngx_πmp_£nd_sh¨ed_∑ckë
(
s
,

242 
	`ngx_πmp_¸óã_°ªam_eof
(
s
, 
msid
));

243 
	}
}

246 
ngx_chaö_t
 *

247 
	$ngx_πmp_¸óã_°ªam_dry
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
msid
)

249 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

250 "¸óã: såóm_dry msid=%uD", 
msid
);

253 
	`NGX_RTMP_UCTL_START
(
s
, 
NGX_RTMP_MSG_USER
, 
NGX_RTMP_USER_STREAM_DRY
);

255 
	`NGX_RTMP_USER_OUT4
(
msid
);

257 
	`NGX_RTMP_USER_END
(
s
);

259 
	}
}

262 
ngx_öt_t


263 
	$ngx_πmp_£nd_°ªam_dry
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
msid
)

265  
	`ngx_πmp_£nd_sh¨ed_∑ckë
(
s
,

266 
	`ngx_πmp_¸óã_°ªam_dry
(
s
, 
msid
));

267 
	}
}

270 
ngx_chaö_t
 *

271 
	$ngx_πmp_¸óã_£t_buÊí
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
msid
,

272 
uöt32_t
 
buÊí_m£c
)

274 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

276 
msid
, 
buÊí_m£c
);

279 
	`NGX_RTMP_UCTL_START
(
s
, 
NGX_RTMP_MSG_USER
, 
NGX_RTMP_USER_SET_BUFLEN
);

281 
	`NGX_RTMP_USER_OUT4
(
msid
);

282 
	`NGX_RTMP_USER_OUT4
(
buÊí_m£c
);

284 
	`NGX_RTMP_USER_END
(
s
);

286 
	}
}

289 
ngx_öt_t


290 
	$ngx_πmp_£nd_£t_buÊí
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
msid
,

291 
uöt32_t
 
buÊí_m£c
)

293  
	`ngx_πmp_£nd_sh¨ed_∑ckë
(
s
,

294 
	`ngx_πmp_¸óã_£t_buÊí
(
s
, 
msid
, 
buÊí_m£c
));

295 
	}
}

298 
ngx_chaö_t
 *

299 
	$ngx_πmp_¸óã_ªc‹ded
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
msid
)

301 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

302 "¸óã:Ñec‹ded msid=%uD", 
msid
);

305 
	`NGX_RTMP_UCTL_START
(
s
, 
NGX_RTMP_MSG_USER
, 
NGX_RTMP_USER_RECORDED
);

307 
	`NGX_RTMP_USER_OUT4
(
msid
);

309 
	`NGX_RTMP_USER_END
(
s
);

311 
	}
}

314 
ngx_öt_t


315 
	$ngx_πmp_£nd_ªc‹ded
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
msid
)

317  
	`ngx_πmp_£nd_sh¨ed_∑ckë
(
s
,

318 
	`ngx_πmp_¸óã_ªc‹ded
(
s
, 
msid
));

319 
	}
}

322 
ngx_chaö_t
 *

323 
	$ngx_πmp_¸óã_pög_ªque°
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
time°amp
)

325 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

326 "¸óã:Öög_ªque°Åime°amp=%uD", 
time°amp
);

329 
	`NGX_RTMP_UCTL_START
(
s
, 
NGX_RTMP_MSG_USER
, 
NGX_RTMP_USER_PING_REQUEST
);

331 
	`NGX_RTMP_USER_OUT4
(
time°amp
);

333 
	`NGX_RTMP_USER_END
(
s
);

335 
	}
}

338 
ngx_öt_t


339 
	$ngx_πmp_£nd_pög_ªque°
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
time°amp
)

341  
	`ngx_πmp_£nd_sh¨ed_∑ckë
(
s
,

342 
	`ngx_πmp_¸óã_pög_ªque°
(
s
, 
time°amp
));

343 
	}
}

346 
ngx_chaö_t
 *

347 
	$ngx_πmp_¸óã_pög_ª•⁄£
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
time°amp
)

349 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

350 "¸óã:Öög_ª•⁄£Åime°amp=%uD", 
time°amp
);

353 
	`NGX_RTMP_UCTL_START
(
s
, 
NGX_RTMP_MSG_USER
, 
NGX_RTMP_USER_PING_RESPONSE
);

355 
	`NGX_RTMP_USER_OUT4
(
time°amp
);

357 
	`NGX_RTMP_USER_END
(
s
);

359 
	}
}

362 
ngx_öt_t


363 
	$ngx_πmp_£nd_pög_ª•⁄£
(
ngx_πmp_£ssi⁄_t
 *
s
, 
uöt32_t
 
time°amp
)

365  
	`ngx_πmp_£nd_sh¨ed_∑ckë
(
s
,

366 
	`ngx_πmp_¸óã_pög_ª•⁄£
(
s
, 
time°amp
));

367 
	}
}

370 
ngx_chaö_t
 *

371 
	$ngx_πmp_Æloc_amf_buf
(*
¨g
)

373  
	`ngx_πmp_Æloc_sh¨ed_buf
((
ngx_πmp_c‹e_§v_c⁄f_t
 *)
¨g
);

374 
	}
}

380 
ngx_öt_t


381 
	$ngx_πmp_≠≥nd_amf
(
ngx_πmp_£ssi⁄_t
 *
s
,

382 
ngx_chaö_t
 **
fú°
,Çgx_chaö_à**
œ°
,

383 
ngx_πmp_amf_ñt_t
 *
ñts
, 
size_t
 
√…s
)

385 
ngx_πmp_amf_˘x_t
 
a˘
;

386 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

387 
ngx_öt_t
 
rc
;

389 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

391 
	`mem£t
(&
a˘
, 0, (act));

392 
a˘
.
¨g
 = 
cscf
;

393 
a˘
.
Æloc
 = 
ngx_πmp_Æloc_amf_buf
;

394 
a˘
.
log
 = 
s
->
c⁄√˘i⁄
->log;

396 i‡(
fú°
) {

397 
a˘
.
fú°
 = *first;

400 i‡(
œ°
) {

401 
a˘
.
lök
 = *
œ°
;

404 
rc
 = 
	`ngx_πmp_amf_wrôe
(&
a˘
, 
ñts
, 
√…s
);

406 i‡(
fú°
) {

407 *
fú°
 = 
a˘
.first;

410 i‡(
œ°
) {

411 *
œ°
 = 
a˘
.
lök
;

414  
rc
;

415 
	}
}

418 
ngx_chaö_t
 *

419 
	$ngx_πmp_¸óã_amf
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

420 
ngx_πmp_amf_ñt_t
 *
ñts
, 
size_t
 
√…s
)

422 
ngx_chaö_t
 *
fú°
;

423 
ngx_öt_t
 
rc
;

424 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
;

426 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

427 "¸óã:ám‡√…s=%ui", 
√…s
);

429 
cscf
 = 
	`ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
ngx_πmp_c‹e_moduÀ
);

431 
fú°
 = 
NULL
;

433 
rc
 = 
	`ngx_πmp_≠≥nd_amf
(
s
, &
fú°
, 
NULL
, 
ñts
, 
√…s
);

435 i‡(
rc
 !
NGX_OK
 && 
fú°
) {

436 
	`ngx_πmp_‰ì_sh¨ed_chaö
(
cscf
, 
fú°
);

437 
fú°
 = 
NULL
;

440 i‡(
fú°
) {

441 
	`ngx_πmp_¥ï¨e_mesßge
(
s
, 
h
, 
NULL
, 
fú°
);

444  
fú°
;

445 
	}
}

448 
ngx_öt_t


449 
	$ngx_πmp_£nd_amf
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

450 
ngx_πmp_amf_ñt_t
 *
ñts
, 
size_t
 
√…s
)

452  
	`ngx_πmp_£nd_sh¨ed_∑ckë
(
s
,

453 
	`ngx_πmp_¸óã_amf
(
s
, 
h
, 
ñts
, 
√…s
));

454 
	}
}

457 
ngx_chaö_t
 *

458 
	$ngx_πmp_¸óã_°©us
(
ngx_πmp_£ssi⁄_t
 *
s
, *
code
, * 
Àvñ
,

459 *
desc
)

461 
ngx_πmp_hódî_t
 
h
;

462 
å™s
;

464 
ngx_πmp_amf_ñt_t
 
out_öf
[] = {

466 { 
NGX_RTMP_AMF_STRING
,

467 
	`ngx_°rög
("level"),

468 
NULL
, 0 },

470 { 
NGX_RTMP_AMF_STRING
,

471 
	`ngx_°rög
("code"),

472 
NULL
, 0 },

474 { 
NGX_RTMP_AMF_STRING
,

475 
	`ngx_°rög
("description"),

476 
NULL
, 0 },

479 
ngx_πmp_amf_ñt_t
 
out_ñts
[] = {

481 { 
NGX_RTMP_AMF_STRING
,

482 
ngx_nuŒ_°rög
,

485 { 
NGX_RTMP_AMF_NUMBER
,

486 
ngx_nuŒ_°rög
,

487 &
å™s
, 0 },

489 { 
NGX_RTMP_AMF_NULL
,

490 
ngx_nuŒ_°rög
,

491 
NULL
, 0 },

493 { 
NGX_RTMP_AMF_OBJECT
,

494 
ngx_nuŒ_°rög
,

495 
out_öf
,

496 (
out_öf
) },

499 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

501 
code
, 
Àvñ
, 
desc
);

503 
out_öf
[0].
d©a
 = 
Àvñ
;

504 
out_öf
[1].
d©a
 = 
code
;

505 
out_öf
[2].
d©a
 = 
desc
;

507 
	`mem£t
(&
h
, 0, (h));

509 
h
.
ty≥
 = 
NGX_RTMP_MSG_AMF_CMD
;

510 
h
.
csid
 = 
NGX_RTMP_CSID_AMF
;

511 
h
.
msid
 = 
NGX_RTMP_MSID
;

513  
	`ngx_πmp_¸óã_amf
(
s
, &
h
, 
out_ñts
,

514 (
out_ñts
) / (out_elts[0]));

515 
	}
}

518 
ngx_öt_t


519 
	$ngx_πmp_£nd_°©us
(
ngx_πmp_£ssi⁄_t
 *
s
, *
code
, * 
Àvñ
, *
desc
)

521  
	`ngx_πmp_£nd_sh¨ed_∑ckë
(
s
,

522 
	`ngx_πmp_¸óã_°©us
(
s
, 
code
, 
Àvñ
, 
desc
));

523 
	}
}

526 
ngx_chaö_t
 *

527 
	$ngx_πmp_¸óã_∂ay_°©us
(
ngx_πmp_£ssi⁄_t
 *
s
, *
code
, * 
Àvñ
,

528 
ngx_uöt_t
 
duøti⁄
,Çgx_uöt_à
byãs
)

530 
ngx_πmp_hódî_t
 
h
;

531 
dduøti⁄
;

532 
dbyãs
;

534 
ngx_πmp_amf_ñt_t
 
out_öf
[] = {

536 { 
NGX_RTMP_AMF_STRING
,

537 
	`ngx_°rög
("code"),

538 
NULL
, 0 },

540 { 
NGX_RTMP_AMF_STRING
,

541 
	`ngx_°rög
("level"),

542 
NULL
, 0 },

544 { 
NGX_RTMP_AMF_NUMBER
,

545 
	`ngx_°rög
("duration"),

546 &
dduøti⁄
, 0 },

548 { 
NGX_RTMP_AMF_NUMBER
,

549 
	`ngx_°rög
("bytes"),

550 &
dbyãs
, 0 },

553 
ngx_πmp_amf_ñt_t
 
out_ñts
[] = {

555 { 
NGX_RTMP_AMF_STRING
,

556 
ngx_nuŒ_°rög
,

559 { 
NGX_RTMP_AMF_OBJECT
,

560 
ngx_nuŒ_°rög
,

561 
out_öf
,

562 (
out_öf
) },

565 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_RTMP
, 
s
->
c⁄√˘i⁄
->
log
, 0,

568 
code
, 
Àvñ
, 
duøti⁄
, 
byãs
);

570 
out_öf
[0].
d©a
 = 
code
;

571 
out_öf
[1].
d©a
 = 
Àvñ
;

573 
dduøti⁄
 = 
duøti⁄
;

574 
dbyãs
 = 
byãs
;

576 
	`mem£t
(&
h
, 0, (h));

578 
h
.
ty≥
 = 
NGX_RTMP_MSG_AMF_META
;

579 
h
.
csid
 = 
NGX_RTMP_CSID_AMF
;

580 
h
.
msid
 = 
NGX_RTMP_MSID
;

581 
h
.
time°amp
 = 
duøti⁄
;

583  
	`ngx_πmp_¸óã_amf
(
s
, &
h
, 
out_ñts
,

584 (
out_ñts
) / (out_elts[0]));

585 
	}
}

588 
ngx_öt_t


589 
	$ngx_πmp_£nd_∂ay_°©us
(
ngx_πmp_£ssi⁄_t
 *
s
, *
code
, * 
Àvñ
,

590 
ngx_uöt_t
 
duøti⁄
,Çgx_uöt_à
byãs
)

592  
	`ngx_πmp_£nd_sh¨ed_∑ckë
(
s
,

593 
	`ngx_πmp_¸óã_∂ay_°©us
(
s
, 
code
, 
Àvñ
, 
duøti⁄
, 
byãs
));

594 
	}
}

597 
ngx_chaö_t
 *

598 
	$ngx_πmp_¸óã_ßm∂e_ac˚ss
(
ngx_πmp_£ssi⁄_t
 *
s
)

600 
ngx_πmp_hódî_t
 
h
;

602 
ac˚ss
 = 1;

604 
ngx_πmp_amf_ñt_t
 
ac˚ss_ñts
[] = {

606 { 
NGX_RTMP_AMF_STRING
,

607 
ngx_nuŒ_°rög
,

610 { 
NGX_RTMP_AMF_BOOLEAN
,

611 
ngx_nuŒ_°rög
,

612 &
ac˚ss
, 0 },

614 { 
NGX_RTMP_AMF_BOOLEAN
,

615 
ngx_nuŒ_°rög
,

616 &
ac˚ss
, 0 },

619 
	`mem£t
(&
h
, 0, (h));

621 
h
.
ty≥
 = 
NGX_RTMP_MSG_AMF_META
;

622 
h
.
csid
 = 
NGX_RTMP_CSID_AMF
;

623 
h
.
msid
 = 
NGX_RTMP_MSID
;

625  
	`ngx_πmp_¸óã_amf
(
s
, &
h
, 
ac˚ss_ñts
,

626 (
ac˚ss_ñts
) / (access_elts[0]));

627 
	}
}

630 
ngx_öt_t


631 
	$ngx_πmp_£nd_ßm∂e_ac˚ss
(
ngx_πmp_£ssi⁄_t
 *
s
)

633  
	`ngx_πmp_£nd_sh¨ed_∑ckë
(
s
,

634 
	`ngx_πmp_¸óã_ßm∂e_ac˚ss
(
s
));

635 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_shared.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~"ngx_πmp.h
"

12 
ngx_chaö_t
 *

13 
	$ngx_πmp_Æloc_sh¨ed_buf
(
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
)

15 
u_ch¨
 *
p
;

16 
ngx_chaö_t
 *
out
;

17 
ngx_buf_t
 *
b
;

18 
size_t
 
size
;

20 i‡(
cscf
->
‰ì
) {

21 
out
 = 
cscf
->
‰ì
;

22 
cscf
->
‰ì
 = 
out
->
√xt
;

26 
size
 = 
cscf
->
chunk_size
 + 
NGX_RTMP_MAX_CHUNK_HEADER
;

28 
p
 = 
	`ngx_pˇŒoc
(
cscf
->
poﬁ
, 
NGX_RTMP_REFCOUNT_BYTES


29 + (
ngx_chaö_t
)

30 + (
ngx_buf_t
)

31 + 
size
);

32 i‡(
p
 =
NULL
) {

33  
NULL
;

36 
p
 +
NGX_RTMP_REFCOUNT_BYTES
;

37 
out
 = (
ngx_chaö_t
 *)
p
;

39 
p
 +(
ngx_chaö_t
);

40 
out
->
buf
 = (
ngx_buf_t
 *)
p
;

42 
p
 +(
ngx_buf_t
);

43 
out
->
buf
->
°¨t
 = 
p
;

44 
out
->
buf
->
íd
 = 
p
 + 
size
;

47 
out
->
√xt
 = 
NULL
;

48 
b
 = 
out
->
buf
;

49 
b
->
pos
 = b->
œ°
 = b->
°¨t
 + 
NGX_RTMP_MAX_CHUNK_HEADER
;

50 
b
->
mem‹y
 = 1;

53 
	`ngx_πmp_ªf_£t
(
out
, 1);

55  
out
;

56 
	}
}

60 
	$ngx_πmp_‰ì_sh¨ed_chaö
(
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
, 
ngx_chaö_t
 *
ö
)

62 
ngx_chaö_t
 *
˛
;

64 i‡(
	`ngx_πmp_ªf_put
(
ö
)) {

68 
˛
 = 
ö
; ; c»˛->
√xt
) {

69 i‡(
˛
->
√xt
 =
NULL
) {

70 
˛
->
√xt
 = 
cscf
->
‰ì
;

71 
cscf
->
‰ì
 = 
ö
;

75 
	}
}

78 
ngx_chaö_t
 *

79 
	$ngx_πmp_≠≥nd_sh¨ed_bufs
(
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
,

80 
ngx_chaö_t
 *
hód
,Çgx_chaö_à*
ö
)

82 
ngx_chaö_t
 *
l
, **
Œ
;

83 
u_ch¨
 *
p
;

84 
size_t
 
size
;

86 
Œ
 = &
hód
;

87 
p
 = 
ö
->
buf
->
pos
;

88 
l
 = 
hód
;

90 i‡(
l
) {

91 ; 
l
->
√xt
;Ü =Ü->next);

92 
Œ
 = &
l
->
√xt
;

97 i‡(
l
 =
NULL
 ||Ü->
buf
->
œ°
 =l->buf->
íd
) {

98 
l
 = 
	`ngx_πmp_Æloc_sh¨ed_buf
(
cscf
);

99 i‡(
l
 =
NULL
 ||Ü->
buf
 == NULL) {

103 *
Œ
 = 
l
;

104 
Œ
 = &
l
->
√xt
;

107 
l
->
buf
->
íd
 -Ü->buf->
œ°
 >
ö
->buf->œ° - 
p
) {

108 
l
->
buf
->
œ°
 = 
	`ngx_˝ymem
÷->buf->œ°, 
p
,

109 
ö
->
buf
->
œ°
 - 
p
);

110 
ö
 = in->
√xt
;

111 i‡(
ö
 =
NULL
) {

112 
d⁄e
;

114 
p
 = 
ö
->
buf
->
pos
;

117 
size
 = 
l
->
buf
->
íd
 -Ü->buf->
œ°
;

118 
l
->
buf
->
œ°
 = 
	`ngx_˝ymem
÷->buf->œ°, 
p
, 
size
);

119 
p
 +
size
;

122 
d⁄e
:

123 *
Œ
 = 
NULL
;

125  
hód
;

126 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_stat_module.c

7 
	~<ngx_c⁄fig.h
>

8 
	~<ngx_c‹e.h
>

9 
	~<ngx_hâp.h
>

10 
	~<ngöx.h
>

11 
	~"ngx_πmp.h
"

12 
	~"ngx_πmp_vîsi⁄.h
"

13 
	~"ngx_πmp_live_moduÀ.h
"

14 
	~"ngx_πmp_∂ay_moduÀ.h
"

15 
	~"ngx_πmp_codec_moduÀ.h
"

18 
ngx_öt_t
 
ngx_πmp_°©_öô_¥o˚ss
(
ngx_cy˛e_t
 *
cy˛e
);

19 *
ngx_πmp_°©
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
);

20 
ngx_öt_t
 
ngx_πmp_°©_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
);

21 * 
ngx_πmp_°©_¸óã_loc_c⁄f
(
ngx_c⁄f_t
 *
cf
);

22 * 
ngx_πmp_°©_mîge_loc_c⁄f
(
ngx_c⁄f_t
 *
cf
,

23 *
∑ª¡
, *
chûd
);

26 
time_t
 
	g°¨t_time
;

29 
	#NGX_RTMP_STAT_ALL
 0xff

	)

30 
	#NGX_RTMP_STAT_GLOBAL
 0x01

	)

31 
	#NGX_RTMP_STAT_LIVE
 0x02

	)

32 
	#NGX_RTMP_STAT_CLIENTS
 0x04

	)

33 
	#NGX_RTMP_STAT_PLAY
 0x08

	)

41 
ngx_uöt_t
 
	m°©
;

42 
ngx_°r_t
 
	m°yÀshìt
;

43 } 
	tngx_πmp_°©_loc_c⁄f_t
;

46 
ngx_c⁄f_bômask_t
 
	gngx_πmp_°©_masks
[] = {

47 { 
ngx_°rög
("Æl"), 
NGX_RTMP_STAT_ALL
 },

48 { 
ngx_°rög
("globÆ"), 
NGX_RTMP_STAT_GLOBAL
 },

49 { 
ngx_°rög
("live"), 
NGX_RTMP_STAT_LIVE
 },

50 { 
ngx_°rög
("˛õ¡s"), 
NGX_RTMP_STAT_CLIENTS
 },

51 { 
ngx_nuŒ_°rög
, 0 }

55 
ngx_comm™d_t
 
	gngx_πmp_°©_comm™ds
[] = {

57 { 
ngx_°rög
("rtmp_stat"),

58 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_1MORE
,

59 
ngx_πmp_°©
,

60 
NGX_HTTP_LOC_CONF_OFFSET
,

61 
off£tof
(
ngx_πmp_°©_loc_c⁄f_t
, 
°©
),

62 
ngx_πmp_°©_masks
 },

64 { 
ngx_°rög
("rtmp_stat_stylesheet"),

65 
NGX_HTTP_MAIN_CONF
|
NGX_HTTP_SRV_CONF
|
NGX_HTTP_LOC_CONF
|
NGX_CONF_TAKE1
,

66 
ngx_c⁄f_£t_°r_¶Ÿ
,

67 
NGX_HTTP_LOC_CONF_OFFSET
,

68 
off£tof
(
ngx_πmp_°©_loc_c⁄f_t
, 
°yÀshìt
),

69 
NULL
 },

71 
ngx_nuŒ_comm™d


75 
ngx_hâp_moduÀ_t
 
	gngx_πmp_°©_moduÀ_˘x
 = {

76 
NULL
,

77 
ngx_πmp_°©_po°c⁄figuøti⁄
,

79 
NULL
,

80 
NULL
,

82 
NULL
,

83 
NULL
,

85 
ngx_πmp_°©_¸óã_loc_c⁄f
,

86 
ngx_πmp_°©_mîge_loc_c⁄f
,

90 
ngx_moduÀ_t
 
	gngx_πmp_°©_moduÀ
 = {

91 
NGX_MODULE_V1
,

92 &
ngx_πmp_°©_moduÀ_˘x
,

93 
ngx_πmp_°©_comm™ds
,

94 
NGX_HTTP_MODULE
,

95 
NULL
,

96 
NULL
,

97 
ngx_πmp_°©_öô_¥o˚ss
,

98 
NULL
,

99 
NULL
,

100 
NULL
,

101 
NULL
,

102 
NGX_MODULE_V1_PADDING


106 
	#NGX_RTMP_STAT_BUFSIZE
 256

	)

109 
ngx_öt_t


110 
	$ngx_πmp_°©_öô_¥o˚ss
(
ngx_cy˛e_t
 *
cy˛e
)

118 
	`ngx_evít_¥o˚ss_po°ed
(
cy˛e
, &
ngx_πmp_öô_queue
);

120  
NGX_OK
;

121 
	}
}

128 
	$ngx_πmp_°©_esˇ≥
(
ngx_hâp_ªque°_t
 *
r
, *
d©a
, 
size_t
 
Àn
)

130 
u_ch¨
 *
p
, *
≈
;

131 *
√w_d©a
;

132 
size_t
 
n
;

134 
p
 = 
d©a
;

136 
n
 = 0;Ç < 
Àn
; ++n, ++
p
) {

137 i‡(*
p
 < 0x20 || *p >= 0x7f) {

142 i‡(
n
 =
Àn
) {

143  
d©a
;

146 
√w_d©a
 = 
	`ngx_∑Œoc
(
r
->
poﬁ
, 
Àn
);

147 i‡(
√w_d©a
 =
NULL
) {

148  
NULL
;

151 
p
 = 
d©a
;

152 
≈
 = 
√w_d©a
;

154 
n
 = 0;Ç < 
Àn
; ++n, ++
p
, ++
≈
) {

155 *
≈
 = (*
p
 < 0x20 || *∞>0x7fË? (
u_ch¨
) ' ' : *p;

158  
√w_d©a
;

159 
	}
}

161 #i‡(
NGX_WIN32
)

166 
	$__de˛•ec
(
noölöe
)

170 
	$ngx_πmp_°©_ouçut
(
ngx_hâp_ªque°_t
 *
r
, 
ngx_chaö_t
 ***
Œl
,

171 *
d©a
, 
size_t
 
Àn
, 
ngx_uöt_t
 
esˇ≥
)

173 
ngx_chaö_t
 *
˛
;

174 
ngx_buf_t
 *
b
;

175 
size_t
 
ªÆ_Àn
;

177 i‡(
Àn
 == 0) {

181 i‡(
esˇ≥
) {

182 
d©a
 = 
	`ngx_πmp_°©_esˇ≥
(
r
, d©a, 
Àn
);

183 i‡(
d©a
 =
NULL
) {

188 
ªÆ_Àn
 = 
esˇ≥


189 ? 
Àn
 + 
	`ngx_esˇ≥_html
(
NULL
, 
d©a
,Üen)

190 : 
Àn
;

192 
˛
 = **
Œl
;

193 i‡(
˛
 && cl->
buf
->
œ°
 + 
ªÆ_Àn
 > cl->buf->
íd
) {

194 *
Œl
 = &
˛
->
√xt
;

197 i‡(**
Œl
 =
NULL
) {

198 
˛
 = 
	`ngx_Æloc_chaö_lök
(
r
->
poﬁ
);

199 i‡(
˛
 =
NULL
) {

202 
b
 = 
	`ngx_¸óã_ãmp_buf
(
r
->
poﬁ
,

203 
	`ngx_max
(
NGX_RTMP_STAT_BUFSIZE
, 
ªÆ_Àn
));

204 i‡(
b
 =
NULL
 || b->
pos
 == NULL) {

207 
˛
->
√xt
 = 
NULL
;

208 
˛
->
buf
 = 
b
;

209 **
Œl
 = 
˛
;

212 
b
 = (**
Œl
)->
buf
;

214 i‡(
esˇ≥
) {

215 
b
->
œ°
 = (
u_ch¨
 *)
	`ngx_esˇ≥_html
(b->œ°, 
d©a
, 
Àn
);

217 
b
->
œ°
 = 
	`ngx_˝ymem
(b->œ°, 
d©a
, 
Àn
);

219 
	}
}

227 
	#NGX_RTMP_STAT
(
d©a
, 
Àn
Ë
	`ngx_πmp_°©_ouçut
(
r
, 
Œl
, d©a,Üí, 0)

	)

230 
	#NGX_RTMP_STAT_E
(
d©a
, 
Àn
Ë
	`ngx_πmp_°©_ouçut
(
r
, 
Œl
, d©a,Üí, 1)

	)

233 
	#NGX_RTMP_STAT_L
(
s
Ë
	`NGX_RTMP_STAT
((s), (sË- 1)

	)

236 
	#NGX_RTMP_STAT_S
(
s
Ë
	`NGX_RTMP_STAT
((s)->
d©a
, (s)->
Àn
)

	)

239 
	#NGX_RTMP_STAT_ES
(
s
Ë
	`NGX_RTMP_STAT_E
((s)->
d©a
, (s)->
Àn
)

	)

242 
	#NGX_RTMP_STAT_CS
(
s
Ë
	`NGX_RTMP_STAT
((s), 
	`ngx_°æí
(s))

	)

245 
	#NGX_RTMP_STAT_ECS
(
s
Ë
	`NGX_RTMP_STAT_E
((s), 
	`ngx_°æí
(s))

	)

248 
	#NGX_RTMP_STAT_BW
 0x01

	)

249 
	#NGX_RTMP_STAT_BYTES
 0x02

	)

250 
	#NGX_RTMP_STAT_BW_BYTES
 0x03

	)

254 
	$ngx_πmp_°©_bw
(
ngx_hâp_ªque°_t
 *
r
, 
ngx_chaö_t
 ***
Œl
,

255 
ngx_πmp_b™dwidth_t
 *
bw
, *
«me
,

256 
ngx_uöt_t
 
Êags
)

258 
u_ch¨
 
buf
[
NGX_INT64_LEN
 + 9];

260 
	`ngx_πmp_upd©e_b™dwidth
(
bw
, 0);

262 i‡(
Êags
 & 
NGX_RTMP_STAT_BW
) {

263 
	`NGX_RTMP_STAT_L
("<bw_");

264 
	`NGX_RTMP_STAT_CS
(
«me
);

265 
	`NGX_RTMP_STAT
(
buf
, 
	`ngx_¢¥ötf
(buf, (buf), ">%uL</bw_",

266 
bw
->
b™dwidth
 * 8)

267 - 
buf
);

268 
	`NGX_RTMP_STAT_CS
(
«me
);

269 
	`NGX_RTMP_STAT_L
(">\r\n");

272 i‡(
Êags
 & 
NGX_RTMP_STAT_BYTES
) {

273 
	`NGX_RTMP_STAT_L
("<bytes_");

274 
	`NGX_RTMP_STAT_CS
(
«me
);

275 
	`NGX_RTMP_STAT
(
buf
, 
	`ngx_¢¥ötf
(buf, (buf), ">%uL</bytes_",

276 
bw
->
byãs
)

277 - 
buf
);

278 
	`NGX_RTMP_STAT_CS
(
«me
);

279 
	`NGX_RTMP_STAT_L
(">\r\n");

281 
	}
}

284 #ifde‡
NGX_RTMP_POOL_DEBUG


286 
	$ngx_πmp_°©_gë_poﬁ_size
(
ngx_poﬁ_t
 *
poﬁ
, 
ngx_uöt_t
 *
∆¨ge
,

287 
ngx_uöt_t
 *
size
)

289 
ngx_poﬁ_œrge_t
 *
l
;

290 
ngx_poﬁ_t
 *
p
, *
n
;

292 *
∆¨ge
 = 0;

293 
l
 = 
poﬁ
->
œrge
;Ü;Ü =Ü->
√xt
) {

294 ++*
∆¨ge
;

297 *
size
 = 0;

298 
p
 = 
poﬁ
, 
n
 =Öoﬁ->
d
.
√xt
; ;Ö =Ç,Ç =Ç->d.next) {

299 *
size
 +(
p
->
d
.
œ°
 - (
u_ch¨
 *)p);

300 i‡(
n
 =
NULL
) {

304 
	}
}

308 
	$ngx_πmp_°©_dump_poﬁ
(
ngx_hâp_ªque°_t
 *
r
, 
ngx_chaö_t
 ***
Œl
,

309 
ngx_poﬁ_t
 *
poﬁ
)

311 
ngx_uöt_t
 
∆¨ge
, 
size
;

312 
u_ch¨
 
buf
[
NGX_INT_T_LEN
];

314 
size
 = 0;

315 
∆¨ge
 = 0;

316 
	`ngx_πmp_°©_gë_poﬁ_size
(
poﬁ
, &
∆¨ge
, &
size
);

317 
	`NGX_RTMP_STAT_L
("<pool><nlarge>");

318 
	`NGX_RTMP_STAT
(
buf
, 
	`ngx_¢¥ötf
(buf, (buf), "%ui", 
∆¨ge
) - buf);

319 
	`NGX_RTMP_STAT_L
("</nlarge><size>");

320 
	`NGX_RTMP_STAT
(
buf
, 
	`ngx_¢¥ötf
(buf, (buf), "%ui", 
size
) - buf);

321 
	`NGX_RTMP_STAT_L
("</size></pool>\r\n");

322 
	}
}

328 
	$ngx_πmp_°©_˛õ¡
(
ngx_hâp_ªque°_t
 *
r
, 
ngx_chaö_t
 ***
Œl
,

329 
ngx_πmp_£ssi⁄_t
 *
s
)

331 
u_ch¨
 
buf
[
NGX_INT_T_LEN
];

333 #ifde‡
NGX_RTMP_POOL_DEBUG


334 
	`ngx_πmp_°©_dump_poﬁ
(
r
, 
Œl
, 
s
->
c⁄√˘i⁄
->
poﬁ
);

336 
	`NGX_RTMP_STAT_L
("<id>");

337 
	`NGX_RTMP_STAT
(
buf
, 
	`ngx_¢¥ötf
(buf, (buf), "%ui",

338 (
ngx_uöt_t
Ë
s
->
c⁄√˘i⁄
->
numbî
Ë- 
buf
);

339 
	`NGX_RTMP_STAT_L
("</id>");

341 
	`NGX_RTMP_STAT_L
("<address>");

342 
	`NGX_RTMP_STAT_ES
(&
s
->
c⁄√˘i⁄
->
addr_ãxt
);

343 
	`NGX_RTMP_STAT_L
("</address>");

345 
	`NGX_RTMP_STAT_L
("<time>");

346 
	`NGX_RTMP_STAT
(
buf
, 
	`ngx_¢¥ötf
(buf, (buf), "%i",

347 (
ngx_öt_t
Ë(
ngx_cuºít_m£c
 - 
s
->
ïoch
)Ë- 
buf
);

348 
	`NGX_RTMP_STAT_L
("</time>");

350 i‡(
s
->
Êashvî
.
Àn
) {

351 
	`NGX_RTMP_STAT_L
("<flashver>");

352 
	`NGX_RTMP_STAT_ES
(&
s
->
Êashvî
);

353 
	`NGX_RTMP_STAT_L
("</flashver>");

356 i‡(
s
->
∑ge_uæ
.
Àn
) {

357 
	`NGX_RTMP_STAT_L
("<pageurl>");

358 
	`NGX_RTMP_STAT_ES
(&
s
->
∑ge_uæ
);

359 
	`NGX_RTMP_STAT_L
("</pageurl>");

362 i‡(
s
->
swf_uæ
.
Àn
) {

363 
	`NGX_RTMP_STAT_L
("<swfurl>");

364 
	`NGX_RTMP_STAT_ES
(&
s
->
swf_uæ
);

365 
	`NGX_RTMP_STAT_L
("</swfurl>");

367 
	}
}

371 
	$ngx_πmp_°©_gë_Øc_¥ofûe
(
ngx_uöt_t
 
p
,Çgx_uöt_à
sbr
,Çgx_uöt_à
ps
) {

372 
p
) {

376 i‡(
ps
) {

379 i‡(
sbr
) {

392 
	}
}

396 
	$ngx_πmp_°©_gë_avc_¥ofûe
(
ngx_uöt_t
 
p
) {

397 
p
) {

407 
	}
}

411 
	$ngx_πmp_°©_live
(
ngx_hâp_ªque°_t
 *
r
, 
ngx_chaö_t
 ***
Œl
,

412 
ngx_πmp_live_≠p_c⁄f_t
 *
œcf
)

414 
ngx_πmp_live_°ªam_t
 *
°ªam
;

415 
ngx_πmp_codec_˘x_t
 *
codec
;

416 
ngx_πmp_live_˘x_t
 *
˘x
;

417 
ngx_πmp_£ssi⁄_t
 *
s
;

418 
ngx_öt_t
 
n
;

419 
ngx_uöt_t
 
n˛õ¡s
, 
tŸÆ_n˛õ¡s
;

420 
u_ch¨
 
buf
[
NGX_INT_T_LEN
];

421 
u_ch¨
 
bbuf
[
NGX_INT32_LEN
];

422 
ngx_πmp_°©_loc_c⁄f_t
 *
¶cf
;

423 
u_ch¨
 *
˙ame
;

425 i‡(!
œcf
->
live
) {

429 
¶cf
 = 
	`ngx_hâp_gë_moduÀ_loc_c⁄f
(
r
, 
ngx_πmp_°©_moduÀ
);

431 
	`NGX_RTMP_STAT_L
("<live>\r\n");

433 
tŸÆ_n˛õ¡s
 = 0;

434 
n
 = 0;Ç < 
œcf
->
nbuckës
; ++n) {

435 
°ªam
 = 
œcf
->
°ªams
[
n
]; såóm; såóm = såóm->
√xt
) {

436 
	`NGX_RTMP_STAT_L
("<stream>\r\n");

438 
	`NGX_RTMP_STAT_L
("<name>");

439 
	`NGX_RTMP_STAT_ECS
(
°ªam
->
«me
);

440 
	`NGX_RTMP_STAT_L
("</name>\r\n");

442 
	`NGX_RTMP_STAT_L
("<time>");

443 
	`NGX_RTMP_STAT
(
buf
, 
	`ngx_¢¥ötf
(buf, (buf), "%i",

444 (
ngx_öt_t
Ë(
ngx_cuºít_m£c
 - 
°ªam
->
ïoch
))

445 - 
buf
);

446 
	`NGX_RTMP_STAT_L
("</time>");

448 
	`ngx_πmp_°©_bw
(
r
, 
Œl
, &
°ªam
->
bw_ö
, "in",

449 
NGX_RTMP_STAT_BW_BYTES
);

450 
	`ngx_πmp_°©_bw
(
r
, 
Œl
, &
°ªam
->
bw_out
, "out",

451 
NGX_RTMP_STAT_BW_BYTES
);

452 
	`ngx_πmp_°©_bw
(
r
, 
Œl
, &
°ªam
->
bw_ö_audio
, "audio",

453 
NGX_RTMP_STAT_BW
);

454 
	`ngx_πmp_°©_bw
(
r
, 
Œl
, &
°ªam
->
bw_ö_video
, "video",

455 
NGX_RTMP_STAT_BW
);

457 
n˛õ¡s
 = 0;

458 
codec
 = 
NULL
;

459 
˘x
 = 
°ªam
->˘x; ctx; ctx = ctx->
√xt
, ++
n˛õ¡s
) {

460 
s
 = 
˘x
->
£ssi⁄
;

461 i‡(
¶cf
->
°©
 & 
NGX_RTMP_STAT_CLIENTS
) {

462 
	`NGX_RTMP_STAT_L
("<client>");

464 
	`ngx_πmp_°©_˛õ¡
(
r
, 
Œl
, 
s
);

466 
	`NGX_RTMP_STAT_L
("<dropped>");

467 
	`NGX_RTMP_STAT
(
buf
, 
	`ngx_¢¥ötf
(buf, (buf),

468 "%ui", 
˘x
->
ndr›≥d
Ë- 
buf
);

469 
	`NGX_RTMP_STAT_L
("</dropped>");

471 
	`NGX_RTMP_STAT_L
("<avsync>");

472 i‡(!
œcf
->
öãæóve
) {

473 
	`NGX_RTMP_STAT
(
bbuf
, 
	`ngx_¢¥ötf
(bbuf, (bbuf),

474 "%D", 
˘x
->
cs
[1].
time°amp
 -

475 
˘x
->
cs
[0].
time°amp
Ë- 
bbuf
);

477 
	`NGX_RTMP_STAT_L
("</avsync>");

479 
	`NGX_RTMP_STAT_L
("<timestamp>");

480 
	`NGX_RTMP_STAT
(
bbuf
, 
	`ngx_¢¥ötf
(bbuf, (bbuf),

481 "%D", 
s
->
cuºít_time
Ë- 
bbuf
);

482 
	`NGX_RTMP_STAT_L
("</timestamp>");

484 i‡(
˘x
->
publishög
) {

485 
	`NGX_RTMP_STAT_L
("<publishing/>");

488 i‡(
˘x
->
a˘ive
) {

489 
	`NGX_RTMP_STAT_L
("<active/>");

492 
	`NGX_RTMP_STAT_L
("</client>\r\n");

494 i‡(
˘x
->
publishög
) {

495 
codec
 = 
	`ngx_πmp_gë_moduÀ_˘x
(
s
, 
ngx_πmp_codec_moduÀ
);

498 
tŸÆ_n˛õ¡s
 +
n˛õ¡s
;

500 i‡(
codec
) {

501 
	`NGX_RTMP_STAT_L
("<meta>");

503 
	`NGX_RTMP_STAT_L
("<video>");

504 
	`NGX_RTMP_STAT_L
("<width>");

505 
	`NGX_RTMP_STAT
(
buf
, 
	`ngx_¢¥ötf
(buf, (buf),

506 "%ui", 
codec
->
width
Ë- 
buf
);

507 
	`NGX_RTMP_STAT_L
("</width><height>");

508 
	`NGX_RTMP_STAT
(
buf
, 
	`ngx_¢¥ötf
(buf, (buf),

509 "%ui", 
codec
->
height
Ë- 
buf
);

510 
	`NGX_RTMP_STAT_L
("</height><frame_rate>");

511 
	`NGX_RTMP_STAT
(
buf
, 
	`ngx_¢¥ötf
(buf, (buf),

512 "%ui", 
codec
->
‰ame_øã
Ë- 
buf
);

513 
	`NGX_RTMP_STAT_L
("</frame_rate>");

515 
˙ame
 = 
	`ngx_πmp_gë_video_codec_«me
(
codec
->
video_codec_id
);

516 i‡(*
˙ame
) {

517 
	`NGX_RTMP_STAT_L
("<codec>");

518 
	`NGX_RTMP_STAT_ECS
(
˙ame
);

519 
	`NGX_RTMP_STAT_L
("</codec>");

521 i‡(
codec
->
avc_¥ofûe
) {

522 
	`NGX_RTMP_STAT_L
("<profile>");

523 
	`NGX_RTMP_STAT_CS
(

524 
	`ngx_πmp_°©_gë_avc_¥ofûe
(
codec
->
avc_¥ofûe
));

525 
	`NGX_RTMP_STAT_L
("</profile>");

527 i‡(
codec
->
avc_Àvñ
) {

528 
	`NGX_RTMP_STAT_L
("<compat>");

529 
	`NGX_RTMP_STAT
(
buf
, 
	`ngx_¢¥ötf
(buf, (buf),

530 "%ui", 
codec
->
avc_com∑t
Ë- 
buf
);

531 
	`NGX_RTMP_STAT_L
("</compat>");

533 i‡(
codec
->
avc_Àvñ
) {

534 
	`NGX_RTMP_STAT_L
("<level>");

535 
	`NGX_RTMP_STAT
(
buf
, 
	`ngx_¢¥ötf
(buf, (buf),

536 "%.1f", 
codec
->
avc_Àvñ
 / 10.Ë- 
buf
);

537 
	`NGX_RTMP_STAT_L
("</level>");

539 
	`NGX_RTMP_STAT_L
("</video>");

541 
	`NGX_RTMP_STAT_L
("<audio>");

542 
˙ame
 = 
	`ngx_πmp_gë_audio_codec_«me
(
codec
->
audio_codec_id
);

543 i‡(*
˙ame
) {

544 
	`NGX_RTMP_STAT_L
("<codec>");

545 
	`NGX_RTMP_STAT_ECS
(
˙ame
);

546 
	`NGX_RTMP_STAT_L
("</codec>");

548 i‡(
codec
->
Øc_¥ofûe
) {

549 
	`NGX_RTMP_STAT_L
("<profile>");

550 
	`NGX_RTMP_STAT_CS
(

551 
	`ngx_πmp_°©_gë_Øc_¥ofûe
(
codec
->
Øc_¥ofûe
,

552 
codec
->
Øc_sbr
,

553 
codec
->
Øc_ps
));

554 
	`NGX_RTMP_STAT_L
("</profile>");

556 i‡(
codec
->
Øc_ch™_c⁄f
) {

557 
	`NGX_RTMP_STAT_L
("<channels>");

558 
	`NGX_RTMP_STAT
(
buf
, 
	`ngx_¢¥ötf
(buf, (buf),

559 "%ui", 
codec
->
Øc_ch™_c⁄f
Ë- 
buf
);

560 
	`NGX_RTMP_STAT_L
("</channels>");

561 } i‡(
codec
->
audio_ch™√ls
) {

562 
	`NGX_RTMP_STAT_L
("<channels>");

563 
	`NGX_RTMP_STAT
(
buf
, 
	`ngx_¢¥ötf
(buf, (buf),

564 "%ui", 
codec
->
audio_ch™√ls
Ë- 
buf
);

565 
	`NGX_RTMP_STAT_L
("</channels>");

567 i‡(
codec
->
ßm∂e_øã
) {

568 
	`NGX_RTMP_STAT_L
("<sample_rate>");

569 
	`NGX_RTMP_STAT
(
buf
, 
	`ngx_¢¥ötf
(buf, (buf),

570 "%ui", 
codec
->
ßm∂e_øã
Ë- 
buf
);

571 
	`NGX_RTMP_STAT_L
("</sample_rate>");

573 
	`NGX_RTMP_STAT_L
("</audio>");

575 
	`NGX_RTMP_STAT_L
("</meta>\r\n");

578 
	`NGX_RTMP_STAT_L
("<nclients>");

579 
	`NGX_RTMP_STAT
(
buf
, 
	`ngx_¢¥ötf
(buf, (buf),

580 "%ui", 
n˛õ¡s
Ë- 
buf
);

581 
	`NGX_RTMP_STAT_L
("</nclients>\r\n");

583 i‡(
°ªam
->
publishög
) {

584 
	`NGX_RTMP_STAT_L
("<publishing/>\r\n");

587 i‡(
°ªam
->
a˘ive
) {

588 
	`NGX_RTMP_STAT_L
("<active/>\r\n");

591 
	`NGX_RTMP_STAT_L
("</stream>\r\n");

595 
	`NGX_RTMP_STAT_L
("<nclients>");

596 
	`NGX_RTMP_STAT
(
buf
, 
	`ngx_¢¥ötf
(buf, (buf),

597 "%ui", 
tŸÆ_n˛õ¡s
Ë- 
buf
);

598 
	`NGX_RTMP_STAT_L
("</nclients>\r\n");

600 
	`NGX_RTMP_STAT_L
("</live>\r\n");

601 
	}
}

605 
	$ngx_πmp_°©_∂ay
(
ngx_hâp_ªque°_t
 *
r
, 
ngx_chaö_t
 ***
Œl
,

606 
ngx_πmp_∂ay_≠p_c⁄f_t
 *
∑cf
)

608 
ngx_πmp_∂ay_˘x_t
 *
˘x
, *
s˘x
;

609 
ngx_πmp_£ssi⁄_t
 *
s
;

610 
ngx_uöt_t
 
n
, 
n˛õ¡s
, 
tŸÆ_n˛õ¡s
;

611 
u_ch¨
 
buf
[
NGX_INT_T_LEN
];

612 
u_ch¨
 
bbuf
[
NGX_INT32_LEN
];

613 
ngx_πmp_°©_loc_c⁄f_t
 *
¶cf
;

615 i‡(
∑cf
->
íåõs
.
√…s
 == 0) {

619 
¶cf
 = 
	`ngx_hâp_gë_moduÀ_loc_c⁄f
(
r
, 
ngx_πmp_°©_moduÀ
);

621 
	`NGX_RTMP_STAT_L
("<play>\r\n");

623 
tŸÆ_n˛õ¡s
 = 0;

624 
n
 = 0;Ç < 
∑cf
->
nbuckës
; ++n) {

625 
˘x
 = 
∑cf
->˘x[
n
]; ctx; ) {

626 
	`NGX_RTMP_STAT_L
("<stream>\r\n");

628 
	`NGX_RTMP_STAT_L
("<name>");

629 
	`NGX_RTMP_STAT_ECS
(
˘x
->
«me
);

630 
	`NGX_RTMP_STAT_L
("</name>\r\n");

632 
n˛õ¡s
 = 0;

633 
s˘x
 = 
˘x
;

634 ; 
˘x
; ctx = ctx->
√xt
) {

635 i‡(
	`ngx_°rcmp
(
˘x
->
«me
, 
s˘x
->name)) {

639 
n˛õ¡s
++;

641 
s
 = 
˘x
->
£ssi⁄
;

642 i‡(
¶cf
->
°©
 & 
NGX_RTMP_STAT_CLIENTS
) {

643 
	`NGX_RTMP_STAT_L
("<client>");

645 
	`ngx_πmp_°©_˛õ¡
(
r
, 
Œl
, 
s
);

647 
	`NGX_RTMP_STAT_L
("<timestamp>");

648 
	`NGX_RTMP_STAT
(
bbuf
, 
	`ngx_¢¥ötf
(bbuf, (bbuf),

649 "%D", 
s
->
cuºít_time
Ë- 
bbuf
);

650 
	`NGX_RTMP_STAT_L
("</timestamp>");

652 
	`NGX_RTMP_STAT_L
("</client>\r\n");

655 
tŸÆ_n˛õ¡s
 +
n˛õ¡s
;

657 
	`NGX_RTMP_STAT_L
("<active/>");

658 
	`NGX_RTMP_STAT_L
("<nclients>");

659 
	`NGX_RTMP_STAT
(
buf
, 
	`ngx_¢¥ötf
(buf, (buf),

660 "%ui", 
n˛õ¡s
Ë- 
buf
);

661 
	`NGX_RTMP_STAT_L
("</nclients>\r\n");

663 
	`NGX_RTMP_STAT_L
("</stream>\r\n");

667 
	`NGX_RTMP_STAT_L
("<nclients>");

668 
	`NGX_RTMP_STAT
(
buf
, 
	`ngx_¢¥ötf
(buf, (buf),

669 "%ui", 
tŸÆ_n˛õ¡s
Ë- 
buf
);

670 
	`NGX_RTMP_STAT_L
("</nclients>\r\n");

672 
	`NGX_RTMP_STAT_L
("</play>\r\n");

673 
	}
}

677 
	$ngx_πmp_°©_≠∂iˇti⁄
(
ngx_hâp_ªque°_t
 *
r
, 
ngx_chaö_t
 ***
Œl
,

678 
ngx_πmp_c‹e_≠p_c⁄f_t
 *
ˇcf
)

680 
ngx_πmp_°©_loc_c⁄f_t
 *
¶cf
;

682 
	`NGX_RTMP_STAT_L
("<application>\r\n");

683 
	`NGX_RTMP_STAT_L
("<name>");

684 
	`NGX_RTMP_STAT_ES
(&
ˇcf
->
«me
);

685 
	`NGX_RTMP_STAT_L
("</name>\r\n");

687 
¶cf
 = 
	`ngx_hâp_gë_moduÀ_loc_c⁄f
(
r
, 
ngx_πmp_°©_moduÀ
);

689 i‡(
¶cf
->
°©
 & 
NGX_RTMP_STAT_LIVE
) {

690 
	`ngx_πmp_°©_live
(
r
, 
Œl
,

691 
ˇcf
->
≠p_c⁄f
[
ngx_πmp_live_moduÀ
.
˘x_ödex
]);

694 i‡(
¶cf
->
°©
 & 
NGX_RTMP_STAT_PLAY
) {

695 
	`ngx_πmp_°©_∂ay
(
r
, 
Œl
,

696 
ˇcf
->
≠p_c⁄f
[
ngx_πmp_∂ay_moduÀ
.
˘x_ödex
]);

699 
	`NGX_RTMP_STAT_L
("</application>\r\n");

700 
	}
}

704 
	$ngx_πmp_°©_£rvî
(
ngx_hâp_ªque°_t
 *
r
, 
ngx_chaö_t
 ***
Œl
,

705 
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
)

707 
ngx_πmp_c‹e_≠p_c⁄f_t
 **
ˇcf
;

708 
size_t
 
n
;

710 
	`NGX_RTMP_STAT_L
("<server>\r\n");

712 #ifde‡
NGX_RTMP_POOL_DEBUG


713 
	`ngx_πmp_°©_dump_poﬁ
(
r
, 
Œl
, 
cscf
->
poﬁ
);

716 
ˇcf
 = 
cscf
->
≠∂iˇti⁄s
.
ñts
;

717 
n
 = 0;Ç < 
cscf
->
≠∂iˇti⁄s
.
√…s
; ++n, ++
ˇcf
) {

718 
	`ngx_πmp_°©_≠∂iˇti⁄
(
r
, 
Œl
, *
ˇcf
);

721 
	`NGX_RTMP_STAT_L
("</server>\r\n");

722 
	}
}

725 
ngx_öt_t


726 
	$ngx_πmp_°©_h™dÀr
(
ngx_hâp_ªque°_t
 *
r
)

728 
ngx_πmp_°©_loc_c⁄f_t
 *
¶cf
;

729 
ngx_πmp_c‹e_maö_c⁄f_t
 *
cmcf
;

730 
ngx_πmp_c‹e_§v_c⁄f_t
 **
cscf
;

731 
ngx_chaö_t
 *
˛
, *
l
, **
Œ
, ***
Œl
;

732 
size_t
 
n
;

733 
off_t
 
Àn
;

734 
u_ch¨
 
tbuf
[
NGX_TIME_T_LEN
];

735 
u_ch¨
 
nbuf
[
NGX_INT_T_LEN
];

737 
¶cf
 = 
	`ngx_hâp_gë_moduÀ_loc_c⁄f
(
r
, 
ngx_πmp_°©_moduÀ
);

738 i‡(
¶cf
->
°©
 == 0) {

739  
NGX_DECLINED
;

742 
cmcf
 = 
ngx_πmp_c‹e_maö_c⁄f
;

743 i‡(
cmcf
 =
NULL
) {

744 
îr‹
;

747 
˛
 = 
NULL
;

748 
Œ
 = &
˛
;

749 
Œl
 = &
Œ
;

751 
	`NGX_RTMP_STAT_L
("<?xml version=\"1.0\"Éncoding=\"utf-8\" ?>\r\n");

752 i‡(
¶cf
->
°yÀshìt
.
Àn
) {

753 
	`NGX_RTMP_STAT_L
("<?xml-stylesheetÅype=\"text/xsl\" href=\"");

754 
	`NGX_RTMP_STAT_ES
(&
¶cf
->
°yÀshìt
);

755 
	`NGX_RTMP_STAT_L
("\" ?>\r\n");

758 
	`NGX_RTMP_STAT_L
("<rtmp>\r\n");

760 #ifde‡
NGINX_VERSION


761 
	`NGX_RTMP_STAT_L
("<ngöx_vîsi⁄>" 
NGINX_VERSION
 "</nginx_version>\r\n");

764 #ifde‡
NGINX_RTMP_VERSION


765 
	`NGX_RTMP_STAT_L
("<ngöx_πmp_vîsi⁄>" 
NGINX_RTMP_VERSION
 "</nginx_rtmp_version>\r\n");

768 #ifde‡
NGX_COMPILER


769 
	`NGX_RTMP_STAT_L
("<compûî>" 
NGX_COMPILER
 "</compiler>\r\n");

771 
	`NGX_RTMP_STAT_L
("<buût>" 
__DATE__
 " " 
__TIME__
 "</built>\r\n");

773 
	`NGX_RTMP_STAT_L
("<pid>");

774 
	`NGX_RTMP_STAT
(
nbuf
, 
	`ngx_¢¥ötf
(nbuf, (nbuf),

775 "%ui", (
ngx_uöt_t
Ë
	`ngx_gëpid
()Ë- 
nbuf
);

776 
	`NGX_RTMP_STAT_L
("</pid>\r\n");

778 
	`NGX_RTMP_STAT_L
("<uptime>");

779 
	`NGX_RTMP_STAT
(
tbuf
, 
	`ngx_¢¥ötf
(tbuf, (tbuf),

780 "%T", 
ngx_ˇched_time
->
£c
 - 
°¨t_time
Ë- 
tbuf
);

781 
	`NGX_RTMP_STAT_L
("</uptime>\r\n");

783 
	`NGX_RTMP_STAT_L
("<naccepted>");

784 
	`NGX_RTMP_STAT
(
nbuf
, 
	`ngx_¢¥ötf
(nbuf, (nbuf),

785 "%ui", 
ngx_πmp_«c˚±ed
Ë- 
nbuf
);

786 
	`NGX_RTMP_STAT_L
("</naccepted>\r\n");

788 
	`ngx_πmp_°©_bw
(
r
, 
Œl
, &
ngx_πmp_bw_ö
, "ö", 
NGX_RTMP_STAT_BW_BYTES
);

789 
	`ngx_πmp_°©_bw
(
r
, 
Œl
, &
ngx_πmp_bw_out
, "out", 
NGX_RTMP_STAT_BW_BYTES
);

791 
cscf
 = 
cmcf
->
£rvîs
.
ñts
;

792 
n
 = 0;Ç < 
cmcf
->
£rvîs
.
√…s
; ++n, ++
cscf
) {

793 
	`ngx_πmp_°©_£rvî
(
r
, 
Œl
, *
cscf
);

796 
	`NGX_RTMP_STAT_L
("</rtmp>\r\n");

798 
Àn
 = 0;

799 
l
 = 
˛
;Ü;Ü =Ü->
√xt
) {

800 
Àn
 +(
l
->
buf
->
œ°
 -Ü->buf->
pos
);

802 
	`ngx_°r_£t
(&
r
->
hódîs_out
.
c⁄ã¡_ty≥
, "text/xml");

803 
r
->
hódîs_out
.
c⁄ã¡_Àngth_n
 = 
Àn
;

804 
r
->
hódîs_out
.
°©us
 = 
NGX_HTTP_OK
;

805 
	`ngx_hâp_£nd_hódî
(
r
);

806 (*
Œ
)->
buf
->
œ°_buf
 = 1;

807  
	`ngx_hâp_ouçut_fûãr
(
r
, 
˛
);

809 
îr‹
:

810 
r
->
hódîs_out
.
°©us
 = 
NGX_HTTP_INTERNAL_SERVER_ERROR
;

811 
r
->
hódîs_out
.
c⁄ã¡_Àngth_n
 = 0;

812  
	`ngx_hâp_£nd_hódî
(
r
);

813 
	}
}

817 
	$ngx_πmp_°©_¸óã_loc_c⁄f
(
ngx_c⁄f_t
 *
cf
)

819 
ngx_πmp_°©_loc_c⁄f_t
 *
c⁄f
;

821 
c⁄f
 = 
	`ngx_pˇŒoc
(
cf
->
poﬁ
, (
ngx_πmp_°©_loc_c⁄f_t
));

822 i‡(
c⁄f
 =
NULL
) {

823  
NULL
;

826 
c⁄f
->
°©
 = 0;

828  
c⁄f
;

829 
	}
}

833 
	$ngx_πmp_°©_mîge_loc_c⁄f
(
ngx_c⁄f_t
 *
cf
, *
∑ª¡
, *
chûd
)

835 
ngx_πmp_°©_loc_c⁄f_t
 *
¥ev
 = 
∑ª¡
;

836 
ngx_πmp_°©_loc_c⁄f_t
 *
c⁄f
 = 
chûd
;

838 
	`ngx_c⁄f_mîge_bômask_vÆue
(
c⁄f
->
°©
, 
¥ev
->stat, 0);

839 
	`ngx_c⁄f_mîge_°r_vÆue
(
c⁄f
->
°yÀshìt
, 
¥ev
->stylesheet, "");

841  
NGX_CONF_OK
;

842 
	}
}

846 
	$ngx_πmp_°©
(
ngx_c⁄f_t
 *
cf
, 
ngx_comm™d_t
 *
cmd
, *
c⁄f
)

848 
ngx_hâp_c‹e_loc_c⁄f_t
 *
˛cf
;

850 
˛cf
 = 
	`ngx_hâp_c⁄f_gë_moduÀ_loc_c⁄f
(
cf
, 
ngx_hâp_c‹e_moduÀ
);

851 
˛cf
->
h™dÀr
 = 
ngx_πmp_°©_h™dÀr
;

853  
	`ngx_c⁄f_£t_bômask_¶Ÿ
(
cf
, 
cmd
, 
c⁄f
);

854 
	}
}

857 
ngx_öt_t


858 
	$ngx_πmp_°©_po°c⁄figuøti⁄
(
ngx_c⁄f_t
 *
cf
)

860 
°¨t_time
 = 
ngx_ˇched_time
->
£c
;

862  
NGX_OK
;

863 
	}
}

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_streams.h

7 #i‚de‡
_NGX_RTMP_STREAMS_H_INCLUDED_


8 
	#_NGX_RTMP_STREAMS_H_INCLUDED_


	)

11 
	#NGX_RTMP_MSID
 1

	)

13 
	#NGX_RTMP_CSID_AMF_INI
 3

	)

14 
	#NGX_RTMP_CSID_AMF
 5

	)

15 
	#NGX_RTMP_CSID_AUDIO
 6

	)

16 
	#NGX_RTMP_CSID_VIDEO
 7

	)

	@/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_version.h

7 #i‚de‡
_NGX_RTMP_VERSION_H_INCLUDED_


8 
	#_NGX_RTMP_VERSION_H_INCLUDED_


	)

11 
	#ngöx_πmp_vîsi⁄
 1001004

	)

12 
	#NGINX_RTMP_VERSION
 "1.1.4"

	)

	@ngx_rtmp.h

7 #i‚de‡
_NGX_RTMP_H_INCLUDED_


8 
	#_NGX_RTMP_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

13 
	~<ngx_evít.h
>

14 
	~<ngx_evít_c⁄√˘.h
>

15 
	~<ngöx.h
>

17 
	~"ngx_πmp_amf.h
"

18 
	~"ngx_πmp_b™dwidth.h
"

21 #i‡(
NGX_WIN32
)

22 
__öt8
 
	töt8_t
;

23 
	t__öt8
 
	tuöt8_t
;

28 **
	mmaö_c⁄f
;

29 **
	m§v_c⁄f
;

30 **
	m≠p_c⁄f
;

31 } 
	tngx_πmp_c⁄f_˘x_t
;

35 
u_ch¨
 
	msockaddr
[
NGX_SOCKADDRLEN
];

36 
sockÀn_t
 
	msockÀn
;

39 
ngx_πmp_c⁄f_˘x_t
 *
	m˘x
;

41 
	mböd
:1;

42 
	mwûdˇrd
:1;

43 #i‡(
NGX_HAVE_INET6
 && 
deföed
 
IPV6_V6ONLY
)

44 
	mùv6⁄ly
:2;

46 
	mso_kì∑live
:2;

47 
	m¥oxy_¥Ÿocﬁ
:1;

48 #i‡(
NGX_HAVE_KEEPALIVE_TUNABLE
)

49 
	mt˝_kìpidÀ
;

50 
	mt˝_kìpötvl
;

51 
	mt˝_kìp˙t
;

53 } 
	tngx_πmp_li°í_t
;

57 
ngx_πmp_c⁄f_˘x_t
 *
	m˘x
;

58 
ngx_°r_t
 
	maddr_ãxt
;

59 
	m¥oxy_¥Ÿocﬁ
:1;

60 } 
	tngx_πmp_addr_c⁄f_t
;

63 
ö_addr_t
 
	maddr
;

64 
ngx_πmp_addr_c⁄f_t
 
	mc⁄f
;

65 } 
	tngx_πmp_ö_addr_t
;

68 #i‡(
NGX_HAVE_INET6
)

71 
ö6_addr
 
	maddr6
;

72 
ngx_πmp_addr_c⁄f_t
 
	mc⁄f
;

73 } 
	tngx_πmp_ö6_addr_t
;

79 *
	maddrs
;

80 
ngx_uöt_t
 
	m«ddrs
;

81 } 
	tngx_πmp_p‹t_t
;

85 
	mÁmûy
;

86 
ö_p‹t_t
 
	mp‹t
;

87 
ngx_¨øy_t
 
	maddrs
;

88 } 
	tngx_πmp_c⁄f_p‹t_t
;

92 
sockaddr
 *
	msockaddr
;

93 
sockÀn_t
 
	msockÀn
;

95 
ngx_πmp_c⁄f_˘x_t
 *
	m˘x
;

97 
	mböd
:1;

98 
	mwûdˇrd
:1;

99 #i‡(
NGX_HAVE_INET6
 && 
deföed
 
IPV6_V6ONLY
)

100 
	mùv6⁄ly
:2;

102 
	mso_kì∑live
:2;

103 
	m¥oxy_¥Ÿocﬁ
:1;

104 #i‡(
NGX_HAVE_KEEPALIVE_TUNABLE
)

105 
	mt˝_kìpidÀ
;

106 
	mt˝_kìpötvl
;

107 
	mt˝_kìp˙t
;

109 } 
	tngx_πmp_c⁄f_addr_t
;

112 
	#NGX_RTMP_VERSION
 3

	)

114 
	#NGX_LOG_DEBUG_RTMP
 
NGX_LOG_DEBUG_CORE


	)

116 
	#NGX_RTMP_DEFAULT_CHUNK_SIZE
 128

	)

120 
	#NGX_RTMP_MSG_CHUNK_SIZE
 1

	)

121 
	#NGX_RTMP_MSG_ABORT
 2

	)

122 
	#NGX_RTMP_MSG_ACK
 3

	)

123 
	#NGX_RTMP_MSG_USER
 4

	)

124 
	#NGX_RTMP_MSG_ACK_SIZE
 5

	)

125 
	#NGX_RTMP_MSG_BANDWIDTH
 6

	)

126 
	#NGX_RTMP_MSG_EDGE
 7

	)

127 
	#NGX_RTMP_MSG_AUDIO
 8

	)

128 
	#NGX_RTMP_MSG_VIDEO
 9

	)

129 
	#NGX_RTMP_MSG_AMF3_META
 15

	)

130 
	#NGX_RTMP_MSG_AMF3_SHARED
 16

	)

131 
	#NGX_RTMP_MSG_AMF3_CMD
 17

	)

132 
	#NGX_RTMP_MSG_AMF_META
 18

	)

133 
	#NGX_RTMP_MSG_AMF_SHARED
 19

	)

134 
	#NGX_RTMP_MSG_AMF_CMD
 20

	)

135 
	#NGX_RTMP_MSG_AGGREGATE
 22

	)

136 
	#NGX_RTMP_MSG_MAX
 22

	)

138 
	#NGX_RTMP_CONNECT
 
NGX_RTMP_MSG_MAX
 + 1

	)

139 
	#NGX_RTMP_DISCONNECT
 
NGX_RTMP_MSG_MAX
 + 2

	)

140 
	#NGX_RTMP_HANDSHAKE_DONE
 
NGX_RTMP_MSG_MAX
 + 3

	)

141 
	#NGX_RTMP_MAX_EVENT
 
NGX_RTMP_MSG_MAX
 + 4

	)

145 
	#NGX_RTMP_USER_STREAM_BEGIN
 0

	)

146 
	#NGX_RTMP_USER_STREAM_EOF
 1

	)

147 
	#NGX_RTMP_USER_STREAM_DRY
 2

	)

148 
	#NGX_RTMP_USER_SET_BUFLEN
 3

	)

149 
	#NGX_RTMP_USER_RECORDED
 4

	)

150 
	#NGX_RTMP_USER_PING_REQUEST
 6

	)

151 
	#NGX_RTMP_USER_PING_RESPONSE
 7

	)

152 
	#NGX_RTMP_USER_UNKNOWN
 8

	)

153 
	#NGX_RTMP_USER_BUFFER_END
 31

	)

160 
	#NGX_RTMP_MAX_CHUNK_HEADER
 18

	)

164 
uöt32_t
 
	mcsid
;

165 
uöt32_t
 
	mtime°amp
;

166 
uöt32_t
 
	mmÀn
;

167 
uöt8_t
 
	mty≥
;

168 
uöt32_t
 
	mmsid
;

169 } 
	tngx_πmp_hódî_t
;

173 
ngx_πmp_hódî_t
 
	mhdr
;

174 
uöt32_t
 
	mdtime
;

175 
uöt32_t
 
	mÀn
;

176 
uöt8_t
 
	mext
;

177 
ngx_chaö_t
 *
	mö
;

178 } 
	tngx_πmp_°ªam_t
;

183 #i‡(
NGX_WIN32
)

184 #¥agm®
w¨nög
(
push
)

185 #¥agm®
w¨nög
(
dißbÀ
:4200)

190 
uöt32_t
 
	msig«tuª
;

192 
ngx_evít_t
 
	m˛o£
;

194 **
	m˘x
;

195 **
	mmaö_c⁄f
;

196 **
	m§v_c⁄f
;

197 **
	m≠p_c⁄f
;

199 
ngx_°r_t
 *
	maddr_ãxt
;

200 
	mc⁄√˘ed
;

202 #i‡(
ngöx_vîsi⁄
 >= 1007005)

203 
ngx_queue_t
 
	mpo°ed_dry_evíts
;

205 
ngx_evít_t
 *
	mpo°ed_dry_evíts
;

209 
uöt32_t
 
	mbuÊí
;

210 
uöt32_t
 
	mack_size
;

213 
ngx_°r_t
 
	m≠p
;

214 
ngx_°r_t
 
	m¨gs
;

215 
ngx_°r_t
 
	mÊashvî
;

216 
ngx_°r_t
 
	mswf_uæ
;

217 
ngx_°r_t
 
	mtc_uæ
;

218 
uöt32_t
 
	macodecs
;

219 
uöt32_t
 
	mvcodecs
;

220 
ngx_°r_t
 
	m∑ge_uæ
;

223 
ngx_buf_t
 *
	mhs_buf
;

224 
u_ch¨
 *
	mhs_dige°
;

225 
	mhs_ﬁd
:1;

226 
ngx_uöt_t
 
	mhs_°age
;

229 
ngx_m£c_t
 
	mïoch
;

230 
ngx_m£c_t
 
	m≥î_ïoch
;

231 
ngx_m£c_t
 
	mba£_time
;

232 
uöt32_t
 
	mcuºít_time
;

235 
ngx_evít_t
 
	mpög_evt
;

236 
	mpög_a˘ive
:1;

237 
	mpög_ª£t
:1;

240 
	mauto_pushed
:1;

241 
	mªœy
:1;

242 
	m°©ic_ªœy
:1;

247 
ngx_πmp_°ªam_t
 *
	mö_°ªams
;

248 
uöt32_t
 
	mö_csid
;

249 
ngx_uöt_t
 
	mö_chunk_size
;

250 
ngx_poﬁ_t
 *
	mö_poﬁ
;

251 
uöt32_t
 
	mö_byãs
;

252 
uöt32_t
 
	mö_œ°_ack
;

254 
ngx_poﬁ_t
 *
	mö_ﬁd_poﬁ
;

255 
ngx_öt_t
 
	mö_chunk_size_ch™gög
;

257 
ngx_c⁄√˘i⁄_t
 *
	mc⁄√˘i⁄
;

260 
ngx_m£c_t
 
	mtimeout
;

261 
uöt32_t
 
	mout_byãs
;

262 
size_t
 
	mout_pos
, 
	mout_œ°
;

263 
ngx_chaö_t
 *
	mout_chaö
;

264 
u_ch¨
 *
	mout_bpos
;

265 
	mout_buf„r
:1;

266 
size_t
 
	mout_queue
;

267 
size_t
 
	mout_c‹k
;

268 
ngx_chaö_t
 *
	mout
[0];

269 } 
	tngx_πmp_£ssi⁄_t
;

272 #i‡(
NGX_WIN32
)

273 #¥agm®
w¨nög
(
p›
)

282 
	$ngx_öt_t
 (*
	tngx_πmp_h™dÀr_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

283 
	tngx_πmp_hódî_t
 *
	th
, 
	tngx_chaö_t
 *
	tö
);

287 
ngx_°r_t
 
«me
;

288 
ngx_πmp_h™dÀr_±
 
h™dÀr
;

289 } 
	tngx_πmp_amf_h™dÀr_t
;

293 
ngx_¨øy_t
 
£rvîs
;

294 
ngx_¨øy_t
 
li°í
;

296 
ngx_¨øy_t
 
evíts
[
NGX_RTMP_MAX_EVENT
];

298 
ngx_hash_t
 
amf_hash
;

299 
ngx_¨øy_t
 
amf_¨øys
;

300 
ngx_¨øy_t
 
amf
;

301 } 
	tngx_πmp_c‹e_maö_c⁄f_t
;

305 
ngx_πmp_c‹e_maö_c⁄f_t
 *
ngx_πmp_c‹e_maö_c⁄f
;

308 
	sngx_πmp_c‹e_§v_c⁄f_s
 {

309 
ngx_¨øy_t
 
≠∂iˇti⁄s
;

311 
ngx_m£c_t
 
timeout
;

312 
ngx_m£c_t
 
pög
;

313 
ngx_m£c_t
 
pög_timeout
;

314 
ngx_Êag_t
 
so_kì∑live
;

315 
ngx_öt_t
 
max_°ªams
;

317 
ngx_uöt_t
 
ack_wödow
;

319 
ngx_öt_t
 
chunk_size
;

320 
ngx_poﬁ_t
 *
poﬁ
;

321 
ngx_chaö_t
 *
‰ì
;

322 
ngx_chaö_t
 *
‰ì_hs
;

323 
size_t
 
max_mesßge
;

324 
ngx_Êag_t
 
∂ay_time_fix
;

325 
ngx_Êag_t
 
publish_time_fix
;

326 
ngx_Êag_t
 
busy
;

327 
size_t
 
out_queue
;

328 
size_t
 
out_c‹k
;

329 
ngx_m£c_t
 
buÊí
;

331 
ngx_πmp_c⁄f_˘x_t
 *
˘x
;

332 } 
	tngx_πmp_c‹e_§v_c⁄f_t
;

336 
ngx_¨øy_t
 
≠∂iˇti⁄s
;

337 
ngx_°r_t
 
«me
;

338 **
≠p_c⁄f
;

339 } 
	tngx_πmp_c‹e_≠p_c⁄f_t
;

343 
ngx_°r_t
 *
˛õ¡
;

344 
ngx_πmp_£ssi⁄_t
 *
£ssi⁄
;

345 } 
	tngx_πmp_îr‹_log_˘x_t
;

349 
	`ngx_öt_t
 (*
¥ec⁄figuøti⁄
)(
ngx_c⁄f_t
 *
cf
);

350 
	`ngx_öt_t
 (*
po°c⁄figuøti⁄
)(
ngx_c⁄f_t
 *
cf
);

352 *(*
¸óã_maö_c⁄f
)(
ngx_c⁄f_t
 *
cf
);

353 *(*
öô_maö_c⁄f
)(
ngx_c⁄f_t
 *
cf
, *
c⁄f
);

355 *(*
¸óã_§v_c⁄f
)(
ngx_c⁄f_t
 *
cf
);

356 *(*
mîge_§v_c⁄f
)(
ngx_c⁄f_t
 *
cf
, *
¥ev
,

357 *
c⁄f
);

359 *(*
¸óã_≠p_c⁄f
)(
ngx_c⁄f_t
 *
cf
);

360 *(*
mîge_≠p_c⁄f
)(
ngx_c⁄f_t
 *
cf
, *
¥ev
,

361 *
c⁄f
);

362 } 
	tngx_πmp_moduÀ_t
;

364 
	#NGX_RTMP_MODULE
 0x504D5452

	)

366 
	#NGX_RTMP_MAIN_CONF
 0x02000000

	)

367 
	#NGX_RTMP_SRV_CONF
 0x04000000

	)

368 
	#NGX_RTMP_APP_CONF
 0x08000000

	)

369 
	#NGX_RTMP_REC_CONF
 0x10000000

	)

372 
	#NGX_RTMP_MAIN_CONF_OFFSET
 
	`off£tof
(
ngx_πmp_c⁄f_˘x_t
, 
maö_c⁄f
)

	)

373 
	#NGX_RTMP_SRV_CONF_OFFSET
 
	`off£tof
(
ngx_πmp_c⁄f_˘x_t
, 
§v_c⁄f
)

	)

374 
	#NGX_RTMP_APP_CONF_OFFSET
 
	`off£tof
(
ngx_πmp_c⁄f_˘x_t
, 
≠p_c⁄f
)

	)

377 
	#ngx_πmp_gë_moduÀ_˘x
(
s
, 
moduÀ
Ë(s)->
˘x
[moduÀ.
˘x_ödex
]

	)

378 
	#ngx_πmp_£t_˘x
(
s
, 
c
, 
moduÀ
Ës->
˘x
[moduÀ.
˘x_ödex
] = c;

	)

379 
	#ngx_πmp_dñëe_˘x
(
s
, 
moduÀ
Ës->
˘x
[moduÀ.
˘x_ödex
] = 
NULL
;

	)

382 
	#ngx_πmp_gë_moduÀ_maö_c⁄f
(
s
, 
moduÀ
) \

383 (
s
)->
maö_c⁄f
[
moduÀ
.
˘x_ödex
]

	)

384 
	#ngx_πmp_gë_moduÀ_§v_c⁄f
(
s
, 
moduÀ
Ë(s)->
§v_c⁄f
[moduÀ.
˘x_ödex
]

	)

385 
	#ngx_πmp_gë_moduÀ_≠p_c⁄f
(
s
, 
moduÀ
Ë((s)->
≠p_c⁄f
 ? \

386 (
s
)->
≠p_c⁄f
[
moduÀ
.
˘x_ödex
] : 
NULL
)

	)

388 
	#ngx_πmp_c⁄f_gë_moduÀ_maö_c⁄f
(
cf
, 
moduÀ
) \

389 ((
ngx_πmp_c⁄f_˘x_t
 *Ë
cf
->
˘x
)->
maö_c⁄f
[
moduÀ
.
˘x_ödex
]

	)

390 
	#ngx_πmp_c⁄f_gë_moduÀ_§v_c⁄f
(
cf
, 
moduÀ
) \

391 ((
ngx_πmp_c⁄f_˘x_t
 *Ë
cf
->
˘x
)->
§v_c⁄f
[
moduÀ
.
˘x_ödex
]

	)

392 
	#ngx_πmp_c⁄f_gë_moduÀ_≠p_c⁄f
(
cf
, 
moduÀ
) \

393 ((
ngx_πmp_c⁄f_˘x_t
 *Ë
cf
->
˘x
)->
≠p_c⁄f
[
moduÀ
.
˘x_ödex
]

	)

396 #ifde‡
NGX_DEBUG


397 * 
	`ngx_πmp_mesßge_ty≥
(
uöt8_t
 
ty≥
);

398 * 
	`ngx_πmp_u£r_mesßge_ty≥
(
uöt16_t
 
evt
);

401 
	`ngx_πmp_öô_c⁄√˘i⁄
(
ngx_c⁄√˘i⁄_t
 *
c
);

402 
ngx_πmp_£ssi⁄_t
 * 
	`ngx_πmp_öô_£ssi⁄
(
ngx_c⁄√˘i⁄_t
 *
c
,

403 
ngx_πmp_addr_c⁄f_t
 *
addr_c⁄f
);

404 
	`ngx_πmp_föÆize_£ssi⁄
(
ngx_πmp_£ssi⁄_t
 *
s
);

405 
	`ngx_πmp_h™dshake
(
ngx_πmp_£ssi⁄_t
 *
s
);

406 
	`ngx_πmp_˛õ¡_h™dshake
(
ngx_πmp_£ssi⁄_t
 *
s
, 
async
);

407 
	`ngx_πmp_‰ì_h™dshake_buf„rs
(
ngx_πmp_£ssi⁄_t
 *
s
);

408 
	`ngx_πmp_cy˛e
(
ngx_πmp_£ssi⁄_t
 *
s
);

409 
	`ngx_πmp_ª£t_pög
(
ngx_πmp_£ssi⁄_t
 *
s
);

410 
ngx_öt_t
 
	`ngx_πmp_fúe_evít
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_uöt_t
 
evt
,

411 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
);

414 
ngx_öt_t
 
	`ngx_πmp_£t_chunk_size
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_uöt_t
 
size
);

418 * 
	`ngx_πmp_rmem˝y
(*
d°
, c⁄° * 
§c
, 
size_t
 
n
);

420 
	#ngx_πmp_r˝ymem
(
d°
, 
§c
, 
n
) \

421 (((
u_ch¨
*)
	`ngx_πmp_rmem˝y
(
d°
, 
§c
, 
n
)Ë+ (n))

	)

424 
ngx_ölöe
 
uöt16_t


425 
	$ngx_πmp_r16
(
uöt16_t
 
n
)

427  (
n
 << 8) | (n >> 8);

428 
	}
}

431 
ngx_ölöe
 
uöt32_t


432 
	$ngx_πmp_r32
(
uöt32_t
 
n
)

434  (
n
 << 24) | ((n << 8) & 0xff0000) | ((n >> 8) & 0xff00) | (n >> 24);

435 
	}
}

438 
ngx_ölöe
 
uöt64_t


439 
	$ngx_πmp_r64
(
uöt64_t
 
n
)

441  (
uöt64_t
Ë
	`ngx_πmp_r32
((
uöt32_t
Ë
n
) << 32 |

442 
	`ngx_πmp_r32
((
uöt32_t
Ë(
n
 >> 32));

443 
	}
}

447 
ngx_öt_t
 
ngx_πmp_ª˚ive_mesßge
(
ngx_πmp_£ssi⁄_t
 *
s
,

448 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
);

449 
ngx_öt_t
 
ngx_πmp_¥Ÿocﬁ_mesßge_h™dÀr
(
ngx_πmp_£ssi⁄_t
 *
s
,

450 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
);

451 
ngx_öt_t
 
ngx_πmp_u£r_mesßge_h™dÀr
(
ngx_πmp_£ssi⁄_t
 *
s
,

452 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
);

453 
ngx_öt_t
 
ngx_πmp_aggªg©e_mesßge_h™dÀr
(
ngx_πmp_£ssi⁄_t
 *
s
,

454 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
);

455 
ngx_öt_t
 
ngx_πmp_amf_mesßge_h™dÀr
(
ngx_πmp_£ssi⁄_t
 *
s
,

456 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
);

457 
ngx_öt_t
 
ngx_πmp_amf_sh¨ed_obje˘_h™dÀr
(
ngx_πmp_£ssi⁄_t
 *
s
,

458 
ngx_πmp_hódî_t
 *
h
, 
ngx_chaö_t
 *
ö
);

465 
	#NGX_RTMP_REFCOUNT_TYPE
 
uöt32_t


	)

466 
	#NGX_RTMP_REFCOUNT_BYTES
 (
NGX_RTMP_REFCOUNT_TYPE
)

	)

468 
	#ngx_πmp_ªf
(
b
) \

469 *((
NGX_RTMP_REFCOUNT_TYPE
*)(
b
Ë- 1)

	)

471 
	#ngx_πmp_ªf_£t
(
b
, 
v
) \

472 
	`ngx_πmp_ªf
(
b
Ë
v


	)

474 
	#ngx_πmp_ªf_gë
(
b
) \

475 ++
	`ngx_πmp_ªf
(
b
)

	)

477 
	#ngx_πmp_ªf_put
(
b
) \

478 --
	`ngx_πmp_ªf
(
b
)

	)

480 
ngx_chaö_t
 * 
ngx_πmp_Æloc_sh¨ed_buf
(
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
);

481 
ngx_πmp_‰ì_sh¨ed_chaö
(
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
,

482 
ngx_chaö_t
 *
ö
);

483 
ngx_chaö_t
 * 
ngx_πmp_≠≥nd_sh¨ed_bufs
(
ngx_πmp_c‹e_§v_c⁄f_t
 *
cscf
,

484 
ngx_chaö_t
 *
hód
,Çgx_chaö_à*
ö
);

486 
	#ngx_πmp_acquúe_sh¨ed_chaö
(
ö
) \

487 
	`ngx_πmp_ªf_gë
(
ö
); \

488 

	)

491 
ngx_πmp_¥ï¨e_mesßge
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

492 
ngx_πmp_hódî_t
 *
lh
, 
ngx_chaö_t
 *
out
);

493 
ngx_öt_t
 
ngx_πmp_£nd_mesßge
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_chaö_t
 *
out
,

494 
ngx_uöt_t
 
¥i‹ôy
);

501 
	#NGX_RTMP_LIMIT_SOFT
 0

	)

502 
	#NGX_RTMP_LIMIT_HARD
 1

	)

503 
	#NGX_RTMP_LIMIT_DYNAMIC
 2

	)

506 
ngx_chaö_t
 * 
ngx_πmp_¸óã_chunk_size
(
ngx_πmp_£ssi⁄_t
 *
s
,

507 
uöt32_t
 
chunk_size
);

508 
ngx_chaö_t
 * 
ngx_πmp_¸óã_ab‹t
(
ngx_πmp_£ssi⁄_t
 *
s
,

509 
uöt32_t
 
csid
);

510 
ngx_chaö_t
 * 
ngx_πmp_¸óã_ack
(
ngx_πmp_£ssi⁄_t
 *
s
,

511 
uöt32_t
 
£q
);

512 
ngx_chaö_t
 * 
ngx_πmp_¸óã_ack_size
(
ngx_πmp_£ssi⁄_t
 *
s
,

513 
uöt32_t
 
ack_size
);

514 
ngx_chaö_t
 * 
ngx_πmp_¸óã_b™dwidth
(
ngx_πmp_£ssi⁄_t
 *
s
,

515 
uöt32_t
 
ack_size
, 
uöt8_t
 
limô_ty≥
);

517 
ngx_öt_t
 
ngx_πmp_£nd_chunk_size
(
ngx_πmp_£ssi⁄_t
 *
s
,

518 
uöt32_t
 
chunk_size
);

519 
ngx_öt_t
 
ngx_πmp_£nd_ab‹t
(
ngx_πmp_£ssi⁄_t
 *
s
,

520 
uöt32_t
 
csid
);

521 
ngx_öt_t
 
ngx_πmp_£nd_ack
(
ngx_πmp_£ssi⁄_t
 *
s
,

522 
uöt32_t
 
£q
);

523 
ngx_öt_t
 
ngx_πmp_£nd_ack_size
(
ngx_πmp_£ssi⁄_t
 *
s
,

524 
uöt32_t
 
ack_size
);

525 
ngx_öt_t
 
ngx_πmp_£nd_b™dwidth
(
ngx_πmp_£ssi⁄_t
 *
s
,

526 
uöt32_t
 
ack_size
, 
uöt8_t
 
limô_ty≥
);

529 
ngx_chaö_t
 * 
ngx_πmp_¸óã_°ªam_begö
(
ngx_πmp_£ssi⁄_t
 *
s
,

530 
uöt32_t
 
msid
);

531 
ngx_chaö_t
 * 
ngx_πmp_¸óã_°ªam_eof
(
ngx_πmp_£ssi⁄_t
 *
s
,

532 
uöt32_t
 
msid
);

533 
ngx_chaö_t
 * 
ngx_πmp_¸óã_°ªam_dry
(
ngx_πmp_£ssi⁄_t
 *
s
,

534 
uöt32_t
 
msid
);

535 
ngx_chaö_t
 * 
ngx_πmp_¸óã_£t_buÊí
(
ngx_πmp_£ssi⁄_t
 *
s
,

536 
uöt32_t
 
msid
, uöt32_à
buÊí_m£c
);

537 
ngx_chaö_t
 * 
ngx_πmp_¸óã_ªc‹ded
(
ngx_πmp_£ssi⁄_t
 *
s
,

538 
uöt32_t
 
msid
);

539 
ngx_chaö_t
 * 
ngx_πmp_¸óã_pög_ªque°
(
ngx_πmp_£ssi⁄_t
 *
s
,

540 
uöt32_t
 
time°amp
);

541 
ngx_chaö_t
 * 
ngx_πmp_¸óã_pög_ª•⁄£
(
ngx_πmp_£ssi⁄_t
 *
s
,

542 
uöt32_t
 
time°amp
);

544 
ngx_öt_t
 
ngx_πmp_£nd_°ªam_begö
(
ngx_πmp_£ssi⁄_t
 *
s
,

545 
uöt32_t
 
msid
);

546 
ngx_öt_t
 
ngx_πmp_£nd_°ªam_eof
(
ngx_πmp_£ssi⁄_t
 *
s
,

547 
uöt32_t
 
msid
);

548 
ngx_öt_t
 
ngx_πmp_£nd_°ªam_dry
(
ngx_πmp_£ssi⁄_t
 *
s
,

549 
uöt32_t
 
msid
);

550 
ngx_öt_t
 
ngx_πmp_£nd_£t_buÊí
(
ngx_πmp_£ssi⁄_t
 *
s
,

551 
uöt32_t
 
msid
, uöt32_à
buÊí_m£c
);

552 
ngx_öt_t
 
ngx_πmp_£nd_ªc‹ded
(
ngx_πmp_£ssi⁄_t
 *
s
,

553 
uöt32_t
 
msid
);

554 
ngx_öt_t
 
ngx_πmp_£nd_pög_ªque°
(
ngx_πmp_£ssi⁄_t
 *
s
,

555 
uöt32_t
 
time°amp
);

556 
ngx_öt_t
 
ngx_πmp_£nd_pög_ª•⁄£
(
ngx_πmp_£ssi⁄_t
 *
s
,

557 
uöt32_t
 
time°amp
);

560 
ngx_öt_t
 
ngx_πmp_≠≥nd_amf
(
ngx_πmp_£ssi⁄_t
 *
s
,

561 
ngx_chaö_t
 **
fú°
,Çgx_chaö_à**
œ°
,

562 
ngx_πmp_amf_ñt_t
 *
ñts
, 
size_t
 
√…s
);

563 
ngx_öt_t
 
ngx_πmp_ª˚ive_amf
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_chaö_t
 *
ö
,

564 
ngx_πmp_amf_ñt_t
 *
ñts
, 
size_t
 
√…s
);

566 
ngx_chaö_t
 * 
ngx_πmp_¸óã_amf
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

567 
ngx_πmp_amf_ñt_t
 *
ñts
, 
size_t
 
√…s
);

568 
ngx_öt_t
 
ngx_πmp_£nd_amf
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_πmp_hódî_t
 *
h
,

569 
ngx_πmp_amf_ñt_t
 *
ñts
, 
size_t
 
√…s
);

572 
ngx_chaö_t
 * 
ngx_πmp_¸óã_°©us
(
ngx_πmp_£ssi⁄_t
 *
s
, *
code
,

573 * 
Àvñ
, *
desc
);

574 
ngx_chaö_t
 * 
ngx_πmp_¸óã_∂ay_°©us
(
ngx_πmp_£ssi⁄_t
 *
s
, *
code
,

575 * 
Àvñ
, 
ngx_uöt_t
 
duøti⁄
,Çgx_uöt_à
byãs
);

576 
ngx_chaö_t
 * 
ngx_πmp_¸óã_ßm∂e_ac˚ss
(
ngx_πmp_£ssi⁄_t
 *
s
);

578 
ngx_öt_t
 
ngx_πmp_£nd_°©us
(
ngx_πmp_£ssi⁄_t
 *
s
, *
code
,

579 * 
Àvñ
, *
desc
);

580 
ngx_öt_t
 
ngx_πmp_£nd_∂ay_°©us
(
ngx_πmp_£ssi⁄_t
 *
s
, *
code
,

581 * 
Àvñ
, 
ngx_uöt_t
 
duøti⁄
,Çgx_uöt_à
byãs
);

582 
ngx_öt_t
 
ngx_πmp_£nd_ßm∂e_ac˚ss
(
ngx_πmp_£ssi⁄_t
 *
s
);

586 
	#NGX_RTMP_VIDEO_KEY_FRAME
 1

	)

587 
	#NGX_RTMP_VIDEO_INTER_FRAME
 2

	)

588 
	#NGX_RTMP_VIDEO_DISPOSABLE_FRAME
 3

	)

591 
ngx_ölöe
 
ngx_öt_t


592 
	$ngx_πmp_gë_video_‰ame_ty≥
(
ngx_chaö_t
 *
ö
)

594  (
ö
->
buf
->
pos
[0] & 0xf0) >> 4;

595 
	}
}

598 
ngx_ölöe
 
ngx_öt_t


599 
	$ngx_πmp_is_codec_hódî
(
ngx_chaö_t
 *
ö
)

601  
ö
->
buf
->
pos
 + 1 < in->buf->
œ°
 && in->buf->pos[1] == 0;

602 
	}
}

605 
ngx_πmp_b™dwidth_t
 
ngx_πmp_bw_out
;

606 
ngx_πmp_b™dwidth_t
 
ngx_πmp_bw_ö
;

609 
ngx_uöt_t
 
ngx_πmp_«c˚±ed
;

610 #i‡(
ngöx_vîsi⁄
 >= 1007005)

611 
ngx_thªad_vﬁ©ûe
 
ngx_queue_t
 
ngx_πmp_öô_queue
;

613 
ngx_thªad_vﬁ©ûe
 
ngx_evít_t
 *
ngx_πmp_öô_queue
;

616 
ngx_uöt_t
 
ngx_πmp_max_moduÀ
;

617 
ngx_moduÀ_t
 
ngx_πmp_c‹e_moduÀ
;

	@ngx_rtmp_amf.h

7 #i‚de‡
_NGX_RTMP_AMF_H_INCLUDED_


8 
	#_NGX_RTMP_AMF_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

16 
	#NGX_RTMP_AMF_NUMBER
 0x00

	)

17 
	#NGX_RTMP_AMF_BOOLEAN
 0x01

	)

18 
	#NGX_RTMP_AMF_STRING
 0x02

	)

19 
	#NGX_RTMP_AMF_OBJECT
 0x03

	)

20 
	#NGX_RTMP_AMF_NULL
 0x05

	)

21 
	#NGX_RTMP_AMF_ARRAY_NULL
 0x06

	)

22 
	#NGX_RTMP_AMF_MIXED_ARRAY
 0x08

	)

23 
	#NGX_RTMP_AMF_END
 0x09

	)

24 
	#NGX_RTMP_AMF_ARRAY
 0x0a

	)

27 
	#NGX_RTMP_AMF_INT8
 0x0100

	)

28 
	#NGX_RTMP_AMF_INT16
 0x0101

	)

29 
	#NGX_RTMP_AMF_INT32
 0x0102

	)

30 
	#NGX_RTMP_AMF_VARIANT_
 0x0103

	)

33 
	#NGX_RTMP_AMF_OPTIONAL
 0x1000

	)

34 
	#NGX_RTMP_AMF_TYPELESS
 0x2000

	)

35 
	#NGX_RTMP_AMF_CONTEXT
 0x4000

	)

37 
	#NGX_RTMP_AMF_VARIANT
 (
NGX_RTMP_AMF_VARIANT_
\

38 |
NGX_RTMP_AMF_TYPELESS
)

	)

42 
ngx_öt_t
 
	mty≥
;

43 
ngx_°r_t
 
	m«me
;

44 *
	md©a
;

45 
size_t
 
	mÀn
;

46 } 
	tngx_πmp_amf_ñt_t
;

49 
	gngx_chaö_t
 * (*
	tngx_πmp_amf_Æloc_±
)(*
	t¨g
);

53 
ngx_chaö_t
 *
	mlök
, *
	mfú°
;

54 
size_t
 
	moff£t
;

55 
ngx_πmp_amf_Æloc_±
 
	mÆloc
;

56 *
	m¨g
;

57 
ngx_log_t
 *
	mlog
;

58 } 
	tngx_πmp_amf_˘x_t
;

62 
ngx_öt_t
 
ngx_πmp_amf_ªad
(
ngx_πmp_amf_˘x_t
 *
˘x
,

63 
ngx_πmp_amf_ñt_t
 *
ñts
, 
size_t
 
√…s
);

66 
ngx_öt_t
 
ngx_πmp_amf_wrôe
(
ngx_πmp_amf_˘x_t
 *
˘x
,

67 
ngx_πmp_amf_ñt_t
 *
ñts
, 
size_t
 
√…s
);

	@ngx_rtmp_bandwidth.h

7 #i‚de‡
_NGX_RTMP_BANDWIDTH_H_INCLUDED_


8 
	#_NGX_RTMP_BANDWIDTH_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

16 
	#NGX_RTMP_BANDWIDTH_INTERVAL
 10

	)

20 
uöt64_t
 
	mbyãs
;

21 
uöt64_t
 
	mb™dwidth
;

23 
time_t
 
	möé_íd
;

24 
uöt64_t
 
	möé_byãs
;

25 } 
	tngx_πmp_b™dwidth_t
;

28 
ngx_πmp_upd©e_b™dwidth
(
ngx_πmp_b™dwidth_t
 *
bw
, 
uöt32_t
 
byãs
);

	@ngx_rtmp_bitop.h

7 #i‚de‡
_NGX_RTMP_BITOP_H_INCLUDED_


8 
	#_NGX_RTMP_BITOP_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

16 
u_ch¨
 *
	mpos
;

17 
u_ch¨
 *
	mœ°
;

18 
ngx_uöt_t
 
	moffs
;

19 
ngx_uöt_t
 
	mîr
;

20 } 
	tngx_πmp_bô_ªadî_t
;

23 
ngx_πmp_bô_öô_ªadî
(
ngx_πmp_bô_ªadî_t
 *
br
, 
u_ch¨
 *
pos
,

24 
u_ch¨
 *
œ°
);

25 
uöt64_t
 
ngx_πmp_bô_ªad
(
ngx_πmp_bô_ªadî_t
 *
br
, 
ngx_uöt_t
 
n
);

26 
uöt64_t
 
ngx_πmp_bô_ªad_gﬁomb
(
ngx_πmp_bô_ªadî_t
 *
br
);

29 
	#ngx_πmp_bô_ªad_îr
(
br
Ë((br)->
îr
)

	)

31 
	#ngx_πmp_bô_ªad_eof
(
br
Ë((br)->
pos
 =(br)->
œ°
)

	)

33 
	#ngx_πmp_bô_ªad_8
(
br
) \

34 ((
uöt8_t
Ë
	`ngx_πmp_bô_ªad
(
br
, 8))

	)

36 
	#ngx_πmp_bô_ªad_16
(
br
) \

37 ((
uöt16_t
Ë
	`ngx_πmp_bô_ªad
(
br
, 16))

	)

39 
	#ngx_πmp_bô_ªad_32
(
br
) \

40 ((
uöt32_t
Ë
	`ngx_πmp_bô_ªad
(
br
, 32))

	)

42 
	#ngx_πmp_bô_ªad_64
(
br
) \

43 ((
uöt64_t
Ë
	`ngx_πmp_ªad
(
br
, 64))

	)

	@ngx_rtmp_cmd_module.h

7 #i‚de‡
_NGX_RTMP_CMD_H_INCLUDED_


8 
	#_NGX_RTMP_CMD_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

13 
	~<ngx_evít.h
>

14 
	~"ngx_πmp.h
"

17 
	#NGX_RTMP_MAX_NAME
 256

	)

18 
	#NGX_RTMP_MAX_URL
 256

	)

19 
	#NGX_RTMP_MAX_ARGS
 
NGX_RTMP_MAX_NAME


	)

25 
	må™s
;

26 
u_ch¨
 
	m≠p
[
NGX_RTMP_MAX_NAME
];

27 
u_ch¨
 
	m¨gs
[
NGX_RTMP_MAX_ARGS
];

28 
u_ch¨
 
	mÊashvî
[32];

29 
u_ch¨
 
	mswf_uæ
[
NGX_RTMP_MAX_URL
];

30 
u_ch¨
 
	mtc_uæ
[
NGX_RTMP_MAX_URL
];

31 
	macodecs
;

32 
	mvcodecs
;

33 
u_ch¨
 
	m∑ge_uæ
[
NGX_RTMP_MAX_URL
];

34 
	mobje˘_ícodög
;

35 } 
	tngx_πmp_c⁄√˘_t
;

39 
	må™s
;

40 
	m°ªam
;

41 } 
	tngx_πmp_¸óã_°ªam_t
;

45 
	m°ªam
;

46 } 
	tngx_πmp_dñëe_°ªam_t
;

50 
	m°ªam
;

51 } 
	tngx_πmp_˛o£_°ªam_t
;

55 
u_ch¨
 
	m«me
[
NGX_RTMP_MAX_NAME
];

56 
u_ch¨
 
	m¨gs
[
NGX_RTMP_MAX_ARGS
];

57 
u_ch¨
 
	mty≥
[16];

58 
	msûít
;

59 } 
	tngx_πmp_publish_t
;

63 
u_ch¨
 
	m«me
[
NGX_RTMP_MAX_NAME
];

64 
u_ch¨
 
	m¨gs
[
NGX_RTMP_MAX_ARGS
];

65 
	m°¨t
;

66 
	mduøti⁄
;

67 
	mª£t
;

68 
	msûít
;

69 } 
	tngx_πmp_∂ay_t
;

73 
	moff£t
;

74 } 
	tngx_πmp_£ek_t
;

78 
uöt8_t
 
	m∑u£
;

79 
	mposôi⁄
;

80 } 
	tngx_πmp_∑u£_t
;

84 
uöt32_t
 
	mmsid
;

85 } 
	tngx_πmp_msid_t
;

88 
ngx_πmp_msid_t
 
	tngx_πmp_°ªam_begö_t
;

89 
ngx_πmp_msid_t
 
	tngx_πmp_°ªam_eof_t
;

90 
ngx_πmp_msid_t
 
	tngx_πmp_°ªam_dry_t
;

91 
ngx_πmp_msid_t
 
	tngx_πmp_ªc‹ded_t
;

95 
uöt32_t
 
	mmsid
;

96 
uöt32_t
 
	mbuÊí
;

97 } 
	tngx_πmp_£t_buÊí_t
;

100 
ngx_πmp_cmd_fûl_¨gs
(
u_ch¨
 
«me
[
NGX_RTMP_MAX_NAME
],

101 
u_ch¨
 
¨gs
[
NGX_RTMP_MAX_ARGS
]);

104 
	$ngx_öt_t
 (*
	tngx_πmp_c⁄√˘_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

105 
	tngx_πmp_c⁄√˘_t
 *
	tv
);

106 
	$ngx_öt_t
 (*
	tngx_πmp_disc⁄√˘_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
);

107 
	$ngx_öt_t
 (*
	tngx_πmp_¸óã_°ªam_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

108 
	tngx_πmp_¸óã_°ªam_t
 *
	tv
);

109 
	$ngx_öt_t
 (*
	tngx_πmp_˛o£_°ªam_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

110 
	tngx_πmp_˛o£_°ªam_t
 *
	tv
);

111 
	$ngx_öt_t
 (*
	tngx_πmp_dñëe_°ªam_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

112 
	tngx_πmp_dñëe_°ªam_t
 *
	tv
);

113 
	$ngx_öt_t
 (*
	tngx_πmp_publish_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

114 
	tngx_πmp_publish_t
 *
	tv
);

115 
	$ngx_öt_t
 (*
	tngx_πmp_∂ay_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

116 
	tngx_πmp_∂ay_t
 *
	tv
);

117 
	$ngx_öt_t
 (*
	tngx_πmp_£ek_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

118 
	tngx_πmp_£ek_t
 *
	tv
);

119 
	$ngx_öt_t
 (*
	tngx_πmp_∑u£_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

120 
	tngx_πmp_∑u£_t
 *
	tv
);

122 
	$ngx_öt_t
 (*
	tngx_πmp_°ªam_begö_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

123 
	tngx_πmp_°ªam_begö_t
 *
	tv
);

124 
	$ngx_öt_t
 (*
	tngx_πmp_°ªam_eof_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

125 
	tngx_πmp_°ªam_eof_t
 *
	tv
);

126 
	$ngx_öt_t
 (*
	tngx_πmp_°ªam_dry_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

127 
	tngx_πmp_°ªam_dry_t
 *
	tv
);

128 
	$ngx_öt_t
 (*
	tngx_πmp_ªc‹ded_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

129 
	tngx_πmp_ªc‹ded_t
 *
	tv
);

130 
	$ngx_öt_t
 (*
	tngx_πmp_£t_buÊí_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

131 
	tngx_πmp_£t_buÊí_t
 *
	tv
);

134 
ngx_πmp_c⁄√˘_±
 
ngx_πmp_c⁄√˘
;

135 
ngx_πmp_disc⁄√˘_±
 
ngx_πmp_disc⁄√˘
;

136 
ngx_πmp_¸óã_°ªam_±
 
ngx_πmp_¸óã_°ªam
;

137 
ngx_πmp_˛o£_°ªam_±
 
ngx_πmp_˛o£_°ªam
;

138 
ngx_πmp_dñëe_°ªam_±
 
ngx_πmp_dñëe_°ªam
;

139 
ngx_πmp_publish_±
 
ngx_πmp_publish
;

140 
ngx_πmp_∂ay_±
 
ngx_πmp_∂ay
;

141 
ngx_πmp_£ek_±
 
ngx_πmp_£ek
;

142 
ngx_πmp_∑u£_±
 
ngx_πmp_∑u£
;

144 
ngx_πmp_°ªam_begö_±
 
ngx_πmp_°ªam_begö
;

145 
ngx_πmp_°ªam_eof_±
 
ngx_πmp_°ªam_eof
;

146 
ngx_πmp_°ªam_dry_±
 
ngx_πmp_°ªam_dry
;

147 
ngx_πmp_£t_buÊí_±
 
ngx_πmp_£t_buÊí
;

148 
ngx_πmp_ªc‹ded_±
 
ngx_πmp_ªc‹ded
;

	@ngx_rtmp_codec_module.h

7 #i‚de‡
_NGX_RTMP_CODEC_H_INCLUDED_


8 
	#_NGX_RTMP_CODEC_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

13 
	~"ngx_πmp.h
"

20 
	mNGX_RTMP_AUDIO_UNCOMPRESSED
 = 16,

21 
	mNGX_RTMP_AUDIO_ADPCM
 = 1,

22 
	mNGX_RTMP_AUDIO_MP3
 = 2,

23 
	mNGX_RTMP_AUDIO_LINEAR_LE
 = 3,

24 
	mNGX_RTMP_AUDIO_NELLY16
 = 4,

25 
	mNGX_RTMP_AUDIO_NELLY8
 = 5,

26 
	mNGX_RTMP_AUDIO_NELLY
 = 6,

27 
	mNGX_RTMP_AUDIO_G711A
 = 7,

28 
	mNGX_RTMP_AUDIO_G711U
 = 8,

29 
	mNGX_RTMP_AUDIO_AAC
 = 10,

30 
	mNGX_RTMP_AUDIO_SPEEX
 = 11,

31 
	mNGX_RTMP_AUDIO_MP3_8
 = 14,

32 
	mNGX_RTMP_AUDIO_DEVSPEC
 = 15,

38 
	mNGX_RTMP_VIDEO_JPEG
 = 1,

39 
	mNGX_RTMP_VIDEO_SORENSON_H263
 = 2,

40 
	mNGX_RTMP_VIDEO_SCREEN
 = 3,

41 
	mNGX_RTMP_VIDEO_ON2_VP6
 = 4,

42 
	mNGX_RTMP_VIDEO_ON2_VP6_ALPHA
 = 5,

43 
	mNGX_RTMP_VIDEO_SCREEN2
 = 6,

44 
	mNGX_RTMP_VIDEO_H264
 = 7

48 
u_ch¨
 * 
ngx_πmp_gë_audio_codec_«me
(
ngx_uöt_t
 
id
);

49 
u_ch¨
 * 
ngx_πmp_gë_video_codec_«me
(
ngx_uöt_t
 
id
);

53 
ngx_uöt_t
 
	mwidth
;

54 
ngx_uöt_t
 
	mheight
;

55 
ngx_uöt_t
 
	mduøti⁄
;

56 
ngx_uöt_t
 
	m‰ame_øã
;

57 
ngx_uöt_t
 
	mvideo_d©a_øã
;

58 
ngx_uöt_t
 
	mvideo_codec_id
;

59 
ngx_uöt_t
 
	maudio_d©a_øã
;

60 
ngx_uöt_t
 
	maudio_codec_id
;

61 
ngx_uöt_t
 
	mØc_¥ofûe
;

62 
ngx_uöt_t
 
	mØc_ch™_c⁄f
;

63 
ngx_uöt_t
 
	mØc_sbr
;

64 
ngx_uöt_t
 
	mØc_ps
;

65 
ngx_uöt_t
 
	mavc_¥ofûe
;

66 
ngx_uöt_t
 
	mavc_com∑t
;

67 
ngx_uöt_t
 
	mavc_Àvñ
;

68 
ngx_uöt_t
 
	mavc_«l_byãs
;

69 
ngx_uöt_t
 
	mavc_ªf_‰ames
;

70 
ngx_uöt_t
 
	mßm∂e_øã
;

71 
ngx_uöt_t
 
	mßm∂e_size
;

72 
ngx_uöt_t
 
	maudio_ch™√ls
;

73 
u_ch¨
 
	m¥ofûe
[32];

74 
u_ch¨
 
	mÀvñ
[32];

76 
ngx_chaö_t
 *
	mavc_hódî
;

77 
ngx_chaö_t
 *
	mØc_hódî
;

79 
ngx_chaö_t
 *
	mmëa
;

80 
ngx_uöt_t
 
	mmëa_vîsi⁄
;

81 } 
	tngx_πmp_codec_˘x_t
;

84 
ngx_moduÀ_t
 
ngx_πmp_codec_moduÀ
;

	@ngx_rtmp_eval.h

7 #i‚de‡
_NGX_RTMP_EVAL_H_INCLUDED_


8 
	#_NGX_RTMP_EVAL_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

13 
	~"ngx_πmp.h
"

16 
ngx_πmp_evÆ_s
 
	tngx_πmp_evÆ_t
;

19 (* 
	tngx_πmp_evÆ_±
)(*
	t˘x
, 
	tngx_πmp_evÆ_t
 *
	te
,

20 
	tngx_°r_t
 *
	tªt
);

23 
	sngx_πmp_evÆ_s
 {

24 
ngx_°r_t
 
«me
;

25 
ngx_πmp_evÆ_±
 
h™dÀr
;

26 
ngx_uöt_t
 
off£t
;

30 
	#ngx_πmp_nuŒ_evÆ
 { 
ngx_nuŒ_°rög
, 
NULL
, 0 
	}

	)
}

34 
ngx_πmp_evÆ_t
 
ngx_πmp_evÆ_£ssi⁄
[];

37 
ngx_öt_t
 
ngx_πmp_evÆ
(*
˘x
, 
ngx_°r_t
 *
ö
, 
ngx_πmp_evÆ_t
 **
e
,

38 
ngx_°r_t
 *
out
, 
ngx_log_t
 *
log
);

41 
ngx_öt_t
 
ngx_πmp_evÆ_°ªams
(
ngx_°r_t
 *
ö
);

	@ngx_rtmp_live_module.h

7 #i‚de‡
_NGX_RTMP_LIVE_H_INCLUDED_


8 
	#_NGX_RTMP_LIVE_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

13 
	~"ngx_πmp.h
"

14 
	~"ngx_πmp_cmd_moduÀ.h
"

15 
	~"ngx_πmp_b™dwidth.h
"

16 
	~"ngx_πmp_°ªams.h
"

19 
ngx_πmp_live_˘x_s
 
	tngx_πmp_live_˘x_t
;

20 
ngx_πmp_live_°ªam_s
 
	tngx_πmp_live_°ªam_t
;

24 
	ma˘ive
:1;

25 
uöt32_t
 
	mtime°amp
;

26 
uöt32_t
 
	mcsid
;

27 
uöt32_t
 
	mdr›≥d
;

28 } 
	tngx_πmp_live_chunk_°ªam_t
;

31 
	sngx_πmp_live_˘x_s
 {

32 
ngx_πmp_£ssi⁄_t
 *
	m£ssi⁄
;

33 
ngx_πmp_live_°ªam_t
 *
	m°ªam
;

34 
ngx_πmp_live_˘x_t
 *
	m√xt
;

35 
ngx_uöt_t
 
	mndr›≥d
;

36 
ngx_πmp_live_chunk_°ªam_t
 
	mcs
[2];

37 
ngx_uöt_t
 
	mmëa_vîsi⁄
;

38 
ngx_evít_t
 
	midÀ_evt
;

39 
	ma˘ive
:1;

40 
	mpublishög
:1;

41 
	msûít
:1;

42 
	m∑u£d
:1;

46 
	sngx_πmp_live_°ªam_s
 {

47 
u_ch¨
 
	m«me
[
NGX_RTMP_MAX_NAME
];

48 
ngx_πmp_live_°ªam_t
 *
	m√xt
;

49 
ngx_πmp_live_˘x_t
 *
	m˘x
;

50 
ngx_πmp_b™dwidth_t
 
	mbw_ö
;

51 
ngx_πmp_b™dwidth_t
 
	mbw_ö_audio
;

52 
ngx_πmp_b™dwidth_t
 
	mbw_ö_video
;

53 
ngx_πmp_b™dwidth_t
 
	mbw_out
;

54 
ngx_m£c_t
 
	mïoch
;

55 
	ma˘ive
:1;

56 
	mpublishög
:1;

61 
ngx_öt_t
 
	mnbuckës
;

62 
ngx_πmp_live_°ªam_t
 **
	m°ªams
;

63 
ngx_Êag_t
 
	mlive
;

64 
ngx_Êag_t
 
	mmëa
;

65 
ngx_m£c_t
 
	msync
;

66 
ngx_m£c_t
 
	midÀ_timeout
;

67 
ngx_Êag_t
 
	m©c
;

68 
ngx_Êag_t
 
	möãæóve
;

69 
ngx_Êag_t
 
	mwaô_key
;

70 
ngx_Êag_t
 
	mwaô_video
;

71 
ngx_Êag_t
 
	mpublish_nŸify
;

72 
ngx_Êag_t
 
	m∂ay_ª°¨t
;

73 
ngx_Êag_t
 
	midÀ_°ªams
;

74 
ngx_m£c_t
 
	mbuÊí
;

75 
ngx_poﬁ_t
 *
	mpoﬁ
;

76 
ngx_πmp_live_°ªam_t
 *
	m‰ì_°ªams
;

77 } 
	tngx_πmp_live_≠p_c⁄f_t
;

80 
ngx_moduÀ_t
 
ngx_πmp_live_moduÀ
;

	@ngx_rtmp_netcall_module.h

7 #i‚de‡
_NGX_RTMP_NETCALL_H_INCLUDED_


8 
	#_NGX_RTMP_NETCALL_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

13 
	~"ngx_πmp.h
"

16 
	gngx_chaö_t
 * (*
	tngx_πmp_√tˇŒ_¸óã_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

17 *
	t¨g
, 
	tngx_poﬁ_t
 *
	tpoﬁ
);

18 
	$ngx_öt_t
 (*
	tngx_πmp_√tˇŒ_fûãr_±
)(
	tngx_chaö_t
 *
	tö
);

19 
	$ngx_öt_t
 (*
	tngx_πmp_√tˇŒ_sök_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

20 
	tngx_chaö_t
 *
	tö
);

21 
	$ngx_öt_t
 (*
	tngx_πmp_√tˇŒ_h™dÀ_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

22 *
	t¨g
, 
	tngx_chaö_t
 *
	tö
);

24 
	#NGX_RTMP_NETCALL_HTTP_GET
 0

	)

25 
	#NGX_RTMP_NETCALL_HTTP_POST
 1

	)

38 
ngx_uæ_t
 *
uæ
;

39 
ngx_πmp_√tˇŒ_¸óã_±
 
¸óã
;

40 
ngx_πmp_√tˇŒ_fûãr_±
 
fûãr
;

41 
ngx_πmp_√tˇŒ_sök_±
 
sök
;

42 
ngx_πmp_√tˇŒ_h™dÀ_±
 
h™dÀ
;

43 *
¨g
;

44 
size_t
 
¨gsize
;

45 } 
	tngx_πmp_√tˇŒ_öô_t
;

48 
ngx_öt_t
 
	`ngx_πmp_√tˇŒ_¸óã
(
ngx_πmp_£ssi⁄_t
 *
s
,

49 
ngx_πmp_√tˇŒ_öô_t
 *
ci
);

53 
ngx_chaö_t
 * 
	`ngx_πmp_√tˇŒ_hâp_f‹m©_£ssi⁄
(
ngx_πmp_£ssi⁄_t
 *
s
,

54 
ngx_poﬁ_t
 *
poﬁ
);

55 
ngx_chaö_t
 * 
	`ngx_πmp_√tˇŒ_hâp_f‹m©_ªque°
(
ngx_öt_t
 
mëhod
,

56 
ngx_°r_t
 *
ho°
,Çgx_°r_à*
uri
, 
ngx_chaö_t
 *
¨gs
,Çgx_chaö_à*
body
,

57 
ngx_poﬁ_t
 *
poﬁ
, 
ngx_°r_t
 *
c⁄ã¡_ty≥
);

58 
ngx_chaö_t
 * 
	`ngx_πmp_√tˇŒ_hâp_skù_hódî
“gx_chaö_à*
ö
);

62 
ngx_chaö_t
 * 
	`ngx_πmp_√tˇŒ_memˇche_£t
(
ngx_πmp_£ssi⁄_t
 *
s
,

63 
ngx_poﬁ_t
 *
poﬁ
, 
ngx_°r_t
 *
key
,Çgx_°r_à*
vÆue
,

64 
ngx_uöt_t
 
Êags
,Çgx_uöt_à
£c
);

	@ngx_rtmp_play_module.h

7 #i‚de‡
_NGX_RTMP_PLAY_H_INCLUDED_


8 
	#_NGX_RTMP_PLAY_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

13 
	~"ngx_πmp.h
"

14 
	~"ngx_πmp_cmd_moduÀ.h
"

17 
	$ngx_öt_t
 (*
	tngx_πmp_∂ay_öô_±
Ë(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

18 
	tngx_fûe_t
 *
	tf
, 
	tngx_öt_t
 
	taödex
,Çgx_öt_à
	tvödex
);

19 
	$ngx_öt_t
 (*
	tngx_πmp_∂ay_d⁄e_±
Ë(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

20 
	tngx_fûe_t
 *
	tf
);

21 
	$ngx_öt_t
 (*
	tngx_πmp_∂ay_°¨t_±
Ë(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

22 
	tngx_fûe_t
 *
	tf
);

23 
	$ngx_öt_t
 (*
	tngx_πmp_∂ay_£ek_±
Ë(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

24 
	tngx_fûe_t
 *
	tf
, 
	tngx_uöt_t
 
	toffs
);

25 
	$ngx_öt_t
 (*
	tngx_πmp_∂ay_°›_±
Ë(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

26 
	tngx_fûe_t
 *
	tf
);

27 
	$ngx_öt_t
 (*
	tngx_πmp_∂ay_£nd_±
Ë(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

28 
	tngx_fûe_t
 *
	tf
, 
	tngx_uöt_t
 *
	tts
);

32 
ngx_°r_t
 
«me
;

33 
ngx_°r_t
 
pfx
;

34 
ngx_°r_t
 
sfx
;

36 
ngx_πmp_∂ay_öô_±
 
öô
;

37 
ngx_πmp_∂ay_d⁄e_±
 
d⁄e
;

38 
ngx_πmp_∂ay_°¨t_±
 
°¨t
;

39 
ngx_πmp_∂ay_£ek_±
 
£ek
;

40 
ngx_πmp_∂ay_°›_±
 
°›
;

41 
ngx_πmp_∂ay_£nd_±
 
£nd
;

42 } 
	tngx_πmp_∂ay_fmt_t
;

45 
ngx_πmp_∂ay_˘x_s
 
	tngx_πmp_∂ay_˘x_t
;

48 
	sngx_πmp_∂ay_˘x_s
 {

49 
ngx_πmp_£ssi⁄_t
 *
£ssi⁄
;

50 
ngx_fûe_t
 
fûe
;

51 
ngx_πmp_∂ay_fmt_t
 *
fmt
;

52 
ngx_evít_t
 
£nd_evt
;

53 
∂ayög
:1;

54 
›íed
:1;

55 
joöed
:1;

56 
ngx_uöt_t
 
n¸s
;

57 
ngx_uöt_t
 
nhódî
;

58 
ngx_uöt_t
 
nbody
;

59 
size_t
 
pfx_size
;

60 
ngx_°r_t
 
sfx
;

61 
ngx_uöt_t
 
fûe_id
;

62 
ngx_öt_t
 
aödex
, 
vödex
;

63 
ngx_uöt_t
 
√¡ry
;

64 
ngx_uöt_t
 
po°_£ek
;

65 
u_ch¨
 
«me
[
NGX_RTMP_MAX_NAME
];

66 
ngx_πmp_∂ay_˘x_t
 *
√xt
;

71 
ngx_°r_t
 *
roŸ
;

72 
ngx_uæ_t
 *
uæ
;

73 } 
	tngx_πmp_∂ay_íåy_t
;

77 
ngx_°r_t
 
ãmp_∑th
;

78 
ngx_°r_t
 
loˇl_∑th
;

79 
ngx_¨øy_t
 
íåõs
;

80 
ngx_uöt_t
 
nbuckës
;

81 
ngx_πmp_∂ay_˘x_t
 **
˘x
;

82 } 
	tngx_πmp_∂ay_≠p_c⁄f_t
;

86 
ngx_¨øy_t
 
fmts
;

87 } 
	tngx_πmp_∂ay_maö_c⁄f_t
;

90 
ngx_moduÀ_t
 
ngx_πmp_∂ay_moduÀ
;

	@ngx_rtmp_proxy_protocol.h

7 #i‚de‡
_NGX_RTMP_PROXY_PROTOCOL_H_INCLUDED_


8 
	#_NGX_RTMP_PROXY_PROTOCOL_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

13 
	~"ngx_πmp.h
"

16 
ngx_πmp_¥oxy_¥Ÿocﬁ
(
ngx_πmp_£ssi⁄_t
 *
c
);

	@ngx_rtmp_record_module.h

7 #i‚de‡
_NGX_RTMP_RECORD_H_INCLUDED_


8 
	#_NGX_RTMP_RECORD_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

13 
	~"ngx_πmp.h
"

16 
	#NGX_RTMP_RECORD_OFF
 0x01

	)

17 
	#NGX_RTMP_RECORD_AUDIO
 0x02

	)

18 
	#NGX_RTMP_RECORD_VIDEO
 0x04

	)

19 
	#NGX_RTMP_RECORD_KEYFRAMES
 0x08

	)

20 
	#NGX_RTMP_RECORD_MANUAL
 0x10

	)

25 
ngx_queue_t
 
	mque
;

26 
ngx_Êag_t
 
	mis_vÆid
;

27 
u_ch¨
 
	m°ªam_«me
[
NGX_RTMP_MAX_NAME
];

28 } 
	tngx_°ªam_öfo
;

31 
ngx_queue_t
 *
	mqueue
;

32 } 
	tngx_πmp_ªc‹d_maö_c⁄f_t
;

34 
ngx_πmp_ªc‹d_maö_c⁄f_t
 *
	gngx_πmp_ªc‹d_maö_c⁄f
;

36 
ngx_öt_t
 
ngx_föd_queue
(
ngx_queue_t
 *
queue
, 
u_ch¨
 *
«me
);

37 
ngx_queue_ö£π
(
ngx_queue_t
 *
queue
, 
ngx_°ªam_öfo
 *
tmp_öfo
);

38 
ngx_queue_ªmove_°©us
(
ngx_queue_t
 *
queue
, 
u_ch¨
 *
«me
);

39 
ngx_¥öt_queue
(
ngx_queue_t
 *
queue
);

43 
ngx_°r_t
 
	mid
;

44 
ngx_uöt_t
 
	mÊags
;

45 
ngx_°r_t
 
	m∑th
;

46 
size_t
 
	mmax_size
;

47 
size_t
 
	mmax_‰ames
;

48 
ngx_m£c_t
 
	möãrvÆ
;

49 
ngx_°r_t
 
	msuffix
;

50 
ngx_Êag_t
 
	munique
;

51 
ngx_Êag_t
 
	m≠≥nd
;

52 
ngx_Êag_t
 
	mlock_fûe
;

53 
ngx_Êag_t
 
	mnŸify
;

54 
ngx_uæ_t
 *
	muæ
;

56 **
	mªc_c⁄f
;

57 
ngx_¨øy_t
 
	mªc
;

58 } 
	tngx_πmp_ªc‹d_≠p_c⁄f_t
;

62 
ngx_πmp_ªc‹d_≠p_c⁄f_t
 *
	mc⁄f
;

63 
ngx_fûe_t
 
	mfûe
;

64 
ngx_uöt_t
 
	mn‰ames
;

65 
uöt32_t
 
	mïoch
, 
	mtime_shi·
;

66 
ngx_time_t
 
	mœ°
;

67 
time_t
 
	mtime°amp
;

68 
	mÁûed
:1;

69 
	möôülized
:1;

70 
	mØc_hódî_£¡
:1;

71 
	mavc_hódî_£¡
:1;

72 
	mvideo_key_£¡
:1;

73 
	maudio
:1;

74 
	mvideo
:1;

75 } 
	tngx_πmp_ªc‹d_ªc_˘x_t
;

79 
ngx_¨øy_t
 
	mªc
;

80 
u_ch¨
 
	m«me
[
NGX_RTMP_MAX_NAME
];

81 
u_ch¨
 
	m¨gs
[
NGX_RTMP_MAX_ARGS
];

82 
u_ch¨
 
	mliveid
[
NGX_RTMP_MAX_ARGS
];

83 } 
	tngx_πmp_ªc‹d_˘x_t
;

86 
ngx_uöt_t
 
ngx_πmp_ªc‹d_föd
(
ngx_πmp_ªc‹d_≠p_c⁄f_t
 *
øcf
,

87 
ngx_°r_t
 *
id
);

94 
ngx_öt_t
 
ngx_πmp_ªc‹d_›í
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_uöt_t
 
n
,

95 
ngx_°r_t
 *
∑th
);

96 
ngx_öt_t
 
ngx_πmp_ªc‹d_˛o£
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_uöt_t
 
n
,

97 
ngx_°r_t
 *
∑th
);

101 
ngx_°r_t
 
	mªc‹dî
;

102 
ngx_°r_t
 
	m∑th
;

103 } 
	tngx_πmp_ªc‹d_d⁄e_t
;

106 
	$ngx_öt_t
 (*
	tngx_πmp_ªc‹d_d⁄e_±
)(
	tngx_πmp_£ssi⁄_t
 *
	ts
,

107 
	tngx_πmp_ªc‹d_d⁄e_t
 *
	tv
);

110 
ngx_πmp_ªc‹d_d⁄e_±
 
ngx_πmp_ªc‹d_d⁄e
;

113 
ngx_moduÀ_t
 
ngx_πmp_ªc‹d_moduÀ
;

	@ngx_rtmp_relay_module.h

7 #i‚de‡
_NGX_RTMP_RELAY_H_INCLUDED_


8 
	#_NGX_RTMP_RELAY_H_INCLUDED_


	)

11 
	~<ngx_c⁄fig.h
>

12 
	~<ngx_c‹e.h
>

13 
	~"ngx_πmp.h
"

17 
ngx_uæ_t
 
	muæ
;

18 
ngx_°r_t
 
	m≠p
;

19 
ngx_°r_t
 
	m«me
;

20 
ngx_°r_t
 
	mtc_uæ
;

21 
ngx_°r_t
 
	m∑ge_uæ
;

22 
ngx_°r_t
 
	mswf_uæ
;

23 
ngx_°r_t
 
	mÊash_vî
;

24 
ngx_°r_t
 
	m∂ay_∑th
;

25 
ngx_öt_t
 
	mlive
;

26 
ngx_öt_t
 
	m°¨t
;

27 
ngx_öt_t
 
	m°›
;

29 *
	mèg
;

30 *
	md©a
;

31 
ngx_uöt_t
 
	mcou¡î
;

32 } 
	tngx_πmp_ªœy_èrgë_t
;

35 
ngx_πmp_ªœy_˘x_s
 
	tngx_πmp_ªœy_˘x_t
;

37 
	sngx_πmp_ªœy_˘x_s
 {

38 
ngx_°r_t
 
	m«me
;

39 
ngx_°r_t
 
	muæ
;

40 
ngx_log_t
 
	mlog
;

41 
ngx_πmp_£ssi⁄_t
 *
	m£ssi⁄
;

42 
ngx_πmp_ªœy_˘x_t
 *
	mpublish
;

43 
ngx_πmp_ªœy_˘x_t
 *
	m∂ay
;

44 
ngx_πmp_ªœy_˘x_t
 *
	m√xt
;

46 
ngx_°r_t
 
	m≠p
;

47 
ngx_°r_t
 
	mtc_uæ
;

48 
ngx_°r_t
 
	m∑ge_uæ
;

49 
ngx_°r_t
 
	mswf_uæ
;

50 
ngx_°r_t
 
	mÊash_vî
;

51 
ngx_°r_t
 
	m∂ay_∑th
;

52 
ngx_öt_t
 
	mlive
;

53 
ngx_öt_t
 
	m°¨t
;

54 
ngx_öt_t
 
	m°›
;

56 
ngx_evít_t
 
	mpush_evt
;

57 
ngx_evít_t
 *
	m°©ic_evt
;

58 *
	mèg
;

59 *
	md©a
;

63 
ngx_moduÀ_t
 
ngx_πmp_ªœy_moduÀ
;

66 
ngx_öt_t
 
ngx_πmp_ªœy_puŒ
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_°r_t
 *
«me
,

67 
ngx_πmp_ªœy_èrgë_t
 *
èrgë
);

68 
ngx_öt_t
 
ngx_πmp_ªœy_push
(
ngx_πmp_£ssi⁄_t
 *
s
, 
ngx_°r_t
 *
«me
,

69 
ngx_πmp_ªœy_èrgë_t
 *
èrgë
);

	@ngx_rtmp_streams.h

7 #i‚de‡
_NGX_RTMP_STREAMS_H_INCLUDED_


8 
	#_NGX_RTMP_STREAMS_H_INCLUDED_


	)

11 
	#NGX_RTMP_MSID
 1

	)

13 
	#NGX_RTMP_CSID_AMF_INI
 3

	)

14 
	#NGX_RTMP_CSID_AMF
 5

	)

15 
	#NGX_RTMP_CSID_AUDIO
 6

	)

16 
	#NGX_RTMP_CSID_VIDEO
 7

	)

	@ngx_rtmp_version.h

7 #i‚de‡
_NGX_RTMP_VERSION_H_INCLUDED_


8 
	#_NGX_RTMP_VERSION_H_INCLUDED_


	)

11 
	#ngöx_πmp_vîsi⁄
 1001004

	)

12 
	#NGINX_RTMP_VERSION
 "1.1.4"

	)

	@
1
.
0
68
7890
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/.git/config
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/config
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/dash/ngx_rtmp_dash_module.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/dash/ngx_rtmp_mp4.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/dash/ngx_rtmp_mp4.h
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/hls/ngx_rtmp_hls_module.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/hls/ngx_rtmp_mpegts.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/hls/ngx_rtmp_mpegts.h
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp.h
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_access_module.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_amf.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_amf.h
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_auto_push_module.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_bandwidth.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_bandwidth.h
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_bitop.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_bitop.h
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_cmd_module.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_cmd_module.h
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_codec_module.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_codec_module.h
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_control_module.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_core_module.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_eval.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_eval.h
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_exec_module.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_flv_module.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_handler.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_handshake.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_init.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_limit_module.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_live_module.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_live_module.h
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_log_module.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_mp4_module.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_netcall_module.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_netcall_module.h
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_notify_module.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_play_module.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_play_module.h
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_proxy_protocol.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_proxy_protocol.h
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_receive.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_record_module.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_record_module.h
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_relay_module.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_relay_module.h
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_send.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_shared.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_stat_module.c
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_streams.h
/home/ligp/work/nginx_online/nginx_rtmp/source_node/nginx-rtmp/nginx_rtmp_module/branch/nginx-1.6.2/src/nginx-rtmp-module/ngx_rtmp_version.h
ngx_rtmp.h
ngx_rtmp_amf.h
ngx_rtmp_bandwidth.h
ngx_rtmp_bitop.h
ngx_rtmp_cmd_module.h
ngx_rtmp_codec_module.h
ngx_rtmp_eval.h
ngx_rtmp_live_module.h
ngx_rtmp_netcall_module.h
ngx_rtmp_play_module.h
ngx_rtmp_proxy_protocol.h
ngx_rtmp_record_module.h
ngx_rtmp_relay_module.h
ngx_rtmp_streams.h
ngx_rtmp_version.h
